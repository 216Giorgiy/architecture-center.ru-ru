---
title: Ведение журнала и мониторинг в микрослужбах
description: Ведение журнала и мониторинг в микрослужбах
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 1da67047daa9ae87cda5dd7dd581d6081183c428
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
ms.locfileid: "26653000"
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="af975-103">Проектирование микрослужб: ведение журнала и мониторинг</span><span class="sxs-lookup"><span data-stu-id="af975-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="af975-104">В любом сложном приложении в определенный момент возникают проблемы.</span><span class="sxs-lookup"><span data-stu-id="af975-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="af975-105">Если вы используете приложение для микрослужб, вам необходимо отслеживать, что происходит между десятками и даже сотнями служб.</span><span class="sxs-lookup"><span data-stu-id="af975-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="af975-106">Ведение журнала и мониторинг очень важны, так как они обеспечивают целостное представление о системе.</span><span class="sxs-lookup"><span data-stu-id="af975-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="af975-107">В архитектуре микрослужб может быть особенно сложно выявить точную причину ошибок или узких мест производительности.</span><span class="sxs-lookup"><span data-stu-id="af975-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="af975-108">Операция одного пользователя может включать использование нескольких служб.</span><span class="sxs-lookup"><span data-stu-id="af975-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="af975-109">Службы могут достичь лимита сетевых операций ввода-вывода внутри кластера.</span><span class="sxs-lookup"><span data-stu-id="af975-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="af975-110">Цепочки вызовов между службами могут вызвать замедленную обратную реакцию в системе, что приводит к высокой задержке или каскадным сбоям.</span><span class="sxs-lookup"><span data-stu-id="af975-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="af975-111">Более того, чаще всего неизвестно, на каком узле будет запущен конкретный контейнер.</span><span class="sxs-lookup"><span data-stu-id="af975-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="af975-112">Контейнеры, размещенные на одном и том же узле, могут конкурировать за ограниченные ресурсы ЦП или память.</span><span class="sxs-lookup"><span data-stu-id="af975-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="af975-113">Чтобы понять, что происходит, приложение должно сформировать события телеметрии.</span><span class="sxs-lookup"><span data-stu-id="af975-113">To make sense of what's happening, the application must emit telemetry events.</span></span> <span data-ttu-id="af975-114">Вы можете разделить их на метрики и текстовые журналы.</span><span class="sxs-lookup"><span data-stu-id="af975-114">You can categorize these into metrics and text-based logs.</span></span> 

<span data-ttu-id="af975-115">*Метрики* — это числовые значения, которые можно проанализировать.</span><span class="sxs-lookup"><span data-stu-id="af975-115">*Metrics* are numerical values that can be analyzed.</span></span> <span data-ttu-id="af975-116">С их помощью можно наблюдать за системой в режиме реального времени (или близком к реальному времени) и анализировать тенденции производительности с течением времени.</span><span class="sxs-lookup"><span data-stu-id="af975-116">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="af975-117">Есть такие типы метрик:</span><span class="sxs-lookup"><span data-stu-id="af975-117">Metrics include:</span></span>

- <span data-ttu-id="af975-118">Системные метрики уровня узла, в том числе использование ЦП, памяти, сети, диска и файловой системы.</span><span class="sxs-lookup"><span data-stu-id="af975-118">Node-level system metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="af975-119">Они помогают понять выделение ресурсов для каждого узла в кластере и устранять возникшие выбросы.</span><span class="sxs-lookup"><span data-stu-id="af975-119">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>
 
- <span data-ttu-id="af975-120">Метрики Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="af975-120">Kubernetes metrics.</span></span> <span data-ttu-id="af975-121">Так как службы запускаются в контейнерах, вам необходимо собирать метрики на уровне контейнера, а не только на уровне виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="af975-121">Because services run in containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="af975-122">В Kubernetes cAdvisor (Помощник по контейнерам) — это агент, который собирает статистику о ЦП, памяти, файловой системе и сетевых ресурсах, используемых в каждом контейнере.</span><span class="sxs-lookup"><span data-stu-id="af975-122">In Kubernetes, cAdvisor (Container Advisor) is the agent that collects statistics about the CPU, memory, file system, and network resources used by each container.</span></span> <span data-ttu-id="af975-123">Управляющая программа kubelet собирает статистики ресурсов с cAdvisor и предоставляет их через REST API.</span><span class="sxs-lookup"><span data-stu-id="af975-123">The kubelet daemon collects resource statistics from cAdvisor and exposes them through a REST API.</span></span>
   
- <span data-ttu-id="af975-124">Метрики приложения.</span><span class="sxs-lookup"><span data-stu-id="af975-124">Application metrics.</span></span> <span data-ttu-id="af975-125">Сюда входят все метрики, которые важны для понимания поведения службы.</span><span class="sxs-lookup"><span data-stu-id="af975-125">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="af975-126">Например, число входящих HTTP-запросов в очереди, задержка выполнения запросов, длина очереди сообщений или количество транзакций, обрабатываемых в секунду.</span><span class="sxs-lookup"><span data-stu-id="af975-126">Examples include the number of queued inbound HTTP requests, request latency, message queue length, or number of transactions processed per second.</span></span>

- <span data-ttu-id="af975-127">Метрики зависимых служб.</span><span class="sxs-lookup"><span data-stu-id="af975-127">Dependent service metrics.</span></span> <span data-ttu-id="af975-128">Службы внутри кластера могут вызывать внешние службы, которые находятся за пределами кластера, например управляемые службы PaaS.</span><span class="sxs-lookup"><span data-stu-id="af975-128">Services inside the cluster may call external services that are outside the cluster, such as managed PaaS services.</span></span> <span data-ttu-id="af975-129">Вы можете отслеживать службы Azure с помощью [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span><span class="sxs-lookup"><span data-stu-id="af975-129">You can monitor Azure services by using [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span></span> <span data-ttu-id="af975-130">Сторонние службы могут предоставлять метрики.</span><span class="sxs-lookup"><span data-stu-id="af975-130">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="af975-131">В противном случае вам придется использовать собственные метрики приложения для отслеживания статистики задержки и частоты ошибок.</span><span class="sxs-lookup"><span data-stu-id="af975-131">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

<span data-ttu-id="af975-132">*Журналы* — это записи о событиях, происходящих во время работы приложения.</span><span class="sxs-lookup"><span data-stu-id="af975-132">*Logs* are records of events that occur while the application is running.</span></span> <span data-ttu-id="af975-133">Они включают в себя журналы приложений (трассировочных операторов) и журналы веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="af975-133">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="af975-134">Журналы главным образом используются для экспертизы и анализа первопричины.</span><span class="sxs-lookup"><span data-stu-id="af975-134">Logs are primarily useful for forensics and root cause analysis.</span></span> 

## <a name="considerations"></a><span data-ttu-id="af975-135">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="af975-135">Considerations</span></span>

<span data-ttu-id="af975-136">В статье [Мониторинг и диагностика](../best-practices/monitoring.md) приводятся общие рекомендации по мониторингу приложения.</span><span class="sxs-lookup"><span data-stu-id="af975-136">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="af975-137">Ниже приведены некоторые особенности, на которые стоит обратить внимание в контексте архитектуры микрослужб.</span><span class="sxs-lookup"><span data-stu-id="af975-137">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="af975-138">**Настройка и управление**.</span><span class="sxs-lookup"><span data-stu-id="af975-138">**Configuration and management**.</span></span> <span data-ttu-id="af975-139">Будете ли вы использовать управляемую службу для ведения журнала и мониторинга или развертывать компоненты ведения журнала и мониторинг в качестве контейнеров внутри кластера?</span><span class="sxs-lookup"><span data-stu-id="af975-139">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="af975-140">Дополнительные сведения об этих вариантах см. ниже в разделе [Варианты технологий](#technology-options).</span><span class="sxs-lookup"><span data-stu-id="af975-140">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="af975-141">**Скорость приема**.</span><span class="sxs-lookup"><span data-stu-id="af975-141">**Ingestion rate**.</span></span> <span data-ttu-id="af975-142">С какой пропускной способностью система может принимать события телеметрии?</span><span class="sxs-lookup"><span data-stu-id="af975-142">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="af975-143">Что произойдет, если эта скорость будет превышена?</span><span class="sxs-lookup"><span data-stu-id="af975-143">What happens if that rate is exceeded?</span></span> <span data-ttu-id="af975-144">Например, система может регулировать клиентов. В этом случае данные телеметрии будут потеряны или же это может привести к уменьшению выборки данных.</span><span class="sxs-lookup"><span data-stu-id="af975-144">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="af975-145">Иногда вы можете снизить этот риск, уменьшив объем собираемых данных:</span><span class="sxs-lookup"><span data-stu-id="af975-145">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="af975-146">Выполните статистическое вычисление метрик путем расчета статистики (например, среднего и стандартного отклонения) и отправки их в систему мониторинга.</span><span class="sxs-lookup"><span data-stu-id="af975-146">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="af975-147">Уменьшите выборку данных, то есть обрабатывайте только определенный процент событий.</span><span class="sxs-lookup"><span data-stu-id="af975-147">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="af975-148">Сгруппируйте данные, чтобы уменьшить количество сетевых вызовов к службе мониторинга.</span><span class="sxs-lookup"><span data-stu-id="af975-148">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="af975-149">**Стоимость**.</span><span class="sxs-lookup"><span data-stu-id="af975-149">**Cost**.</span></span> <span data-ttu-id="af975-150">Стоимость приема и хранения данных телеметрии может быть высокой, особенно для больших объемов.</span><span class="sxs-lookup"><span data-stu-id="af975-150">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="af975-151">В некоторых случаях она даже может превысить стоимость выполнения приложения.</span><span class="sxs-lookup"><span data-stu-id="af975-151">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="af975-152">В этом случае необходимо сократить объем данных телеметрии с помощью статистической обработки, уменьшения выборки или пакетной обработки данных, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="af975-152">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="af975-153">**Точность данных**.</span><span class="sxs-lookup"><span data-stu-id="af975-153">**Data fidelity**.</span></span> <span data-ttu-id="af975-154">Насколько точны метрики?</span><span class="sxs-lookup"><span data-stu-id="af975-154">How accurate are the metrics?</span></span> <span data-ttu-id="af975-155">Средние значения могут скрыть выбросы, особенно в масштабе.</span><span class="sxs-lookup"><span data-stu-id="af975-155">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="af975-156">Кроме того, если частота выборки слишком низкая, она может сгладить колебания данных.</span><span class="sxs-lookup"><span data-stu-id="af975-156">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="af975-157">Может показаться, что все запросы имеют одинаковую сквозную задержку, однако же на самом деле значительная часть запросов занимает гораздо больше времени.</span><span class="sxs-lookup"><span data-stu-id="af975-157">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="af975-158">**Задержка**.</span><span class="sxs-lookup"><span data-stu-id="af975-158">**Latency**.</span></span> <span data-ttu-id="af975-159">Чтобы гарантировать мониторинг и оповещения в режиме реального времени, данные телеметрии должны быть быстродоступны.</span><span class="sxs-lookup"><span data-stu-id="af975-159">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="af975-160">Как быстро данные появляются на панели мониторинга?</span><span class="sxs-lookup"><span data-stu-id="af975-160">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="af975-161">Через несколько секунд?</span><span class="sxs-lookup"><span data-stu-id="af975-161">A few seconds old?</span></span> <span data-ttu-id="af975-162">Через несколько минут?</span><span class="sxs-lookup"><span data-stu-id="af975-162">More than a minute?</span></span>

<span data-ttu-id="af975-163">**Хранилище.**</span><span class="sxs-lookup"><span data-stu-id="af975-163">**Storage.**</span></span> <span data-ttu-id="af975-164">Для журналов наиболее эффективной может быть запись событий во временное хранилище в кластере и настройка агента для отправки файлов в постоянное хранилище.</span><span class="sxs-lookup"><span data-stu-id="af975-164">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="af975-165">В конечном итоге данные должны быть перенесены в долгосрочное хранилище. Там они будут доступны для ретроспективного анализа.</span><span class="sxs-lookup"><span data-stu-id="af975-165">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="af975-166">В архитектуре микрослужб может сформироваться большой объем данных телеметрии, поэтому стоимость хранения этих данных важна.</span><span class="sxs-lookup"><span data-stu-id="af975-166">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="af975-167">Кроме того, следует учитывать метод запроса данных.</span><span class="sxs-lookup"><span data-stu-id="af975-167">Also consider how you will query the data.</span></span> 

<span data-ttu-id="af975-168">**Панель мониторинга и визуализация.**</span><span class="sxs-lookup"><span data-stu-id="af975-168">**Dashboard and visualization.**</span></span> <span data-ttu-id="af975-169">Имеете ли вы целостное представление о системе во всех службах как в пределах кластера, так и во внешних службах?</span><span class="sxs-lookup"><span data-stu-id="af975-169">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="af975-170">Если вы пишете телеметрические данные и журналы в несколько расположений, сможет ли панель мониторинга отобразить их и сопоставить?</span><span class="sxs-lookup"><span data-stu-id="af975-170">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="af975-171">На панели мониторинга должны отображаться по крайней мере следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="af975-171">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="af975-172">Общее выделение ресурсов для производительности и роста.</span><span class="sxs-lookup"><span data-stu-id="af975-172">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="af975-173">Сюда входит количество контейнеров, метрики файловой системы, сеть и распределение основных компонентов.</span><span class="sxs-lookup"><span data-stu-id="af975-173">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="af975-174">Метрики контейнеров коррелируют на уровне службы.</span><span class="sxs-lookup"><span data-stu-id="af975-174">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="af975-175">Метрики системы коррелируют с контейнерами.</span><span class="sxs-lookup"><span data-stu-id="af975-175">System metrics correlated with containers.</span></span>
- <span data-ttu-id="af975-176">Ошибки и выбросы службы.</span><span class="sxs-lookup"><span data-stu-id="af975-176">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="af975-177">Распределенная трассировка</span><span class="sxs-lookup"><span data-stu-id="af975-177">Distributed tracing</span></span>

<span data-ttu-id="af975-178">Как уже упоминалось, одна из сложностей при использовании микрослужб состоит в понимании потока событий между службами.</span><span class="sxs-lookup"><span data-stu-id="af975-178">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="af975-179">Одна операция или транзакция может содержать множество вызовов к разным службам.</span><span class="sxs-lookup"><span data-stu-id="af975-179">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="af975-180">Чтобы восстановить всю последовательность шагов, каждая служба должна распространять *идентификатор корреляции*, который действует как уникальный идентификатор для этой операции.</span><span class="sxs-lookup"><span data-stu-id="af975-180">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="af975-181">Идентификатор корреляции обеспечивает [распределенную трассировку](http://microservices.io/patterns/observability/distributed-tracing.html) между службами.</span><span class="sxs-lookup"><span data-stu-id="af975-181">The correlation ID enables [distributed tracing](http://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="af975-182">Первая служба, получающая запрос клиента, должна создать идентификатор корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-182">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="af975-183">Если служба выполняет HTTP-вызов к другой службе, она помещает идентификатор корреляции в заголовок запроса.</span><span class="sxs-lookup"><span data-stu-id="af975-183">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="af975-184">Точно так же при отправке асинхронного сообщения служба помещает идентификатор корреляции в сообщение.</span><span class="sxs-lookup"><span data-stu-id="af975-184">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="af975-185">Нисходящие службы продолжают распространять идентификатор корреляции, чтобы он проходил через всю систему.</span><span class="sxs-lookup"><span data-stu-id="af975-185">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="af975-186">Кроме того, весь код, который записывает метрики приложения или события журнала, должен включать идентификатор корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-186">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="af975-187">Если вызовы службы сопоставлены, вы можете рассчитать операционные метрики, такие как сквозная задержка для полной транзакции, количество успешных транзакций в секунду и процент неудачных транзакций.</span><span class="sxs-lookup"><span data-stu-id="af975-187">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="af975-188">Наличие идентификаторов корреляции в журналах приложений позволяет выполнять анализ первопричины.</span><span class="sxs-lookup"><span data-stu-id="af975-188">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="af975-189">Если операция не удалась, вы можете найти операторы журнала для всех вызовов службы, которые были частью одной операции.</span><span class="sxs-lookup"><span data-stu-id="af975-189">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="af975-190">Ниже приведены рекомендации по реализации распределенной трассировки.</span><span class="sxs-lookup"><span data-stu-id="af975-190">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="af975-191">В настоящее время нет стандартного HTTP-заголовка для идентификаторов корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-191">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="af975-192">Ваша команда должна стандартизировать значение пользовательского заголовка.</span><span class="sxs-lookup"><span data-stu-id="af975-192">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="af975-193">Выбор может зависеть от механизма ведения журнала или платформы мониторинга либо используемой платформы слоя взаимодействия между службами.</span><span class="sxs-lookup"><span data-stu-id="af975-193">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="af975-194">Если ваша инфраструктура обмена сообщениями поддерживает добавление метаданных в сообщения, для асинхронных сообщений нужно включить идентификатор корреляции в качестве метаданных.</span><span class="sxs-lookup"><span data-stu-id="af975-194">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="af975-195">В противном случае включите его как часть схемы сообщений.</span><span class="sxs-lookup"><span data-stu-id="af975-195">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="af975-196">Вместо одного непрозрачного идентификатора вы можете отправить *контекст корреляции*, который содержит больше информации, например отношения при вызове.</span><span class="sxs-lookup"><span data-stu-id="af975-196">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="af975-197">Пакет SDK для Azure Application Insights автоматически внедряет контекст корреляции в HTTP-заголовки и включает идентификатор корреляции в журналы Application Insights.</span><span class="sxs-lookup"><span data-stu-id="af975-197">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="af975-198">Если вы решите использовать возможности корреляции, встроенные в Application Insights, для некоторых служб все равно может потребоваться распространение заголовков корреляции (в зависимости от используемых библиотек).</span><span class="sxs-lookup"><span data-stu-id="af975-198">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="af975-199">Дополнительные сведения см. в статье [Корреляция данных телеметрии в Application Insights](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="af975-199">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="af975-200">Если вы используете Istio или linkerd в качестве платформы слоя взаимодействия между службами, эти технологии автоматически создают заголовки корреляции, когда HTTP-вызовы маршрутизируются через прокси-серверы слоя взаимодействия между службами.</span><span class="sxs-lookup"><span data-stu-id="af975-200">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="af975-201">Службы должны переадресовывать соответствующие заголовки.</span><span class="sxs-lookup"><span data-stu-id="af975-201">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="af975-202">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html) (Трассировка распределенного запроса)</span><span class="sxs-lookup"><span data-stu-id="af975-202">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="af975-203">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers) (Заголовки контекста)</span><span class="sxs-lookup"><span data-stu-id="af975-203">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="af975-204">Рассмотрим, как выполнять общий сбор журналов.</span><span class="sxs-lookup"><span data-stu-id="af975-204">Consider how you will aggregate logs.</span></span> <span data-ttu-id="af975-205">Возможно, вы захотите стандартизировать метод включения идентификаторов корреляции в журналах между всеми командами.</span><span class="sxs-lookup"><span data-stu-id="af975-205">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="af975-206">Используйте структурированный или полуструктурированный формат (например, JSON) и определите общее поле для хранения идентификатора корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-206">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="af975-207">Варианты технологии</span><span class="sxs-lookup"><span data-stu-id="af975-207">Technology options</span></span>

<span data-ttu-id="af975-208">**Application Insights** — это управляемая служба Azure, которая принимает и сохраняет данные телеметрии, а также предоставляет средства для анализа и поиска данных.</span><span class="sxs-lookup"><span data-stu-id="af975-208">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="af975-209">Чтобы использовать Application Insights, вам необходимо установить пакет инструментирования в приложении.</span><span class="sxs-lookup"><span data-stu-id="af975-209">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="af975-210">Данный пакет выполняет мониторинг приложения и отправляет данные телеметрии службе Application Insights.</span><span class="sxs-lookup"><span data-stu-id="af975-210">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="af975-211">Он также может извлечь данные телеметрии из среды узла.</span><span class="sxs-lookup"><span data-stu-id="af975-211">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="af975-212">Application Insights предоставляет встроенную корреляцию и отслеживание зависимостей.</span><span class="sxs-lookup"><span data-stu-id="af975-212">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="af975-213">Этот пакет позволяет отслеживать метрики системы, приложений и служб Azure в одном месте.</span><span class="sxs-lookup"><span data-stu-id="af975-213">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="af975-214">Обратите внимание, что Application Insights регулирует скорость передачи данных, чтобы она не превышала максимальный предел. Дополнительные сведения см. в разделе [Ограничения Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="af975-214">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="af975-215">Одна операция может создавать несколько событий телеметрии, поэтому, если в приложении большой объем трафика, может произойти регулирование.</span><span class="sxs-lookup"><span data-stu-id="af975-215">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="af975-216">Чтобы устранить эту проблему, вы можете выполнить выборку для уменьшения трафика телеметрии.</span><span class="sxs-lookup"><span data-stu-id="af975-216">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="af975-217">Однако при этом ваши метрики будут менее точными.</span><span class="sxs-lookup"><span data-stu-id="af975-217">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="af975-218">Дополнительные сведения см. в статье [Выборка в Application Insights](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="af975-218">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="af975-219">Вы также можете уменьшить объем данных путем предварительного агрегирования метрик, то есть вычислить статистические значения (например, среднее и стандартное отклонение) и отправить их вместо необработанной телеметрии.</span><span class="sxs-lookup"><span data-stu-id="af975-219">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="af975-220">В следующей записи блога описывается подход к использованию Application Insights в масштабе: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/) (Мониторинг и аналитика в Azure в нужном масштабе среды).</span><span class="sxs-lookup"><span data-stu-id="af975-220">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="af975-221">Кроме того, изучите модель ценообразования для Application Insights, так как плата взымается в зависимости от объема данных.</span><span class="sxs-lookup"><span data-stu-id="af975-221">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="af975-222">Дополнительные сведения см. в статье [Управление ценами и объемом данных в Application Insights](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="af975-222">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="af975-223">Служба Application Insights вам не подходит, если приложение создает большой объем данных телеметрии и вы не хотите выполнять выборку или агрегирование данных.</span><span class="sxs-lookup"><span data-stu-id="af975-223">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="af975-224">Если Application Insights не соответствует вашим требованиям, мы рекомендуем вам следующие подходы с использованием популярных технологий с открытым исходным кодом.</span><span class="sxs-lookup"><span data-stu-id="af975-224">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="af975-225">Что касается метрик системы и контейнера, можно экспортировать метрики в базу данных временных рядов, например **Prometheus** или **InfluxDB**, выполняющиеся в кластере.</span><span class="sxs-lookup"><span data-stu-id="af975-225">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="af975-226">InfluxDB — это система принудительной отправки.</span><span class="sxs-lookup"><span data-stu-id="af975-226">InfluxDB is a push-based system.</span></span> <span data-ttu-id="af975-227">Агент должен принудительно отправлять метрики.</span><span class="sxs-lookup"><span data-stu-id="af975-227">An agent needs to push the metrics.</span></span> <span data-ttu-id="af975-228">Вы можете использовать [Heapster][heapster]. Это служба, которая собирает с kubelet метрики на уровне кластера, объединяет данные и отправляет их в InfluxDB или другие решения хранилища временных рядов.</span><span class="sxs-lookup"><span data-stu-id="af975-228">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="af975-229">Служба контейнеров Azure развертывает Heapster как часть установки кластера.</span><span class="sxs-lookup"><span data-stu-id="af975-229">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="af975-230">Другой вариант — [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/). Это агент для сбора метрик и создания отчетов.</span><span class="sxs-lookup"><span data-stu-id="af975-230">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="af975-231">Prometheus — это система извлечения по запросу.</span><span class="sxs-lookup"><span data-stu-id="af975-231">Prometheus is a pull-based system.</span></span> <span data-ttu-id="af975-232">Она периодически извлекает метрики из настроенных расположений.</span><span class="sxs-lookup"><span data-stu-id="af975-232">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="af975-233">Prometheus может получать метрики, созданные cAdvisor или kube-state-metrics.</span><span class="sxs-lookup"><span data-stu-id="af975-233">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="af975-234">[kube-state-metrics][kube-state-metrics] — это служба, которая собирает метрики с сервера API Kubernetes и делает их доступными для Prometheus (или службы, совместимой с конечной точкой клиента Prometheus).</span><span class="sxs-lookup"><span data-stu-id="af975-234">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="af975-235">В то время как Heapster собирает метрики, которые создает и пересылает в приемник Kubernetes, служба kube-state-metrics создает свои метрики и делает их доступными для извлечения через конечную точку.</span><span class="sxs-lookup"><span data-stu-id="af975-235">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="af975-236">Для метрик системы используйте [Node exporter](https://github.com/prometheus/node_exporter). Это средство экспорта Prometheus для метрик системы.</span><span class="sxs-lookup"><span data-stu-id="af975-236">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="af975-237">Prometheus поддерживает данные с плавающей запятой, а не строки, поэтому эта система подходит для метрик системы, но не для журналов.</span><span class="sxs-lookup"><span data-stu-id="af975-237">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="af975-238">Для визуализации и отслеживания данных используйте средство с панелью мониторинга, например **Kibana** или **Grafana**.</span><span class="sxs-lookup"><span data-stu-id="af975-238">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="af975-239">Вы также можете запустить службу панели мониторинга в контейнере кластера.</span><span class="sxs-lookup"><span data-stu-id="af975-239">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="af975-240">Для журналов приложений используйте **Fluentd** и **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="af975-240">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="af975-241">Fluentd — это сборщик данных с открытым исходным кодом, а Elasticsearch — это база данных документов, которая оптимизирована для работы в качестве поисковой системы.</span><span class="sxs-lookup"><span data-stu-id="af975-241">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="af975-242">При таком подходе каждая служба отправляет журналы в `stdout` и `stderr`, а Kubernetes записывает эти потоки в локальную файловую систему.</span><span class="sxs-lookup"><span data-stu-id="af975-242">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="af975-243">Fluentd собирает журналы, при необходимости дополняет их метаданными из Kubernetes и отправляет их в Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="af975-243">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="af975-244">Создавайте панель мониторинга для Elasticsearch с помощью Kibana, Grafana или другого аналогичного средства.</span><span class="sxs-lookup"><span data-stu-id="af975-244">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="af975-245">Fluentd запускается в кластере в качестве daemonset. Это означает, что для каждого узла назначен один модуль Fluentd.</span><span class="sxs-lookup"><span data-stu-id="af975-245">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="af975-246">Вы можете настроить Fluentd для сбора журналов kubelet и журналов контейнера.</span><span class="sxs-lookup"><span data-stu-id="af975-246">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="af975-247">При больших объемах запись журналов в локальную файловую систему может стать узким местом производительности, особенно если несколько служб запущены на одном узле.</span><span class="sxs-lookup"><span data-stu-id="af975-247">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="af975-248">Выполните мониторинг задержки диска и использования файловой системы в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="af975-248">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="af975-249">Одно из преимуществ использования Fluentd и Elasticsearch заключается в том, что службам не требуются дополнительные зависимости библиотек.</span><span class="sxs-lookup"><span data-stu-id="af975-249">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="af975-250">Каждая служба просто записывает в `stdout` и `stderr`, а Fluentd выполняет экспорт журналов в Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="af975-250">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="af975-251">Кроме того, разработчикам в командах не нужно настраивать инфраструктуру ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="af975-251">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="af975-252">Единственная сложность состоит в том, чтобы настроить кластер Elasticsearch для рабочего развертывания, выполняющий масштабирование для обработки вашего трафика.</span><span class="sxs-lookup"><span data-stu-id="af975-252">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="af975-253">Другим вариантом является отправка журналов в Microsoft Operations Management Suite (OMS) Log Analytics.</span><span class="sxs-lookup"><span data-stu-id="af975-253">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="af975-254">Служба [Log Analytics][log-analytics] собирает данные журнала в центральном репозитории, а также объединяет данные из других служб Azure, которые приложение использует.</span><span class="sxs-lookup"><span data-stu-id="af975-254">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="af975-255">Дополнительные сведения см. в статье [Мониторинг кластера Службы контейнеров Azure с помощью Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="af975-255">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="af975-256">Пример: ведение журнала с использованием идентификаторов корреляции</span><span class="sxs-lookup"><span data-stu-id="af975-256">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="af975-257">Чтобы проиллюстрировать некоторые из моментов, представленных в этой главе, рассмотрим пример того, как служба посылок реализует ведение журнала.</span><span class="sxs-lookup"><span data-stu-id="af975-257">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="af975-258">Служба посылок написана на языке TypeScript. Она использует веб-платформу [Koa](http://koajs.com/) для Node.js.</span><span class="sxs-lookup"><span data-stu-id="af975-258">The Package service was written in TypeScript and uses the [Koa](http://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="af975-259">Доступно множество библиотек ведения журнала Node.js.</span><span class="sxs-lookup"><span data-stu-id="af975-259">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="af975-260">Мы выбрали [Winston](https://github.com/winstonjs/winston). Это популярная библиотека ведения журналов, которая отвечает нашим требованиям к производительности.</span><span class="sxs-lookup"><span data-stu-id="af975-260">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="af975-261">Чтобы инкапсулировать детали реализации, мы определили абстрактный интерфейс `ILogger`:</span><span class="sxs-lookup"><span data-stu-id="af975-261">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="af975-262">Ниже представлена реализация `ILogger`, которая служит оболочкой для библиотеки Winston.</span><span class="sxs-lookup"><span data-stu-id="af975-262">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="af975-263">Она вводит идентификатор корреляции в качестве параметра конструктора в каждое сообщение журнала.</span><span class="sxs-lookup"><span data-stu-id="af975-263">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="af975-264">Службе посылок необходимо извлечь идентификатор корреляции из HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="af975-264">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="af975-265">Например, если вы используете linkerd, идентификатор корреляции находится в заголовке `l5d-ctx-trace`.</span><span class="sxs-lookup"><span data-stu-id="af975-265">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="af975-266">В веб-платформе Koa HTTP-запрос хранится в объекте Context, который проходит через конвейер обработки запросов.</span><span class="sxs-lookup"><span data-stu-id="af975-266">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="af975-267">Мы можем определить функцию ПО промежуточного слоя, чтобы получить идентификатор корреляции из этого объекта и инициализировать средство ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="af975-267">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="af975-268">(Функция ПО промежуточного слоя в Koa — это функция, которая выполняется для каждого запроса.)</span><span class="sxs-lookup"><span data-stu-id="af975-268">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="af975-269">Это ПО промежуточного слоя вызывает определяемую вызывающим объектом функцию `getCorrelationId`, чтобы получить идентификатор корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-269">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="af975-270">Затем оно создает экземпляр средства ведения журнала и помещает его внутри `ctx.state`, который является словарем пар "ключ — значение", используемым в Koa для передачи информации по конвейеру.</span><span class="sxs-lookup"><span data-stu-id="af975-270">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="af975-271">ПО промежуточного слоя для средства ведения журнала добавляется в конвейер во время запуска:</span><span class="sxs-lookup"><span data-stu-id="af975-271">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="af975-272">После настройки можно легко добавить операторы ведения журнала в код.</span><span class="sxs-lookup"><span data-stu-id="af975-272">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="af975-273">Ниже приведен пример метода, который ищет посылку.</span><span class="sxs-lookup"><span data-stu-id="af975-273">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="af975-274">Выполняются два вызова метода `ILogger.info`.</span><span class="sxs-lookup"><span data-stu-id="af975-274">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="af975-275">Нам не нужно включать идентификатор корреляции в операторы ведения журнала, так как это уже сделано автоматически с помощью функции ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="af975-275">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="af975-276">Это делает код ведения журнала более простым и снижает вероятность того, что разработчик забудет включить идентификатор корреляции.</span><span class="sxs-lookup"><span data-stu-id="af975-276">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="af975-277">Так как все операторы ведения журнала используют абстрактный интерфейс `ILogger`, в случае необходимости позже было бы легко заменить реализацию средства ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="af975-277">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="af975-278">Непрерывная интеграция и поставка</span><span class="sxs-lookup"><span data-stu-id="af975-278">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/