---
title: "Непрерывная интеграция и непрерывная поставка микрослужб"
description: "Непрерывная интеграция и непрерывная поставка микрослужб"
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 7d8a81b7bc236e50d722a68a0115b9220d4e094f
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="designing-microservices-continuous-integration"></a><span data-ttu-id="42eab-103">Разработка микрослужб: непрерывная интеграция</span><span class="sxs-lookup"><span data-stu-id="42eab-103">Designing microservices: Continuous integration</span></span>

<span data-ttu-id="42eab-104">Непрерывная интеграция и непрерывная поставка (CI/CD) являются основным требованием для достижения успеха в работе с микрослужбами.</span><span class="sxs-lookup"><span data-stu-id="42eab-104">Continuous integration and continuous delivery (CI/CD) are a key requirement for achieving success with microservices.</span></span> <span data-ttu-id="42eab-105">Без хорошо налаженного процесса непрерывной интеграции и поставки невозможно добиться гибкости, которую обеспечивают микрослужбы.</span><span class="sxs-lookup"><span data-stu-id="42eab-105">Without a good CI/CD process, you will not achieve the agility that microservices promise.</span></span> <span data-ttu-id="42eab-106">При наличии нескольких баз кода и разнородных сред сборки для различных служб возникают определенные проблемы с непрерывной интеграцией и поставкой микрослужб.</span><span class="sxs-lookup"><span data-stu-id="42eab-106">Some of the CI/CD challenges for microservices arise from having multiple code bases and heterogenous build environments for the various services.</span></span> <span data-ttu-id="42eab-107">В этой главе содержится описание проблем и рекомендованные подходы для их решения.</span><span class="sxs-lookup"><span data-stu-id="42eab-107">This chapter describes the challenges and recommends some approaches to the problem.</span></span>

![](./images/ci-cd.png)

<span data-ttu-id="42eab-108">Одной из важнейших причин внедрения архитектуры микрослужб является ускорение жизненного цикла.</span><span class="sxs-lookup"><span data-stu-id="42eab-108">Faster release cycles are one of the biggest reasons to adopt a microservices architecture.</span></span> 

<span data-ttu-id="42eab-109">В исключительно монолитном приложении находится один конвейер сборки, выходные данные которого представляют собой исполняемый файл приложения.</span><span class="sxs-lookup"><span data-stu-id="42eab-109">In a purely monolithic application, there is a single build pipeline whose output is the application executable.</span></span> <span data-ttu-id="42eab-110">Все данные разработки поступают в этот конвейер.</span><span class="sxs-lookup"><span data-stu-id="42eab-110">All development work feeds into this pipeline.</span></span> <span data-ttu-id="42eab-111">При обнаружении ошибки с высоким приоритетом необходимо интегрировать, протестировать и опубликовать исправление, из-за чего может быть отложен выпуск новых функций.</span><span class="sxs-lookup"><span data-stu-id="42eab-111">If a high-priority bug is found, a fix must be integrated, tested, and published, which can delay the release of new features.</span></span> <span data-ttu-id="42eab-112">В действительности этих проблем можно избежать при наличии хорошо организованных модулей и при использовании ветвей компонентов, что помогает свести к минимуму влияние изменений кода.</span><span class="sxs-lookup"><span data-stu-id="42eab-112">It's true that you can mitigate these problems by having well-factored modules and using feature branches to minimize the impact of code changes.</span></span> <span data-ttu-id="42eab-113">Но так как объем данных приложения со временем увеличивается и оно становится более сложным, а также добавляются дополнительные функции, процесс выпуска для монолитного приложения становится нестабильным и часто нарушается.</span><span class="sxs-lookup"><span data-stu-id="42eab-113">But as the application grows more complex, and more features are added, the release process for a monolith tends to become more brittle and likely to break.</span></span> 

<span data-ttu-id="42eab-114">Принципы работы с микрослужбами предусматривают, что цепочка выпуска не может быть длинной, когда каждая команда должна становиться в очередь.</span><span class="sxs-lookup"><span data-stu-id="42eab-114">Following the microservices philosophy, there should never be a long release train where every team has to get in line.</span></span> <span data-ttu-id="42eab-115">Команда, создающая службу "A", может выпустить обновление в любое время, не ожидая объединения, тестирования и развертывания изменений в службе "B".</span><span class="sxs-lookup"><span data-stu-id="42eab-115">The team that builds service "A" can release an update at any time, without waiting for changes in service "B" to be merged, tested, and deployed.</span></span> <span data-ttu-id="42eab-116">Чтобы это обеспечить, чрезвычайно важно наладить процесс непрерывной интеграции и поставки.</span><span class="sxs-lookup"><span data-stu-id="42eab-116">The CI/CD process is critical to making this possible.</span></span> <span data-ttu-id="42eab-117">Конвейер выпуска должен быть автоматическим и очень надежным, чтобы свести к минимуму риски развертывания обновлений.</span><span class="sxs-lookup"><span data-stu-id="42eab-117">Your release pipeline must be automated and highly reliable, so that the risks of deploying updates are minimized.</span></span> <span data-ttu-id="42eab-118">Если вы выполняете выпуск в рабочую среду каждый день или несколько раз в день, регрессии или перерывы в работе должны возникать очень редко.</span><span class="sxs-lookup"><span data-stu-id="42eab-118">If you are releasing to production daily or multiple times a day, regressions or service disruptions must be very rare.</span></span> <span data-ttu-id="42eab-119">В то же время в случае развертывания неправильного обновления необходимо располагать надежным способом быстро выполнить откат или накат до предыдущей версии службы.</span><span class="sxs-lookup"><span data-stu-id="42eab-119">At the same time, if a bad update does get deployed, you must have a reliable way to quickly roll back or roll forward to a previous version of a service.</span></span>

![](./images/cicd-monolith.png)

<span data-ttu-id="42eab-120">Когда идет речь о непрерывной интеграции и поставке, имеются в виду несколько связанных процессов: непрерывная интеграция, непрерывная поставка и непрерывное развертывание.</span><span class="sxs-lookup"><span data-stu-id="42eab-120">When we talk about CI/CD, we are really talking about several related processes: Continuous integration, continuous delivery, and continuous deployment.</span></span>

- <span data-ttu-id="42eab-121">Непрерывная интеграция подразумевает частое слияние изменений кода с главной ветвью с использованием автоматизированных процессов сборки и тестирования. Благодаря этому код в главной ветви всегда соответствует рабочему уровню.</span><span class="sxs-lookup"><span data-stu-id="42eab-121">Continuous integration means that code changes are frequently merged into the main branch, using automated build and test processes to ensure that  code in the main branch is always production-quality.</span></span>

- <span data-ttu-id="42eab-122">Непрерывная поставка означает, что изменения кода, которые прошли процесс непрерывной интеграции, автоматически публикуются в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-122">Continuous delivery means that code changes that pass the CI process are automatically published to a production-like environment.</span></span> <span data-ttu-id="42eab-123">Для развертывания в рабочей среде может потребоваться утверждение вручную, в противном случае оно выполняется автоматически.</span><span class="sxs-lookup"><span data-stu-id="42eab-123">Deployment into the live production environment may require manual approval, but is otherwise automated.</span></span> <span data-ttu-id="42eab-124">В результате этого код всегда будет *готов* к развертыванию в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-124">The goal is that your code should always be *ready* to deploy into production.</span></span>

- <span data-ttu-id="42eab-125">Непрерывное развертывание означает, что изменения кода, прошедшие процесс непрерывной интеграции и поставки, автоматически развертываются в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-125">Continuous deployment means that code changes that pass the CI/CD process are automatically deployed into production.</span></span>

<span data-ttu-id="42eab-126">В контексте Kubernetes и микрослужб на этапе непрерывной интеграции происходит сборка и тестирование образов контейнеров и помещение этих образов в реестр контейнеров.</span><span class="sxs-lookup"><span data-stu-id="42eab-126">In the context of Kubernetes and microservices, the CI stage is concerned with building and testing container images, and pushing those images to a container registry.</span></span> <span data-ttu-id="42eab-127">На этапе развертывания спецификации pod обновляются, чтобы был выбран самый последний образ рабочей среды.</span><span class="sxs-lookup"><span data-stu-id="42eab-127">In the deployment stage, pod specs are updated to pick up the latest production image.</span></span>

## <a name="challenges"></a><span data-ttu-id="42eab-128">Сложности</span><span class="sxs-lookup"><span data-stu-id="42eab-128">Challenges</span></span>

- <span data-ttu-id="42eab-129">**Множество небольших независимых баз кода**.</span><span class="sxs-lookup"><span data-stu-id="42eab-129">**Many small independent code bases**.</span></span> <span data-ttu-id="42eab-130">Каждая команда отвечает за создание собственной службы со своим собственным конвейером сборки.</span><span class="sxs-lookup"><span data-stu-id="42eab-130">Each team is responsible for building its own service, with its own build pipeline.</span></span> <span data-ttu-id="42eab-131">В некоторых организациях команды могут использовать отдельные репозитории кода.</span><span class="sxs-lookup"><span data-stu-id="42eab-131">In some organizations, teams may use separate code repositories.</span></span> <span data-ttu-id="42eab-132">Это может привести к ситуации, когда многие команды знают, как создать систему, но никто в организации не знает, как развернуть все приложение.</span><span class="sxs-lookup"><span data-stu-id="42eab-132">This could lead to a situation where the knowledge of how to build the system is spread across teams, and nobody in the organization knows how to deploy the entire application.</span></span> <span data-ttu-id="42eab-133">Например, что происходит в сценарии аварийного восстановления, если необходимо быстро выполнить развертывание в новый кластер?</span><span class="sxs-lookup"><span data-stu-id="42eab-133">For example, what happens in a disaster recovery scenario, if you need to quickly deploy to a new cluster?</span></span>   

- <span data-ttu-id="42eab-134">**Множество языков программирования и платформ**.</span><span class="sxs-lookup"><span data-stu-id="42eab-134">**Multiple languages and frameworks**.</span></span> <span data-ttu-id="42eab-135">При том, что каждая команда использует свой собственный набор технологий, могут возникнуть сложности в создании процесса сборки, применимого для всей организации.</span><span class="sxs-lookup"><span data-stu-id="42eab-135">With each team using its own mix of technologies, it can be difficult to create a single build process that works across the organization.</span></span> <span data-ttu-id="42eab-136">Процесс сборки должен быть достаточно гибким, чтобы любая команда могла использовать его независимо от выбранного языка программирования или платформы.</span><span class="sxs-lookup"><span data-stu-id="42eab-136">The build process must be flexible enough that every team can adapt it for their choice of language or framework.</span></span> 

- <span data-ttu-id="42eab-137">**Интеграция и нагрузочное тестирование**.</span><span class="sxs-lookup"><span data-stu-id="42eab-137">**Integration and load testing**.</span></span> <span data-ttu-id="42eab-138">Так как команды выпускают обновления независимо друг от друга, с разработкой надежного и комплексного тестирования могут возникнуть сложности, особенно если у службы есть зависимости от других служб.</span><span class="sxs-lookup"><span data-stu-id="42eab-138">With teams releasing updates at their own pace, it can be challenging to design robust end-to-end testing, especially when services have dependencies on other services.</span></span> <span data-ttu-id="42eab-139">Кроме того, запуск полного рабочего кластера может быть дорогостоящим, поэтому маловероятно, что каждая команда сможет запустить весь собственный кластер в производственных масштабах только для тестирования.</span><span class="sxs-lookup"><span data-stu-id="42eab-139">Moreover, running a full production cluster can be expensive, so it's unlikely that every team will be able to run its own full cluster at production scales, just for testing.</span></span> 

- <span data-ttu-id="42eab-140">**Управление выпусками**.</span><span class="sxs-lookup"><span data-stu-id="42eab-140">**Release management**.</span></span> <span data-ttu-id="42eab-141">Любая команда должна иметь возможность развернуть обновление в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-141">Every team should have the ability to deploy an update to production.</span></span> <span data-ttu-id="42eab-142">Это не означает, что у каждого участника команды есть на это разрешения.</span><span class="sxs-lookup"><span data-stu-id="42eab-142">That doesn't mean that every team member has permissions to do so.</span></span> <span data-ttu-id="42eab-143">Но при наличии централизованной роли диспетчера выпусков может снизиться скорость развертываний.</span><span class="sxs-lookup"><span data-stu-id="42eab-143">But having a centralized Release Manager role can reduce the velocity of deployments.</span></span> <span data-ttu-id="42eab-144">Чем больше автоматизирован процесс непрерывной интеграции и поставки и чем выше его надежность, тем меньше потребность в центральном администрировании.</span><span class="sxs-lookup"><span data-stu-id="42eab-144">The more that your CI/CD process is automated and reliable, the less there should be a need for a central authority.</span></span> <span data-ttu-id="42eab-145">С другой стороны, могут применяться различные политики для выпуска обновлений основных компонентов и небольших исправлений ошибок.</span><span class="sxs-lookup"><span data-stu-id="42eab-145">That said, you might have different policies for releasing major feature updates versus minor bug fixes.</span></span> <span data-ttu-id="42eab-146">Децентрализация вовсе не подразумевает отсутствие управления.</span><span class="sxs-lookup"><span data-stu-id="42eab-146">Being decentralized does not mean there should be zero governance.</span></span>

- <span data-ttu-id="42eab-147">**Управление версиями образов контейнеров**.</span><span class="sxs-lookup"><span data-stu-id="42eab-147">**Container image versioning**.</span></span> <span data-ttu-id="42eab-148">Во время цикла разработки и тестирования процесс непрерывной интеграции и поставки включает в себя сборку многих образов контейнера.</span><span class="sxs-lookup"><span data-stu-id="42eab-148">During the development and test cycle, the CI/CD process will build many container images.</span></span> <span data-ttu-id="42eab-149">Только некоторые из них становятся кандидатами для выпуска, а затем только некоторые из этих релиз-кандидатов помещаются в рабочую среду.</span><span class="sxs-lookup"><span data-stu-id="42eab-149">Only some of those are candidates for release, and then only some of those release candidates will get pushed into production.</span></span> <span data-ttu-id="42eab-150">Вы должны иметь четкую стратегию управления версиями, чтобы знать, какие образы сейчас развернуты в рабочей среде, и выполнить откат до предыдущей версии при необходимости.</span><span class="sxs-lookup"><span data-stu-id="42eab-150">You should have a clear versioning strategy, so that you know which images are currently deployed to production, and can roll back to a previous version if necessary.</span></span> 

- <span data-ttu-id="42eab-151">**Обновления службы**.</span><span class="sxs-lookup"><span data-stu-id="42eab-151">**Service updates**.</span></span> <span data-ttu-id="42eab-152">Обновление службы до новой версии не должно нарушать работу других служб, зависящих от нее.</span><span class="sxs-lookup"><span data-stu-id="42eab-152">When you update a service to a new version, it shouldn't break other services that depend on it.</span></span> <span data-ttu-id="42eab-153">Если выполняется последовательное обновление, в течение определенного периода времени могут быть запущены несколько версий.</span><span class="sxs-lookup"><span data-stu-id="42eab-153">If you do a rolling update, there will be a period of time when a mix of versions is running.</span></span> 
 
<span data-ttu-id="42eab-154">Эти трудности определяют основные противоречия.</span><span class="sxs-lookup"><span data-stu-id="42eab-154">These challenges reflect a fundamental tension.</span></span> <span data-ttu-id="42eab-155">С одной стороны, командам необходимо работать независимо друг от друга, насколько это возможно.</span><span class="sxs-lookup"><span data-stu-id="42eab-155">On the one hand, teams need to work as independently as possible.</span></span> <span data-ttu-id="42eab-156">С другой стороны, требуется некоторое координирование, чтобы один человек мог выполнять такие задачи, как запуск интеграционного теста, повторное развертывание всего решения в новый кластер или откат неправильного обновления.</span><span class="sxs-lookup"><span data-stu-id="42eab-156">On the other hand, some coordination is needed so that a single person can do tasks like running an integration test, redeploying the entire solution to a new cluster, or rolling back a bad update.</span></span> 
 
## <a name="cicd-approaches-for-microservices"></a><span data-ttu-id="42eab-157">Подходы непрерывной интеграции и поставки для микрослужб</span><span class="sxs-lookup"><span data-stu-id="42eab-157">CI/CD approaches for microservices</span></span>

<span data-ttu-id="42eab-158">Каждой группе поддержки рекомендуется выполнить контейнеризацию среды сборки.</span><span class="sxs-lookup"><span data-stu-id="42eab-158">It's a good practice for every service team to containerize their build environment.</span></span> <span data-ttu-id="42eab-159">В этом контейнере должны быть все средства сборки, необходимые для сборки артефактов кода для их службы.</span><span class="sxs-lookup"><span data-stu-id="42eab-159">This container should have all of the build tools necessary to build the code artifacts for their service.</span></span> <span data-ttu-id="42eab-160">Часто вы можете найти официальный образ Docker для вашего языка программирования и платформы.</span><span class="sxs-lookup"><span data-stu-id="42eab-160">Often you can find an official Docker image for your language and framework.</span></span> <span data-ttu-id="42eab-161">После этого можно воспользоваться `docker run` или Docker Compose для запуска сборки.</span><span class="sxs-lookup"><span data-stu-id="42eab-161">Then you can use `docker run` or Docker Compose to run the build.</span></span> 

<span data-ttu-id="42eab-162">При таком подходе настраивать новую среду сборки совсем несложно.</span><span class="sxs-lookup"><span data-stu-id="42eab-162">With this approach, it's trivial to set up a new build environment.</span></span> <span data-ttu-id="42eab-163">Разработчику, желающему выполнить сборку кода, не нужно устанавливать набор средств сборки. Достаточно лишь запустить образ контейнера.</span><span class="sxs-lookup"><span data-stu-id="42eab-163">A developer who wants to build your code doesn't need to install a set of build tools, but simply runs the container image.</span></span> <span data-ttu-id="42eab-164">Впрочем, для выполнения этой задачи можно настроить ваш сервер сборки, что гораздо важнее.</span><span class="sxs-lookup"><span data-stu-id="42eab-164">Perhaps more importantly, your build server can be configured to do the same thing.</span></span> <span data-ttu-id="42eab-165">Таким образом, вам не требуется устанавливать эти средства на сервере сборки или управлять конфликтующими версиями средств.</span><span class="sxs-lookup"><span data-stu-id="42eab-165">That way, you don't need to install those tools onto the build server, or manage conflicting versions of tools.</span></span> 

<span data-ttu-id="42eab-166">При локальной разработке и тестировании используйте Docker для запуска службы внутри контейнера.</span><span class="sxs-lookup"><span data-stu-id="42eab-166">For local development and testing, use Docker to run the service inside a container.</span></span> <span data-ttu-id="42eab-167">В рамках этого процесса может потребоваться запустить другие контейнеры, в которых есть службы имитации или тестовые базы данных, необходимые для локального тестирования.</span><span class="sxs-lookup"><span data-stu-id="42eab-167">As part of this process, you may need to run other containers that have mock services or test databases needed for local testing.</span></span> <span data-ttu-id="42eab-168">Вы можете использовать Docker Compose, чтобы координировать эти контейнеры, либо Minikube, чтобы запустить Kubernetes локально.</span><span class="sxs-lookup"><span data-stu-id="42eab-168">You could use Docker Compose to coordinate these containers, or use Minikube to run Kubernetes locally.</span></span> 

<span data-ttu-id="42eab-169">Когда код будет готов, подайте запрос на вытягивание и выполните слияние в главную ветвь.</span><span class="sxs-lookup"><span data-stu-id="42eab-169">When the code is ready, open a pull request and merge into master.</span></span> <span data-ttu-id="42eab-170">Это запустит на сервере сборки задание:</span><span class="sxs-lookup"><span data-stu-id="42eab-170">This will start a job on the build server:</span></span>

1. <span data-ttu-id="42eab-171">Сборка ресурсов кода.</span><span class="sxs-lookup"><span data-stu-id="42eab-171">Build the code assets.</span></span> 
2. <span data-ttu-id="42eab-172">Выполнение модульных тестов кода.</span><span class="sxs-lookup"><span data-stu-id="42eab-172">Run unit tests against the code.</span></span>
3. <span data-ttu-id="42eab-173">Создание образа контейнера.</span><span class="sxs-lookup"><span data-stu-id="42eab-173">Build the container image.</span></span>
4. <span data-ttu-id="42eab-174">Проверка образа контейнера путем выполнения функциональных тестов в запущенном контейнере.</span><span class="sxs-lookup"><span data-stu-id="42eab-174">Test the container image by running functional tests on a running container.</span></span> <span data-ttu-id="42eab-175">На этом шаге можно перехватить ошибки в файле Docker, например неправильную точку входа.</span><span class="sxs-lookup"><span data-stu-id="42eab-175">This step can catch errors in the Docker file, such as a bad entry point.</span></span>
5. <span data-ttu-id="42eab-176">Отправка образа в реестр контейнеров.</span><span class="sxs-lookup"><span data-stu-id="42eab-176">Push the image to a container registry.</span></span>
6. <span data-ttu-id="42eab-177">Обновление тестового кластера с помощью нового образа для запуска тестов интеграции.</span><span class="sxs-lookup"><span data-stu-id="42eab-177">Update the test cluster with the new image to run integration tests.</span></span>

<span data-ttu-id="42eab-178">Когда образ будет готов к работе в рабочей среде, обновите файлы развертывания, указав последний образ, включительно с файлами конфигурации Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="42eab-178">When the image is ready to go into production, update the deployment files as needed to specify the latest image, including any Kubernetes configuration files.</span></span> <span data-ttu-id="42eab-179">Затем примените обновление в рабочем кластере.</span><span class="sxs-lookup"><span data-stu-id="42eab-179">Then apply the update to the production cluster.</span></span>

<span data-ttu-id="42eab-180">Ниже приведены некоторые рекомендации по повышению надежности развертываний.</span><span class="sxs-lookup"><span data-stu-id="42eab-180">Here are some recommendations for making deployments more reliable:</span></span>
 
- <span data-ttu-id="42eab-181">Определите действующие для всей организации соглашения для тегов контейнеров, управления версиями и соглашения об именовании ресурсов, развернутых в кластере (модули, службы и т. д.).</span><span class="sxs-lookup"><span data-stu-id="42eab-181">Define organization-wide conventions for container tags, versioning, and naming conventions for resources deployed to the cluster (pods, services, and so on).</span></span> <span data-ttu-id="42eab-182">В результате этого будет легче диагностировать проблемы с развертыванием.</span><span class="sxs-lookup"><span data-stu-id="42eab-182">That can make it easier to diagnose deployment issues.</span></span> 

- <span data-ttu-id="42eab-183">Создайте два отдельных реестра контейнеров: один для разработки и тестирования, а другой — для рабочей среды.</span><span class="sxs-lookup"><span data-stu-id="42eab-183">Create two separate container registries, one for development/testing and one for production.</span></span> <span data-ttu-id="42eab-184">Не отправляйте образ в реестр рабочей среды, пока не будете готовы к его развертыванию в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-184">Don't push an image to the production registry until you're ready to deploy it into production.</span></span> <span data-ttu-id="42eab-185">При использовании такого подхода с семантическим управлением версиями образов контейнеров можно уменьшить вероятность случайного развертывания версии, не утвержденной для выпуска.</span><span class="sxs-lookup"><span data-stu-id="42eab-185">If you combine this practice with semantic versioning of container images, it can reduce the chance of accidentally deploying a version that wasn't approved for release.</span></span>

## <a name="updating-services"></a><span data-ttu-id="42eab-186">Обновление служб</span><span class="sxs-lookup"><span data-stu-id="42eab-186">Updating services</span></span>

<span data-ttu-id="42eab-187">Есть различные стратегии обновления службы, которая уже находится в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="42eab-187">There are various strategies for updating a service that's already in production.</span></span> <span data-ttu-id="42eab-188">Здесь рассматриваются три распространенных варианта: последовательное обновление, "сине-зеленое" развертывание и ранний выпуск.</span><span class="sxs-lookup"><span data-stu-id="42eab-188">Here we discuss three common options: Rolling update, blue-green deployment, and canary release.</span></span>

### <a name="rolling-update"></a><span data-ttu-id="42eab-189">Последовательное обновление</span><span class="sxs-lookup"><span data-stu-id="42eab-189">Rolling update</span></span> 

<span data-ttu-id="42eab-190">В последовательном обновлении развертываются новые экземпляры службы, которые сразу же начинают получать запросы.</span><span class="sxs-lookup"><span data-stu-id="42eab-190">In a rolling update, you deploy new instances of a service, and the new instances start receiving requests right away.</span></span> <span data-ttu-id="42eab-191">При появлении новых экземпляров предыдущие экземпляры удаляются.</span><span class="sxs-lookup"><span data-stu-id="42eab-191">As the new instances come up, the previous instances are removed.</span></span>

<span data-ttu-id="42eab-192">Последовательное обновление — это поведение по умолчанию в Kubernetes при обновлении спецификации pod для развертывания.</span><span class="sxs-lookup"><span data-stu-id="42eab-192">Rolling updates are the default behavior in Kubernetes when you update the pod spec for a Deployment.</span></span> <span data-ttu-id="42eab-193">Контроллер развертывания создает новый набор реплик для обновленных модулей pod.</span><span class="sxs-lookup"><span data-stu-id="42eab-193">The Deployment controller creates a new ReplicaSet for the updated pods.</span></span> <span data-ttu-id="42eab-194">Затем он масштабирует новый набор реплик, при этом уменьшая масштаб старого набора реплик, чтобы сохранить необходимое количество реплик.</span><span class="sxs-lookup"><span data-stu-id="42eab-194">Then it scales up the new ReplicaSet while scaling down the old one, to maintain the desired replica count.</span></span> <span data-ttu-id="42eab-195">Пока не готовы новые модули pod, старые модули не удаляются.</span><span class="sxs-lookup"><span data-stu-id="42eab-195">It doesn't delete old pods until the new ones are ready.</span></span> <span data-ttu-id="42eab-196">Kubernetes сохраняет журнал обновлений, чтобы можно было использовать kubectl для отката обновления при необходимости.</span><span class="sxs-lookup"><span data-stu-id="42eab-196">Kubernetes keeps a history of the update, so you can use kubectl to roll back an update if needed.</span></span> 

<span data-ttu-id="42eab-197">Если служба выполняет длительную задачу запуска, можно настроить пробу готовности.</span><span class="sxs-lookup"><span data-stu-id="42eab-197">If your service performs a long startup task, you can define a readiness probe.</span></span> <span data-ttu-id="42eab-198">Проба готовности сообщает, когда контейнер готов к получению трафика.</span><span class="sxs-lookup"><span data-stu-id="42eab-198">The readiness probe reports when the container is ready to start receiving traffic.</span></span> <span data-ttu-id="42eab-199">Kubernetes не будет отправлять трафик в модуль pod, пока проба не сообщит об успешном выполнении.</span><span class="sxs-lookup"><span data-stu-id="42eab-199">Kubernetes won't send traffic to the pod until the probe reports success.</span></span> 

<span data-ttu-id="42eab-200">Одной из проблем последовательного обновления является то, что во время обновления и старая, и новая версии выполняются и получают трафик.</span><span class="sxs-lookup"><span data-stu-id="42eab-200">One challenge of rolling updates is that during the update process, a mix of old and new versions are running and receiving traffic.</span></span> <span data-ttu-id="42eab-201">В течение этого периода любой запрос может перенаправляться в одну из двух версий.</span><span class="sxs-lookup"><span data-stu-id="42eab-201">During this period, any request could get routed to either of the two versions.</span></span> <span data-ttu-id="42eab-202">Это может вызвать проблемы в зависимости от масштаба изменений в обеих версиях.</span><span class="sxs-lookup"><span data-stu-id="42eab-202">That may or may not cause problems, depending on the scope of the changes between the two versions.</span></span> 

### <a name="blue-green-deployment"></a><span data-ttu-id="42eab-203">"Сине-зеленое" развертывание</span><span class="sxs-lookup"><span data-stu-id="42eab-203">Blue-green deployment</span></span>

<span data-ttu-id="42eab-204">При "сине-зеленом" развертывании новая версия развертывается параллельно с предыдущей версией.</span><span class="sxs-lookup"><span data-stu-id="42eab-204">In a blue-green deployment, you deploy the new version alongside the previous version.</span></span> <span data-ttu-id="42eab-205">После проверки новой версии весь трафик сразу же переходит из предыдущей версии в новую.</span><span class="sxs-lookup"><span data-stu-id="42eab-205">After you validate the new version, you switch all traffic at once from the previous version to the new version.</span></span> <span data-ttu-id="42eab-206">После переключения трафика выполняется мониторинг приложения на наличие проблем.</span><span class="sxs-lookup"><span data-stu-id="42eab-206">After the switch, you monitor the application for any problems.</span></span> <span data-ttu-id="42eab-207">Если что-то пойдет не так, можно вернуться обратно к старой версии.</span><span class="sxs-lookup"><span data-stu-id="42eab-207">If something goes wrong, you can swap back to the old version.</span></span> <span data-ttu-id="42eab-208">При условии, что проблем нет, старую версию можно удалить.</span><span class="sxs-lookup"><span data-stu-id="42eab-208">Assuming there are no problems, you can delete the old version.</span></span>

<span data-ttu-id="42eab-209">В более традиционных монолитных или n-уровневых приложениях "сине-зеленое" развертывание обычно подразумевает подготовку двух идентичных сред.</span><span class="sxs-lookup"><span data-stu-id="42eab-209">With a more traditional monolithic or N-tier application, blue-green deployment generally meant provisioning two identical environments.</span></span> <span data-ttu-id="42eab-210">Понадобится развернуть новую версию в промежуточной среде, а затем перенаправить трафик клиента в промежуточную среду. Например, путем переключения виртуальных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="42eab-210">You would deploy the new version to a staging environment, then redirect client traffic to the staging environment &mdash; for example, by swapping VIP addresses.</span></span>

<span data-ttu-id="42eab-211">В Kubernetes для выполнения "сине-зеленых" развертываний не нужно подготавливать отдельный кластер.</span><span class="sxs-lookup"><span data-stu-id="42eab-211">In Kubernetes, you don't need to provision a separate cluster to do blue-green deployments.</span></span> <span data-ttu-id="42eab-212">Вместо этого можно воспользоваться селекторами.</span><span class="sxs-lookup"><span data-stu-id="42eab-212">Instead, you can take advantage of selectors.</span></span> <span data-ttu-id="42eab-213">Создайте новый ресурс развертывания с новой спецификацией pod и другим набором меток.</span><span class="sxs-lookup"><span data-stu-id="42eab-213">Create a new Deployment resource with a new pod spec and a different set of labels.</span></span> <span data-ttu-id="42eab-214">Создайте это развертывание, не удаляя предыдущее развертывание и не изменяя службу, которая указывает на него.</span><span class="sxs-lookup"><span data-stu-id="42eab-214">Create this deployment, without deleting the previous deployment or modifying the service that points to it.</span></span> <span data-ttu-id="42eab-215">После запуска новых модулей pod можно обновить селектор службы в соответствии с новым развертыванием.</span><span class="sxs-lookup"><span data-stu-id="42eab-215">Once the new pods are running, you can update the service's selector to match the new deployment.</span></span> 

<span data-ttu-id="42eab-216">Преимущество "сине-зеленого" развертывания состоит в том, что служба выполняет переключение всех модулей pod в одно и то же время.</span><span class="sxs-lookup"><span data-stu-id="42eab-216">An advantage of blue-green deployments is that the service switches all the pods at the same time.</span></span> <span data-ttu-id="42eab-217">После обновления службы все новые запросы будут направляться в новую версию.</span><span class="sxs-lookup"><span data-stu-id="42eab-217">After the service is updated, all new requests get routed to the new version.</span></span> <span data-ttu-id="42eab-218">Недостатком является то, что во время обновления выполняется в два раза больше модулей pod для службы (текущих и следующих).</span><span class="sxs-lookup"><span data-stu-id="42eab-218">One drawback is that during the update, you are running twice as many pods for the service (current and next).</span></span> <span data-ttu-id="42eab-219">Если для модулей pod требуется больший объем ресурсов ЦП или памяти, может потребоваться временно развернуть кластер, чтобы справиться с потреблением ресурсов.</span><span class="sxs-lookup"><span data-stu-id="42eab-219">If the pods require a lot of CPU or memory resources, you may need to scale out the cluster temporarily to handle the resource consumption.</span></span> 

### <a name="canary-release"></a><span data-ttu-id="42eab-220">Ранний выпуск</span><span class="sxs-lookup"><span data-stu-id="42eab-220">Canary release</span></span>

<span data-ttu-id="42eab-221">В раннем выпуске обновленная версия развертывается в небольшое количество клиентов.</span><span class="sxs-lookup"><span data-stu-id="42eab-221">In a canary release, you roll out an updated version to a small number of clients.</span></span> <span data-ttu-id="42eab-222">Затем отслеживается поведение новой службы, прежде чем развернуть ее для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="42eab-222">Then you monitor the behavior of the new service before rolling it out to all clients.</span></span> <span data-ttu-id="42eab-223">Так вы можете выполнить медленный выпуск контролируемым способом, наблюдать за реальными данными, а также обнаруживать проблемы, прежде чем они затронут всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="42eab-223">This lets you do a slow rollout in a controlled fashion, observe real data, and spot problems before all customers are affected.</span></span>

<span data-ttu-id="42eab-224">Ранний выпуск сложнее в управлении, чем "сине-зеленое" развертывание или последовательное обновление, так как необходимо динамически направлять запросы в разные версии службы.</span><span class="sxs-lookup"><span data-stu-id="42eab-224">A canary release is more complex to manage than either blue-green or rolling update, because you must dynamically route requests to different versions of the service.</span></span> <span data-ttu-id="42eab-225">В Kubernetes можно настроить службу так, чтобы охватить два набора реплик (по одному для каждой версии) и регулировать счетчики реплики вручную.</span><span class="sxs-lookup"><span data-stu-id="42eab-225">In Kubernetes, you can configure a Service to span two replica sets (one for each version) and adjust the replica counts manually.</span></span> <span data-ttu-id="42eab-226">Тем не менее этот подход не детализирован из-за того, как Kubernetes распределяет нагрузку между модулями pod.</span><span class="sxs-lookup"><span data-stu-id="42eab-226">However, this approach is rather coarse-grained, because of the way Kubernetes load balances across pods.</span></span> <span data-ttu-id="42eab-227">Например, при наличии десяти реплик сместить трафик можно только с шагом приращения 10 %.</span><span class="sxs-lookup"><span data-stu-id="42eab-227">For example, if you have a total of ten replicas, you can only shift traffic in 10% increments.</span></span> <span data-ttu-id="42eab-228">При использовании ПО слоя взаимодействия между службами можно использовать правила маршрутизации для реализации более сложной стратегии раннего выпуска.</span><span class="sxs-lookup"><span data-stu-id="42eab-228">If you are using a service mesh, you can use the service mesh routing rules to implement a more sophisticated canary release strategy.</span></span> <span data-ttu-id="42eab-229">Ниже приведены некоторые ресурсы, которые могут оказаться полезными:</span><span class="sxs-lookup"><span data-stu-id="42eab-229">Here are some resources that may be helpful:</span></span>

- <span data-ttu-id="42eab-230">Kubernetes без ПО слоя взаимодействия между службами: [Canary deployments](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments) (Ранние развертывания);</span><span class="sxs-lookup"><span data-stu-id="42eab-230">Kubernetes without service mesh: [Canary deployments](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)</span></span>
- <span data-ttu-id="42eab-231">Linkerd: [Dynamic request routing](https://linkerd.io/features/routing/) (Маршрутизация динамических запросов);</span><span class="sxs-lookup"><span data-stu-id="42eab-231">Linkerd: [Dynamic request routing](https://linkerd.io/features/routing/)</span></span>
- <span data-ttu-id="42eab-232">Istio: [Canary Deployments using Istio](https://istio.io/blog/canary-deployments-using-istio.html) (Ранние развертывания с использованием Istio).</span><span class="sxs-lookup"><span data-stu-id="42eab-232">Istio: [Canary Deployments using Istio](https://istio.io/blog/canary-deployments-using-istio.html)</span></span>

## <a name="conclusion"></a><span data-ttu-id="42eab-233">Заключение</span><span class="sxs-lookup"><span data-stu-id="42eab-233">Conclusion</span></span>

<span data-ttu-id="42eab-234">В последние годы произошло кардинальное изменение в отрасли: переход от создания *систем записи* до создания *систем взаимодействия*.</span><span class="sxs-lookup"><span data-stu-id="42eab-234">In recent years, there has been a sea change in the industry, a movement from building *systems of record* to building *systems of engagement*.</span></span>

<span data-ttu-id="42eab-235">Системы записи — это традиционные приложения операционных отделов организации для управления клиентскими данными.</span><span class="sxs-lookup"><span data-stu-id="42eab-235">Systems of record are traditional back-office data management applications.</span></span> <span data-ttu-id="42eab-236">В основе этих систем часто лежит реляционная СУБД, которая является единым источником достоверных данных.</span><span class="sxs-lookup"><span data-stu-id="42eab-236">At the heart of these systems there often sits an RDBMS that is the single source of truth.</span></span> <span data-ttu-id="42eab-237">Термин "система вовлечения, или взаимодействия" ввел Джеффри Мур (Geoffrey Moore) в работе 2011 г. *Systems of Engagement and the Future of Enterprise IT* (Системы взаимодействия и будущее корпоративной ИТ-среды).</span><span class="sxs-lookup"><span data-stu-id="42eab-237">The term "system of engagement" is credited to Geoffrey Moore, in his 2011 paper *Systems of Engagement and the Future of Enterprise IT*.</span></span> <span data-ttu-id="42eab-238">Системы взаимодействия — это приложения, ориентированные на поддержку связи и совместную работу.</span><span class="sxs-lookup"><span data-stu-id="42eab-238">Systems of engagement are applications focused on communication and collaboration.</span></span> <span data-ttu-id="42eab-239">Они дают пользователям возможность взаимодействовать в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="42eab-239">They connect people in real time.</span></span> <span data-ttu-id="42eab-240">Они должны быть доступными круглосуточно.</span><span class="sxs-lookup"><span data-stu-id="42eab-240">They must be available 24/7.</span></span> <span data-ttu-id="42eab-241">Новые функции вводятся регулярно, при этом приложение не отключается.</span><span class="sxs-lookup"><span data-stu-id="42eab-241">New features are introduced regularly without taking the application offline.</span></span> <span data-ttu-id="42eab-242">Пользователи рассчитывают на большее и не допускают непредвиденных задержек или простоев.</span><span class="sxs-lookup"><span data-stu-id="42eab-242">Users expect more and are less patient of unexpected delays or downtime.</span></span>

<span data-ttu-id="42eab-243">На стороне потребителя удобство работы может иметь определенную ценность для бизнеса.</span><span class="sxs-lookup"><span data-stu-id="42eab-243">In the consumer space, a better user experience can have measurable business value.</span></span> <span data-ttu-id="42eab-244">От количества времени, которое пользователь работает с приложением, напрямую зависит прибыль компании.</span><span class="sxs-lookup"><span data-stu-id="42eab-244">The amount of time that a user engages with an application may translate directly into revenue.</span></span> <span data-ttu-id="42eab-245">И в области бизнес-систем ожидания пользователей изменились.</span><span class="sxs-lookup"><span data-stu-id="42eab-245">And in the realm of business systems, users' expectations have changed.</span></span> <span data-ttu-id="42eab-246">Если эти системы предназначены для высокоэффективного взаимодействия и совместной работы, в них должны быть учтены особенности клиентских приложений.</span><span class="sxs-lookup"><span data-stu-id="42eab-246">If these systems aim to foster communication and collaboration, they must take their cue from consumer-facing applications.</span></span>

<span data-ttu-id="42eab-247">Микрослужбы являются ответом на этот изменяющийся ландшафт.</span><span class="sxs-lookup"><span data-stu-id="42eab-247">Microservices are a response to this changing landscape.</span></span> <span data-ttu-id="42eab-248">Разбивая монолитное приложение на группу слабо связанных служб, мы можем управлять циклом выпуска каждой службы и выполнять частые обновления без перерывов в работе и внесения критических изменений.</span><span class="sxs-lookup"><span data-stu-id="42eab-248">By decomposing a monolithic application into a group of loosely coupled services, we can control the release cycle of each service, and enable frequent updates without downtime or breaking changes.</span></span> <span data-ttu-id="42eab-249">Микрослужбы также гарантируют масштабируемость, изоляцию от сбоев и устойчивость.</span><span class="sxs-lookup"><span data-stu-id="42eab-249">Microservices also help with scalability, failure isolation, and resiliency.</span></span> <span data-ttu-id="42eab-250">В то же время облачные платформы упрощают создание и запуск микрослужб с помощью автоматической подготовки вычислительных ресурсов, оркестраторов контейнеров как услуги и управляемых событиями бессерверных сред.</span><span class="sxs-lookup"><span data-stu-id="42eab-250">Meanwhile, cloud platforms are making it easier to build and run microservices, with automated provisioning of compute resources, container orchestrators as a service, and event-driven serverless environments.</span></span>

<span data-ttu-id="42eab-251">Но, как мы уже увидели, архитектуры микрослужб также таят в себе много проблем.</span><span class="sxs-lookup"><span data-stu-id="42eab-251">But as we've seen, microservices architectures also being a lot of challenges.</span></span> <span data-ttu-id="42eab-252">Чтобы добиться успеха, необходимо начать с надежной архитектуры.</span><span class="sxs-lookup"><span data-stu-id="42eab-252">To succeed, you must start from a solid design.</span></span> <span data-ttu-id="42eab-253">Следует тщательно проанализировать предметную область, выбрать технологии, моделировать данные, спроектировать API-интерфейсы и создать современную культуру DevOps.</span><span class="sxs-lookup"><span data-stu-id="42eab-253">You must put careful thought into analyzing the domain, choosing technologies, modeling data, designing APIs, and building a mature DevOps culture.</span></span> <span data-ttu-id="42eab-254">Мы надеемся, что это руководство и сопутствующая [эталонная реализация](https://github.com/mspnp/microservices-reference-implementation) помогли пролить свет на ваш вопрос.</span><span class="sxs-lookup"><span data-stu-id="42eab-254">We hope that this guide, and the accompanying [reference implementation](https://github.com/mspnp/microservices-reference-implementation), has helped to illuminate the journey.</span></span> 

