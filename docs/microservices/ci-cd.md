---
title: Непрерывная интеграция и непрерывная поставка микрослужб
description: Непрерывная интеграция и непрерывная поставка для микрослужб.
author: MikeWasson
ms.date: 03/27/2019
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: microservices
ms.openlocfilehash: c52ff3d0a330f564e5f7e9b0b07f0ba84c328c8b
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59639790"
---
# <a name="cicd-for-microservices-architectures"></a><span data-ttu-id="a0aea-103">CI/CD для архитектур микрослужб</span><span class="sxs-lookup"><span data-stu-id="a0aea-103">CI/CD for microservices architectures</span></span>

<span data-ttu-id="a0aea-104">Ускорение жизненного цикла — это один из основных преимуществ архитектуры микрослужб.</span><span class="sxs-lookup"><span data-stu-id="a0aea-104">Faster release cycles are one of the major advantages of microservices architectures.</span></span> <span data-ttu-id="a0aea-105">Но без Непрерывной интеграции и если процесс налажен, не добиться гибкости, promise микрослужб.</span><span class="sxs-lookup"><span data-stu-id="a0aea-105">But without a good CI/CD process, you won't achieve the agility that microservices promise.</span></span> <span data-ttu-id="a0aea-106">В этой статье описываются проблемы и рекомендованные подходы к проблеме.</span><span class="sxs-lookup"><span data-stu-id="a0aea-106">This article describes the challenges and recommends some approaches to the problem.</span></span>

## <a name="what-is-cicd"></a><span data-ttu-id="a0aea-107">Что такое CI/CD?</span><span class="sxs-lookup"><span data-stu-id="a0aea-107">What is CI/CD?</span></span>

<span data-ttu-id="a0aea-108">Когда мы говорим о CI/CD, мы действительно речь идет о несколько связанных процессов: непрерывная интеграция, непрерывная поставка и непрерывное развертывание.</span><span class="sxs-lookup"><span data-stu-id="a0aea-108">When we talk about CI/CD, we're really talking about several related processes: Continuous integration, continuous delivery, and continuous deployment.</span></span>

- <span data-ttu-id="a0aea-109">**Непрерывная интеграция**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-109">**Continuous integration**.</span></span> <span data-ttu-id="a0aea-110">Изменения в коде часто объединяются с главной ветвью.</span><span class="sxs-lookup"><span data-stu-id="a0aea-110">Code changes are frequently merged into the main branch.</span></span> <span data-ttu-id="a0aea-111">Автоматической сборки и процессов тестирования убедитесь, что код в главной ветви всегда промышленного качества.</span><span class="sxs-lookup"><span data-stu-id="a0aea-111">Automated build and test processes ensure that code in the main branch is always production-quality.</span></span>

- <span data-ttu-id="a0aea-112">**Непрерывная Поставка**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-112">**Continuous delivery**.</span></span> <span data-ttu-id="a0aea-113">Любые изменения кода, которые прошли процесс непрерывной Интеграции, автоматически публикуются в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-113">Any code changes that pass the CI process are automatically published to a production-like environment.</span></span> <span data-ttu-id="a0aea-114">Для развертывания в рабочей среде может потребоваться утверждение вручную, в противном случае оно выполняется автоматически.</span><span class="sxs-lookup"><span data-stu-id="a0aea-114">Deployment into the live production environment may require manual approval, but is otherwise automated.</span></span> <span data-ttu-id="a0aea-115">В результате этого код всегда будет *готов* к развертыванию в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-115">The goal is that your code should always be *ready* to deploy into production.</span></span>

- <span data-ttu-id="a0aea-116">**Осуществлять непрерывное развертывание.**</span><span class="sxs-lookup"><span data-stu-id="a0aea-116">**Continuous deployment**.</span></span> <span data-ttu-id="a0aea-117">Код изменяет этого этапа, предыдущие два шага, автоматически развертываются *в рабочую среду*.</span><span class="sxs-lookup"><span data-stu-id="a0aea-117">Code changes that pass the previous two steps are automatically deployed *into production*.</span></span>

<span data-ttu-id="a0aea-118">Ниже приведены некоторые цели надежного процесса CI/CD для архитектуры микрослужб:</span><span class="sxs-lookup"><span data-stu-id="a0aea-118">Here are some goals of a robust CI/CD process for a microservices architecture:</span></span>

- <span data-ttu-id="a0aea-119">Каждая команда может создавать и развертывать службы, которыми она владеет независимо, не влияя на другие команды и не нарушая их работу.</span><span class="sxs-lookup"><span data-stu-id="a0aea-119">Each team can build and deploy the services that it owns independently, without affecting or disrupting other teams.</span></span>

- <span data-ttu-id="a0aea-120">Перед развертыванием новой версии службы в рабочей среде она развертывается в средах разработки, тестирования и контроля качества для проверки.</span><span class="sxs-lookup"><span data-stu-id="a0aea-120">Before a new version of a service is deployed to production, it gets deployed to dev/test/QA environments for validation.</span></span> <span data-ttu-id="a0aea-121">Шлюзы качества применяются на каждом этапе.</span><span class="sxs-lookup"><span data-stu-id="a0aea-121">Quality gates are enforced at each stage.</span></span>

- <span data-ttu-id="a0aea-122">Новую версию службы можно развернуть параллельно с предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="a0aea-122">A new version of a service can be deployed side by side with the previous version.</span></span>

- <span data-ttu-id="a0aea-123">Заданы достаточные политики контроля доступа.</span><span class="sxs-lookup"><span data-stu-id="a0aea-123">Sufficient access control policies are in place.</span></span>

- <span data-ttu-id="a0aea-124">Для контейнерных рабочих нагрузок можно доверять образы контейнеров, развернутых в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-124">For containerized workloads, you can trust the container images that are deployed to production.</span></span>

## <a name="why-a-robust-cicd-pipeline-matters"></a><span data-ttu-id="a0aea-125">Почему важна надежные конвейера CI/CD</span><span class="sxs-lookup"><span data-stu-id="a0aea-125">Why a robust CI/CD pipeline matters</span></span>

<span data-ttu-id="a0aea-126">В традиционных монолитного приложения есть один конвейер сборки, выходные данные которого является исполняемым файлом приложения.</span><span class="sxs-lookup"><span data-stu-id="a0aea-126">In a traditional monolithic application, there is a single build pipeline whose output is the application executable.</span></span> <span data-ttu-id="a0aea-127">Все данные разработки поступают в этот конвейер.</span><span class="sxs-lookup"><span data-stu-id="a0aea-127">All development work feeds into this pipeline.</span></span> <span data-ttu-id="a0aea-128">При обнаружении ошибки с высоким приоритетом необходимо интегрировать, протестировать и опубликовать исправление, из-за чего может быть отложен выпуск новых функций.</span><span class="sxs-lookup"><span data-stu-id="a0aea-128">If a high-priority bug is found, a fix must be integrated, tested, and published, which can delay the release of new features.</span></span> <span data-ttu-id="a0aea-129">Этих проблем можно избежать при наличии хорошо организованных модулей и использовании ветвей компонентов, чтобы свести к минимуму влияние изменений кода.</span><span class="sxs-lookup"><span data-stu-id="a0aea-129">You can mitigate these problems by having well-factored modules and using feature branches to minimize the impact of code changes.</span></span> <span data-ttu-id="a0aea-130">Но так как объем данных приложения со временем увеличивается и оно становится более сложным, а также добавляются дополнительные функции, процесс выпуска для монолитного приложения становится нестабильным и часто нарушается.</span><span class="sxs-lookup"><span data-stu-id="a0aea-130">But as the application grows more complex, and more features are added, the release process for a monolith tends to become more brittle and likely to break.</span></span>

<span data-ttu-id="a0aea-131">Принципы работы с микрослужбами предусматривают, что цепочка выпуска не может быть длинной, когда каждая команда должна становиться в очередь.</span><span class="sxs-lookup"><span data-stu-id="a0aea-131">Following the microservices philosophy, there should never be a long release train where every team has to get in line.</span></span> <span data-ttu-id="a0aea-132">Команда, создающая службу "A", может выпустить обновление в любое время, не ожидая объединения, тестирования и развертывания изменений в службе "B".</span><span class="sxs-lookup"><span data-stu-id="a0aea-132">The team that builds service "A" can release an update at any time, without waiting for changes in service "B" to be merged, tested, and deployed.</span></span>

![Схема монолитного процесса CI/CD](./images/cicd-monolith.png)

<span data-ttu-id="a0aea-134">Для достижения выпуск на высокой скорости, конвейер выпуска должен быть автоматическим и очень надежным, чтобы свести к минимуму риск.</span><span class="sxs-lookup"><span data-stu-id="a0aea-134">To achieve a high release velocity, your release pipeline must be automated and highly reliable, to minimize risk.</span></span> <span data-ttu-id="a0aea-135">Если отпустить в рабочую среду каждый день или несколько раз в день, регрессии или перерывы должны возникать очень редко.</span><span class="sxs-lookup"><span data-stu-id="a0aea-135">If you release to production daily or multiple times a day, regressions or service disruptions must be very rare.</span></span> <span data-ttu-id="a0aea-136">В то же время в случае развертывания неправильного обновления необходимо располагать надежным способом быстро выполнить откат или накат до предыдущей версии службы.</span><span class="sxs-lookup"><span data-stu-id="a0aea-136">At the same time, if a bad update does get deployed, you must have a reliable way to quickly roll back or roll forward to a previous version of a service.</span></span>

## <a name="challenges"></a><span data-ttu-id="a0aea-137">Сложности</span><span class="sxs-lookup"><span data-stu-id="a0aea-137">Challenges</span></span>

- <span data-ttu-id="a0aea-138">**Множество небольших независимых баз кода**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-138">**Many small independent code bases**.</span></span> <span data-ttu-id="a0aea-139">Каждая команда отвечает за создание собственной службы со своим собственным конвейером сборки.</span><span class="sxs-lookup"><span data-stu-id="a0aea-139">Each team is responsible for building its own service, with its own build pipeline.</span></span> <span data-ttu-id="a0aea-140">В некоторых организациях команды могут использовать отдельные репозитории кода.</span><span class="sxs-lookup"><span data-stu-id="a0aea-140">In some organizations, teams may use separate code repositories.</span></span> <span data-ttu-id="a0aea-141">Отдельные репозитории может привести к ситуации, когда многие команды знают, как создать систему, и никто в организации знает, как развертывать все приложение.</span><span class="sxs-lookup"><span data-stu-id="a0aea-141">Separate repositories can lead to a situation where the knowledge of how to build the system is spread across teams, and nobody in the organization knows how to deploy the entire application.</span></span> <span data-ttu-id="a0aea-142">Например, что происходит в сценарии аварийного восстановления, если необходимо быстро выполнить развертывание в новый кластер?</span><span class="sxs-lookup"><span data-stu-id="a0aea-142">For example, what happens in a disaster recovery scenario, if you need to quickly deploy to a new cluster?</span></span>

    <span data-ttu-id="a0aea-143">**Устранение.** Иметь единое и автоматических конвейер для сборки и развертывания служб, таким образом, чтобы эти знания «отображается» в каждой команде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-143">**Mitigation**: Have a unified and automated pipeline to build and deploy services, so that this knowledge is not "hidden" within each team.</span></span>

- <span data-ttu-id="a0aea-144">**Множество языков программирования и платформ**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-144">**Multiple languages and frameworks**.</span></span> <span data-ttu-id="a0aea-145">При том, что каждая команда использует свой собственный набор технологий, могут возникнуть сложности в создании процесса сборки, применимого для всей организации.</span><span class="sxs-lookup"><span data-stu-id="a0aea-145">With each team using its own mix of technologies, it can be difficult to create a single build process that works across the organization.</span></span> <span data-ttu-id="a0aea-146">Процесс сборки должен быть достаточно гибким, чтобы любая команда могла использовать его независимо от выбранного языка программирования или платформы.</span><span class="sxs-lookup"><span data-stu-id="a0aea-146">The build process must be flexible enough that every team can adapt it for their choice of language or framework.</span></span>

    <span data-ttu-id="a0aea-147">**Устранение.** Контейнеризация процесс сборки для каждой службы.</span><span class="sxs-lookup"><span data-stu-id="a0aea-147">**Mitigation**: Containerize the build process for each service.</span></span> <span data-ttu-id="a0aea-148">Таким образом, система сборки просто нужно иметь возможность запускать контейнеры.</span><span class="sxs-lookup"><span data-stu-id="a0aea-148">That way, the build system just needs to be able to run the containers.</span></span>

- <span data-ttu-id="a0aea-149">**Интеграция и нагрузочное тестирование**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-149">**Integration and load testing**.</span></span> <span data-ttu-id="a0aea-150">Так как команды выпускают обновления независимо друг от друга, с разработкой надежного и комплексного тестирования могут возникнуть сложности, особенно если у службы есть зависимости от других служб.</span><span class="sxs-lookup"><span data-stu-id="a0aea-150">With teams releasing updates at their own pace, it can be challenging to design robust end-to-end testing, especially when services have dependencies on other services.</span></span> <span data-ttu-id="a0aea-151">Кроме того запуск полного рабочего кластера может быть дорогостоящим, поэтому маловероятно, что каждая команда будет выполняться весь собственный кластер в производственных масштабах только для тестирования.</span><span class="sxs-lookup"><span data-stu-id="a0aea-151">Moreover, running a full production cluster can be expensive, so it's unlikely that every team will run its own full cluster at production scales, just for testing.</span></span>

- <span data-ttu-id="a0aea-152">**Управление выпусками**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-152">**Release management**.</span></span> <span data-ttu-id="a0aea-153">Каждая команда должна иметь возможность развернуть обновление в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-153">Every team should be able to deploy an update to production.</span></span> <span data-ttu-id="a0aea-154">Это не означает, что у каждого участника команды есть на это разрешения.</span><span class="sxs-lookup"><span data-stu-id="a0aea-154">That doesn't mean that every team member has permissions to do so.</span></span> <span data-ttu-id="a0aea-155">Но при наличии централизованной роли диспетчера выпусков может снизиться скорость развертываний.</span><span class="sxs-lookup"><span data-stu-id="a0aea-155">But having a centralized Release Manager role can reduce the velocity of deployments.</span></span>

    <span data-ttu-id="a0aea-156">**Устранение.** Чем больше автоматизирован процесс непрерывной интеграции и поставки и чем выше его надежность, тем меньше потребность в центральном администрировании.</span><span class="sxs-lookup"><span data-stu-id="a0aea-156">**Mitigation**: The more that your CI/CD process is automated and reliable, the less there should be a need for a central authority.</span></span> <span data-ttu-id="a0aea-157">С другой стороны, могут применяться различные политики для выпуска обновлений основных компонентов и небольших исправлений ошибок.</span><span class="sxs-lookup"><span data-stu-id="a0aea-157">That said, you might have different policies for releasing major feature updates versus minor bug fixes.</span></span> <span data-ttu-id="a0aea-158">Децентрализация вовсе не означает отсутствие управления.</span><span class="sxs-lookup"><span data-stu-id="a0aea-158">Being decentralized doesn't mean zero governance.</span></span>

- <span data-ttu-id="a0aea-159">**Обновления службы**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-159">**Service updates**.</span></span> <span data-ttu-id="a0aea-160">Обновление службы до новой версии не должно нарушать работу других служб, зависящих от нее.</span><span class="sxs-lookup"><span data-stu-id="a0aea-160">When you update a service to a new version, it shouldn't break other services that depend on it.</span></span>

    <span data-ttu-id="a0aea-161">**Устранение.** Используйте методы развертывания, такие как blue-green или ранние версии для некритических изменений.</span><span class="sxs-lookup"><span data-stu-id="a0aea-161">**Mitigation**: Use deployment techniques such as blue-green or canary release for non-breaking changes.</span></span> <span data-ttu-id="a0aea-162">Критически важных изменениях API, разверните новую версию параллельно с предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="a0aea-162">For breaking API changes, deploy the new version side by side with the previous version.</span></span> <span data-ttu-id="a0aea-163">Таким образом, служб, которые используют предыдущий API может обновляться и протестированы для нового API.</span><span class="sxs-lookup"><span data-stu-id="a0aea-163">That way, services that consume the previous API can be updated and tested for the new API.</span></span> <span data-ttu-id="a0aea-164">См. в разделе [службах обновления](#updating-services)ниже.</span><span class="sxs-lookup"><span data-stu-id="a0aea-164">See [Updating services](#updating-services), below.</span></span>

## <a name="monorepo-vs-multi-repo"></a><span data-ttu-id="a0aea-165">Нескольких репозиториев Monorepo vs</span><span class="sxs-lookup"><span data-stu-id="a0aea-165">Monorepo vs multi-repo</span></span>

<span data-ttu-id="a0aea-166">Прежде чем создавать рабочий процесс CI/CD, необходимо знать, как будет структурирована база кода и как ею управлять.</span><span class="sxs-lookup"><span data-stu-id="a0aea-166">Before creating a CI/CD workflow, you must know how the code base will be structured and managed.</span></span>

- <span data-ttu-id="a0aea-167">Команды работают в отдельном репозитории или monorepo (один репозиторий)?</span><span class="sxs-lookup"><span data-stu-id="a0aea-167">Do teams work in separate repositories or in a monorepo (single repository)?</span></span>
- <span data-ttu-id="a0aea-168">Что такое стратегия создания ветви?</span><span class="sxs-lookup"><span data-stu-id="a0aea-168">What is your branching strategy?</span></span>
- <span data-ttu-id="a0aea-169">Кто может отправлять код в рабочую среду?</span><span class="sxs-lookup"><span data-stu-id="a0aea-169">Who can push code to production?</span></span> <span data-ttu-id="a0aea-170">Существует ли роль менеджера выпуска?</span><span class="sxs-lookup"><span data-stu-id="a0aea-170">Is there a release manager role?</span></span>

<span data-ttu-id="a0aea-171">Подход единого репозитория получил приоритет, но есть определенные преимущества и недостатки.</span><span class="sxs-lookup"><span data-stu-id="a0aea-171">The monorepo approach has been gaining favor but there are advantages and disadvantages to both.</span></span>

| &nbsp; | <span data-ttu-id="a0aea-172">Единый репозиторий</span><span class="sxs-lookup"><span data-stu-id="a0aea-172">Monorepo</span></span> | <span data-ttu-id="a0aea-173">Несколько репозиториев</span><span class="sxs-lookup"><span data-stu-id="a0aea-173">Multiple repos</span></span> |
|--------|----------|----------------|
| <span data-ttu-id="a0aea-174">**Преимущества**</span><span class="sxs-lookup"><span data-stu-id="a0aea-174">**Advantages**</span></span> | <span data-ttu-id="a0aea-175">Общий доступ к коду</span><span class="sxs-lookup"><span data-stu-id="a0aea-175">Code sharing</span></span><br/><span data-ttu-id="a0aea-176">Простой способ стандартизировать код и средства</span><span class="sxs-lookup"><span data-stu-id="a0aea-176">Easier to standardize code and tooling</span></span><br/><span data-ttu-id="a0aea-177">Простой рефакторинг кода</span><span class="sxs-lookup"><span data-stu-id="a0aea-177">Easier to refactor code</span></span><br/><span data-ttu-id="a0aea-178">Обнаруживаемость – единое представление кода</span><span class="sxs-lookup"><span data-stu-id="a0aea-178">Discoverability - single view of the code</span></span><br/> | <span data-ttu-id="a0aea-179">Очистка владельца в команде</span><span class="sxs-lookup"><span data-stu-id="a0aea-179">Clear ownership per team</span></span><br/><span data-ttu-id="a0aea-180">Потенциально меньше конфликтов слияния</span><span class="sxs-lookup"><span data-stu-id="a0aea-180">Potentially fewer merge conflicts</span></span><br/><span data-ttu-id="a0aea-181">Помогает применить разделение микрослужб</span><span class="sxs-lookup"><span data-stu-id="a0aea-181">Helps to enforce decoupling of microservices</span></span> |
| <span data-ttu-id="a0aea-182">**Сложности**</span><span class="sxs-lookup"><span data-stu-id="a0aea-182">**Challenges**</span></span> | <span data-ttu-id="a0aea-183">Изменение совместного использования кода может повлиять на несколько микрослужб</span><span class="sxs-lookup"><span data-stu-id="a0aea-183">Changes to shared code can affect multiple microservices</span></span><br/><span data-ttu-id="a0aea-184">Большая вероятность конфликтов слияния</span><span class="sxs-lookup"><span data-stu-id="a0aea-184">Greater potential for merge conflicts</span></span><br/><span data-ttu-id="a0aea-185">Инструментарий необходимо масштабировать в большую базу кода</span><span class="sxs-lookup"><span data-stu-id="a0aea-185">Tooling must scale to a large code base</span></span><br/><span data-ttu-id="a0aea-186">управление доступом;</span><span class="sxs-lookup"><span data-stu-id="a0aea-186">Access control</span></span><br/><span data-ttu-id="a0aea-187">Более сложный процесс развертывания</span><span class="sxs-lookup"><span data-stu-id="a0aea-187">More complex deployment process</span></span> | <span data-ttu-id="a0aea-188">Труднее совместно использовать код</span><span class="sxs-lookup"><span data-stu-id="a0aea-188">Harder to share code</span></span><br/><span data-ttu-id="a0aea-189">Труднее применять стандарты кодирования</span><span class="sxs-lookup"><span data-stu-id="a0aea-189">Harder to enforce coding standards</span></span><br/><span data-ttu-id="a0aea-190">Управление зависимостями</span><span class="sxs-lookup"><span data-stu-id="a0aea-190">Dependency management</span></span><br/><span data-ttu-id="a0aea-191">Диффузная база кода, низкая обнаруживаемость</span><span class="sxs-lookup"><span data-stu-id="a0aea-191">Diffuse code base, poor discoverability</span></span><br/><span data-ttu-id="a0aea-192">Отсутствие общей инфраструктуры</span><span class="sxs-lookup"><span data-stu-id="a0aea-192">Lack of shared infrastructure</span></span>

## <a name="updating-services"></a><span data-ttu-id="a0aea-193">Обновление служб</span><span class="sxs-lookup"><span data-stu-id="a0aea-193">Updating services</span></span>

<span data-ttu-id="a0aea-194">Есть различные стратегии обновления службы, которая уже находится в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="a0aea-194">There are various strategies for updating a service that's already in production.</span></span> <span data-ttu-id="a0aea-195">Мы рассмотрим три распространенных варианта: последовательное обновление, развертывание по схеме blue-green и ранний выпуск.</span><span class="sxs-lookup"><span data-stu-id="a0aea-195">Here we discuss three common options: Rolling update, blue-green deployment, and canary release.</span></span>

### <a name="rolling-updates"></a><span data-ttu-id="a0aea-196">Последовательные обновления</span><span class="sxs-lookup"><span data-stu-id="a0aea-196">Rolling updates</span></span>

<span data-ttu-id="a0aea-197">В последовательном обновлении развертываются новые экземпляры службы, которые сразу же начинают получать запросы.</span><span class="sxs-lookup"><span data-stu-id="a0aea-197">In a rolling update, you deploy new instances of a service, and the new instances start receiving requests right away.</span></span> <span data-ttu-id="a0aea-198">При появлении новых экземпляров предыдущие экземпляры удаляются.</span><span class="sxs-lookup"><span data-stu-id="a0aea-198">As the new instances come up, the previous instances are removed.</span></span>

<span data-ttu-id="a0aea-199">**Пример.**</span><span class="sxs-lookup"><span data-stu-id="a0aea-199">**Example.**</span></span> <span data-ttu-id="a0aea-200">В Kubernetes последовательные обновления — это поведение по умолчанию, при обновлении спецификации pod для развертывания.</span><span class="sxs-lookup"><span data-stu-id="a0aea-200">In Kubernetes, rolling updates are the default behavior when you update the pod spec for a Deployment.</span></span> <span data-ttu-id="a0aea-201">Контроллер развертывания создает новый набор реплик для обновленных модулей pod.</span><span class="sxs-lookup"><span data-stu-id="a0aea-201">The Deployment controller creates a new ReplicaSet for the updated pods.</span></span> <span data-ttu-id="a0aea-202">Затем он масштабирует новый набор реплик, при этом уменьшая масштаб старого набора реплик, чтобы сохранить необходимое количество реплик.</span><span class="sxs-lookup"><span data-stu-id="a0aea-202">Then it scales up the new ReplicaSet while scaling down the old one, to maintain the desired replica count.</span></span> <span data-ttu-id="a0aea-203">Пока не готовы новые модули pod, старые модули не удаляются.</span><span class="sxs-lookup"><span data-stu-id="a0aea-203">It doesn't delete old pods until the new ones are ready.</span></span> <span data-ttu-id="a0aea-204">Kubernetes сохраняет журнал обновления, поэтому можно выполнить откат обновления при необходимости.</span><span class="sxs-lookup"><span data-stu-id="a0aea-204">Kubernetes keeps a history of the update, so you can roll back an update if needed.</span></span>

<span data-ttu-id="a0aea-205">Одной из проблем последовательного обновления является то, что во время обновления и старая, и новая версии выполняются и получают трафик.</span><span class="sxs-lookup"><span data-stu-id="a0aea-205">One challenge of rolling updates is that during the update process, a mix of old and new versions are running and receiving traffic.</span></span> <span data-ttu-id="a0aea-206">В течение этого периода любой запрос может перенаправляться в одну из двух версий.</span><span class="sxs-lookup"><span data-stu-id="a0aea-206">During this period, any request could get routed to either of the two versions.</span></span>

<span data-ttu-id="a0aea-207">Критически важных изменениях API, мы рекомендуем для поддержки обеих версий параллельно, пока не будут обновлены все клиенты с предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="a0aea-207">For breaking API changes, a good practice is to support both versions side by side, until all clients of the previous version are updated.</span></span> <span data-ttu-id="a0aea-208">См. в разделе [управление версиями API](./design/api-design.md#api-versioning).</span><span class="sxs-lookup"><span data-stu-id="a0aea-208">See [API versioning](./design/api-design.md#api-versioning).</span></span>

### <a name="blue-green-deployment"></a><span data-ttu-id="a0aea-209">"Сине-зеленое" развертывание</span><span class="sxs-lookup"><span data-stu-id="a0aea-209">Blue-green deployment</span></span>

<span data-ttu-id="a0aea-210">При "сине-зеленом" развертывании новая версия развертывается параллельно с предыдущей версией.</span><span class="sxs-lookup"><span data-stu-id="a0aea-210">In a blue-green deployment, you deploy the new version alongside the previous version.</span></span> <span data-ttu-id="a0aea-211">После проверки новой версии весь трафик сразу же переходит из предыдущей версии в новую.</span><span class="sxs-lookup"><span data-stu-id="a0aea-211">After you validate the new version, you switch all traffic at once from the previous version to the new version.</span></span> <span data-ttu-id="a0aea-212">После переключения трафика выполняется мониторинг приложения на наличие проблем.</span><span class="sxs-lookup"><span data-stu-id="a0aea-212">After the switch, you monitor the application for any problems.</span></span> <span data-ttu-id="a0aea-213">Если что-то пойдет не так, можно вернуться обратно к старой версии.</span><span class="sxs-lookup"><span data-stu-id="a0aea-213">If something goes wrong, you can swap back to the old version.</span></span> <span data-ttu-id="a0aea-214">При условии, что проблем нет, старую версию можно удалить.</span><span class="sxs-lookup"><span data-stu-id="a0aea-214">Assuming there are no problems, you can delete the old version.</span></span>

<span data-ttu-id="a0aea-215">В более традиционных монолитных или n-уровневых приложениях "сине-зеленое" развертывание обычно подразумевает подготовку двух идентичных сред.</span><span class="sxs-lookup"><span data-stu-id="a0aea-215">With a more traditional monolithic or N-tier application, blue-green deployment generally meant provisioning two identical environments.</span></span> <span data-ttu-id="a0aea-216">Понадобится развернуть новую версию в промежуточной среде, а затем перенаправить трафик клиента в промежуточную среду. Например, путем переключения виртуальных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="a0aea-216">You would deploy the new version to a staging environment, then redirect client traffic to the staging environment &mdash; for example, by swapping VIP addresses.</span></span> <span data-ttu-id="a0aea-217">В архитектуре микрослужб обновления происходят на уровне микрослужб, что обычно будет развернуть обновление в ту же среду и использовать механизм обнаружения служб для замены.</span><span class="sxs-lookup"><span data-stu-id="a0aea-217">In a microservices architecture, updates happen at the microservice level, so you would typically deploy the update into the same environment and use a service discovery mechanism to swap.</span></span>

<span data-ttu-id="a0aea-218">**Пример**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-218">**Example**.</span></span> <span data-ttu-id="a0aea-219">В Kubernetes для выполнения "сине-зеленых" развертываний не нужно подготавливать отдельный кластер.</span><span class="sxs-lookup"><span data-stu-id="a0aea-219">In Kubernetes, you don't need to provision a separate cluster to do blue-green deployments.</span></span> <span data-ttu-id="a0aea-220">Вместо этого можно воспользоваться селекторами.</span><span class="sxs-lookup"><span data-stu-id="a0aea-220">Instead, you can take advantage of selectors.</span></span> <span data-ttu-id="a0aea-221">Создайте новый ресурс развертывания с новой спецификацией pod и другим набором меток.</span><span class="sxs-lookup"><span data-stu-id="a0aea-221">Create a new Deployment resource with a new pod spec and a different set of labels.</span></span> <span data-ttu-id="a0aea-222">Создайте это развертывание, не удаляя предыдущее развертывание и не изменяя службу, которая указывает на него.</span><span class="sxs-lookup"><span data-stu-id="a0aea-222">Create this deployment, without deleting the previous deployment or modifying the service that points to it.</span></span> <span data-ttu-id="a0aea-223">После запуска новых модулей pod можно обновить селектор службы в соответствии с новым развертыванием.</span><span class="sxs-lookup"><span data-stu-id="a0aea-223">Once the new pods are running, you can update the service's selector to match the new deployment.</span></span>

<span data-ttu-id="a0aea-224">Одним из недостатков развертывания blue-green является то, что во время обновления, выполняется два раза больше модулей POD для службы (текущих и следующих).</span><span class="sxs-lookup"><span data-stu-id="a0aea-224">One drawback of blue-green deployment is that during the update, you are running twice as many pods for the service (current and next).</span></span> <span data-ttu-id="a0aea-225">Если для модулей pod требуется больший объем ресурсов ЦП или памяти, может потребоваться временно развернуть кластер, чтобы справиться с потреблением ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a0aea-225">If the pods require a lot of CPU or memory resources, you may need to scale out the cluster temporarily to handle the resource consumption.</span></span>

### <a name="canary-release"></a><span data-ttu-id="a0aea-226">Ранний выпуск</span><span class="sxs-lookup"><span data-stu-id="a0aea-226">Canary release</span></span>

<span data-ttu-id="a0aea-227">В раннем выпуске обновленная версия развертывается в небольшое количество клиентов.</span><span class="sxs-lookup"><span data-stu-id="a0aea-227">In a canary release, you roll out an updated version to a small number of clients.</span></span> <span data-ttu-id="a0aea-228">Затем отслеживается поведение новой службы, прежде чем развернуть ее для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="a0aea-228">Then you monitor the behavior of the new service before rolling it out to all clients.</span></span> <span data-ttu-id="a0aea-229">Так вы можете выполнить медленный выпуск контролируемым способом, наблюдать за реальными данными, а также обнаруживать проблемы, прежде чем они затронут всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="a0aea-229">This lets you do a slow rollout in a controlled fashion, observe real data, and spot problems before all customers are affected.</span></span>

<span data-ttu-id="a0aea-230">Ранний выпуск сложнее в управлении, чем "сине-зеленое" развертывание или последовательное обновление, так как необходимо динамически направлять запросы в разные версии службы.</span><span class="sxs-lookup"><span data-stu-id="a0aea-230">A canary release is more complex to manage than either blue-green or rolling update, because you must dynamically route requests to different versions of the service.</span></span>

<span data-ttu-id="a0aea-231">**Пример**.</span><span class="sxs-lookup"><span data-stu-id="a0aea-231">**Example**.</span></span> <span data-ttu-id="a0aea-232">В Kubernetes можно настроить службу так, чтобы охватить два набора реплик (по одному для каждой версии) и регулировать счетчики реплики вручную.</span><span class="sxs-lookup"><span data-stu-id="a0aea-232">In Kubernetes, you can configure a Service to span two replica sets (one for each version) and adjust the replica counts manually.</span></span> <span data-ttu-id="a0aea-233">Тем не менее этот подход не детализирован из-за того, как Kubernetes распределяет нагрузку между модулями pod.</span><span class="sxs-lookup"><span data-stu-id="a0aea-233">However, this approach is rather coarse-grained, because of the way Kubernetes load balances across pods.</span></span> <span data-ttu-id="a0aea-234">Например если у вас есть всего 10 реплик, вы сместить трафик можно только с шагом в 10%.</span><span class="sxs-lookup"><span data-stu-id="a0aea-234">For example, if you have a total of 10 replicas, you can only shift traffic in 10% increments.</span></span> <span data-ttu-id="a0aea-235">При использовании ПО слоя взаимодействия между службами можно использовать правила маршрутизации для реализации более сложной стратегии раннего выпуска.</span><span class="sxs-lookup"><span data-stu-id="a0aea-235">If you are using a service mesh, you can use the service mesh routing rules to implement a more sophisticated canary release strategy.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a0aea-236">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="a0aea-236">Next steps</span></span>

<span data-ttu-id="a0aea-237">Сведения конкретного процессам CI/CD для микрослужб, выполняющихся на платформе Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="a0aea-237">Learn specific CI/CD practices for microservices running on Kubernetes.</span></span>

- [<span data-ttu-id="a0aea-238">Непрерывные Интеграция и развертывание микрослужб в Kubernetes</span><span class="sxs-lookup"><span data-stu-id="a0aea-238">CI/CD for microservices on Kubernetes</span></span>](./ci-cd-kubernetes.md)