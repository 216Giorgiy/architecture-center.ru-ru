---
title: "Рекомендации по работе с данными для микрослужб"
description: "Рекомендации по работе с данными для микрослужб"
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 9bd7a8424309b5753b42cfb70559836288a3ce9d
ms.sourcegitcommit: c7f46b14ad7d55cf553b2d0b01045c9c25aefcdb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/09/2017
---
# <a name="designing-microservices-data-considerations"></a><span data-ttu-id="f1ad1-103">Проектирование микрослужб: рекомендации по работе с данными</span><span class="sxs-lookup"><span data-stu-id="f1ad1-103">Designing microservices: Data considerations</span></span>

<span data-ttu-id="f1ad1-104">В этой главе содержатся рекомендации по управлению данными в архитектуре микрослужб.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-104">This chapter describes considerations for managing data in a microservices architecture.</span></span> <span data-ttu-id="f1ad1-105">Так как каждая микрослужба управляет собственными данными, их обеспечение их целостности и согласованности является критически важной задачей.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-105">Because every microservice manages its own data, data integrity and data consistency are critical challenges.</span></span>

![](./images/data-considerations.png)

<span data-ttu-id="f1ad1-106">Основной принцип работы микрослужб заключается в том, что каждая служба управляет собственными данными.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-106">A basic principle of microservices is that each service manages its own data.</span></span> <span data-ttu-id="f1ad1-107">Две службы не могут использовать одно и то же хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-107">Two services should not share a data store.</span></span> <span data-ttu-id="f1ad1-108">Наоборот, каждая служба отвечает за собственное хранилище данных, которое напрямую недоступно для других служб.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-108">Instead, each service is responsible for its own private data store, which other services cannot access directly.</span></span>

<span data-ttu-id="f1ad1-109">Это позволяет устранить непреднамеренную взаимозависимость между службами, которая может возникнуть, когда службы совместно используют одни и те же базовые схемы данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-109">The reason for this rule is to avoid unintentional coupling between services, which can result if services share the same underlying data schemas.</span></span> <span data-ttu-id="f1ad1-110">Если в схему данных вносятся изменения, их нужно согласовать в каждой службе, которая зависит от этой базы данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-110">If there is a change to the data schema, the change must be coordinated across every service that relies on that database.</span></span> <span data-ttu-id="f1ad1-111">Изолируя хранилище данных каждой службы, мы можем ограничить область изменений и сохранить гибкость полностью независимых развертываний.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-111">By isolating each service's data store, we can limit the scope of change, and preserve the agility of truly independent deployments.</span></span> <span data-ttu-id="f1ad1-112">Кроме того, у каждой микрослужбы могут быть собственные модели данных, запросы или шаблоны операций чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-112">Another reason is that each microservice may have its own data models, queries, or read/write patterns.</span></span> <span data-ttu-id="f1ad1-113">При использовании общего хранилища данных для каждой команды ограничивается возможность оптимизировать хранилище данных для какой-либо службы.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-113">Using a shared data store limits each team's ability to optimize data storage for their particular service.</span></span> 

![](../guide/architecture-styles/images/cqrs-microservices-wrong.png)

<span data-ttu-id="f1ad1-114">Следовательно, это предполагает применение подхода [Polyglot Persistence](https://martinfowler.com/bliki/PolyglotPersistence.html), когда в одном приложении используется несколько технологий хранения данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-114">This approach naturally leads to [polyglot persistence](https://martinfowler.com/bliki/PolyglotPersistence.html) &mdash; the use of multiple data storage technologies within a single application.</span></span> <span data-ttu-id="f1ad1-115">Для работы одной службы могут требоваться возможности схемы при чтении, свойственные базе данных документов.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-115">One service might require the schema-on-read capabilities of a document database.</span></span> <span data-ttu-id="f1ad1-116">Для другой — целостность данных, предоставляемая реляционной СУБД.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-116">Another might need the referential integrity provided by an RDBMS.</span></span> <span data-ttu-id="f1ad1-117">Каждая команда может выбрать подходящий вариант для своей службы.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-117">Each team is free to make the best choice for their service.</span></span> <span data-ttu-id="f1ad1-118">Дополнительные сведения о подходе Polyglot Persistence см. в статье [Использование подходящего хранилища данных для задания](../guide/design-principles/use-the-best-data-store.md).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-118">For more about the general principle of polyglot persistence, see [Use the best data store for the job](../guide/design-principles/use-the-best-data-store.md).</span></span> 

> [!NOTE]
> <span data-ttu-id="f1ad1-119">Службы могут использовать один и тот же физический сервер базы данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-119">It's fine for services to share the same physical database server.</span></span> <span data-ttu-id="f1ad1-120">Проблема возникает, если службы используют одни и те же схему или набор таблиц базы данных для операций чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-120">The problem occurs when services share the same schema, or read and write to the same set of database tables.</span></span>


## <a name="challenges"></a><span data-ttu-id="f1ad1-121">Сложности</span><span class="sxs-lookup"><span data-stu-id="f1ad1-121">Challenges</span></span>

<span data-ttu-id="f1ad1-122">Управление данными с применением такого распределенного подхода сопряжено с некоторыми сложностями.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-122">Some challenges arise from this distributed approach to managing data.</span></span> <span data-ttu-id="f1ad1-123">Во-первых, данные в хранилищах данных могут стать избыточными (когда один и тот же элемент данных хранится в нескольких расположениях).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-123">First, there may be redundancy across the data stores, with the same item of data appearing in multiple places.</span></span> <span data-ttu-id="f1ad1-124">Например, данные могут храниться как часть транзакции и при этом храниться в других расположениях для анализа, создания отчетов или архивации.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-124">For example, data might be stored as part of a transaction, then stored elsewhere for analytics, reporting, or archiving.</span></span> <span data-ttu-id="f1ad1-125">Дублированные и секционированные данные могут нарушить целостность и согласованность данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-125">Duplicated or partitioned data can lead to issues of data integrity and consistency.</span></span> <span data-ttu-id="f1ad1-126">Если связи между данными охватывают несколько служб, вы не сможете использовать традиционные методы управления данными для реализации этих связей.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-126">When data relationships span multiple services, you can't use traditional data management techniques to enforce the relationships.</span></span>

<span data-ttu-id="f1ad1-127">В традиционном моделировании данных применяется правило "один факт в одном расположении".</span><span class="sxs-lookup"><span data-stu-id="f1ad1-127">Traditional data modeling uses the rule of "one fact in one place."</span></span> <span data-ttu-id="f1ad1-128">Каждая сущность представлена в схеме только один раз.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-128">Every entity appears exactly once in the schema.</span></span> <span data-ttu-id="f1ad1-129">Другие сущности могут ссылаться на нее, но не дублировать.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-129">Other entities may hold references to it but not duplicate it.</span></span> <span data-ttu-id="f1ad1-130">Очевидное преимущество традиционного подхода заключается в том, что обновления выполняются в одном расположении, позволяя избежать проблем с согласованностью данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-130">The obvious advantage to the traditional approach is that updates are made in a single place, which avoids problems with data consistency.</span></span> <span data-ttu-id="f1ad1-131">Проектируя архитектуру микрослужб, вам следует продумать, как выполнять обновления в нескольких службах и управлять итоговой согласованностью, если данные хранятся в нескольких расположениях без строгой согласованности.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-131">In a microservices architecture, you have to consider how updates are propagated across services, and how to manage eventual consistency when data appears in multiple places without strong consistency.</span></span> 

## <a name="approaches-to-managing-data"></a><span data-ttu-id="f1ad1-132">Подходы к управлению данными</span><span class="sxs-lookup"><span data-stu-id="f1ad1-132">Approaches to managing data</span></span>

<span data-ttu-id="f1ad1-133">Универсального подхода, который будет приемлемым во всех сценариях, нет. Но ниже приведены некоторые общие рекомендации по управлению данными в архитектуре микрослужб.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-133">There is no single approach that's correct in all cases, but here are some general guidelines for managing data in a microservices architecture.</span></span>

- <span data-ttu-id="f1ad1-134">Применяйте итоговую согласованность, где это возможно.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-134">Embrace eventual consistency where possible.</span></span> <span data-ttu-id="f1ad1-135">Определите, где в системе требуется строгая согласованность или транзакции ACID, а где — окончательная согласованность.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-135">Understand the places in the system where you need strong consistency or ACID transactions, and the places where eventual consistency is acceptable.</span></span>

- <span data-ttu-id="f1ad1-136">Если требуется обеспечить строгую согласованность, одна служба может представлять источник истины для определенной сущности, который предоставляется через API.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-136">When you need strong consistency guarantees, one service may represent the source of truth for a given entity, which is exposed through an API.</span></span> <span data-ttu-id="f1ad1-137">Другие службы могут содержать собственную копию данных или набор данных, которые в итоге согласовываются с основными данными, но не считаются источником истины.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-137">Other services might hold their own copy of the data, or a subset of the data, that is eventually consistent with the master data but not considered the source of truth.</span></span> <span data-ttu-id="f1ad1-138">Например, представьте систему электронной коммерции со службой для обработки заказов клиента и службой рекомендации.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-138">For example, imagine an e-commerce system with a customer order service and a recommendation service.</span></span> <span data-ttu-id="f1ad1-139">Служба рекомендаций может прослушивать события из службы обработки заказов, но в ситуациях, когда клиент запрашивает возмещение, полный журнал транзакций хранится в службе заказов, а не службе рекомендаций.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-139">The recommendation service might listen to events from the order service, but if a customer requests a refund, it is the order service, not the recommendation service, that has the complete transaction history.</span></span>

- <span data-ttu-id="f1ad1-140">Для транзакций используйте такие шаблоны, как [Планировщик, агент, контролер](../patterns/scheduler-agent-supervisor.md) и [Компенсирующие транзакции](../patterns/compensating-transaction.md), чтобы обеспечить согласованность данных в нескольких службах.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-140">For transactions, use patterns such as [Scheduler Agent Supervisor](../patterns/scheduler-agent-supervisor.md) and [Compensating Transaction](../patterns/compensating-transaction.md) to keep data consistent across several services.</span></span>  <span data-ttu-id="f1ad1-141">Возможно, потребуется хранить дополнительный фрагмент данных, в котором записано состояние единицы работы, охватывающей несколько служб, чтобы избежать частичного сбоя между этими службами.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-141">You may need to store an additional piece of data that captures the state of a unit of work that spans multiple services, to avoid partial failure among multiple services.</span></span> <span data-ttu-id="f1ad1-142">Например, оставьте рабочий элемент в долгосрочной очереди, пока осуществляется многоэтапная транзакция.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-142">For example, keep a work item on a durable queue while a multi-step transaction is in progress.</span></span> 

- <span data-ttu-id="f1ad1-143">Храните только данные, которые требуются службе.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-143">Store only the data that a service needs.</span></span> <span data-ttu-id="f1ad1-144">Службе может потребоваться только набор данных о сущности домена.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-144">A service might only need a subset of information about a domain entity.</span></span> <span data-ttu-id="f1ad1-145">Например, в ограниченном контексте доставки нужно знать, какой клиент связан с определенной доставкой.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-145">For example, in the Shipping bounded context, we need to know which customer is associated to a particular delivery.</span></span> <span data-ttu-id="f1ad1-146">Но нам не требуется адрес клиента для выставления счета, который управляется в ограниченном контексте счетов.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-146">But we don't need the customer's billing address &mdash; that's managed by the Accounts bounded context.</span></span> <span data-ttu-id="f1ad1-147">Здесь поможет тщательный анализ и использование разработки на основе домена (DDD).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-147">Thinking carefully about the domain, and using a DDD approach, can help here.</span></span> 

- <span data-ttu-id="f1ad1-148">Подумайте, являются ли службы согласованными и слабо связанными.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-148">Consider whether your services are coherent and loosely coupled.</span></span> <span data-ttu-id="f1ad1-149">Если две службы постоянно обмениваются данными, в результате чего через API-интерфейсы проходят множественные операции, потребуется изменить границы служб, объединив эти службы или выполнив рефакторинг их функций.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-149">If two services are continually exchanging information with each other, resulting in chatty APIs, you may need to redraw your service boundaries, by merging two services or refactoring their functionality.</span></span>

- <span data-ttu-id="f1ad1-150">Используйте [стиль архитектуры, управляемой событиями](../guide/architecture-styles/event-driven.md).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-150">Use an [event driven architecture style](../guide/architecture-styles/event-driven.md).</span></span> <span data-ttu-id="f1ad1-151">В рамках этого подхода служба публикует событие, если изменяются ее общедоступные модели или сущности.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-151">In this architecture style, a service publishes an event when there are changes to its public models or entities.</span></span> <span data-ttu-id="f1ad1-152">Заинтересованные службы можно подписать на эти события.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-152">Interested services can subscribe to these events.</span></span> <span data-ttu-id="f1ad1-153">Например, другая служба может использовать эти события для создания материализованного представления данных, которое больше подходит для запросов.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-153">For example, another service could use the events to construct a materialized view of the data that is more suitable for querying.</span></span> 

- <span data-ttu-id="f1ad1-154">Служба, которой принадлежат события, должна опубликовать схему, с помощью которой можно автоматизировать сериализацию и десериализацию событий, чтобы избежать тесной взаимозависимости между издателями и подписчиками.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-154">A service that owns events should publish a schema that can be used to automate serializing and deserializing the events, to avoid tight coupling between publishers and subscribers.</span></span> <span data-ttu-id="f1ad1-155">Используйте схему JSON для таких платформ, как [Microsoft Bond](https://github.com/Microsoft/bond), Protobuf или Avro.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-155">Consider JSON schema or a framework like [Microsoft Bond](https://github.com/Microsoft/bond), Protobuf, or Avro.</span></span>  
 
- <span data-ttu-id="f1ad1-156">При больших масштабах события могут вызывать проблемы на уровне системы, поэтому рекомендуется использовать агрегирование или пакетную обработку, чтобы уменьшить общую нагрузку.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-156">At high scale, events can become a bottleneck on the system, so consider using aggregation or batching to reduce the total load.</span></span> 

## <a name="drone-delivery-choosing-the-data-stores"></a><span data-ttu-id="f1ad1-157">Доставка беспилотными летательными аппаратами: выбор хранилища данных</span><span class="sxs-lookup"><span data-stu-id="f1ad1-157">Drone Delivery: Choosing the data stores</span></span> 

<span data-ttu-id="f1ad1-158">Пример ограниченного контекста доставки даже с несколькими службами иллюстрирует некоторые моменты, рассматриваемые в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-158">Even with only a few services, the Shipping bounded context illustrates several of the points discussed in this section.</span></span> 

<span data-ttu-id="f1ad1-159">Когда пользователь планирует новую доставку, запрос клиента содержит сведения о доставке, например пункт выдачи заказа и конечный пункт доставки, а также о посылке, например размер и вес.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-159">When a user schedules a new delivery, the client request includes information about the both the delivery, such as the pickup and dropoff locations, and about the package, such as the size and weight.</span></span> <span data-ttu-id="f1ad1-160">Эта информация определяет единицу работы, которую служба приема событий отправляет в концентраторы событий.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-160">This information defines a unit of work, which the Ingestion service sends to Event Hubs.</span></span> <span data-ttu-id="f1ad1-161">Важно, чтобы единица работы оставалась в постоянном хранилище, когда служба планировщика выполняет рабочий процесс. Так запросы на доставку не будут утеряны.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-161">It's important that the unit of work stays in persistent storage while the Scheduler service is executing the workflow, so that no delivery requests are lost.</span></span> <span data-ttu-id="f1ad1-162">Подробное описание рабочего процесса см. в статье [Проектирование микрослужб: прием данных и рабочий процесс](./ingestion-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-162">For more discussion of the workflow, see [Ingestion and workflow](./ingestion-workflow.md).</span></span> 

<span data-ttu-id="f1ad1-163">Разные серверные службы отвечают за разные блоки информации в запросе и также имеют разные профили чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-163">The various backend services care about different portions of the information in the request, and also have different read and write profiles.</span></span> 

### <a name="delivery-service"></a><span data-ttu-id="f1ad1-164">Служба доставки</span><span class="sxs-lookup"><span data-stu-id="f1ad1-164">Delivery service</span></span>

<span data-ttu-id="f1ad1-165">В службе доставки хранится информация о каждой запланированной или выполняемой доставке.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-165">The Delivery service stores information about every delivery that is currently scheduled or in progress.</span></span> <span data-ttu-id="f1ad1-166">Эта служба прослушивает события, передаваемые от беспилотных летательных аппаратов, и отслеживает состояние выполняемых доставок.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-166">It listens for events from the drones, and tracks the status of deliveries that are in progress.</span></span> <span data-ttu-id="f1ad1-167">Служба также отправляет события домена с обновлениями состояния доставки.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-167">It also sends domain events with delivery status updates.</span></span>

<span data-ttu-id="f1ad1-168">Ожидается, что пользователи будут часто проверять состояние доставки, пока они ожидают свою посылку.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-168">It's expected that users will frequently check the status of a delivery while they are waiting for their package.</span></span> <span data-ttu-id="f1ad1-169">Поэтому для службы доставки требуется такое хранилище данных, в котором преимущество отдается пропускной способности (чтение и запись) при долговременном хранении данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-169">Therefore, the Delivery service requires a data store that emphasizes throughput (read and write) over long-term storage.</span></span> <span data-ttu-id="f1ad1-170">Кроме того, служба доставки не выполняет сложные запросы или операции анализа. Она просто получает данные о последнем состоянии определенной доставки.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-170">Also, the Delivery service does not perform any complex queries or analysis, it simply fetches the latest status for a given delivery.</span></span> <span data-ttu-id="f1ad1-171">Команда разработчиков службы доставки выбрала кэш Redis для Azure, чтобы обеспечить высокий уровень производительности операций чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-171">The Delivery service team chose Azure Redis Cache for its high read-write performance.</span></span> <span data-ttu-id="f1ad1-172">В кэше Redis хранится информация с коротким сроком хранения.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-172">The information stored in Redis is relatively short-lived.</span></span> <span data-ttu-id="f1ad1-173">После выполнения доставки в качестве системы записи используется служба истории доставок.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-173">Once a delivery is complete, the Delivery History service is the system of record.</span></span>

### <a name="delivery-history-service"></a><span data-ttu-id="f1ad1-174">Служба истории доставок</span><span class="sxs-lookup"><span data-stu-id="f1ad1-174">Delivery History service</span></span>

<span data-ttu-id="f1ad1-175">Служба истории доставок прослушивает события состояния доставки, передаваемые от службы доставки.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-175">The Delivery History service listens for delivery status events from the Delivery service.</span></span> <span data-ttu-id="f1ad1-176">Она сохраняет эти данные в долговременном хранилище.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-176">It stores this data in long-term storage.</span></span> <span data-ttu-id="f1ad1-177">Есть два варианта использования этих исторических данных, которые имеют разные требования к хранилищу данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-177">There are two different use-cases for this historical data, which have different data storage requirements.</span></span> 

<span data-ttu-id="f1ad1-178">В первом сценарии данные агрегируются для анализа, чтобы оптимизировать бизнес или улучшить качество услуг.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-178">The first scenario is aggregating the data for the purpose of data analytics, in order to optimize the business or improve the quality of the service.</span></span> <span data-ttu-id="f1ad1-179">Важно отметить, что служба истории доставок не осуществляет фактический анализ данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-179">Note that the Delivery History service doesn't perform the actual analysis of the data.</span></span> <span data-ttu-id="f1ad1-180">Она отвечает только за прием и хранение.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-180">It's only responsible for the ingestion and storage.</span></span> <span data-ttu-id="f1ad1-181">В этом сценарии нужно оптимизировать хранилище для анализа большого набора данных, используя подход схемы при чтении для размещения различных источников данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-181">For this scenario, the storage must be optimized for data analysis over a large set of data, using a schema-on-read approach to accommodate a variety of data sources.</span></span> <span data-ttu-id="f1ad1-182">[Azure Data Lake Store](/azure/data-lake-store/) отлично подходит для этого сценария.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-182">[Azure Data Lake Store](/azure/data-lake-store/) is a good fit for this scenario.</span></span> <span data-ttu-id="f1ad1-183">Data Lake Store имеет файловую систему Apache Hadoop, которая совместима с распределенной файловой системой Hadoop и адаптирована к различным сценариям анализа данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-183">Data Lake Store is an Apache Hadoop file system compatible with Hadoop Distributed File System (HDFS), and is tuned for performance for data analytics scenarios.</span></span> 

<span data-ttu-id="f1ad1-184">Во втором сценарии пользователи могут просмотреть историю завершенной доставки.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-184">The other scenario is enabling users to look up the history of a delivery after the delivery is completed.</span></span> <span data-ttu-id="f1ad1-185">Azure Data Lake не очень подходит для этого сценария.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-185">Azure Data Lake is not particularly optimized for this scenario.</span></span> <span data-ttu-id="f1ad1-186">Для достижения оптимальной производительности рекомендуется хранить данные временных рядов в Data Lake в папках, секционированных по датам.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-186">For optimal performance, Microsoft recommends storing time-series data in Data Lake in folders partitioned by date.</span></span> <span data-ttu-id="f1ad1-187">Дополнительные сведения см. в статье [Настройка Azure Data Lake Store для повышения производительности](/azure/data-lake-store/data-lake-store-performance-tuning-guidance).</span><span class="sxs-lookup"><span data-stu-id="f1ad1-187">(See [Tuning Azure Data Lake Store for performance](/azure/data-lake-store/data-lake-store-performance-tuning-guidance)).</span></span> <span data-ttu-id="f1ad1-188">Но такая структура не подходит для поиска отдельных записей по идентификатору.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-188">However, that structure is not optimal for looking up individual records by ID.</span></span> <span data-ttu-id="f1ad1-189">Если метка времени неизвестна, для поиска по идентификатору требуется проверить всю коллекцию.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-189">Unless you also know the timestamp, a lookup by ID requires scanning the entire collection.</span></span> <span data-ttu-id="f1ad1-190">Таким образом, служба истории доставок также содержит набор исторических данных в Cosmos DB для ускоренного поиска.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-190">Therefore, the Delivery History service also stores a subset of the historical data in Cosmos DB for quicker lookup.</span></span> <span data-ttu-id="f1ad1-191">Записи не должны все время храниться в Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-191">The records don't need to stay in Cosmos DB indefinitely.</span></span> <span data-ttu-id="f1ad1-192">Старые записи можно архивировать, например через месяц.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-192">Older deliveries can be archived &mdash; say, after a month.</span></span> <span data-ttu-id="f1ad1-193">Это можно сделать, запуская нерегулярную пакетную обработку.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-193">This could be done by running an occasional batch process.</span></span>

### <a name="package-service"></a><span data-ttu-id="f1ad1-194">Служба посылок</span><span class="sxs-lookup"><span data-stu-id="f1ad1-194">Package service</span></span>

<span data-ttu-id="f1ad1-195">В службе посылок хранится информация о всех посылках.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-195">The Package service stores information about all of the packages.</span></span> <span data-ttu-id="f1ad1-196">Требования к хранилищу данных для этой службы:</span><span class="sxs-lookup"><span data-stu-id="f1ad1-196">The storage requirements for the Package are:</span></span> 

- <span data-ttu-id="f1ad1-197">долговременное хранение;</span><span class="sxs-lookup"><span data-stu-id="f1ad1-197">Long-term storage.</span></span>
- <span data-ttu-id="f1ad1-198">возможность обрабатывать большое количество пакетов, для чего требуется высокая пропускная способность операций записи;</span><span class="sxs-lookup"><span data-stu-id="f1ad1-198">Able to handle a high volume of packages, requiring high write throughput.</span></span>
- <span data-ttu-id="f1ad1-199">поддержка простых запросов по идентификатору посылки;</span><span class="sxs-lookup"><span data-stu-id="f1ad1-199">Support simple queries by package ID.</span></span> <span data-ttu-id="f1ad1-200">отсутствие сложных соединений и требований для обеспечения целостности данных.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-200">No complex joins or requirements for referential integrity.</span></span>

<span data-ttu-id="f1ad1-201">Так как данные о посылках не являются реляционными, можно использовать базу данных для хранения документов. Тогда Cosmos DB сможет достичь высокой пропускной способности с использованием сегментированных коллекций.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-201">Because the package data is not relational, a document oriented database is appropriate, and Cosmos DB can achieve very high throughput by using sharded collections.</span></span> <span data-ttu-id="f1ad1-202">Команда, которая работает со службой посылок, знакома со стеком MEAN (MongoDB, Express.js, AngularJS и Node.js.), поэтому она выбрала [MongoDB API](/azure/cosmos-db/mongodb-introduction) для Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-202">The team that works on the Package service is familiar with the MEAN stack (MongoDB, Express.js, AngularJS, and Node.js), so they select the [MongoDB API](/azure/cosmos-db/mongodb-introduction) for Cosmos DB.</span></span> <span data-ttu-id="f1ad1-203">Это позволит ей эффективно применить свой опыт работы с MongoDB и воспользоваться преимуществами Cosmos DB, управляемой службой Azure.</span><span class="sxs-lookup"><span data-stu-id="f1ad1-203">That lets them leverage their existing experience with MongoDB, while getting the benefits of Cosmos DB, which is a managed Azure service.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="f1ad1-204">Обмен данными между службами</span><span class="sxs-lookup"><span data-stu-id="f1ad1-204">Interservice communication</span></span>](./interservice-communication.md)