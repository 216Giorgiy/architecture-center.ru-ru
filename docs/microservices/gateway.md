---
title: Шлюзы API
description: Шлюзы API в микрослужбах
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 6483d416363e24f4084d6b856847a740bf4054d9
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/29/2017
---
# <a name="designing-microservices-api-gateways"></a><span data-ttu-id="da206-103">Проектирование микрослужб: шлюзы API</span><span class="sxs-lookup"><span data-stu-id="da206-103">Designing microservices: API gateways</span></span>

<span data-ttu-id="da206-104">В архитектуре микрослужб клиент может взаимодействовать с несколькими внешними службами.</span><span class="sxs-lookup"><span data-stu-id="da206-104">In a microservices architecture, a client might interact with more than one front-end service.</span></span> <span data-ttu-id="da206-105">Учитывая этот факт, как клиент узнает, какую конечную точку вызывать?</span><span class="sxs-lookup"><span data-stu-id="da206-105">Given this fact, how does a client know what endpoints to call?</span></span> <span data-ttu-id="da206-106">Что происходит, когда появляются новые службы или выполняется рефакторинг существующих?</span><span class="sxs-lookup"><span data-stu-id="da206-106">What happens when new services are introduced, or existing services are refactored?</span></span> <span data-ttu-id="da206-107">Как службы обрабатывают завершение SSL-запросов, аутентификацию и другие операции?</span><span class="sxs-lookup"><span data-stu-id="da206-107">How do services handle SSL termination, authentication, and other concerns?</span></span> <span data-ttu-id="da206-108">*Шлюз API* поможет ответить на эти вопросы.</span><span class="sxs-lookup"><span data-stu-id="da206-108">An *API gateway* can help to address these challenges.</span></span> 

![](./images/gateway.png)

## <a name="what-is-an-api-gateway"></a><span data-ttu-id="da206-109">Что такое шлюз API?</span><span class="sxs-lookup"><span data-stu-id="da206-109">What is an API gateway?</span></span>

<span data-ttu-id="da206-110">Шлюз API находится между клиентами и службами.</span><span class="sxs-lookup"><span data-stu-id="da206-110">An API gateway sits between clients and services.</span></span> <span data-ttu-id="da206-111">Он выполняет роль обратного прокси-сервера, который перенаправляет запросы от клиентов к службам.</span><span class="sxs-lookup"><span data-stu-id="da206-111">It acts as a reverse proxy, routing requests from clients to services.</span></span> <span data-ttu-id="da206-112">Он также может выполнять такие специализированные задачи, как аутентификация, завершение SSL-запросов и ограничение частоты.</span><span class="sxs-lookup"><span data-stu-id="da206-112">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> <span data-ttu-id="da206-113">Если этот шлюз не будет развернут, клиенты должны будут отправлять запросы непосредственно к внешним службам.</span><span class="sxs-lookup"><span data-stu-id="da206-113">If you don't deploy a gateway, clients must send requests directly to front-end services.</span></span> <span data-ttu-id="da206-114">Но при предоставлении клиентам непосредственного доступа к службам могут возникнуть некоторые проблемы.</span><span class="sxs-lookup"><span data-stu-id="da206-114">However, there are some potential problems with exposing services directly to clients:</span></span>

- <span data-ttu-id="da206-115">Это может усложнить клиентский код.</span><span class="sxs-lookup"><span data-stu-id="da206-115">It can result in complex client code.</span></span> <span data-ttu-id="da206-116">Клиент должен отслеживать несколько конечных точек и обрабатывать ошибки, сохраняя отказоустойчивость.</span><span class="sxs-lookup"><span data-stu-id="da206-116">The client must keep track of multiple endpoints, and handle failures in a resilient way.</span></span> 
- <span data-ttu-id="da206-117">Так создается взаимозависимость между клиентом и сервером.</span><span class="sxs-lookup"><span data-stu-id="da206-117">It creates coupling between the client and the backend.</span></span> <span data-ttu-id="da206-118">Клиент должен знать, каким образом выполняется разбивка отдельных служб.</span><span class="sxs-lookup"><span data-stu-id="da206-118">The client needs to know how the individual services are decomposed.</span></span> <span data-ttu-id="da206-119">Из-за этого усложняется поддержка клиента и выполнение рефакторинга служб.</span><span class="sxs-lookup"><span data-stu-id="da206-119">That makes it harder to maintain the client and also harder to refactor services.</span></span>
- <span data-ttu-id="da206-120">Для одной операции может потребоваться вызвать несколько служб.</span><span class="sxs-lookup"><span data-stu-id="da206-120">A single operation might require calls to multiple services.</span></span> <span data-ttu-id="da206-121">Это может привести к увеличению круговых путей в сети между клиентом и сервером, из-за чего возникает значительная задержка.</span><span class="sxs-lookup"><span data-stu-id="da206-121">That can result in multiple network round trips between the client and the server, adding significant latency.</span></span> 
- <span data-ttu-id="da206-122">Каждая общедоступная служба должна обрабатывать такие операции, как аутентификация, SSL-запросы и ограничение частоты клиента.</span><span class="sxs-lookup"><span data-stu-id="da206-122">Each public-facing service must handle concerns such as authentication, SSL, and client rate limiting.</span></span> 
- <span data-ttu-id="da206-123">Службы должны предоставлять понятный для клиента протокол, например HTTP или WebSocket.</span><span class="sxs-lookup"><span data-stu-id="da206-123">Services must expose a client-friendly protocol such as HTTP or WebSocket.</span></span> <span data-ttu-id="da206-124">Это ограничивает выбор [протоколов связи](./interservice-communication.md).</span><span class="sxs-lookup"><span data-stu-id="da206-124">This limits the choice of [communication protocols](./interservice-communication.md).</span></span> 
- <span data-ttu-id="da206-125">Службы с общедоступными конечными точками являются целью потенциальных атак и должны быть защищены.</span><span class="sxs-lookup"><span data-stu-id="da206-125">Services with public endpoints are a potential attack surface, and must be hardened.</span></span>

<span data-ttu-id="da206-126">Шлюз помогает решить эти проблемы, разделив клиенты и службы.</span><span class="sxs-lookup"><span data-stu-id="da206-126">A gateway helps to address these issues by decoupling clients from services.</span></span> <span data-ttu-id="da206-127">Шлюзы могут выполнять разные функции, не все из которых вам могут потребоваться.</span><span class="sxs-lookup"><span data-stu-id="da206-127">Gateways can perform a number of different functions, and you may not need all of them.</span></span> <span data-ttu-id="da206-128">Функции можно сгруппировать в соответствии со следующими задачами:</span><span class="sxs-lookup"><span data-stu-id="da206-128">The functions can be grouped into the following design patterns:</span></span>

<span data-ttu-id="da206-129">[Маршрутизация шлюза.](../patterns/gateway-routing.md)</span><span class="sxs-lookup"><span data-stu-id="da206-129">[Gateway Routing](../patterns/gateway-routing.md).</span></span> <span data-ttu-id="da206-130">Использование шлюза в качестве обратного прокси-сервера для перенаправления запросов на одну или несколько серверных служб с помощью маршрутизации уровня 7.</span><span class="sxs-lookup"><span data-stu-id="da206-130">Use the gateway as a reverse proxy to route requests to one or more backend services, using layer 7 routing.</span></span> <span data-ttu-id="da206-131">Шлюз предоставляет одну конечную точку для клиентов и позволяет разделить клиенты и службы.</span><span class="sxs-lookup"><span data-stu-id="da206-131">The gateway provides a single endpoint for clients, and helps to decouple clients from services.</span></span> 

<span data-ttu-id="da206-132">[Агрегация шлюза.](../patterns/gateway-aggregation.md)</span><span class="sxs-lookup"><span data-stu-id="da206-132">[Gateway Aggregation](../patterns/gateway-aggregation.md).</span></span> <span data-ttu-id="da206-133">Использование шлюза для объединения нескольких отдельных запросов в один.</span><span class="sxs-lookup"><span data-stu-id="da206-133">Use the gateway to aggregate multiple individual requests into a single request.</span></span> <span data-ttu-id="da206-134">Этот шаблон применяется, если необходимо выполнить одну операцию вызова к нескольким серверным службам.</span><span class="sxs-lookup"><span data-stu-id="da206-134">This pattern applies when a single operation requires calls to multiple backend services.</span></span> <span data-ttu-id="da206-135">Клиент отправляет один запрос к шлюзу.</span><span class="sxs-lookup"><span data-stu-id="da206-135">The client sends one request to the gateway.</span></span> <span data-ttu-id="da206-136">Этот шлюз распределяет запросы между разными серверными службами, затем объединяет результаты и отправляет их запрашивающему клиенту.</span><span class="sxs-lookup"><span data-stu-id="da206-136">The gateway dispatches requests to the various backend services, and then aggregates the results and sends them back to the client.</span></span> <span data-ttu-id="da206-137">Это позволяет сократить число вызовов между клиентом и серверной частью.</span><span class="sxs-lookup"><span data-stu-id="da206-137">This helps to reduce chattiness between the client and the backend.</span></span> 

<span data-ttu-id="da206-138">[Разгрузка шлюза.](../patterns/gateway-offloading.md)</span><span class="sxs-lookup"><span data-stu-id="da206-138">[Gateway Offloading](../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="da206-139">Использование шлюза для передачи функций отдельных служб в шлюз, в частности специализированных операций.</span><span class="sxs-lookup"><span data-stu-id="da206-139">Use the gateway to offload functionality from individual services to the gateway, particularly cross-cutting concerns.</span></span> <span data-ttu-id="da206-140">Этот шаблон можно использовать для объединения этих функций, вместо того, чтобы каждая служба отвечала за их реализацию.</span><span class="sxs-lookup"><span data-stu-id="da206-140">It can be useful to consolidate these functions into one place, rather than making every service responsible for implementing them.</span></span> <span data-ttu-id="da206-141">Это особенно полезно для компонентов, для реализации которых необходимы специальные действия. Например, для аутентификации и авторизации.</span><span class="sxs-lookup"><span data-stu-id="da206-141">This is particularly true for features that requires specialized skills to implement correctly, such as authentication and authorization.</span></span> 

<span data-ttu-id="da206-142">Ниже приведены некоторые примеры функций, которые можно передать в шлюз:</span><span class="sxs-lookup"><span data-stu-id="da206-142">Here are some examples of functionality that could be offloaded to a gateway:</span></span>

- <span data-ttu-id="da206-143">завершение SSL-запросов;</span><span class="sxs-lookup"><span data-stu-id="da206-143">SSL termination</span></span>
- <span data-ttu-id="da206-144">аутентификация;</span><span class="sxs-lookup"><span data-stu-id="da206-144">Authentication</span></span>
- <span data-ttu-id="da206-145">список разрешенных IP-адресов;</span><span class="sxs-lookup"><span data-stu-id="da206-145">IP whitelisting</span></span>
- <span data-ttu-id="da206-146">ограничение частоты клиента (регулирование количества запросов);</span><span class="sxs-lookup"><span data-stu-id="da206-146">Client rate limiting (throttling)</span></span>
- <span data-ttu-id="da206-147">ведение журналов и мониторинг;</span><span class="sxs-lookup"><span data-stu-id="da206-147">Logging and monitoring</span></span>
- <span data-ttu-id="da206-148">кэширование ответов;</span><span class="sxs-lookup"><span data-stu-id="da206-148">Response caching</span></span>
- <span data-ttu-id="da206-149">брандмауэр веб-приложения;</span><span class="sxs-lookup"><span data-stu-id="da206-149">Web application firewall</span></span>
- <span data-ttu-id="da206-150">сжатие GZIP;</span><span class="sxs-lookup"><span data-stu-id="da206-150">GZIP compression</span></span>
- <span data-ttu-id="da206-151">обслуживание статического содержимого.</span><span class="sxs-lookup"><span data-stu-id="da206-151">Servicing static content</span></span>

## <a name="choosing-a-gateway-technology"></a><span data-ttu-id="da206-152">Выбор технологии шлюза</span><span class="sxs-lookup"><span data-stu-id="da206-152">Choosing a gateway technology</span></span>

<span data-ttu-id="da206-153">Вот несколько параметров для реализации шлюза API в приложении.</span><span class="sxs-lookup"><span data-stu-id="da206-153">Here are some options for implementing an API gateway in your application.</span></span>

- <span data-ttu-id="da206-154">**Обратный прокси-сервер.**</span><span class="sxs-lookup"><span data-stu-id="da206-154">**Reverse proxy server**.</span></span> <span data-ttu-id="da206-155">Nginx и HAProxy — популярные обратные прокси-серверы, которые поддерживают такие функции, как SSL-запросы, балансировка нагрузки и маршрутизация уровня 7.</span><span class="sxs-lookup"><span data-stu-id="da206-155">Nginx and HAProxy are popular reverse proxy servers that support features such as load balancing, SSL, and layer 7 routing.</span></span> <span data-ttu-id="da206-156">Оба сервера являются бесплатными продуктами с открытым кодом и платными выпусками, которые предусматривают дополнительные возможности и варианты поддержки.</span><span class="sxs-lookup"><span data-stu-id="da206-156">They are both free, open-source products, with paid editions that provide additional features and support options.</span></span> <span data-ttu-id="da206-157">Nginx и HAProxy — это современные продукты с широкими наборами функций и высоким уровнем производительности.</span><span class="sxs-lookup"><span data-stu-id="da206-157">Nginx and HAProxy are both mature products with rich feature sets and high performance.</span></span> <span data-ttu-id="da206-158">Их можно расширить с помощью сторонних модулей или путем написания пользовательских скриптов в Lua.</span><span class="sxs-lookup"><span data-stu-id="da206-158">You can extend them with third-party modules or by writing custom scripts in Lua.</span></span> <span data-ttu-id="da206-159">Nginx также поддерживает модуль создания скриптов на базе JavaScript, который называется NginScript.</span><span class="sxs-lookup"><span data-stu-id="da206-159">Nginx also supports a JavaScript-based scripting module called NginScript.</span></span>

- <span data-ttu-id="da206-160">**Входящий контроллер сетки службы.**</span><span class="sxs-lookup"><span data-stu-id="da206-160">**Service mesh ingress controller**.</span></span> <span data-ttu-id="da206-161">При использовании слоя взаимодействия между службами, например linkerd или Istio, попробуйте использовать функции, предоставленные входящим контроллером для этой сетки службы.</span><span class="sxs-lookup"><span data-stu-id="da206-161">If you are using a service mesh such as linkerd or Istio, consider the features that are provided by the ingress controller for that service mesh.</span></span> <span data-ttu-id="da206-162">Например, входящий контроллер Istio поддерживает маршрутизацию уровня 7, переадресацию HTTP, повторные попытки и другие функции.</span><span class="sxs-lookup"><span data-stu-id="da206-162">For example, the Istio ingress controller supports layer 7 routing, HTTP redirects, retries, and other features.</span></span> 

- <span data-ttu-id="da206-163">[Шлюз приложений Azure.](/azure/application-gateway/)</span><span class="sxs-lookup"><span data-stu-id="da206-163">[Azure Application Gateway](/azure/application-gateway/).</span></span> <span data-ttu-id="da206-164">Шлюз приложений — управляемая служба балансировки нагрузки, которая может выполнять маршрутизацию уровня 7 и завершение SSL-запросов.</span><span class="sxs-lookup"><span data-stu-id="da206-164">Application Gateway is a managed load balancing service that can perform layer-7 routing and SSL termination.</span></span> <span data-ttu-id="da206-165">Эта служба также предоставляет брандмауэр веб-приложения (WAF).</span><span class="sxs-lookup"><span data-stu-id="da206-165">It also provides a web application firewall (WAF).</span></span>

- <span data-ttu-id="da206-166">[Служба управления Azure API.](/azure/api-management/)</span><span class="sxs-lookup"><span data-stu-id="da206-166">[Azure API Management](/azure/api-management/).</span></span> <span data-ttu-id="da206-167">Служба управления API — это комплексное решение, обеспечивающее публикацию API во внешние и внутренние клиенты.</span><span class="sxs-lookup"><span data-stu-id="da206-167">API Management is a turnkey solution for publishing APIs to external and internal customers.</span></span> <span data-ttu-id="da206-168">Она предоставляет возможности, которые можно использовать для управления общедоступным API, в включая ограничение частоты, использование списка разрешенных IP-адресов и аутентификацию с помощью Azure Active Directory или других поставщиков удостоверений.</span><span class="sxs-lookup"><span data-stu-id="da206-168">It provides features that are useful for managing a public-facing API, including rate limiting, IP white listing, and authentication using Azure Active Directory or other identity providers.</span></span> <span data-ttu-id="da206-169">Служба управления API не выполняет балансировку нагрузки, поэтому ее следует использовать в сочетании с подсистемой балансировки нагрузки, например шлюзом приложений или обратным прокси-сервером.</span><span class="sxs-lookup"><span data-stu-id="da206-169">API Management doesn't perform any load balancing, so it should be used in conjunction with a load balancer such as Application Gateway or a reverse proxy.</span></span>

<span data-ttu-id="da206-170">При выборе технологии шлюза учитывайте следующее:</span><span class="sxs-lookup"><span data-stu-id="da206-170">When choosing a gateway technology, consider the following:</span></span>

<span data-ttu-id="da206-171">**Функции.**</span><span class="sxs-lookup"><span data-stu-id="da206-171">**Features**.</span></span> <span data-ttu-id="da206-172">Все варианты, перечисленные выше, поддерживают маршрутизацию уровня 7, но не обязательно поддерживают остальные функции.</span><span class="sxs-lookup"><span data-stu-id="da206-172">The options listed above all support layer 7 routing, but support for other features will vary.</span></span> <span data-ttu-id="da206-173">Вы можете развернуть несколько шлюзов в зависимости от функций, которые вам нужны.</span><span class="sxs-lookup"><span data-stu-id="da206-173">Depending on the features that you need, you might deploy more than one gateway.</span></span> 

<span data-ttu-id="da206-174">**Развертывание**.</span><span class="sxs-lookup"><span data-stu-id="da206-174">**Deployment**.</span></span> <span data-ttu-id="da206-175">Шлюз приложений Azure и управление API являются управляемыми службами.</span><span class="sxs-lookup"><span data-stu-id="da206-175">Azure Application Gateway and API Management are managed services.</span></span> <span data-ttu-id="da206-176">Nginx и HAProxy обычно выполняются в контейнерах внутри кластера, а также могут быть развернуты на выделенных виртуальных машинах за пределами кластера.</span><span class="sxs-lookup"><span data-stu-id="da206-176">Nginx and HAProxy will typically run in containers inside the cluster, but can also be deployed to dedicated VMs outside of the cluster.</span></span> <span data-ttu-id="da206-177">Такая конфигурация изолирует шлюз от остальной части рабочей нагрузки, но увеличивает затраты на управление.</span><span class="sxs-lookup"><span data-stu-id="da206-177">This isolates the gateway from the rest of the workload, but incurs higher management overhead.</span></span>

<span data-ttu-id="da206-178">**Управление.**</span><span class="sxs-lookup"><span data-stu-id="da206-178">**Management**.</span></span> <span data-ttu-id="da206-179">Когда обновляются службы или добавляются новые, может потребоваться обновить правила маршрутизации шлюза.</span><span class="sxs-lookup"><span data-stu-id="da206-179">When services are updated or new services are added, the gateway routing rules may need to be updated.</span></span> <span data-ttu-id="da206-180">Рассмотрим, как управлять этим процессом.</span><span class="sxs-lookup"><span data-stu-id="da206-180">Consider how this process will be managed.</span></span> <span data-ttu-id="da206-181">Такие же рекомендации применимы к управлению SSL-сертификатами, спискам разрешенных IP-адресов и другим аспектам конфигурации.</span><span class="sxs-lookup"><span data-stu-id="da206-181">Similar considerations apply to managing SSL certificates, IP whitelists, and other aspects of configuration.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="da206-182">Рекомендации по развертыванию</span><span class="sxs-lookup"><span data-stu-id="da206-182">Deployment considerations</span></span>

### <a name="deploying-nginx-or-haproxy-to-kubernetes"></a><span data-ttu-id="da206-183">Развертывание Nginx или HAProxy в Kubernetes</span><span class="sxs-lookup"><span data-stu-id="da206-183">Deploying Nginx or HAProxy to Kubernetes</span></span>

<span data-ttu-id="da206-184">Серверы Nginx или HAProxy можно развернуть в Kubernetes как [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) или [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/), определяющие образ контейнера Nginx или HAProxy.</span><span class="sxs-lookup"><span data-stu-id="da206-184">You can deploy Nginx or HAProxy to Kubernetes as a [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) or [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) that specifies the Nginx or HAProxy container image.</span></span> <span data-ttu-id="da206-185">Используйте ConfigMap для хранения файла конфигурации прокси-сервера и подключения ConfigMap в качестве тома.</span><span class="sxs-lookup"><span data-stu-id="da206-185">Use a ConfigMap to store the configuration file for the proxy, and mount the ConfigMap as a volume.</span></span> <span data-ttu-id="da206-186">Создайте службу типа LoadBalancer, чтобы предоставлять доступ к шлюзу через Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="da206-186">Create a service of type LoadBalancer to expose the gateway through an Azure Load Balancer.</span></span> 

<!-- - Configure a readiness probe that serves a static file from the gateway (rather than routing to another service). -->

<span data-ttu-id="da206-187">Или создайте входящий контроллер.</span><span class="sxs-lookup"><span data-stu-id="da206-187">An alternative is to create an Ingress Controller.</span></span> <span data-ttu-id="da206-188">Входящий контроллер является ресурсом Kubernetes, который развертывает подсистему балансировки нагрузки или обратный прокси-сервер.</span><span class="sxs-lookup"><span data-stu-id="da206-188">An Ingress Controller is a Kubernetes resource that deploys a load balancer or reverse proxy server.</span></span> <span data-ttu-id="da206-189">Есть несколько вариантов реализации контроллера, в том числе Nginx и HAProxy.</span><span class="sxs-lookup"><span data-stu-id="da206-189">Several implementations exist, including Nginx and HAProxy.</span></span> <span data-ttu-id="da206-190">Отдельный ресурс, который называется входящим, определяет параметры входящего контроллера, например правила маршрутизации и сертификаты TLS.</span><span class="sxs-lookup"><span data-stu-id="da206-190">A separate resource called an Ingress defines settings for the Ingress Controller, such as routing rules and TLS certificates.</span></span> <span data-ttu-id="da206-191">В этом случае не нужно управлять сложными файлами конфигурации, которые относятся к конкретной технологии прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="da206-191">That way, you don't need to manage complex configuration files that are specific to a particular proxy server technology.</span></span> <span data-ttu-id="da206-192">На момент написания этой статьи входящие контроллеры по-прежнему являются функцией Kubernetes в бета-версии, которая будет продолжать развиваться.</span><span class="sxs-lookup"><span data-stu-id="da206-192">Ingress Controllers are still a beta feature of Kubernetes at the time of this writing, and the feature will continue to evolve.</span></span>

<span data-ttu-id="da206-193">Шлюз является потенциально проблемным местом или единой точкой сбоя в системе, поэтому всегда следует развертывать как минимум две реплики для обеспечения высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="da206-193">The gateway is a potential bottleneck or single point of failure in the system, so always deploy at least two replicas for high availability.</span></span> <span data-ttu-id="da206-194">В зависимости от нагрузки в дальнейшем может потребоваться развернуть реплики.</span><span class="sxs-lookup"><span data-stu-id="da206-194">You may need to scale out the replicas further, depending on the load.</span></span> 

<span data-ttu-id="da206-195">Также попробуйте запустить шлюз на выделенном наборе узлов в кластере.</span><span class="sxs-lookup"><span data-stu-id="da206-195">Also consider running the gateway on a dedicated set of nodes in the cluster.</span></span> <span data-ttu-id="da206-196">Этот подход отличается следующими преимуществами:</span><span class="sxs-lookup"><span data-stu-id="da206-196">Benefits to this approach include:</span></span>

- <span data-ttu-id="da206-197">Изоляция.</span><span class="sxs-lookup"><span data-stu-id="da206-197">Isolation.</span></span> <span data-ttu-id="da206-198">Весь входящий трафик передается на фиксированный набор узлов, которые могут быть изолированы от серверных служб.</span><span class="sxs-lookup"><span data-stu-id="da206-198">All inbound traffic goes to a fixed set of nodes, which can be isolated from backend services.</span></span>

- <span data-ttu-id="da206-199">Стабильная конфигурация.</span><span class="sxs-lookup"><span data-stu-id="da206-199">Stable configuration.</span></span> <span data-ttu-id="da206-200">Если шлюз настроен неправильно, все приложение может стать недоступным.</span><span class="sxs-lookup"><span data-stu-id="da206-200">If the gateway is misconfigured, the entire application may become unavailable.</span></span> 

- <span data-ttu-id="da206-201">Производительность.</span><span class="sxs-lookup"><span data-stu-id="da206-201">Performance.</span></span> <span data-ttu-id="da206-202">Для шлюза можно использовать определенную конфигурацию виртуальной машины, чтобы увеличить производительность.</span><span class="sxs-lookup"><span data-stu-id="da206-202">You may want to use a specific VM configuration for the gateway for performance reasons.</span></span>

<!-- - Load balancing. You can configure the external load balancer so that requests always go to a gateway node. That can save a network hop, which would otherwise happen whenever a request lands on a node that isn't running a gateway pod. This consideration applies mainly to large clusters, where the gateway runs on a relatively small fraction of the total nodes. In Azure Container Service (ACS), this approach currently requires [ACS Engine](https://github.com/Azure/acs-engine)) which allows you to create multiple agent pools. Then you can deploy the gateway as a DaemonSet to the front-end pool. -->

### <a name="azure-application-gateway"></a><span data-ttu-id="da206-203">Шлюз приложений Azure</span><span class="sxs-lookup"><span data-stu-id="da206-203">Azure Application Gateway</span></span>

<span data-ttu-id="da206-204">Чтобы подключить шлюз приложений к кластеру Kubernetes в Azure, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="da206-204">To connect Application Gateway to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="da206-205">Создайте пустую подсеть в виртуальной сети кластера.</span><span class="sxs-lookup"><span data-stu-id="da206-205">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="da206-206">Разверните шлюз приложений.</span><span class="sxs-lookup"><span data-stu-id="da206-206">Deploy Application Gateway.</span></span>
3. <span data-ttu-id="da206-207">Создайте службу Kubernetes с типом [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport).</span><span class="sxs-lookup"><span data-stu-id="da206-207">Create a Kubernetes service with type=[NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport).</span></span> <span data-ttu-id="da206-208">Это обеспечивает доступ к службе на каждом узле, чтобы к ней можно было обращаться вне кластера.</span><span class="sxs-lookup"><span data-stu-id="da206-208">This exposes the service on each node so that it can be reached from outside the cluster.</span></span> <span data-ttu-id="da206-209">При этом подсистема балансировки нагрузки не создается.</span><span class="sxs-lookup"><span data-stu-id="da206-209">It does not create a load balancer.</span></span>
5. <span data-ttu-id="da206-210">Получите номер порта, назначенный для службы.</span><span class="sxs-lookup"><span data-stu-id="da206-210">Get the assigned port number for the service.</span></span>
6. <span data-ttu-id="da206-211">Добавьте правило шлюза приложений, где:</span><span class="sxs-lookup"><span data-stu-id="da206-211">Add an Application Gateway rule where:</span></span>
    - <span data-ttu-id="da206-212">внутренний пул содержит агент виртуальных машин;</span><span class="sxs-lookup"><span data-stu-id="da206-212">The backend pool contains the agent VMs.</span></span>
    - <span data-ttu-id="da206-213">параметр HTTP указывает номер порта службы;</span><span class="sxs-lookup"><span data-stu-id="da206-213">The HTTP setting specifies the service port number.</span></span>
    - <span data-ttu-id="da206-214">прослушиватель шлюза ожидает передачу данных на портах 80/443.</span><span class="sxs-lookup"><span data-stu-id="da206-214">The gateway listener listens on ports 80/443</span></span>
    
<span data-ttu-id="da206-215">Для обеспечения высокого уровня доступности создайте 2 или несколько экземпляров.</span><span class="sxs-lookup"><span data-stu-id="da206-215">Set the instance count to 2 or more for high availability.</span></span>

### <a name="azure-api-management"></a><span data-ttu-id="da206-216">Cлужба управления Azure API </span><span class="sxs-lookup"><span data-stu-id="da206-216">Azure API Management</span></span> 

<span data-ttu-id="da206-217">Чтобы подключить службу управления API к кластеру Kubernetes в Azure, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="da206-217">To connect API Management to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="da206-218">Создайте пустую подсеть в виртуальной сети кластера.</span><span class="sxs-lookup"><span data-stu-id="da206-218">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="da206-219">Разверните службу управления API в этой подсети.</span><span class="sxs-lookup"><span data-stu-id="da206-219">Deploy API Management to that subnet.</span></span>
3. <span data-ttu-id="da206-220">Создайте службу Kubernetes типа LoadBalancer.</span><span class="sxs-lookup"><span data-stu-id="da206-220">Create a Kubernetes service of type LoadBalancer.</span></span> <span data-ttu-id="da206-221">Используйте заметку [внутренняя подсистема балансировки нагрузки](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer), чтобы создать внутреннюю подсистему балансировки нагрузки вместо общедоступной, используемой по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="da206-221">Use the [internal load balancer](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer) annotation to create an internal load balancer, instead of an Internet-facing load balancer, which is the default.</span></span>
4. <span data-ttu-id="da206-222">Найдите частный IP-адрес внутренней подсистемы балансировки нагрузки с помощью kubectl или Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="da206-222">Find the private IP of the internal load balancer, using kubectl or the Azure CLI.</span></span>
5. <span data-ttu-id="da206-223">Используйте службу управления API для создания API, который направляет трафик на частный IP-адрес подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="da206-223">Use API Management to create an API that directs to the private IP address of the load balancer.</span></span>

<span data-ttu-id="da206-224">Попробуйте объединить службу управления API с обратным прокси-сервером, например Nginx, HAProxy или шлюзом приложений Azure.</span><span class="sxs-lookup"><span data-stu-id="da206-224">Consider combining API Management with a reverse proxy, whether Nginx, HAProxy, or Azure Application Gateway.</span></span> <span data-ttu-id="da206-225">Сведения об использовании службы управления API со шлюзом приложений см. в руководстве по [интеграции службы управления API во внутреннюю виртуальную сеть со шлюзом приложений](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway).</span><span class="sxs-lookup"><span data-stu-id="da206-225">For information about using API Management with Application Gateway, see [Integrate API Management in an internal VNET with Application Gateway](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway).</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="da206-226">Ведение журналов и мониторинг</span><span class="sxs-lookup"><span data-stu-id="da206-226">Logging and monitoring</span></span>](./logging-monitoring.md)
