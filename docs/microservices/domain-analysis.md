---
title: "Анализ предметной области для микрослужб"
description: "Анализ предметной области для микрослужб"
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: dc07c5195299c88a946accbe4e13a997afaaff90
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/29/2017
---
# <a name="designing-microservices-domain-analysis"></a>Проектирование микрослужб: анализ предметной области 

Одной из основных проблем, связанных с микрослужбами, является определение границ отдельных служб. Общее правило состоит в том, что служба должна выполнять что-то одно, но правильное применение этого правила требует тщательного планирования. Механического процесса, создающего "правильную" структуру, не существует. Необходимо подробно рассмотреть предметную отрасль, требования и цели вашего бизнеса. В противном случае можно столкнуться с непродуманной структурой, в которой есть некоторые нежелательные характеристики, такие как скрытые зависимости между службами, тесная взаимозависимость или плохо разработанные интерфейсы. В этой главе рассматривается проектирование микрослужб с использованием предметно-ориентированного подхода. 

Микрослужбы нужно разрабатывать с учетом бизнес-возможностей, а не горизонтальных слоев, таких как доступ к данным или обмен сообщениями. Кроме того, службы должны иметь слабую взаимозависимость и высокую функциональную слаженность. Микрослужбы *имеют слабую взаимозависимость*, если можно изменить одну службу без необходимости одновременного обновления других служб. Микрослужба считается *слаженной*, если у нее есть одна определенная цель, например управление учетными записями пользователей или отслеживание истории поставок. Служба должна содержать знания о предметной области и отделять эти знания от клиентов. Например, клиент должен иметь возможность запланировать полет дрона, не зная подробностей алгоритма планирования или управления парком дронов.

Предметно-ориентированное проектирование (DDD) предоставляет платформу, которая может помочь в разработке набора хорошо продуманных микрослужб. Этот алгоритм имеет два отдельных этапа: стратегический и тактический. На стратегическом этапе определяется масштабная структура системы. Этот этап помогает гарантировать, что архитектура ориентирована на бизнес-возможности. Тактический этап предоставляет набор конструктивных шаблонов, которые можно использовать для создания модели предметной области. Эти шаблоны включают в себя сущности, статистические выражения и службы предметных областей. Эти тактические шаблоны помогают создавать микрослужбы, имеющие слабую взаимозависимость и хорошую слаженность.

![](./images/ddd-process.png)

В этой и следующей главах мы рассмотрим приведенные ниже шаги, применяя их к приложению доставки с помощью дронов: 

1. Начните с анализа предметной области бизнеса, чтобы разобраться в функциональных требованиях приложения. В результате вы получите неформальное описание предметной области, которое можно разделить на более формальный набор моделей предметных областей. 

2. Затем определите *ограниченные контексты* предметной области. Каждый ограниченный контекст содержит модель предметной области, которая представляет определенную подобласть крупного приложения. 

3. В рамках ограниченного контекста примените тактические шаблоны DDD, чтобы определить сущности, статистические выражения и службы предметных областей. 
 
4. На основе результатов предыдущего шага идентифицируйте микрослужбы в своем приложении.

В этой главе мы рассмотрим первые три шага, которые в первую очередь касаются предметно-ориентированного проектирования. В следующей главе мы определим микрослужбы. Важно помнить, что предметно-ориентированное проектирование — это итеративный текущий процесс. Ограничения службы не зафиксированы. По мере развития приложения можно разбить службу на несколько небольших служб.

> [!NOTE]
> Эта глава не предназначена для демонстрации полного и исчерпывающего анализа предметной области. Мы намеренно приводим небольшой пример, чтобы продемонстрировать основные аспекты. Общие сведения о проблемно-ориентированном проектировании можно найти в *одноименной книге* Эрика Эванса (Eric Evans), в которой был впервые представлен этот термин. Другим хорошим справочником является книга Вона Вернона (Vaughn Vernon) *Реализация методов предметно-ориентированного проектирования*. 

## <a name="analyze-the-domain"></a>Анализ предметной области

Используя подход DDD, можно создавать микрослужбы так, чтобы каждая форма службы естественным образом совпадала с функциональным бизнес-требованием. Так вы сможете избежать ловушки, когда ограничения организации или технологии будут определять структуру.

Прежде чем написать код, необходимо иметь общее представление о создаваемой системе. DDD начинается с моделирования предметной области бизнеса и создания *ее модели*. Модель предметной области является абстрактной моделью предметной области бизнеса. Она извлекает и организует знания о предметной области, а также предоставляет общий язык для разработчиков и экспертов соответствующей сферы. 

Начните с составления схемы всех бизнес-функций и их связей. Это совместный процесс, в котором участвуют эксперты в соответствующей сфере, архитекторы ПО и другие заинтересованные лица. Какой-либо конкретный формализм использовать необязательно.  Нарисуйте схему на бумаге или доске.

Создавая схему, можно начать определять дискретные подобласти. Какие функции тесно связаны? Какие функции являются основными для бизнеса, а какие предоставляют вспомогательные службы? Что такое схема зависимостей? На начальном этапе технологии и подробности реализации не важны. Все же следует отметить место, где приложение нужно будет интегрировать с внешними системами, такими как CRM, система обработки оплаты или выставления счетов. 

## <a name="drone-delivery-analyzing-the-business-domain"></a>Доставка с помощью дронов: анализ предметной области бизнеса

После первоначального анализа предметной области команда Fabrikam создала приблизительный эскиз, представляющий предметную область "Доставка с помощью дронов".

![](./images/ddd1.svg) 

- Функция **Доставка** размещается в центре схемы, так как она является основной для бизнеса. Все остальное в схеме предназначено для обеспечения этой функции.
- **Управление дронами** также является ключевой бизнес-функцией. Функция, которая тесно связана с управлением дронами, включает **их ремонт** и использование **прогнозного анализа** для прогнозирования, когда дроны нуждаются в обслуживании. 
- **Анализ ETA** предоставляет оценки времени приема и доставки. 
- **Транспортировка сторонними лицами** позволяет приложению планировать другие способы транспортировки, если груз невозможно полностью отправить с помощью дрона.
- **Совместное использование дрона** является возможным расширением основной бизнес-функции. В определенные часы у компании может быть избыточное количество дронов, которые можно сдавать в аренду, чтобы они не простаивали. Этой возможности не будет в первоначальной версии.
- **Видеонаблюдение** является еще одной областью расширения деятельности для компании.
- **Учетные записи пользователей**, **Выставление счетов** и **Центр обработки вызовов** — это подобласти, используемые для поддержки основных бизнес-процессов.
 
Обратите внимание, что на этом этапе никаких решений о реализации и технологиях не принималось. Некоторые из подсистем могут включать внешние программные системы или сторонние службы. Тем не менее приложению необходимо взаимодействовать с этими системами и службами, поэтому важно включить их в модель предметной области. 

> [!NOTE]
> Если приложение зависит от внешней системы, есть риск, что может произойти утечка схемы данных внешней системы или API в приложение, что может скомпрометировать архитектурный проект. Это особенно верно в отношении устаревших систем, которые могут не следовать современным рекомендациям и могут использовать сложные схемы данных или устаревшие API. В этом случае важно иметь четко определенную границу между внешними системами и приложением. Рассмотрите возможность использования [шаблона подавления](../patterns/strangler.md) или [шаблона уровня защиты от повреждений](../patterns/anti-corruption-layer.md) для этой цели.

## <a name="define-bounded-contexts"></a>Определение ограниченных контекстов

Модель предметной области включает представления реальных вещей &mdash; пользователей, дронов, грузов и т. д. Однако это не значит, что каждая часть системы должна использовать одни и те же представления для одних и тех же вещей. 

Например, подсистемы, обрабатывающие ремонт дронов и прогнозную аналитику, должны представлять множество физических характеристик дронов, таких как история обслуживания, пробег, срок службы, номер модели, характеристики работы и т. д. Однако при планировании доставки это нам неинтересно. Подсистеме планирования необходимо знать, доступен ли дрон, а также предполагаемое время для приема и доставки (ETA). 

Если бы мы попытались создать единую модель для обеих этих подсистем, это было бы излишне сложным. С течением времени модель будет все сложнее видоизменять, так как любые изменения должны будут удовлетворять несколько команд, работающих над отдельными подсистемами. Поэтому зачастую лучше разрабатывать отдельные модели, которые представляют один и тот же объект реального мира (в данном случае дрон) в двух разных контекстах. Каждая модель содержит только те функции и атрибуты, которые имеют отношение к конкретному контексту.

Именно здесь вступает в действие концепция *ограниченных контекстов*, существующая в рамках предметно-ориентированного проектирования. Ограниченный контекст — это просто граница внутри предметной области, где применяется конкретная модель предметной области. Рассматривая предыдущую схему, можно группировать функции в зависимости от того, будут ли различные функции использовать одну модель предметной области. 

![](./images/ddd2.svg) 
 
Ограниченные контексты не обязательно изолировать друг от друга. На этой схеме сплошные линии, соединяющие ограниченные контексты, представляют места, где взаимодействуют два ограниченных контекста. Например, область "Доставка" зависит от области "Учетные записи пользователей" для получения информации о клиентах и от области "Управление дронами" для планирования полетов отдельных дронов.

В книге *Проблемно-ориентированное проектирование* Эрик Эванс описывает шаблоны по поддержке целостности модели предметной области при взаимодействии с другим ограниченным контекстом. Одним из основных принципов микрослужб является то, что службы обмениваются данными через четко определенные API. Этот подход соответствует двум шаблонам, которые Эванс называет открытой службой размещения и опубликованным языком. Идея открытой службы размещения заключается в том, что подсистема определяет формальный протокол (API), через который другие подсистемы могут взаимодействовать с ней. Опубликованный язык расширяет эту идею, публикуя API в форме, которую другие команды могут использовать для написания клиентов. В главе, посвященной [созданию API](./api-design.md), мы обсудим использование [спецификации OpenAPI](https://www.openapis.org/specification/repo) (ранее известной как Swagger) для определения описаний зависящего от языка интерфейса для REST API, выраженных в формате JSON или YAML.

В оставшейся части этого руководства мы сконцентрируемся на ограниченном контексте доставки. 

## <a name="tactical-ddd"></a>Тактическое предметно-ориентированное проектирование

На стратегическом этапе предметно-ориентированного проектирования составляется схема предметной области бизнеса и определяются ограниченные контексты для модели предметной области. На тактическом этапе модели предметной области определяются с более высокой точностью. Тактические шаблоны применяются в рамках одного ограниченного контекста. В архитектуре микрослужб нас особенно интересуют шаблоны статистических выражений и сущностей. Применение этих шаблонов помогает определить естественные границы служб в приложении (см. в [следующей главе](./microservice-boundaries.md)). Как правило, микрослужба должна быть не меньше статистического выражения и не больше ограниченного контекста. Сначала рассмотрим тактические шаблоны. Затем мы применим их к ограниченному контексту доставки в приложении доставки с помощью дронов. 

### <a name="overview-of-the-tactical-patterns"></a>Общие сведения о тактических шаблонах

Этот раздел содержит краткую сводку тактических шаблонов DDD. Так что, если вы уже знакомы с ними, можете переходить к следующему разделу. Более подробно шаблоны описаны в главах 5&ndash;6 книги Эрика Эванса и в книге Вона Вернона *Реализация методов предметно-ориентированного проектирования*. 

![](./images/ddd-patterns.png)

**Сущности**. Сущность представляет собой объект с уникальным идентификатором, который сохраняется с течением времени. Например, в банковском приложении клиенты и учетные записи выступают сущностями. 

- У сущности в системе есть уникальный идентификатор, который может использоваться для поиска или извлечения объекта. Это не означает, что идентификатор всегда предоставляется пользователям напрямую. Это может быть GUID или первичный ключ в базе данных. 
- Идентификатор может охватывать несколько ограниченных контекстов. Срок его действия может превышать время существования приложения. Например, номера банковских счетов или идентификаторы, выданные правительством, не привязаны к времени существования конкретного приложения.
- Атрибуты сущности могут изменяться со временем. Например, имя или адрес пользователя могут измениться, но сущность останется одной и той же. 
- Сущность может содержать ссылки на другие сущности.
 
**Объекты-значения**. Объект-значение не имеет идентификатора. Он определяется только значениями его атрибутов. Объекты-значения также являются неизменяемыми. Чтобы обновить объект-значение, всегда создавайте новый экземпляр для замены старого. Объекты-значения могут иметь методы, которые внедряют логику предметной области, но эти методы не должны иметь побочных эффектов для состояния объекта. К самым распространенным примерам объектов-значений относятся цвета, даты и время, а также значения валюты. 

**Статистические выражения**. Статистическое выражение определяет границу согласованности одной или нескольких сущностей. Одна сущность в статистическом выражении является корневой. Поиск выполняется по идентификатору корневой сущности. Любые другие сущности в статистическом выражении являются дочерними элементами корневой сущности, на которые ссылаются следующие указатели корневой сущности. 

Статистические выражения предназначены для моделирования транзакционных инвариантов. Вещи в реальном мире имеют сложные сети связей. Клиенты размещают заказы, заказы содержат продукты, продукты поставляются поставщиками и т. д. Если приложение изменяет несколько связанных объектов, как оно гарантирует согласованность? Как отслеживать инварианты и применять их?  

Традиционные приложения часто используют транзакции базы данных для обеспечения согласованности. Однако в распределенном приложении это, как правило, нецелесообразно. Одна бизнес-транзакция может охватывать несколько хранилищ данных, долго выполняться или включать сторонние службы. В конечном итоге обеспечение требуемых для предметной области инвариантов зависит от приложения, а не от уровня данных. Вот что должны моделировать статистические выражения.

> [!NOTE]
> Статистическое выражение может состоять из одной сущности без каких-либо дочерних сущностей. Этот объект является статистическим выражением благодаря транзакционной границе.

**Службы предметных областей и службы приложений**. В терминологии DDD служба является объектом, который реализует логику без удержания какого-либо состояния. Эванс различает *службы предметных областей*, которые содержат логику предметной области, и *службы приложений*, которые предоставляют технические функциональные возможности, такие как проверка подлинности пользователя или отправка текстового сообщения. Службы предметных областей часто используются для моделирования реакции на событие, охватывающей несколько сущностей. 

> [!NOTE]
> Термин *служба* перегружен в разработке программного обеспечения. Приведенное здесь определение не связано непосредственно с микрослужбами.

**События предметной области**. События предметной области могут использоваться для уведомления других частей системы, когда происходит событие. Как следует из названия, события предметной области должны означать что-то внутри предметной области. Например, "в таблицу вставлена запись" не является событием предметной области. "Доставка отменена" — пример события предметной области. События предметной области особенно важны в архитектуре микрослужб. Так как микрослужбы распределены и не имеют общих хранилищ данных, события предметной области предоставляют микрослужбам способ координации друг с другом. В главе об [обмене данными между службами](./interservice-communication.md) более подробно рассматривается асинхронный обмен сообщениями.
 
Есть также несколько других шаблонов DDD, которые не перечислены здесь, включая фабрики, репозитории и модули. Эти шаблоны могут быть полезны при реализации микрослужбы, однако они менее актуальны при разработке границ между микрослужбами.

## <a name="drone-delivery-applying-the-patterns"></a>Доставка с помощью дронов: применение шаблонов

Мы начнем со сценариев, которые должен обрабатывать ограниченный контекст доставки.

- Клиент может запросить дрон, чтобы быстро принять товар у компании, зарегистрированной в службе доставки с помощью дронов.
- Отправитель создает тег (штрихкод или RFID) для размещения на грузе. 
- Дрон примет и доставит груз из исходного расположения в целевое.
- Когда клиент планирует доставку, система выдает предполагаемое время приема и доставки на основе информации о маршруте, погодных условиях и исторических данных. 
- Когда дрон в пути, пользователь может отслеживать его расположение и последнее ETA. 
- Пока дрон не получил груз, клиент может отменить доставку.
- Клиент уведомляется о завершении доставки.
- Отправитель может запросить подтверждение от клиента в форме подписи или отпечатка пальца.
- Пользователи могут просмотреть историю завершенной доставки.

В этих сценариях команды разработки определили следующие **сущности**:

- доставка;
- Package
- дрон;
- Учетная запись.
- Подтверждение
- Уведомление
- Тег

Первые четыре сущности (доставка, груз, дрон и учетная запись) являются **статистическими выражениями**, которые представляют границы согласованности транзакций. Подтверждения и уведомления являются дочерними сущностями доставки, а теги — дочерними сущностями грузов. 

**Объекты-значения** в этом проекте включают расположение, ETA, вес и размер груза. 

Для демонстрации ниже приведена схема UML статистического выражения доставки. Обратите внимание, что оно содержит ссылки на другие статистические выражения, включая учетную запись, груз и дрон.

![](./images/delivery-entity.png)

Есть два события предметной области:

- когда дрон выполняет доставку, одноименная сущность отправляет события DroneStatus (состояние дрона), которые описывают его расположение и состояние (в пути, приземлился);

- сущность доставки отправляет события DeliveryTracking при каждом изменении этапа доставки. К ним относятся DeliveryCreated (доставка создана), DeliveryRescheduled (доставка перепланирована), DeliveryHeadedToDropoff (груз направляется в конечный пункт) и DeliveryCompleted (доставка завершена). 

Обратите внимание, что эти события описывают вещи, которые важны в модели предметной области. Они описывают что-то о предметной области и не привязаны к конкретной конструкции языка программирования.

Команда разработчиков определила еще одну область функций, которая не соответствует полностью ни одной из уже описанных сущностей. Некоторая часть системы должна координировать все шаги, связанные с планированием или обновлением доставки. Таким образом, команда разработчиков добавляет две **службы предметных областей** в проект: *планировщик*, управляющий действиями, и *контролер*, отслеживающий состояние каждого шага, чтобы определить, есть ли шаги, которые завершились со сбоем и в каких истекло время ожидания. Это разновидность [шаблона "планировщик, агент, контролер"](../patterns/scheduler-agent-supervisor.md).

![](./images/drone-ddd.png)

> [!div class="nextstepaction"]
> [Определение границ микрослужбы](./microservice-boundaries.md)
