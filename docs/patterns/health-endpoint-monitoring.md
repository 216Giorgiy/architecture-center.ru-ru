---
title: Мониторинг конечных точек работоспособности
description: Внедрение в приложение функциональных проверок, к которым внешние средства могут регулярно получать доступ через предоставленные конечные точки.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- availability
- management-monitoring
- resiliency
ms.openlocfilehash: 3b3bce46b460148af17bfe6064cd052a5f9a6458
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="health-endpoint-monitoring-pattern"></a>Шаблон мониторинга конечных точек работоспособности

[!INCLUDE [header](../_includes/header.md)]

Внедрение в приложение функциональных проверок, к которым внешние средства могут регулярно получать доступ через предоставленные конечные точки. Это позволяет проверить правильность работы приложений и служб.

## <a name="context-and-problem"></a>Контекст и проблема

Мониторинг веб-приложений и служб для отслеживания их доступности и выполнения не только является рекомендуемым действием. Также эта процедура часто включена в список бизнес-требований. При этом мониторинг для облачных служб организовать сложнее, чем для локальных. Помимо прочего, у вас нет полного контроля над средой размещения, и службы часто зависят от других служб, предоставляемых поставщиками платформы и другими поставщиками.

На работу облачных приложений влияет множество факторов, например задержки сети, производительность и доступность базовых систем вычислений и хранения и пропускная способность сети между ними. Любой из этих факторов может привести к полному или частичному отказу службы. Поэтому вам следует регулярно проверять, что служба работает правильно, чтобы обеспечить требуемый уровень доступности в рамках соглашении об уровне обслуживания.

## <a name="solution"></a>Решение

Реализуйте мониторинг работоспособности, отправляя запросы к конечной точке в приложении. Приложение самостоятельно выполняет необходимые проверки и извещает о состоянии своей работоспособности.

Обычно проверка работоспособности выполняется по двум направлениям:

- Приложение или служба выполняет проверки (если возможно) в ответ на запрос к конечной точке проверки работоспособности.
- Результаты проверок передаются для анализа в специальное средство или платформу.

Код ответа содержит сведения о состоянии приложения и, возможно, используемых им компонентов и (или) служб. Проверка задержки или времени ответа выполняется средством или платформой наблюдения. На рисунке ниже представлена схема этого шаблона.

![Общая схема шаблона](./_images/health-endpoint-monitoring-pattern.png)

Код проверки работоспособности, внедряемый в приложение, может выполнять и дополнительные проверки:
- проверку доступности и времени ответа для облачного хранилища или базы данных;
- проверку других ресурсов и служб, которые размещены вместе с этим приложением или используются им.

Существуют разные службы и средства для мониторинга веб-приложений. Они отправляют запросы к указанным конечным точкам и оценивают полученные результаты по набору настраиваемых правил. Вы можете достаточно легко создать конечную точку службы, которая предназначена только для выполнения функциональных тестов в системе.

Такие средства мониторинга часто выполняют следующие типы проверок:

- Проверка кода ответа. Например, ответ HTTP 200 (ОК) означает, что приложение выполнено без ошибок. Система отслеживания может проверять и другие коды ответов, чтобы получить более полные результаты.
- Проверка содержимого ответа для выявления ошибок, даже если возвращается код состояния 200 (ОК). Это позволит обнаружить ошибки, которые влияют только на часть возвращенной веб-страницы или ответа службы. Например, можно проверять заголовок страницы или наличие некоторой фразы, которая подтверждает правильность полученной страницы.
- Измерение времени отклика, которое определяется сочетанием сетевых задержек и скорости обработки запроса в приложении. Если это значение увеличивается, это может указывать на развитие проблем в приложении или сети.
- Проверка ресурсов или служб, расположенных отдельно от приложения, например сети доставки содержимого, через которую приложение получает содержимое из глобального кэша.
- Проверка срока действия SSL-сертификатов.
- Измерение времени отклика при получении URL-адреса приложения от DNS-сервера, что позволяет оценить задержку и наличие ошибок в службе DNS.
- Проверка URL-адреса, полученного от DNS-сервера, что позволяет контролировать правильность данных. Это поможет избежать вредоносного перенаправления запросов в случае успешной атаки на DNS-сервер.

По возможности такие проверки следует выполнять из разных локальных сред и служб размещения, чтобы оценивать и сравнивать времена отклика для разных расположений. Лучше всего, если мониторинг приложений выполняется из расположений, близких к расположению реальных клиентов, что позволит получить адекватное представление о реальной производительности для этих расположений. В этом случае результаты проверки будут более надежными и помогут принять решения о том, где лучше расположить развертывание и нужно ли использовать дополнительный центр обработки данных.

Проверки следует выполнять для всех экземпляров службы, которые используют клиенты, чтобы убедиться в правильности работы приложения для всех клиентов. Например, если клиентское хранилище размещено в нескольких учетных записях хранения, процесс мониторинга должен проверять их все.

## <a name="issues-and-considerations"></a>Проблемы и рекомендации

При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.

Правильная интерпретация ответа. Например, достаточно ли проверить наличие кода состояния 200 (ОК), чтобы считать, что приложение работает правильно? Конечно же, это основная оценка доступности приложения, минимально необходимая для реализации этого шаблона, но она предоставляет мало информации об операциях, тенденциях и возможных неполадках в приложении.

   >  Сделайте так, чтобы приложение возвращало код 200 (ОК) только в том случае, когда целевой ресурс обнаружен и правильно обработан. В некоторых сценариях, например при использовании эталонной страницы для размещения целевой веб-страницы, сервер возвращает код состояния 200 (ОК) вместо 404 (не найдено) при отсутствии целевой страницы содержимого.

Количество конечных точек, которые нужно создать для приложения. Один из возможных подходов заключается в том, чтобы предоставить не меньше двух конечных точек: одну для основных служб приложения, а другую для менее приоритетных служб. Так вы сможете назначить разные уровни важности разным результатам мониторинга. Вы можете предоставить больше конечных точек, например по одной для каждой базовой службы, чтобы повысить степень детализации мониторинга. Например, проверка работоспособности может включать проверку базы данных, хранилища и внешней службы геокодирования, используемой приложением, и для каждой из этих служб установлены разные требования к времени работы и времени отклика. Приложение сохранит работоспособность, если служба геокодирования или другая фоновая задача станут недоступны на несколько минут.

Использование для мониторинга ту же конечную точку, что и для общего доступа, создав в ней отдельный путь (например, /HealthCheck/{GUID}/) для проверки работоспособности. Это позволит средствам мониторинга выполнять в приложении функциональные тесты, например добавлять учетные записи, выполнять вход с учетными данными и размещать тестовые заказы, одновременно с проверкой доступности конечной точки.

Тип данных, которые служба будет получать в ответ на запрос мониторинга, и методы выдачи этих сведений. Большинство существующих средств и платформ оценивают только код состояния HTTP, полученный от конечной точки. Чтобы получить и проверить дополнительную информацию, вам придется создать собственную программу или службу мониторинга.

Объем собираемых сведений. Чрезмерный объем обработки при выполнении проверок приведет к перегрузке приложения и повлияет на работу пользователей. Для такой обработки может потребоваться больше времени, чем ожидает система мониторинга, и тогда приложение будет отмечено как недоступное. В большинстве приложений реализовано специальное инструментирование для обработки ошибок и оценки производительности, которые ведут журналы производительности и сохраняют подробные сведения об ошибках. Возможно, есть смысл просто возвращать эти сведения, а не выполнять дополнительный сбор данных для проверки работоспособности.

Кэширование состояния конечной точки. Слишком частый запуск проверки работоспособности может расходовать много ресурсов. Например, если состояние работоспособности отображается на панели мониторинга, вы вряд ли захотите запускать новую проверку работоспособности в ответ на любое действие на панели мониторинга. Проводите проверки через определенные промежутки времени и сохраняйте сведения о результатах. Создайте конечную точку, которая возвращает сохраненное (кэшированное) состояние.

Защита конечных точек мониторинга от несанкционированного доступа, чтобы предотвратить атаки злоумышленников на приложение, снизить риск раскрытия конфиденциальных сведений или атак отказа в обслуживании (DoS). Обычно защита реализуется в конфигурации приложения, чтобы ее уровень можно было легко изменить без перезапуска приложения. Постарайтесь применить хотя бы одну из следующих методик:

- Включите требование выполнять аутентификацию для доступа к конечной точке. Для этого можно передавать в заголовке запроса ключ аутентификации или включать в запрос учетные данные, если служба или средство мониторинга поддерживает аутентификацию.

  - Используйте замаскированные или скрытые конечные точки. Например, конечную точку можно разместить на другом IP-адресе, который недоступен через URL-адрес приложения по умолчанию. Можно использовать нестандартный порт HTTP и (или) сложный путь к тестовой странице. Адреса и порты конечных точек можно указать в конфигурации приложения, а если вы не хотите напрямую указывать IP-адреса — добавьте записи для этих конечных точек на DNS-сервер.

  - Предоставьте на конечной точке метод, который принимает определенный параметр, например значение ключа или режима операции. В зависимости от значения этого параметра в полученном запросе код будет выполнять определенный тест или несколько тестов, а если значение параметра не соответствует условиям — возвращать ошибку 404 (не найдено). Допустимые значения таких параметров можно включить в конфигурацию приложения.

     >  DoS-атаки будут меньше влиять на работу конечной точки, которая выполняет базовые функциональных тестов, не нарушая работу приложения. Избегайте таких тестов, которые могут раскрыть конфиденциальные сведения. Если необходимо возвращать сведения, которые могут быть полезными для злоумышленника, подумайте о защите конечной точки и ее данных от несанкционированного доступа. В этом случае нельзя надеяться только на маскировку. Можно также применить HTTPS-соединение и шифрование конфиденциальных данных, но это увеличит нагрузку на сервер.

- Настройте доступ к конечной точке, защищенной с помощью аутентификации. Не все инструменты и платформы позволяют указать учетные данные для запросов проверки работоспособности. Например, встроенная функция проверки работоспособности в Microsoft Azure не поддерживает передачу данных для аутентификации. Можно использовать некоторые сторонние реализации, например [Pingdom](https://www.pingdom.com/), [Panopta](http://www.panopta.com/), [NewRelic](https://newrelic.com/) или [Statuscake](https://www.statuscake.com/).

- Убедитесь в правильности работы агента мониторинга. Для тестирования агента можно предоставить отдельную конечную точку, которая будет возвращать некоторое значение, указанное в конфигурации приложения, или случайное значение.

   >  Можно также настроить систему мониторинга на выполнение внутренних проверок (встроенных проверок, самопроверок и т. п.), чтобы избежать ложных срабатываний.

## <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

Этот шаблон можно использовать для следующих целей:
- мониторинга доступности для веб-сайтов и веб-приложений;
- мониторинга правильности работы веб-сайтов и веб-приложений;
- мониторинга служб среднего уровня или общих служб для выявления ошибок, которые могут нарушить работу других приложений;
- дополнения существующих в приложении средств инструментирования, таких как счетчики производительности и обработчики ошибок. Проверка работоспособности не отменяет необходимость вести журналы и выполнять аудит в приложении. Инструментирование может передавать важную информацию в платформу, которая контролирует счетчики и журналы ошибок для поиска ошибок или других проблем. Но эти сведения не удастся получить, если приложение недоступно.

## <a name="example"></a>Пример

В следующем примере кода из класса `HealthCheckController` (пример, демонстрирующий этот шаблон, размещен в репозитории [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring)) конечная точка предоставляется для нескольких проверок работоспособности.

Представленный ниже метод `CoreServices` на языке C# выполняет серию проверок для используемых в приложении служб. Если все тесты выполняются без ошибок, метод возвращает код состояния 200 (ОК). Если любой из тестов вызывает исключение, метод возвращает код состояния 500 (внутренняя ошибка). Этот метод может предоставлять при возникновении ошибки дополнительную информацию, если средство или платформа мониторинга умеют ее использовать.

```csharp
public ActionResult CoreServices()
{
  try
  {
    // Run a simple check to ensure the database is available.
    DataStore.Instance.CoreHealthCheck();

    // Run a simple check on our external service.
    MyExternalService.Instance.CoreHealthCheck();
  }
  catch (Exception ex)
  {
    Trace.TraceError("Exception in basic health check: {0}", ex.Message);

    // This can optionally return different status codes based on the exception.
    // Optionally it could return more details about the exception.
    // The additional information could be used by administrators who access the
    // endpoint with a browser, or using a ping utility that can display the
    // additional information.
    return new HttpStatusCodeResult((int)HttpStatusCode.InternalServerError);
  }
  return new HttpStatusCodeResult((int)HttpStatusCode.OK);
}
```
Метод `ObscurePath` демонстрирует, как получить путь из конфигурации приложения и использовать его для создания конечной точки тестов. Также в этом примере на языке C# демонстрируется, как получить из параметра запроса значение идентификатора и проверить его допустимость.

```csharp
public ActionResult ObscurePath(string id)
{
  // The id could be used as a simple way to obscure or hide the endpoint.
  // The id to match could be retrieved from configuration and, if matched,
  // perform a specific set of tests and return the result. If not matched it
  // could return a 404 (Not Found) status.

  // The obscure path can be set through configuration to hide the endpoint.
  var hiddenPathKey = CloudConfigurationManager.GetSetting("Test.ObscurePath");

  // If the value passed does not match that in configuration, return 404 (Not Found).
  if (!string.Equals(id, hiddenPathKey))
  {
    return new HttpStatusCodeResult((int)HttpStatusCode.NotFound);
  }

  // Else continue and run the tests...
  // Return results from the core services test.
  return this.CoreServices();
}
```

Метод `TestResponseFromConfig` показывает, как предоставить конечную точку, которая выполняет проверку указанного параметра конфигурации.

```csharp
public ActionResult TestResponseFromConfig()
{
  // Health check that returns a response code set in configuration for testing.
  var returnStatusCodeSetting = CloudConfigurationManager.GetSetting(
                                                          "Test.ReturnStatusCode");

  int returnStatusCode;

  if (!int.TryParse(returnStatusCodeSetting, out returnStatusCode))
  {
    returnStatusCode = (int)HttpStatusCode.OK;
  }

  return new HttpStatusCodeResult(returnStatusCode);
}
```
## <a name="monitoring-endpoints-in-azure-hosted-applications"></a>Конечные точки мониторинга в приложениях на платформе Azure

Чтобы использовать конечные точки мониторинга в приложениях Azure, есть несколько доступных методов:

- использование встроенных функций мониторинга Azure;

- использование служб или платформ сторонних разработчиков, например Microsoft System Center Operations Manager;

- создание собственной программы или службы, которая выполняется в локальной среде или на размещенном сервере.

   >  Хотя Azure предоставляет достаточно широкий набор возможностей для мониторинга, вы всегда можете получить дополнительные сведения с помощью дополнительных служб и (или) средств. Службы управления Azure предлагают встроенный механизм мониторинга для правил генерации оповещений. Раздел предупреждений на странице служб управления на портале Azure позволяет настроить для ваших служб до десяти правил генерации оповещений. В этих правилах можно задать условие и пороговое значение для службы, например предельную загрузку ЦП или максимальное число запросов или ошибок в секунду. Служба будет автоматически отправлять уведомления по электронной почте на адреса, указанные в каждом правиле.

Условия для мониторинга будут разными в зависимости от механизма размещения, выбранного для приложения (веб-сайты, облачные службы, виртуальные машины или мобильные службы), но все они позволяют создать правило оповещения на основе конечной точки, указанной в параметрах соответствующей службы. Эта конечная точка должна отвечать быстро, чтобы система предупреждений считала работу приложения правильной.

>  Дополнительные сведения о создании уведомлений см. [здесь][portal-alerts].

Если приложение размещено на виртуальных машинах, в веб-ролях или рабочих ролях облачной службы Azure, вы можете использовать встроенные службы Azure, которые называются диспетчер трафика Azure. Диспетчер трафика — это служба маршрутизации и балансировки нагрузки, которая распределяет запросы между определенными экземплярами приложения, размещенного в облачной службе, используя определенный набор правил и параметров.

Диспетчер трафика помимо маршрутизации запросов регулярно проверяет связь, используя указанные в настройках URL-адрес, порт и относительный путь, чтобы контролировать работоспособность каждого экземпляра приложения, указанного в правилах. Если он получает в ответ состояние 200 (ОК), приложение считается доступным. Получив любой другой код состояния, диспетчер трафика отмечает приложение как неработоспособное. В консоли диспетчера трафика вы можете просмотреть эти состояния и настроить правила для перенаправления запросов к другим, активным экземплярам приложения.

Однако, диспетчер трафика при мониторинге URL-адреса ожидает ответ всего десять секунд. Это означает, что ваш код подтверждения работоспособности должен выполняться быстрее этого времени, учитывая также задержку кругового пути при передаче информации от диспетчера трафика к приложению и обратно.

>  Дополнительные сведения об использовании диспетчера трафика для мониторинга приложений см. [здесь](https://azure.microsoft.com/documentation/services/traffic-manager/). Диспетчер трафика обсуждается также в статье [Multiple Datacenter Deployment Guidance](https://msdn.microsoft.com/library/dn589779.aspx) (Руководство по развертыванию в нескольких центрах обработки данных).

## <a name="related-guidance"></a>Связанные руководства

Следующие руководства также могут быть полезными при реализации этого шаблона.
- [Руководство по инструментированию и телеметрии.](https://msdn.microsoft.com/library/dn589775.aspx) Для проверки работоспособности служб и компонентов обычно используется тестовый запрос, но полезно будет и наблюдать за производительностью приложения и отслеживать события, происходящие во время выполнения. Эти данные можно передавать в средства мониторинга в качестве дополнительных сведений о работоспособности. Руководство по инструментированию и телеметрии описывает, как собирать сведения удаленной диагностики от средств инструментирования в приложениях.
- [Создание оповещений метрик в Azure Monitor для служб Azure с помощью портала Azure][portal-alerts].
- Этот шаблон содержит доступный для скачивания [пример приложения](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring).

[portal-alerts]: https://azure.microsoft.com/documentation/articles/insights-receive-alert-notifications/
