---
title: Шаблон мониторинга конечных точек работоспособности
titleSuffix: Cloud Design Patterns
description: Внедрение в приложение функциональных проверок, к которым внешние средства могут регулярно получать доступ через предоставленные конечные точки.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 475b9572cb5b34850944fdf03061dc56ea6d0bf9
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54485151"
---
# <a name="health-endpoint-monitoring-pattern"></a><span data-ttu-id="4f09a-104">Шаблон мониторинга конечных точек работоспособности</span><span class="sxs-lookup"><span data-stu-id="4f09a-104">Health Endpoint Monitoring pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="4f09a-105">Внедрение в приложение функциональных проверок, к которым внешние средства могут регулярно получать доступ через предоставленные конечные точки.</span><span class="sxs-lookup"><span data-stu-id="4f09a-105">Implement functional checks in an application that external tools can access through exposed endpoints at regular intervals.</span></span> <span data-ttu-id="4f09a-106">Это позволяет проверить правильность работы приложений и служб.</span><span class="sxs-lookup"><span data-stu-id="4f09a-106">This can help to verify that applications and services are performing correctly.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="4f09a-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="4f09a-107">Context and problem</span></span>

<span data-ttu-id="4f09a-108">Мониторинг веб-приложений и служб для отслеживания их доступности и выполнения не только является рекомендуемым действием. Также эта процедура часто включена в список бизнес-требований.</span><span class="sxs-lookup"><span data-stu-id="4f09a-108">It's a good practice, and often a business requirement, to monitor web applications and back-end services, to ensure they're available and performing correctly.</span></span> <span data-ttu-id="4f09a-109">При этом мониторинг для облачных служб организовать сложнее, чем для локальных.</span><span class="sxs-lookup"><span data-stu-id="4f09a-109">However, it's more difficult to monitor services running in the cloud than it is to monitor on-premises services.</span></span> <span data-ttu-id="4f09a-110">Помимо прочего, у вас нет полного контроля над средой размещения, и службы часто зависят от других служб, предоставляемых поставщиками платформы и другими поставщиками.</span><span class="sxs-lookup"><span data-stu-id="4f09a-110">For example, you don't have full control of the hosting environment, and the services typically depend on other services provided by platform vendors and others.</span></span>

<span data-ttu-id="4f09a-111">На работу облачных приложений влияет множество факторов, например задержки сети, производительность и доступность базовых систем вычислений и хранения и пропускная способность сети между ними.</span><span class="sxs-lookup"><span data-stu-id="4f09a-111">There are many factors that affect cloud-hosted applications such as network latency, the performance and availability of the underlying compute and storage systems, and the network bandwidth between them.</span></span> <span data-ttu-id="4f09a-112">Любой из этих факторов может привести к полному или частичному отказу службы.</span><span class="sxs-lookup"><span data-stu-id="4f09a-112">The service can fail entirely or partially due to any of these factors.</span></span> <span data-ttu-id="4f09a-113">Поэтому вам следует регулярно проверять, что служба работает правильно, чтобы обеспечить требуемый уровень доступности в рамках соглашении об уровне обслуживания.</span><span class="sxs-lookup"><span data-stu-id="4f09a-113">Therefore, you must verify at regular intervals that the service is performing correctly to ensure the required level of availability, which might be part of your service level agreement (SLA).</span></span>

## <a name="solution"></a><span data-ttu-id="4f09a-114">Решение</span><span class="sxs-lookup"><span data-stu-id="4f09a-114">Solution</span></span>

<span data-ttu-id="4f09a-115">Реализуйте мониторинг работоспособности, отправляя запросы к конечной точке в приложении.</span><span class="sxs-lookup"><span data-stu-id="4f09a-115">Implement health monitoring by sending requests to an endpoint on the application.</span></span> <span data-ttu-id="4f09a-116">Приложение самостоятельно выполняет необходимые проверки и извещает о состоянии своей работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-116">The application should perform the necessary checks, and return an indication of its status.</span></span>

<span data-ttu-id="4f09a-117">Обычно проверка работоспособности выполняется по двум направлениям:</span><span class="sxs-lookup"><span data-stu-id="4f09a-117">A health monitoring check typically combines two factors:</span></span>

- <span data-ttu-id="4f09a-118">Приложение или служба выполняет проверки (если возможно) в ответ на запрос к конечной точке проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-118">The checks (if any) performed by the application or service in response to the request to the health verification endpoint.</span></span>
- <span data-ttu-id="4f09a-119">Результаты проверок передаются для анализа в специальное средство или платформу.</span><span class="sxs-lookup"><span data-stu-id="4f09a-119">Analysis of the results by the tool or framework that performs the health verification check.</span></span>

<span data-ttu-id="4f09a-120">Код ответа содержит сведения о состоянии приложения и, возможно, используемых им компонентов и (или) служб.</span><span class="sxs-lookup"><span data-stu-id="4f09a-120">The response code indicates the status of the application and, optionally, any components or services it uses.</span></span> <span data-ttu-id="4f09a-121">Проверка задержки или времени ответа выполняется средством или платформой наблюдения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-121">The latency or response time check is performed by the monitoring tool or framework.</span></span> <span data-ttu-id="4f09a-122">На рисунке ниже представлена схема этого шаблона.</span><span class="sxs-lookup"><span data-stu-id="4f09a-122">The figure provides an overview of the pattern.</span></span>

![Общая схема шаблона](./_images/health-endpoint-monitoring-pattern.png)

<span data-ttu-id="4f09a-124">Код проверки работоспособности, внедряемый в приложение, может выполнять и дополнительные проверки:</span><span class="sxs-lookup"><span data-stu-id="4f09a-124">Other checks that might be carried out by the health monitoring code in the application include:</span></span>

- <span data-ttu-id="4f09a-125">проверку доступности и времени ответа для облачного хранилища или базы данных;</span><span class="sxs-lookup"><span data-stu-id="4f09a-125">Checking cloud storage or a database for availability and response time.</span></span>
- <span data-ttu-id="4f09a-126">проверку других ресурсов и служб, которые размещены вместе с этим приложением или используются им.</span><span class="sxs-lookup"><span data-stu-id="4f09a-126">Checking other resources or services located in the application, or located elsewhere but used by the application.</span></span>

<span data-ttu-id="4f09a-127">Существуют разные службы и средства для мониторинга веб-приложений. Они отправляют запросы к указанным конечным точкам и оценивают полученные результаты по набору настраиваемых правил.</span><span class="sxs-lookup"><span data-stu-id="4f09a-127">Services and tools are available that monitor web applications by submitting a request to a configurable set of endpoints, and evaluating the results against a set of configurable rules.</span></span> <span data-ttu-id="4f09a-128">Вы можете достаточно легко создать конечную точку службы, которая предназначена только для выполнения функциональных тестов в системе.</span><span class="sxs-lookup"><span data-stu-id="4f09a-128">It's relatively easy to create a service endpoint whose sole purpose is to perform some functional tests on the system.</span></span>

<span data-ttu-id="4f09a-129">Такие средства мониторинга часто выполняют следующие типы проверок:</span><span class="sxs-lookup"><span data-stu-id="4f09a-129">Typical checks that can be performed by the monitoring tools include:</span></span>

- <span data-ttu-id="4f09a-130">Проверка кода ответа.</span><span class="sxs-lookup"><span data-stu-id="4f09a-130">Validating the response code.</span></span> <span data-ttu-id="4f09a-131">Например, ответ HTTP 200 (ОК) означает, что приложение выполнено без ошибок.</span><span class="sxs-lookup"><span data-stu-id="4f09a-131">For example, an HTTP response of 200 (OK) indicates that the application responded without error.</span></span> <span data-ttu-id="4f09a-132">Система отслеживания может проверять и другие коды ответов, чтобы получить более полные результаты.</span><span class="sxs-lookup"><span data-stu-id="4f09a-132">The monitoring system might also check for other response codes to give more comprehensive results.</span></span>
- <span data-ttu-id="4f09a-133">Проверка содержимого ответа для выявления ошибок, даже если возвращается код состояния 200 (ОК).</span><span class="sxs-lookup"><span data-stu-id="4f09a-133">Checking the content of the response to detect errors, even when a 200 (OK) status code is returned.</span></span> <span data-ttu-id="4f09a-134">Это позволит обнаружить ошибки, которые влияют только на часть возвращенной веб-страницы или ответа службы.</span><span class="sxs-lookup"><span data-stu-id="4f09a-134">This can detect errors that affect only a section of the returned web page or service response.</span></span> <span data-ttu-id="4f09a-135">Например, можно проверять заголовок страницы или наличие некоторой фразы, которая подтверждает правильность полученной страницы.</span><span class="sxs-lookup"><span data-stu-id="4f09a-135">For example, checking the title of a page or looking for a specific phrase that indicates the correct page was returned.</span></span>
- <span data-ttu-id="4f09a-136">Измерение времени отклика, которое определяется сочетанием сетевых задержек и скорости обработки запроса в приложении.</span><span class="sxs-lookup"><span data-stu-id="4f09a-136">Measuring the response time, which indicates a combination of the network latency and the time that the application took to execute the request.</span></span> <span data-ttu-id="4f09a-137">Если это значение увеличивается, это может указывать на развитие проблем в приложении или сети.</span><span class="sxs-lookup"><span data-stu-id="4f09a-137">An increasing value can indicate an emerging problem with the application or network.</span></span>
- <span data-ttu-id="4f09a-138">Проверка ресурсов или служб, расположенных отдельно от приложения, например сети доставки содержимого, через которую приложение получает содержимое из глобального кэша.</span><span class="sxs-lookup"><span data-stu-id="4f09a-138">Checking resources or services located outside the application, such as a content delivery network used by the application to deliver content from global caches.</span></span>
- <span data-ttu-id="4f09a-139">Проверка срока действия SSL-сертификатов.</span><span class="sxs-lookup"><span data-stu-id="4f09a-139">Checking for expiration of SSL certificates.</span></span>
- <span data-ttu-id="4f09a-140">Измерение времени отклика при получении URL-адреса приложения от DNS-сервера, что позволяет оценить задержку и наличие ошибок в службе DNS.</span><span class="sxs-lookup"><span data-stu-id="4f09a-140">Measuring the response time of a DNS lookup for the URL of the application to measure DNS latency and DNS failures.</span></span>
- <span data-ttu-id="4f09a-141">Проверка URL-адреса, полученного от DNS-сервера, что позволяет контролировать правильность данных.</span><span class="sxs-lookup"><span data-stu-id="4f09a-141">Validating the URL returned by the DNS lookup to ensure correct entries.</span></span> <span data-ttu-id="4f09a-142">Это поможет избежать вредоносного перенаправления запросов в случае успешной атаки на DNS-сервер.</span><span class="sxs-lookup"><span data-stu-id="4f09a-142">This can help to avoid malicious request redirection through a successful attack on the DNS server.</span></span>

<span data-ttu-id="4f09a-143">По возможности такие проверки следует выполнять из разных локальных сред и служб размещения, чтобы оценивать и сравнивать времена отклика для разных расположений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-143">It's also useful, where possible, to run these checks from different on-premises or hosted locations to measure and compare response times.</span></span> <span data-ttu-id="4f09a-144">Лучше всего, если мониторинг приложений выполняется из расположений, близких к расположению реальных клиентов, что позволит получить адекватное представление о реальной производительности для этих расположений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-144">Ideally you should monitor applications from locations that are close to customers to get an accurate view of the performance from each location.</span></span> <span data-ttu-id="4f09a-145">В этом случае результаты проверки будут более надежными и помогут принять решения о том, где лучше расположить развертывание и нужно ли использовать дополнительный центр обработки данных.</span><span class="sxs-lookup"><span data-stu-id="4f09a-145">In addition to providing a more robust checking mechanism, the results can help you decide on the deployment location for the application&mdash;and whether to deploy it in more than one datacenter.</span></span>

<span data-ttu-id="4f09a-146">Проверки следует выполнять для всех экземпляров службы, которые используют клиенты, чтобы убедиться в правильности работы приложения для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="4f09a-146">Tests should also be run against all the service instances that customers use to ensure the application is working correctly for all customers.</span></span> <span data-ttu-id="4f09a-147">Например, если клиентское хранилище размещено в нескольких учетных записях хранения, процесс мониторинга должен проверять их все.</span><span class="sxs-lookup"><span data-stu-id="4f09a-147">For example, if customer storage is spread across more than one storage account, the monitoring process should check all of these.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="4f09a-148">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="4f09a-148">Issues and considerations</span></span>

<span data-ttu-id="4f09a-149">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="4f09a-149">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="4f09a-150">Правильная интерпретация ответа.</span><span class="sxs-lookup"><span data-stu-id="4f09a-150">How to validate the response.</span></span> <span data-ttu-id="4f09a-151">Например, достаточно ли проверить наличие кода состояния 200 (ОК), чтобы считать, что приложение работает правильно?</span><span class="sxs-lookup"><span data-stu-id="4f09a-151">For example, is just a single 200 (OK) status code sufficient to verify the application is working correctly?</span></span> <span data-ttu-id="4f09a-152">Конечно же, это основная оценка доступности приложения, минимально необходимая для реализации этого шаблона, но она предоставляет мало информации об операциях, тенденциях и возможных неполадках в приложении.</span><span class="sxs-lookup"><span data-stu-id="4f09a-152">While this provides the most basic measure of application availability, and is the minimum implementation of this pattern, it provides little information about the operations, trends, and possible upcoming issues in the application.</span></span>

   > <span data-ttu-id="4f09a-153">Сделайте так, чтобы приложение возвращало код 200 (ОК) только в том случае, когда целевой ресурс обнаружен и правильно обработан.</span><span class="sxs-lookup"><span data-stu-id="4f09a-153">Make sure that the application correctly returns a 200 (OK) only when the target resource is found and processed.</span></span> <span data-ttu-id="4f09a-154">В некоторых сценариях, например при использовании эталонной страницы для размещения целевой веб-страницы, сервер возвращает код состояния 200 (ОК) вместо 404 (не найдено) при отсутствии целевой страницы содержимого.</span><span class="sxs-lookup"><span data-stu-id="4f09a-154">In some scenarios, such as when using a master page to host the target web page, the server sends back a 200 (OK) status code instead of a 404 (Not Found) code, even when the target content page was not found.</span></span>

<span data-ttu-id="4f09a-155">Количество конечных точек, которые нужно создать для приложения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-155">The number of endpoints to expose for an application.</span></span> <span data-ttu-id="4f09a-156">Один из возможных подходов заключается в том, чтобы предоставить не меньше двух конечных точек: одну для основных служб приложения, а другую для менее приоритетных служб. Так вы сможете назначить разные уровни важности разным результатам мониторинга.</span><span class="sxs-lookup"><span data-stu-id="4f09a-156">One approach is to expose at least one endpoint for the core services that the application uses and another for lower priority services, allowing different levels of importance to be assigned to each monitoring result.</span></span> <span data-ttu-id="4f09a-157">Вы можете предоставить больше конечных точек, например по одной для каждой базовой службы, чтобы повысить степень детализации мониторинга.</span><span class="sxs-lookup"><span data-stu-id="4f09a-157">Also consider exposing more endpoints, such as one for each core service, for additional monitoring granularity.</span></span> <span data-ttu-id="4f09a-158">Например, проверка работоспособности может включать проверку базы данных, хранилища и внешней службы геокодирования, используемой приложением, и для каждой из этих служб установлены разные требования к времени работы и времени отклика.</span><span class="sxs-lookup"><span data-stu-id="4f09a-158">For example, a health verification check might check the database, storage, and an external geocoding service that an application uses, with each requiring a different level of uptime and response time.</span></span> <span data-ttu-id="4f09a-159">Приложение сохранит работоспособность, если служба геокодирования или другая фоновая задача станут недоступны на несколько минут.</span><span class="sxs-lookup"><span data-stu-id="4f09a-159">The application could still be healthy if the geocoding service, or some other background task, is unavailable for a few minutes.</span></span>

<span data-ttu-id="4f09a-160">Использование для мониторинга ту же конечную точку, что и для общего доступа, создав в ней отдельный путь (например, /HealthCheck/{GUID}/) для проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-160">Whether to use the same endpoint for monitoring as is used for general access, but to a specific path designed for health verification checks, for example, /HealthCheck/{GUID}/ on the general access endpoint.</span></span> <span data-ttu-id="4f09a-161">Это позволит средствам мониторинга выполнять в приложении функциональные тесты, например добавлять учетные записи, выполнять вход с учетными данными и размещать тестовые заказы, одновременно с проверкой доступности конечной точки.</span><span class="sxs-lookup"><span data-stu-id="4f09a-161">This allows some functional tests in the application to be run by the monitoring tools, such as adding a new user registration, signing in, and placing a test order, while also verifying that the general access endpoint is available.</span></span>

<span data-ttu-id="4f09a-162">Тип данных, которые служба будет получать в ответ на запрос мониторинга, и методы выдачи этих сведений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-162">The type of information to collect in the service in response to monitoring requests, and how to return this information.</span></span> <span data-ttu-id="4f09a-163">Большинство существующих средств и платформ оценивают только код состояния HTTP, полученный от конечной точки.</span><span class="sxs-lookup"><span data-stu-id="4f09a-163">Most existing tools and frameworks look only at the HTTP status code that the endpoint returns.</span></span> <span data-ttu-id="4f09a-164">Чтобы получить и проверить дополнительную информацию, вам придется создать собственную программу или службу мониторинга.</span><span class="sxs-lookup"><span data-stu-id="4f09a-164">To return and validate additional information, you might have to create a custom monitoring utility or service.</span></span>

<span data-ttu-id="4f09a-165">Объем собираемых сведений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-165">How much information to collect.</span></span> <span data-ttu-id="4f09a-166">Чрезмерный объем обработки при выполнении проверок приведет к перегрузке приложения и повлияет на работу пользователей.</span><span class="sxs-lookup"><span data-stu-id="4f09a-166">Performing excessive processing during the check can overload the application and impact other users.</span></span> <span data-ttu-id="4f09a-167">Для такой обработки может потребоваться больше времени, чем ожидает система мониторинга, и тогда приложение будет отмечено как недоступное.</span><span class="sxs-lookup"><span data-stu-id="4f09a-167">The time it takes might exceed the timeout of the monitoring system so it marks the application as unavailable.</span></span> <span data-ttu-id="4f09a-168">В большинстве приложений реализовано специальное инструментирование для обработки ошибок и оценки производительности, которые ведут журналы производительности и сохраняют подробные сведения об ошибках. Возможно, есть смысл просто возвращать эти сведения, а не выполнять дополнительный сбор данных для проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-168">Most applications include instrumentation such as error handlers and performance counters that log performance and detailed error information, this might be sufficient instead of returning additional information from a health verification check.</span></span>

<span data-ttu-id="4f09a-169">Кэширование состояния конечной точки.</span><span class="sxs-lookup"><span data-stu-id="4f09a-169">Caching the endpoint status.</span></span> <span data-ttu-id="4f09a-170">Слишком частый запуск проверки работоспособности может расходовать много ресурсов.</span><span class="sxs-lookup"><span data-stu-id="4f09a-170">It could be expensive to run the health check too frequently.</span></span> <span data-ttu-id="4f09a-171">Например, если состояние работоспособности отображается на панели мониторинга, вы вряд ли захотите запускать новую проверку работоспособности в ответ на любое действие на панели мониторинга.</span><span class="sxs-lookup"><span data-stu-id="4f09a-171">If the health status is reported through a dashboard, for example, you don't want every request from the dashboard to trigger a health check.</span></span> <span data-ttu-id="4f09a-172">Проводите проверки через определенные промежутки времени и сохраняйте сведения о результатах.</span><span class="sxs-lookup"><span data-stu-id="4f09a-172">Instead, periodically check the system health and cache the status.</span></span> <span data-ttu-id="4f09a-173">Создайте конечную точку, которая возвращает сохраненное (кэшированное) состояние.</span><span class="sxs-lookup"><span data-stu-id="4f09a-173">Expose an endpoint that returns the cached status.</span></span>

<span data-ttu-id="4f09a-174">Защита конечных точек мониторинга от несанкционированного доступа, чтобы предотвратить атаки злоумышленников на приложение, снизить риск раскрытия конфиденциальных сведений или атак отказа в обслуживании (DoS).</span><span class="sxs-lookup"><span data-stu-id="4f09a-174">How to configure security for the monitoring endpoints to protect them from public access, which might expose the application to malicious attacks, risk the exposure of sensitive information, or attract denial of service (DoS) attacks.</span></span> <span data-ttu-id="4f09a-175">Обычно защита реализуется в конфигурации приложения, чтобы ее уровень можно было легко изменить без перезапуска приложения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-175">Typically this should be done in the application configuration so that it can be updated easily without restarting the application.</span></span> <span data-ttu-id="4f09a-176">Постарайтесь применить хотя бы одну из следующих методик:</span><span class="sxs-lookup"><span data-stu-id="4f09a-176">Consider using one or more of the following techniques:</span></span>

- <span data-ttu-id="4f09a-177">Включите требование выполнять аутентификацию для доступа к конечной точке.</span><span class="sxs-lookup"><span data-stu-id="4f09a-177">Secure the endpoint by requiring authentication.</span></span> <span data-ttu-id="4f09a-178">Для этого можно передавать в заголовке запроса ключ аутентификации или включать в запрос учетные данные, если служба или средство мониторинга поддерживает аутентификацию.</span><span class="sxs-lookup"><span data-stu-id="4f09a-178">You can do this by using an authentication security key in the request header or by passing credentials with the request, provided that the monitoring service or tool supports authentication.</span></span>

  - <span data-ttu-id="4f09a-179">Используйте замаскированные или скрытые конечные точки.</span><span class="sxs-lookup"><span data-stu-id="4f09a-179">Use an obscure or hidden endpoint.</span></span> <span data-ttu-id="4f09a-180">Например, конечную точку можно разместить на другом IP-адресе, который недоступен через URL-адрес приложения по умолчанию. Можно использовать нестандартный порт HTTP и (или) сложный путь к тестовой странице.</span><span class="sxs-lookup"><span data-stu-id="4f09a-180">For example, expose the endpoint on a different IP address to that used by the default application URL, configure the endpoint on a nonstandard HTTP port, and/or use a complex path to the test page.</span></span> <span data-ttu-id="4f09a-181">Адреса и порты конечных точек можно указать в конфигурации приложения, а если вы не хотите напрямую указывать IP-адреса — добавьте записи для этих конечных точек на DNS-сервер.</span><span class="sxs-lookup"><span data-stu-id="4f09a-181">You can usually specify additional endpoint addresses and ports in the application configuration, and add entries for these endpoints to the DNS server if required to avoid having to specify the IP address directly.</span></span>

  - <span data-ttu-id="4f09a-182">Предоставьте на конечной точке метод, который принимает определенный параметр, например значение ключа или режима операции.</span><span class="sxs-lookup"><span data-stu-id="4f09a-182">Expose a method on an endpoint that accepts a parameter such as a key value or an operation mode value.</span></span> <span data-ttu-id="4f09a-183">В зависимости от значения этого параметра в полученном запросе код будет выполнять определенный тест или несколько тестов, а если значение параметра не соответствует условиям — возвращать ошибку 404 (не найдено).</span><span class="sxs-lookup"><span data-stu-id="4f09a-183">Depending on the value supplied for this parameter, when a request is received the code can perform a specific test or set of tests, or return a 404 (Not Found) error if the parameter value isn't recognized.</span></span> <span data-ttu-id="4f09a-184">Допустимые значения таких параметров можно включить в конфигурацию приложения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-184">The recognized parameter values could be set in the application configuration.</span></span>

     >  <span data-ttu-id="4f09a-185">DoS-атаки будут меньше влиять на работу конечной точки, которая выполняет базовые функциональных тестов, не нарушая работу приложения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-185">DoS attacks are likely to have less impact on a separate endpoint that performs basic functional tests without compromising the operation of the application.</span></span> <span data-ttu-id="4f09a-186">Избегайте таких тестов, которые могут раскрыть конфиденциальные сведения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-186">Ideally, avoid using a test that might expose sensitive information.</span></span> <span data-ttu-id="4f09a-187">Если необходимо возвращать сведения, которые могут быть полезными для злоумышленника, подумайте о защите конечной точки и ее данных от несанкционированного доступа.</span><span class="sxs-lookup"><span data-stu-id="4f09a-187">If you must return information that might be useful to an attacker, consider how you'll protect the endpoint and the data from unauthorized access.</span></span> <span data-ttu-id="4f09a-188">В этом случае нельзя надеяться только на маскировку.</span><span class="sxs-lookup"><span data-stu-id="4f09a-188">In this case just relying on obscurity isn't enough.</span></span> <span data-ttu-id="4f09a-189">Можно также применить HTTPS-соединение и шифрование конфиденциальных данных, но это увеличит нагрузку на сервер.</span><span class="sxs-lookup"><span data-stu-id="4f09a-189">You should also consider using an HTTPS connection and encrypting any sensitive data, although this will increase the load on the server.</span></span>

- <span data-ttu-id="4f09a-190">Настройте доступ к конечной точке, защищенной с помощью аутентификации.</span><span class="sxs-lookup"><span data-stu-id="4f09a-190">How to access an endpoint that's secured using authentication.</span></span> <span data-ttu-id="4f09a-191">Не все инструменты и платформы позволяют указать учетные данные для запросов проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-191">Not all tools and frameworks can be configured to include credentials with the health verification request.</span></span> <span data-ttu-id="4f09a-192">Например, встроенная функция проверки работоспособности в Microsoft Azure не поддерживает передачу данных для аутентификации.</span><span class="sxs-lookup"><span data-stu-id="4f09a-192">For example, Microsoft Azure built-in health verification features can't provide authentication credentials.</span></span> <span data-ttu-id="4f09a-193">Можно использовать некоторые сторонние реализации, например [Pingdom](https://www.pingdom.com/), [Panopta](https://www.panopta.com/), [NewRelic](https://newrelic.com/) или [Statuscake](https://www.statuscake.com/).</span><span class="sxs-lookup"><span data-stu-id="4f09a-193">Some third-party alternatives are [Pingdom](https://www.pingdom.com/), [Panopta](https://www.panopta.com/), [NewRelic](https://newrelic.com/), and [Statuscake](https://www.statuscake.com/).</span></span>

- <span data-ttu-id="4f09a-194">Убедитесь в правильности работы агента мониторинга.</span><span class="sxs-lookup"><span data-stu-id="4f09a-194">How to ensure that the monitoring agent is performing correctly.</span></span> <span data-ttu-id="4f09a-195">Для тестирования агента можно предоставить отдельную конечную точку, которая будет возвращать некоторое значение, указанное в конфигурации приложения, или случайное значение.</span><span class="sxs-lookup"><span data-stu-id="4f09a-195">One approach is to expose an endpoint that simply returns a value from the application configuration or a random value that can be used to test the agent.</span></span>

   >  <span data-ttu-id="4f09a-196">Можно также настроить систему мониторинга на выполнение внутренних проверок (встроенных проверок, самопроверок и т. п.), чтобы избежать ложных срабатываний.</span><span class="sxs-lookup"><span data-stu-id="4f09a-196">Also ensure that the monitoring system performs checks on itself, such as a self-test and built-in test, to avoid it issuing false positive results.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="4f09a-197">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="4f09a-197">When to use this pattern</span></span>

<span data-ttu-id="4f09a-198">Этот шаблон можно использовать для следующих целей:</span><span class="sxs-lookup"><span data-stu-id="4f09a-198">This pattern is useful for:</span></span>

- <span data-ttu-id="4f09a-199">мониторинга доступности для веб-сайтов и веб-приложений;</span><span class="sxs-lookup"><span data-stu-id="4f09a-199">Monitoring websites and web applications to verify availability.</span></span>
- <span data-ttu-id="4f09a-200">мониторинга правильности работы веб-сайтов и веб-приложений;</span><span class="sxs-lookup"><span data-stu-id="4f09a-200">Monitoring websites and web applications to check for correct operation.</span></span>
- <span data-ttu-id="4f09a-201">мониторинга служб среднего уровня или общих служб для выявления ошибок, которые могут нарушить работу других приложений;</span><span class="sxs-lookup"><span data-stu-id="4f09a-201">Monitoring middle-tier or shared services to detect and isolate a failure that could disrupt other applications.</span></span>
- <span data-ttu-id="4f09a-202">дополнения существующих в приложении средств инструментирования, таких как счетчики производительности и обработчики ошибок.</span><span class="sxs-lookup"><span data-stu-id="4f09a-202">Complementing existing instrumentation in the application, such as performance counters and error handlers.</span></span> <span data-ttu-id="4f09a-203">Проверка работоспособности не отменяет необходимость вести журналы и выполнять аудит в приложении.</span><span class="sxs-lookup"><span data-stu-id="4f09a-203">Health verification checking doesn't replace the requirement for logging and auditing in the application.</span></span> <span data-ttu-id="4f09a-204">Инструментирование может передавать важную информацию в платформу, которая контролирует счетчики и журналы ошибок для поиска ошибок или других проблем.</span><span class="sxs-lookup"><span data-stu-id="4f09a-204">Instrumentation can provide valuable information for an existing framework that monitors counters and error logs to detect failures or other issues.</span></span> <span data-ttu-id="4f09a-205">Но эти сведения не удастся получить, если приложение недоступно.</span><span class="sxs-lookup"><span data-stu-id="4f09a-205">However, it can't provide information if the application is unavailable.</span></span>

## <a name="example"></a><span data-ttu-id="4f09a-206">Пример</span><span class="sxs-lookup"><span data-stu-id="4f09a-206">Example</span></span>

<span data-ttu-id="4f09a-207">В следующем примере кода из класса `HealthCheckController` (пример, демонстрирующий этот шаблон, размещен в репозитории [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring)) конечная точка предоставляется для нескольких проверок работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-207">The following code examples, taken from the `HealthCheckController` class (a sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring)), demonstrates exposing an endpoint for performing a range of health checks.</span></span>

<span data-ttu-id="4f09a-208">Представленный ниже метод `CoreServices` на языке C# выполняет серию проверок для используемых в приложении служб.</span><span class="sxs-lookup"><span data-stu-id="4f09a-208">The `CoreServices` method, shown below in C#, performs a series of checks on services used in the application.</span></span> <span data-ttu-id="4f09a-209">Если все тесты выполняются без ошибок, метод возвращает код состояния 200 (ОК).</span><span class="sxs-lookup"><span data-stu-id="4f09a-209">If all of the tests run without error, the method returns a 200 (OK) status code.</span></span> <span data-ttu-id="4f09a-210">Если любой из тестов вызывает исключение, метод возвращает код состояния 500 (внутренняя ошибка).</span><span class="sxs-lookup"><span data-stu-id="4f09a-210">If any of the tests raises an exception, the method returns a 500 (Internal Error) status code.</span></span> <span data-ttu-id="4f09a-211">Этот метод может предоставлять при возникновении ошибки дополнительную информацию, если средство или платформа мониторинга умеют ее использовать.</span><span class="sxs-lookup"><span data-stu-id="4f09a-211">The method could optionally return additional information when an error occurs, if the monitoring tool or framework is able to make use of it.</span></span>

```csharp
public ActionResult CoreServices()
{
  try
  {
    // Run a simple check to ensure the database is available.
    DataStore.Instance.CoreHealthCheck();

    // Run a simple check on our external service.
    MyExternalService.Instance.CoreHealthCheck();
  }
  catch (Exception ex)
  {
    Trace.TraceError("Exception in basic health check: {0}", ex.Message);

    // This can optionally return different status codes based on the exception.
    // Optionally it could return more details about the exception.
    // The additional information could be used by administrators who access the
    // endpoint with a browser, or using a ping utility that can display the
    // additional information.
    return new HttpStatusCodeResult((int)HttpStatusCode.InternalServerError);
  }
  return new HttpStatusCodeResult((int)HttpStatusCode.OK);
}
```

<span data-ttu-id="4f09a-212">Метод `ObscurePath` демонстрирует, как получить путь из конфигурации приложения и использовать его для создания конечной точки тестов.</span><span class="sxs-lookup"><span data-stu-id="4f09a-212">The `ObscurePath` method shows how you can read a path from the application configuration and use it as the endpoint for tests.</span></span> <span data-ttu-id="4f09a-213">Также в этом примере на языке C# демонстрируется, как получить из параметра запроса значение идентификатора и проверить его допустимость.</span><span class="sxs-lookup"><span data-stu-id="4f09a-213">This example, in C#, also shows how you can accept an ID as a parameter and use it to check for valid requests.</span></span>

```csharp
public ActionResult ObscurePath(string id)
{
  // The id could be used as a simple way to obscure or hide the endpoint.
  // The id to match could be retrieved from configuration and, if matched,
  // perform a specific set of tests and return the result. If not matched it
  // could return a 404 (Not Found) status.

  // The obscure path can be set through configuration to hide the endpoint.
  var hiddenPathKey = CloudConfigurationManager.GetSetting("Test.ObscurePath");

  // If the value passed does not match that in configuration, return 404 (Not Found).
  if (!string.Equals(id, hiddenPathKey))
  {
    return new HttpStatusCodeResult((int)HttpStatusCode.NotFound);
  }

  // Else continue and run the tests...
  // Return results from the core services test.
  return this.CoreServices();
}
```

<span data-ttu-id="4f09a-214">Метод `TestResponseFromConfig` показывает, как предоставить конечную точку, которая выполняет проверку указанного параметра конфигурации.</span><span class="sxs-lookup"><span data-stu-id="4f09a-214">The `TestResponseFromConfig` method shows how you can expose an endpoint that performs a check for a specified configuration setting value.</span></span>

```csharp
public ActionResult TestResponseFromConfig()
{
  // Health check that returns a response code set in configuration for testing.
  var returnStatusCodeSetting = CloudConfigurationManager.GetSetting(
                                                          "Test.ReturnStatusCode");

  int returnStatusCode;

  if (!int.TryParse(returnStatusCodeSetting, out returnStatusCode))
  {
    returnStatusCode = (int)HttpStatusCode.OK;
  }

  return new HttpStatusCodeResult(returnStatusCode);
}
```

## <a name="monitoring-endpoints-in-azure-hosted-applications"></a><span data-ttu-id="4f09a-215">Конечные точки мониторинга в приложениях на платформе Azure</span><span class="sxs-lookup"><span data-stu-id="4f09a-215">Monitoring endpoints in Azure hosted applications</span></span>

<span data-ttu-id="4f09a-216">Чтобы использовать конечные точки мониторинга в приложениях Azure, есть несколько доступных методов:</span><span class="sxs-lookup"><span data-stu-id="4f09a-216">Some options for monitoring endpoints in Azure applications are:</span></span>

- <span data-ttu-id="4f09a-217">использование встроенных функций мониторинга Azure;</span><span class="sxs-lookup"><span data-stu-id="4f09a-217">Use the built-in monitoring features of Azure.</span></span>

- <span data-ttu-id="4f09a-218">использование служб или платформ сторонних разработчиков, например Microsoft System Center Operations Manager;</span><span class="sxs-lookup"><span data-stu-id="4f09a-218">Use a third-party service or a framework such as Microsoft System Center Operations Manager.</span></span>

- <span data-ttu-id="4f09a-219">создание собственной программы или службы, которая выполняется в локальной среде или на размещенном сервере.</span><span class="sxs-lookup"><span data-stu-id="4f09a-219">Create a custom utility or a service that runs on your own or on a hosted server.</span></span>

   >  <span data-ttu-id="4f09a-220">Хотя Azure предоставляет достаточно широкий набор возможностей для мониторинга, вы всегда можете получить дополнительные сведения с помощью дополнительных служб и (или) средств.</span><span class="sxs-lookup"><span data-stu-id="4f09a-220">Even though Azure provides a reasonably comprehensive set of monitoring options, you can use additional services and tools to provide extra information.</span></span> <span data-ttu-id="4f09a-221">Службы управления Azure предлагают встроенный механизм мониторинга для правил генерации оповещений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-221">Azure Management Services provides a built-in monitoring mechanism for alert rules.</span></span> <span data-ttu-id="4f09a-222">Раздел предупреждений на странице служб управления на портале Azure позволяет настроить для ваших служб до десяти правил генерации оповещений.</span><span class="sxs-lookup"><span data-stu-id="4f09a-222">The alerts section of the management services page in the Azure portal allows you to configure up to ten alert rules per subscription for your services.</span></span> <span data-ttu-id="4f09a-223">В этих правилах можно задать условие и пороговое значение для службы, например предельную загрузку ЦП или максимальное число запросов или ошибок в секунду. Служба будет автоматически отправлять уведомления по электронной почте на адреса, указанные в каждом правиле.</span><span class="sxs-lookup"><span data-stu-id="4f09a-223">These rules specify a condition and a threshold value for a service such as CPU load, or the number of requests or errors per second, and the service can automatically send email notifications to addresses you define in each rule.</span></span>

<span data-ttu-id="4f09a-224">Условия для мониторинга будут разными в зависимости от механизма размещения, выбранного для приложения (веб-сайты, облачные службы, виртуальные машины или мобильные службы), но все они позволяют создать правило оповещения на основе конечной точки, указанной в параметрах соответствующей службы.</span><span class="sxs-lookup"><span data-stu-id="4f09a-224">The conditions you can monitor vary depending on the hosting mechanism you choose for your application (such as Web Sites, Cloud Services, Virtual Machines, or Mobile Services), but all of these include the ability to create an alert rule that uses a web endpoint you specify in the settings for your service.</span></span> <span data-ttu-id="4f09a-225">Эта конечная точка должна отвечать быстро, чтобы система предупреждений считала работу приложения правильной.</span><span class="sxs-lookup"><span data-stu-id="4f09a-225">This endpoint should respond in a timely way so that the alert system can detect that the application is operating correctly.</span></span>

> <span data-ttu-id="4f09a-226">Дополнительные сведения о создании уведомлений см. [здесь][portal-alerts].</span><span class="sxs-lookup"><span data-stu-id="4f09a-226">Read more information about [creating alert notifications][portal-alerts].</span></span>

<span data-ttu-id="4f09a-227">Если приложение размещено на виртуальных машинах, в веб-ролях или рабочих ролях облачной службы Azure, вы можете использовать встроенные службы Azure, которые называются диспетчер трафика Azure.</span><span class="sxs-lookup"><span data-stu-id="4f09a-227">If you host your application in Azure Cloud Services web and worker roles or Virtual Machines, you can take advantage of one of the built-in services in Azure called Traffic Manager.</span></span> <span data-ttu-id="4f09a-228">Диспетчер трафика — это служба маршрутизации и балансировки нагрузки, которая распределяет запросы между определенными экземплярами приложения, размещенного в облачной службе, используя определенный набор правил и параметров.</span><span class="sxs-lookup"><span data-stu-id="4f09a-228">Traffic Manager is a routing and load-balancing service that can distribute requests to specific instances of your Cloud Services hosted application based on a range of rules and settings.</span></span>

<span data-ttu-id="4f09a-229">Диспетчер трафика помимо маршрутизации запросов регулярно проверяет связь, используя указанные в настройках URL-адрес, порт и относительный путь, чтобы контролировать работоспособность каждого экземпляра приложения, указанного в правилах.</span><span class="sxs-lookup"><span data-stu-id="4f09a-229">In addition to routing requests, Traffic Manager pings a URL, port, and relative path that you specify on a regular basis to determine which instances of the application defined in its rules are active and are responding to requests.</span></span> <span data-ttu-id="4f09a-230">Если он получает в ответ состояние 200 (ОК), приложение считается доступным.</span><span class="sxs-lookup"><span data-stu-id="4f09a-230">If it detects a status code 200 (OK), it marks the application as available.</span></span> <span data-ttu-id="4f09a-231">Получив любой другой код состояния, диспетчер трафика отмечает приложение как неработоспособное.</span><span class="sxs-lookup"><span data-stu-id="4f09a-231">Any other status code causes Traffic Manager to mark the application as offline.</span></span> <span data-ttu-id="4f09a-232">В консоли диспетчера трафика вы можете просмотреть эти состояния и настроить правила для перенаправления запросов к другим, активным экземплярам приложения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-232">You can view the status in the Traffic Manager console, and configure the rule to reroute requests to other instances of the application that are responding.</span></span>

<span data-ttu-id="4f09a-233">Однако, диспетчер трафика при мониторинге URL-адреса ожидает ответ всего десять секунд.</span><span class="sxs-lookup"><span data-stu-id="4f09a-233">However, Traffic Manager will only wait ten seconds to receive a response from the monitoring URL.</span></span> <span data-ttu-id="4f09a-234">Это означает, что ваш код подтверждения работоспособности должен выполняться быстрее этого времени, учитывая также задержку кругового пути при передаче информации от диспетчера трафика к приложению и обратно.</span><span class="sxs-lookup"><span data-stu-id="4f09a-234">Therefore, you should ensure that your health verification code executes in this time, allowing for network latency for the round trip from Traffic Manager to your application and back again.</span></span>

> <span data-ttu-id="4f09a-235">Дополнительные сведения об использовании диспетчера трафика для мониторинга приложений см. [здесь](/azure/traffic-manager/).</span><span class="sxs-lookup"><span data-stu-id="4f09a-235">Read more information about using [Traffic Manager to monitor your applications](/azure/traffic-manager/).</span></span> <span data-ttu-id="4f09a-236">Диспетчер трафика обсуждается также в статье [Multiple Datacenter Deployment Guidance](https://msdn.microsoft.com/library/dn589779.aspx) (Руководство по развертыванию в нескольких центрах обработки данных).</span><span class="sxs-lookup"><span data-stu-id="4f09a-236">Traffic Manager is also discussed in [Multiple Datacenter Deployment Guidance](https://msdn.microsoft.com/library/dn589779.aspx).</span></span>

## <a name="related-guidance"></a><span data-ttu-id="4f09a-237">Связанные руководства</span><span class="sxs-lookup"><span data-stu-id="4f09a-237">Related guidance</span></span>

<span data-ttu-id="4f09a-238">Следующие руководства также могут быть полезными при реализации этого шаблона.</span><span class="sxs-lookup"><span data-stu-id="4f09a-238">The following guidance can be useful when implementing this pattern:</span></span>

- <span data-ttu-id="4f09a-239">[Руководство по инструментированию и телеметрии.](https://msdn.microsoft.com/library/dn589775.aspx)</span><span class="sxs-lookup"><span data-stu-id="4f09a-239">[Instrumentation and Telemetry Guidance](https://msdn.microsoft.com/library/dn589775.aspx).</span></span> <span data-ttu-id="4f09a-240">Для проверки работоспособности служб и компонентов обычно используется тестовый запрос, но полезно будет и наблюдать за производительностью приложения и отслеживать события, происходящие во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="4f09a-240">Checking the health of services and components is typically done by probing, but it's also useful to have information in place to monitor application performance and detect events that occur at runtime.</span></span> <span data-ttu-id="4f09a-241">Эти данные можно передавать в средства мониторинга в качестве дополнительных сведений о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="4f09a-241">This data can be transmitted back to monitoring tools as additional information for health monitoring.</span></span> <span data-ttu-id="4f09a-242">Руководство по инструментированию и телеметрии описывает, как собирать сведения удаленной диагностики от средств инструментирования в приложениях.</span><span class="sxs-lookup"><span data-stu-id="4f09a-242">Instrumentation and Telemetry Guidance explores gathering remote diagnostics information that's collected by instrumentation in applications.</span></span>
- <span data-ttu-id="4f09a-243">[Создание оповещений метрик в Azure Monitor для служб Azure с помощью портала Azure][portal-alerts].</span><span class="sxs-lookup"><span data-stu-id="4f09a-243">[Receiving alert notifications][portal-alerts].</span></span>
- <span data-ttu-id="4f09a-244">Этот шаблон содержит доступный для скачивания [пример приложения](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring).</span><span class="sxs-lookup"><span data-stu-id="4f09a-244">This pattern includes a downloadable [sample application](https://github.com/mspnp/cloud-design-patterns/tree/master/health-endpoint-monitoring).</span></span>

[portal-alerts]: /azure/azure-monitor/platform/alerts-metric
