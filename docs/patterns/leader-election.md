---
title: Выбор лидера
description: 'Метод координации действий для коллекции экземпляров, объединенных совместной задачей в распределенном приложении: один экземпляр выбирается в качестве лидера, который отвечает за управление другими экземплярами.'
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- design-implementation
- resiliency
ms.openlocfilehash: 3e7d47f70f660f2507f0619e1c41bf9a32a25be4
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="leader-election-pattern"></a><span data-ttu-id="b98e4-104">Шаблон выбора лидера</span><span class="sxs-lookup"><span data-stu-id="b98e4-104">Leader Election pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="b98e4-105">Выбор одного экземпляра как лидера, который несет ответственность за управление другими экземплярами для координации действий, выполняемых экземплярами, объединенными совместной задачей в распределенном приложении.</span><span class="sxs-lookup"><span data-stu-id="b98e4-105">Coordinate the actions performed by a collection of collaborating instances in a distributed application by electing one instance as the leader that assumes responsibility for managing the others.</span></span> <span data-ttu-id="b98e4-106">Это позволяет обеспечить, чтобы экземпляры не конфликтовали друг с другом, не было конфликта между совместно используемыми ресурсами и не возникало непреднамеренного вмешательства в работу, выполняемую другими экземплярами.</span><span class="sxs-lookup"><span data-stu-id="b98e4-106">This can help to ensure that instances don't conflict with each other, cause contention for shared resources, or inadvertently interfere with the work that other instances are performing.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="b98e4-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="b98e4-107">Context and problem</span></span>

<span data-ttu-id="b98e4-108">В типичном облачном приложении согласованно выполняется множество задач.</span><span class="sxs-lookup"><span data-stu-id="b98e4-108">A typical cloud application has many tasks acting in a coordinated manner.</span></span> <span data-ttu-id="b98e4-109">Все эти задачи могут быть экземплярами, которые выполняются одним и тем же кодом и которым требуется доступ к тем же ресурсам. Или могут работать вместе в параллельном режиме и выполнять отдельные части сложного вычисления.</span><span class="sxs-lookup"><span data-stu-id="b98e4-109">These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.</span></span>

<span data-ttu-id="b98e4-110">Большую часть времени экземпляры задач могут выполняться отдельно, но также может потребоваться координация действий каждого экземпляра, чтобы гарантировать отсутствие конфликтов между ними и между совместно используемыми ресурсами, а также чтобы случайно не возникло вмешательства в работу других экземпляров.</span><span class="sxs-lookup"><span data-stu-id="b98e4-110">The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don’t conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.</span></span>

<span data-ttu-id="b98e4-111">Например: </span><span class="sxs-lookup"><span data-stu-id="b98e4-111">For example:</span></span>

- <span data-ttu-id="b98e4-112">В облачной системе, реализующей горизонтальное масштабирование, одновременно может выполняться несколько экземпляров одной задачи, при этом каждый экземпляр может обслуживать другого пользователя.</span><span class="sxs-lookup"><span data-stu-id="b98e4-112">In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user.</span></span> <span data-ttu-id="b98e4-113">Если эти экземпляры выполняют запись в общий ресурс, то необходимо координировать их действия, чтобы каждый экземпляр не перезаписывал изменения, внесенные другими экземплярами.</span><span class="sxs-lookup"><span data-stu-id="b98e4-113">If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.</span></span>
- <span data-ttu-id="b98e4-114">Если задачи параллельно выполняют отдельные элементы сложного вычисления, то результаты должны вычисляться после их полного завершения.</span><span class="sxs-lookup"><span data-stu-id="b98e4-114">If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they all complete.</span></span>

<span data-ttu-id="b98e4-115">Все экземпляры задач являются кэширующими узлами, поэтому среди них нет естественного лидера, который бы действовал как координатор или агрегатор.</span><span class="sxs-lookup"><span data-stu-id="b98e4-115">The task instances are all peers, so there isn't a natural leader that can act as the coordinator or aggregator.</span></span>

## <a name="solution"></a><span data-ttu-id="b98e4-116">Решение</span><span class="sxs-lookup"><span data-stu-id="b98e4-116">Solution</span></span>

<span data-ttu-id="b98e4-117">В качестве лидера необходимо выбрать один экземпляр задачи, и этот экземпляр будет координировать действия других подчиненных экземпляров задач.</span><span class="sxs-lookup"><span data-stu-id="b98e4-117">A single task instance should be elected to act as the leader, and this instance should coordinate the actions of the other subordinate task instances.</span></span> <span data-ttu-id="b98e4-118">Если все экземпляры задач выполняются одним и тем же кодом, то все они могут выступать в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-118">If all of the task instances are running the same code, they are each capable of acting as the leader.</span></span> <span data-ttu-id="b98e4-119">Поэтому процесс выбора должен тщательно контролироваться, чтобы два или более экземпляров не получили роль лидера одновременно.</span><span class="sxs-lookup"><span data-stu-id="b98e4-119">Therefore, the election process must be managed carefully to prevent two or more instances taking over the leader role at the same time.</span></span>

<span data-ttu-id="b98e4-120">Система должна предоставлять надежный механизм для выбора лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-120">The system must provide a robust mechanism for selecting the leader.</span></span> <span data-ttu-id="b98e4-121">Этот метод должен справляться с такими событиями, как сбои сети или сбои рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-121">This method has to cope with events such as network outages or process failures.</span></span> <span data-ttu-id="b98e4-122">Во многих решениях подчиненные экземпляры задач выполняют мониторинг лидера посредством так называемого метода пульса или с помощью опроса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-122">In many solutions, the subordinate task instances monitor the leader through some type of heartbeat method, or by polling.</span></span> <span data-ttu-id="b98e4-123">Если назначенный лидер неожиданно завершает работу, или если сбой сети делает лидера недоступным для подчиненных экземпляров задач, то им необходимо выбрать нового лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-123">If the designated leader terminates unexpectedly, or a network failure makes the leader unavailable to the subordinate task instances, it's necessary for them to elect a new leader.</span></span>

<span data-ttu-id="b98e4-124">Существует несколько стратегий выбора лидера среди набора задач в распределенной среде, а именно:</span><span class="sxs-lookup"><span data-stu-id="b98e4-124">There are several strategies for electing a leader among a set of tasks in a distributed environment, including:</span></span>
- <span data-ttu-id="b98e4-125">Выбор экземпляра задачи с самым низким рангом или наименьшим значением идентификатора процесса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-125">Selecting the task instance with the lowest-ranked instance or process ID.</span></span>
- <span data-ttu-id="b98e4-126">Состязание для получения общего распределенного мьютекса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-126">Racing to acquire a shared, distributed mutex.</span></span> <span data-ttu-id="b98e4-127">Первый экземпляр задачи, который получит мьютекс, становится лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-127">The first task instance that acquires the mutex is the leader.</span></span> <span data-ttu-id="b98e4-128">При этом системе необходимо убедиться, что если лидер завершает работу или отключается от остальной части системы, то мьютекс отменяется, чтобы другой экземпляр задачи мог стать лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-128">However, the system must ensure that, if the leader terminates or becomes disconnected from the rest of the system, the mutex is released to allow another task instance to become the leader.</span></span>
- <span data-ttu-id="b98e4-129">Реализация одного из распространенных алгоритмов выбора лидера, таких как [алгоритм Bully](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) или [алгоритм Ring](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="b98e4-129">Implementing one of the common leader election algorithms such as the [Bully Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) or the [Ring Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span> <span data-ttu-id="b98e4-130">Эти алгоритмы предполагают, что каждый кандидат при выборе имеет уникальный идентификатор, и что он может надежно взаимодействовать с другими кандидатами.</span><span class="sxs-lookup"><span data-stu-id="b98e4-130">These algorithms assume that each candidate in the election has a unique ID, and that it can communicate with the other candidates reliably.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="b98e4-131">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="b98e4-131">Issues and considerations</span></span>

<span data-ttu-id="b98e4-132">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="b98e4-132">Consider the following points when deciding how to implement this pattern:</span></span>
- <span data-ttu-id="b98e4-133">Процесс выбора лидера должен быть устойчивым к временным и постоянным сбоям.</span><span class="sxs-lookup"><span data-stu-id="b98e4-133">The process of electing a leader should be resilient to transient and persistent failures.</span></span>
- <span data-ttu-id="b98e4-134">Должна быть возможность выявления ситуаций, когда в лидере произошел сбой или он стал недоступным по другой причине (например, из-за ошибки связи).</span><span class="sxs-lookup"><span data-stu-id="b98e4-134">It must be possible to detect when the leader has failed or has become otherwise unavailable (such as due to a communications failure).</span></span> <span data-ttu-id="b98e4-135">Необходимая скорость выявления зависит от системы.</span><span class="sxs-lookup"><span data-stu-id="b98e4-135">How quickly detection is needed is system dependent.</span></span> <span data-ttu-id="b98e4-136">Некоторые системы способны какое-то время функционировать без лидера. В этот период временная ошибка может быть исправлена.</span><span class="sxs-lookup"><span data-stu-id="b98e4-136">Some systems might be able to function for a short time without a leader, during which a transient fault might be fixed.</span></span> <span data-ttu-id="b98e4-137">В других случаях может потребоваться немедленно обнаружить сбой лидера и запустить новый процесс выбора.</span><span class="sxs-lookup"><span data-stu-id="b98e4-137">In other cases, it might be necessary to detect leader failure immediately and trigger a new election.</span></span>
- <span data-ttu-id="b98e4-138">В системе, в которой реализовано горизонтальное автомасштабирование, лидер может выйти из строя, если система выполнит обратное масштабирование и, как следствие, завершит работу некоторых вычислительных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="b98e4-138">In a system that implements horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some of the computing resources.</span></span>
- <span data-ttu-id="b98e4-139">Использование общего распределенного мьютекса вводит зависимость от внешней службы, которая предоставляет мьютекс.</span><span class="sxs-lookup"><span data-stu-id="b98e4-139">Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex.</span></span> <span data-ttu-id="b98e4-140">Служба представляет собой единую точку отказа.</span><span class="sxs-lookup"><span data-stu-id="b98e4-140">The service constitutes a single point of failure.</span></span> <span data-ttu-id="b98e4-141">Если она станет недоступной по какой-либо причине, система не сможет выбрать лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-141">If it becomes unavailable for any reason, the system won't be able to elect a leader.</span></span>
- <span data-ttu-id="b98e4-142">Использование одного выделенного процесса в качестве лидера является простым подходом.</span><span class="sxs-lookup"><span data-stu-id="b98e4-142">Using a single dedicated process as the leader is a straightforward approach.</span></span> <span data-ttu-id="b98e4-143">Тем не менее, в случае сбоя процесса может возникать значительная задержка при его перезапуске.</span><span class="sxs-lookup"><span data-stu-id="b98e4-143">However, if the process fails there could be a significant delay while it's restarted.</span></span> <span data-ttu-id="b98e4-144">Эта задержка может негативно влиять на производительность и время отклика других процессов, если они ожидают действий лидера по координации операции.</span><span class="sxs-lookup"><span data-stu-id="b98e4-144">The resulting latency can affect the performance and response times of other processes if they're waiting for the leader to coordinate an operation.</span></span>
- <span data-ttu-id="b98e4-145">Реализация одного из алгоритмов выбора лидера вручную обеспечивает наибольшую гибкость для настройки и оптимизации кода.</span><span class="sxs-lookup"><span data-stu-id="b98e4-145">Implementing one of the leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="b98e4-146">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="b98e4-146">When to use this pattern</span></span>

<span data-ttu-id="b98e4-147">Используйте этот шаблон, когда задачи в распределенном приложении (например, размещенном в облаке решении) нуждаются в тщательной координации, а естественный лидер отсутствует.</span><span class="sxs-lookup"><span data-stu-id="b98e4-147">Use this pattern when the tasks in a distributed application, such as a cloud-hosted solution, need careful coordination and there's no natural leader.</span></span>

>  <span data-ttu-id="b98e4-148">Старайтесь не делать лидером узкое место в системе.</span><span class="sxs-lookup"><span data-stu-id="b98e4-148">Avoid making the leader a bottleneck in the system.</span></span> <span data-ttu-id="b98e4-149">Предназначение лидера &mdash; координировать работу подчиненных задач. Он не обязан сам участвовать в этой работе, хотя он должен иметь возможность это сделать, если задача не выбрана в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-149">The purpose of the leader is to coordinate the work of the subordinate tasks, and it doesn't necessarily have to participate in this work itself&mdash;although it should be able to do so if the task isn't elected as the leader.</span></span>

<span data-ttu-id="b98e4-150">Этот шаблон может оказаться неэффективным в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="b98e4-150">This pattern might not be useful if:</span></span>
- <span data-ttu-id="b98e4-151">Существует естественный лидер или выделенный процесс, который всегда может выступить в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-151">There's a natural leader or dedicated process that can always act as the leader.</span></span> <span data-ttu-id="b98e4-152">Например, может быть возможность реализовать одноэлементный процесс, координирующий экземпляры задач.</span><span class="sxs-lookup"><span data-stu-id="b98e4-152">For example, it might be possible to implement a singleton process that coordinates the task instances.</span></span> <span data-ttu-id="b98e4-153">Если произойдет сбой этого процесса или он станет неработоспособным, то система может завершить его работу и перезапустить его.</span><span class="sxs-lookup"><span data-stu-id="b98e4-153">If this process fails or becomes unhealthy, the system can shut it down and restart it.</span></span>
- <span data-ttu-id="b98e4-154">Координация между задачами может достигаться с помощью более упрощенного метода.</span><span class="sxs-lookup"><span data-stu-id="b98e4-154">The coordination between tasks can be achieved using a more lightweight method.</span></span> <span data-ttu-id="b98e4-155">Например, если нескольким экземплярам задач просто требуется координируемый доступ к общему ресурсу, то лучшим решением для управления доступом является использование оптимистической или пессимистической блокировки.</span><span class="sxs-lookup"><span data-stu-id="b98e4-155">For example, if several task instances simply need coordinated access to a shared resource, a better solution is to use optimistic or pessimistic locking to control access.</span></span>
- <span data-ttu-id="b98e4-156">Стороннее решение является более подходящим.</span><span class="sxs-lookup"><span data-stu-id="b98e4-156">A third-party solution is more appropriate.</span></span> <span data-ttu-id="b98e4-157">Например, служба Microsoft Azure HDInsight (на основе Apache Hadoop) использует службы, предоставляемые Apache Zookeeper, чтобы координировать задачи map и reduce, собирающие и сводящие данные.</span><span class="sxs-lookup"><span data-stu-id="b98e4-157">For example, the Microsoft Azure HDInsight service (based on Apache Hadoop) uses the services provided by Apache Zookeeper to coordinate the map and reduce tasks that collect and summarize data.</span></span>

## <a name="example"></a><span data-ttu-id="b98e4-158">Пример</span><span class="sxs-lookup"><span data-stu-id="b98e4-158">Example</span></span>

<span data-ttu-id="b98e4-159">Проект DistributedMutex в решении LeaderElection (пример, демонстрирующий этот шаблон, можно найти на портале [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) показывает, как использовать аренду с большим двоичным объектом службы хранилища Azure для обеспечения механизма реализации общего распределенного мьютекса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-159">The DistributedMutex project in the LeaderElection solution (a sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) shows how to use a lease on an Azure Storage blob to provide a mechanism for implementing a shared, distributed mutex.</span></span> <span data-ttu-id="b98e4-160">Этот мьютекс можно использовать для выбора лидера среди группы экземпляров ролей в облачной службе Azure.</span><span class="sxs-lookup"><span data-stu-id="b98e4-160">This mutex can be used to elect a leader among a group of role instances in an Azure cloud service.</span></span> <span data-ttu-id="b98e4-161">Первый экземпляр роли, который получит аренду, выбирается в качестве лидера и остается лидером, пока не освободит аренду или будет не в состоянии возобновить аренду.</span><span class="sxs-lookup"><span data-stu-id="b98e4-161">The first role instance to acquire the lease is elected the leader, and remains the leader until it releases the lease or isn't able to renew the lease.</span></span> <span data-ttu-id="b98e4-162">Другие экземпляры роли могут продолжать отслеживать аренду большого двоичного объекта, если лидер станет недоступным.</span><span class="sxs-lookup"><span data-stu-id="b98e4-162">Other role instances can continue to monitor the blob lease in case the leader is no longer available.</span></span>

>  <span data-ttu-id="b98e4-163">Аренда большого двоичного объекта — это блокировка на запись в большой двоичный объект.</span><span class="sxs-lookup"><span data-stu-id="b98e4-163">A blob lease is an exclusive write lock over a blob.</span></span> <span data-ttu-id="b98e4-164">Один большой двоичный объект может быть субъектом только одной аренды в любой момент времени.</span><span class="sxs-lookup"><span data-stu-id="b98e4-164">A single blob can be the subject of only one lease at any point in time.</span></span> <span data-ttu-id="b98e4-165">Экземпляр роли может запросить аренду указанного большого двоичного объекта, и аренда будет ему предоставлена, если какой-то другой экземпляр роли не арендует этот же большой двоичный объект.</span><span class="sxs-lookup"><span data-stu-id="b98e4-165">A role instance can request a lease over a specified blob, and it'll be granted the lease if no other role instance holds a lease over the same blob.</span></span> <span data-ttu-id="b98e4-166">В противном случае запрос вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="b98e4-166">Otherwise the request will throw an exception.</span></span>
> 
> <span data-ttu-id="b98e4-167">Чтобы избежать ситуации, когда неисправный экземпляр роли удерживает аренду неограниченное время, укажите время существования аренды.</span><span class="sxs-lookup"><span data-stu-id="b98e4-167">To avoid a faulted role instance retaining the lease indefinitely, specify a lifetime for the lease.</span></span> <span data-ttu-id="b98e4-168">По истечении этого срока аренда станет доступной.</span><span class="sxs-lookup"><span data-stu-id="b98e4-168">When this expires, the lease becomes available.</span></span> <span data-ttu-id="b98e4-169">Тем не менее, пока экземпляр роли обладает арендой, он может запросить ее продление. В этом случае ему будет предоставлена аренда на последующий период времени.</span><span class="sxs-lookup"><span data-stu-id="b98e4-169">However, while a role instance holds the lease it can request that the lease is renewed, and it'll be granted the lease for a further period of time.</span></span> <span data-ttu-id="b98e4-170">Экземпляр роли может постоянно повторять этот процесс, чтобы сохранить аренду.</span><span class="sxs-lookup"><span data-stu-id="b98e4-170">The role instance can continually repeat this process if it wants to retain the lease.</span></span>
> <span data-ttu-id="b98e4-171">Дополнительные сведения об аренде большого двоичного объекта см. в статье [Lease Blob](https://msdn.microsoft.com/library/azure/ee691972.aspx) (Аренда большого двоичного объекта).</span><span class="sxs-lookup"><span data-stu-id="b98e4-171">For more information on how to lease a blob, see [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span></span>

<span data-ttu-id="b98e4-172">Класс `BlobDistributedMutex` в приведенном ниже примере C# содержит метод `RunTaskWhenMutexAquired`, который предоставляет экземпляру роли возможность получить аренду указанного большого двоичного объекта.</span><span class="sxs-lookup"><span data-stu-id="b98e4-172">The `BlobDistributedMutex` class in the C# example below contains the `RunTaskWhenMutexAquired` method that enables a role instance to attempt to acquire a lease over a specified blob.</span></span> <span data-ttu-id="b98e4-173">Сведения о большом двоичном объекте (имя, контейнер и учетная запись хранения) передаются в конструктор в объекте `BlobSettings`, когда создается объект `BlobDistributedMutex` (этот объект является простой структурой, включенной в пример кода).</span><span class="sxs-lookup"><span data-stu-id="b98e4-173">The details of the blob (the name, container, and storage account) are passed to the constructor in a `BlobSettings` object when the `BlobDistributedMutex` object is created (this object is a simple struct that is included in the sample code).</span></span> <span data-ttu-id="b98e4-174">Конструктор также принимает объект `Task`, ссылающийся на код, который должен выполнять экземпляр роли, если он успешно получил аренду большого двоичного объекта и был выбран лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-174">The constructor also accepts a `Task` that references the code that the role instance should run if it successfully acquires the lease over the blob and is elected the leader.</span></span> <span data-ttu-id="b98e4-175">Обратите внимание, что код, который обрабатывает низкоуровневые сведения о получении аренды, реализован в отдельном вспомогательном классе `BlobLeaseManager`.</span><span class="sxs-lookup"><span data-stu-id="b98e4-175">Note that the code that handles the low-level details of acquiring the lease is implemented in a separate helper class named `BlobLeaseManager`.</span></span>

```csharp
public class BlobDistributedMutex
{
  ...
  private readonly BlobSettings blobSettings;
  private readonly Func<CancellationToken, Task> taskToRunWhenLeaseAcquired;
  ...

  public BlobDistributedMutex(BlobSettings blobSettings,
           Func<CancellationToken, Task> taskToRunWhenLeaseAquired)
  {
    this.blobSettings = blobSettings;
    this.taskToRunWhenLeaseAquired = taskToRunWhenLeaseAquired;
  }

  public async Task RunTaskWhenMutexAcquired(CancellationToken token)
  {
    var leaseManager = new BlobLeaseManager(blobSettings);
    await this.RunTaskWhenBlobLeaseAcquired(leaseManager, token);
  }
  ...
```

<span data-ttu-id="b98e4-176">Метод `RunTaskWhenMutexAquired` в приведенном выше примере кода вызывает метод `RunTaskWhenBlobLeaseAcquired`, который показан в следующем примере кода. Это фактически и есть приобретение аренды.</span><span class="sxs-lookup"><span data-stu-id="b98e4-176">The `RunTaskWhenMutexAquired` method in the code sample above invokes the `RunTaskWhenBlobLeaseAcquired` method shown in the following code sample to actually acquire the lease.</span></span> <span data-ttu-id="b98e4-177">Метод `RunTaskWhenBlobLeaseAcquired` выполняется асинхронно.</span><span class="sxs-lookup"><span data-stu-id="b98e4-177">The `RunTaskWhenBlobLeaseAcquired` method runs asynchronously.</span></span> <span data-ttu-id="b98e4-178">Если аренда успешно получена, то экземпляр роли выбран лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-178">If the lease is successfully acquired, the role instance has been elected the leader.</span></span> <span data-ttu-id="b98e4-179">Делегат `taskToRunWhenLeaseAcquired` предназначен для выполнения работы, координирующей другие экземпляры роли.</span><span class="sxs-lookup"><span data-stu-id="b98e4-179">The purpose of the `taskToRunWhenLeaseAcquired` delegate is to perform the work that coordinates the other role instances.</span></span> <span data-ttu-id="b98e4-180">Если аренда не получена, значит лидером выбран другой экземпляр роли, а текущий экземпляр роли остается подчиненным.</span><span class="sxs-lookup"><span data-stu-id="b98e4-180">If the lease isn't acquired, another role instance has been elected as the leader and the current role instance remains a subordinate.</span></span> <span data-ttu-id="b98e4-181">Обратите внимание, что `TryAcquireLeaseOrWait` — это вспомогательный метод, который использует объект `BlobLeaseManager` для получения аренды.</span><span class="sxs-lookup"><span data-stu-id="b98e4-181">Note that the `TryAcquireLeaseOrWait` method is a helper method that uses the `BlobLeaseManager` object to acquire the lease.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (!token.IsCancellationRequested)
    {
      // Try to acquire the blob lease.
      // Otherwise wait for a short time before trying again.
      string leaseId = await this.TryAquireLeaseOrWait(leaseManager, token);

      if (!string.IsNullOrEmpty(leaseId))
      {
        // Create a new linked cancellation token source so that if either the
        // original token is canceled or the lease can't be renewed, the
        // leader task can be canceled.
        using (var leaseCts =
          CancellationTokenSource.CreateLinkedTokenSource(new[] { token }))
        {
          // Run the leader task.
          var leaderTask = this.taskToRunWhenLeaseAquired.Invoke(leaseCts.Token);
          ...
        }
      }
    }
    ...
  }
```

<span data-ttu-id="b98e4-182">Задача, запускаемая лидером, также выполняется асинхронно.</span><span class="sxs-lookup"><span data-stu-id="b98e4-182">The task started by the leader also runs asynchronously.</span></span> <span data-ttu-id="b98e4-183">Пока выполняется эта задача, метод `RunTaskWhenBlobLeaseAquired`, показанный в следующем примере кода, периодически пытается возобновить аренду.</span><span class="sxs-lookup"><span data-stu-id="b98e4-183">While this task is running, the `RunTaskWhenBlobLeaseAquired` method shown in the following code sample periodically attempts to renew the lease.</span></span> <span data-ttu-id="b98e4-184">Тем самым гарантируется, что экземпляр роли остается лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-184">This helps to ensure that the role instance remains the leader.</span></span> <span data-ttu-id="b98e4-185">В примере решения задержка между запросами на возобновление меньше, чем время, указанное как продолжительность аренды. Это сделано для того, чтобы другой экземпляр роли не был выбран лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-185">In the sample solution, the delay between renewal requests is less than the time specified for the duration of the lease in order to prevent another role instance from being elected the leader.</span></span> <span data-ttu-id="b98e4-186">Если по какой-то причине при возобновлении происходит сбой, то задача отменяется.</span><span class="sxs-lookup"><span data-stu-id="b98e4-186">If the renewal fails for any reason, the task is canceled.</span></span>

<span data-ttu-id="b98e4-187">Если не удается возобновить аренду, или если задача отменяется (это может произойти в результате завершения работы экземпляра роли), то аренда прекращается.</span><span class="sxs-lookup"><span data-stu-id="b98e4-187">If the lease fails to be renewed or the task is canceled (possibly as a result of the role instance shutting down), the lease is released.</span></span> <span data-ttu-id="b98e4-188">На данном этапе этот или другой экземпляр роли можно выбрать в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-188">At this point, this or another role instance might be elected as the leader.</span></span> <span data-ttu-id="b98e4-189">В приведенном ниже фрагменте кода показана эта часть процесса.</span><span class="sxs-lookup"><span data-stu-id="b98e4-189">The code extract below shows this part of the process.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (...)
    {
      ...
      if (...)
      {
        ...
        using (var leaseCts = ...)
        {
          ...
          // Keep renewing the lease in regular intervals.
          // If the lease can't be renewed, then the task completes.
          var renewLeaseTask =
            this.KeepRenewingLease(leaseManager, leaseId, leaseCts.Token);

          // When any task completes (either the leader task itself or when it
          // couldn't renew the lease) then cancel the other task.
          await CancelAllWhenAnyCompletes(leaderTask, renewLeaseTask, leaseCts);
        }
      }
    }
  }
  ...
}
```

<span data-ttu-id="b98e4-190">`KeepRenewingLease` — это еще один вспомогательный метод, который использует объект `BlobLeaseManager` для возобновления аренды.</span><span class="sxs-lookup"><span data-stu-id="b98e4-190">The `KeepRenewingLease` method is another helper method that uses the `BlobLeaseManager` object to renew the lease.</span></span> <span data-ttu-id="b98e4-191">Метод `CancelAllWhenAnyCompletes` отменяет задачи, указанные в качестве первых двух параметров.</span><span class="sxs-lookup"><span data-stu-id="b98e4-191">The `CancelAllWhenAnyCompletes` method cancels the tasks specified as the first two parameters.</span></span> <span data-ttu-id="b98e4-192">На следующей схеме показано, как с помощью класса `BlobDistributedMutex` выбирается лидер и запускается задача, которая координирует операции.</span><span class="sxs-lookup"><span data-stu-id="b98e4-192">The following diagram illustrates using the `BlobDistributedMutex` class to elect a leader and run a task that coordinates operations.</span></span>

![Рисунок 1, демонстрирующий функции класса BlobDistributedMutex](./_images/leader-election-diagram.png)


<span data-ttu-id="b98e4-194">В следующем примере кода показано использование класса `BlobDistributedMutex` в рабочей роли.</span><span class="sxs-lookup"><span data-stu-id="b98e4-194">The following code example shows how to use the `BlobDistributedMutex` class in a worker role.</span></span> <span data-ttu-id="b98e4-195">Этот код получает аренду большого двоичного объекта с именем `MyLeaderCoordinatorTask`, помещая ее в контейнер аренды в хранилище разработки, а также указывает, что код, определенный в методе `MyLeaderCoordinatorTask`, должен выполняться, если экземпляр роли выбирается в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-195">This code acquires a lease over a blob named `MyLeaderCoordinatorTask` in the lease's container in development storage, and specifies that the code defined in the `MyLeaderCoordinatorTask` method should run if the role instance is elected the leader.</span></span>

```csharp
var settings = new BlobSettings(CloudStorageAccount.DevelopmentStorageAccount,
  "leases", "MyLeaderCoordinatorTask");
var cts = new CancellationTokenSource();
var mutex = new BlobDistributedMutex(settings, MyLeaderCoordinatorTask);
mutex.RunTaskWhenMutexAcquired(this.cts.Token);
...

// Method that runs if the role instance is elected the leader
private static async Task MyLeaderCoordinatorTask(CancellationToken token)
{
  ...
}
```

<span data-ttu-id="b98e4-196">Обратите внимание на следующие аспекты, касающиеся примера решения:</span><span class="sxs-lookup"><span data-stu-id="b98e4-196">Note the following points about the sample solution:</span></span>
- <span data-ttu-id="b98e4-197">Большой двоичный объект — это потенциальная единая точка отказа.</span><span class="sxs-lookup"><span data-stu-id="b98e4-197">The blob is a potential single point of failure.</span></span> <span data-ttu-id="b98e4-198">Если служба BLOB-объектов становится недоступной, или в нее не удается войти, то лидер не сможет возобновить аренду. И никакой другой экземпляр роли не сможет получить аренду.</span><span class="sxs-lookup"><span data-stu-id="b98e4-198">If the blob service becomes unavailable, or is inaccessible, the leader won't be able to renew the lease and no other role instance will be able to acquire the lease.</span></span> <span data-ttu-id="b98e4-199">В таком случае никакой экземпляр роли не сможет выступать в качестве лидера.</span><span class="sxs-lookup"><span data-stu-id="b98e4-199">In this case, no role instance will be able to act as the leader.</span></span> <span data-ttu-id="b98e4-200">Однако служба BLOB-объектов обладает отказоустойчивостью, поэтому полный сбой этой службы является крайне маловероятным.</span><span class="sxs-lookup"><span data-stu-id="b98e4-200">However, the blob service is designed to be resilient, so complete failure of the blob service is considered to be extremely unlikely.</span></span>
- <span data-ttu-id="b98e4-201">Если задача, выполняемая лидером, останавливается, то лидер может по-прежнему возобновить аренду. При этом никакой другой экземпляр не сможет получить аренду и занять роль лидера для координации задач.</span><span class="sxs-lookup"><span data-stu-id="b98e4-201">If the task being performed by the leader stalls, the leader might continue to renew the lease, preventing any other role instance from acquiring the lease and taking over the leader role in order to coordinate tasks.</span></span> <span data-ttu-id="b98e4-202">В реальной среде работоспособность лидера должна проверяться достаточно часто.</span><span class="sxs-lookup"><span data-stu-id="b98e4-202">In the real world, the health of the leader should be checked at frequent intervals.</span></span>
- <span data-ttu-id="b98e4-203">Процесс выбора является недетерминированным.</span><span class="sxs-lookup"><span data-stu-id="b98e4-203">The election process is nondeterministic.</span></span> <span data-ttu-id="b98e4-204">Вы не можете допустить каких-либо предположений о том, какой экземпляр роли получит аренду большого двоичного объекта и станет лидером.</span><span class="sxs-lookup"><span data-stu-id="b98e4-204">You can't make any assumptions about which role instance will acquire the blob lease and become the leader.</span></span>
- <span data-ttu-id="b98e4-205">Большой двоичный объект, используемый в качестве целевого объекта аренды большого двоичного объекта, не должен использоваться ни для какой иной цели.</span><span class="sxs-lookup"><span data-stu-id="b98e4-205">The blob used as the target of the blob lease shouldn't be used for any other purpose.</span></span> <span data-ttu-id="b98e4-206">Если экземпляр роли попытается сохранить данные в большой двоичный объект, то эти данные не станут доступными, пока экземпляр роли не станет лидером и не получит аренду большого двоичного объекта.</span><span class="sxs-lookup"><span data-stu-id="b98e4-206">If a role instance attempts to store data in this blob, this data won't be accessible unless the role instance is the leader and holds the blob lease.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="b98e4-207">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="b98e4-207">Related patterns and guidance</span></span>

<span data-ttu-id="b98e4-208">При реализации этого шаблона следует принять во внимание следующие рекомендации:</span><span class="sxs-lookup"><span data-stu-id="b98e4-208">The following guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="b98e4-209">Этот шаблон содержит доступный для скачивания [пример приложения](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span><span class="sxs-lookup"><span data-stu-id="b98e4-209">This pattern has a downloadable [sample application](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span></span>
- <span data-ttu-id="b98e4-210">[Руководство по автоматическому масштабированию](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="b98e4-210">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="b98e4-211">Существует возможность запускать и останавливать экземпляры узлов задач, так как нагрузка на приложение варьируется.</span><span class="sxs-lookup"><span data-stu-id="b98e4-211">It's possible to start and stop instances of the task hosts as the load on the application varies.</span></span> <span data-ttu-id="b98e4-212">Автомасштабирование может быть полезным для поддержания пропускной способности и производительности во время максимальной нагрузки.</span><span class="sxs-lookup"><span data-stu-id="b98e4-212">Autoscaling can help to maintain throughput and performance during times of peak processing.</span></span>
- <span data-ttu-id="b98e4-213">[Рекомендации по разделению вычислений](https://msdn.microsoft.com/library/dn589773.aspx).</span><span class="sxs-lookup"><span data-stu-id="b98e4-213">[Compute Partitioning Guidance](https://msdn.microsoft.com/library/dn589773.aspx).</span></span> <span data-ttu-id="b98e4-214">В этом руководстве описывается выделение задач для узлов в облачной службе, которое позволяет свести к минимуму эксплуатационные расходы при сохранении масштабируемости, производительности, доступности и безопасности службы.</span><span class="sxs-lookup"><span data-stu-id="b98e4-214">This guidance describes how to allocate tasks to hosts in a cloud service in a way that helps to minimize running costs while maintaining the scalability, performance, availability, and security of the service.</span></span>
- <span data-ttu-id="b98e4-215">[Task-based Asynchronous Pattern ](https://msdn.microsoft.com/library/hh873175.aspx) (Асинхронная модель на основе задач).</span><span class="sxs-lookup"><span data-stu-id="b98e4-215">The [Task-based Asynchronous Pattern](https://msdn.microsoft.com/library/hh873175.aspx).</span></span>
- <span data-ttu-id="b98e4-216">Пример, демонстрирующий [алгоритм Bully](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span><span class="sxs-lookup"><span data-stu-id="b98e4-216">An example illustrating the [Bully Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span></span>
- <span data-ttu-id="b98e4-217">Пример, демонстрирующий [алгоритм Ring](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="b98e4-217">An example illustrating the [Ring Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span>
- <span data-ttu-id="b98e4-218">Статья [Apache Zookeeper on Microsoft Azure](https://msopentech.com/opentech-projects/apache-zookeeper-on-windows-azure-2/) (Zookeeper Apache в Microsoft Azure) на веб-сайте Microsoft Open Technologies.</span><span class="sxs-lookup"><span data-stu-id="b98e4-218">The article [Apache Zookeeper on Microsoft Azure](https://msopentech.com/opentech-projects/apache-zookeeper-on-windows-azure-2/) on the Microsoft Open Technologies website.</span></span>
- <span data-ttu-id="b98e4-219">[Apache Curator](http://curator.apache.org/) — клиентская библиотека для Apache ZooKeeper.</span><span class="sxs-lookup"><span data-stu-id="b98e4-219">[Apache Curator](http://curator.apache.org/) a client library for Apache ZooKeeper.</span></span>
- <span data-ttu-id="b98e4-220">Статья [Lease Blob](https://msdn.microsoft.com/library/azure/ee691972.aspx) (Аренда большого двоичного объекта) на сайте MSDN.</span><span class="sxs-lookup"><span data-stu-id="b98e4-220">The article [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx) on MSDN.</span></span>
