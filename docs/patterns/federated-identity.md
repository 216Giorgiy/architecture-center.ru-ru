---
title: Федеративная идентификация
description: Делегируйте аутентификацию внешнему поставщику удостоверений.
keywords: конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- security
ms.openlocfilehash: a1edbdd080309383201d33e73602e2f18928c080
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="federated-identity-pattern"></a>Шаблон федеративной идентификации

[!INCLUDE [header](../_includes/header.md)]

Делегируйте аутентификацию внешнему поставщику удостоверений. Это может упростить разработку, свести к минимуму требование для администрирования пользователей и улучшить работу с приложением.

## <a name="context-and-problem"></a>Контекст и проблема

Как правило, пользователи должны работать с несколькими приложениями, предоставленными и размещенными организациями, с которыми они сотрудничают. Этим пользователям может потребоваться использовать конкретные учетные данные (и при этом разные) для каждого приложения. Это может:

- **Привести к несвязной работе пользователей**. Пользователи часто забывают учетные данные для входа, так как их много.

- **Привести к появлению уязвимостей безопасности**. Когда пользователь уходит из компании, учетная запись должна быть немедленно удалена. В крупных организациях этот нюанс упускается.

- **Усложнить управление пользователями**. Администраторы должны управлять учетными данными для всех пользователей и выполнять дополнительные задачи, например запоминать пароль.

Обычно пользователи предпочитают использовать одинаковые учетные данные для всех приложений.

## <a name="solution"></a>Решение

Реализуйте механизм аутентификации, который может использовать федеративное удостоверение. Отделите аутентификацию пользователей от кода приложения и делегируйте аутентификацию доверенному поставщику удостоверений. Это может упростить разработку и позволить пользователям проходить аутентификацию с использованием различных поставщиков удостоверений, а также свести к минимуму административные издержки. Кроме того, это позволяет четко отделить аутентификацию от авторизации.

Доверенные поставщики удостоверений включают корпоративные каталоги, локальные службы федерации и другие службы токенов безопасности (STS), предоставляемые деловыми партнерами или социальными поставщиками удостоверений, которые могут аутентифицировать пользователей с такими учетными записями, как Microsoft, Google, Yahoo! или Facebook.

На рисунке показан шаблон федеративного удостоверения. Клиентскому приложению нужен доступ к службе, которая запрашивает аутентификацию. Ее выполняет поставщик удостоверений, который работает со службой токенов безопасности. Поставщик удостоверений издает маркеры безопасности, предоставляющие сведения об аутентифицированном пользователе. Эти сведения называются утверждениями и включают идентификатор пользователя, а также другие сведения, например членство в роли и детальные права доступа.

![Общие сведения о федеративной аутентификации](./_images/federated-identity-overview.png)


Эта модель часто называется управлением доступом на основе утверждений. Приложения и службы разрешают получать доступ к функциям и возможностям на основе утверждений, содержащихся в токене. Служба, которая требует аутентификации, должна доверять поставщику удостоверений. Клиентское приложение обращается к поставщику удостоверений, который выполняет аутентификацию. Если аутентификация успешна, поставщик удостоверений возвращает токен, содержащий утверждения, идентифицирующие пользователя в службе маркеров безопасности (обратите внимание, что поставщик удостоверений и служба маркеров безопасности могут быть одной службой). Перед возвращением клиенту служба маркеров безопасности может преобразовывать и дополнять утверждения в маркере на основе стандартных правил. Затем клиентское приложение может передать этот маркер службе как доказательство своей подлинности.

> В цепочке доверия могут существовать дополнительные службы токенов безопасности. Например, в описанном далее сценарии отношения доверия существуют между локальной службой токенов безопасности и другой службой, которая отвечает за доступ поставщика удостоверений для аутентификации пользователя. Этот подход часто встречается в корпоративных сценариях при наличии локальной службы токенов безопасности и каталога.

Федеративная аутентификация обеспечивает решение на основе стандартов для доверия идентификаторам в различных доменах. Кроме того, она может поддерживать единый вход. Этот подход все шире распространяется среди различных типов приложений, особенно размещенных в облаке, так как он поддерживает единый вход, не требующий прямого сетевого подключения для поставщиков удостоверений. Пользователю не нужно вводить учетные данные для каждого приложения. Это повышает уровень безопасности, так как предотвращает создание учетных данных, необходимых для доступа к различным приложениям. Кроме того, при этом подходе скрываются учетные данные пользователя для всех, за исключением исходного поставщика удостоверений. Приложения видят только содержащиеся в маркере сведения об удостоверении, прошедшем аутентификацию.

Федеративные удостоверения также имеют важное преимущество. Оно заключается в том, что именно поставщик удостоверений управляет удостоверениями и учетными данными. Приложению или службе не нужно управлять ими. Кроме того, в корпоративных сценариях каталог организации не должен знать о пользователе, если он доверяет поставщику удостоверений. При этом сокращаются все административные расходы на управление удостоверениями пользователей в каталоге.

## <a name="issues-and-considerations"></a>Проблемы и рекомендации

При разработке приложения, которое реализует федеративную аутентификацию, необходимо учитывать следующее:

- Аутентификация может быть единой точкой отказа. При развертывании приложения в нескольких центрах обработки данных убедитесь, что механизм управления удостоверениями развертывается в одном центре, чтобы поддержать доступность и стабильность приложения.

- Инструменты аутентификации позволяют настроить управление доступом на основе утверждений ролей, содержащихся в маркере проверки подлинности. Это часто называется управлением доступом на основе ролей (RBAC) и позволяет более эффективно контролировать доступ к компонентам и ресурсам.

- В отличие от каталогов организации аутентификация на основе утверждений, использующая поставщиков удостоверений из социальных сетей, обычно не предоставляет никаких сведений о прошедших аутентификацию пользователях, кроме адреса электронной почты и, может быть, имени. Некоторые поставщики удостоверений из социальных сетей, например из учетной записи Майкрософт, указывают лишь уникальный идентификатор. Обычно приложение должно содержать некоторые сведения о зарегистрированных пользователях и сопоставлять их с идентификатором в утверждениях токена. Это делается путем регистрации после первого доступа к приложению, а затем сведения вставляются в токен в виде дополнительных утверждений после каждой аутентификации.

- Если для службы маркеров безопасности настроено несколько поставщиков удостоверений, необходимо определить, к какому поставщику нужно перенаправить пользователей для аутентификации. Этот процесс называется обнаружением домашней области. Служба токенов безопасности может сделать это автоматически на основе адреса электронной почты или имени пользователя, предоставленными пользователем, дочернего домена приложения, к которому обращается пользователь, области IP-адресов для пользователя или содержимого файла cookie, хранящегося в браузере пользователя. Например, если пользователь ввел адрес электронной почты в домене корпорации Майкрософт user@live.com, служба токенов безопасности перенаправит его на страницу входа в учетную запись Майкрософт. В следующий раз служба токенов безопасности может использовать файл cookie, чтобы указать, что последний вход был совершен через учетную запись Майкрософт. Если при автоматическом обнаружении домашняя область не определяется, служба токенов безопасности откроет страницу обнаружения домашней области со списком доверенных поставщиков удостоверений, и пользователь должен выбрать одного из них.

## <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

Шаблон полезен в следующих случаях:

- **Единый вход в корпоративное приложение**. В этом случае необходимо выполнить аутентификацию сотрудников для корпоративных приложений, размещенных в облаке за пределами периметра безопасности организации. При этом не нужно входить в систему каждый раз при использовании приложения. Взаимодействие с пользователем будет таким же, как при использовании локальных приложений, в которых они проходили аутентификацию после входа в систему в корпоративной сети и получали доступ ко всем соответствующим приложениям без необходимости повторного входа.

- **Федеративная идентификация с несколькими участниками**. В этом случае необходимо выполнить аутентификацию для корпоративных сотрудников и деловых партнеров, не имеющих учетных записей в каталоге организации. Такое часто встречается в бизнес-приложениях, приложениях, которые интегрируются со службами сторонних производителей, а также при слиянии компаний с различными ИТ-системами или при обмене ресурсами.

- **Федеративная идентификация в приложениях SaaS**. В этом случае независимые поставщики программного обеспечения предоставляют готовые к использованию службы нескольким клиентам или арендаторам. Каждый арендатор выполняет аутентификацию с помощью подходящего поставщика удостоверений. Например, бизнес-пользователи будут использовать свои корпоративные учетные данные, а потребители и клиенты арендатора будут использовать свои учетные данные удостоверений из социальных сетей.

Этот шаблон неприменим в следующих случаях:

- Один поставщик удостоверений может выполнить аутентификацию для всех пользователей приложения, и не нужно проводить аутентификацию с использованием другого поставщика удостоверений. Такое часто встречается в бизнес-приложениях, которые используют корпоративный каталог (доступный в приложении) для аутентификации с помощью VPN или (в сценарии размещения в облаке) через подключение к виртуальной сети между локальным каталогом и приложением.

- Приложение изначально было создано с другим механизмом аутентификации, возможно, с помощью пользовательских хранилищ, или же у него нет возможности для обработки стандартов согласования, используемых технологиями на основе утверждений. Модернизация управления доступом и аутентификации на основе утверждений для имеющихся приложений может быть сложной и, возможно, невыгодной.

## <a name="example"></a>Пример

Организация размещает мультитенантное приложение SaaS в Microsoft Azure. Приложение включает веб-сайт, с помощью которого клиенты могут настраивать приложения для пользователей. Оно позволяет клиентам осуществлять доступ к веб-сайту с помощью федеративного удостоверения, созданного службами федерации Active Directory (ADFS). Это происходит, когда пользователь проходит аутентификацию Active Directory.

![Как пользователи крупного корпоративного подписчика получают доступ к приложению](./_images/federated-identity-multitenat.png)


На рисунке показано, как клиент выполняет аутентификацию с помощью собственного поставщика удостоверений службы федерации Active Directory (шаг 1). После успешной аутентификации клиента служба федерации Active Directory выдает токен. Браузер клиента перенаправляет этот токен федеративному поставщику приложения SaaS, который доверяет токенам, выданным клиентом службы федерации Active Directory, чтобы получить допустимый для поставщика федерации SaaS токен (шаг 2). При необходимости перед возвратом нового токена в клиентский браузер федеративный поставщик SaaS выполняет преобразование утверждений в токене в утверждения, которые распознает приложение (шаг 3). Приложение доверяет токенам, выданным федеративным поставщиком SaaS, и использует утверждения в токене для применения правил авторизации (шаг 4).

Клиентам не нужно запоминать отдельные учетные данные для доступа к приложению. Администратор компании клиента в своем ADFS может настроить список пользователей, которые получат доступ к приложению.

## <a name="related-guidance"></a>Связанное руководство

- [Microsoft Azure Active Directory](https://azure.microsoft.com/services/active-directory/)
- [Доменные службы Active Directory](https://msdn.microsoft.com/library/bb897402.aspx)
- [Active Directory Federation Services](https://msdn.microsoft.com/library/bb897402.aspx) (Службы федерации Active Directory)
- [Управление удостоверениями мультитенантных приложений в Microsoft Azure](https://azure.microsoft.com/documentation/articles/guidance-multitenant-identity/)
- [Мультитенантные приложения Azure](https://azure.microsoft.com/documentation/articles/dotnet-develop-multitenant-applications/)
