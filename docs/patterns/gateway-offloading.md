---
title: Схема разгрузки шлюза
titleSuffix: Cloud Design Patterns
description: Перенесение общих или специализированных функций служб на прокси-сервер шлюза.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: 50af3d8593279986ed6efee55667187424c18e56
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2019
ms.locfileid: "54010223"
---
# <a name="gateway-offloading-pattern"></a>Схема разгрузки шлюза

Перенесение общих или специализированных функций служб на прокси-сервер шлюза. Эта схема позволяет упростить разработку приложений, перемещая общие функции служб (например, использование SSL-сертификатов) из разных частей приложения в шлюз.

## <a name="context-and-problem"></a>Контекст и проблема

Некоторые компоненты традиционно используются сразу в нескольких службах. При этом для каждого из них нужно выполнять настройку, управление и обслуживание. Общая или специализированная служба, которая распространяется вместе с каждым развертыванием приложения, увеличивает административные издержки и повышает вероятность ошибки при развертывании. Все обновления общего компонента нужно развертывать во всех службах, в которых он используется.

Правильное решение проблем безопасности (проверка маркера, шифрование, управление SSL-сертификатами) и других сложных задач требует высокой квалификации разработчиков. Предположим, что необходимый для приложения сертификат нужно настраивать и развертывать во всех экземплярах приложения. Приходится следить за каждым новым развертыванием, чтобы контролировать срок действия сертификата. По истечении срока действия общего сертификата его нужно обновлять, проверять и утверждать отдельно в каждом развертывании приложения.

Для большого количества развертываний достаточно сложно развертывать и поддерживать и другие распространенные службы, например отвечающие за аутентификацию, авторизацию, ведение журналов, мониторинг или [регулирование](./throttling.md). Иногда такие компоненты следует консолидировать, чтобы снизить издержки и вероятность ошибок.

## <a name="solution"></a>Решение

Перенесите в шлюз API часть компонентов, в частности те, которые широко используются в приложении, например отвечают за управление сертификатами, аутентификацию, оконечную точку SSL, мониторинг, преобразование протоколов и регулирование.

На следующей схеме представлен шлюз API, служащий оконечной точкой для входящих SSL-подключений. Он обращается от имени исходной запрашивающей стороны ко всем HTTP-серверам, размещенным за этим шлюзом API.

 ![Схема разгрузки шлюза](./_images/gateway-offload.png)

Такая схема предоставляет следующие преимущества:

- Упрощает разработку служб, так как не нужно распространять и поддерживать для всех защищенных веб-узлов вспомогательные ресурсы, например сертификаты и настройки веб-сервера. Упрощает настройку и управление, а также повышает масштабируемость и удобство обновления служб.

- Позволяет поручить отдельным командам реализацию функций, требующих специальных навыков (например, в сфере систем безопасности). Благодаря этому основная команда разработчиков может сосредоточиться на важных функциях приложения, переложив сквозные специализированные задачи на экспертов в соответствующей области.

- Повышает согласованность при ведении журналов, а также при мониторинге запросов и ответов. Даже если служба не располагает необходимыми инструментами, минимальный уровень мониторинга и ведения журнала можно настроить прямо в шлюзе.

## <a name="issues-and-considerations"></a>Проблемы и рекомендации

- Следите за тем, чтобы для шлюза API поддерживалась высокая доступность и устойчивость к сбоям. Избавляйтесь от единых точек отказа, создавая несколько экземпляров шлюза API.
- Обеспечьте для шлюза достаточную емкость и возможность масштабирования в соответствии с потребностями приложений и конечных точек. Убедитесь, что шлюз не станет узким местом для приложения и его можно масштабировать до необходимого уровня.
- Переносите только те компоненты, которые используются во всех частях приложения, такие как функции обеспечения безопасности и (или) передачи данных.
- Ни в коем случае не переносите в шлюз API компоненты бизнес-логики.
- Чтобы отслеживать транзакции, рекомендуем внедрить идентификаторы корреляции для ведения журнала.

## <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

Используйте этот шаблон в следующих случаях:

- в развертывании приложения есть общий компонент, например сертификаты SSL или шифрование;
- есть общий для нескольких развертываний компонент, который может иметь разные требования к ресурсам, например к памяти, хранилищу или сетевым подключениям;
- нужно передать специализированной команде определенные задачи, например обеспечение сетевой безопасности, регулирование или другие проблемы границ сети.

Такая схема может не подойти, если она добавляет новые взаимозависимости между службами.

## <a name="example"></a>Пример

В следующей конфигурации как устройство для разгрузки SSL используется Nginx. Он завершает входящее подключение SSL и распределяет запросы между тремя HTTP-серверами, размещенными дальше в сети.

```console
upstream iis {
        server  10.3.0.10    max_fails=3    fail_timeout=15s;
        server  10.3.0.20    max_fails=3    fail_timeout=15s;
        server  10.3.0.30    max_fails=3    fail_timeout=15s;
}

server {
        listen 443;
        ssl on;
        ssl_certificate /etc/nginx/ssl/domain.cer;
        ssl_certificate_key /etc/nginx/ssl/domain.key;

        location / {
                set $targ iis;
                proxy_pass http://$targ;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header Host $host;
        }
}
```

## <a name="related-guidance"></a>Связанные руководства

- [Схема отдельных серверных частей для каждого интерфейса](./backends-for-frontends.md)
- [Схема агрегирования на шлюзе](./gateway-aggregation.md)
- [Схема маршрутизации шлюза](./gateway-routing.md)
