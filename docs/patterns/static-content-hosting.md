---
title: Размещение статического содержимого
description: Развертывание статического содержимого в облачной службе хранения для прямой выдачи клиенту.
keywords: конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- data-management
- design-implementation
- performance-scalability
ms.openlocfilehash: deb15001bea2598d56a2793be78bbc3e7473bdf3
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="static-content-hosting-pattern"></a>Шаблон размещения статического содержимого

[!INCLUDE [header](../_includes/header.md)]

Развертывайте статическое содержимое в облачной службе хранения, чтобы предоставлять его непосредственно клиенту. Это позволяет снизить потребность в использовании дорогостоящих вычислительных экземпляров.

## <a name="context-and-problem"></a>Контекст и проблема

Как правило, веб-приложения содержат элементы статического содержимого. Это статическое содержимое может включать HTML-страницы и другие ресурсы, такие как изображения и документы, доступные для клиента либо в составе HTML-страниц (например, встроенные изображения, таблицы стилей и клиентские файлы JavaScript), либо как отдельно загружаемые страницы (например, PDF-документы).

Хотя веб-серверы отлично настроены для оптимизации запросов путем эффективного динамического выполнения кода страницы и кэширования выводимых данных, они по-прежнему должны обрабатывать запросы на скачивание статического содержимого. Для этого задействуются циклы обработки, которые могли бы использоваться для других задач.

## <a name="solution"></a>Решение

В большинстве сред для облачного размещения можно уменьшить потребность в вычислительных экземплярах (например, использовать экземпляры меньшего размера или меньшее число экземпляров), разместив некоторые ресурсы и статические страницы приложения в службе хранения. Как правило, облачные хранилища намного дешевле, чем вычислительные экземпляры.

Основные проблемы при размещении некоторых частей приложения в службе хранения связаны c развертыванием приложения и защитой ресурсов, которые не должны быть доступны для анонимных пользователей.

## <a name="issues-and-considerations"></a>Проблемы и рекомендации

При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.

- Размещенная служба хранения должна предоставлять конечную точку HTTP, к которой пользователи смогут получать доступ для скачивания статических ресурсов. Некоторые службы хранения также поддерживают протокол HTTPS, что позволяет размещать в службах хранения ресурсы, для которых требуется протокол SSL.

- Если требуется обеспечить максимальную производительность и доступность, рекомендуем использовать сеть доставки содержимого (CDN) для кэширования содержимого контейнера хранилища в нескольких центрах обработки данных по всему миру. Но за использование CDN может взиматься плата.

- Как правило, учетные записи хранения являются геореплицируемыми по умолчанию. Это позволяет обеспечить устойчивость при возникновении событий, которые могут повлиять на работу центра обработки данных. Это означает, что IP-адрес может измениться, но URL-адрес останется тем же.

- Когда одна часть содержимого находится в учетной записи хранения, а другая — в размещенном вычислительном экземпляре, развертывание приложения и его обновление усложняется. Возможно, потребуется несколько отдельных развертываний, а также управление версиями приложения и содержимого. Это позволит упростить управление, особенно если статическое содержимое содержит файлы скриптов или компоненты пользовательского интерфейса. Но если требуется обновить только статические ресурсы, их можно просто отправить в учетную запись хранения, не развертывая пакет приложения повторно.

- Службы хранения могут не поддерживать пользовательские доменные имена. В этом случае необходимо указать полные URL-адреса ресурсов в виде ссылок, так как они будут находиться в домене, отличном от домена для динамического содержимого, содержащего ссылки.

- Контейнеры хранилища должны быть настроены для открытого доступа на чтение. Но обязательно убедитесь, что они не настроены для открытого доступа на запись, чтобы пользователи не могли отправлять содержимое. Для управления доступом к ресурсам, которые не должны быть доступны анонимно, рекомендуется использовать ключ камердинера или токен &mdash; см. статью о [шаблоне ключа камердинера](valet-key.md).

## <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

Этот шаблон можно использовать для следующих целей:

- Сокращение затрат на размещение веб-сайтов и приложений, которые содержат некоторые статические ресурсы.

- Сокращение затрат на размещение веб-сайтов, которые содержат только статическое содержимое и ресурсы. В зависимости от возможностей системы хранения поставщика услуг размещения можно разместить весь статический веб-сайт в учетной записи хранения.

- Предоставление статических ресурсов и содержимого для приложений, выполняющихся в других средах размещения или на локальных серверах.

- Расположение содержимого в нескольких географических областях с использованием сети CDN, которая позволяет кэшировать содержимое учетной записи хранения в нескольких центрах обработки данных по всему миру.

- Мониторинг затрат и использования пропускной способности. Использование отдельной учетной записи хранения для некоторого или всего статического содержимого позволяет легко отделить затраты на размещение и на среду выполнения.

Этот шаблон неприменим в следующих случаях:

- Приложение должно выполнять обработку статического содержимого перед его доставкой клиенту. Например, может потребоваться добавить метку времени в документ.

- Объем статического содержимого очень мал. Затраты на получение этого содержимого из отдельного хранилища могут превысить затраты на отделение содержимого от вычислительных ресурсов.

## <a name="example"></a>Пример

К статическому содержимому, расположенному в хранилище BLOB-объектов Azure, можно получить доступ непосредственно из браузера. Azure предоставляет интерфейс на основе HTTP для хранилища, который может быть открытым для клиентов. Например, содержимое в контейнере хранилища BLOB-объектов Azure предоставляется с использованием URL-адреса в следующем формате:

`http://[ storage-account-name ].blob.core.windows.net/[ container-name ]/[ file-name ]`


При отправке содержимого необходимо создать один или несколько контейнеров BLOB-объектов, в которых будут храниться файлы и документы. Обратите внимание, что по умолчанию для нового контейнера задано разрешение "Закрытый". Это значение нужно заменить на "Открытый", чтобы клиенты могли получить доступ к содержимому. Если требуется защитить содержимое от анонимного доступа, можно реализовать [шаблон ключа камердинера](valet-key.md). В таком случае для скачивания ресурсов пользователи должны будут предоставить допустимый токен.

> Сведения о хранилище BLOB-объектов, а также о том, как получить к нему доступ и как его использовать, см. в статье [Основные понятия службы BLOB-объектов](https://msdn.microsoft.com/library/azure/dd179376.aspx).

В ссылках на каждой странице будет указан URL-адрес ресурса, и клиент будет получать к нему доступ прямо из службы хранения. На рисунке показана доставка статических частей приложения непосредственно из службы хранения.

![Рис. 1. Доставка статических частей приложения непосредственно из службы хранения](./_images/static-content-hosting-pattern.png)


В ссылках на страницах, которые доставляются клиенту, должны указываться полные URL-адреса ресурса и контейнера BLOB-объектов. Например, страница со ссылкой на изображение в открытом контейнере может содержать следующий код HTML.

```html
<img src="http://mystorageaccount.blob.core.windows.net/myresources/image1.png"
     alt="My image" />
```

> Если ресурсы защищены с помощью ключа камердинера, например подписанного URL-адреса Azure, он должен включаться в URL-адреса в ссылках.

Решение StaticContentHosting, в котором продемонстрировано использование внешнего хранилища для статических ресурсов, доступно на сайте [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/static-content-hosting). Проект StaticContentHosting.Cloud содержит файлы конфигурации, в которых указаны учетная запись хранения и контейнер, в котором хранится статическое содержимое.

```xml
<Setting name="StaticContent.StorageConnectionString"
         value="UseDevelopmentStorage=true" />
<Setting name="StaticContent.Container" value="static-content" />
```

Класс `Settings` в файле Settings.cs проекта StaticContentHosting.Web содержит методы для извлечения этих значений и создания строкового значения, содержащего URL-адрес контейнера облачной учетной записи хранения.

```csharp
public class Settings
{
  public static string StaticContentStorageConnectionString {
    get
    {
      return RoleEnvironment.GetConfigurationSettingValue(
                              "StaticContent.StorageConnectionString");
    }
  }

  public static string StaticContentContainer
  {
    get
    {
      return RoleEnvironment.GetConfigurationSettingValue("StaticContent.Container");
    }
  }

  public static string StaticContentBaseUrl
  {
    get
    {
      var account = CloudStorageAccount.Parse(StaticContentStorageConnectionString);

      return string.Format("{0}/{1}", account.BlobEndpoint.ToString().TrimEnd('/'),
                                      StaticContentContainer.TrimStart('/'));
    }
  }
}
```

Класс `StaticContentUrlHtmlHelper` в файле StaticContentUrlHtmlHelper.cs предоставляет метод `StaticContentUrl`, который создает URL-адрес, содержащий путь к облачной учетной записи хранения, если переданный в нее URL-адрес начинается с символа (~) пути к корневой папке ASP.NET.

```csharp
public static class StaticContentUrlHtmlHelper
{
  public static string StaticContentUrl(this HtmlHelper helper, string contentPath)
  {
    if (contentPath.StartsWith("~"))
    {
      contentPath = contentPath.Substring(1);
    }

    contentPath = string.Format("{0}/{1}", Settings.StaticContentBaseUrl.TrimEnd('/'),
                                contentPath.TrimStart('/'));

    var url = new UrlHelper(helper.ViewContext.RequestContext);

    return url.Content(contentPath);
  }
}
```

Файл Index.cshtml в папке Views\Home содержит элемент изображения, использующего метод `StaticContentUrl` для создания URL-адреса для его атрибута `src`.

```html
<img src="@Html.StaticContentUrl("~/media/orderedList1.png")" alt="Test Image" />
```

## <a name="related-patterns-and-guidance"></a>Связанные шаблоны и рекомендации

- Пример, демонстрирующий этот шаблон, можно найти на сайте [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/static-content-hosting).
- [Шаблон ключа камердинера](valet-key.md). Если целевые ресурсы не должны быть доступы для анонимных пользователей, нужно обеспечить безопасность на уровне хранилища, которое содержит статическое содержимое. В статье по ссылке объясняется, как использовать токен или ключ, который позволяет клиентам с ограниченным доступом получить прямой доступ к определенному ресурсу или службе, например к размещенной в облаке службе хранения.
- Эффективный способ развертывания статического сайта в Azure описан в [блоге Infosys](http://www.infosysblogs.com/microsoft/2010/06/an_efficient_way_of_deploying.html).
- [Основные понятия службы BLOB-объектов](https://msdn.microsoft.com/library/azure/dd179376.aspx).
