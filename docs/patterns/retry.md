---
title: Retry
description: Механизм обработки ожидаемых временных сбоев, при котором приложение повторно подключается к службе или сетевому ресурсу, обращение к которым завершилось сбоем, не прерывая потока событий.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- resiliency
ms.openlocfilehash: 73fdcbcc2bd75593a4c8e33dc2259c90593e14db
ms.sourcegitcommit: 3d9ee03e2dda23753661a80c7106d1789f5223bb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2018
ms.locfileid: "29478261"
---
# <a name="retry-pattern"></a><span data-ttu-id="8e096-104">Шаблон повторов</span><span class="sxs-lookup"><span data-stu-id="8e096-104">Retry pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="8e096-105">Позвольте приложению обрабатывать временные сбои при попытке подключения к службе или сетевому ресурсу с помощью повторных попыток выполнения операции, завершившейся сбоем, открытым образом.</span><span class="sxs-lookup"><span data-stu-id="8e096-105">Enable an application to handle transient failures when it tries to connect to a service or network resource, by transparently retrying a failed operation.</span></span> <span data-ttu-id="8e096-106">Таким образом приложение станет работать стабильнее.</span><span class="sxs-lookup"><span data-stu-id="8e096-106">This can improve the stability of the application.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="8e096-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="8e096-107">Context and problem</span></span>

<span data-ttu-id="8e096-108">Приложение, которое взаимодействует с элементами, запущенными в облаке, должно быть чувствительно к временным сбоям, которые могут случаться в этой среде.</span><span class="sxs-lookup"><span data-stu-id="8e096-108">An application that communicates with elements running in the cloud has to be sensitive to the transient faults that can occur in this environment.</span></span> <span data-ttu-id="8e096-109">Сбои включают в себя кратковременную потерю сетевого подключения для компонентов и служб, временную недоступность службы или наличие времени ожидания, вызванного занятостью службы.</span><span class="sxs-lookup"><span data-stu-id="8e096-109">Faults include the momentary loss of network connectivity to components and services, the temporary unavailability of a service, or timeouts that occur when a service is busy.</span></span>

<span data-ttu-id="8e096-110">Эти ошибки часто устраняются без вмешательства со стороны пользователя, поэтому, если повторить действие через некоторый промежуток времени, оно с большой вероятностью будет выполнено успешно.</span><span class="sxs-lookup"><span data-stu-id="8e096-110">These faults are typically self-correcting, and if the action that triggered a fault is repeated after a suitable delay it's likely to be successful.</span></span> <span data-ttu-id="8e096-111">Например, с помощью службы базы данных, которая обрабатывает большое количество одновременных запросов, можно реализовать стратегию регулирования, временно отклоняющую все последующие запросы до того момента, пока рабочая нагрузка не станет менее интенсивной.</span><span class="sxs-lookup"><span data-stu-id="8e096-111">For example, a database service that's processing a large number of concurrent requests can implement a throttling strategy that temporarily rejects any further requests until its workload has eased.</span></span> <span data-ttu-id="8e096-112">Попытка подключения приложения к базе данных может завершиться сбоем, но повторная попытка подключения через некоторое время с большой вероятностью будет выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="8e096-112">An application trying to access the database might fail to connect, but if it tries again after a delay it might succeed.</span></span>

## <a name="solution"></a><span data-ttu-id="8e096-113">Решение</span><span class="sxs-lookup"><span data-stu-id="8e096-113">Solution</span></span>

<span data-ttu-id="8e096-114">В облаке временные сбои встречаются часто, поэтому приложение должно быть разработано соответствующим образом, чтобы легко и прозрачно обрабатывать эти сбои.</span><span class="sxs-lookup"><span data-stu-id="8e096-114">In the cloud, transient faults aren't uncommon and an application should be designed to handle them elegantly and transparently.</span></span> <span data-ttu-id="8e096-115">Это сводит к минимуму воздействие сбоев на бизнес-задачи, которые выполняет приложение.</span><span class="sxs-lookup"><span data-stu-id="8e096-115">This minimizes the effects faults can have on the business tasks the application is performing.</span></span>

<span data-ttu-id="8e096-116">Если приложение обнаруживает сбой при попытке отправить запрос к удаленной службе, оно может обработать этот сбой с помощью стратегий ниже:</span><span class="sxs-lookup"><span data-stu-id="8e096-116">If an application detects a failure when it tries to send a request to a remote service, it can handle the failure using the following strategies:</span></span>

- <span data-ttu-id="8e096-117">**Отмена**.</span><span class="sxs-lookup"><span data-stu-id="8e096-117">**Cancel**.</span></span> <span data-ttu-id="8e096-118">Если ошибка указывает, что сбой является не временным или при повторной попытке его обработка не будет успешной, приложение должно отменить операцию и сформировать отчет об исключении.</span><span class="sxs-lookup"><span data-stu-id="8e096-118">If the fault indicates that the failure isn't transient or is unlikely to be successful if repeated, the application should cancel the operation and report an exception.</span></span> <span data-ttu-id="8e096-119">Например, сбой аутентификации, вызванный предоставлением неверных учетных данных, не завершится успешно, независимо от количества повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="8e096-119">For example, an authentication failure caused by providing invalid credentials is not likely to succeed no matter how many times it's attempted.</span></span>

- <span data-ttu-id="8e096-120">**Повтор**.</span><span class="sxs-lookup"><span data-stu-id="8e096-120">**Retry**.</span></span> <span data-ttu-id="8e096-121">Если определенная ошибка в отчете является нестандартной или редкой, вероятнее всего, она вызвана непредвиденными обстоятельствами, например повреждением сетевого пакета во время его передачи.</span><span class="sxs-lookup"><span data-stu-id="8e096-121">If the specific fault reported is unusual or rare, it might have been caused by unusual circumstances such as a network packet becoming corrupted while it was being transmitted.</span></span> <span data-ttu-id="8e096-122">В этом случае приложение может попытаться сразу же снова отправить запрос, завершившийся сбоем, так как маловероятно, что этот сбой повторится, и запрос, скорее всего, завершится успешно.</span><span class="sxs-lookup"><span data-stu-id="8e096-122">In this case, the application could retry the failing request again immediately because the same failure is unlikely to be repeated and the request will probably be successful.</span></span>

- <span data-ttu-id="8e096-123">**Повтор через некоторое время.**</span><span class="sxs-lookup"><span data-stu-id="8e096-123">**Retry after delay.**</span></span> <span data-ttu-id="8e096-124">Если сбой вызван одной из множества распространенных проблем с подключением или занятостью, сети или службе может потребоваться короткий промежуток на устранение ошибок подключения или удаления списка невыполненных работ.</span><span class="sxs-lookup"><span data-stu-id="8e096-124">If the fault is caused by one of the more commonplace connectivity or busy failures, the network or service might need a short period while the connectivity issues are corrected or the backlog of work is cleared.</span></span> <span data-ttu-id="8e096-125">По истечении необходимого времени приложение повторно выполнит запрос.</span><span class="sxs-lookup"><span data-stu-id="8e096-125">The application should wait for a suitable time before retrying the request.</span></span>

<span data-ttu-id="8e096-126">Для более распространенных временных сбоев период между повторными попытками следует выбирать с учетом максимально равномерного распределения запросов из нескольких экземпляров приложения.</span><span class="sxs-lookup"><span data-stu-id="8e096-126">For the more common transient failures, the period between retries should be chosen to spread requests from multiple instances of the application as evenly as possible.</span></span> <span data-ttu-id="8e096-127">Это снижает вероятность перегрузки занятой службы.</span><span class="sxs-lookup"><span data-stu-id="8e096-127">This reduces the chance of a busy service continuing to be overloaded.</span></span> <span data-ttu-id="8e096-128">Если несколько экземпляров приложения постоянно перегружают службу запросами повторных попыток, этой службе потребуется больше времени на восстановление.</span><span class="sxs-lookup"><span data-stu-id="8e096-128">If many instances of an application are continually overwhelming a service with retry requests, it'll take the service longer to recover.</span></span>

<span data-ttu-id="8e096-129">Если запрос по-прежнему завершается сбоем, приложение может ожидать некоторое время, а затем повторит попытку.</span><span class="sxs-lookup"><span data-stu-id="8e096-129">If the request still fails, the application can wait and make another attempt.</span></span> <span data-ttu-id="8e096-130">При необходимости этот процесс может повторяться с увеличением задержки между повторными попытками, пока не будет выполнено максимальное число запросов.</span><span class="sxs-lookup"><span data-stu-id="8e096-130">If necessary, this process can be repeated with increasing delays between retry attempts, until some maximum number of requests have been attempted.</span></span> <span data-ttu-id="8e096-131">Задержку можно увеличить последовательно или экспоненциально, в зависимости от типа сбоя и вероятности его устранения в течение этого времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="8e096-131">The delay can be increased incrementally or exponentially, depending on the type of failure and the probability that it'll be corrected during this time.</span></span>

<span data-ttu-id="8e096-132">На схеме ниже показан вызов операции в размещенной службе по этому шаблону.</span><span class="sxs-lookup"><span data-stu-id="8e096-132">The following diagram illustrates invoking an operation in a hosted service using this pattern.</span></span> <span data-ttu-id="8e096-133">Если после определенного числа попыток запрос завершается сбоем, приложение должно обработать ошибку как исключение соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="8e096-133">If the request is unsuccessful after a predefined number of attempts, the application should treat the fault as an exception and handle it accordingly.</span></span>

![Рис. 1. Вызов операции в размещенной службе с использованием шаблона повторов](./_images/retry-pattern.png)

<span data-ttu-id="8e096-135">Приложение должно перенести все попытки доступа к удаленной службе в код, который реализует политику повторов, соответствующую одной из стратегий выше.</span><span class="sxs-lookup"><span data-stu-id="8e096-135">The application should wrap all attempts to access a remote service in code that implements a retry policy matching one of the strategies listed above.</span></span> <span data-ttu-id="8e096-136">Запросы, отправленные в разные службы, могут относиться к различным политикам.</span><span class="sxs-lookup"><span data-stu-id="8e096-136">Requests sent to different services can be subject to different policies.</span></span> <span data-ttu-id="8e096-137">Некоторые поставщики предоставляют библиотеки, которые реализуют политики повторных попыток, где приложение может указывать максимальное число повторных попыток, время между этими попытками и другие параметры.</span><span class="sxs-lookup"><span data-stu-id="8e096-137">Some vendors provide libraries that implement retry policies, where the application can specify the maximum number of retries, the time between retry attempts, and other parameters.</span></span>

<span data-ttu-id="8e096-138">Приложение должно записывать в журнал подробные сведения об ошибках и невыполненных операциях.</span><span class="sxs-lookup"><span data-stu-id="8e096-138">An application should log the details of faults and failing operations.</span></span> <span data-ttu-id="8e096-139">Эти сведения полезны для операторов.</span><span class="sxs-lookup"><span data-stu-id="8e096-139">This information is useful to operators.</span></span> <span data-ttu-id="8e096-140">Если служба часто недоступна или занята, зачастую это происходит из-за того, что служба исчерпала свои ресурсы.</span><span class="sxs-lookup"><span data-stu-id="8e096-140">If a service is frequently unavailable or busy, it's often because the service has exhausted its resources.</span></span> <span data-ttu-id="8e096-141">Такие ошибки будут возникать реже, если развернуть службу.</span><span class="sxs-lookup"><span data-stu-id="8e096-141">You can reduce the frequency of these faults by scaling out the service.</span></span> <span data-ttu-id="8e096-142">Например, если служба базы данных постоянно перегружена, полезно разделить базу данных и распределить нагрузку между несколькими серверами.</span><span class="sxs-lookup"><span data-stu-id="8e096-142">For example, if a database service is continually overloaded, it might be beneficial to partition the database and spread the load across multiple servers.</span></span>

> <span data-ttu-id="8e096-143">[Microsoft Entity Framework](https://docs.microsoft.com/ef/) предоставляет инструменты для повторного выполнения операций в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e096-143">[Microsoft Entity Framework](https://docs.microsoft.com/ef/) provides facilities for retrying database operations.</span></span> <span data-ttu-id="8e096-144">Большинство служб Azure и клиентских пакетов SDK также содержат механизм повтора.</span><span class="sxs-lookup"><span data-stu-id="8e096-144">Also, most Azure services and client SDKs include a retry mechanism.</span></span> <span data-ttu-id="8e096-145">Дополнительные сведения см. в статье, посвященной [конкретным рекомендациям по использованию механизма повторов](https://docs.microsoft.com/azure/architecture/best-practices/retry-service-specific).</span><span class="sxs-lookup"><span data-stu-id="8e096-145">For more information, see [Retry guidance for specific services](https://docs.microsoft.com/azure/architecture/best-practices/retry-service-specific).</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="8e096-146">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="8e096-146">Issues and considerations</span></span>

<span data-ttu-id="8e096-147">При выборе схемы реализации этого шаблона следует учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="8e096-147">You should consider the following points when deciding how to implement this pattern.</span></span>

<span data-ttu-id="8e096-148">Политика повтора должна быть настроена в соответствии с бизнес-требованиями приложения и типами сбоя.</span><span class="sxs-lookup"><span data-stu-id="8e096-148">The retry policy should be tuned to match the business requirements of the application and the nature of the failure.</span></span> <span data-ttu-id="8e096-149">Некоторые некритические операции лучше настроить так, чтобы они завершались при первой ошибке, так как выполнение нескольких повторных попыток снижает пропускную способность приложения.</span><span class="sxs-lookup"><span data-stu-id="8e096-149">For some noncritical operations, it's better to fail fast rather than retry several times and impact the throughput of the application.</span></span> <span data-ttu-id="8e096-150">Например, в интерактивном веб-приложении, которое получает доступ к удаленной службе, лучше завершить сбоем несколько повторных попыток с небольшой задержкой между ними и отобразить соответствующее сообщение для пользователя (например, "Повторите попытку позже").</span><span class="sxs-lookup"><span data-stu-id="8e096-150">For example, in an interactive web application accessing a remote service, it's better to fail after a smaller number of retries with only a short delay between retry attempts, and display a suitable message to the user (for example, “please try again later”).</span></span> <span data-ttu-id="8e096-151">Для приложения пакета более подходящим вариантом является увеличение количества повторных попыток с экспоненциальным увеличением задержки между ними.</span><span class="sxs-lookup"><span data-stu-id="8e096-151">For a batch application, it might be more appropriate to increase the number of retry attempts with an exponentially increasing delay between attempts.</span></span>

<span data-ttu-id="8e096-152">Интенсивная политика повтора с минимальной задержкой между попытками и большое число повторных попыток может еще больше снизить производительность максимально занятой службы или службы с нагрузкой, близкой к максимальной.</span><span class="sxs-lookup"><span data-stu-id="8e096-152">An aggressive retry policy with minimal delay between attempts, and a large number of retries, could further degrade a busy service that's running close to or at capacity.</span></span> <span data-ttu-id="8e096-153">Эта политика повтора также может повлиять на скорость реагирования приложения, если оно непрерывно пытается выполнить операцию, завершившуюся сбоем.</span><span class="sxs-lookup"><span data-stu-id="8e096-153">This retry policy could also affect the responsiveness of the application if it's continually trying to perform a failing operation.</span></span>

<span data-ttu-id="8e096-154">Если после достаточного количества повторных попыток запрос по-прежнему завершается сбоем, приложению лучше предотвратить отправку запросов к тому же ресурсу и просто сразу сформировать отчет о сбое.</span><span class="sxs-lookup"><span data-stu-id="8e096-154">If a request still fails after a significant number of retries, it's better for the application to prevent further requests going to the same resource and simply report a failure immediately.</span></span> <span data-ttu-id="8e096-155">По истечении периода ожидания приложение может отправить еще несколько запросов, чтобы проверить, будут ли они успешны.</span><span class="sxs-lookup"><span data-stu-id="8e096-155">When the period expires, the application can tentatively allow one or more requests through to see whether they're successful.</span></span> <span data-ttu-id="8e096-156">Дополнительные сведения об этой стратегии см. в статье, посвященной [шаблону автоматического выключения](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="8e096-156">For more details of this strategy, see the [Circuit Breaker pattern](circuit-breaker.md).</span></span>

<span data-ttu-id="8e096-157">Рассмотрим вопрос идемпотентности операции.</span><span class="sxs-lookup"><span data-stu-id="8e096-157">Consider whether the operation is idempotent.</span></span> <span data-ttu-id="8e096-158">Если она является идемпотентной, выполнение повторной попытки безопасно.</span><span class="sxs-lookup"><span data-stu-id="8e096-158">If so, it's inherently safe to retry.</span></span> <span data-ttu-id="8e096-159">В противном случае повторные попытки могут вызвать дополнительное количество выполнений операции с непредвиденными побочными эффектами.</span><span class="sxs-lookup"><span data-stu-id="8e096-159">Otherwise, retries could cause the operation to be executed more than once, with unintended side effects.</span></span> <span data-ttu-id="8e096-160">Например, служба может принять запрос, успешно обработать его, но отправка ответа завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="8e096-160">For example, a service might receive the request, process the request successfully, but fail to send a response.</span></span> <span data-ttu-id="8e096-161">На этом этапе логика повторных попыток может повторно отправить запрос, предполагая, что не был получен первый.</span><span class="sxs-lookup"><span data-stu-id="8e096-161">At that point, the retry logic might re-send the request, assuming that the first request wasn't received.</span></span>

<span data-ttu-id="8e096-162">Запрос к службе может завершиться ошибкой в силу ряда причин, вызывающих различные исключения в зависимости от характера сбоя.</span><span class="sxs-lookup"><span data-stu-id="8e096-162">A request to a service can fail for a variety of reasons raising different exceptions depending on the nature of the failure.</span></span> <span data-ttu-id="8e096-163">Некоторые исключения указывают на сбой, который можно быстро устранить, в то время как другие указывают, что на устранение сбоя потребуется больше времени.</span><span class="sxs-lookup"><span data-stu-id="8e096-163">Some exceptions indicate a failure that can be resolved quickly, while others indicate that the failure is longer lasting.</span></span> <span data-ttu-id="8e096-164">Для политики повтора полезно регулировать время между попытками повтора в зависимости от типа исключения.</span><span class="sxs-lookup"><span data-stu-id="8e096-164">It's useful for the retry policy to adjust the time between retry attempts based on the type of the exception.</span></span>

<span data-ttu-id="8e096-165">Рассмотрим, как повторное выполнение операции, являющейся частью транзакции, повлияет на общую согласованность транзакций.</span><span class="sxs-lookup"><span data-stu-id="8e096-165">Consider how retrying an operation that's part of a transaction will affect the overall transaction consistency.</span></span> <span data-ttu-id="8e096-166">Настройте соответствующим образом политику повтора для операций транзакций, чтобы увеличить вероятность успеха и устранить необходимость обхода всех шагов выполнения транзакции.</span><span class="sxs-lookup"><span data-stu-id="8e096-166">Fine tune the retry policy for transactional operations to maximize the chance of success and reduce the need to undo all the transaction steps.</span></span>

<span data-ttu-id="8e096-167">Полностью протестируйте весь код повторных попыток для ряда условий сбоя.</span><span class="sxs-lookup"><span data-stu-id="8e096-167">Ensure that all retry code is fully tested against a variety of failure conditions.</span></span> <span data-ttu-id="8e096-168">Код не должен значительно влиять на производительность или надежность приложения, вызывать чрезмерную нагрузку на службы или ресурсы или создавать состояния гонки или узкие места.</span><span class="sxs-lookup"><span data-stu-id="8e096-168">Check that it doesn't severely impact the performance or reliability of the application, cause excessive load on services and resources, or generate race conditions or bottlenecks.</span></span>

<span data-ttu-id="8e096-169">Реализуйте логику повторных попыток только в тех расположениях, в которых полностью предусмотрен контекст операций, которые могут завершиться сбоем.</span><span class="sxs-lookup"><span data-stu-id="8e096-169">Implement retry logic only where the full context of a failing operation is understood.</span></span> <span data-ttu-id="8e096-170">Например, если задача, которая содержит политику повтора, вызывает другую задачу, которая также содержит эту политику, этот дополнительный уровень повторных попыток может вызвать дополнительную задержку обработки.</span><span class="sxs-lookup"><span data-stu-id="8e096-170">For example, if a task that contains a retry policy invokes another task that also contains a retry policy, this extra layer of retries can add long delays to the processing.</span></span> <span data-ttu-id="8e096-171">Мы рекомендуем настроить задачу более низкого уровня для завершения работы при первой ошибке и формирования отчета о причине сбоя для задачи, которая его вызвала.</span><span class="sxs-lookup"><span data-stu-id="8e096-171">It might be better to configure the lower-level task to fail fast and report the reason for the failure back to the task that invoked it.</span></span> <span data-ttu-id="8e096-172">Эта задача более высокого уровня затем может обработать сбой на основе собственной политики.</span><span class="sxs-lookup"><span data-stu-id="8e096-172">This higher-level task can then handle the failure based on its own policy.</span></span>

<span data-ttu-id="8e096-173">Важно записывать в журнал все сбои подключения, которые вызывают повторные попытки, чтобы определить основные проблемы приложения, служб и ресурсов.</span><span class="sxs-lookup"><span data-stu-id="8e096-173">It's important to log all connectivity failures that cause a retry so that underlying problems with the application, services, or resources can be identified.</span></span>

<span data-ttu-id="8e096-174">Проанализируйте сбои, которые вероятнее всего могут возникнуть в службе или ресурсе, чтобы понять, являются ли они продолжительными или временными,</span><span class="sxs-lookup"><span data-stu-id="8e096-174">Investigate the faults that are most likely to occur for a service or a resource to discover if they're likely to be long lasting or terminal.</span></span> <span data-ttu-id="8e096-175">что значит, что в таком случае сбой лучше обработать как исключение.</span><span class="sxs-lookup"><span data-stu-id="8e096-175">If they are, it's better to handle the fault as an exception.</span></span> <span data-ttu-id="8e096-176">Исключение можно вывести в отчет или журнал, затем приложение может повторить попытку, вызвав другую службу (если она доступна), или продолжать работать в режиме ограниченной функциональности.</span><span class="sxs-lookup"><span data-stu-id="8e096-176">The application can report or log the exception, and then try to continue either by invoking an alternative service (if one is available), or by offering degraded functionality.</span></span> <span data-ttu-id="8e096-177">Дополнительные сведения о том, как обнаружить и обработать длительные сбои, см. в статье, посвященной [шаблону автоматического выключения](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="8e096-177">For more information on how to detect and handle long-lasting faults, see the [Circuit Breaker pattern](circuit-breaker.md).</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="8e096-178">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="8e096-178">When to use this pattern</span></span>

<span data-ttu-id="8e096-179">Используйте этот шаблон в случае временных сбоев приложения, так как он взаимодействует с удаленной службой или обращается к удаленному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="8e096-179">Use this pattern when an application could experience transient faults as it interacts with a remote service or accesses a remote resource.</span></span> <span data-ttu-id="8e096-180">Предполагается, что эти сбои будут непродолжительными, и следующая попытка повтора запроса, завершившегося ранее сбоем, будет успешна.</span><span class="sxs-lookup"><span data-stu-id="8e096-180">These faults are expected to be short lived, and repeating a request that has previously failed could succeed on a subsequent attempt.</span></span>

<span data-ttu-id="8e096-181">Этот шаблон может оказаться неэффективным в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="8e096-181">This pattern might not be useful:</span></span>

- <span data-ttu-id="8e096-182">Если предполагается длительный сбой, так как он может повлиять на скорость реагирования приложения.</span><span class="sxs-lookup"><span data-stu-id="8e096-182">When a fault is likely to be long lasting, because this can affect the responsiveness of an application.</span></span> <span data-ttu-id="8e096-183">Приложение может пытаться повторить запрос, который, вероятнее всего, завершится сбоем, напрасно используя время и ресурсы.</span><span class="sxs-lookup"><span data-stu-id="8e096-183">The application might be wasting time and resources trying to repeat a request that's likely to fail.</span></span>
- <span data-ttu-id="8e096-184">Для обработки сбоев, вызванных не временными ошибками, например внутренних исключений, вызванных ошибками в бизнес-логике приложения.</span><span class="sxs-lookup"><span data-stu-id="8e096-184">For handling failures that aren't due to transient faults, such as internal exceptions caused by errors in the business logic of an application.</span></span>
- <span data-ttu-id="8e096-185">Как альтернатива устранения проблем масштабируемости в системе.</span><span class="sxs-lookup"><span data-stu-id="8e096-185">As an alternative to addressing scalability issues in a system.</span></span> <span data-ttu-id="8e096-186">Если в приложении часто возникают сбои, связанные с занятостью, вероятнее всего, это говорит о том, что необходимо масштабировать службу или ресурс, к которому направлен запрос.</span><span class="sxs-lookup"><span data-stu-id="8e096-186">If an application experiences frequent busy faults, it's often a sign that the service or resource being accessed should be scaled up.</span></span>

## <a name="example"></a><span data-ttu-id="8e096-187">Пример</span><span class="sxs-lookup"><span data-stu-id="8e096-187">Example</span></span>

<span data-ttu-id="8e096-188">В этом примере на C# показана реализация шаблона повторов.</span><span class="sxs-lookup"><span data-stu-id="8e096-188">This example in C# illustrates an implementation of the Retry pattern.</span></span> <span data-ttu-id="8e096-189">Метод `OperationWithBasicRetryAsync` ниже асинхронно вызывает внешнюю службу с помощью метода `TransientOperationAsync`.</span><span class="sxs-lookup"><span data-stu-id="8e096-189">The `OperationWithBasicRetryAsync` method, shown below, invokes an external service asynchronously through the `TransientOperationAsync` method.</span></span> <span data-ttu-id="8e096-190">Выходные данные метода `TransientOperationAsync` будут относиться к конкретной службе и исключены из примера кода.</span><span class="sxs-lookup"><span data-stu-id="8e096-190">The details of the `TransientOperationAsync` method will be specific to the service and are omitted from the sample code.</span></span>

```csharp
private int retryCount = 3;
private readonly TimeSpan delay = TimeSpan.FromSeconds(5);

public async Task OperationWithBasicRetryAsync()
{
  int currentRetry = 0;

  for (;;)
  {
    try
    {
      // Call external service.
      await TransientOperationAsync();

      // Return or break.
      break;
    }
    catch (Exception ex)
    {
      Trace.TraceError("Operation Exception");

      currentRetry++;

      // Check if the exception thrown was a transient exception
      // based on the logic in the error detection strategy.
      // Determine whether to retry the operation, as well as how
      // long to wait, based on the retry strategy.
      if (currentRetry > this.retryCount || !IsTransient(ex))
      {
        // If this isn't a transient error or we shouldn't retry, 
        // rethrow the exception.
        throw;
      }
    }

    // Wait to retry the operation.
    // Consider calculating an exponential delay here and
    // using a strategy best suited for the operation and fault.
    await Task.Delay(delay);
  }
}

// Async method that wraps a call to a remote service (details not shown).
private async Task TransientOperationAsync()
{
  ...
}
```

<span data-ttu-id="8e096-191">Инструкция, вызывающая этот метод, содержится в блоке try-catch, выполняющемся с помощью цикла for.</span><span class="sxs-lookup"><span data-stu-id="8e096-191">The statement that invokes this method is contained in a try/catch block wrapped in a for loop.</span></span> <span data-ttu-id="8e096-192">Цикл for создается при успешном завершении вызова метода `TransientOperationAsync` без исключения.</span><span class="sxs-lookup"><span data-stu-id="8e096-192">The for loop exits if the call to the `TransientOperationAsync` method succeeds without throwing an exception.</span></span> <span data-ttu-id="8e096-193">Если вызов метода `TransientOperationAsync` завершается сбоем, блок catch анализирует причину сбоя.</span><span class="sxs-lookup"><span data-stu-id="8e096-193">If the `TransientOperationAsync` method fails, the catch block examines the reason for the failure.</span></span> <span data-ttu-id="8e096-194">Если предполагается временная ошибка, после небольшой задержки операция выполняется повторно в коде.</span><span class="sxs-lookup"><span data-stu-id="8e096-194">If it's believed to be a transient error the code waits for a short delay before retrying the operation.</span></span>

<span data-ttu-id="8e096-195">Этот цикл также отслеживает количество повторов выполнения операции. Если три попытки выполнения завершаются сбоем, предполагается длительное исключение.</span><span class="sxs-lookup"><span data-stu-id="8e096-195">The for loop also tracks the number of times that the operation has been attempted, and if the code fails three times the exception is assumed to be more long lasting.</span></span> <span data-ttu-id="8e096-196">Если исключение не является временным или является длительным, обработчик блока catch выдает исключение.</span><span class="sxs-lookup"><span data-stu-id="8e096-196">If the exception isn't transient or it's long lasting, the catch handler throws an exception.</span></span> <span data-ttu-id="8e096-197">Это исключение выходит из цикла for, и его перехватывает код, вызывающий метод `OperationWithBasicRetryAsync`.</span><span class="sxs-lookup"><span data-stu-id="8e096-197">This exception exits the for loop and should be caught by the code that invokes the `OperationWithBasicRetryAsync` method.</span></span>

<span data-ttu-id="8e096-198">Метод `IsTransient` ниже проверяет определенный набор исключений, соответствующих среде, в которой выполняется код.</span><span class="sxs-lookup"><span data-stu-id="8e096-198">The `IsTransient` method, shown below, checks for a specific set of exceptions that are relevant to the environment the code is run in.</span></span> <span data-ttu-id="8e096-199">Определение временного исключения будет различаться в зависимости от соответствующих ресурсов и среды, в которой выполняется операция.</span><span class="sxs-lookup"><span data-stu-id="8e096-199">The definition of a transient exception will vary according to the resources being accessed and the environment the operation is being performed in.</span></span>

```csharp
private bool IsTransient(Exception ex)
{
  // Determine if the exception is transient.
  // In some cases this is as simple as checking the exception type, in other
  // cases it might be necessary to inspect other properties of the exception.
  if (ex is OperationTransientException)
    return true;

  var webException = ex as WebException;
  if (webException != null)
  {
    // If the web exception contains one of the following status values
    // it might be transient.
    return new[] {WebExceptionStatus.ConnectionClosed,
                  WebExceptionStatus.Timeout,
                  WebExceptionStatus.RequestCanceled }.
            Contains(webException.Status);
  }

  // Additional exception checking logic goes here.
  return false;
}
```

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="8e096-200">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="8e096-200">Related patterns and guidance</span></span>

- <span data-ttu-id="8e096-201">[Шаблон прерывателя](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="8e096-201">[Circuit Breaker pattern](circuit-breaker.md).</span></span> <span data-ttu-id="8e096-202">Шаблон повторов эффективен для обработки временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="8e096-202">The Retry pattern is useful for handling transient faults.</span></span> <span data-ttu-id="8e096-203">Если предполагается длительный сбой, лучше реализовать шаблон автоматического выключения.</span><span class="sxs-lookup"><span data-stu-id="8e096-203">If a failure is expected to be more long lasting, it might be more appropriate to implement the Circuit Breaker pattern.</span></span> <span data-ttu-id="8e096-204">Шаблон повторов можно также использовать в сочетании с автоматическим выключением для обеспечения комплексного подхода к обработке сбоев.</span><span class="sxs-lookup"><span data-stu-id="8e096-204">The Retry pattern can also be used in conjunction with a circuit breaker to provide a comprehensive approach to handling faults.</span></span>
- <span data-ttu-id="8e096-205">[Retry guidance for specific services](https://docs.microsoft.com/azure/architecture/best-practices/retry-service-specific) (Руководство о механизме повторов для отдельных служб)</span><span class="sxs-lookup"><span data-stu-id="8e096-205">[Retry guidance for specific services](https://docs.microsoft.com/azure/architecture/best-practices/retry-service-specific)</span></span>
- <span data-ttu-id="8e096-206">[Connection Resiliency](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency) (Устойчивость подключения)</span><span class="sxs-lookup"><span data-stu-id="8e096-206">[Connection Resiliency](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency)</span></span>
