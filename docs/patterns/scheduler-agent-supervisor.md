---
title: "\"Планировщик, агент, контролер\""
description: "Координируйте ряд действий в распределенном наборе служб и других удаленных ресурсов."
keywords: "конструктивный шаблон"
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- messaging
- resiliency
ms.openlocfilehash: 03bfe2fe96b3b81d547cfedb075bcf855846b668
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="scheduler-agent-supervisor-pattern"></a><span data-ttu-id="9fb8f-104">Шаблон супервизора агента планировщика</span><span class="sxs-lookup"><span data-stu-id="9fb8f-104">Scheduler Agent Supervisor pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="9fb8f-105">Координируйте набор распределенных действий как единую операцию.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-105">Coordinate a set of distributed actions as a single operation.</span></span> <span data-ttu-id="9fb8f-106">Если любое из действий завершится сбоем, постарайтесь обработать этот сбой, не затрагивая остальные действия. Если это невозможно, отмените всю выполненную работу. Вся операция в целом должна завершаться успешно или не выполняться совсем.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-106">If any of the actions fail, try to handle the failures transparently, or else undo the work that was performed, so the entire operation succeeds or fails as a whole.</span></span> <span data-ttu-id="9fb8f-107">Это повысит устойчивость распределенной системы, позволяя восстановить и повторить действия, завершившиеся сбоем из-за временных исключений, длительных проблем или ошибок в процессах.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-107">This can add resiliency to a distributed system, by enabling it to recover and retry actions that fail due to transient exceptions, long-lasting faults, and process failures.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="9fb8f-108">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="9fb8f-108">Context and problem</span></span>

<span data-ttu-id="9fb8f-109">Приложение выполняет задачи, содержащие ряд шагов. Некоторые из них могут вызывать удаленные службы или обращаться к удаленным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-109">An application performs tasks that include a number of steps, some of which might invoke remote services or access remote resources.</span></span> <span data-ttu-id="9fb8f-110">Отдельные шаги могут быть независимы друг от друга, но они подчиняются логике приложения, которая реализует задачу.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-110">The individual steps might be independent of each other, but they are orchestrated by the application logic that implements the task.</span></span>

<span data-ttu-id="9fb8f-111">Везде, где это возможно, приложение должно проверить, полностью ли выполнена задача, и устранить любые возможные сбои при доступе к удаленным службам или ресурсам.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-111">Whenever possible, the application should ensure that the task runs to completion and resolve any failures that might occur when accessing remote services or resources.</span></span> <span data-ttu-id="9fb8f-112">Сбои могут возникать по многим причинам.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-112">Failures can occur for many reasons.</span></span> <span data-ttu-id="9fb8f-113">Это может быть нарушение работы сети, разрыв подключения, нестабильность или отсутствие ответа от удаленной службы либо временная недоступность удаленного ресурса (например, из-за превышения установленных ограничений).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-113">For example, the network might be down, communications could be interrupted, a remote service might be unresponsive or in an unstable state, or a remote resource might be temporarily inaccessible, perhaps due to resource constraints.</span></span> <span data-ttu-id="9fb8f-114">В большинстве случаев это временные ошибки, для устранения которых можно применить [шаблон повторения][retry-pattern].</span><span class="sxs-lookup"><span data-stu-id="9fb8f-114">In many cases the failures will be transient and can be handled by using the [Retry pattern][retry-pattern].</span></span>

<span data-ttu-id="9fb8f-115">Если в приложении возникает постоянный сбой, который непросто устранить, оно должно иметь возможность восстановить систему до стабильного состояния и обеспечить целостность всей операции.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-115">If the application detects a more permanent fault it can't easily recover from, it must be able to restore the system to a consistent state and ensure integrity of the entire operation.</span></span>

## <a name="solution"></a><span data-ttu-id="9fb8f-116">Решение</span><span class="sxs-lookup"><span data-stu-id="9fb8f-116">Solution</span></span>

<span data-ttu-id="9fb8f-117">Шаблон "планировщик, агент, контролер" определяет следующие субъекты.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-117">The Scheduler Agent Supervisor pattern defines the following actors.</span></span> <span data-ttu-id="9fb8f-118">Эти субъекты координируют действия, выполняемые в составе общей задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-118">These actors orchestrate the steps to be performed as part of the overall task.</span></span>

- <span data-ttu-id="9fb8f-119">**Планировщик** упорядочивает действия, входящие в выполняемую задачу, и координирует их работу.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-119">The **Scheduler** arranges for the steps that make up the task to be executed and orchestrates their operation.</span></span> <span data-ttu-id="9fb8f-120">Эти действия могут объединяться в конвейер или рабочий процесс.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-120">These steps can be combined into a pipeline or workflow.</span></span> <span data-ttu-id="9fb8f-121">Планировщик отвечает за то, чтобы все действия в таком рабочем процессе выполнялись в правильном порядке.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-121">The Scheduler is responsible for ensuring that the steps in this workflow are performed in the right order.</span></span> <span data-ttu-id="9fb8f-122">По мере выполнения отдельных шагов планировщик регистрирует состояние рабочего процесса, например: "шаг еще не начат", "шаг выполняется", "шаг завершен" и т. п.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-122">As each step is performed, the Scheduler records the state of the workflow, such as "step not yet started," "step running," or "step completed."</span></span> <span data-ttu-id="9fb8f-123">Сведения о состоянии также содержат максимальное значение времени, выделенного для выполнения шага.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-123">The state information should also include an upper limit of the time allowed for the step to finish, called the complete-by time.</span></span> <span data-ttu-id="9fb8f-124">Если на определенном шаге требуется доступ к удаленной службе или ресурсу, планировщик вызывает соответствующий агент и передает ему сведения о работе, которую следует выполнить.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-124">If a step requires access to a remote service or resource, the Scheduler invokes the appropriate Agent, passing it the details of the work to be performed.</span></span> <span data-ttu-id="9fb8f-125">Планировщик обычно взаимодействует с агентом посредством асинхронного обмена сообщениями (запрос — ответ).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-125">The Scheduler typically communicates with an Agent using asynchronous request/response messaging.</span></span> <span data-ttu-id="9fb8f-126">Для этого можно применить механизм очередей или любые другие технологии распределенного обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-126">This can be implemented using queues, although other distributed messaging technologies could be used instead.</span></span>

    > <span data-ttu-id="9fb8f-127">Планировщик выполняет примерно такие же функции, как и диспетчер процессов в [шаблоне диспетчера процессов](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-127">The Scheduler performs a similar function to the Process Manager in the [Process Manager pattern](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span></span> <span data-ttu-id="9fb8f-128">Фактический рабочий процесс обычно определяется и реализуется обработчиком рабочего процесса, которым управляет планировщик.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-128">The actual workflow is typically defined and implemented by a workflow engine that's controlled by the Scheduler.</span></span> <span data-ttu-id="9fb8f-129">Такой подход позволяет отделить от планировщика бизнес-логику рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-129">This approach decouples the business logic in the workflow from the Scheduler.</span></span>

- <span data-ttu-id="9fb8f-130">**Агент** содержит логику, в которой заключен вызов удаленной службы или доступ к удаленному ресурсу, на которые ссылается шаг задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-130">The **Agent** contains logic that encapsulates a call to a remote service, or access to a remote resource referenced by a step in a task.</span></span> <span data-ttu-id="9fb8f-131">Каждый агент обычно служит оболочкой для вызова одной службы или ресурса. В нем же реализуется логика повторов и обработки ошибок (с учетом ограничений по времени ожидания, которые описаны ниже).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-131">Each Agent typically wraps calls to a single service or resource, implementing the appropriate error handling and retry logic (subject to a timeout constraint, described later).</span></span> <span data-ttu-id="9fb8f-132">Если в рабочем процессе, который выполняется планировщиком, некоторые службы и ресурсы используются несколько раз на разных шагах, эти шаги могут ссылаться на разные агенты (это зависит от реализации шаблона).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-132">If the steps in the workflow being run by the Scheduler use several services and resources across different steps, each step might reference a different Agent (this is an implementation detail of the pattern).</span></span>

- <span data-ttu-id="9fb8f-133">**Контролер** отслеживает состояние шагов задачи, которую выполняет планировщик.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-133">The **Supervisor** monitors the status of the steps in the task being performed by the Scheduler.</span></span> <span data-ttu-id="9fb8f-134">Он периодически запускается (с разной частотой для разных систем) и проверяет состояние шагов, с которыми работает планировщик.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-134">It runs periodically (the frequency will be system specific), and examines the status of steps maintained by the Scheduler.</span></span> <span data-ttu-id="9fb8f-135">Если он обнаружит, что на одном из шагов истекло время ожидания или произошел сбой, он передает соответствующему агенту указание повторить этот шаг или выполнить действия по исправлению (в том числе изменить состояние шага).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-135">If it detects any that have timed out or failed, it arranges for the appropriate Agent to recover the step or execute the appropriate remedial action (this might involve modifying the status of a step).</span></span> <span data-ttu-id="9fb8f-136">Обратите внимание, что сами действия по восстановлению или исправлению выполняют планировщик и агенты.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-136">Note that the recovery or remedial actions are implemented by the Scheduler and Agents.</span></span> <span data-ttu-id="9fb8f-137">Контролер должен просто передать запрос на выполнение этих действий.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-137">The Supervisor should simply request that these actions be performed.</span></span>

<span data-ttu-id="9fb8f-138">Планировщик, агент и контролер являются логическими компонентами. Конкретная физическая реализация зависит от используемой технологии.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-138">The Scheduler, Agent, and Supervisor are logical components and their physical implementation depends on the technology being used.</span></span> <span data-ttu-id="9fb8f-139">Например, несколько логических агентов могут быть реализованы в составе одной веб-службы.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-139">For example, several logical agents might be implemented as part of a single web service.</span></span>

<span data-ttu-id="9fb8f-140">Планировщик сохраняет сведения о ходе выполнения задачи и состоянии каждого шага в устойчивом хранилище данных, которое называется хранилищем состояний.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-140">The Scheduler maintains information about the progress of the task and the state of each step in a durable data store, called the state store.</span></span> <span data-ttu-id="9fb8f-141">Контролер может использовать эту информацию для обнаружения сбоев на определенных шагах.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-141">The Supervisor can use this information to help determine whether a step has failed.</span></span> <span data-ttu-id="9fb8f-142">На рисунке показана связь между планировщиком, агентами, контролером и хранилищем состояний.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-142">The figure illustrates the relationship between the Scheduler, the Agents, the Supervisor, and the state store.</span></span>

![Рис. 1. Субъекты в шаблоне "планировщик, агент, контролер"](./_images/scheduler-agent-supervisor-pattern.png)


> <span data-ttu-id="9fb8f-144">На этой диаграмме представлена упрощенная версия шаблона.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-144">This diagram shows a simplified version of the pattern.</span></span> <span data-ttu-id="9fb8f-145">В фактической реализации могут одновременно существовать и работать несколько экземпляров планировщика, каждый со своим подмножеством задач.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-145">In a real implementation, there might be many instances of the Scheduler running concurrently, each a subset of tasks.</span></span> <span data-ttu-id="9fb8f-146">Аналогичным образом в системе могут одновременно работать несколько экземпляров каждого агента или даже несколько контролеров.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-146">Similarly, the system could run multiple instances of each Agent, or even multiple Supervisors.</span></span> <span data-ttu-id="9fb8f-147">Но в этом случае контролеры должны тщательно координировать свою работу друг с другом, чтобы не пытаться одновременно восстанавливать одни и те же шаги или задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-147">In this case, Supervisors must coordinate their work with each other carefully to ensure that they don’t compete to recover the same failed steps and tasks.</span></span> <span data-ttu-id="9fb8f-148">Эту проблему можно решить, например, с помощью [шаблона выбора лидера](leader-election.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-148">The [Leader Election pattern](leader-election.md) provides one possible solution to this problem.</span></span>

<span data-ttu-id="9fb8f-149">Когда приложение готово к выполнению задачи, оно отправляет планировщику запрос.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-149">When the application is ready to run a task, it submits a request to the Scheduler.</span></span> <span data-ttu-id="9fb8f-150">Планировщик записывает в хранилище состояний исходную информацию о состоянии задачи и ее шагов (например, состояние "не запущен" для каждого шага), а затем начинает выполнять операции, определенные в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-150">The Scheduler records initial state information about the task and its steps (for example, step not yet started) in the state store and then starts performing the operations defined by the workflow.</span></span> <span data-ttu-id="9fb8f-151">При запуске каждого шага планировщик обновляет сведения о состоянии этого шага в хранилище состояний (например, "шаг выполняется").</span><span class="sxs-lookup"><span data-stu-id="9fb8f-151">As the Scheduler starts each step, it updates the information about the state of that step in the state store (for example, step running).</span></span>

<span data-ttu-id="9fb8f-152">Если шаг ссылается на удаленную службу или ресурс, планировщик передает сообщения соответствующим агентам.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-152">If a step references a remote service or resource, the Scheduler sends a message to the appropriate Agent.</span></span> <span data-ttu-id="9fb8f-153">Это сообщение содержит сведения, которые требуются агенту для перехода к службе или доступа к ресурсу, а также требуемое время выполнения для запрошенной операции.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-153">The message contains the information that the Agent needs to pass to the service or access the resource, in addition to the complete-by time for the operation.</span></span> <span data-ttu-id="9fb8f-154">Если агент успешно завершает свою работу, он возвращает планировщику ответ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-154">If the Agent completes its operation successfully, it returns a response to the Scheduler.</span></span> <span data-ttu-id="9fb8f-155">В таком случае планировщик может обновить сведения о состоянии в хранилище состояний (например, "шаг завершен") и перейти к следующему шагу.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-155">The Scheduler can then update the state information in the state store (for example, step completed) and perform the next step.</span></span> <span data-ttu-id="9fb8f-156">Этот процесс продолжается, пока не будет выполнена вся задача.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-156">This process continues until the entire task is complete.</span></span>

<span data-ttu-id="9fb8f-157">В агенте можно реализовать любую логику повторов, которая будет уместна для выполнения его работы.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-157">An Agent can implement any retry logic that's necessary to perform its work.</span></span> <span data-ttu-id="9fb8f-158">Но если агент не завершит свою работу в отведенное время, планировщик предположит, что операция завершилась сбоем.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-158">However, if the Agent doesn't complete its work before the complete-by period expires, the Scheduler will assume that the operation has failed.</span></span> <span data-ttu-id="9fb8f-159">В таком случае агент должен остановить работу и не пытаться вернуть планировщику данные (даже сообщение об ошибке) или выполнить обновление в любом виде.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-159">In this case, the Agent should stop its work and not try to return anything to the Scheduler (not even an error message), or try any form of recovery.</span></span> <span data-ttu-id="9fb8f-160">Такое ограничение связано с тем, что в случае сбоя на любом шаге или завершения времени ожидания может быть запущен другой экземпляр агента для повторного выполнения этого шага (этот процесс описан ниже).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-160">The reason for this restriction is that, after a step has timed out or failed, another instance of the Agent might be scheduled to run the failing step (this process is described later).</span></span>

<span data-ttu-id="9fb8f-161">Если происходит сбой агента, планировщик не получает никакого ответа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-161">If the Agent fails, the Scheduler won't receive a response.</span></span> <span data-ttu-id="9fb8f-162">Поэтому в шаблоне не существует различий между шагом, для которого истекло время ожидания, и шагом, который действительно завершился сбоем.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-162">The pattern doesn't make a distinction between a step that has timed out and one that has genuinely failed.</span></span>

<span data-ttu-id="9fb8f-163">Если истечет время ожидания для шага или произойдет сбой, в хранилище состояния будет содержаться запись о шаге с состоянием "выполняется" и отметкой о том, что время выполнения истекло.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-163">If a step times out or fails, the state store will contain a record that indicates that the step is running, but the complete-by time will have passed.</span></span> <span data-ttu-id="9fb8f-164">Контролер ищет такие шаги и пытается их восстановить.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-164">The Supervisor looks for steps like this and tries to recover them.</span></span> <span data-ttu-id="9fb8f-165">Например, контролер может увеличить значение времени выполнения, чтобы шаг мог завершиться, а затем отправить планировщику сообщение с указанием шага, для которого истекло время ожидания. В этом случае планировщик может попытаться повторно выполнить указанный шаг.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-165">One possible strategy is for the Supervisor to update the complete-by value to extend the time available to complete the step, and then send a message to the Scheduler identifying the step that has timed out. The Scheduler can then try to repeat this step.</span></span> <span data-ttu-id="9fb8f-166">Но для этого задачи должны быть идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-166">However, this design requires the tasks to be idempotent.</span></span>

<span data-ttu-id="9fb8f-167">Если шаг постоянно завершается сбоем или для него истекает время ожидания, контролеру следует прекратить повторные попытки выполнения. Для этого контролер может фиксировать количество повторных попыток для каждого шага в хранилище состояний (в дополнение к другим сведениям о состоянии).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-167">The Supervisor might need to prevent the same step from being retried if it continually fails or times out. To do this, the Supervisor could maintain a retry count for each step, along with the state information, in the state store.</span></span> <span data-ttu-id="9fb8f-168">Когда значение счетчика превысит определенное пороговое значение, контролер может установить более продолжительный период ожидания, а затем сообщить планировщику, что этот шаг нужно выполнить снова. Возможно, благодаря дополнительному времени ошибка будет устранена.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-168">If this count exceeds a predefined threshold the Supervisor can adopt a strategy of waiting for an extended period before notifying the Scheduler that it should retry the step, in the expectation that the fault will be resolved during this period.</span></span> <span data-ttu-id="9fb8f-169">Есть и другой вариант — контролер может передать планировщику сообщение об отмене всей задачи, то есть реализовать [шаблон компенсирующих транзакций](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-169">Alternatively, the Supervisor can send a message to the Scheduler to request the entire task be undone by implementing a [Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="9fb8f-170">Этот подход возможен, если планировщик и агенты способны предоставить достаточные сведения для компенсации каждого шага, который уже был успешно выполнен.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-170">This approach will depend on the Scheduler and Agents providing the information necessary to implement the compensating operations for each step that completed successfully.</span></span>

> <span data-ttu-id="9fb8f-171">Контролер не должен отслеживать, работают ли планировщик и агенты, и не должен перезапускать их в случае сбоя.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-171">It isn't the purpose of the Supervisor to monitor the Scheduler and Agents, and restart them if they fail.</span></span> <span data-ttu-id="9fb8f-172">Этот аспект системы должен контролироваться инфраструктурой, в которой выполняются компоненты.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-172">This aspect of the system should be handled by the infrastructure these components are running in.</span></span> <span data-ttu-id="9fb8f-173">Также контролер не должен получать информацию о фактических бизнес-операциях в выполняемых планировщиком задачах (в том числе он не должен знать, как компенсировать невыполненные задачи).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-173">Similarly, the Supervisor shouldn't have knowledge of the actual business operations that the tasks being performed by the Scheduler are running (including how to compensate should these tasks fail).</span></span> <span data-ttu-id="9fb8f-174">Эта функция входит в логику рабочего процесса, реализованную в планировщике.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-174">This is the purpose of the workflow logic implemented by the Scheduler.</span></span> <span data-ttu-id="9fb8f-175">Единственное, за что отвечает контролер, — это обнаружение сбоев на любом шаге и передача сообщений для повтора этого шага или для отмены всей операции, в которую входил этот шаг.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-175">The sole responsibility of the Supervisor is to determine whether a step has failed and arrange either for it to be repeated or for the entire task containing the failed step to be undone.</span></span>

<span data-ttu-id="9fb8f-176">Если планировщик перезапускается после сбоя или происходит непредвиденное завершение рабочего процесса, планировщик должен иметь возможность определить состояние всех незавершенных задач, которые выполнялись до сбоя, и возобновить выполнение этих задач с соответствующего момента.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-176">If the Scheduler is restarted after a failure, or the workflow being performed by the Scheduler terminates unexpectedly, the Scheduler should be able to determine the status of any inflight task that it was handling when it failed, and be prepared to resume this task from that point.</span></span> <span data-ttu-id="9fb8f-177">Подробности реализации этого процесса будут зависеть от конкретной системы.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-177">The implementation details of this process are likely to be system specific.</span></span> <span data-ttu-id="9fb8f-178">Если восстановить выполнение задачи невозможно, может потребоваться отмена всех действий, уже выполненных в рамках этой задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-178">If the task can't be recovered, it might be necessary to undo the work already performed by the task.</span></span> <span data-ttu-id="9fb8f-179">Для этого можно реализовать [компенсирующие транзакции](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-179">This might also require implementing a [compensating transaction](compensating-transaction.md).</span></span>

<span data-ttu-id="9fb8f-180">Важным преимуществом этой модели является устойчивость системы даже в случае неожиданных сбоев — как временных, так и неустранимых.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-180">The key advantage of this pattern is that the system is resilient in the event of unexpected temporary or unrecoverable failures.</span></span> <span data-ttu-id="9fb8f-181">Можно спроектировать систему так, чтобы она самовосстанавливалась.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-181">The system can be constructed to be self healing.</span></span> <span data-ttu-id="9fb8f-182">Например, при сбое агента или планировщика можно запускать новый экземпляр, а контролер может подготовить возобновление задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-182">For example, if an Agent or the Scheduler fails, a new one can be started and the Supervisor can arrange for a task to be resumed.</span></span> <span data-ttu-id="9fb8f-183">В случае сбоя контролера можно запускать другой экземпляр, который возьмет на себя работу с того места, в котором произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-183">If the Supervisor fails, another instance can be started and can take over from where the failure occurred.</span></span> <span data-ttu-id="9fb8f-184">Если контролер настроен на периодическое выполнение, новый экземпляр можно запускать автоматически после определенного интервала.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-184">If the Supervisor is scheduled to run periodically, a new instance can be automatically started after a predefined interval.</span></span> <span data-ttu-id="9fb8f-185">Хранилище состояний можно реплицировать, чтобы дополнительно повысить устойчивость.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-185">The state store can be replicated to reach an even greater degree of resiliency.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="9fb8f-186">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="9fb8f-186">Issues and considerations</span></span>

<span data-ttu-id="9fb8f-187">При выборе схемы реализации этого шаблона следует учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-187">You should consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="9fb8f-188">Этот шаблон может быть сложным в реализации и требует тщательного тестирования всех возможных режимов сбоя системы.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-188">This pattern can be difficult to implement and requires thorough testing of each possible failure mode of the system.</span></span>

- <span data-ttu-id="9fb8f-189">Логика восстановления и повторов, реализованная в планировщике, будет сложной и зависимой от сведений о состоянии, размещенных в хранилище состояний.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-189">The recovery/retry logic implemented by the Scheduler is complex and dependent on state information held in the state store.</span></span> <span data-ttu-id="9fb8f-190">Также может потребоваться фиксировать информацию, необходимую для выполнения компенсирующей транзакции в устойчивом хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-190">It might also be necessary to record the information required to implement a compensating transaction in a durable data store.</span></span>

- <span data-ttu-id="9fb8f-191">Важно выбрать правильную частоту для запуска контролера.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-191">How often the Supervisor runs will be important.</span></span> <span data-ttu-id="9fb8f-192">Он должен выполняться достаточно часто, чтобы сбой любого шага не вызывал длительную блокировку всего приложения, но при этом не слишком часто — во избежание дополнительных затрат.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-192">It should run often enough to prevent any failed steps from blocking an application for an extended period, but it shouldn't run so often that it becomes an overhead.</span></span>

- <span data-ttu-id="9fb8f-193">Шаги, выполняемые агентом, можно запускать более одного раза.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-193">The steps performed by an Agent could be run more than once.</span></span> <span data-ttu-id="9fb8f-194">Логика, которая реализует эти действия, должна быть идемпотентной.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-194">The logic that implements these steps should be idempotent.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="9fb8f-195">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="9fb8f-195">When to use this pattern</span></span>

<span data-ttu-id="9fb8f-196">Используйте этот шаблон, если процесс выполняется в распределенной среде, например в облаке, и должен быть устойчивым к ошибкам связи и (или) функциональным сбоям.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-196">Use this pattern when a process that runs in a distributed environment, such as the cloud, must be resilient to communications failure and/or operational failure.</span></span>

<span data-ttu-id="9fb8f-197">Этот шаблон не всегда подходит для задач, которые не обращаются к удаленным службам или ресурсам.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-197">This pattern might not be suitable for tasks that don't invoke remote services or access remote resources.</span></span>

## <a name="example"></a><span data-ttu-id="9fb8f-198">Пример</span><span class="sxs-lookup"><span data-stu-id="9fb8f-198">Example</span></span>

<span data-ttu-id="9fb8f-199">В Microsoft Azure развернуто веб-приложение, в котором реализована система электронной коммерции.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-199">A web application that implements an ecommerce system has been deployed on Microsoft Azure.</span></span> <span data-ttu-id="9fb8f-200">Пользователи могут запускать это приложение для просмотра доступных товаров и размещения заказов.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-200">Users can run this application to browse the available products and to place orders.</span></span> <span data-ttu-id="9fb8f-201">Пользовательский интерфейс работает как веб-роль, а элементы обработки заказов реализованы в приложении как набор рабочих ролей.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-201">The user interface runs as a web role, and the order processing elements of the application are implemented as a set of worker roles.</span></span> <span data-ttu-id="9fb8f-202">Логика обработки заказов включает элементы с доступом к удаленной службе, и этот аспект системы уязвим для временных или длительных сбоев.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-202">Part of the order processing logic involves accessing a remote service, and this aspect of the system could be prone to transient or more long-lasting faults.</span></span> <span data-ttu-id="9fb8f-203">По этой причине разработчики применяют шаблон "планировщик, агент, контролер" для реализации обработки заказов в системе.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-203">For this reason, the designers used the Scheduler Agent Supervisor pattern to implement the order processing elements of the system.</span></span>

<span data-ttu-id="9fb8f-204">Когда клиент размещает заказ, приложение создает сообщение с описанием заказа и отправляет это сообщение в очередь.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-204">When a customer places an order, the application constructs a message that describes the order and posts this message to a queue.</span></span> <span data-ttu-id="9fb8f-205">Отдельный процесс отправки, запущенный в рабочей роли, извлекает это сообщение, переносит данные о заказе в базу данных заказов и создает запись в хранилище состояний для обработки заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-205">A separate submission process, running in a worker role, retrieves the message, inserts the order details into the orders database, and creates a record for the order process in the state store.</span></span> <span data-ttu-id="9fb8f-206">Обратите внимание, что запись в базу данных заказов и в хранилище состояний выполняется в рамках одной операции.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-206">Note that the inserts into the orders database and the state store are performed as part of the same operation.</span></span> <span data-ttu-id="9fb8f-207">Процесс отправки реализован так, что гарантирует одновременное успешное выполнение этих операций записи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-207">The submission process is designed to ensure that both inserts complete together.</span></span>

<span data-ttu-id="9fb8f-208">Запись о состоянии, которую процесс отправки создает для заказа, содержит следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="9fb8f-208">The state information that the submission process creates for the order includes:</span></span>

- <span data-ttu-id="9fb8f-209">**OrderID**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-209">**OrderID**.</span></span> <span data-ttu-id="9fb8f-210">Идентификатор заказа в базе данных заказов.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-210">The ID of the order in the orders database.</span></span>

- <span data-ttu-id="9fb8f-211">**LockedBy**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-211">**LockedBy**.</span></span> <span data-ttu-id="9fb8f-212">Идентификатор экземпляра рабочей роли, которая обрабатывает этот заказ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-212">The instance ID of the worker role handling the order.</span></span> <span data-ttu-id="9fb8f-213">Планировщик может запустить несколько экземпляров рабочей роли, но каждый заказ должен обрабатываться только одним экземпляром.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-213">There might be multiple current instances of the worker role running the Scheduler, but each order should only be handled by a single instance.</span></span>

- <span data-ttu-id="9fb8f-214">**CompleteBy**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-214">**CompleteBy**.</span></span> <span data-ttu-id="9fb8f-215">Время, к которому должен быть обработан заказ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-215">The time the order should be processed by.</span></span>

- <span data-ttu-id="9fb8f-216">**ProcessState**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-216">**ProcessState**.</span></span> <span data-ttu-id="9fb8f-217">Текущее состояние задачи, обрабатывающей заказ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-217">The current state of the task handling the order.</span></span> <span data-ttu-id="9fb8f-218">Возможны следующие состояния.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-218">The possible states are:</span></span>

    - <span data-ttu-id="9fb8f-219">**Pending**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-219">**Pending**.</span></span> <span data-ttu-id="9fb8f-220">Заказ был создан, но обработка еще не началась.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-220">The order has been created but processing hasn't yet been started.</span></span>
    - <span data-ttu-id="9fb8f-221">**Processing**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-221">**Processing**.</span></span> <span data-ttu-id="9fb8f-222">Заказ обрабатывается в настоящее время.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-222">The order is currently being processed.</span></span>
    - <span data-ttu-id="9fb8f-223">**Processed**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-223">**Processed**.</span></span> <span data-ttu-id="9fb8f-224">Заказ успешно обработан.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-224">The order has been processed successfully.</span></span>
    - <span data-ttu-id="9fb8f-225">**Ошибка**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-225">**Error**.</span></span> <span data-ttu-id="9fb8f-226">Сбой при обработке заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-226">The order processing has failed.</span></span>

- <span data-ttu-id="9fb8f-227">**FailureCount**.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-227">**FailureCount**.</span></span> <span data-ttu-id="9fb8f-228">Количество попыток обработки этого заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-228">The number of times that processing has been tried for the order.</span></span>

<span data-ttu-id="9fb8f-229">Поле `OrderID` в этом наборе сведений о состоянии содержит значение идентификатора нового заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-229">In this state information, the `OrderID` field is copied from the order ID of the new order.</span></span> <span data-ttu-id="9fb8f-230">Поля `LockedBy` и `CompleteBy` имеют значение `null`, поле `ProcessState` имеет значение `Pending`, а поле `FailureCount` — значение 0.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-230">The `LockedBy` and `CompleteBy` fields are set to `null`, the `ProcessState` field is set to `Pending`, and the `FailureCount` field is set to 0.</span></span>

> <span data-ttu-id="9fb8f-231">В этом примере используется довольно простая логика обработки заказов, содержащая только один шаг, который вызывает удаленную службу.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-231">In this example, the order handling logic is relatively simple and only has a single step that invokes a remote service.</span></span> <span data-ttu-id="9fb8f-232">В более сложных многоэтапных сценариях процесс отправки будет включать несколько шагов, и в хранилище состояний будет создаваться несколько записей — по одной для состояний каждого отдельного шага.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-232">In a more complex multistep scenario, the submission process would likely involve several steps, and so several records would be created in the state store—each one describing the state of an individual step.</span></span>

<span data-ttu-id="9fb8f-233">Планировщик также выполняется в рабочей роли и содержит бизнес-логику для обработки заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-233">The Scheduler also runs as part of a worker role and implements the business logic that handles the order.</span></span> <span data-ttu-id="9fb8f-234">Экземпляр планировщика, выполняющего опрос относительно наличия новых заказов, проверяет записи в хранилище состояний, в которых поле `LockedBy` имеет значение NULL, а поле `ProcessState` — значение Pending.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-234">An instance of the Scheduler polling for new orders examines the state store for records where the `LockedBy` field is null and the `ProcessState` field is pending.</span></span> <span data-ttu-id="9fb8f-235">Когда планировщик находит новый заказ, он немедленно заносит в поле `LockedBy` значение своего идентификатора экземпляра, в поле `CompleteBy` фиксирует текущее время, а в поле `ProcessState` указывает состояние Processing.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-235">When the Scheduler finds a new order, it immediately populates the `LockedBy` field with its own instance ID, sets the `CompleteBy` field to an appropriate time, and sets the `ProcessState` field to processing.</span></span> <span data-ttu-id="9fb8f-236">Код выполняет атомарную операцию в монопольном режиме, что не позволяет двум параллельно запущенным экземплярам планировщика обрабатывать один заказ одновременно.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-236">The code is designed to be exclusive and atomic to ensure that two concurrent instances of the Scheduler can't try to handle the same order simultaneously.</span></span>

<span data-ttu-id="9fb8f-237">После этого планировщик запускает рабочий процесс асинхронной обработки заказа, передавая ему значение поля `OrderID` из хранилища состояний.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-237">The Scheduler then runs the business workflow to process the order asynchronously, passing it the value in the `OrderID` field from the state store.</span></span> <span data-ttu-id="9fb8f-238">Рабочий процесс, обрабатывающий заказ, извлекает сведения о заказе из базы данных заказов и выполняет свою работу.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-238">The workflow handling the order retrieves the details of the order from the orders database and performs its work.</span></span> <span data-ttu-id="9fb8f-239">Когда шаг рабочего процесса обработки заказа должен обратиться к удаленной службе, он использует агент.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-239">When a step in the order processing workflow needs to invoke the remote service, it uses an Agent.</span></span> <span data-ttu-id="9fb8f-240">Шаг рабочего процесса взаимодействует с агентом с помощью пары очередей сообщений служебной шины Azure, которые выполняют функции канала "запрос — ответ".</span><span class="sxs-lookup"><span data-stu-id="9fb8f-240">The workflow step communicates with the Agent using a pair of Azure Service Bus message queues acting as a request/response channel.</span></span> <span data-ttu-id="9fb8f-241">На рисунке показано общее представление этого решения.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-241">The figure shows a high level view of the solution.</span></span>

![Рис. 2. Использование шаблона "планировщик, агент, контролер" для обработки заказов в решении Azure](./_images/scheduler-agent-supervisor-solution.png)

<span data-ttu-id="9fb8f-243">В сообщении, которое шаг рабочего процесса отправляет агенту, описывается заказ и указывается время выполнения.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-243">The message sent to the Agent from a workflow step describes the order and includes the complete-by time.</span></span> <span data-ttu-id="9fb8f-244">Если агент успевает получить ответ от удаленной службы до истечения времени выполнения, он передает ответное сообщение через очередь служебной шины, которую прослушивает рабочий процесс.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-244">If the Agent receives a response from the remote service before the complete-by time expires, it posts a reply message on the Service Bus queue on which the workflow is listening.</span></span> <span data-ttu-id="9fb8f-245">Получив допустимое ответное сообщение, шаг рабочего процесса завершает обработку, а планировщик задает в поле ProcessState для этого заказа значение Processed.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-245">When the workflow step receives the valid reply message, it completes its processing and the Scheduler sets the \`ProcessState field of the order state to processed.</span></span> <span data-ttu-id="9fb8f-246">Теперь можно считать, что обработка заказа успешно завершена.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-246">At this point, the order processing has completed successfully.</span></span>

<span data-ttu-id="9fb8f-247">Если время выполнения истечет раньше, чем агент получит ответ от удаленной службы, агент просто прерывает ожидание ответа и прекращает обработку заказа.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-247">If the complete-by time expires before the Agent receives a response from the remote service, the Agent simply halts its processing and terminates handling the order.</span></span> <span data-ttu-id="9fb8f-248">Аналогично, если рабочий процесс обработки заказа превысит время выполнения, он также завершается.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-248">Similarly, if the workflow handling the order exceeds the complete-by time, it also terminates.</span></span> <span data-ttu-id="9fb8f-249">В обоих случаях для заказа в хранилище состояний сохраняется состояние Processing, но значение времени выполнения позволяет понять, что время ожидания уже истекло, и считается, что процесс завершился сбоем.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-249">In both cases, the state of the order in the state store remains set to processing, but the complete-by time indicates that the time for processing the order has passed and the process is deemed to have failed.</span></span> <span data-ttu-id="9fb8f-250">Обратите внимание, что в случае неожиданного завершения работы агента, который обращается к удаленной службе, и (или) рабочего процесса, обрабатывающего заказ, в хранилище состояний также сохранится состояние Processing, и будет указано, что время выполнения истекло.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-250">Note that if the Agent that's accessing the remote service, or the workflow that's handling the order (or both) terminate unexpectedly, the information in the state store will again remain set to processing and eventually will have an expired complete-by value.</span></span>

<span data-ttu-id="9fb8f-251">Если агент при попытке подключения к удаленной службе столкнется с неустранимой постоянной ошибкой, он может вернуть в рабочий процесс сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-251">If the Agent detects an unrecoverable, nontransient fault while it's trying to contact the remote service, it can send an error response back to the workflow.</span></span> <span data-ttu-id="9fb8f-252">Тогда планировщик сможет установить значение Error для состояния заказа и создать событие с предупреждением для оператора.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-252">The Scheduler can set the status of the order to error and raise an event that alerts an operator.</span></span> <span data-ttu-id="9fb8f-253">Оператор может попытаться устранить причину сбоя вручную и повторить этот шаг обработки.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-253">The operator can then try to resolve the reason for the failure manually and resubmit the failed processing step.</span></span>

<span data-ttu-id="9fb8f-254">Контролер периодически проверяет хранилище состояний на наличие заказов с истекшим сроком выполнения.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-254">The Supervisor periodically examines the state store looking for orders with an expired complete-by value.</span></span> <span data-ttu-id="9fb8f-255">Обнаружив такую запись, контролер увеличивает для нее значение поля `FailureCount`.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-255">If the Supervisor finds a record, it increments the `FailureCount` field.</span></span> <span data-ttu-id="9fb8f-256">Пока значение счетчика сбоев остается ниже определенного порогового значения, контролер задает для поля `LockedBy` значение NULL, вносит в поле `CompleteBy` новое время окончания срока выполнения и меняет значение поля `ProcessState` на Pending.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-256">If the failure count value is below a specified threshold value, the Supervisor resets the `LockedBy` field to null, updates the `CompleteBy` field with a new expiration time, and sets the `ProcessState` field to pending.</span></span> <span data-ttu-id="9fb8f-257">Экземпляр планировщика подберет этот заказ и обработает его, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-257">An instance of the Scheduler can pick up this order and perform its processing as before.</span></span> <span data-ttu-id="9fb8f-258">Если значение счетчика сбоев превышает заданное пороговое значение, сбой можно считать постоянным.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-258">If the failure count value exceeds a specified threshold, the reason for the failure is assumed to be nontransient.</span></span> <span data-ttu-id="9fb8f-259">Тогда планировщик устанавливает значение Error для состояния заказа и создает событие с предупреждением для оператора.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-259">The Supervisor sets the status of the order to error and raises an event that alerts an operator.</span></span>

> <span data-ttu-id="9fb8f-260">В этом примере контролер реализован в отдельной рабочей роли.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-260">In this example, the Supervisor is implemented in a separate worker role.</span></span> <span data-ttu-id="9fb8f-261">Вы можете использовать разные стратегии для выполнения задачи контролера, в том числе через службу планировщика Azure (не путать с компонентом планировщика из этого шаблона).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-261">You can use a variety of strategies to arrange for the Supervisor task to be run, including using the Azure Scheduler service (not to be confused with the Scheduler component in this pattern).</span></span> <span data-ttu-id="9fb8f-262">Дополнительные сведения о службе планировщика Azure можно найти на [странице с его описанием](https://azure.microsoft.com/services/scheduler/).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-262">For more information about the Azure Scheduler service, visit the [Scheduler](https://azure.microsoft.com/services/scheduler/) page.</span></span>

<span data-ttu-id="9fb8f-263">Хотя это не показано в нашем примере, может потребоваться передача информации о ходе обработки и текущем состоянии заказа от планировщика к приложению, которое передало заказ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-263">Although it isn't shown in this example, the Scheduler might need to keep the application that submitted the order informed about the progress and status of the order.</span></span> <span data-ttu-id="9fb8f-264">Приложение и планировщик изолированы друг от друга, что позволяет исключить любые зависимости между ними.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-264">The application and the Scheduler are isolated from each other to eliminate any dependencies between them.</span></span> <span data-ttu-id="9fb8f-265">Приложение не имеет сведений о том, какой экземпляр планировщика обрабатывает заказ, а планировщик не знает, какой экземпляр приложения разместил этот заказ.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-265">The application has no knowledge of which instance of the Scheduler is handling the order, and the Scheduler is unaware of which specific application instance posted the order.</span></span>

<span data-ttu-id="9fb8f-266">Чтобы передавать информацию о состоянии заказа, приложение может использовать собственную очередь ответов.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-266">To allow the order status to be reported, the application could use its own private response queue.</span></span> <span data-ttu-id="9fb8f-267">Сведения из этой очереди ответов будут включаться в запрос, отправляемый в процесс отправки, который передаст эту информацию в хранилище состояний.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-267">The details of this response queue would be included as part of the request sent to the submission process, which would include this information in the state store.</span></span> <span data-ttu-id="9fb8f-268">Затем планировщик поместит в эту очередь сообщения, указывающие состояние заказа (запрос получен, заказ выполнен, сбой обработки заказа и т. д.).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-268">The Scheduler would then post messages to this queue indicating the status of the order (request received, order completed, order failed, and so on).</span></span> <span data-ttu-id="9fb8f-269">В сообщениях должен быть указан идентификатор заказа, чтобы их можно было сопоставить с исходным запросом приложения.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-269">It should include the order ID in these messages so they can be correlated with the original request by the application.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="9fb8f-270">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="9fb8f-270">Related patterns and guidance</span></span>

<span data-ttu-id="9fb8f-271">При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-271">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="9fb8f-272">[Шаблон повторов][retry-pattern].</span><span class="sxs-lookup"><span data-stu-id="9fb8f-272">[Retry pattern][retry-pattern].</span></span> <span data-ttu-id="9fb8f-273">Агент может использовать этот шаблон для прозрачного повторения операций доступа к удаленной службе или ресурсу, если ранее они завершались сбоем.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-273">An Agent can use this pattern to transparently retry an operation that accesses a remote service or resource that has previously failed.</span></span> <span data-ttu-id="9fb8f-274">Используйте его, если есть основания полагать, что сбой является временным и может быть исправлен.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-274">Use when the expectation is that the cause of the failure is transient and can be corrected.</span></span>
- <span data-ttu-id="9fb8f-275">[Шаблон прерывателя](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-275">[Circuit Breaker pattern](circuit-breaker.md).</span></span> <span data-ttu-id="9fb8f-276">Агент может использовать этот шаблон для обработки ошибок при подключении к удаленной службе или ресурсу, если для их исправления требуется непредсказуемое время.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-276">An Agent can use this pattern to handle faults that take a variable amount of time to correct when connecting to a remote service or resource.</span></span>
- <span data-ttu-id="9fb8f-277">[Шаблон компенсирующих транзакций](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-277">[Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="9fb8f-278">Если рабочий процесс, запущенный планировщиком, не может успешно завершиться, может потребоваться отмена всех действий, уже выполненных в рамках этой задачи.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-278">If the workflow being performed by a Scheduler can't be completed successfully, it might be necessary to undo any work it's previously performed.</span></span> <span data-ttu-id="9fb8f-279">Шаблон компенсирующих транзакций описывает, как правильно сделать это для операций, построенных на основе модели итоговой согласованности.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-279">The Compensating Transaction pattern describes how this can be achieved for operations that follow the eventual consistency model.</span></span> <span data-ttu-id="9fb8f-280">Обычно именно такой тип согласованности используется в планировщиках, выполняющих сложные бизнес-процессы и рабочие процессы.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-280">These types of operations are commonly implemented by a Scheduler that performs complex business processes and workflows.</span></span>
- <span data-ttu-id="9fb8f-281">[Руководство по асинхронному обмену сообщениями](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-281">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="9fb8f-282">Обычно компоненты шаблона "планировщик, агент, контролер" выполняются отдельно друг от друга и взаимодействуют асинхронно.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-282">The components in the Scheduler Agent Supervisor pattern typically run decoupled from each other and communicate asynchronously.</span></span> <span data-ttu-id="9fb8f-283">Здесь описываются некоторые подходы, которые можно использовать для асинхронного взаимодействия с помощью очередей сообщений.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-283">Describes some of the approaches that can be used to implement asynchronous communication based on message queues.</span></span>
- <span data-ttu-id="9fb8f-284">[Шаблон выбора лидера](leader-election.md).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-284">[Leader Election pattern](leader-election.md).</span></span> <span data-ttu-id="9fb8f-285">Возможно, вам потребуется согласовывать действия нескольких экземпляров контролера, чтобы предотвратить одновременные попытки восстановления одного процесса, в котором произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-285">It might be necessary to coordinate the actions of multiple instances of a Supervisor to prevent them from attempting to recover the same failed process.</span></span> <span data-ttu-id="9fb8f-286">Шаблон выбора лидера описывает, как это сделать.</span><span class="sxs-lookup"><span data-stu-id="9fb8f-286">The Leader Election pattern describes how to do this.</span></span>
- <span data-ttu-id="9fb8f-287">Запись в блоге Клеменса Вастерса (Clemens Vasters) [Cloud Architecture: The Scheduler-Agent-Supervisor Pattern](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) (Облачная архитектура: шаблон "планировщик, агент, контролер").</span><span class="sxs-lookup"><span data-stu-id="9fb8f-287">[Cloud Architecture: The Scheduler-Agent-Supervisor Pattern](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) on Clemens Vasters' blog</span></span>
- [<span data-ttu-id="9fb8f-288">Шаблон диспетчера процессов</span><span class="sxs-lookup"><span data-stu-id="9fb8f-288">Process Manager pattern</span></span>](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html)
- <span data-ttu-id="9fb8f-289">[Reference 6: A Saga on Sagas](https://msdn.microsoft.com/library/jj591569.aspx) (Справочник 6. Сага о сагах).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-289">[Reference 6: A Saga on Sagas](https://msdn.microsoft.com/library/jj591569.aspx).</span></span> <span data-ttu-id="9fb8f-290">Пример, демонстрирующий использование диспетчера процессов в шаблоне CQRS (часть руководства по CQRS).</span><span class="sxs-lookup"><span data-stu-id="9fb8f-290">An example showing how the CQRS pattern uses a process manager (part of the CQRS Journey guidance).</span></span>
- [<span data-ttu-id="9fb8f-291">Планировщик Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="9fb8f-291">Microsoft Azure Scheduler</span></span>](https://azure.microsoft.com/services/scheduler/)

[retry-pattern]: ./retry.md
