---
title: Шаблон источников событий
titleSuffix: Cloud Design Patterns
description: Использование инкрементируемого хранилища для сохранения всей последовательности событий, то есть всех действий с данными в домене.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 0183342257c676538aedc073f4f31a1c38ffdeef
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58248799"
---
# <a name="event-sourcing-pattern"></a><span data-ttu-id="d744d-104">Шаблон источников событий</span><span class="sxs-lookup"><span data-stu-id="d744d-104">Event Sourcing pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="d744d-105">Вместо сохранения текущего состояния данных в домене используйте инкрементируемое хранилище для записи полных серий действий с этими данными.</span><span class="sxs-lookup"><span data-stu-id="d744d-105">Instead of storing just the current state of the data in a domain, use an append-only store to record the full series of actions taken on that data.</span></span>
<span data-ttu-id="d744d-106">Хранилище действует как система записи, и его можно использовать для материализации объектов домена.</span><span class="sxs-lookup"><span data-stu-id="d744d-106">The store acts as the system of record and can be used to materialize the domain objects.</span></span> <span data-ttu-id="d744d-107">Это позволяет упростить задачи в сложных доменах, устраняя необходимость синхронизации модели данных и домена для бизнеса при одновременном повышении производительности, масштабируемости и скорости реагирования.</span><span class="sxs-lookup"><span data-stu-id="d744d-107">This can simplify tasks in complex domains, by avoiding the need to synchronize the data model and the business domain, while improving performance, scalability, and responsiveness.</span></span> <span data-ttu-id="d744d-108">Кроме того, обеспечивается совместимость транзакционных данных и сохранение всех журналов аудита и истории, с помощью которых можно использовать компенсирующие действия.</span><span class="sxs-lookup"><span data-stu-id="d744d-108">It can also provide consistency for transactional data, and maintain full audit trails and history that can enable compensating actions.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="d744d-109">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="d744d-109">Context and problem</span></span>

<span data-ttu-id="d744d-110">Большинство приложений работают с данными, и типичный подход, используемый в приложении, — поддержка текущего состояния данных за счет обновления по мере работы с ними.</span><span class="sxs-lookup"><span data-stu-id="d744d-110">Most applications work with data, and the typical approach is for the application to maintain the current state of the data by updating it as users work with it.</span></span> <span data-ttu-id="d744d-111">Например, в традиционной модели создания, чтения, обновления и удаления (CRUD) типичная обработка данных представляет собой считывание данных из хранилища, внесение в них определенных изменений и обновление их текущего состояния с помощью новых значений (часто с помощью транзакций блокирования данных).</span><span class="sxs-lookup"><span data-stu-id="d744d-111">For example, in the traditional create, read, update, and delete (CRUD) model a typical data process is to read data from the store, make some modifications to it, and update the current state of the data with the new values&mdash;often by using transactions that lock the data.</span></span>

<span data-ttu-id="d744d-112">Для такого подхода CRUD предусмотрены некоторые ограничения:</span><span class="sxs-lookup"><span data-stu-id="d744d-112">The CRUD approach has some limitations:</span></span>

- <span data-ttu-id="d744d-113">Системы CRUD выполняют операции обновления непосредственно в хранилище данных, которые могут замедлять производительность и скорость реагирования и ограничивать масштабируемость — все это из-за требуемой дополнительной нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d744d-113">CRUD systems perform update operations directly against a data store, which can slow down performance and responsiveness, and limit scalability, due to the processing overhead it requires.</span></span>

- <span data-ttu-id="d744d-114">В домене для совместной работы с большим количеством параллельных подключений пользователей более вероятны возникновения конфликтов обновления данных, так как операции обновления выполняются для отдельного элемента данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-114">In a collaborative domain with many concurrent users, data update conflicts are more likely because the update operations take place on a single item of data.</span></span>

- <span data-ttu-id="d744d-115">Если отсутствует дополнительный механизм аудита, записывающий подробности каждой операции в отдельный журнал, история не сохраняется.</span><span class="sxs-lookup"><span data-stu-id="d744d-115">Unless there's an additional auditing mechanism that records the details of each operation in a separate log, history is lost.</span></span>

> <span data-ttu-id="d744d-116">Чтобы лучше понять ограничения, связанные с архитектурой CRUD, ознакомьтесь с [этой](https://blogs.msdn.microsoft.com/maarten_mullender/2004/07/23/crud-only-when-you-can-afford-it-revisited/) записью блога.</span><span class="sxs-lookup"><span data-stu-id="d744d-116">For a deeper understanding of the limits of the CRUD approach see [CRUD, Only When You Can Afford It](https://blogs.msdn.microsoft.com/maarten_mullender/2004/07/23/crud-only-when-you-can-afford-it-revisited/).</span></span>

## <a name="solution"></a><span data-ttu-id="d744d-117">Решение</span><span class="sxs-lookup"><span data-stu-id="d744d-117">Solution</span></span>

<span data-ttu-id="d744d-118">Шаблон источника событий определяет подход к обработке операций с данными на основе последовательности событий, каждое из которых записывается в инкрементируемое хранилище.</span><span class="sxs-lookup"><span data-stu-id="d744d-118">The Event Sourcing pattern defines an approach to handling operations on data that's driven by a sequence of events, each of which is recorded in an append-only store.</span></span> <span data-ttu-id="d744d-119">Код приложения отправляет ряд событий, которые принудительно описывают каждое действие с данными в хранилище событий, где они сохраняются.</span><span class="sxs-lookup"><span data-stu-id="d744d-119">Application code sends a series of events that imperatively describe each action that has occurred on the data to the event store, where they're persisted.</span></span> <span data-ttu-id="d744d-120">Каждое событие обозначает некоторый набор изменений в данных (например, `AddedItemToOrder`).</span><span class="sxs-lookup"><span data-stu-id="d744d-120">Each event represents a set of changes to the data (such as `AddedItemToOrder`).</span></span>

<span data-ttu-id="d744d-121">События сохраняются в хранилище событий, которое выступает в качестве системы записи (заслуживающий доверие источник данных) текущего состояния данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-121">The events are persisted in an event store that acts as the system of record (the authoritative data source) about the current state of the data.</span></span> <span data-ttu-id="d744d-122">Хранилище событий обычно публикует эти события для оповещения потребителей и при необходимости предоставления им возможности обрабатывать эти события.</span><span class="sxs-lookup"><span data-stu-id="d744d-122">The event store typically publishes these events so that consumers can be notified and can handle them if needed.</span></span> <span data-ttu-id="d744d-123">Потребители могут, например, запустить задачи, применяющие операции в событиях к другим системам, или выполнить любое другое связанное действие, необходимое для завершения операции.</span><span class="sxs-lookup"><span data-stu-id="d744d-123">Consumers could, for example, initiate tasks that apply the operations in the events to other systems, or perform any other associated action that's required to complete the operation.</span></span> <span data-ttu-id="d744d-124">Обратите внимание, что код приложения, создающий события, никак не связан с системами, подписанными на эти события.</span><span class="sxs-lookup"><span data-stu-id="d744d-124">Notice that the application code that generates the events is decoupled from the systems that subscribe to the events.</span></span>

<span data-ttu-id="d744d-125">Стандартное использование событий, опубликованных хранилищем событий, включает поддержку материализованных представлений сущностей по мере их изменения в приложении с помощью действий, а также интеграцию с внешними системами.</span><span class="sxs-lookup"><span data-stu-id="d744d-125">Typical uses of the events published by the event store are to maintain materialized views of entities as actions in the application change them, and for integration with external systems.</span></span> <span data-ttu-id="d744d-126">Например, система может поддерживать материализованное представление всех заказов клиента, используемых для заполнения частей пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="d744d-126">For example, a system can maintain a materialized view of all customer orders that's used to populate parts of the UI.</span></span> <span data-ttu-id="d744d-127">По мере добавления новых заказов, добавления или удаления позиций в заказе или добавления сведений о доставке в приложении события, описывающие эти изменения, можно обрабатывать, а также использовать для обновления [материализованного представления](./materialized-view.md).</span><span class="sxs-lookup"><span data-stu-id="d744d-127">As the application adds new orders, adds or removes items on the order, and adds shipping information, the events that describe these changes can be handled and used to update the [materialized view](./materialized-view.md).</span></span>

<span data-ttu-id="d744d-128">Кроме того, приложения могут в любой момент считать историю событий и использовать ее для материализации текущего состояния сущности за счет воспроизведения и использования всех событий, которые относятся к этой сущности.</span><span class="sxs-lookup"><span data-stu-id="d744d-128">In addition, at any point it's possible for applications to read the history of events, and use it to materialize the current state of an entity by playing back and consuming all the events related to that entity.</span></span> <span data-ttu-id="d744d-129">Это можно сделать по запросу для материализации объекта домена при обработке запроса или в запланированной задаче для сохранения состояния сущности в виде материализованного представления для поддержки уровня представления.</span><span class="sxs-lookup"><span data-stu-id="d744d-129">This can occur on demand to materialize a domain object when handling a request, or through a scheduled task so that the state of the entity can be stored as a materialized view to support the presentation layer.</span></span>

<span data-ttu-id="d744d-130">На схеме ниже представлен обзор шаблона, включая некоторые варианты использования потока событий, например создание материализованного представления, интеграцию событий с внешними приложениями и системами, а также воспроизведение событий для создания проекций текущего состояния определенных сущностей.</span><span class="sxs-lookup"><span data-stu-id="d744d-130">The figure shows an overview of the pattern, including some of the options for using the event stream such as creating a materialized view, integrating events with external applications and systems, and replaying events to create projections of the current state of specific entities.</span></span>

![Обзор и пример шаблона источника событий](./_images/event-sourcing-overview.png)

<span data-ttu-id="d744d-132">Шаблон источника событий предоставляет следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="d744d-132">The Event Sourcing pattern provides the following advantages:</span></span>

- <span data-ttu-id="d744d-133">События являются неизменяемыми, и их можно сохранить с помощью инкрементируемой операции.</span><span class="sxs-lookup"><span data-stu-id="d744d-133">Events are immutable and can be stored using an append-only operation.</span></span> <span data-ttu-id="d744d-134">Вы можете не завершать работу источника, с помощью которого было активировано событие (пользовательский интерфейс, рабочий процесс или любой другой процесс), а задачи, обрабатывающие события, могут выполняться в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="d744d-134">The user interface, workflow, or process that initiated an event can continue, and tasks that handle the events can run in the background.</span></span> <span data-ttu-id="d744d-135">Таким образом, с учетом отсутствия конкурирующих процессов во время обработки транзакций может значительно улучшиться производительность и масштабируемость приложений, особенно для уровня презентации или интерфейса пользователя.</span><span class="sxs-lookup"><span data-stu-id="d744d-135">This, combined with the fact that there's no contention during the processing of transactions, can vastly improve performance and scalability for applications, especially for the presentation level or user interface.</span></span>

- <span data-ttu-id="d744d-136">События представляют собой простые объекты, которые описывают некоторые выполненные действия, а также связанные данные, необходимые для описания действия, представленного событием.</span><span class="sxs-lookup"><span data-stu-id="d744d-136">Events are simple objects that describe some action that occurred, together with any associated data required to describe the action represented by the event.</span></span> <span data-ttu-id="d744d-137">События не имеют прямого отношения к обновлению хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-137">Events don't directly update a data store.</span></span> <span data-ttu-id="d744d-138">Они просто записываются для обработки в соответствующее время.</span><span class="sxs-lookup"><span data-stu-id="d744d-138">They're simply recorded for handling at the appropriate time.</span></span> <span data-ttu-id="d744d-139">Это позволяет упростить управление и реализацию.</span><span class="sxs-lookup"><span data-stu-id="d744d-139">This can simplify implementation and management.</span></span>

- <span data-ttu-id="d744d-140">События представляют определенную ценность для специалиста по работе с доменами, а [объектно-реляционная несогласованность](https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch) может усложнить понимание сложных таблиц базы данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-140">Events typically have meaning for a domain expert, whereas [object-relational impedance mismatch](https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch) can make complex database tables hard to understand.</span></span> <span data-ttu-id="d744d-141">Таблицы представляют собой искусственные конструкции, отображающие текущее состояние системы, а не произошедшие события.</span><span class="sxs-lookup"><span data-stu-id="d744d-141">Tables are artificial constructs that represent the current state of the system, not the events that occurred.</span></span>

- <span data-ttu-id="d744d-142">Источник событий может помочь предотвратить возникновение конфликтов, вызванных параллельными обновлениями, так как исключает необходимость непосредственного обновления объектов в хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-142">Event sourcing can help prevent concurrent updates from causing conflicts because it avoids the requirement to directly update objects in the data store.</span></span> <span data-ttu-id="d744d-143">Однако модель домена по-прежнему должна быть разработана для собственной защиты от запросов, которые могут вызвать несогласованное состояние.</span><span class="sxs-lookup"><span data-stu-id="d744d-143">However, the domain model must still be designed to protect itself from requests that might result in an inconsistent state.</span></span>

- <span data-ttu-id="d744d-144">Инкрементируемое хранилище событий предоставляет журнал аудита, который можно использовать для мониторинга событий, произошедших в хранилище данных, повторного создания текущего состояния в виде материализованного представления или проекций путем воспроизведения событий в любое время, а также упрощения тестирования и отладки системы.</span><span class="sxs-lookup"><span data-stu-id="d744d-144">The append-only storage of events provides an audit trail that can be used to monitor actions taken against a data store, regenerate the current state as materialized views or projections by replaying the events at any time, and assist in testing and debugging the system.</span></span> <span data-ttu-id="d744d-145">Кроме того, необходимость использовать компенсирующие события для отмены изменений предоставляет журнал изменений, которые были отменены, чего можно было бы избежать, если бы модель просто сохранила текущее состояние.</span><span class="sxs-lookup"><span data-stu-id="d744d-145">In addition, the requirement to use compensating events to cancel changes provides a history of changes that were reversed, which wouldn't be the case if the model simply stored the current state.</span></span> <span data-ttu-id="d744d-146">Список событий можно также использовать для анализа производительности приложения и выявления тенденций поведения пользователя или получения других полезных бизнес-сведений.</span><span class="sxs-lookup"><span data-stu-id="d744d-146">The list of events can also be used to analyze application performance and detect user behavior trends, or to obtain other useful business information.</span></span>

- <span data-ttu-id="d744d-147">Хранилище событий вызывает события, а задачи выполняют операции в ответ на эти события.</span><span class="sxs-lookup"><span data-stu-id="d744d-147">The event store raises events, and tasks perform operations in response to those events.</span></span> <span data-ttu-id="d744d-148">Это разделение задач и событий обеспечивает гибкость и расширяемость.</span><span class="sxs-lookup"><span data-stu-id="d744d-148">This decoupling of the tasks from the events provides flexibility and extensibility.</span></span> <span data-ttu-id="d744d-149">Задачи "знают" о типе и данных события, но не об операции, вызвавшей это событие.</span><span class="sxs-lookup"><span data-stu-id="d744d-149">Tasks know about the type of event and the event data, but not about the operation that triggered the event.</span></span> <span data-ttu-id="d744d-150">Кроме того, каждое событие могут обрабатывать несколько задач.</span><span class="sxs-lookup"><span data-stu-id="d744d-150">In addition, multiple tasks can handle each event.</span></span> <span data-ttu-id="d744d-151">Это обеспечивает простую интеграцию с другими службами и системами, которые только прослушивают новые события, вызванные хранилищем событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-151">This enables easy integration with other services and systems that only listen for new events raised by the event store.</span></span> <span data-ttu-id="d744d-152">Однако события источника событий зачастую являются низкоуровневыми, из-за чего может потребоваться создание определенных событий интеграции.</span><span class="sxs-lookup"><span data-stu-id="d744d-152">However, the event sourcing events tend to be very low level, and it might be necessary to generate specific integration events instead.</span></span>

> <span data-ttu-id="d744d-153">Источник событий часто сочетается с шаблоном CQRS за счет выполнения задач управления данными в ответ на события, а также материализации представления из хранимых событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-153">Event sourcing is commonly combined with the CQRS pattern by performing the data management tasks in response to the events, and by materializing views from the stored events.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="d744d-154">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="d744d-154">Issues and considerations</span></span>

<span data-ttu-id="d744d-155">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="d744d-155">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="d744d-156">Система будет согласованной в конечном счете только при создании материализованных представлений или проекций данных путем воспроизведения событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-156">The system will only be eventually consistent when creating materialized views or generating projections of data by replaying events.</span></span> <span data-ttu-id="d744d-157">Между добавлением событий приложения в хранилище событий (в результате обработки запроса), публикацией событий и обработкой событий потребителями есть некоторая задержка.</span><span class="sxs-lookup"><span data-stu-id="d744d-157">There's some delay between an application adding events to the event store as the result of handling a request, the events being published, and consumers of the events handling them.</span></span> <span data-ttu-id="d744d-158">В течение этого периода в хранилище событий могли попасть новые события, описывающие дальнейшие изменения сущностей.</span><span class="sxs-lookup"><span data-stu-id="d744d-158">During this period, new events that describe further changes to entities might have arrived at the event store.</span></span>

> [!NOTE]
> <span data-ttu-id="d744d-159">Дополнительные сведения о реализации итоговой согласованности см. в [руководстве по согласованности данных](https://msdn.microsoft.com/library/dn589800.aspx).</span><span class="sxs-lookup"><span data-stu-id="d744d-159">See the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for information about eventual consistency.</span></span>

<span data-ttu-id="d744d-160">Хранилище событий представляет собой постоянный источник данных и таким образом исключает необходимость обновления данных событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-160">The event store is the permanent source of information, and so the event data should never be updated.</span></span> <span data-ttu-id="d744d-161">Единственный способ обновить сущность для отмены изменения — добавить компенсирующее событие в хранилище событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-161">The only way to update an entity to undo a change is to add a compensating event to the event store.</span></span> <span data-ttu-id="d744d-162">Если необходимо изменить формат (а не данные) сохраненных событий (возможно, во время миграции), может возникнуть сложность при объединении имеющихся событий в хранилище с новой версией.</span><span class="sxs-lookup"><span data-stu-id="d744d-162">If the format (rather than the data) of the persisted events needs to change, perhaps during a migration, it can be difficult to combine existing events in the store with the new version.</span></span> <span data-ttu-id="d744d-163">Может потребоваться выполнить итерацию всех событий, внеся изменения для соответствия событий новому формату, или добавить новые события, использующие новый формат.</span><span class="sxs-lookup"><span data-stu-id="d744d-163">It might be necessary to iterate through all the events making changes so they're compliant with the new format, or add new events that use the new format.</span></span> <span data-ttu-id="d744d-164">Рассмотрите возможность использования штампа версии в каждой версии схемы события для поддержки прежнего и нового форматов событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-164">Consider using a version stamp on each version of the event schema to maintain both the old and the new event formats.</span></span>

<span data-ttu-id="d744d-165">Многопоточные приложения и несколько экземпляров приложений могут сохранять события в хранилище событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-165">Multi-threaded applications and multiple instances of applications might be storing events in the event store.</span></span> <span data-ttu-id="d744d-166">Согласованность событий в хранилище событий крайне важна, так как представляет собой порядок событий, влияющих на определенную сущность (порядок событий, который вызывает изменения в отношении сущности, влияет на ее текущее состояние).</span><span class="sxs-lookup"><span data-stu-id="d744d-166">The consistency of events in the event store is vital, as is the order of events that affect a specific entity (the order that changes occur to an entity affects its current state).</span></span> <span data-ttu-id="d744d-167">Добавление метки времени для каждого события может помочь избежать проблем.</span><span class="sxs-lookup"><span data-stu-id="d744d-167">Adding a timestamp to every event can help to avoid issues.</span></span> <span data-ttu-id="d744d-168">Другой распространенной практикой является добавление заметок для каждого события, вызванного запросом с добавочным идентификатором.</span><span class="sxs-lookup"><span data-stu-id="d744d-168">Another common practice is to annotate each event resulting from a request with an incremental identifier.</span></span> <span data-ttu-id="d744d-169">Если два действия пытаются добавить события для одной сущности одновременно, хранилище событий может отклонить событие, которое соответствует идентификатору имеющейся сущности и идентификатору события.</span><span class="sxs-lookup"><span data-stu-id="d744d-169">If two actions attempt to add events for the same entity at the same time, the event store can reject an event that matches an existing entity identifier and event identifier.</span></span>

<span data-ttu-id="d744d-170">Для считывания событий с целью получения сведений отсутствует стандартный подход или имеющиеся механизмы, например SQL-запросы.</span><span class="sxs-lookup"><span data-stu-id="d744d-170">There's no standard approach, or existing mechanisms such as SQL queries, for reading the events to obtain information.</span></span> <span data-ttu-id="d744d-171">Единственные данные, которые можно извлечь, — это поток событий, использующий идентификатор события в качестве условия.</span><span class="sxs-lookup"><span data-stu-id="d744d-171">The only data that can be extracted is a stream of events using an event identifier as the criteria.</span></span> <span data-ttu-id="d744d-172">Идентификатор события обычно сопоставляется с отдельными сущностями.</span><span class="sxs-lookup"><span data-stu-id="d744d-172">The event ID typically maps to individual entities.</span></span> <span data-ttu-id="d744d-173">Текущее состояние сущности можно определить только путем воспроизведения всех событий, связанных с ней в отношении исходного состояния этой сущности.</span><span class="sxs-lookup"><span data-stu-id="d744d-173">The current state of an entity can be determined only by replaying all of the events that relate to it against the original state of that entity.</span></span>

<span data-ttu-id="d744d-174">Продолжительность каждого потока события влияет на управление системой и ее обновление.</span><span class="sxs-lookup"><span data-stu-id="d744d-174">The length of each event stream affects managing and updating the system.</span></span> <span data-ttu-id="d744d-175">Если потоки объемные, можно создать моментальные снимки через определенные интервалы, например указанное количество событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-175">If the streams are large, consider creating snapshots at specific intervals such as a specified number of events.</span></span> <span data-ttu-id="d744d-176">Текущее состояние сущности можно получить из моментального снимка и за счет воспроизведения любого события, произошедшего после этой точки во времени.</span><span class="sxs-lookup"><span data-stu-id="d744d-176">The current state of the entity can be obtained from the snapshot and by replaying any events that occurred after that point in time.</span></span> <span data-ttu-id="d744d-177">Дополнительные сведения о создании моментальных снимков данных см. на страницах, посвященных [моментальному снимку](https://martinfowler.com/eaaDev/Snapshot.html) и [репликации моментального снимка](https://msdn.microsoft.com/library/ff650012.aspx).</span><span class="sxs-lookup"><span data-stu-id="d744d-177">For more information about creating snapshots of data, see [Snapshot on Martin Fowler’s Enterprise Application Architecture website](https://martinfowler.com/eaaDev/Snapshot.html) and [Master-Subordinate Snapshot Replication](https://msdn.microsoft.com/library/ff650012.aspx).</span></span>

<span data-ttu-id="d744d-178">Несмотря на то что источник событий снижает вероятность конфликта из-за обновления данных, приложение все равно должно устранить несоответствия, возникшие в результате итоговой согласованности и недостатка транзакций.</span><span class="sxs-lookup"><span data-stu-id="d744d-178">Even though event sourcing minimizes the chance of conflicting updates to the data, the application must still be able to deal with inconsistencies that result from eventual consistency and the lack of transactions.</span></span> <span data-ttu-id="d744d-179">Например, событие, указывающее на сокращение складских запасов, может поступить в хранилище данных во время размещения заказа для этой позиции, вызывая необходимость согласования двух операций: с помощью уведомления клиента или создания обратного заказа.</span><span class="sxs-lookup"><span data-stu-id="d744d-179">For example, an event that indicates a reduction in stock inventory might arrive in the data store while an order for that item is being placed, resulting in a requirement to reconcile the two operations either by advising the customer or creating a back order.</span></span>

<span data-ttu-id="d744d-180">Возможна как минимум одна публикация события, поэтому потребители событий должны быть идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="d744d-180">Event publication might be “at least once,” and so consumers of the events must be idempotent.</span></span> <span data-ttu-id="d744d-181">Они не должны повторно применять обновление, описанное в событии, если событие обрабатывается несколько раз.</span><span class="sxs-lookup"><span data-stu-id="d744d-181">They must not reapply the update described in an event if the event is handled more than once.</span></span> <span data-ttu-id="d744d-182">Например, если несколько экземпляров потребителя поддерживают статистическую обработку свойства сущности, например общее количество размещенных заказов, только для одного экземпляра успешно завершится добавление статистического выражения при возникновении события размещения заказа.</span><span class="sxs-lookup"><span data-stu-id="d744d-182">For example, if multiple instances of a consumer maintain an aggregate an entity's property, such as the total number of orders placed, only one must succeed in incrementing the aggregate when an order placed event occurs.</span></span> <span data-ttu-id="d744d-183">Это не основная характеристика источника событий, а обычное решение реализации.</span><span class="sxs-lookup"><span data-stu-id="d744d-183">While this isn't a key characteristic of event sourcing, it's the usual implementation decision.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="d744d-184">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="d744d-184">When to use this pattern</span></span>

<span data-ttu-id="d744d-185">Используйте этот шаблон в следующих сценариях:</span><span class="sxs-lookup"><span data-stu-id="d744d-185">Use this pattern in the following scenarios:</span></span>

- <span data-ttu-id="d744d-186">Когда в данные необходимо записать намерение, цель или причину.</span><span class="sxs-lookup"><span data-stu-id="d744d-186">When you want to capture intent, purpose, or reason in the data.</span></span> <span data-ttu-id="d744d-187">Например, изменения в сущности клиента можно записать как ряд определенных типов событий, таких как _Возвращение к исходному_, _Закрытая учетная запись_ или _Недействительные_.</span><span class="sxs-lookup"><span data-stu-id="d744d-187">For example, changes to a customer entity can be captured as a series of specific event types such as _Moved home_, _Closed account_, or _Deceased_.</span></span>

- <span data-ttu-id="d744d-188">Когда крайне важно свести к минимуму или полностью избежать конфликта операций обновления данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-188">When it's vital to minimize or completely avoid the occurrence of conflicting updates to data.</span></span>

- <span data-ttu-id="d744d-189">Если требуется записать происходящие события и иметь возможность воспроизвести их для восстановления состояния системы, отката изменений или сохранения истории и журнала аудита.</span><span class="sxs-lookup"><span data-stu-id="d744d-189">When you want to record events that occur, and be able to replay them to restore the state of a system, roll back changes, or keep a history and audit log.</span></span> <span data-ttu-id="d744d-190">Например, если задача включает несколько шагов, необходимых для восстановления обновлений и последующего воспроизведения некоторых действий для восстановления согласованного состояния данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-190">For example, when a task involves multiple steps you might need to execute actions to revert updates and then replay some steps to bring the data back into a consistent state.</span></span>

- <span data-ttu-id="d744d-191">Когда использование событий представляет собой стандартную возможность операции приложения и требует некоторой дополнительной разработки или усилий в отношении реализации.</span><span class="sxs-lookup"><span data-stu-id="d744d-191">When using events is a natural feature of the operation of the application, and requires little additional development or implementation effort.</span></span>

- <span data-ttu-id="d744d-192">Если нужно разбить процесс ввода или обновления данных из задач, необходимых для применения этих действий.</span><span class="sxs-lookup"><span data-stu-id="d744d-192">When you need to decouple the process of inputting or updating data from the tasks required to apply these actions.</span></span> <span data-ttu-id="d744d-193">Это может быть в целях улучшения производительности пользовательского интерфейса или распределения событий в другие прослушиватели, выполняющие определенные действия при возникновении событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-193">This might be to improve UI performance, or to distribute events to other listeners that take action when the events occur.</span></span> <span data-ttu-id="d744d-194">Например, интеграция платежной системы с веб-сайтом о расходах требуется для того, чтобы события, вызванные с помощью хранилища событий в ответ на обновления данных, реализованные для веб-сайта, использовались как веб-сайтом, так и платежной системой.</span><span class="sxs-lookup"><span data-stu-id="d744d-194">For example, integrating a payroll system with an expense submission website so that events raised by the event store in response to data updates made in the website are consumed by both the website and the payroll system.</span></span>

- <span data-ttu-id="d744d-195">Если необходима гибкость для изменения формата материализованных моделей и данных сущности при изменении требований или &mdash;использовании в сочетании с CQRS&mdash;, необходимо адаптировать модель чтения или представления с данными.</span><span class="sxs-lookup"><span data-stu-id="d744d-195">When you want flexibility to be able to change the format of materialized models and entity data if requirements change, or&mdash;when used in conjunction with CQRS&mdash;you need to adapt a read model or the views that expose the data.</span></span>

- <span data-ttu-id="d744d-196">Если используется в сочетании с CQRS, итоговая согласованность допустима при обновлении модели чтения или допустимо влияние на производительность при восстановленных сущностях и данных из потока события.</span><span class="sxs-lookup"><span data-stu-id="d744d-196">When used in conjunction with CQRS, and eventual consistency is acceptable while a read model is updated, or the performance impact of rehydrating entities and data from an event stream is acceptable.</span></span>

<span data-ttu-id="d744d-197">Этот шаблон неприменим в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="d744d-197">This pattern might not be useful in the following situations:</span></span>

- <span data-ttu-id="d744d-198">Для небольших или простых доменов, систем, которым не достает бизнес-логики или она и вовсе отсутствует, систем, не имеющих отношения к домену, которые обычно хорошо взаимодействуют со стандартными механизмами управления данных CRUD.</span><span class="sxs-lookup"><span data-stu-id="d744d-198">Small or simple domains, systems that have little or no business logic, or nondomain systems that naturally work well with traditional CRUD data management mechanisms.</span></span>

- <span data-ttu-id="d744d-199">Систем, где для представления данных требуются согласованность и обновления в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="d744d-199">Systems where consistency and real-time updates to the views of the data are required.</span></span>

- <span data-ttu-id="d744d-200">Систем, где для действий отката и воспроизведения не требуются определенные функции, история и журналы аудита.</span><span class="sxs-lookup"><span data-stu-id="d744d-200">Systems where audit trails, history, and capabilities to roll back and replay actions are not required.</span></span>

- <span data-ttu-id="d744d-201">Систем, где имеется незначительный конфликт обновлений в базовых данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-201">Systems where there's only a very low occurrence of conflicting updates to the underlying data.</span></span> <span data-ttu-id="d744d-202">Например, это системы, которые преимущественно добавляют данные, а не обновляют их.</span><span class="sxs-lookup"><span data-stu-id="d744d-202">For example, systems that predominantly add data rather than updating it.</span></span>

## <a name="example"></a><span data-ttu-id="d744d-203">Пример</span><span class="sxs-lookup"><span data-stu-id="d744d-203">Example</span></span>

<span data-ttu-id="d744d-204">Система управления конференцией должна отслеживать количество завершенных резервирований для конференц-связи, чтобы проверить наличие доступных мест при попытке потенциального участника зарезервировать место.</span><span class="sxs-lookup"><span data-stu-id="d744d-204">A conference management system needs to track the number of completed bookings for a conference so that it can check whether there are seats still available when a potential attendee tries to make a booking.</span></span> <span data-ttu-id="d744d-205">Имеется по крайней мере два способа хранения общего числа заявок на бронирование для конференции в системе:</span><span class="sxs-lookup"><span data-stu-id="d744d-205">The system could store the total number of bookings for a conference in at least two ways:</span></span>

- <span data-ttu-id="d744d-206">Она может хранить сведения об общем количестве зарезервированных мест в качестве отдельной сущности в базе данных, содержащей данные о резервировании.</span><span class="sxs-lookup"><span data-stu-id="d744d-206">The system could store the information about the total number of bookings as a separate entity in a database that holds booking information.</span></span> <span data-ttu-id="d744d-207">После резервирования мест или отмены резервирования система может соответствующим образом регулировать это количество.</span><span class="sxs-lookup"><span data-stu-id="d744d-207">As bookings are made or canceled, the system could increment or decrement this number as appropriate.</span></span> <span data-ttu-id="d744d-208">Этот подход прост в теории, но может привести к проблемам с масштабируемостью, если большое количество участников попытается зарезервировать места за короткий период времени.</span><span class="sxs-lookup"><span data-stu-id="d744d-208">This approach is simple in theory, but can cause scalability issues if a large number of attendees are attempting to book seats during a short period of time.</span></span> <span data-ttu-id="d744d-209">Например, в последний день или перед непосредственным завершением периода резервирования.</span><span class="sxs-lookup"><span data-stu-id="d744d-209">For example, in the last day or so prior to the booking period closing.</span></span>

- <span data-ttu-id="d744d-210">Система может хранить сведения о резервировании и отменах по мере выполнения событий в хранилище событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-210">The system could store information about bookings and cancellations as events held in an event store.</span></span> <span data-ttu-id="d744d-211">Затем путем воспроизведения этих событий она может рассчитать количество доступных мест.</span><span class="sxs-lookup"><span data-stu-id="d744d-211">It could then calculate the number of seats available by replaying these events.</span></span> <span data-ttu-id="d744d-212">Из-за неизменяемости событий этот подход может оказаться более масштабируемым.</span><span class="sxs-lookup"><span data-stu-id="d744d-212">This approach can be more scalable due to the immutability of events.</span></span> <span data-ttu-id="d744d-213">Системе необходимо только считывать данные из хранилища событий или добавлять их в это хранилище.</span><span class="sxs-lookup"><span data-stu-id="d744d-213">The system only needs to be able to read data from the event store, or append data to the event store.</span></span> <span data-ttu-id="d744d-214">Сведения события о резервировании и отменах никогда не изменяются.</span><span class="sxs-lookup"><span data-stu-id="d744d-214">Event information about bookings and cancellations is never modified.</span></span>

<span data-ttu-id="d744d-215">На схеме ниже показано, как с помощью источника событий можно реализовать подсистему резервирования мест системы управления конференцией.</span><span class="sxs-lookup"><span data-stu-id="d744d-215">The following diagram illustrates how the seat reservation subsystem of the conference management system might be implemented using event sourcing.</span></span>

![Использование источника событий для записи сведений о резервировании мест в системе управления конференцией](./_images/event-sourcing-bounded-context.png)

<span data-ttu-id="d744d-217">Последовательность действий для резервирования двух мест выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d744d-217">The sequence of actions for reserving two seats is as follows:</span></span>

1. <span data-ttu-id="d744d-218">Пользовательский интерфейс выдает команду для резервирования мест для двух участников.</span><span class="sxs-lookup"><span data-stu-id="d744d-218">The user interface issues a command to reserve seats for two attendees.</span></span> <span data-ttu-id="d744d-219">Команда обрабатывается отдельным обработчиком команд.</span><span class="sxs-lookup"><span data-stu-id="d744d-219">The command is handled by a separate command handler.</span></span> <span data-ttu-id="d744d-220">Часть логики, отделенная от пользовательского интерфейса и отвечающая за обработку запросов, записывается в виде команд.</span><span class="sxs-lookup"><span data-stu-id="d744d-220">A piece of logic that is decoupled from the user interface and is responsible for handling requests posted as commands.</span></span>

2. <span data-ttu-id="d744d-221">Статистическое выражение, содержащее сведения о всех местах резервирования для конференции, создается с помощью запроса событий, описывающих операции резервирования и отмены.</span><span class="sxs-lookup"><span data-stu-id="d744d-221">An aggregate containing information about all reservations for the conference is constructed by querying the events that describe bookings and cancellations.</span></span> <span data-ttu-id="d744d-222">Это статистическое выражение называется `SeatAvailability` и содержится в модели домена, предоставляющей методы для запроса и изменения данных в статистической обработке.</span><span class="sxs-lookup"><span data-stu-id="d744d-222">This aggregate is called `SeatAvailability`, and is contained within a domain model that exposes methods for querying and modifying the data in the aggregate.</span></span>

    > <span data-ttu-id="d744d-223">Некоторые способы оптимизации, которые можно рассмотреть, включают использование моментальных снимков (таким образом, вам не нужно выполнять запрос и воспроизводить полный список событий для получения текущего состояния статистической обработки), а также сохранение кэшированной копии статистической обработки в памяти.</span><span class="sxs-lookup"><span data-stu-id="d744d-223">Some optimizations to consider are using snapshots (so that you don’t need to query and replay the full list of events to obtain the current state of the aggregate), and maintaining a cached copy of the aggregate in memory.</span></span>

3. <span data-ttu-id="d744d-224">Для выполнения резервирования обработчик команд вызывает метод, предоставляемый моделью домена.</span><span class="sxs-lookup"><span data-stu-id="d744d-224">The command handler invokes a method exposed by the domain model to make the reservations.</span></span>

4. <span data-ttu-id="d744d-225">Статистическая функция `SeatAvailability` записывает событие, содержащее количество зарезервированных мест.</span><span class="sxs-lookup"><span data-stu-id="d744d-225">The `SeatAvailability` aggregate records an event containing the number of seats that were reserved.</span></span> <span data-ttu-id="d744d-226">При очередном применении событий статистической функцией все зарезервированные места будут использоваться для вычисления оставшихся мест.</span><span class="sxs-lookup"><span data-stu-id="d744d-226">The next time the aggregate applies events, all the reservations will be used to compute how many seats remain.</span></span>

5. <span data-ttu-id="d744d-227">Система добавляет новое событие в список событий в хранилище событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-227">The system appends the new event to the list of events in the event store.</span></span>

<span data-ttu-id="d744d-228">Если пользователь отменяет резервирование, в системе выполняется аналогичный процесс, за исключением того, что обработчик команд выдает команду, которая создает событие отмены места и добавляет это событие в хранилище событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-228">If a user cancels a seat, the system follows a similar process except the command handler issues a command that generates a seat cancellation event and appends it to the event store.</span></span>

<span data-ttu-id="d744d-229">Кроме предоставления дополнительных областей масштабируемости с помощью хранилища событий вы также получаете полный журнал или журнал аудита резервирования и отмены для конференции.</span><span class="sxs-lookup"><span data-stu-id="d744d-229">As well as providing more scope for scalability, using an event store also provides a complete history, or audit trail, of the bookings and cancellations for a conference.</span></span> <span data-ttu-id="d744d-230">События в хранилище событий представляют собой точные записи.</span><span class="sxs-lookup"><span data-stu-id="d744d-230">The events in the event store are the accurate record.</span></span> <span data-ttu-id="d744d-231">Сохранять статистические функции любым другим способом не нужно, так как система способна легко воспроизводить события и восстанавливать состояние до любой точки во времени.</span><span class="sxs-lookup"><span data-stu-id="d744d-231">There is no need to persist aggregates in any other way because the system can easily replay the events and restore the state to any point in time.</span></span>

> <span data-ttu-id="d744d-232">Дополнительные сведения об этом примере можно найти в руководстве, посвященном [обзору источника событий](https://msdn.microsoft.com/library/jj591559.aspx).</span><span class="sxs-lookup"><span data-stu-id="d744d-232">You can find more information about this example in [Introducing Event Sourcing](https://msdn.microsoft.com/library/jj591559.aspx).</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="d744d-233">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="d744d-233">Related patterns and guidance</span></span>

<span data-ttu-id="d744d-234">При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="d744d-234">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="d744d-235">[Шаблон выделения ответственности команды и запроса (CQRS)](./cqrs.md).</span><span class="sxs-lookup"><span data-stu-id="d744d-235">[Command and Query Responsibility Segregation (CQRS) pattern](./cqrs.md).</span></span> <span data-ttu-id="d744d-236">В хранилище записи, предоставляющее постоянный источник информации для реализации CQRS, часто используется реализация шаблона источника событий.</span><span class="sxs-lookup"><span data-stu-id="d744d-236">The write store that provides the permanent source of information for a CQRS implementation is often based on an implementation of the Event Sourcing pattern.</span></span> <span data-ttu-id="d744d-237">В этом шаблоне описывается, как отделить операции, считывающие данные в приложении, от операций обновления данных с помощью отдельных интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="d744d-237">Describes how to segregate the operations that read data in an application from the operations that update data by using separate interfaces.</span></span>

- <span data-ttu-id="d744d-238">[Materialized View Pattern](./materialized-view.md) (Шаблон материализованного представления).</span><span class="sxs-lookup"><span data-stu-id="d744d-238">[Materialized View pattern](./materialized-view.md).</span></span> <span data-ttu-id="d744d-239">Хранилище данных, используемое в системе на основе источника событий, для создания запросов обычно не подходит.</span><span class="sxs-lookup"><span data-stu-id="d744d-239">The data store used in a system based on event sourcing is typically not well suited to efficient querying.</span></span> <span data-ttu-id="d744d-240">Вместо этого наиболее распространенным подходом является создание предварительно заполненных представлений данных через регулярные интервалы или при изменении данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-240">Instead, a common approach is to generate prepopulated views of the data at regular intervals, or when the data changes.</span></span> <span data-ttu-id="d744d-241">Здесь можно рассмотреть реализацию.</span><span class="sxs-lookup"><span data-stu-id="d744d-241">Shows how this can be done.</span></span>

- <span data-ttu-id="d744d-242">[Шаблон компенсирующих транзакций](./compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="d744d-242">[Compensating Transaction pattern](./compensating-transaction.md).</span></span> <span data-ttu-id="d744d-243">Имеющиеся данные в хранилище источника событий не обновляются, вместо этого добавляются новые записи, которые преобразуют состояние сущностей в новые значения.</span><span class="sxs-lookup"><span data-stu-id="d744d-243">The existing data in an event sourcing store is not updated, instead new entries are added that transition the state of entities to the new values.</span></span> <span data-ttu-id="d744d-244">Чтобы отменить изменение, используются компенсирующие записи, так как невозможно просто отменить предыдущее изменение.</span><span class="sxs-lookup"><span data-stu-id="d744d-244">To reverse a change, compensating entries are used because it isn't possible to simply reverse the previous change.</span></span> <span data-ttu-id="d744d-245">Этот шаблон описывает, как отменить задачи, выполненные с помощью предыдущей операции.</span><span class="sxs-lookup"><span data-stu-id="d744d-245">Describes how to undo the work that was performed by a previous operation.</span></span>

- <span data-ttu-id="d744d-246">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Руководство по обеспечению согласованности данных).</span><span class="sxs-lookup"><span data-stu-id="d744d-246">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="d744d-247">При использовании источника событий с отдельным хранилищем чтения или материализованными представлениями данные для считывания не будут сразу согласованными, они будут только согласованными в конечном счете.</span><span class="sxs-lookup"><span data-stu-id="d744d-247">When using event sourcing with a separate read store or materialized views, the read data won't be immediately consistent, instead it'll be only eventually consistent.</span></span> <span data-ttu-id="d744d-248">В руководстве приведена сводка проблем, возникающих при обеспечении согласованности распределенных данных.</span><span class="sxs-lookup"><span data-stu-id="d744d-248">Summarizes the issues surrounding maintaining consistency over distributed data.</span></span>

- <span data-ttu-id="d744d-249">[Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx) (Руководство по секционированию данных).</span><span class="sxs-lookup"><span data-stu-id="d744d-249">[Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span> <span data-ttu-id="d744d-250">При использовании источника событий данные часто секционируются, чтобы улучшить масштабируемость, снизить число конфликтов и оптимизировать производительность.</span><span class="sxs-lookup"><span data-stu-id="d744d-250">Data is often partitioned when using event sourcing to improve scalability, reduce contention, and optimize performance.</span></span> <span data-ttu-id="d744d-251">В этом руководстве описывается, как разделить данные на дискретные секции, а также проблемы, с которыми можно столкнуться.</span><span class="sxs-lookup"><span data-stu-id="d744d-251">Describes how to divide data into discrete partitions, and the issues that can arise.</span></span>
