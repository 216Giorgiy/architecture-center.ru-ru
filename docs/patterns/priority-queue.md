---
title: Шаблон очереди с приоритетом
titleSuffix: Cloud Design Patterns
description: Запросы, отправляемые в службу, получают разные приоритеты. При этом запросы с высоким приоритетом принимаются и обрабатываются быстрее, чем запросы с низким приоритетом.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: b3cde9c59e7b4cd023369366ae69977b153eb805
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58244415"
---
# <a name="priority-queue-pattern"></a><span data-ttu-id="385d9-104">Шаблон очереди с приоритетом</span><span class="sxs-lookup"><span data-stu-id="385d9-104">Priority Queue pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="385d9-105">Назначайте приоритет запросам, отправляемым в службу, чтобы получать и обрабатывать запросы с высоким приоритетом быстрее, чем запросы с низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-105">Prioritize requests sent to services so that requests with a higher priority are received and processed more quickly than those with a lower priority.</span></span> <span data-ttu-id="385d9-106">Этот шаблон полезен в приложениях, предлагающих отдельным клиентам различные гарантии на уровне обслуживания.</span><span class="sxs-lookup"><span data-stu-id="385d9-106">This pattern is useful in applications that offer different service level guarantees to individual clients.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="385d9-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="385d9-107">Context and Problem</span></span>

<span data-ttu-id="385d9-108">Приложения могут делегировать задачи другим службам, например для выполнения фоновой обработки или для интеграции с другими приложениями или службами.</span><span class="sxs-lookup"><span data-stu-id="385d9-108">Applications can delegate specific tasks to other services, for example, to perform background processing or to integrate with other applications or services.</span></span> <span data-ttu-id="385d9-109">В облаке очередь сообщений обычно используется для делегирования задач фоновой обработки.</span><span class="sxs-lookup"><span data-stu-id="385d9-109">In the cloud, a message queue is typically used to delegate tasks to background processing.</span></span> <span data-ttu-id="385d9-110">Во многих случаях порядок запросов, полученных службой, не имеет значения.</span><span class="sxs-lookup"><span data-stu-id="385d9-110">In many cases the order requests are received in by a service isn't important.</span></span> <span data-ttu-id="385d9-111">В некоторых случаях он важен для определения приоритета конкретных запросов.</span><span class="sxs-lookup"><span data-stu-id="385d9-111">In some cases, though, it's necessary to prioritize specific requests.</span></span> <span data-ttu-id="385d9-112">Эти запросы должны обрабатываться перед низкоприоритетными запросами, которые были отправлены приложением ранее.</span><span class="sxs-lookup"><span data-stu-id="385d9-112">These requests should be processed earlier than lower priority requests that were sent previously by the application.</span></span>

## <a name="solution"></a><span data-ttu-id="385d9-113">Решение</span><span class="sxs-lookup"><span data-stu-id="385d9-113">Solution</span></span>

<span data-ttu-id="385d9-114">Очередь обычно является структурой, функционирующей по принципу FIFO ("первым поступил — первым обслужен"), а клиенты получают сообщения в том же порядке, в котором они были переданы в очередь.</span><span class="sxs-lookup"><span data-stu-id="385d9-114">A queue is usually a first-in, first-out (FIFO) structure, and consumers typically receive messages in the same order that they were posted to the queue.</span></span> <span data-ttu-id="385d9-115">Тем не менее некоторые очереди сообщений поддерживают приоритет обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="385d9-115">However, some message queues support priority messaging.</span></span> <span data-ttu-id="385d9-116">Приложение, отправляющее сообщение, может присваивать приоритет, а сообщения в очереди будут автоматически переупорядочиваться, поэтому сообщения с более высоким приоритетом будут получены раньше, чем сообщения с более низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-116">The application posting a message can assign a priority and the messages in the queue are automatically reordered so that those with a higher priority will be received before those with a lower priority.</span></span> <span data-ttu-id="385d9-117">На рисунке показана очередь с приоритетом обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="385d9-117">The figure illustrates a queue with priority messaging.</span></span>

![Рисунок 1. Использование механизма организации очередей, который поддерживает определение приоритета сообщений](./_images/priority-queue-pattern.png)

> <span data-ttu-id="385d9-119">Большинство реализаций очереди сообщений поддерживает отправку сообщений нескольким клиентам (согласно [шаблону конкурирующих потребителей](./competing-consumers.md)), а число клиентских процессов масштабируется по требованию.</span><span class="sxs-lookup"><span data-stu-id="385d9-119">Most message queue implementations support multiple consumers (following the [Competing Consumers pattern](./competing-consumers.md)), and the number of consumer processes can be scaled up or down depending on demand.</span></span>

<span data-ttu-id="385d9-120">В системах, которые не поддерживают очереди сообщений на основе приоритета, альтернативным решением является создание отдельной очереди для каждого уровня приоритета.</span><span class="sxs-lookup"><span data-stu-id="385d9-120">In systems that don't support priority-based message queues, an alternative solution is to maintain a separate queue for each priority.</span></span> <span data-ttu-id="385d9-121">Приложение отвечает за отправку сообщений в соответствующую очередь.</span><span class="sxs-lookup"><span data-stu-id="385d9-121">The application is responsible for posting messages to the appropriate queue.</span></span> <span data-ttu-id="385d9-122">Каждая очередь может иметь отдельный пул потребителей.</span><span class="sxs-lookup"><span data-stu-id="385d9-122">Each queue can have a separate pool of consumers.</span></span> <span data-ttu-id="385d9-123">В очередях с более высоким приоритетом пул потребителей, работающих на более быстром оборудовании, может быть больше, чем в очереди с более низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-123">Higher priority queues can have a larger pool of consumers running on faster hardware than lower priority queues.</span></span> <span data-ttu-id="385d9-124">На следующем рисунке показано использование отдельных очередей сообщений для каждого уровня приоритета.</span><span class="sxs-lookup"><span data-stu-id="385d9-124">The next figure illustrates using separate message queues for each priority.</span></span>

![Рисунок 2. Использование отдельный очередей сообщений для каждого уровня приоритета](./_images/priority-queue-separate.png)

<span data-ttu-id="385d9-126">Вариация этой стратегии — один пул потребителей, который сначала проверяет сообщения в приоритетных очередях и только затем начинает извлекать сообщения из очередей с более низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-126">A variation on this strategy is to have a single pool of consumers that check for messages on high priority queues first, and only then start to fetch messages from lower priority queues.</span></span> <span data-ttu-id="385d9-127">Есть некоторые семантические различия между решением, которое использует один пул процессов потребителя (либо с одной очередью, которая поддерживает сообщения с разными приоритетами, либо с несколькими очередями, каждая из которых обрабатывает сообщения с одним приоритетом), и решением, которое использует несколько очередей с отдельным пулом для каждой очереди.</span><span class="sxs-lookup"><span data-stu-id="385d9-127">There are some semantic differences between a solution that uses a single pool of consumer processes (either with a single queue that supports messages with different priorities or with multiple queues that each handle messages of a single priority), and a solution that uses multiple queues with a separate pool for each queue.</span></span>

<span data-ttu-id="385d9-128">При использовании подхода с одним пулом сообщения с более высоким приоритетом всегда поступают и обрабатываются перед сообщениями с низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-128">In the single pool approach, higher priority messages are always received and processed before lower priority messages.</span></span> <span data-ttu-id="385d9-129">В теории сообщения с очень низким приоритетом могут постоянно замещаться и никогда не будут обработаны.</span><span class="sxs-lookup"><span data-stu-id="385d9-129">In theory, messages that have a very low priority could be continually superseded and might never be processed.</span></span> <span data-ttu-id="385d9-130">При использовании нескольких пулов низкоприоритетные сообщения будут всегда обрабатываться, просто не так быстро, как сообщения с более высоким приоритетом (в зависимости от относительных размеров пулов и ресурсов, которые им доступны).</span><span class="sxs-lookup"><span data-stu-id="385d9-130">In the multiple pool approach, lower priority messages will always be processed, just not as quickly as those of a higher priority (depending on the relative size of the pools and the resources that they have available).</span></span>

<span data-ttu-id="385d9-131">Использование механизма приоритета очередей предоставляет следующие преимущества:</span><span class="sxs-lookup"><span data-stu-id="385d9-131">Using a priority queuing mechanism can provide the following advantages:</span></span>

- <span data-ttu-id="385d9-132">Он обеспечивает приложениям соответствие бизнес-требованиям, по которым нужны приоритеты в доступности или производительности, например за счет различных уровней обслуживания для определенных групп клиентов.</span><span class="sxs-lookup"><span data-stu-id="385d9-132">It allows applications to meet business requirements that require prioritization of availability or performance, such as offering different levels of service to specific groups of customers.</span></span>

- <span data-ttu-id="385d9-133">Это может помочь сократить эксплуатационные расходы.</span><span class="sxs-lookup"><span data-stu-id="385d9-133">It can help to minimize operational costs.</span></span> <span data-ttu-id="385d9-134">При использовании одной очереди можно выполнить обратное масштабирование числа потребителей, если это необходимо.</span><span class="sxs-lookup"><span data-stu-id="385d9-134">In the single queue approach, you can scale back the number of consumers if necessary.</span></span> <span data-ttu-id="385d9-135">Сообщения с высоким приоритетом будут по-прежнему обрабатываться в первую очередь (хотя, возможно, и медленнее), а обработка низкоприоритетных сообщений может быть отложена на еще больший срок.</span><span class="sxs-lookup"><span data-stu-id="385d9-135">High priority messages will still be processed first (although possibly more slowly), and lower priority messages might be delayed for longer.</span></span> <span data-ttu-id="385d9-136">Если реализован подход с несколькими очередями сообщений с отдельными пулами потребителей для каждой очереди, можно уменьшить пул потребителей для очередей с более низким приоритетом или даже приостановить обработку для очередей с очень низким приоритетом, остановив всех потребителей, которые ожидают передачу данных сообщений в этих очередях.</span><span class="sxs-lookup"><span data-stu-id="385d9-136">If you've implemented the multiple message queue approach with separate pools of consumers for each queue, you can reduce the pool of consumers for lower priority queues, or even suspend processing for some very low priority queues by stopping all the consumers that listen for messages on those queues.</span></span>

- <span data-ttu-id="385d9-137">Подход с несколькими очередями сообщений позволяет максимизировать производительность и масштабируемость приложений путем разделения сообщений по требованиям к обработке.</span><span class="sxs-lookup"><span data-stu-id="385d9-137">The multiple message queue approach can help maximize application performance and scalability by partitioning messages based on processing requirements.</span></span> <span data-ttu-id="385d9-138">Например, критически важные задачи могут иметь приоритет при обработке получателями, которые запускаются немедленно, в то время как менее важные фоновые задачи могут обрабатываться получателями, которые планируется запустить в менее загруженные периоды.</span><span class="sxs-lookup"><span data-stu-id="385d9-138">For example, vital tasks can be prioritized to be handled by receivers that run immediately while less important background tasks can be handled by receivers that are scheduled to run at less busy periods.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="385d9-139">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="385d9-139">Issues and Considerations</span></span>

<span data-ttu-id="385d9-140">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="385d9-140">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="385d9-141">Определяйте приоритеты в контексте решения.</span><span class="sxs-lookup"><span data-stu-id="385d9-141">Define the priorities in the context of the solution.</span></span> <span data-ttu-id="385d9-142">Например, высокий приоритет может означать, что сообщения могут обрабатываться в течение 10 секунд.</span><span class="sxs-lookup"><span data-stu-id="385d9-142">For example, high priority could mean that messages should be processed within ten seconds.</span></span> <span data-ttu-id="385d9-143">Идентифицируйте требования для обработки элементов с высоким приоритетом и ресурсы, которые следует выделить на выполнение этих требований.</span><span class="sxs-lookup"><span data-stu-id="385d9-143">Identify the requirements for handling high priority items, and the other resources that should be allocated to meet these criteria.</span></span>

<span data-ttu-id="385d9-144">Решите, должны ли все высокоприоритетные элементы обрабатываться перед любыми низкоприоритетными элементами.</span><span class="sxs-lookup"><span data-stu-id="385d9-144">Decide if all high priority items must be processed before any lower priority items.</span></span> <span data-ttu-id="385d9-145">Если сообщения обрабатываются в одном пуле потребителей, нужно предоставить механизм выгрузки и приостановки задачи, которая обрабатывает сообщение с низким приоритетом, если сообщение с более высоким приоритетом становится доступным.</span><span class="sxs-lookup"><span data-stu-id="385d9-145">If the messages are being processed by a single pool of consumers, you have to provide a mechanism that can preempt and suspend a task that's handling a low priority message if a higher priority message becomes available.</span></span>

<span data-ttu-id="385d9-146">В подходе с несколькими очередями при использовании одного пула потребительских процессов, который прослушивается во всех очередях, а не в выделенном пуле потребителей для каждой очереди, потребитель должен применять алгоритм, который гарантирует, что сообщения из очередей с более высоким приоритетом всегда обслуживаются перед сообщениями из низкоприоритетных очередей.</span><span class="sxs-lookup"><span data-stu-id="385d9-146">In the multiple queue approach, when using a single pool of consumer processes that listen on all queues rather than a dedicated consumer pool for each queue, the consumer must apply an algorithm that ensures it always services messages from higher priority queues before those from lower priority queues.</span></span>

<span data-ttu-id="385d9-147">Отслеживайте скорость обработки в очередях с высоким и низким приоритетами, чтобы гарантировать, что сообщения в этих очередях обрабатывались с ожидаемой скоростью.</span><span class="sxs-lookup"><span data-stu-id="385d9-147">Monitor the processing speed on high and low priority queues to ensure that messages in these queues are processed at the expected rates.</span></span>

<span data-ttu-id="385d9-148">Если нужно обеспечить обработку низкоприоритетных сообщений, необходимо реализовать подход, в котором предусмотрено несколько очередей сообщений с несколькими пулами потребителей.</span><span class="sxs-lookup"><span data-stu-id="385d9-148">If you need to guarantee that low priority messages will be processed, it's necessary to implement the multiple message queue approach with multiple pools of consumers.</span></span> <span data-ttu-id="385d9-149">Кроме того, в очереди, которая поддерживает определение приоритетов сообщений, есть возможность динамически увеличивать приоритет сообщения в очереди по мере истечения его срока годности.</span><span class="sxs-lookup"><span data-stu-id="385d9-149">Alternatively, in a queue that supports message prioritization, it's possible to dynamically increase the priority of a queued message as it ages.</span></span> <span data-ttu-id="385d9-150">Однако такой подход зависит от очереди сообщений, предоставляющих эту функцию.</span><span class="sxs-lookup"><span data-stu-id="385d9-150">However, this approach depends on the message queue providing this feature.</span></span>

<span data-ttu-id="385d9-151">Использование отдельной очереди для каждого приоритета сообщений лучше всего подходит для систем с небольшим количеством четко определенных приоритетов.</span><span class="sxs-lookup"><span data-stu-id="385d9-151">Using a separate queue for each message priority works best for systems that have a small number of well-defined priorities.</span></span>

<span data-ttu-id="385d9-152">Система может определять приоритеты сообщений логически.</span><span class="sxs-lookup"><span data-stu-id="385d9-152">Message priorities can be determined logically by the system.</span></span> <span data-ttu-id="385d9-153">Например, вместо явного отображения сообщений с высоким и низким приоритетом можно было бы назначить уровень "платный клиент" или "бесплатный клиент".</span><span class="sxs-lookup"><span data-stu-id="385d9-153">For example, rather than having explicit high and low priority messages, they could be designated as “fee paying customer,” or “non-fee paying customer.”</span></span> <span data-ttu-id="385d9-154">В зависимости от бизнес-модели система может выделить больше ресурсов для обработки сообщений от платных клиентов, чем от бесплатных.</span><span class="sxs-lookup"><span data-stu-id="385d9-154">Depending on your business model, your system can allocate more resources to processing messages from fee paying customers than non-fee paying ones.</span></span>

<span data-ttu-id="385d9-155">При проверке сообщений в очереди могут возникнуть финансовые затраты и затраты на обработку (в некоторых коммерческих системах обмена сообщениями при отправке или извлечении сообщения или запроса сообщений в очереди взимается небольшая плата).</span><span class="sxs-lookup"><span data-stu-id="385d9-155">There might be a financial and processing cost associated with checking a queue for a message (some commercial messaging systems charge a small fee each time a message is posted or retrieved, and each time a queue is queried for messages).</span></span> <span data-ttu-id="385d9-156">Плата увеличивается при проверке нескольких очередей.</span><span class="sxs-lookup"><span data-stu-id="385d9-156">This cost increases when checking multiple queues.</span></span>

<span data-ttu-id="385d9-157">Пул потребителей можно динамически настроить по длине очереди, которую обслуживает пул.</span><span class="sxs-lookup"><span data-stu-id="385d9-157">It's possible to dynamically adjust the size of a pool of consumers based on the length of the queue that the pool is servicing.</span></span> <span data-ttu-id="385d9-158">Дополнительные сведения см. в [руководстве по автомасштабированию](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="385d9-158">For more information, see the [Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="385d9-159">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="385d9-159">When to use this pattern</span></span>

<span data-ttu-id="385d9-160">Этот шаблон полезен в следующих ситуациях:</span><span class="sxs-lookup"><span data-stu-id="385d9-160">This pattern is useful in scenarios where:</span></span>

- <span data-ttu-id="385d9-161">система должна обработать несколько задач с различными приоритетами;</span><span class="sxs-lookup"><span data-stu-id="385d9-161">The system must handle multiple tasks that have different priorities.</span></span>

- <span data-ttu-id="385d9-162">различные пользователи и клиенты должны обслуживаться с разными приоритетами.</span><span class="sxs-lookup"><span data-stu-id="385d9-162">Different users or tenants should be served with different priority.</span></span>

## <a name="example"></a><span data-ttu-id="385d9-163">Пример</span><span class="sxs-lookup"><span data-stu-id="385d9-163">Example</span></span>

<span data-ttu-id="385d9-164">Microsoft Azure не предоставляет механизм организации очереди, который поддерживает автоматическое определение приоритетов сообщений с помощью сортировки.</span><span class="sxs-lookup"><span data-stu-id="385d9-164">Microsoft Azure doesn't provide a queuing mechanism that natively supports automatic prioritization of messages through sorting.</span></span> <span data-ttu-id="385d9-165">Однако предусмотрены разделы и подписки служебной шины Azure, которые поддерживают механизм организации очереди, предоставляющий фильтрацию сообщений и множество гибких возможностей, которые идеально подходят для использования в большинстве реализаций очереди с приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-165">However, it does provide Azure Service Bus topics and subscriptions that support a queuing mechanism that provides message filtering, together with a wide range of flexible capabilities that make it ideal for use in most priority queue implementations.</span></span>

<span data-ttu-id="385d9-166">В решении Azure можно реализовать раздел служебной шины, в который приложение может отправлять сообщения, также как в очередь.</span><span class="sxs-lookup"><span data-stu-id="385d9-166">An Azure solution can implement a Service Bus topic an application can post messages to, in the same way as a queue.</span></span> <span data-ttu-id="385d9-167">Сообщения могут содержать метаданные в форме пользовательских свойств, определенных приложением.</span><span class="sxs-lookup"><span data-stu-id="385d9-167">Messages can contain metadata in the form of application-defined custom properties.</span></span> <span data-ttu-id="385d9-168">Подписки служебной шины можно связать с разделом. Эти подписки могут фильтровать сообщения на основе их свойств.</span><span class="sxs-lookup"><span data-stu-id="385d9-168">Service Bus subscriptions can be associated with the topic, and these subscriptions can filter messages based on their properties.</span></span> <span data-ttu-id="385d9-169">Когда приложение отправляет сообщение в раздел, сообщение направляется в нужную подписку, где оно может быть прочитано.</span><span class="sxs-lookup"><span data-stu-id="385d9-169">When an application sends a message to a topic, the message is directed to the appropriate subscription where it can be read by a consumer.</span></span> <span data-ttu-id="385d9-170">Потребитель обрабатывает сообщения, полученные из подписки, используя ту же семантику, что и очередь сообщений (подписка — это логическая очередь).</span><span class="sxs-lookup"><span data-stu-id="385d9-170">Consumer processes can retrieve messages from a subscription using the same semantics as a message queue (a subscription is a logical queue).</span></span> <span data-ttu-id="385d9-171">На следующем рисунке показана реализация очереди с приоритетом с помощью разделов и подписок служебной шины.</span><span class="sxs-lookup"><span data-stu-id="385d9-171">The following figure illustrates implementing a priority queue with Azure Service Bus topics and subscriptions.</span></span>

![Рисунок 3. Реализация очереди с приоритетом при помощи разделов и подписок служебной шины](./_images/priority-queue-service-bus.png)

<span data-ttu-id="385d9-173">На приведенном выше рисунке приложение создает несколько сообщений и присваивает настраиваемое свойство, называемое `Priority` в каждом сообщении со значением `High` или `Low`.</span><span class="sxs-lookup"><span data-stu-id="385d9-173">In the figure above, the application creates several messages and assigns a custom property called `Priority` in each message with a value, either `High` or `Low`.</span></span> <span data-ttu-id="385d9-174">Приложение отправляет эти сообщения в раздел.</span><span class="sxs-lookup"><span data-stu-id="385d9-174">The application posts these messages to a topic.</span></span> <span data-ttu-id="385d9-175">Раздел содержит две связанные подписки, которые фильтруют сообщения с помощью проверки свойства `Priority`.</span><span class="sxs-lookup"><span data-stu-id="385d9-175">The topic has two associated subscriptions that both filter messages by examining the `Priority` property.</span></span> <span data-ttu-id="385d9-176">Одна подписка принимает сообщения, где свойство `Priority` имеет значение `High`, а другая — где свойство `Priority` имеет значение `Low`.</span><span class="sxs-lookup"><span data-stu-id="385d9-176">One subscription accepts messages where the `Priority` property is set to `High`, and the other accepts messages where the `Priority` property is set to `Low`.</span></span> <span data-ttu-id="385d9-177">Пул потребителей считывает сообщения из каждой подписки.</span><span class="sxs-lookup"><span data-stu-id="385d9-177">A pool of consumers reads messages from each subscription.</span></span> <span data-ttu-id="385d9-178">Подписка с высоким приоритетом имеет больший пул, поэтому потребители могут работать на более мощных компьютерах с большим количеством ресурсов, чем потребители в низкоприоритетном пуле.</span><span class="sxs-lookup"><span data-stu-id="385d9-178">The high priority subscription has a larger pool, and these consumers might be running on more powerful computers with more resources available than the consumers in the low priority pool.</span></span>

<span data-ttu-id="385d9-179">Обратите внимание, что в этом примере нет ничего особенного в обозначении сообщений с высоким и низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-179">Note that there's nothing special about the designation of high and low priority messages in this example.</span></span> <span data-ttu-id="385d9-180">Это просто метки, указанные в качестве свойств в каждом сообщении и используемые для направления сообщений в определенную подписку.</span><span class="sxs-lookup"><span data-stu-id="385d9-180">They're simply labels specified as properties in each message, and are used to direct messages to a specific subscription.</span></span> <span data-ttu-id="385d9-181">Если необходимы дополнительные приоритеты, можно относительно просто создать дополнительные подписки и пулы потребительских процессов для обработки этих приоритетов.</span><span class="sxs-lookup"><span data-stu-id="385d9-181">If additional priorities are required, it's relatively easy to create further subscriptions and pools of consumer processes to handle these priorities.</span></span>

<span data-ttu-id="385d9-182">Решение PriorityQueue, доступное на [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue), содержит реализацию этого подхода.</span><span class="sxs-lookup"><span data-stu-id="385d9-182">The PriorityQueue solution available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue) contains an implementation of this approach.</span></span> <span data-ttu-id="385d9-183">Это решение содержит проекты двух рабочих ролей с именем `PriorityQueue.High` и `PriorityQueue.Low`.</span><span class="sxs-lookup"><span data-stu-id="385d9-183">This solution contains two worker role projects named `PriorityQueue.High` and `PriorityQueue.Low`.</span></span> <span data-ttu-id="385d9-184">Эти рабочие роли наследуются от класса `PriorityWorkerRole`, который содержит функции для подключения к указанной подписке в методе `OnStart`.</span><span class="sxs-lookup"><span data-stu-id="385d9-184">These worker roles inherit from the `PriorityWorkerRole` class that contains the functionality for connecting to a specified subscription in the `OnStart` method.</span></span>

<span data-ttu-id="385d9-185">Рабочие роли `PriorityQueue.High` и `PriorityQueue.Low` подключаются к разным подпискам, которые определяются их параметрами конфигурации.</span><span class="sxs-lookup"><span data-stu-id="385d9-185">The `PriorityQueue.High` and `PriorityQueue.Low` worker roles connect to different subscriptions, defined by their configuration settings.</span></span> <span data-ttu-id="385d9-186">Администратор может настраивать различное количество ролей, которые нужно выполнить.</span><span class="sxs-lookup"><span data-stu-id="385d9-186">An administrator can configure different numbers of each role to be run.</span></span> <span data-ttu-id="385d9-187">Обычно у вас будет больше экземпляров рабочей роли `PriorityQueue.High`, чем рабочей роли `PriorityQueue.Low`.</span><span class="sxs-lookup"><span data-stu-id="385d9-187">Typically there'll be more instances of the `PriorityQueue.High` worker role than the `PriorityQueue.Low` worker role.</span></span>

<span data-ttu-id="385d9-188">Метод `Run` в классе `PriorityWorkerRole` упорядочивает виртуальный метод `ProcessMessage` (также определенный в классе `PriorityWorkerRole`) для выполнения для каждого сообщения, полученного в очереди.</span><span class="sxs-lookup"><span data-stu-id="385d9-188">The `Run` method in the `PriorityWorkerRole` class arranges for the virtual `ProcessMessage` method (also defined in the `PriorityWorkerRole` class) to be run for each message received on the queue.</span></span> <span data-ttu-id="385d9-189">В следующем коде приведены методы `Run` и `ProcessMessage`.</span><span class="sxs-lookup"><span data-stu-id="385d9-189">The following code shows the `Run` and `ProcessMessage` methods.</span></span> <span data-ttu-id="385d9-190">Класс `QueueManager`, определенный в проекте PriorityQueue.Shared, предоставляет вспомогательные методы для использования очередей служебной шины Azure.</span><span class="sxs-lookup"><span data-stu-id="385d9-190">The `QueueManager` class, defined in the PriorityQueue.Shared project, provides helper methods for using Azure Service Bus queues.</span></span>

```csharp
public class PriorityWorkerRole : RoleEntryPoint
{
  private QueueManager queueManager;
  ...

  public override void Run()
  {
    // Start listening for messages on the subscription.
    var subscriptionName = CloudConfigurationManager.GetSetting("SubscriptionName");
    this.queueManager.ReceiveMessages(subscriptionName, this.ProcessMessage);
    ...;
  }
  ...

  protected virtual async Task ProcessMessage(BrokeredMessage message)
  {
    // Simulating processing.
    await Task.Delay(TimeSpan.FromSeconds(2));
  }
}
```

<span data-ttu-id="385d9-191">Рабочие роли `PriorityQueue.High` и `PriorityQueue.Low` перезаписывают функции по умолчанию метода `ProcessMessage`.</span><span class="sxs-lookup"><span data-stu-id="385d9-191">The `PriorityQueue.High` and `PriorityQueue.Low` worker roles both override the default functionality of the `ProcessMessage` method.</span></span> <span data-ttu-id="385d9-192">В коде ниже показан метод `ProcessMessage` рабочей роли `PriorityQueue.High`.</span><span class="sxs-lookup"><span data-stu-id="385d9-192">The code below shows the `ProcessMessage` method for the `PriorityQueue.High` worker role.</span></span>

```csharp
protected override async Task ProcessMessage(BrokeredMessage message)
{
  // Simulate message processing for High priority messages.
  await base.ProcessMessage(message);
  Trace.TraceInformation("High priority message processed by " +
    RoleEnvironment.CurrentRoleInstance.Id + " MessageId: " + message.MessageId);
}
```

<span data-ttu-id="385d9-193">Когда приложение отправляет сообщение в раздел, связанный с подписками, используемыми в рабочих ролях `PriorityQueue.High` и `PriorityQueue.Low`, оно указывает приоритет с помощью настраиваемого свойства `Priority`, как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="385d9-193">When an application posts messages to the topic associated with the subscriptions used by the `PriorityQueue.High` and `PriorityQueue.Low` worker roles, it specifies the priority by using the `Priority` custom property, as shown in the following code example.</span></span> <span data-ttu-id="385d9-194">Код (реализованный в классе `WorkerRole` в проекте PriorityQueue.Sender) использует вспомогательный метод `SendBatchAsync` класса `QueueManager` для отправки сообщений в раздел в пакетах.</span><span class="sxs-lookup"><span data-stu-id="385d9-194">This code (implemented in the `WorkerRole` class in the PriorityQueue.Sender project), uses the `SendBatchAsync` helper method of the `QueueManager` class to post messages to a topic in batches.</span></span>

```csharp
// Send a low priority batch.
var lowMessages = new List<BrokeredMessage>();

for (int i = 0; i < 10; i++)
{
  var message = new BrokeredMessage() { MessageId = Guid.NewGuid().ToString() };
  message.Properties["Priority"] = Priority.Low;
  lowMessages.Add(message);
}

this.queueManager.SendBatchAsync(lowMessages).Wait();
...

// Send a high priority batch.
var highMessages = new List<BrokeredMessage>();

for (int i = 0; i < 10; i++)
{
  var message = new BrokeredMessage() { MessageId = Guid.NewGuid().ToString() };
  message.Properties["Priority"] = Priority.High;
  highMessages.Add(message);
}

this.queueManager.SendBatchAsync(highMessages).Wait();
```

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="385d9-195">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="385d9-195">Related patterns and guidance</span></span>

<span data-ttu-id="385d9-196">При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="385d9-196">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="385d9-197">Пример, демонстрирующий этот шаблон, можно найти на сайте [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue).</span><span class="sxs-lookup"><span data-stu-id="385d9-197">A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue).</span></span>

- <span data-ttu-id="385d9-198">[Руководство по асинхронному обмену сообщениями](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="385d9-198">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="385d9-199">Службе потребителя, которая обрабатывает запрос, может потребоваться отправить ответ на экземпляр приложения, отправившего запрос.</span><span class="sxs-lookup"><span data-stu-id="385d9-199">A consumer service that processes a request might need to send a reply to the instance of the application that posted the request.</span></span> <span data-ttu-id="385d9-200">Позволяет получить сведения о стратегиях, которые можно использовать для обмена сообщениями (запрос — ответ).</span><span class="sxs-lookup"><span data-stu-id="385d9-200">Provides information on the strategies that you can use to implement request/response messaging.</span></span>

- <span data-ttu-id="385d9-201">[Шаблон конкурирующих потребителей](./competing-consumers.md).</span><span class="sxs-lookup"><span data-stu-id="385d9-201">[Competing Consumers pattern](./competing-consumers.md).</span></span> <span data-ttu-id="385d9-202">Чтобы увеличить пропускную способность очередей, можно сделать так, чтобы несколько потребителей ожидали передачи данных в одной очереди и обрабатывали задачи параллельно.</span><span class="sxs-lookup"><span data-stu-id="385d9-202">To increase the throughput of the queues, it’s possible to have multiple consumers that listen on the same queue, and process the tasks in parallel.</span></span> <span data-ttu-id="385d9-203">Эти потребители будут конкурировать за сообщения, но только один должен иметь возможность обрабатывать каждое сообщение.</span><span class="sxs-lookup"><span data-stu-id="385d9-203">These consumers will compete for messages, but only one should be able to process each message.</span></span> <span data-ttu-id="385d9-204">Позволяет получить дополнительные сведения о преимуществах и недостатках реализации этого метода.</span><span class="sxs-lookup"><span data-stu-id="385d9-204">Provides more information on the benefits and tradeoffs of implementing this approach.</span></span>

- <span data-ttu-id="385d9-205">[Throttling pattern](./throttling.md) (Шаблон регулирования).</span><span class="sxs-lookup"><span data-stu-id="385d9-205">[Throttling pattern](./throttling.md).</span></span> <span data-ttu-id="385d9-206">Регулирование можно реализовать с помощью очередей.</span><span class="sxs-lookup"><span data-stu-id="385d9-206">You can implement throttling by using queues.</span></span> <span data-ttu-id="385d9-207">Приоритетные сообщения могут использоваться, чтобы запросы от критически важных приложений или приложений, выполняемых ценными клиентами, получали приоритет над запросами от менее важных приложений.</span><span class="sxs-lookup"><span data-stu-id="385d9-207">Priority messaging can be used to ensure that requests from critical applications, or applications being run by high-value customers, are given priority over requests from less important applications.</span></span>

- <span data-ttu-id="385d9-208">[Autoscaling](https://msdn.microsoft.com/library/dn589774.aspx) (Автомасштабирование).</span><span class="sxs-lookup"><span data-stu-id="385d9-208">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="385d9-209">В зависимости от длины очереди можно масштабировать размеры пула процессов пользователя, обрабатывающего очередь.</span><span class="sxs-lookup"><span data-stu-id="385d9-209">It might be possible to scale the size of the pool of consumer processes handling a queue depending on the length of the queue.</span></span> <span data-ttu-id="385d9-210">Эта стратегия помогает повысить производительность, особенно для пулов, обрабатывающих сообщения с высоким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="385d9-210">This strategy can help to improve performance, especially for pools handling high priority messages.</span></span>

- <span data-ttu-id="385d9-211">[Enterprise Integration Patterns with Service Bus (Part 2)](https://abhishekrlal.com/2013/01/11/enterprise-integration-patterns-with-service-bus-part-2/) (Шаблоны интеграции Enterprise со служебной шиной) в блоге Абхишека Лала (Abhishek Lal).</span><span class="sxs-lookup"><span data-stu-id="385d9-211">[Enterprise Integration Patterns with Service Bus](https://abhishekrlal.com/2013/01/11/enterprise-integration-patterns-with-service-bus-part-2/) on Abhishek Lal’s blog.</span></span>
