---
title: Компенсирующие транзакции
description: Отмена работы с выполнением серии шагов, которые вместе определяют согласованную в конечном счете операцию.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- resiliency
ms.openlocfilehash: a822de990d6ce933024207073b110e98f8da40bf
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2017
ms.locfileid: "26359406"
---
# <a name="compensating-transaction-pattern"></a>Шаблон компенсирующих транзакций

[!INCLUDE [header](../_includes/header.md)]

Вы можете отменить работу, выполненную рядом шагов, которые вместе образуют операцию по итоговому согласованию, если один или несколько шагов завершаются сбоем. Операции, которые следуют за моделью итоговой согласованности, обычно встречаются в облачных приложениях, которые реализуют сложные бизнес-процессы и рабочие процессы.

## <a name="context-and-problem"></a>Контекст и проблема

Приложения, работающие в облаке, часто изменяют данные. Эти данные могут быть распределены между различными источниками данных, которые содержатся в разных географических регионах. Чтобы избежать конфликтов и повысить производительность в распределенной среде, приложение не должно пытаться обеспечить надежную согласованность транзакций. Вместо этого приложение должно реализовать итоговую согласованность. В этой модели обычная бизнес-операция состоит из ряда отдельных этапов. Хотя эти шаги выполняются, общее состояние системы может быть несогласованным, но когда операция завершится и все шаги будут выполнены, система должна снова стать согласованной.

> [Руководство по согласованности данных](https://msdn.microsoft.com/library/dn589800.aspx) предоставляет сведения о том, почему распределенные транзакции не масштабируются надлежащим образом, а также о принципах модели итоговой согласованности.

Сложность модели итоговой согласованности заключается в обработке неудачного шага. В этом случае может потребоваться отменить всю работу, выполненную с помощью операций предыдущих шагов. Однако данные нельзя просто откатить, так как другие параллельно запущенные экземпляры приложения могли изменить данные. Даже в тех случаях, когда данные не были изменены параллельно запущенным экземпляром, отмена шага может заключаться не просто в восстановлении исходного состояния. Возможно, потребуется применять различные правила бизнес-процессов (см. веб-сайт путешествий, описанный в разделе "Пример").

Если операция, которая реализует конечную согласованность, охватывает несколько разнородных хранилищ данных, отмена шагов в операции требует поочередного посещения каждого хранилища. Работа, выполняемая в каждом хранилище данных, должна быть отменена, чтобы система не оставалась несогласованной.

Не все данные, затронутые операцией, которая реализует итоговую согласованность, могут храниться в базе данных. В среде сервис-ориентированной архитектуры (SOA) операция может вызвать действие в службе и вызвать изменение состояния, хранящегося в этой службе. Чтобы отменить операцию, это изменение состояния также должно быть отменено. Это может включать повторный вызов службы и выполнение другого действия, которое отменяет результаты первого.

## <a name="solution"></a>Решение

Решение заключается в реализации компенсирующей транзакции. Шаги в компенсирующей транзакции должны отменять действие шагов в исходной операции. Компенсирующая транзакция может оказаться неспособной просто заменить текущее состояние на состояние, в котором находилась система в начале операции, потому что при этом подходе изменения, сделанные другими параллельно запущенными экземплярами приложения, могут перезаписаться. Вместо этого необходим интеллектуальный процесс, который учитывает любую работу, выполняемую параллельно запущенными экземплярами. Этот процесс обычно будет предназначен для конкретного приложения, определяемый характером выполняемой исходной операцией.

Общим подходом является использование рабочего процесса для реализации операции по итоговому согласованию, требующей компенсации. По мере выполнения исходной операции система записывает информацию о каждом шаге и о том, как можно откатить работу, выполненную на этом шаге. Если в ​​любой момент операция завершается ошибкой, рабочий процесс поэтапно откатывается назад, выполняя работу, которая отменяет каждый шаг. Обратите внимание, что компенсирующая транзакция не обязательно должна отменять работу в точно обратном порядке по отношению к исходной операции, и, возможно, некоторые из шагов отмены можно будет выполнить параллельно.

> Этот подход аналогичен стратегии Саг, которая рассматривается в [блоге Клеменса Вастерса (Clemens Vasters)](http://vasters.com/clemensv/2012/09/01/Sagas.aspx).

Компенсирующая транзакция также является операцией по итоговому согласованию, и она также может закончиться сбоем. Система должна иметь возможность возобновить компенсирующую транзакцию в точке сбоя и продолжить работу. Возможно, потребуется повторить неудавшийся шаг, поэтому шаги в компенсирующей транзакции должны быть определены как идемпотентые команды. Дополнительные сведения см. в статье, посвященной [шаблонам идемпотентности](http://blog.jonathanoliver.com/idempotency-patterns/) в блоге Джонатана Оливера (Jonathan Oliver).

В некоторых случаях может оказаться невозможным восстановление с шага, который закончился сбоем, кроме как вручную. В этих ситуациях система должна создать оповещение и предоставить как можно больше информации о причине сбоя.

## <a name="issues-and-considerations"></a>Проблемы и рекомендации

При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.

Возможно, будет сложно определить, произошел ли сбой в операции, которая реализует итоговую согласованность. Шаг может завершиться сбоем не сразу, но вместо этого может быть заблокирован. Возможно, потребуется реализовать какой-то механизм тайм-аута.

Логика компенсации сложно поддается обобщению. Компенсирующая транзакция зависит от приложения. Она зависит от приложения, которое имеет достаточно сведений, чтобы отменить эффекты каждого шага в неудавшейся операции.

Вы должны определить шаги в компенсирующей транзакции как идемпотентные команды. Это позволяет повторять шаги, если сама компенсирующая транзакция заканчивается сбоем.

Инфраструктура, которая обрабатывает шаги в исходной операции и компенсирующую транзакцию, должна быть устойчивой. Она не должна терять сведения, необходимые для компенсации неудачного шага, и должна надежно контролировать ход логики компенсации.

Компенсирующая транзакция не обязательно возвращает данные в системе в состояние, в котором они находились в начале первоначальной операции. Вместо этого она компенсирует работу, выполненную с помощью шагов, которые успешно завершились до того, как операция завершилась сбоем.

Порядок шагов в компенсирующей транзакции необязательно должен быть полностью противоположным шагам в исходной операции. Например, одно хранилище данных может быть более чувствительно к несогласованностям, чем другое, и поэтому сначала следует выполнить шаги в компенсирующей транзакции, которые отменят изменения в этом хранилище.

Размещение кратковременной блокировки на основе тайм-аута в каждом ресурсе, который требуется для завершения операции, и получение этих ресурсов заблаговременно может помочь повысить вероятность успеха всей процедуры. Работу следует выполнять только после получения всех ресурсов. Необходимо завершить все действия до истечения срока действия блокировки.

Рекомендуется использовать более щадящую логику повторных попыток, чтобы свести к минимуму сбои, запускающие компенсирующие транзакции. Если какой-либо шаг в операции, которая реализует итоговую согласованность, сработает, попробуйте обработать сбой в качестве временного исключения и повторите шаг. Остановите операцию и инициируйте компенсирующую транзакцию, если шаг прерывается многократно или безвозвратно.

> Многие проблемы реализации компенсирующей транзакции аналогичны проблемам реализации итоговой согласованности. Дополнительные сведения о реализации итоговой согласованности см. в [руководстве по согласованности данных](https://msdn.microsoft.com/library/dn589800.aspx).

## <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

Используйте этот шаблон только для операций, которые необходимо отменить в случае сбоя. По возможности создавайте решения с учетом возникновения сложностей, требующих компенсирующих транзакций.

## <a name="example"></a>Пример

Веб-сайт путешествий позволяет клиентам бронировать маршруты. Один маршрут может включать в себя ряд перелетов и отелей. Клиент, путешествующий из Сиэтла в Лондон, а затем в Париж, может выполнить следующие шаги при создании маршрута:

1. Забронировать место в рейсе F1 из Сиэтла в Лондон.
2. Забронировать место в рейсе F2 из Лондона в Париж.
3. Забронировать место в рейсе F3 из Парижа в Сиэтл.
4. Забронировать номер в отеле H1 в Лондоне.
5. Забронировать номер в отеле H2 в Париже.

Эти шаги представляют собой операцию по итоговому согласованию, хотя каждый шаг является отдельным действием. Поэтому вместе с выполнением этих шагов система должна также записывать операции счетчика, необходимые для отмены каждого шага, если клиент решает отменить маршрут. Затем шаги, необходимые для выполнения операций счетчика, могут выполняться в виде компенсирующих транзакций.

Обратите внимание, что шаги в компенсирующей транзакции не обязательно должны быть противоположными исходным шагам, а логика на каждом этапе компенсирующей транзакции должна учитывать любые бизнес-правила. Например, отмена бронирования места в рейсе может не обеспечивать клиенту полного возмещения затрат. На рисунке показано создание компенсирующей транзакции для отмены продолжительной транзакции, чтобы забронировать маршрут путешествия.

![Создание компенсирующей транзакции для отмены продолжительной транзакции, чтобы забронировать маршрут путешествия](./_images/compensating-transaction-diagram.png)


> Возможно, что шаги в компенсирующей транзакции будут выполняться параллельно, в зависимости от того, как вы разработали компенсирующую логику для каждого шага.

Во многих бизнес-решениях сбой одного шага не всегда требует отката системы с помощью компенсирующей транзакции. Например, если &mdash;после бронирования рейсов F1, F2 и F3 в сценарии веб-сайта путешествия&mdash; клиент не может зарезервировать номер в отеле H1, желательно предложить клиенту номер в другом отеле в том же городе вместо отмены рейсов. Клиент всегда сможет отменить бронирование (в этом случае выполняется компенсирующая транзакция и отменяются бронирования на рейсы F1, F2 и F3), но это решение должно приниматься клиентом, а не системой.

## <a name="related-patterns-and-guidance"></a>Связанные шаблоны и рекомендации

При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.

- [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Руководство по обеспечению согласованности данных). Шаблон компенсирующей транзакции часто используется для отмены операций, реализующих модель итоговой согласованности. Это руководство содержит сведения о преимуществах и недостатках итоговой согласованности.

- [Scheduler-Agent-Supervisor Pattern](scheduler-agent-supervisor.md) (Шаблон "планировщик, агент, контролер"). Описывает, как внедрять отказоустойчивые системы, которые выполняют бизнес-операции с использованием распределенных служб и ресурсов. Иногда может потребоваться отменить работу, выполняемую операцией, с помощью компенсирующей транзакции.

- [Шаблон повторов](./retry.md). Компенсирующие транзакции могут быть дорогостоящими, и можно свести к минимуму их использование путем реализации эффективной политики повтора неудачных операций, следуя шаблону повторов.
