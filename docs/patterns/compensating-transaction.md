---
title: Компенсирующие транзакции
description: Отмена работы с выполнением серии шагов, которые вместе определяют согласованную в конечном счете операцию.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- resiliency
ms.openlocfilehash: 3d58537d9c77b97332bcabf762b9af7ed2f20421
ms.sourcegitcommit: 94d50043db63416c4d00cebe927a0c88f78c3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2018
ms.locfileid: "47428148"
---
# <a name="compensating-transaction-pattern"></a><span data-ttu-id="21fe3-104">Шаблон компенсирующих транзакций</span><span class="sxs-lookup"><span data-stu-id="21fe3-104">Compensating Transaction pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="21fe3-105">Вы можете отменить работу, выполненную рядом шагов, которые вместе образуют операцию по итоговому согласованию, если один или несколько шагов завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="21fe3-105">Undo the work performed by a series of steps, which together define an eventually consistent operation, if one or more of the steps fail.</span></span> <span data-ttu-id="21fe3-106">Операции, которые следуют за моделью итоговой согласованности, обычно встречаются в облачных приложениях, которые реализуют сложные бизнес-процессы и рабочие процессы.</span><span class="sxs-lookup"><span data-stu-id="21fe3-106">Operations that follow the eventual consistency model are commonly found in cloud-hosted applications that implement complex business processes and workflows.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="21fe3-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="21fe3-107">Context and problem</span></span>

<span data-ttu-id="21fe3-108">Приложения, работающие в облаке, часто изменяют данные.</span><span class="sxs-lookup"><span data-stu-id="21fe3-108">Applications running in the cloud frequently modify data.</span></span> <span data-ttu-id="21fe3-109">Эти данные могут быть распределены между различными источниками данных, которые содержатся в разных географических регионах.</span><span class="sxs-lookup"><span data-stu-id="21fe3-109">This data might be spread across various data sources held in different geographic locations.</span></span> <span data-ttu-id="21fe3-110">Чтобы избежать конфликтов и повысить производительность в распределенной среде, приложение не должно пытаться обеспечить надежную согласованность транзакций.</span><span class="sxs-lookup"><span data-stu-id="21fe3-110">To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency.</span></span> <span data-ttu-id="21fe3-111">Вместо этого приложение должно реализовать итоговую согласованность.</span><span class="sxs-lookup"><span data-stu-id="21fe3-111">Rather, the application should implement eventual consistency.</span></span> <span data-ttu-id="21fe3-112">В этой модели обычная бизнес-операция состоит из ряда отдельных этапов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-112">In this model, a typical business operation consists of a series of separate steps.</span></span> <span data-ttu-id="21fe3-113">Хотя эти шаги выполняются, общее состояние системы может быть несогласованным, но когда операция завершится и все шаги будут выполнены, система должна снова стать согласованной.</span><span class="sxs-lookup"><span data-stu-id="21fe3-113">While these steps are being performed, the overall view of the system state might be inconsistent, but when the operation has completed and all of the steps have been executed the system should become consistent again.</span></span>

> <span data-ttu-id="21fe3-114">[Руководство по согласованности данных](https://msdn.microsoft.com/library/dn589800.aspx) предоставляет сведения о том, почему распределенные транзакции не масштабируются надлежащим образом, а также о принципах модели итоговой согласованности.</span><span class="sxs-lookup"><span data-stu-id="21fe3-114">The [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) provides information about why distributed transactions don't scale well, and the principles of the eventual consistency model.</span></span>

<span data-ttu-id="21fe3-115">Сложность модели итоговой согласованности заключается в обработке неудачного шага.</span><span class="sxs-lookup"><span data-stu-id="21fe3-115">A challenge in the eventual consistency model is how to handle a step that has failed.</span></span> <span data-ttu-id="21fe3-116">В этом случае может потребоваться отменить всю работу, выполненную с помощью операций предыдущих шагов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-116">In this case it might be necessary to undo all of the work completed by the previous steps in the operation.</span></span> <span data-ttu-id="21fe3-117">Однако данные нельзя просто откатить, так как другие параллельно запущенные экземпляры приложения могли изменить данные.</span><span class="sxs-lookup"><span data-stu-id="21fe3-117">However, the data can't simply be rolled back because other concurrent instances of the application might have changed it.</span></span> <span data-ttu-id="21fe3-118">Даже в тех случаях, когда данные не были изменены параллельно запущенным экземпляром, отмена шага может заключаться не просто в восстановлении исходного состояния.</span><span class="sxs-lookup"><span data-stu-id="21fe3-118">Even in cases where the data hasn't been changed by a concurrent instance, undoing a step might not simply be a matter of restoring the original state.</span></span> <span data-ttu-id="21fe3-119">Возможно, потребуется применять различные правила бизнес-процессов (см. веб-сайт путешествий, описанный в разделе "Пример").</span><span class="sxs-lookup"><span data-stu-id="21fe3-119">It might be necessary to apply various business-specific rules (see the travel website described in the Example section).</span></span>

<span data-ttu-id="21fe3-120">Если операция, которая реализует конечную согласованность, охватывает несколько разнородных хранилищ данных, отмена шагов в операции требует поочередного посещения каждого хранилища.</span><span class="sxs-lookup"><span data-stu-id="21fe3-120">If an operation that implements eventual consistency spans several heterogeneous data stores, undoing the steps in the operation will require visiting each data store in turn.</span></span> <span data-ttu-id="21fe3-121">Работа, выполняемая в каждом хранилище данных, должна быть отменена, чтобы система не оставалась несогласованной.</span><span class="sxs-lookup"><span data-stu-id="21fe3-121">The work performed in every data store must be undone reliably to prevent the system from remaining inconsistent.</span></span>

<span data-ttu-id="21fe3-122">Не все данные, затронутые операцией, которая реализует итоговую согласованность, могут храниться в базе данных.</span><span class="sxs-lookup"><span data-stu-id="21fe3-122">Not all data affected by an operation that implements eventual consistency might be held in a database.</span></span> <span data-ttu-id="21fe3-123">В среде сервис-ориентированной архитектуры (SOA) операция может вызвать действие в службе и вызвать изменение состояния, хранящегося в этой службе.</span><span class="sxs-lookup"><span data-stu-id="21fe3-123">In a service oriented architecture (SOA) environment an operation could invoke an action in a service, and cause a change in the state held by that service.</span></span> <span data-ttu-id="21fe3-124">Чтобы отменить операцию, это изменение состояния также должно быть отменено.</span><span class="sxs-lookup"><span data-stu-id="21fe3-124">To undo the operation, this state change must also be undone.</span></span> <span data-ttu-id="21fe3-125">Это может включать повторный вызов службы и выполнение другого действия, которое отменяет результаты первого.</span><span class="sxs-lookup"><span data-stu-id="21fe3-125">This can involve invoking the service again and performing another action that reverses the effects of the first.</span></span>

## <a name="solution"></a><span data-ttu-id="21fe3-126">Решение</span><span class="sxs-lookup"><span data-stu-id="21fe3-126">Solution</span></span>

<span data-ttu-id="21fe3-127">Решение заключается в реализации компенсирующей транзакции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-127">The solution is to implement a compensating transaction.</span></span> <span data-ttu-id="21fe3-128">Шаги в компенсирующей транзакции должны отменять действие шагов в исходной операции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-128">The steps in a compensating transaction must undo the effects of the steps in the original operation.</span></span> <span data-ttu-id="21fe3-129">Компенсирующая транзакция может оказаться неспособной просто заменить текущее состояние на состояние, в котором находилась система в начале операции, потому что при этом подходе изменения, сделанные другими параллельно запущенными экземплярами приложения, могут перезаписаться.</span><span class="sxs-lookup"><span data-stu-id="21fe3-129">A compensating transaction might not be able to simply replace the current state with the state the system was in at the start of the operation because this approach could overwrite changes made by other concurrent instances of an application.</span></span> <span data-ttu-id="21fe3-130">Вместо этого необходим интеллектуальный процесс, который учитывает любую работу, выполняемую параллельно запущенными экземплярами.</span><span class="sxs-lookup"><span data-stu-id="21fe3-130">Instead, it must be an intelligent process that takes into account any work done by concurrent instances.</span></span> <span data-ttu-id="21fe3-131">Этот процесс обычно будет предназначен для конкретного приложения, определяемый характером выполняемой исходной операцией.</span><span class="sxs-lookup"><span data-stu-id="21fe3-131">This process will usually be application specific, driven by the nature of the work performed by the original operation.</span></span>

<span data-ttu-id="21fe3-132">Общим подходом является использование рабочего процесса для реализации операции по итоговому согласованию, требующей компенсации.</span><span class="sxs-lookup"><span data-stu-id="21fe3-132">A common approach is to use a workflow to implement an eventually consistent operation that requires compensation.</span></span> <span data-ttu-id="21fe3-133">По мере выполнения исходной операции система записывает информацию о каждом шаге и о том, как можно откатить работу, выполненную на этом шаге.</span><span class="sxs-lookup"><span data-stu-id="21fe3-133">As the original operation proceeds, the system records information about each step and how the work performed by that step can be undone.</span></span> <span data-ttu-id="21fe3-134">Если в ​​любой момент операция завершается ошибкой, рабочий процесс поэтапно откатывается назад, выполняя работу, которая отменяет каждый шаг.</span><span class="sxs-lookup"><span data-stu-id="21fe3-134">If the operation fails at any point, the workflow rewinds back through the steps it's completed and performs the work that reverses each step.</span></span> <span data-ttu-id="21fe3-135">Обратите внимание, что компенсирующая транзакция не обязательно должна отменять работу в точно обратном порядке по отношению к исходной операции, и, возможно, некоторые из шагов отмены можно будет выполнить параллельно.</span><span class="sxs-lookup"><span data-stu-id="21fe3-135">Note that a compensating transaction might not have to undo the work in the exact reverse order of the original operation, and it might be possible to perform some of the undo steps in parallel.</span></span>

> <span data-ttu-id="21fe3-136">Этот подход аналогичен стратегии Саг, которая рассматривается в [блоге Клеменса Вастерса (Clemens Vasters)](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span><span class="sxs-lookup"><span data-stu-id="21fe3-136">This approach is similar to the Sagas strategy discussed in [Clemens Vasters’ blog](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span></span>

<span data-ttu-id="21fe3-137">Компенсирующая транзакция также является операцией по итоговому согласованию, и она также может закончиться сбоем.</span><span class="sxs-lookup"><span data-stu-id="21fe3-137">A compensating transaction is also an eventually consistent operation and it could also fail.</span></span> <span data-ttu-id="21fe3-138">Система должна иметь возможность возобновить компенсирующую транзакцию в точке сбоя и продолжить работу.</span><span class="sxs-lookup"><span data-stu-id="21fe3-138">The system should be able to resume the compensating transaction at the point of failure and continue.</span></span> <span data-ttu-id="21fe3-139">Возможно, потребуется повторить неудавшийся шаг, поэтому шаги в компенсирующей транзакции должны быть определены как идемпотентые команды.</span><span class="sxs-lookup"><span data-stu-id="21fe3-139">It might be necessary to repeat a step that's failed, so the steps in a compensating transaction should be defined as idempotent commands.</span></span> <span data-ttu-id="21fe3-140">Дополнительные сведения см. в статье, посвященной [шаблонам идемпотентности](https://blog.jonathanoliver.com/idempotency-patterns/) в блоге Джонатана Оливера (Jonathan Oliver).</span><span class="sxs-lookup"><span data-stu-id="21fe3-140">For more information, see [Idempotency Patterns](https://blog.jonathanoliver.com/idempotency-patterns/) on Jonathan Oliver’s blog.</span></span>

<span data-ttu-id="21fe3-141">В некоторых случаях может оказаться невозможным восстановление с шага, который закончился сбоем, кроме как вручную.</span><span class="sxs-lookup"><span data-stu-id="21fe3-141">In some cases it might not be possible to recover from a step that has failed except through manual intervention.</span></span> <span data-ttu-id="21fe3-142">В этих ситуациях система должна создать оповещение и предоставить как можно больше информации о причине сбоя.</span><span class="sxs-lookup"><span data-stu-id="21fe3-142">In these situations the system should raise an alert and provide as much information as possible about the reason for the failure.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="21fe3-143">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="21fe3-143">Issues and considerations</span></span>

<span data-ttu-id="21fe3-144">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="21fe3-144">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="21fe3-145">Возможно, будет сложно определить, произошел ли сбой в операции, которая реализует итоговую согласованность.</span><span class="sxs-lookup"><span data-stu-id="21fe3-145">It might not be easy to determine when a step in an operation that implements eventual consistency has failed.</span></span> <span data-ttu-id="21fe3-146">Шаг может завершиться сбоем не сразу, но вместо этого может быть заблокирован.</span><span class="sxs-lookup"><span data-stu-id="21fe3-146">A step might not fail immediately, but instead could block.</span></span> <span data-ttu-id="21fe3-147">Возможно, потребуется реализовать какой-то механизм тайм-аута.</span><span class="sxs-lookup"><span data-stu-id="21fe3-147">It might be necessary to implement some form of time-out mechanism.</span></span>

<span data-ttu-id="21fe3-148">Логика компенсации сложно поддается обобщению.</span><span class="sxs-lookup"><span data-stu-id="21fe3-148">-Compensation logic isn't easily generalized.</span></span> <span data-ttu-id="21fe3-149">Компенсирующая транзакция зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="21fe3-149">A compensating transaction is application specific.</span></span> <span data-ttu-id="21fe3-150">Она зависит от приложения, которое имеет достаточно сведений, чтобы отменить эффекты каждого шага в неудавшейся операции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-150">It relies on the application having sufficient information to be able to undo the effects of each step in a failed operation.</span></span>

<span data-ttu-id="21fe3-151">Вы должны определить шаги в компенсирующей транзакции как идемпотентные команды.</span><span class="sxs-lookup"><span data-stu-id="21fe3-151">You should define the steps in a compensating transaction as idempotent commands.</span></span> <span data-ttu-id="21fe3-152">Это позволяет повторять шаги, если сама компенсирующая транзакция заканчивается сбоем.</span><span class="sxs-lookup"><span data-stu-id="21fe3-152">This enables the steps to be repeated if the compensating transaction itself fails.</span></span>

<span data-ttu-id="21fe3-153">Инфраструктура, которая обрабатывает шаги в исходной операции и компенсирующую транзакцию, должна быть устойчивой.</span><span class="sxs-lookup"><span data-stu-id="21fe3-153">The infrastructure that handles the steps in the original operation, and the compensating transaction, must be resilient.</span></span> <span data-ttu-id="21fe3-154">Она не должна терять сведения, необходимые для компенсации неудачного шага, и должна надежно контролировать ход логики компенсации.</span><span class="sxs-lookup"><span data-stu-id="21fe3-154">It must not lose the information required to compensate for a failing step, and it must be able to reliably monitor the progress of the compensation logic.</span></span>

<span data-ttu-id="21fe3-155">Компенсирующая транзакция не обязательно возвращает данные в системе в состояние, в котором они находились в начале первоначальной операции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-155">A compensating transaction doesn't necessarily return the data in the system to the state it was in at the start of the original operation.</span></span> <span data-ttu-id="21fe3-156">Вместо этого она компенсирует работу, выполненную с помощью шагов, которые успешно завершились до того, как операция завершилась сбоем.</span><span class="sxs-lookup"><span data-stu-id="21fe3-156">Instead, it compensates for the work performed by the steps that completed successfully before the operation failed.</span></span>

<span data-ttu-id="21fe3-157">Порядок шагов в компенсирующей транзакции необязательно должен быть полностью противоположным шагам в исходной операции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-157">The order of the steps in the compensating transaction doesn't necessarily have to be the exact opposite of the steps in the original operation.</span></span> <span data-ttu-id="21fe3-158">Например, одно хранилище данных может быть более чувствительно к несогласованностям, чем другое, и поэтому сначала следует выполнить шаги в компенсирующей транзакции, которые отменят изменения в этом хранилище.</span><span class="sxs-lookup"><span data-stu-id="21fe3-158">For example, one data store might be more sensitive to inconsistencies than another, and so the steps in the compensating transaction that undo the changes to this store should occur first.</span></span>

<span data-ttu-id="21fe3-159">Размещение кратковременной блокировки на основе тайм-аута в каждом ресурсе, который требуется для завершения операции, и получение этих ресурсов заблаговременно может помочь повысить вероятность успеха всей процедуры.</span><span class="sxs-lookup"><span data-stu-id="21fe3-159">Placing a short-term timeout-based lock on each resource that's required to complete an operation, and obtaining these resources in advance, can help increase the likelihood that the overall activity will succeed.</span></span> <span data-ttu-id="21fe3-160">Работу следует выполнять только после получения всех ресурсов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-160">The work should be performed only after all the resources have been acquired.</span></span> <span data-ttu-id="21fe3-161">Необходимо завершить все действия до истечения срока действия блокировки.</span><span class="sxs-lookup"><span data-stu-id="21fe3-161">All actions must be finalized before the locks expire.</span></span>

<span data-ttu-id="21fe3-162">Рекомендуется использовать более щадящую логику повторных попыток, чтобы свести к минимуму сбои, запускающие компенсирующие транзакции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-162">Consider using retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction.</span></span> <span data-ttu-id="21fe3-163">Если какой-либо шаг в операции, которая реализует итоговую согласованность, сработает, попробуйте обработать сбой в качестве временного исключения и повторите шаг.</span><span class="sxs-lookup"><span data-stu-id="21fe3-163">If a step in an operation that implements eventual consistency fails, try handling the failure as a transient exception and repeat the step.</span></span> <span data-ttu-id="21fe3-164">Остановите операцию и инициируйте компенсирующую транзакцию, если шаг прерывается многократно или безвозвратно.</span><span class="sxs-lookup"><span data-stu-id="21fe3-164">Only stop the operation and initiate a compensating transaction if a step fails repeatedly or irrecoverably.</span></span>

> <span data-ttu-id="21fe3-165">Многие проблемы реализации компенсирующей транзакции аналогичны проблемам реализации итоговой согласованности.</span><span class="sxs-lookup"><span data-stu-id="21fe3-165">Many of the challenges of implementing a compensating transaction are the same as those with implementing eventual consistency.</span></span> <span data-ttu-id="21fe3-166">Дополнительные сведения о реализации итоговой согласованности см. в [руководстве по согласованности данных](https://msdn.microsoft.com/library/dn589800.aspx).</span><span class="sxs-lookup"><span data-stu-id="21fe3-166">See the section Considerations for Implementing Eventual Consistency in the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for more information.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="21fe3-167">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="21fe3-167">When to use this pattern</span></span>

<span data-ttu-id="21fe3-168">Используйте этот шаблон только для операций, которые необходимо отменить в случае сбоя.</span><span class="sxs-lookup"><span data-stu-id="21fe3-168">Use this pattern only for operations that must be undone if they fail.</span></span> <span data-ttu-id="21fe3-169">По возможности создавайте решения с учетом возникновения сложностей, требующих компенсирующих транзакций.</span><span class="sxs-lookup"><span data-stu-id="21fe3-169">If possible, design solutions to avoid the complexity of requiring compensating transactions.</span></span>

## <a name="example"></a><span data-ttu-id="21fe3-170">Пример</span><span class="sxs-lookup"><span data-stu-id="21fe3-170">Example</span></span>

<span data-ttu-id="21fe3-171">Веб-сайт путешествий позволяет клиентам бронировать маршруты.</span><span class="sxs-lookup"><span data-stu-id="21fe3-171">A travel website lets customers book itineraries.</span></span> <span data-ttu-id="21fe3-172">Один маршрут может включать в себя ряд перелетов и отелей.</span><span class="sxs-lookup"><span data-stu-id="21fe3-172">A single itinerary might comprise a series of flights and hotels.</span></span> <span data-ttu-id="21fe3-173">Клиент, путешествующий из Сиэтла в Лондон, а затем в Париж, может выполнить следующие шаги при создании маршрута:</span><span class="sxs-lookup"><span data-stu-id="21fe3-173">A customer traveling from Seattle to London and then on to Paris could perform the following steps when creating an itinerary:</span></span>

1. <span data-ttu-id="21fe3-174">Забронировать место в рейсе F1 из Сиэтла в Лондон.</span><span class="sxs-lookup"><span data-stu-id="21fe3-174">Book a seat on flight F1 from Seattle to London.</span></span>
2. <span data-ttu-id="21fe3-175">Забронировать место в рейсе F2 из Лондона в Париж.</span><span class="sxs-lookup"><span data-stu-id="21fe3-175">Book a seat on flight F2 from London to Paris.</span></span>
3. <span data-ttu-id="21fe3-176">Забронировать место в рейсе F3 из Парижа в Сиэтл.</span><span class="sxs-lookup"><span data-stu-id="21fe3-176">Book a seat on flight F3 from Paris to Seattle.</span></span>
4. <span data-ttu-id="21fe3-177">Забронировать номер в отеле H1 в Лондоне.</span><span class="sxs-lookup"><span data-stu-id="21fe3-177">Reserve a room at hotel H1 in London.</span></span>
5. <span data-ttu-id="21fe3-178">Забронировать номер в отеле H2 в Париже.</span><span class="sxs-lookup"><span data-stu-id="21fe3-178">Reserve a room at hotel H2 in Paris.</span></span>

<span data-ttu-id="21fe3-179">Эти шаги представляют собой операцию по итоговому согласованию, хотя каждый шаг является отдельным действием.</span><span class="sxs-lookup"><span data-stu-id="21fe3-179">These steps constitute an eventually consistent operation, although each step is a separate action.</span></span> <span data-ttu-id="21fe3-180">Поэтому вместе с выполнением этих шагов система должна также записывать операции счетчика, необходимые для отмены каждого шага, если клиент решает отменить маршрут.</span><span class="sxs-lookup"><span data-stu-id="21fe3-180">Therefore, as well as performing these steps, the system must also record the counter operations necessary to undo each step in case the customer decides to cancel the itinerary.</span></span> <span data-ttu-id="21fe3-181">Затем шаги, необходимые для выполнения операций счетчика, могут выполняться в виде компенсирующих транзакций.</span><span class="sxs-lookup"><span data-stu-id="21fe3-181">The steps necessary to perform the counter operations can then run as a compensating transaction.</span></span>

<span data-ttu-id="21fe3-182">Обратите внимание, что шаги в компенсирующей транзакции не обязательно должны быть противоположными исходным шагам, а логика на каждом этапе компенсирующей транзакции должна учитывать любые бизнес-правила.</span><span class="sxs-lookup"><span data-stu-id="21fe3-182">Notice that the steps in the compensating transaction might not be the exact opposite of the original steps, and the logic in each step in the compensating transaction must take into account any business-specific rules.</span></span> <span data-ttu-id="21fe3-183">Например, отмена бронирования места в рейсе может не обеспечивать клиенту полного возмещения затрат.</span><span class="sxs-lookup"><span data-stu-id="21fe3-183">For example, unbooking a seat on a flight might not entitle the customer to a complete refund of any money paid.</span></span> <span data-ttu-id="21fe3-184">На рисунке показано создание компенсирующей транзакции для отмены продолжительной транзакции, чтобы забронировать маршрут путешествия.</span><span class="sxs-lookup"><span data-stu-id="21fe3-184">The figure illustrates generating a compensating transaction to undo a long-running transaction to book a travel itinerary.</span></span>

![Создание компенсирующей транзакции для отмены продолжительной транзакции, чтобы забронировать маршрут путешествия](./_images/compensating-transaction-diagram.png)


> <span data-ttu-id="21fe3-186">Возможно, что шаги в компенсирующей транзакции будут выполняться параллельно, в зависимости от того, как вы разработали компенсирующую логику для каждого шага.</span><span class="sxs-lookup"><span data-stu-id="21fe3-186">It might be possible for the steps in the compensating transaction to be performed in parallel, depending on how you've designed the compensating logic for each step.</span></span>

<span data-ttu-id="21fe3-187">Во многих бизнес-решениях сбой одного шага не всегда требует отката системы с помощью компенсирующей транзакции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-187">In many business solutions, failure of a single step doesn't always necessitate rolling the system back by using a compensating transaction.</span></span> <span data-ttu-id="21fe3-188">Например, если &mdash;после бронирования рейсов F1, F2 и F3 в сценарии веб-сайта путешествия&mdash; клиент не может зарезервировать номер в отеле H1, желательно предложить клиенту номер в другом отеле в том же городе вместо отмены рейсов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-188">For example, if&mdash;after having booked flights F1, F2, and F3 in the travel website scenario&mdash;the customer is unable to reserve a room at hotel H1, it's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights.</span></span> <span data-ttu-id="21fe3-189">Клиент всегда сможет отменить бронирование (в этом случае выполняется компенсирующая транзакция и отменяются бронирования на рейсы F1, F2 и F3), но это решение должно приниматься клиентом, а не системой.</span><span class="sxs-lookup"><span data-stu-id="21fe3-189">The customer can still decide to cancel (in which case the compensating transaction runs and undoes the bookings made on flights F1, F2, and F3), but this decision should be made by the customer rather than by the system.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="21fe3-190">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="21fe3-190">Related patterns and guidance</span></span>

<span data-ttu-id="21fe3-191">При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="21fe3-191">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="21fe3-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Руководство по обеспечению согласованности данных).</span><span class="sxs-lookup"><span data-stu-id="21fe3-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="21fe3-193">Шаблон компенсирующей транзакции часто используется для отмены операций, реализующих модель итоговой согласованности.</span><span class="sxs-lookup"><span data-stu-id="21fe3-193">The Compensating Transaction pattern is often used to undo operations that implement the eventual consistency model.</span></span> <span data-ttu-id="21fe3-194">Это руководство содержит сведения о преимуществах и недостатках итоговой согласованности.</span><span class="sxs-lookup"><span data-stu-id="21fe3-194">This primer provides information on the benefits and tradeoffs of eventual consistency.</span></span>

- <span data-ttu-id="21fe3-195">[Scheduler-Agent-Supervisor Pattern](scheduler-agent-supervisor.md) (Шаблон "планировщик, агент, контролер").</span><span class="sxs-lookup"><span data-stu-id="21fe3-195">[Scheduler-Agent-Supervisor Pattern](scheduler-agent-supervisor.md).</span></span> <span data-ttu-id="21fe3-196">Описывает, как внедрять отказоустойчивые системы, которые выполняют бизнес-операции с использованием распределенных служб и ресурсов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-196">Describes how to implement resilient systems that perform business operations that use distributed services and resources.</span></span> <span data-ttu-id="21fe3-197">Иногда может потребоваться отменить работу, выполняемую операцией, с помощью компенсирующей транзакции.</span><span class="sxs-lookup"><span data-stu-id="21fe3-197">Sometimes, it might be necessary to undo the work performed by an operation by using a compensating transaction.</span></span>

- <span data-ttu-id="21fe3-198">[Шаблон повторов](./retry.md).</span><span class="sxs-lookup"><span data-stu-id="21fe3-198">[Retry Pattern](./retry.md).</span></span> <span data-ttu-id="21fe3-199">Компенсирующие транзакции могут быть дорогостоящими, и можно свести к минимуму их использование путем реализации эффективной политики повтора неудачных операций, следуя шаблону повторов.</span><span class="sxs-lookup"><span data-stu-id="21fe3-199">Compensating transactions can be expensive to perform, and it might be possible to minimize their use by implementing an effective policy of retrying failing operations by following the Retry pattern.</span></span>
