---
title: Шаблон балансировки нагрузки на основе очередей
titleSuffix: Cloud Design Patterns
description: Очередь выполняет роль буфера между задачей и службой, которую она вызывает, позволяя сгладить кратковременные всплески нагрузки.
keywords: Конструктивный шаблон
author: dragon119
ms.date: 01/02/2019
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: c736afced1b0478e8eb1a2694acc4d6a6f0c62fc
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54483502"
---
# <a name="queue-based-load-leveling-pattern"></a><span data-ttu-id="749b7-104">Шаблон балансировки нагрузки на основе очередей</span><span class="sxs-lookup"><span data-stu-id="749b7-104">Queue-Based Load Leveling pattern</span></span>

<span data-ttu-id="749b7-105">Для сглаживания кратковременных всплесков нагрузки используйте очередь, которая служит буфером между задачей и вызываемой ею службой. В противном случае такие всплески могут привести к сбою службы или превышению времени ожидания задания. Это позволяет свести к минимуму всплески нагрузки спроса, влияющие на доступность и скорость реагирования, как для задачи, так и для службы.</span><span class="sxs-lookup"><span data-stu-id="749b7-105">Use a queue that acts as a buffer between a task and a service it invokes in order to smooth intermittent heavy loads that can cause the service to fail or the task to time out. This can help to minimize the impact of peaks in demand on availability and responsiveness for both the task and the service.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="749b7-106">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="749b7-106">Context and problem</span></span>

<span data-ttu-id="749b7-107">Многие решения в облаке используют выполняемые задачи, которые вызывают службы.</span><span class="sxs-lookup"><span data-stu-id="749b7-107">Many solutions in the cloud involve running tasks that invoke services.</span></span> <span data-ttu-id="749b7-108">В этой среде, если служба подвергается кратковременным всплескам нагрузки, то могут возникать проблемы с производительностью или надежностью.</span><span class="sxs-lookup"><span data-stu-id="749b7-108">In this environment, if a service is subjected to intermittent heavy loads, it can cause performance or reliability issues.</span></span>

<span data-ttu-id="749b7-109">Служба может быть частью того же решения, что и задачи, которые ее используют. Или это может быть сторонняя служба, предоставляющая доступ к часто используемым ресурсам, таким как кэш или служба хранилища.</span><span class="sxs-lookup"><span data-stu-id="749b7-109">A service could be part of the same solution as the tasks that use it, or it could be a third-party service providing access to frequently used resources such as a cache or a storage service.</span></span> <span data-ttu-id="749b7-110">Если одна служба используется рядом задач, выполняемых одновременно, то может быть сложно предсказать число запросов к службе в любое время.</span><span class="sxs-lookup"><span data-stu-id="749b7-110">If the same service is used by a number of tasks running concurrently, it can be difficult to predict the volume of requests to the service at any time.</span></span>

<span data-ttu-id="749b7-111">В службе могут возникать всплески нагрузки спроса, которые приводят к ее перегрузке и неспособности своевременно отвечать на запросы.</span><span class="sxs-lookup"><span data-stu-id="749b7-111">A service might experience peaks in demand that cause it to overload and be unable to respond to requests in a timely manner.</span></span> <span data-ttu-id="749b7-112">Наполнение службы большим числом одновременных запросов также может приводить к сбоям в работе службы, если она не может справиться с конфликтом, вызываемым этими запросами.</span><span class="sxs-lookup"><span data-stu-id="749b7-112">Flooding a service with a large number of concurrent requests can also result in the service failing if it's unable to handle the contention these requests cause.</span></span>

## <a name="solution"></a><span data-ttu-id="749b7-113">Решение</span><span class="sxs-lookup"><span data-stu-id="749b7-113">Solution</span></span>

<span data-ttu-id="749b7-114">Выполните рефакторинг решения и создайте очередь между задачей и службой.</span><span class="sxs-lookup"><span data-stu-id="749b7-114">Refactor the solution and introduce a queue between the task and the service.</span></span> <span data-ttu-id="749b7-115">Задача и служба выполняются асинхронно.</span><span class="sxs-lookup"><span data-stu-id="749b7-115">The task and the service run asynchronously.</span></span> <span data-ttu-id="749b7-116">Задача отправляет сообщение, содержащее данные, необходимые службе для очереди.</span><span class="sxs-lookup"><span data-stu-id="749b7-116">The task posts a message containing the data required by the service to a queue.</span></span> <span data-ttu-id="749b7-117">Очередь работает как буфер, сохраняя сообщение, пока оно не будет извлечено службой.</span><span class="sxs-lookup"><span data-stu-id="749b7-117">The queue acts as a buffer, storing the message until it's retrieved by the service.</span></span> <span data-ttu-id="749b7-118">Служба извлекает сообщения из очереди и обрабатывает их.</span><span class="sxs-lookup"><span data-stu-id="749b7-118">The service retrieves the messages from the queue and processes them.</span></span> <span data-ttu-id="749b7-119">Запросы от ряда задач, которые могут создаваться с крайне изменчивой скоростью, можно передавать в службу с помощью той же очереди сообщений.</span><span class="sxs-lookup"><span data-stu-id="749b7-119">Requests from a number of tasks, which can be generated at a highly variable rate, can be passed to the service through the same message queue.</span></span> <span data-ttu-id="749b7-120">На этом рисунке показано использование очереди для балансировки нагрузки в службе.</span><span class="sxs-lookup"><span data-stu-id="749b7-120">This figure shows using a queue to level the load on a service.</span></span>

![Рисунок 1. Использование очереди для балансировки нагрузки в службе](./_images/queue-based-load-leveling-pattern.png)

<span data-ttu-id="749b7-122">Очередь отделяет задачи из службы, а служба может обрабатывать сообщения в удобном для нее темпе, независимо от числа запросов от параллельных задач.</span><span class="sxs-lookup"><span data-stu-id="749b7-122">The queue decouples the tasks from the service, and the service can handle the messages at its own pace regardless of the volume of requests from concurrent tasks.</span></span> <span data-ttu-id="749b7-123">Кроме того, отсутствует задержка, связанная с задачей, если служба недоступна в тот момент, когда она отправляет сообщение в очередь.</span><span class="sxs-lookup"><span data-stu-id="749b7-123">Additionally, there's no delay to a task if the service isn't available at the time it posts a message to the queue.</span></span>

<span data-ttu-id="749b7-124">Такой подход обеспечивает следующие преимущества:</span><span class="sxs-lookup"><span data-stu-id="749b7-124">This pattern provides the following benefits:</span></span>

- <span data-ttu-id="749b7-125">Он помогает добиться максимальной доступности, так как задержки, возникающие в службах, не будут оказывать немедленное и прямое влияние на приложение, которое может по-прежнему отправлять сообщения в очередь, даже если служба в данный момент недоступна или не обрабатывает сообщения.</span><span class="sxs-lookup"><span data-stu-id="749b7-125">It can help to maximize availability because delays arising in services won't have an immediate and direct impact on the application, which can continue to post messages to the queue even when the service isn't available or isn't currently processing messages.</span></span>
- <span data-ttu-id="749b7-126">Он позволяет добиться максимальной масштабируемости, так как для удовлетворения спроса можно изменять как количество очередей, так и количество служб.</span><span class="sxs-lookup"><span data-stu-id="749b7-126">It can help to maximize scalability because both the number of queues and the number of services can be varied to meet demand.</span></span>
- <span data-ttu-id="749b7-127">Он помогает контролировать затраты, так как число развернутых экземпляров службы должно быть достаточным для обработки средней нагрузки, а не пиковой нагрузки.</span><span class="sxs-lookup"><span data-stu-id="749b7-127">It can help to control costs because the number of service instances deployed only have to be adequate to meet average load rather than the peak load.</span></span>

    >  <span data-ttu-id="749b7-128">Некоторые службы применяют регулирование количества запросов, когда спрос достигает порогового значения, за которым может произойти сбой системы.</span><span class="sxs-lookup"><span data-stu-id="749b7-128">Some services implement throttling when demand reaches a threshold beyond which the system could fail.</span></span> <span data-ttu-id="749b7-129">Регулирование количества запросов может сократить число доступных функциональных возможностей.</span><span class="sxs-lookup"><span data-stu-id="749b7-129">Throttling can reduce the functionality available.</span></span> <span data-ttu-id="749b7-130">С помощью этих служб можно реализовать балансировку нагрузки, чтобы пороговое значение не достигалось.</span><span class="sxs-lookup"><span data-stu-id="749b7-130">You can implement load leveling with these services to ensure that this threshold isn't reached.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="749b7-131">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="749b7-131">Issues and considerations</span></span>

<span data-ttu-id="749b7-132">При принятии решения о реализации этого шаблона необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="749b7-132">Consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="749b7-133">Во избежание перегрузки целевого ресурса необходимо реализовать логику приложения, контролирующую скорость, с которой службы обрабатывают сообщения.</span><span class="sxs-lookup"><span data-stu-id="749b7-133">It's necessary to implement application logic that controls the rate at which services handle messages to avoid overwhelming the target resource.</span></span> <span data-ttu-id="749b7-134">Избегайте передачи пиковых нагрузок спроса в следующую стадию системы.</span><span class="sxs-lookup"><span data-stu-id="749b7-134">Avoid passing spikes in demand to the next stage of the system.</span></span> <span data-ttu-id="749b7-135">Протестируйте систему под нагрузкой, чтобы убедиться, что она обеспечивает необходимую балансировку, а также настройте количество очередей и экземпляров службы, которые обрабатывают сообщения, для достижения этой цели.</span><span class="sxs-lookup"><span data-stu-id="749b7-135">Test the system under load to ensure that it provides the required leveling, and adjust the number of queues and the number of service instances that handle messages to achieve this.</span></span>
- <span data-ttu-id="749b7-136">Очереди сообщений представляют собой механизм односторонней связи.</span><span class="sxs-lookup"><span data-stu-id="749b7-136">Message queues are a one-way communication mechanism.</span></span> <span data-ttu-id="749b7-137">Если задача ожидает ответа от службы, то может потребоваться реализовать механизм, который служба может использовать для отправки ответа.</span><span class="sxs-lookup"><span data-stu-id="749b7-137">If a task expects a reply from a service, it might be necessary to implement a mechanism that the service can use to send a response.</span></span> <span data-ttu-id="749b7-138">Дополнительные сведения см. в [руководстве по асинхронному обмену сообщениями](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="749b7-138">For more information, see the [Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span>
- <span data-ttu-id="749b7-139">Будьте внимательны, применяя автоматическое масштабирование к службам, которые ожидают передачи запросов в очереди.</span><span class="sxs-lookup"><span data-stu-id="749b7-139">Be careful if you apply autoscaling to services that are listening for requests on the queue.</span></span> <span data-ttu-id="749b7-140">Это может вызвать дополнительные конфликты для любых ресурсов, совместно используемых этими службами, и снизить эффективность использования очереди при балансировке нагрузки.</span><span class="sxs-lookup"><span data-stu-id="749b7-140">This can result in increased contention for any resources that these services share and diminish the effectiveness of using the queue to level the load.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="749b7-141">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="749b7-141">When to use this pattern</span></span>

<span data-ttu-id="749b7-142">Этот шаблон полезен для любого приложения, использующего службы, которые подвержены перегрузкам.</span><span class="sxs-lookup"><span data-stu-id="749b7-142">This pattern is useful to any application that uses services that are subject to overloading.</span></span>

<span data-ttu-id="749b7-143">Этот шаблон не будет полезен, если приложение ожидает ответа от службы с минимальной задержкой.</span><span class="sxs-lookup"><span data-stu-id="749b7-143">This pattern isn't useful if the application expects a response from the service with minimal latency.</span></span>

## <a name="example"></a><span data-ttu-id="749b7-144">Пример</span><span class="sxs-lookup"><span data-stu-id="749b7-144">Example</span></span>

<span data-ttu-id="749b7-145">Веб-приложение записывает данные во внешнее хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="749b7-145">A web app writes data to an external data store.</span></span> <span data-ttu-id="749b7-146">Если большое число экземпляров веб-приложения выполняются одновременно, хранилище данных может оказаться неспособным отвечать на запросы достаточно быстро. Это приведет к истечению времени ожидания у запросов, регулированию запросов или сбоям при их обработке.</span><span class="sxs-lookup"><span data-stu-id="749b7-146">If a large number of instances of the web app run concurrently, the data store might be unable to respond to requests quickly enough, causing requests to time out, be throttled, or otherwise fail.</span></span> <span data-ttu-id="749b7-147">На схеме ниже показана служба, перегруженная большим числом параллельных запросов от экземпляров приложения.</span><span class="sxs-lookup"><span data-stu-id="749b7-147">The following diagram shows a data store being overwhelmed by a large number of concurrent requests from instances of an application.</span></span>

![Рисунок 2. Служба, перегруженная большим числом параллельных запросов от экземпляров веб-приложения](./_images/queue-based-load-leveling-overwhelmed.png)

<span data-ttu-id="749b7-149">Чтобы устранить эту проблему, можно использовать очередь для балансировки нагрузки между экземплярами приложения и хранилищем данных.</span><span class="sxs-lookup"><span data-stu-id="749b7-149">To resolve this, you can use a queue to level the load between the application instances and the data store.</span></span> <span data-ttu-id="749b7-150">Приложение Функций Azure считывает сообщения из очереди и выполняет запросы чтения и записи к хранилищу данных.</span><span class="sxs-lookup"><span data-stu-id="749b7-150">An Azure Functions app reads the messages from the queue and performs the read/write requests to the data store.</span></span> <span data-ttu-id="749b7-151">Логика приложения в приложении-функции может контролировать скорость, с которой это приложение передает запросы в хранилище данных, чтобы предотвратить перегрузку хранилища.</span><span class="sxs-lookup"><span data-stu-id="749b7-151">The application logic in the function app can control the rate at which it passes requests to the data store, to prevent the store from being overwhelmed.</span></span> <span data-ttu-id="749b7-152">(В противном случае приложение-функция просто перенесет эту проблему в серверную часть.)</span><span class="sxs-lookup"><span data-stu-id="749b7-152">(Otherwise the function app will just re-introduce the same problem at the back end.)</span></span>

![Рисунок 3. Использование очереди и приложения-функции для балансировки нагрузки](./_images/queue-based-load-leveling-function.png)



## <a name="related-patterns-and-guidance"></a><span data-ttu-id="749b7-154">Связанные шаблоны и рекомендации</span><span class="sxs-lookup"><span data-stu-id="749b7-154">Related patterns and guidance</span></span>

<span data-ttu-id="749b7-155">При реализации этого шаблона следует принять во внимание следующие шаблоны и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="749b7-155">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="749b7-156">[Руководство по асинхронному обмену сообщениями](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="749b7-156">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="749b7-157">Очереди сообщений по своей сути асинхронны.</span><span class="sxs-lookup"><span data-stu-id="749b7-157">Message queues are inherently asynchronous.</span></span> <span data-ttu-id="749b7-158">Может потребоваться изменить логику приложения в задаче, если ее адаптировали для использования очереди сообщений вместо непосредственного взаимодействия со службой.</span><span class="sxs-lookup"><span data-stu-id="749b7-158">It might be necessary to redesign the application logic in a task if it's adapted from communicating directly with a service to using a message queue.</span></span> <span data-ttu-id="749b7-159">Аналогичным образом может потребоваться выполнить рефакторинг службы, чтобы принимались запросы из очереди сообщений.</span><span class="sxs-lookup"><span data-stu-id="749b7-159">Similarly, it might be necessary to refactor a service to accept requests from a message queue.</span></span> <span data-ttu-id="749b7-160">Также можно реализовать прокси-службу, как описано в примере.</span><span class="sxs-lookup"><span data-stu-id="749b7-160">Alternatively, it might be possible to implement a proxy service, as described in the example.</span></span>

- <span data-ttu-id="749b7-161">[Шаблон конкурирующих потребителей](./competing-consumers.md).</span><span class="sxs-lookup"><span data-stu-id="749b7-161">[Competing Consumers pattern](./competing-consumers.md).</span></span> <span data-ttu-id="749b7-162">Можно запустить несколько экземпляров службы, каждый из которых будет действовать как потребитель сообщений из очереди балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="749b7-162">It might be possible to run multiple instances of a service, each acting as a message consumer from the load-leveling queue.</span></span> <span data-ttu-id="749b7-163">Этот подход можно использовать для настройки скорости, с которой сообщения принимаются и передаются в службу.</span><span class="sxs-lookup"><span data-stu-id="749b7-163">You can use this approach to adjust the rate at which messages are received and passed to a service.</span></span>

- <span data-ttu-id="749b7-164">[Шаблон регулирования](./throttling.md).</span><span class="sxs-lookup"><span data-stu-id="749b7-164">[Throttling pattern](./throttling.md).</span></span> <span data-ttu-id="749b7-165">Простой способ реализовать регулирование количества запросов с помощью службы — это использовать балансировку нагрузки на основе очередей и перенаправлять все запросы к службе через очередь сообщений.</span><span class="sxs-lookup"><span data-stu-id="749b7-165">A simple way to implement throttling with a service is to use queue-based load leveling and route all requests to a service through a message queue.</span></span> <span data-ttu-id="749b7-166">Служба может обрабатывать запросы со скоростью, которая гарантирует, что ресурсы, необходимые для службы, не будут исчерпаны. При этом также сокращается число конфликтов, которые могут возникнуть.</span><span class="sxs-lookup"><span data-stu-id="749b7-166">The service can process requests at a rate that ensures that resources required by the service aren't exhausted, and to reduce the amount of contention that could occur.</span></span>

- <span data-ttu-id="749b7-167">[Сравнение трех служб обмена сообщениями Azure: Сетка событий, Центры событий и Служебная шина](/azure/event-grid/compare-messaging-services).</span><span class="sxs-lookup"><span data-stu-id="749b7-167">[Choose between Azure messaging services](/azure/event-grid/compare-messaging-services).</span></span> <span data-ttu-id="749b7-168">Сведения о выборе механизма обмена сообщениями и организации очереди в приложениях Azure.</span><span class="sxs-lookup"><span data-stu-id="749b7-168">Information about choosing a messaging and queuing mechanism in Azure applications.</span></span>

- <span data-ttu-id="749b7-169">[Повышение масштабируемости в веб-приложении Azure](../reference-architectures/app-service-web-app/scalable-web-app.md).</span><span class="sxs-lookup"><span data-stu-id="749b7-169">[Improve scalability in an Azure web application](../reference-architectures/app-service-web-app/scalable-web-app.md).</span></span> <span data-ttu-id="749b7-170">Эта эталонная архитектура обеспечивает выравнивание нагрузки с использованием очередей, являющихся частью архитектуры.</span><span class="sxs-lookup"><span data-stu-id="749b7-170">This reference architecture includes queue-based load leveling as part of the architecture.</span></span>
