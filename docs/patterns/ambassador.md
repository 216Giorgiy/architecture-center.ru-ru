---
title: Шаблон посредника
description: Создание вспомогательных служб, которые отправляют сетевые запросы от имени клиентской службы или приложения.
author: dragon119
ms.date: 06/23/2017
ms.openlocfilehash: 6c545619aab6a5817e55854350e3769834df27cd
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
ms.locfileid: "24540798"
---
# <a name="ambassador-pattern"></a><span data-ttu-id="87abf-103">Шаблон посредника</span><span class="sxs-lookup"><span data-stu-id="87abf-103">Ambassador pattern</span></span>

<span data-ttu-id="87abf-104">Создание вспомогательных служб, которые отправляют сетевые запросы от имени клиентской службы или приложения.</span><span class="sxs-lookup"><span data-stu-id="87abf-104">Create helper services that send network requests on behalf of a consumer service or application.</span></span> <span data-ttu-id="87abf-105">Службу посредника проще всего представить как самостоятельный прокси-сервер, размещенный в одной сети с клиентом.</span><span class="sxs-lookup"><span data-stu-id="87abf-105">An ambassador service can be thought of as an out-of-process proxy that is co-located with the client.</span></span>

<span data-ttu-id="87abf-106">Этот шаблон позволяет перенести общие задачи подключения клиентов, такие как мониторинг, ведение журналов, маршрутизация, обеспечение безопасности (например, поддержка TLS) и [шаблоны устойчивости][resiliency-patterns], не ограничиваясь в выборе языка реализации.</span><span class="sxs-lookup"><span data-stu-id="87abf-106">This pattern can be useful for offloading common client connectivity tasks such as monitoring, logging, routing, security (such as TLS), and [resiliency patterns][resiliency-patterns] in a language agnostic way.</span></span> <span data-ttu-id="87abf-107">Он часто применяется для расширения сетевых возможностей приложений, которые уже устарели или по другим причинам не поддаются доработке.</span><span class="sxs-lookup"><span data-stu-id="87abf-107">It is often used with legacy applications, or other applications that are difficult to modify, in order to extend their networking capabilities.</span></span> <span data-ttu-id="87abf-108">Также он позволяет создать команду специалистов в узкой области для реализации таких возможностей.</span><span class="sxs-lookup"><span data-stu-id="87abf-108">It can also enable a specialized team to implement those features.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="87abf-109">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="87abf-109">Context and problem</span></span>

<span data-ttu-id="87abf-110">Для разработки устойчивых облачных приложений важны такие функции, как [автоматическое выключение][circuit-breaker], маршрутизация, сбор метрик, мониторинг и обновление сетевых конфигураций.</span><span class="sxs-lookup"><span data-stu-id="87abf-110">Resilient cloud-based applications require features such as [circuit breaking][circuit-breaker], routing, metering and monitoring, and the ability to make network-related configuration updates.</span></span> <span data-ttu-id="87abf-111">Иногда очень трудно или даже невозможно обновить устаревшие приложения или библиотеки кода, чтобы добавить в них эти функции (например, если код уже не поддерживается или у команды разработчиков нет необходимых знаний).</span><span class="sxs-lookup"><span data-stu-id="87abf-111">It may be difficult or impossible to update legacy applications or existing code libraries to add these features, because the code is no longer maintained or can't be easily modified by the development team.</span></span>

<span data-ttu-id="87abf-112">Для организации сетевых вызовов иногда также требуются существенные усилия по настройке подключения, аутентификации и авторизации.</span><span class="sxs-lookup"><span data-stu-id="87abf-112">Network calls may also require substantial configuration for connection, authentication, and authorization.</span></span> <span data-ttu-id="87abf-113">Если эти вызовы используются в нескольких приложениях, созданных на разных языках и платформах, настройку вызовов придется выполнять отдельно для каждого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="87abf-113">If these calls are used across multiple applications, built using multiple languages and frameworks, the calls must be configured for each of these instances.</span></span> <span data-ttu-id="87abf-114">Кроме того, часто есть смысл передать управление сетями и безопасностью в пределах всей организации централизованной группе специалистов.</span><span class="sxs-lookup"><span data-stu-id="87abf-114">In addition, network and security functionality may need to be managed by a central team within your organization.</span></span> <span data-ttu-id="87abf-115">Если база кода велика и эти специалисты вносят изменения в незнакомые участки кода, повышается риск возникновения ошибок.</span><span class="sxs-lookup"><span data-stu-id="87abf-115">With a large code base, it can be risky for that team to update application code they aren't familiar with.</span></span>

## <a name="solution"></a><span data-ttu-id="87abf-116">Решение</span><span class="sxs-lookup"><span data-stu-id="87abf-116">Solution</span></span>

<span data-ttu-id="87abf-117">Вынесите клиентские платформы и библиотеки во внешний процесс, который будет выполнять роль посредника между приложением и внешними службами.</span><span class="sxs-lookup"><span data-stu-id="87abf-117">Put client frameworks and libraries into an external process that acts as a proxy between your application and external services.</span></span> <span data-ttu-id="87abf-118">Разверните этот сервер в той же среде, что и основное приложение, чтобы получить полный контроль над функциями маршрутизации, устойчивости и безопасности, а также избежать любых проблем с ограничениями доступа.</span><span class="sxs-lookup"><span data-stu-id="87abf-118">Deploy the proxy on the same host environment as your application to allow control over routing, resiliency, security features, and to avoid any host-related access restrictions.</span></span> <span data-ttu-id="87abf-119">Шаблон посредника поможет стандартизировать и расширить инструментирование.</span><span class="sxs-lookup"><span data-stu-id="87abf-119">You can also use the ambassador pattern to standardize and extend instrumentation.</span></span> <span data-ttu-id="87abf-120">Прокси-сервер может отслеживать метрики производительности, например задержку и использование ресурсов, непосредственно в той среде, где размещено приложение.</span><span class="sxs-lookup"><span data-stu-id="87abf-120">The proxy can monitor performance metrics such as latency or resource usage, and this monitoring happens in the same host environment as the application.</span></span>

![](./_images/ambassador.png)

<span data-ttu-id="87abf-121">Переданные посреднику функции доступны для управления независимо от приложения.</span><span class="sxs-lookup"><span data-stu-id="87abf-121">Features that are offloaded to the ambassador can be managed independently of the application.</span></span> <span data-ttu-id="87abf-122">Посредник можно легко обновить и (или) изменить, не вмешиваясь в работу существующих компонентов приложения.</span><span class="sxs-lookup"><span data-stu-id="87abf-122">You can update and modify the ambassador without disturbing the application's legacy functionality.</span></span> <span data-ttu-id="87abf-123">Кроме того, вы сможете создать отдельные команды специалистов для внедрения и обслуживания функций безопасности, сети и (или) аутентификации, которые переданы посреднику.</span><span class="sxs-lookup"><span data-stu-id="87abf-123">It also allows for separate, specialized teams to implement and maintain security, networking, or authentication features that have been moved to the ambassador.</span></span>

<span data-ttu-id="87abf-124">Службы посредника можно развернуть в качестве [расширений][sidecar], чтобы соотнести с жизненным циклом приложения или службы, в которых используется посредник.</span><span class="sxs-lookup"><span data-stu-id="87abf-124">Ambassador services can be deployed as a [sidecar][sidecar] to accompany the lifecycle of a consuming application or service.</span></span> <span data-ttu-id="87abf-125">И наоборот, если посредник требуется сразу для нескольких отдельных процессов в одном узле, его можно развернуть как управляющую программу или службу Windows.</span><span class="sxs-lookup"><span data-stu-id="87abf-125">Alternatively, if an ambassador is shared by multiple separate processes on a common host, it can be deployed as a daemon or Windows service.</span></span> <span data-ttu-id="87abf-126">Если для службы-клиента используются контейнеры, посредник следует оформить как отдельный контейнер в том же узле, настроив соответствующие ссылки для взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="87abf-126">If the consuming service is containerized, the ambassador should be created as a separate container on the same host, with the appropriate links configured for communication.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="87abf-127">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="87abf-127">Issues and considerations</span></span>

- <span data-ttu-id="87abf-128">Использование посредника сопровождается дополнительной задержкой.</span><span class="sxs-lookup"><span data-stu-id="87abf-128">The proxy adds some latency overhead.</span></span> <span data-ttu-id="87abf-129">Возможно, рациональнее будет использовать клиентскую библиотеку, которую приложение вызывает напрямую.</span><span class="sxs-lookup"><span data-stu-id="87abf-129">Consider whether a client library, invoked directly by the application, is a better approach.</span></span>
- <span data-ttu-id="87abf-130">Определите, как обобщение компонентов, перемещаемых в посредник, может повлиять на работу.</span><span class="sxs-lookup"><span data-stu-id="87abf-130">Consider the possible impact of including generalized features in the proxy.</span></span> <span data-ttu-id="87abf-131">Например, если в посреднике реализован механизм повторных попыток, это может быть небезопасно для операций, не являющихся идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="87abf-131">For example, the ambassador could handle retries, but that might not be safe unless all operations are idempotent.</span></span>
- <span data-ttu-id="87abf-132">Постарайтесь создать механизм, который позволит передать контекст от клиента к посреднику и (или) от посредника к клиенту.</span><span class="sxs-lookup"><span data-stu-id="87abf-132">Consider a mechanism to allow the client to pass some context to the proxy, as well as back to the client.</span></span> <span data-ttu-id="87abf-133">Например, добавьте специальный заголовок HTTP-запроса, позволяющий запретить повторные попытки или ограничить их количество.</span><span class="sxs-lookup"><span data-stu-id="87abf-133">For example, include HTTP request headers to opt out of retry or specify the maximum number of times to retry.</span></span>
- <span data-ttu-id="87abf-134">Продумайте, как лучше упаковать и развертывать посредник.</span><span class="sxs-lookup"><span data-stu-id="87abf-134">Consider how you will package and deploy the proxy.</span></span>
- <span data-ttu-id="87abf-135">Выберите количество экземпляров: один общий для всех клиентов или по одному для каждого клиента.</span><span class="sxs-lookup"><span data-stu-id="87abf-135">Consider whether to use a single shared instance for all clients or an instance for each client.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="87abf-136">Когда следует использовать этот шаблон</span><span class="sxs-lookup"><span data-stu-id="87abf-136">When to use this pattern</span></span>

<span data-ttu-id="87abf-137">Используйте эту схему в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="87abf-137">Use this pattern when you:</span></span>

- <span data-ttu-id="87abf-138">если нужно создать общий набор клиентских функций подключения для нескольких языков и (или) платформ;</span><span class="sxs-lookup"><span data-stu-id="87abf-138">Need to build a common set of client connectivity features for multiple languages or frameworks.</span></span>
- <span data-ttu-id="87abf-139">если нужно передать сквозную задачу по поддержке коммуникации специалистам по инфраструктуре или по конкретным узким отраслям;</span><span class="sxs-lookup"><span data-stu-id="87abf-139">Need to offload cross-cutting client connectivity concerns to infrastructure developers or other more specialized teams.</span></span>
- <span data-ttu-id="87abf-140">если требуется поддержка облачного или кластерного подключения для приложения, которое устарело или по другим причинам не поддается доработке.</span><span class="sxs-lookup"><span data-stu-id="87abf-140">Need to support cloud or cluster connectivity requirements in a legacy application or an application that is difficult to modify.</span></span>

<span data-ttu-id="87abf-141">Эту схему не стоит применять в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="87abf-141">This pattern may not be suitable:</span></span>

- <span data-ttu-id="87abf-142">Если критически важна задержка сети для запросов.</span><span class="sxs-lookup"><span data-stu-id="87abf-142">When network request latency is critical.</span></span> <span data-ttu-id="87abf-143">Использование посредника сопровождается дополнительной, хоть и небольшой, задержкой, и в некоторых случаях это может повлиять на приложение.</span><span class="sxs-lookup"><span data-stu-id="87abf-143">A proxy will introduce some overhead, although minimal, and in some cases this may affect the application.</span></span>
- <span data-ttu-id="87abf-144">Если все клиентские функции подключения реализованы на одном языке.</span><span class="sxs-lookup"><span data-stu-id="87abf-144">When client connectivity features are consumed by a single language.</span></span> <span data-ttu-id="87abf-145">В таком случае целесообразнее создать клиентскую библиотеку, предоставляя ее командам разработчиков в виде пакета.</span><span class="sxs-lookup"><span data-stu-id="87abf-145">In that case, a better option might be a client library that is distributed to the development teams as a package.</span></span>
- <span data-ttu-id="87abf-146">Если функции подключения невозможно обобщить или требуется более глубокая интеграция с клиентским приложением.</span><span class="sxs-lookup"><span data-stu-id="87abf-146">When connectivity features cannot be generalized and require deeper integration with the client application.</span></span>

## <a name="example"></a><span data-ttu-id="87abf-147">Пример</span><span class="sxs-lookup"><span data-stu-id="87abf-147">Example</span></span>

<span data-ttu-id="87abf-148">На приведенной ниже схеме представлен процесс передачи запроса от приложения в удаленную службу через посредник.</span><span class="sxs-lookup"><span data-stu-id="87abf-148">The following diagram shows an application making a request to a remote service via an ambassador proxy.</span></span> <span data-ttu-id="87abf-149">Этот посредник обеспечивает маршрутизацию, аварийное отключение и ведение журнала.</span><span class="sxs-lookup"><span data-stu-id="87abf-149">The ambassador provides routing, circuit breaking, and logging.</span></span> <span data-ttu-id="87abf-150">Он вызывает удаленную службу и возвращает полученный ответ клиентскому приложению.</span><span class="sxs-lookup"><span data-stu-id="87abf-150">It calls the remote service and then returns the response to the client application:</span></span>

![](./_images/ambassador-example.png) 

## <a name="related-guidance"></a><span data-ttu-id="87abf-151">Связанные руководства</span><span class="sxs-lookup"><span data-stu-id="87abf-151">Related guidance</span></span>

- <span data-ttu-id="87abf-152">[Sidecar pattern](./sidecar.md) (Шаблон расширения)</span><span class="sxs-lookup"><span data-stu-id="87abf-152">[Sidecar pattern](./sidecar.md)</span></span>

<!-- links -->

[circuit-breaker]: ./circuit-breaker.md
[resiliency-patterns]: ./category/resiliency.md
[sidecar]: ./sidecar.md
