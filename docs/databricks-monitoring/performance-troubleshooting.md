---
title: Производительность, устранение неполадок для Azure Databricks с помощью Azure Monitor
titleSuffix: ''
description: Использование панелей мониторинга Grafana для диагностики проблем с производительностью в Azure Databricks.
author: petertaylor9999
ms.date: 04/02/2019
ms.topic: ''
ms.service: ''
ms.subservice: ''
ms.openlocfilehash: 49ec63d0c45ab388ca83b3ab0562428327539619
ms.sourcegitcommit: 1a3cc91530d56731029ea091db1f15d41ac056af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2019
ms.locfileid: "58888110"
---
# <a name="troubleshoot-performance-bottlenecks-in-azure-databricks"></a><span data-ttu-id="e03a4-103">Устранение узких мест производительности в Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="e03a4-103">Troubleshoot performance bottlenecks in Azure Databricks</span></span>

<span data-ttu-id="e03a4-104">В этой статье описывается использование панелей мониторинга, чтобы найти узкие места производительности в заданий Spark в Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="e03a4-104">This article describes how to use monitoring dashboards to find performance bottlenecks in Spark jobs on Azure Databricks.</span></span>

<span data-ttu-id="e03a4-105">[Azure Databricks](/azure/azure-databricks/) — [Apache Spark](https://spark.apache.org/)— на основе Служба аналитики, которая позволяет легко разрабатывать и развертывать аналитику больших данных.</span><span class="sxs-lookup"><span data-stu-id="e03a4-105">[Azure Databricks](/azure/azure-databricks/) is an [Apache Spark](https://spark.apache.org/)–based analytics service that makes it easy to rapidly develop and deploy big data analytics.</span></span> <span data-ttu-id="e03a4-106">Мониторинг и устранение проблем с производительностью важно при работе в производственных рабочих нагрузок Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="e03a4-106">Monitoring and troubleshooting performance issues is a critical when operating production Azure Databricks workloads.</span></span> <span data-ttu-id="e03a4-107">Для выявления общих проблем с производительностью, желательно использовать мониторинга визуализации на основе данных телеметрии.</span><span class="sxs-lookup"><span data-stu-id="e03a4-107">To identify common performance issues, it's helpful to use monitoring visualizations based on telemetry data.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="e03a4-108">Технические условия</span><span class="sxs-lookup"><span data-stu-id="e03a4-108">Prerequisites</span></span>

<span data-ttu-id="e03a4-109">Настройка панели мониторинга Grafana, показанные в этой статье:</span><span class="sxs-lookup"><span data-stu-id="e03a4-109">To set up the Grafana dashboards shown in this article:</span></span>

- <span data-ttu-id="e03a4-110">Настройте свой кластер Databricks для отправки данных телеметрии в рабочую область Log Analytics, с помощью библиотеки мониторинга Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="e03a4-110">Configure your Databricks cluster to send telemetry to a Log Analytics workspace, using the Azure Databricks Monitoring Library.</span></span> <span data-ttu-id="e03a4-111">Дополнительные сведения см. в разделе [настроить Azure Databricks для отправки метрик в Azure Monitor](./configure-cluster.md).</span><span class="sxs-lookup"><span data-stu-id="e03a4-111">For details, see [Configure Azure Databricks to send metrics to Azure Monitor](./configure-cluster.md).</span></span>

- <span data-ttu-id="e03a4-112">Развертывание Grafana на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="e03a4-112">Deploy Grafana in a virtual machine.</span></span> <span data-ttu-id="e03a4-113">См. в разделе [Использование панелей мониторинга для визуализации метрик Azure Databricks](./dashboards.md).</span><span class="sxs-lookup"><span data-stu-id="e03a4-113">See [Use dashboards to visualize Azure Databricks metrics](./dashboards.md).</span></span>

<span data-ttu-id="e03a4-114">Панели мониторинга Grafana, которое развертывается с набором визуализации временных рядов.</span><span class="sxs-lookup"><span data-stu-id="e03a4-114">The Grafana dashboard that is deployed includes a set of time-series visualizations.</span></span> <span data-ttu-id="e03a4-115">Каждый граф — метрики, связанные с задания Apache Spark, этапы задания и задачи, составляющие каждый этап блочная диаграмма временных рядов.</span><span class="sxs-lookup"><span data-stu-id="e03a4-115">Each graph is time-series plot of metrics related to an Apache Spark job, the stages of the job, and tasks that make up each stage.</span></span>

## <a name="azure-databricks-performance-overview"></a><span data-ttu-id="e03a4-116">Общие сведения о производительности Azure Databricks</span><span class="sxs-lookup"><span data-stu-id="e03a4-116">Azure Databricks performance overview</span></span>

<span data-ttu-id="e03a4-117">Azure Databricks основан на Apache Spark, общего назначения распределенная вычислительная система.</span><span class="sxs-lookup"><span data-stu-id="e03a4-117">Azure Databricks is based on Apache Spark, a general-purpose distributed computing system.</span></span> <span data-ttu-id="e03a4-118">Код приложения, известный как **задания**, выполняется в кластере Apache Spark, координируемых с помощью диспетчера кластеров.</span><span class="sxs-lookup"><span data-stu-id="e03a4-118">Application code, known as a **job**, executes on an Apache Spark cluster, coordinated by the cluster manager.</span></span> <span data-ttu-id="e03a4-119">Как правило задание — наивысшего уровня единицы вычисления.</span><span class="sxs-lookup"><span data-stu-id="e03a4-119">In general, a job is the highest-level unit of computation.</span></span> <span data-ttu-id="e03a4-120">Задание представляет собой завершения операции, выполняемой приложением Spark.</span><span class="sxs-lookup"><span data-stu-id="e03a4-120">A job represents the complete operation performed by the Spark application.</span></span> <span data-ttu-id="e03a4-121">Типичные операции включает в себя чтение данных из источника, применения преобразований данных и запись результатов в хранилище или другое место назначения.</span><span class="sxs-lookup"><span data-stu-id="e03a4-121">A typical operation includes reading data from a source, applying data transformations, and writing the results to storage or another destination.</span></span>

<span data-ttu-id="e03a4-122">Задания разбиваются на **этапы**.</span><span class="sxs-lookup"><span data-stu-id="e03a4-122">Jobs are broken down into **stages**.</span></span> <span data-ttu-id="e03a4-123">Задание перемещает через этапы последовательно, что означает, что более поздних стадиях необходимо дождаться более ранних этапах для выполнения.</span><span class="sxs-lookup"><span data-stu-id="e03a4-123">The job advances through the stages sequentially, which means that later stages must wait for earlier stages to complete.</span></span> <span data-ttu-id="e03a4-124">Этапы содержат группы идентичных **задачи** , могут выполняться параллельно на нескольких узлах кластера Spark.</span><span class="sxs-lookup"><span data-stu-id="e03a4-124">Stages contain groups of identical **tasks** that can be executed in parallel on multiple nodes of the Spark cluster.</span></span> <span data-ttu-id="e03a4-125">Задачи являются наиболее детальную единицы выполнения происходящих на подмножестве данных.</span><span class="sxs-lookup"><span data-stu-id="e03a4-125">Tasks are the most granular unit of execution taking place on a subset of the data.</span></span>

<span data-ttu-id="e03a4-126">В следующих разделах описываются некоторые визуализации панели мониторинга, которые полезны для устранения неполадок производительности.</span><span class="sxs-lookup"><span data-stu-id="e03a4-126">The next sections describe some dashboard visualizations that are useful for performance troubleshooting.</span></span>

## <a name="job-and-stage-latency"></a><span data-ttu-id="e03a4-127">Задержка задания и рабочей области</span><span class="sxs-lookup"><span data-stu-id="e03a4-127">Job and stage latency</span></span>

<span data-ttu-id="e03a4-128">Задержку задания — это продолжительность выполнения задания из при запуске до завершения этой операции.</span><span class="sxs-lookup"><span data-stu-id="e03a4-128">Job latency is the duration of a job execution from when it starts until it completes.</span></span> <span data-ttu-id="e03a4-129">Отображается как процент выполнения задания в кластер и идентификатор приложения, чтобы разрешить визуализацию выбросы.</span><span class="sxs-lookup"><span data-stu-id="e03a4-129">It is shown as percentiles of a job execution per cluster and application ID, to allow the visualization of outliers.</span></span> <span data-ttu-id="e03a4-130">На следующей диаграмме показано журнал заданий где 90-й процентиль достигнут 50 секунд, несмотря на то, что 50-й процентиль согласованно было около 10 секунд.</span><span class="sxs-lookup"><span data-stu-id="e03a4-130">The following graph shows a job history where the 90th percentile reached 50 seconds, even though the 50th percentile was consistently around 10 seconds.</span></span>

![Диаграмма, показывающая задержку задания](./_images/grafana-job-latency.png)

<span data-ttu-id="e03a4-132">Проверьте выполнение задания, кластера и приложения поиска пиками задержки.</span><span class="sxs-lookup"><span data-stu-id="e03a4-132">Investigate job execution by cluster and application, looking for spikes in latency.</span></span> <span data-ttu-id="e03a4-133">После определения кластеров и приложений с высокой задержкой перейти к исследовать задержки рабочей области.</span><span class="sxs-lookup"><span data-stu-id="e03a4-133">Once clusters and applications with high latency are identified, move on to investigate stage latency.</span></span>

<span data-ttu-id="e03a4-134">Задержка рабочей области также отображается как процентили разрешить визуализацию выбросы.</span><span class="sxs-lookup"><span data-stu-id="e03a4-134">Stage latency is also shown as percentiles to allow the visualization of outliers.</span></span> <span data-ttu-id="e03a4-135">Этап задержки, разбитое по кластера, приложения и имя рабочей области.</span><span class="sxs-lookup"><span data-stu-id="e03a4-135">Stage latency is broken out by cluster, application, and stage name.</span></span> <span data-ttu-id="e03a4-136">Определите пики задержка задачи в графе, чтобы определить, какие задачи препятствующие завершения этапа.</span><span class="sxs-lookup"><span data-stu-id="e03a4-136">Identify spikes in task latency in the graph to determine which tasks are holding back completion of the stage.</span></span>

![Диаграмма, показывающая задержки рабочей области](./_images/grafana-stage-latency.png)

<span data-ttu-id="e03a4-138">Диаграмма пропускной способности кластер показывает количество заданий, этапы и задачи выполнены в минуту.</span><span class="sxs-lookup"><span data-stu-id="e03a4-138">The cluster throughput graph shows the number of jobs, stages, and tasks completed per minute.</span></span> <span data-ttu-id="e03a4-139">Это поможет вам понять рабочей нагрузки с точки зрения относительное количество этапов и задач на задание.</span><span class="sxs-lookup"><span data-stu-id="e03a4-139">This helps you to understand the workload in terms of the relative number of stages and tasks per job.</span></span> <span data-ttu-id="e03a4-140">Здесь вы увидите, что количество заданий в минуту варьируется в диапазоне от 2 и 6, а число уровней — около 12 &ndash; 24 в минуту.</span><span class="sxs-lookup"><span data-stu-id="e03a4-140">Here you can see that the number of jobs per minute ranges between 2 and 6, while the number of stages is about 12 &ndash; 24 per minute.</span></span>

![Пропускная способность кластера отображение Graph](./_images/grafana-cluster-throughput.png)

## <a name="sum-of-task-execution-latency"></a><span data-ttu-id="e03a4-142">Сумма задержек выполнения задачи</span><span class="sxs-lookup"><span data-stu-id="e03a4-142">Sum of task execution latency</span></span>

<span data-ttu-id="e03a4-143">Эта визуализация показывает сумму задержка выполнения задачи для каждого узла в кластере.</span><span class="sxs-lookup"><span data-stu-id="e03a4-143">This visualization shows the sum of task execution latency per host running on a cluster.</span></span> <span data-ttu-id="e03a4-144">Используя эту диаграмму, чтобы определить задачи, которые выполняются медленно из-за замедляет узла в кластере или misallocation задач на каждый исполнитель.</span><span class="sxs-lookup"><span data-stu-id="e03a4-144">Use this graph to detect tasks that run slowly due to the host slowing down on a cluster, or a misallocation of tasks per executor.</span></span> <span data-ttu-id="e03a4-145">На следующей диаграмме большинство узлов имеют сумму около 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="e03a4-145">In the following graph, most of the hosts have a sum of about 30 seconds.</span></span> <span data-ttu-id="e03a4-146">Тем не менее двух узлов имеют сумм, наведите указатель мыши около 10 минут.</span><span class="sxs-lookup"><span data-stu-id="e03a4-146">However, two of the hosts have sums that hover around 10 minutes.</span></span> <span data-ttu-id="e03a4-147">На узлах выполняется медленно, либо misallocated число задач на каждый исполнитель.</span><span class="sxs-lookup"><span data-stu-id="e03a4-147">Either the hosts are running slow or the number of tasks per executor is misallocated.</span></span>

![Sum отображение диаграммы выполнения задачи каждого узла](./_images/grafana-sum-task-exec.png)

<span data-ttu-id="e03a4-149">Число задач на каждый исполнитель показывает, что два исполнителей присвоен непропорционально большое количество задач, причиной возникновения узкого места.</span><span class="sxs-lookup"><span data-stu-id="e03a4-149">The number of tasks per executor shows that two executors are assigned a disproportionate number of tasks, causing a bottleneck.</span></span>

![Диаграмма, показывающая задач на каждый исполнитель](./_images/grafana-tasks-per-exec.png)

## <a name="task-metrics-per-stage"></a><span data-ttu-id="e03a4-151">Метрики задач каждого этапа</span><span class="sxs-lookup"><span data-stu-id="e03a4-151">Task metrics per stage</span></span>

<span data-ttu-id="e03a4-152">Визуализация метрик задач дает детализация затрат для выполнения задачи.</span><span class="sxs-lookup"><span data-stu-id="e03a4-152">The task metrics visualization gives the cost breakdown for a task execution.</span></span> <span data-ttu-id="e03a4-153">Используется см. в разделе относительное время, затраченное на задачи, например сериализации и десериализации.</span><span class="sxs-lookup"><span data-stu-id="e03a4-153">You can use it see the relative time spent on tasks such as serialization and deserialization.</span></span> <span data-ttu-id="e03a4-154">Эти данные могут показать возможности для оптимизации &mdash; к примеру, с помощью [передайте переменные](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) во избежание доставки данных.</span><span class="sxs-lookup"><span data-stu-id="e03a4-154">This data might show opportunities to optimize &mdash; for example, by using [broadcast variables](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) to avoid shipping data.</span></span> <span data-ttu-id="e03a4-155">Метрики задач также показывают размер данных смешения для задачи и случайном порядке чтения и записи времени.</span><span class="sxs-lookup"><span data-stu-id="e03a4-155">The task metrics also show the shuffle data size for a task, and the shuffle read and write times.</span></span> <span data-ttu-id="e03a4-156">Если высоки эти значения, это означает, что большие объемы данных передаются по сети.</span><span class="sxs-lookup"><span data-stu-id="e03a4-156">If these values are high, it means that a lot of data is moving across the network.</span></span>

<span data-ttu-id="e03a4-157">Другой задачи метрика задержки планировщика, который измеряет время, необходимое для планирования задач.</span><span class="sxs-lookup"><span data-stu-id="e03a4-157">Another task metric is the scheduler delay, which measures how long it takes to schedule a task.</span></span> <span data-ttu-id="e03a4-158">В идеальном случае это значение должно быть низкой по сравнению с исполнителя вычислительное время, то есть время, затраченное на фактического выполнения задачи.</span><span class="sxs-lookup"><span data-stu-id="e03a4-158">Ideally, this value should be low compared to the executor compute time, which is the time spent actually executing the task.</span></span>

<span data-ttu-id="e03a4-159">Ниже graph планировщика время задержки (3.7 s), превышает время вычислений исполнителя (1.1 s).</span><span class="sxs-lookup"><span data-stu-id="e03a4-159">The following graph shows a scheduler delay time (3.7 s) that exceeds the executor compute time (1.1 s).</span></span> <span data-ttu-id="e03a4-160">Это означает, что больше времени тратится на ожидание задачи планироваться, чем на выполнение реальной работы.</span><span class="sxs-lookup"><span data-stu-id="e03a4-160">That means more time is spent waiting for tasks to be scheduled than doing the actual work.</span></span>

![Диаграмма, показывающая метрик задач каждого этапа](./_images/grafana-metrics-per-stage.png)

<span data-ttu-id="e03a4-162">В этом случае причина слишком большое число секций, которые вызывали массу системных издержек.</span><span class="sxs-lookup"><span data-stu-id="e03a4-162">In this case, the problem was caused by having too many partitions, which caused a lot of overhead.</span></span> <span data-ttu-id="e03a4-163">Уменьшение числа секций уменьшается время задержки планировщика.</span><span class="sxs-lookup"><span data-stu-id="e03a4-163">Reducing the number of partitions lowered the scheduler delay time.</span></span> <span data-ttu-id="e03a4-164">Далее показывает график, в большинстве случаев затраченное на выполнение задачи.</span><span class="sxs-lookup"><span data-stu-id="e03a4-164">The next graph shows that most of the time is spent executing the task.</span></span>

![Диаграмма, показывающая метрик задач каждого этапа](./_images/grafana-metrics-per-stage2.png)

## <a name="streaming-throughput-and-latency"></a><span data-ttu-id="e03a4-166">Потоковая передача пропускной способности и задержки</span><span class="sxs-lookup"><span data-stu-id="e03a4-166">Streaming throughput and latency</span></span>

<span data-ttu-id="e03a4-167">Потоковая передача пропускной способности непосредственно связано с структурированной потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="e03a4-167">Streaming throughput is directly related to structured streaming.</span></span> <span data-ttu-id="e03a4-168">Существует две важные метрики, связанные с пропускную способность потоковой передачи: Входные строки на второй и обработанных строк в секунду.</span><span class="sxs-lookup"><span data-stu-id="e03a4-168">There are two important metrics associated with streaming throughput: Input rows per second and processed rows per second.</span></span> <span data-ttu-id="e03a4-169">Если входных строк в секунду outpaces строк, обработанных в секунду, значит, успевают системы обработки потоковых данных.</span><span class="sxs-lookup"><span data-stu-id="e03a4-169">If input rows per second outpaces processed rows per second, it means the stream processing system is falling behind.</span></span> <span data-ttu-id="e03a4-170">Кроме того Если входные данные поступают из концентраторов событий или Kafka, затем входных строк в секунду должен соответствовать скорость приема данных во внешнем интерфейсе.</span><span class="sxs-lookup"><span data-stu-id="e03a4-170">Also, if the input data comes from Event Hubs or Kafka, then input rows per second should keep up with the data ingestion rate at the front end.</span></span>

<span data-ttu-id="e03a4-171">Два задания может иметь аналогичные пропускной способности кластер, но очень разные метрики потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="e03a4-171">Two jobs can have similar cluster throughput but very different streaming metrics.</span></span> <span data-ttu-id="e03a4-172">На следующем рисунке показаны два разных рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="e03a4-172">The following screenshot shows two different workloads.</span></span> <span data-ttu-id="e03a4-173">Они аналогичны с точки зрения пропускной способности кластер (задания, этапы и задачи в минуту).</span><span class="sxs-lookup"><span data-stu-id="e03a4-173">They are similar in terms of cluster throughput (jobs, stages, and tasks per minute).</span></span> <span data-ttu-id="e03a4-174">Но второго запуска обрабатывает 12 000 строк/сек против 4 000 строк в секунду.</span><span class="sxs-lookup"><span data-stu-id="e03a4-174">But the second run processes 12,000 rows/sec versus 4,000 rows/sec.</span></span>

![Пропускную способность потоковой передачи отображение Graph](./_images/grafana-streaming-throughput.png)

<span data-ttu-id="e03a4-176">Пропускную способность потоковой передачи часто является лучшим бизнес-метрики, чем пропускная способность кластера, так как он измеряет количество записей данных, которые обрабатываются.</span><span class="sxs-lookup"><span data-stu-id="e03a4-176">Streaming throughput is often a better business metric than cluster throughput, because it measures the number of data records that are processed.</span></span>

## <a name="resource-consumption-per-executor"></a><span data-ttu-id="e03a4-177">Потребление ресурсов на каждый исполнитель</span><span class="sxs-lookup"><span data-stu-id="e03a4-177">Resource consumption per executor</span></span>

<span data-ttu-id="e03a4-178">Эти метрики помогают понять работу, которая выполняет каждого исполнителя.</span><span class="sxs-lookup"><span data-stu-id="e03a4-178">These metrics help to understand the work that each executor performs.</span></span>

<span data-ttu-id="e03a4-179">**Процентных показателей** измерения, сколько раз, когда исполнитель тратит на различные вещи, выраженное как доля времени, и общую исполнителя вычислительное время, затраченное на.</span><span class="sxs-lookup"><span data-stu-id="e03a4-179">**Percentage metrics** measure how much time an executor spends on various things, expressed as a ratio of time spent versus the overall executor compute time.</span></span> <span data-ttu-id="e03a4-180">Ниже приведены метрики.</span><span class="sxs-lookup"><span data-stu-id="e03a4-180">The metrics are:</span></span>

- <span data-ttu-id="e03a4-181">% Времени сериализации</span><span class="sxs-lookup"><span data-stu-id="e03a4-181">% Serialize time</span></span>
- <span data-ttu-id="e03a4-182">% Время десериализации</span><span class="sxs-lookup"><span data-stu-id="e03a4-182">% Deserialize time</span></span>
- <span data-ttu-id="e03a4-183">% Исполнителя времени ЦП</span><span class="sxs-lookup"><span data-stu-id="e03a4-183">% CPU executor time</span></span>
- <span data-ttu-id="e03a4-184">% Времени виртуальной машины Java</span><span class="sxs-lookup"><span data-stu-id="e03a4-184">% JVM time</span></span>

<span data-ttu-id="e03a4-185">Эти представления показывают, какой объем каждой метрики позволяет общую выполнения обработки.</span><span class="sxs-lookup"><span data-stu-id="e03a4-185">These visualizations show how much each of these metrics contributes to overall executor processing.</span></span>

![Диаграмма, показывающая процентных показателей](./_images/grafana-percentage.png)

<span data-ttu-id="e03a4-187">**Метрики в случайном порядке** , метрик, связанных с данными, перетасовывания между исполнителями.</span><span class="sxs-lookup"><span data-stu-id="e03a4-187">**Shuffle metrics** are metrics related to data shuffling across the executors.</span></span>

- <span data-ttu-id="e03a4-188">Ввод-вывод в случайном порядке</span><span class="sxs-lookup"><span data-stu-id="e03a4-188">Shuffle I/O</span></span>
- <span data-ttu-id="e03a4-189">Память в случайном порядке</span><span class="sxs-lookup"><span data-stu-id="e03a4-189">Shuffle memory</span></span>
- <span data-ttu-id="e03a4-190">Использование файловой системы</span><span class="sxs-lookup"><span data-stu-id="e03a4-190">File system usage</span></span>
- <span data-ttu-id="e03a4-191">Использование диска</span><span class="sxs-lookup"><span data-stu-id="e03a4-191">Disk usage</span></span>

## <a name="common-performance-bottlenecks"></a><span data-ttu-id="e03a4-192">Общие узкие места производительности</span><span class="sxs-lookup"><span data-stu-id="e03a4-192">Common performance bottlenecks</span></span>

<span data-ttu-id="e03a4-193">Два распространенных узких мест производительности в Spark, *задач других ошибок* и *количество разделов не является оптимальным shuffle*.</span><span class="sxs-lookup"><span data-stu-id="e03a4-193">Two common performance bottlenecks in Spark are *task stragglers* and a *non-optimal shuffle partition count*.</span></span>

### <a name="task-stragglers"></a><span data-ttu-id="e03a4-194">Задача других ошибок</span><span class="sxs-lookup"><span data-stu-id="e03a4-194">Task stragglers</span></span>

<span data-ttu-id="e03a4-195">Этапы задания выполняются последовательно, с помощью более ранних этапах, блокировки более поздних стадиях.</span><span class="sxs-lookup"><span data-stu-id="e03a4-195">The stages in a job are executed sequentially, with earlier stages blocking later stages.</span></span> <span data-ttu-id="e03a4-196">Если одна задача выполняет секции shuffle медленнее, чем другие задачи, все задачи в кластере необходимо дождаться медленных задачах отследить, прежде чем могут быть сохранены в рабочей области.</span><span class="sxs-lookup"><span data-stu-id="e03a4-196">If one task executes a shuffle partition more slowly than other tasks, all tasks in the cluster must wait for the slow task to catch up before the stage can end.</span></span> <span data-ttu-id="e03a4-197">Это может произойти по следующим причинам:</span><span class="sxs-lookup"><span data-stu-id="e03a4-197">This can happen for the following reasons:</span></span>

1. <span data-ttu-id="e03a4-198">Для узла или группы узлов выполняется медленно.</span><span class="sxs-lookup"><span data-stu-id="e03a4-198">A host or group of hosts are running slow.</span></span> <span data-ttu-id="e03a4-199">Симптомы: Высокий уровень задач, рабочей области, или задержку задания и кластера с низкой пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="e03a4-199">Symptoms: High task, stage, or job latency and low cluster throughput.</span></span> <span data-ttu-id="e03a4-200">Суммирование задержки задачи каждого узла не распределены неравномерно.</span><span class="sxs-lookup"><span data-stu-id="e03a4-200">The summation of tasks latencies per host won't be evenly distributed.</span></span> <span data-ttu-id="e03a4-201">Тем не менее потребление ресурсов будут равномерно распределены между исполнителями.</span><span class="sxs-lookup"><span data-stu-id="e03a4-201">However, resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="e03a4-202">Задачи иметь дорогостоящие агрегат для выполнения (искажения данных).</span><span class="sxs-lookup"><span data-stu-id="e03a4-202">Tasks have an expensive aggregation to execute (data skewing).</span></span> <span data-ttu-id="e03a4-203">Симптомы: Распределяется равномерно высокого уровня задачи, рабочей области, или задания и кластера с низкой пропускной способности, но также суммирование задержки для каждого узла.</span><span class="sxs-lookup"><span data-stu-id="e03a4-203">Symptoms: High task, stage, or job and low cluster throughput, but the summation of latencies per host is evenly distributed.</span></span> <span data-ttu-id="e03a4-204">Потребление ресурсов будут равномерно распределены между исполнителями.</span><span class="sxs-lookup"><span data-stu-id="e03a4-204">Resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="e03a4-205">Если разделы размера не равны, увеличенный раздел может привести к несбалансированное задачи выполнения (наклон секции).</span><span class="sxs-lookup"><span data-stu-id="e03a4-205">If partitions are of unequal size, a larger partition may cause unbalanced task execution (partition skewing).</span></span> <span data-ttu-id="e03a4-206">Симптомы: Потребление ресурсов исполнителя велико по сравнению с другими исполнителей, запущенных в кластере.</span><span class="sxs-lookup"><span data-stu-id="e03a4-206">Symptoms: Executor resource consumption is high compared to other executors running on the cluster.</span></span> <span data-ttu-id="e03a4-207">Все задачи, выполняемые на этого исполнителя запускается медленно и хранения выполнения этапа в конвейере.</span><span class="sxs-lookup"><span data-stu-id="e03a4-207">All tasks running on that executor will run slow and hold the stage execution in the pipeline.</span></span> <span data-ttu-id="e03a4-208">Эти этапы, называются *этап барьеры*.</span><span class="sxs-lookup"><span data-stu-id="e03a4-208">Those stages are said to be *stage barriers*.</span></span>

### <a name="non-optimal-shuffle-partition-count"></a><span data-ttu-id="e03a4-209">Число секций неоптимальная смешения</span><span class="sxs-lookup"><span data-stu-id="e03a4-209">Non-optimal shuffle partition count</span></span>

<span data-ttu-id="e03a4-210">Во время запросов структурированной потоковой передачи присваивания задачи исполнитель — ресурсоемкая операция, для кластера.</span><span class="sxs-lookup"><span data-stu-id="e03a4-210">During a structured streaming query, the assignment of a task to an executor is a resource-intensive operation for the cluster.</span></span> <span data-ttu-id="e03a4-211">Если данные shuffle не самым оптимальным, продолжительность задержки для задачи может негативно отразиться на пропускной способности и задержки.</span><span class="sxs-lookup"><span data-stu-id="e03a4-211">If the shuffle data isn't the optimal size, the amount of delay for a task will negatively impact throughput and latency.</span></span> <span data-ttu-id="e03a4-212">При наличии слишком мало секций, ядер в кластере будет недостаточно загружены приемом которых может привести к обработке эффективности.</span><span class="sxs-lookup"><span data-stu-id="e03a4-212">If there are too few partitions, the cores in the cluster will be underutilized which can result in processing inefficiency.</span></span> <span data-ttu-id="e03a4-213">И наоборот Если существует слишком много секций, есть немало накладных расходов на небольшое количество задач.</span><span class="sxs-lookup"><span data-stu-id="e03a4-213">Conversely, if there are too many partitions, there's a great deal of management overhead for a small number of tasks.</span></span>

<span data-ttu-id="e03a4-214">Использование показателей потребления ресурсов для устранения неполадок наклон секции и misallocation из исполнителей в кластере.</span><span class="sxs-lookup"><span data-stu-id="e03a4-214">Use the resource consumption metrics to troubleshoot partition skewing and misallocation of executors on the cluster.</span></span> <span data-ttu-id="e03a4-215">Если раздел синхронизована, будут повышены ресурсы исполнителя по сравнению с другими исполнителей, запущенных в кластере.</span><span class="sxs-lookup"><span data-stu-id="e03a4-215">If a partition is skewed, executor resources will be elevated in comparison to other executors running on the cluster.</span></span>

<span data-ttu-id="e03a4-216">Например приведенный ниже график показывает, что объем памяти, используемой перетасовывания на первых двух исполнители — 90 X больше, чем другие исполнители:</span><span class="sxs-lookup"><span data-stu-id="e03a4-216">For example, the following graph shows that the memory used by shuffling on the first two executors is 90X bigger than the other executors:</span></span>

![Диаграмма, показывающая процентных показателей](./_images/grafana-shuffle-memory.png)