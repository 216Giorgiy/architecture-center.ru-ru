---
title: Наблюдение за работоспособностью приложений для обеспечения надежности в Azure
description: Как использовать мониторинг для повышения надежности приложений в Azure
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: 46f9f3fb623a2facf4b9f9c6ec57376ae59e41dc
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646675"
---
# <a name="monitoring-application-health-for-reliability-in-azure"></a>Наблюдение за работоспособностью приложений для обеспечения надежности в Azure

Мониторинг и диагностика важны для обеспечения устойчивости. В случае отказа, необходимо знать *,* попытка не удалась, *при* попытка не удалась &mdash; и *почему*.

*Мониторинг* не является таким же, как *обнаружения сбоев*. Например, приложение может обнаружить временную ошибку и повторить попытку, отсутствие простоев. Но оно также должно регистрировать операцию повтора, можно наблюдать за ее частота ошибок, чтобы получить общее представление о работоспособности приложения.

Процесс мониторинга и диагностики можно рассматривать как конвейер с четырех различных этапов: Инструментирование, сбора и хранения, анализа и диагностики и визуализация и оповещения.

## <a name="instrumentation"></a>Инструментирование

Это не позволяет наблюдать за приложением напрямую, поэтому инструментария является ключом. Крупномасштабная распределенная система может работать на десятках виртуальных машин (ВМ), которые добавляются и удаляются с течением времени. Аналогичным образом Облачное приложение может использовать несколько хранилищ данных и одно действие пользователя может охватывать несколько подсистем.

Предоставьте расширенный инструментарий:

- Для сбоев, которые, скорее всего, но еще не произошло, обеспечить достаточный объем данных, чтобы определить причину, уменьшить последствия ситуации и обеспечить доступность системы.
- Для сбоев, которые уже произошли приложение должно возвращать соответствующее сообщение об ошибке пользователю, но следует попытаться продолжить выполнение, хотя и с ограниченными возможностями.

Систем мониторинга должна записывать всеобъемлющие данные, чтобы приложения, которые могут восстанавливаться эффективно и, при необходимости, проектировщикам и разработчикам может изменить систему для предотвращения подобных ситуаций в будущем.

Необработанные данные мониторинга могут поступать из различных источников, включая:

- Журналы приложений, например созданные программой [Azure Application Insights](/azure/azure-monitor/app/app-insights-overview) службы.
- Сбор показателей производительности операционной системы [Azure агентов мониторинга](/azure/azure-monitor/platform/agents-overview).
- [Ресурсы Azure](/azure/azure-monitor/platform/metrics-supported), включая метрики собранные Azure Monitor.
- [Служба работоспособности служб Azure](/azure/service-health/service-health-overview), который включает панель мониторинга, чтобы помочь вам отслеживать такие активные события.
- [Журналы Azure AD](/azure/active-directory/reports-monitoring/howto-integrate-activity-logs-with-log-analytics) встроены в платформу Azure.

Большинство служб Azure имеют метрик и диагностических сведений, можно настроить для анализа и определить причину проблемы. Дополнительные сведения см. в разделе [данные мониторинга собранные Azure Monitor](/azure/azure-monitor/platform/data-collection).

## <a name="collection-and-storage"></a>Сбор и хранение

Необработанные данные инструментирования могут храниться в различных расположениях и форматах, включая:

- Журналы трассировки приложений
- Журналы IIS
- Счетчики производительности

Эти разрозненные источники собираются, consolidated и поместить в хранилищах данных в Azure, например Application Insights, Azure Monitor метрики, работоспособность службы, учетные записи хранения и Azure Log Analytics.

## <a name="analysis-and-diagnosis"></a>Анализ и диагностика

Анализ данных объединены в эти хранилища данных для устранения неполадок и получить общее представление о работоспособности приложения. Как правило, вы можете [искать и анализировать](/azure/azure-monitor/log-query/log-query-overview) данных в Application Insights и Log Analytics с помощью запросов Kusto или диаграммами предварительно настроенные представления, с помощью [решения по управлению](/azure/azure-monitor/insights/solutions-inventory). Или использовать помощник по Azure, чтобы просмотреть рекомендации с упором на [устойчивости](/azure/advisor/advisor-high-availability-recommendations) и [производительности](/azure/advisor/advisor-performance-recommendations).

## <a name="visualization-and-alerts"></a>Визуализация и оповещения

Представления данных телеметрии в формате, который позволяет легко оператор может заметить проблемы или тенденции, например оповещение в панели мониторинга или по электронной почте.

Получите полный стек представление о состоянии приложения с помощью [панелей мониторинга Azure](/azure/azure-portal/azure-portal-dashboards) создать консолидированное представление мониторинга графов из Application Insights, Log Analytics, метрик Azure Monitor и работоспособности службы. И использовать [оповещения Azure Monitor](/azure/azure-monitor/platform/alerts-overview) для создания уведомлений о работоспособности службы, служба работоспособности ресурсов, метрик Azure Monitor, журналы в Log Analytics и Application Insights.

Дополнительные сведения о мониторинге и диагностике см. в разделе [мониторинг и диагностика](../best-practices/monitoring.md).

## <a name="health-probes-and-check-functions"></a>Проверки работоспособности и функции проверки

Работоспособность и производительность приложения может снижаться с течением времени и снижение может быть заметной пока не происходит сбой приложения.

Реализуйте проверочные или функций проверок и выполняйте их регулярно из вне приложения. Эти проверки может быть просто измерением времени ответа для приложения в целом, для отдельных частей приложения, для определенных служб, используемых приложением или для отдельных компонентов.

Убедитесь, что функции можно выполнять процессы, чтобы убедиться, что они выдают правильные результаты, измерение задержки и проверка доступности и извлечения информации из системы.

## <a name="long-running-workflow-failures"></a>Сбои длительных рабочих процессов

Длительно выполняемые рабочие процессы часто включают в себя несколько этапов, каждый из которых должны быть независимыми.

Отслеживайте ход выполнения длительных рабочих процессов, чтобы свести к минимуму вероятность того, что весь рабочий процесс будет необходимо выполнить откат или что несколько компенсирующих транзакций необходимо выполнить.

>[!TIP]
> Мониторинг и управление им ход выполнения длительных рабочих процессов, реализовав шаблон, такие как [планировщик, агент, контролер](../patterns/scheduler-agent-supervisor.md).

## <a name="application-logs"></a>Журналы приложений

Журналы приложений являются важным источником данных диагностики. Для получения представления о нужный момент большинство, следуйте рекомендациям по ведению журнала приложения.

### <a name="log-data-in-the-production-environment"></a>Данные журнала в рабочей среде

Записывает данные, надежные данные телеметрии, пока приложение выполняется в рабочей среде, поэтому у вас есть достаточно данных для выявления причины возникновения проблем в рабочее состояние.

### <a name="log-events-at-service-boundaries"></a>События журнала в границах служб

Включите идентификатор корреляции в границах служб. Если транзакции проходят через несколько служб и из них завершается ошибкой, корреляции, идентификатор помогает отслеживать запросы на приложения и указывает, почему произошел откат транзакции.

### <a name="use-semantic-structured-logging"></a>Используйте семантическое ведение журнала (структурированные)

С помощью структурированных журналов проще автоматизацию потребления и анализа данных журнала, что особенно важно в масштабе облака. Как правило рекомендуется хранить данные метрик и диагностики ресурсов Azure, в рабочей области Log Analytics, а не в учетной записи хранения. Таким образом, можно использовать запросов Kusto получить данные, которые вы хотите быстро и в структурированном формате. Можно также использовать интерфейсы API Azure Monitor и API-интерфейсы Azure Log Analytics.

### <a name="use-asynchronous-logging"></a>Используйте асинхронное ведение журнала

Синхронное ведение журнала операций иногда блокировать код приложения, запросов для резервного копирования, которые записываются журналы. Используйте асинхронное ведение журнала для сохранения доступности во время ведения журнала приложения.

### <a name="separate-application-logging-from-auditing"></a>Отдельное приложение ведения журнала аудита

Записи аудита обычно поддерживаются для соответствия требованиям или нормативным требованиям и должен быть завершен. Чтобы избежать потерянных транзакций, ведение журналов аудита отдельно от журналов диагностики.

## <a name="remote-call-statistics"></a>Статистику удаленных вызовов

Отслеживания и формирования отчетов удаленного вызова статистику в режиме реального времени и предоставляют простой способ просматривать эту информацию, чтобы рабочая группа имеет конкретное представление работоспособности приложения. Суммируйте показатели удаленного вызова, такие как задержка, пропускная способность и ошибки в 99 и 95 процентили.

## <a name="transient-exceptions-and-retries"></a>Временные исключения и число повторных попыток

Отслеживайте количество временных исключений и повторений некоторое время, чтобы выявить проблемы или сбои в приложении логику повторных попыток. Тенденция увеличения исключений с течением времени может означать, что службы возникла проблема и может завершиться ошибкой. Дополнительные сведения см. в статье [Конкретные рекомендации по использованию механизма повторов](../best-practices/retry-service-specific.md).

## <a name="early-warning-system"></a>Систему раннего предупреждения

Мониторинг приложения для признаков, которые могут потребовать активного вмешательства. Средства, которые оценки общей работоспособности приложения и его зависимости помогут вам быстро распознавать, когда системе или его компоненты внезапно становятся недоступными. Используйте их, чтобы реализовать систему раннего предупреждения.

1. Определите ключевые показатели эффективности по работоспособности приложений, таких как временные исключения и задержка удаленного вызова.
1. Установить пороговые значения на уровнях, которые идентифицируют проблемы, прежде чем они станут критическими и потребуют мер восстановления.
1. Отправьте оповещение операциям при достижении порогового значения.

Рассмотрите возможность [Microsoft System Center 2016](https://www.microsoft.com/cloud-platform/system-center) или сторонних средств для обеспечения возможности мониторинга. Большинство решений мониторинга отслеживают основные счетчики производительности, а также доступность службы. [Служба работоспособности ресурсов Azure](/azure/service-health/resource-health-checks-resource-types) предоставляет некоторые встроенные работоспособности проверки состояния, которые могут помочь диагностировать регулирования служб Azure.

## <a name="subscription-and-service-limitations"></a>Ограничения подписки и службы

Подписках Azure предусмотрены ограничения на определенные типы ресурсов, таких как количество групп ресурсов, ядер и учетные записи хранения. Чтобы убедиться, что приложение не приходится сталкиваться ограничения подписки Azure, создайте оповещения, опрос для служб, близко к их ограничения и квоты.

Устраните следующие ограничения подписки с предупреждениями.

### <a name="individual-services"></a>Отдельные службы

Отдельные службы Azure имеют ограничения на использование хранилища, пропускной способности, число подключений, запросов в секунду и другие показатели. Приложение не будет работать, если предпринимается попытка использовать ресурсы за пределами этих ограничений, приведет к простоям регулирования и возможных службы.

В зависимости от конкретной службы и требований приложения можно часто превышают эти ограничения масштабирования (например, выбора другого уровня цен,) или горизонтального масштабирования (добавления новых экземпляров).

### <a name="azure-storage-scalability-and-performance-targets"></a>Целевые показатели масштабируемости и производительности хранилища Azure

Azure позволяет максимальное количество учетных записей для подписки. Если приложению требуется несколько учетных записей, чем в настоящее время доступны в вашей подписке, создайте новую подписку с помощью дополнительных учетных записей хранения. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы](/azure/azure-subscription-service-limits/#storage-limits).

Если вы превысите целевые показатели масштабируемости и производительности хранилища Azure, приложение будет отрегулировать хранилища. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/storage-scalability-targets/).

### <a name="scalability-targets-for-virtual-machine-disks"></a>Целевые показатели масштабируемости для дисков виртуальной машины

Инфраструктуры как услуги (IaaS) виртуальной Машины Azure поддерживают подключение нескольких дисков данных, в зависимости от нескольких факторов, включая размер виртуальной Машины и тип учетной записи хранения. Если приложение превышает целевые показатели масштабируемости для дисков виртуальных машин, подготовьте дополнительные учетные записи хранения и создайте в них виртуальные диски. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/storage-scalability-targets/#scalability-targets-for-virtual-machine-disks).

### <a name="vm-size"></a>Размер виртуальной машины

Фактическое ЦП, памяти, диска и ввода-вывода ваших виртуальных машин ограничениям размера виртуальной Машины, ваше приложение может испытывать проблем с емкостью. Для устранения проблем, увеличьте размер виртуальной Машины. Размеры виртуальных Машин описаны в [размеры виртуальных машин в Azure](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Если рабочая нагрузка постоянно изменяется со временем, рассмотрите возможность с помощью масштабирования виртуальных машин задает автоматически масштабировать количество экземпляров виртуальных Машин. В противном случае необходимо вручную увеличить или уменьшить число виртуальных машин. Дополнительные сведения см. в разделе [Обзор масштабируемых наборов виртуальных машин](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/).

### <a name="azure-sql-database"></a>Базы данных SQL Azure

Если уровень базы данных SQL Azure не достаточно удовлетворить требования приложения единицы транзакций базы данных (DTU), использование данных будет регулироваться. Дополнительные сведения о выборе правильного плана обслуживания, см. в разделе [базы данных SQL Azure, приобретение моделей](/azure/sql-database/sql-database-service-tiers/).

## <a name="third-party-services"></a>Сторонние службы

Если приложение имеет зависимости от сторонних служб, определите, как эти службы может произойти сбой, и сбоев эффект будет иметь на приложение.

Сторонняя служба могут не включать мониторинга и диагностики. Журнал вызовов этих служб и сопоставлять их с работоспособности и ведение журналов диагностики с использованием уникального идентификатора приложения. Дополнительные сведения о методиках мониторинга и диагностики см. в разделе [руководство по мониторингу и диагностике](../best-practices/monitoring.md).

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [План аварийного восстановления](./disaster-recovery.md)
