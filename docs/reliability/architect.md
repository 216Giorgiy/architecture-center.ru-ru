---
title: Разработка архитектуры приложения Azure для обеспечения устойчивости и доступности
description: Встраивать в приложения Azure устойчивости и доступности
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: ee4bb5b4a85e48fe0ff017297c31823c93a48f04
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646666"
---
# <a name="architecting-azure-applications-for-resiliency-and-availability"></a>Разработка архитектуры приложения Azure для обеспечения устойчивости и доступности

Вы разработали требования для приложения, следующим шагом после построения устойчивости и доступности в него. Эти качества не может быть добавлен в конце &mdash; их необходимо разработать в архитектуру.

## <a name="conduct-a-failure-mode-analysis"></a>Провести анализ режима сбоя

*Анализ режима сбоя* (FMA) выполняет сборку устойчивости в системе путем определения возможных точек сбоя и определения того, как приложение реагирует на эти сбои. FMA должна быть частью этапов архитектуры и разработки, поэтому восстановление после сбоя встроена в систему с самого начала. Цели FMA должны:

- Определите типы сбоев, которые могут возникнуть в приложении и как приложение обнаруживает эти сбои.
- Записать потенциальное влияние каждого типа сбоя и определить реакцию приложения.
- Планирование ведения журналов и мониторинга сбоя и определите стратегии восстановления.

Ниже приведены некоторые примеры режимов сбоя и стратегии обнаружения для точки конкретный сбой &mdash; вызов внешней веб-службы:

| Режим сбоя           | Стратегия обнаружения           |
|------------------------|------------------------------|
| Ресурс недоступен | HTTP 5xx                     |
| Регулирование             | HTTP 429 (слишком много запросов) |
| Authentication         | HTTP 401 (недостаточно прав)      |
| Низкое время отклика          | Истекло время ожидания для запроса            |

Дополнительные сведения о процессе FMA, определенные рекомендации для Azure, см. в разделе [анализ режима сбоя](../resiliency/failure-mode-analysis.md).

## <a name="plan-for-redundancy"></a>План для обеспечения избыточности

Область влияния сбоев различаются. Некоторые аппаратные сбои, такие как неисправный диск, влияющие на одном хост-компьютере. Сбой сетевого коммутатора может повлиять на всю серверную стойку. Менее Типичные сбои, такие как отключение питания, нарушить работу всего центра обработки данных. В редких случаях весь регион становится недоступным.

Избыточность — один из способов обеспечить устойчивость приложения. Уровень избыточности зависит от бизнес-требований &mdash; не каждому приложению требуется избыточность по регионам для защиты от регионального сбоя. Как правило обеспечивает компромисс между избыточность и надежность при сопоставимых выше стоимость и сложность.

### <a name="review-azure-redundancy-features"></a>Ознакомьтесь с функциями избыточности Azure

Azure имеет ряд функций резервирования на каждом уровне сбоя, из отдельных виртуальных машин (ВМ) для всего региона.

- **Одиночные виртуальные машины** имеют [времени работы соглашение об уровне обслуживания (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines) , предоставляемые Azure. (Виртуальной Машины необходимо использовать хранилище класса premium для всех дисков операционной системы и дисков данных.) Вы можете использовать дополнительные возможности в рамках этого соглашения, запуская несколько виртуальных машин. Но отдельная виртуальная машина также может быть достаточно надежна для некоторых рабочих нагрузок. Для рабочих нагрузок в рабочей среде рекомендуем использовать две или более виртуальных машин, чтобы обеспечить избыточность.
- **Группы доступности** защиты от локальных сбоев оборудования, например диск или сетевой коммутатор сбоя. Виртуальные машины в наборе доступности распределены между до трех *домены сбоя*. Домены сбоя определяет группу виртуальных машин, которые совместно используют общий источник питания и сетевой коммутатор. Если сбой оборудования затрагивает один домен сбоя, сетевой трафик направляется к виртуальным машинам в других доменах сбоя. Дополнительные сведения о группах доступности см. в разделе [Управление доступностью виртуальных машин Windows в Azure](/azure/virtual-machines/windows/manage-availability).
- **Зоны доступности** являются физически отдельные зоны в регионе Azure. У каждой зоны доступности есть отдельный источник питания, сеть и система охлаждения. Развертывание виртуальных машин в зонах доступности помогает защитить приложение от сбоев на уровне центра обработки данных. Не все регионы поддерживают Зоны доступности. Список поддерживаемых регионов и служб см. в статье [Что такое Зоны доступности в Azure](/azure/availability-zones/az-overview).

    Если вы планируете использовать зоны доступности в развертывании, сначала убедитесь, что архитектура приложения и базы кода поддерживает такую конфигурацию. Если вы развертываете коммерческое программное обеспечение, обратитесь к поставщику программного обеспечения и адекватно протестировать до развертывания в рабочей среде. Приложение должно поддерживать состояние и предотвратить потерю данных во время сбоя в зоне. Приложение должно поддерживать выполнение в инфраструктуре эластичных БД и распределенные без компонентов инфраструктуры, жестко.
- **Azure Site Recovery** должен реплицирует виртуальные машины Azure в другой регион Azure для обеспечения непрерывности бизнеса (BC) и аварийное восстановление (DR). Можно проводить периодические аварийного восстановления для обеспечения соответствия нормативными требованиями. Виртуальной Машины реплицируются с указанными параметрами в выбранном регионе, позволяя восстанавливать приложения в случае сбоев в исходном регионе. Дополнительные сведения см. в разделе [Настройка аварийного восстановления, в дополнительный регион Azure для виртуальной Машины Azure](/azure/site-recovery/azure-to-azure-quickstart/).

    Убедитесь, что во время тестирования, *целевое время восстановления* (RTO) и *целевая точка восстановления* (RPO) соответствии с вашими потребностями. RTO — это максимальное время, приложение будет недоступным после инцидента, и это максимальная продолжительность потери данных во время аварии.
- **Пары регионов** создаются с помощью диспетчера трафика Azure для распределения Интернет-трафика в разных регионах, защищая приложение от регионального сбоя. Каждый регион Azure сопряжен с другим регионом. Вместе эти регионах, образуют [ *региональные пары*](/azure/best-practices-availability-paired-regions). В соответствии с требованиями к местонахождению данных налогообложением и юрисдикцией применения, региональные пары находятся в той же географической области (за исключением Южной Бразилии).

    Чтобы повысить устойчивость приложения, Azure выполняет сериализацию обновлений платформы (плановое обслуживание) для каждой пары регион, так что только один парный регион обновляется одновременно.
- При создании нескольких регионах приложения учитывает, задержка сети между регионами больше, чем в пределах региона. Например при репликации базы данных для отработки отказа, используйте синхронную репликацию данных в пределах региона, но асинхронных данных репликации между регионами.

В следующей таблице сравниваются факторов избыточности между несколькими стратегии обеспечения отказоустойчивости:

| &nbsp; | Группа доступности | Зона доступности | Azure Site Recovery / Парный регион |
|--------|------------------|-------------------|-----------------------------------|
| Область сбоя | Стойка                  | Центр обработки данных               | Регион                               |
| Маршрутизация запросов  | Azure Load Balancer   | Распределение нагрузки между зонами | Azure Traffic Manager                |
| Задержки сети  | Очень низкий              | Низкий                      | От среднего до высокого                          |
| Виртуальная сеть  | Виртуальная сеть Azure | Виртуальная сеть Azure          | Пиринг между виртуальными сетями между регионами |

### <a name="complete-azure-redundancy-tasks"></a>Задачи завершения избыточности Azure

Используйте следующие задачи в соответствии с требованиями избыточности:

- **Развертывайте несколько экземпляров служб.** Если приложение зависит от одного экземпляра службы, создается единая точка отказа. Подготовка нескольких экземпляров улучшает как отказоустойчивость, так и масштабируемость. Для [службы приложений Azure](/azure/app-service/app-service-value-prop-what-is/) выберите [план служб приложений](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/), где есть несколько экземпляров. Для [виртуальных машинах](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json), убедитесь, что архитектуры имеет несколько виртуальных Машин и что каждая виртуальная машина входит в [доступности](/azure/virtual-machines/virtual-machines-windows-manage-availability/).

- **Репликация виртуальных машин с помощью Site Recovery.** При репликации виртуальных машин Azure с помощью [Site Recovery](/azure/site-recovery/), все диски виртуальной Машины постоянно реплицируются асинхронно к целевой области. Точки восстановления создаются каждые несколько минут, предоставляя целевой точки восстановления от нескольких минут.

- **Рассмотрите возможность развертывания приложения в нескольких регионах.** Если приложение развертывается в одном регионе и регион становится недоступным, приложение также будет недоступна. Это может быть неприемлемо в соответствии с условиями SLA вашего приложения. Если это так, рассмотрите возможность развертывания приложения и служб в нескольких регионах. Можно использовать в нескольких регионах развертывания *активных* или *активный / пассивный* конфигурации. Активный-активный распределяет запросы между несколькими регионами active. Активно пассивной конфигурации остается «горячего» резервирования экземпляров в дополнительном регионе, а не отправлять трафик существует случая основного региона. Для развертываний в нескольких регионах рекомендуется развертывать среди парных регионов, описанных выше. Дополнительные сведения см. в руководстве по обеспечению [непрерывности бизнес-процессов и аварийного восстановления в парах регионов Azure](/azure/best-practices-availability-paired-regions).

- **Используйте диспетчер трафика Azure для маршрутизации трафика вашего приложения в разные регионы.** [Диспетчер трафика Azure](/azure/traffic-manager/traffic-manager-overview/) выполняет балансировку нагрузки на уровне DNS и направляет трафик в разные регионы на основе [маршрутизацию трафика](/azure/traffic-manager/traffic-manager-routing-methods/) метода и работоспособности конечных точек вашего приложения. Без диспетчера трафика вы ограничены одним регионом для развертывания, который ограничивает масштаб, увеличивается задержка для некоторых пользователей и возникает простой приложений, в случае нарушения работы службы на уровне региона.

- **Настройка шлюза приложений Azure для использования нескольких экземпляров.** В зависимости от требований приложения [шлюз приложений Azure](/azure/application-gateway/application-gateway-introduction/) может лучше подойти для распространения запросов в вашем приложении. Тем не менее отдельные экземпляры службы шлюза приложений не гарантируются соглашением SLA, так что вполне возможно, что приложение может завершиться с ошибкой, если происходит сбой экземпляра шлюза приложений. Подготовить несколько экземпляров среднего или большего размера для обеспечения доступности службы в соответствии с условиями [соглашение об уровне ОБСЛУЖИВАНИЯ для приложения шлюза](https://azure.microsoft.com/support/legal/sla/application-gateway/).

## <a name="design-for-scalability"></a>Проектирование для масштабируемости

*Масштабируемость* — это способность системы для обработки повышенной нагрузки и является одним из [основных аспектов качества программного обеспечения](../guide/pillars.md). Следующие задачи масштабируемости на этапе проектирования архитектуры.

- **Рабочие нагрузки секции.** Проектируйте части процесса так, чтобы они были дискретными и делимыми. Свести к минимуму размер каждой части. Это позволяет распространять способом, который расширяет возможности использования каждой вычислительной единицы части компонента. Это также облегчает масштабирование приложения путем добавления экземпляров определенных ресурсов. Для сложных областей применения рекомендуем применять [архитектуру микрослужб](../guide/architecture-styles/microservices.md).
- **Структура для масштабирования.** Масштабирование позволяет приложениям реагировать на переменную нагрузку путем увеличения и уменьшения числа экземпляров ролей, очередей и других служб. Тем не менее приложение должно быть спроектировано с учетом этого. Например приложения и службы, используемые в нем должен быть без отслеживания состояния, чтобы разрешить запросы можно было направлять в любой экземпляр. Наличие служб без отслеживания состояния также означает, что добавление или удаление экземпляра не оказывает негативного влияния текущих пользователей.
- **Планирование роста сети с использованием единиц масштабирования.** Для каждого ресурса знать верхний предел масштабирования и использовать сегментирование или разбиение превысить эти ограничения. Проектируйте приложение таким образом, чтобы его легко было масштабировать, путем добавляя одну или нескольких единиц масштабирования. Определите единицы масштабирования для системы с точки зрения четко определенных наборов ресурсов. Это делает Применение операций масштабирования проще и снизит отрицательное влияние, из-за отсутствия ресурсов в определенной части системы в целом. Например, добавление *X* число интерфейсные виртуальные машины могут потребовать *Y* число дополнительных очередей и *Z* число учетных записей хранения для обработки дополнительной рабочей нагрузки. Поэтому единица масштабирования может состоять из *X* экземпляров виртуальных Машин, *Y* очереди, и *Z* учетные записи хранения.
- **Избегайте привязки клиента.** Если это возможно, убедитесь в том, что приложение не требует сходства. Затем можно было передавать запросы к любому экземпляру, и количество экземпляров не имеет значения. Этим также устраняются дополнительные издержки на хранение, получение и обслуживание информации о состоянии для каждого пользователя.
- **Преимущества функций автомасштабирования платформы.** Используйте встроенные возможности автомасштабирования по возможности вместо пользовательских или сторонних механизмов. Используйте запланированного правила масштабирования, где это возможно, чтобы убедиться, что ресурсы доступны без задержки запуска, но добавить реактивное автоматическое масштабирование в правила, где уместно, справляться с неожиданными изменениями нагрузки. Дополнительные сведения см. в разделе [руководство по автоматическому масштабированию](../best-practices/auto-scaling.md).  

  Если приложение не настроено автоматическое увеличении нагрузки масштабирование, существует возможность, что приложения служб завершится ошибкой, если при перегрузке запросы пользователей. Дополнительные сведения см. в следующих статьях:

  - Общие сведения: [Контрольный список для обеспечения масштабируемости](../checklist/scalability.md)
  - Служба приложений Azure: [Масштабирование числа экземпляров вручную или автоматически](/azure/monitoring-and-diagnostics/insights-how-to-scale/)
  - Облачные службы: [Как выполнять автоматическое масштабирование облачной службы](/azure/cloud-services/cloud-services-how-to-scale/)
  - Виртуальные машины: [Автоматическое масштабирование и виртуальной машины для масштабируемых наборов](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/)

- **Выгрузите ресурсоемкие задачи Процессора и ввода-ВЫВОДА как фоновых задач.** Если запрос к службе предположительно займет много времени для запуска или может требуют значительных ресурсов, выгрузите обработку в отдельную задачу. Использование фоновых заданий для выполнения этих задач. Эта стратегия позволяет службе продолжать получать запросы и продолжает отвечать на запросы. Дополнительные сведения см. в [руководстве по фоновым заданиям](../best-practices/background-jobs.md).
- **Распространите рабочую нагрузку для фоновых задач.** При наличии многих фоновых задач или задачи, требуют значительного времени и ресурсов, распределяйте нагрузку среди нескольких вычислительных единиц. Одно из возможных решений — [шаблон конкурирующих потребителей](../patterns/competing-consumers.md).
- **Вы можете перейти к *неразделяемая* архитектуры.** Эта архитектура использует независимые, самостоятельные узлы, не имеющие единых точек конфликтов (например общих служб или хранилища). Теоретически такую систему можно масштабировать практически бесконечно. Несмотря на то, что обычно подход полностью неразделяемая нецелесообразно, он может предоставлять структурные возможности для повышения масштабируемости. Хорошими примерами перехода к неразделяемая архитектура включают секционирование данных и отказ от использования сходства сеансов на сервере состояния и клиента.
- **Создайте требования к хранилищу приложения, чтобы он попадал в целевые показатели масштабируемости и производительности службы хранилища Azure.** Хранилище Azure предназначено для работы в рамках предопределенные целевые показатели масштабируемости и производительности, поэтому Разрабатывайте приложение для использования хранилища в рамках этих показателей. При превышении этих целевых объектов, приложение будет отрегулировать хранилища. Чтобы избежать этого, подготовьте дополнительные учетные записи хранения. Если вам приходится сталкиваться ограничение учетной записи хранения, подготовьте дополнительные подписки Azure и затем подготовьте дополнительные учетные записи хранения существует. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/storage-scalability-targets/).
- **Выберите правильный размер виртуальной машины для своего приложения.** Измеряют фактическое ЦП, памяти, диска и ввода-вывода ваших виртуальных машин в рабочей среде и убедитесь, что выбранный вами размер виртуальной Машины достаточно. В противном случае ваше приложение может испытывать проблемы с пропускной способностью при достижении ограничений в виртуальных машинах. Размеры виртуальных машин подробно описываются в статье [Размеры виртуальных машин Windows в Azure](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

## <a name="determine-subscription-and-service-requirements"></a>Определение требований к подписке и службы

Выберите подходящую подписку и функции службы для вашего приложения при работе с этих задач:

- **Оценка требований к [подписки Azure и ограничения службы](/azure/azure-subscription-service-limits/).** *Подписки Azure* предусмотрены ограничения на определенные типы ресурсов, таких как количество групп ресурсов, ядер и учетные записи хранения. Если ваши требования к приложениям превышают лимиты подписки Azure, создайте еще одну подписку Azure и подготовьте в ней достаточное количество ресурсов. Отдельные службы Azure имеют ограничения на потребление, например ограничения на объем хранения, пропускную способность, количество подключений, запросы в секунду и другие показатели. Приложение не будет работать, если предпринимается попытка использовать ресурсы за пределами этих ограничений, приводит к службе регулирования и возможному простою для затронутых пользователей. В зависимости от конкретной службы и требований приложения, вы можете избежать этих ограничений, увеличив масштаб (например, выбора другого уровня цен) или масштабирование (например, добавление новых экземпляров).
- **Определите, сколько учетных записей хранения, вам потребуется.** Azure позволяет определенное количество учетных записей для подписки. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы](/azure/azure-subscription-service-limits/#storage-limits).
- **Выберите соответствующий уровень служб для базы данных Azure SQL.** Если приложение использует базу данных SQL Azure, выберите соответствующий уровень служб. Если уровень не может обрабатывать необходимых единиц (DTU) для транзакций базы данных приложения, использование данных будет регулироваться. Дополнительные сведения о выборе соответствующего плана служб см. в описании [уровней служб Базы данных SQL и возможностей, доступных на каждом уровне службы](/azure/sql-database/sql-database-service-tiers/).
- **Подготовка достаточного числа единиц запроса (ЕЗ) в Azure Cosmos DB**. При использовании Azure Cosmos DB вы платите на почасовой основе за пропускную способность, которую предоставляете, и за ресурсы хранения, которое вы потребляете. Стоимость всех операций базы данных нормализуется как единиц запроса, который абстрагирует системные ресурсы, такие как ЦП, операций ввода-ВЫВОДА и памяти. См. дополнительные сведения о [единицах запросов в базе данных Azure Cosmos DB](/azure/cosmos-db/request-units).

## <a name="load-balance-as-needed"></a>Балансировка нагрузки при необходимости

Правильное балансировки нагрузки позволяет выполнить требования к доступности и свести к минимуму затраты, связанные с доступностью.

- **Использовать балансировку нагрузки для распределения запросов.** Балансировка нагрузки приложения распределяет запросы между работоспособными экземплярами службы, удаляя неработоспособные экземпляры из ротации. Если служба использует службу приложений Azure или облачных служб Azure, он уже с балансировкой нагрузки для вас. Тем не менее если приложение использует виртуальные машины Azure, необходимо подготовить подсистему балансировки нагрузки. Дополнительные сведения см. в разделе [что такое Подсистема балансировки нагрузки Azure?](/azure/load-balancer/load-balancer-overview/)

  Azure Load Balancer можно использовать для следующих целей:

  - Балансировка нагрузки входящего Интернет-трафика к виртуальным машинам. Эта конфигурация называется [ *общедоступной подсистемы балансировки нагрузки*](/azure/load-balancer/load-balancer-overview#publicloadbalancer).
  - Балансировка нагрузки трафика между виртуальными машинами внутри виртуальной сети. Кроме того, можно подключиться к внешнему интерфейсу балансировщика нагрузки из локальной сети в гибридном сценарии. Оба сценария используйте конфигурацию, которая называется [ *внутренней подсистемы балансировки нагрузки*](/azure/load-balancer/load-balancer-overview#internalloadbalancer).
  - Перенаправление трафика к порту детализированные отдельных виртуальных машин с помощью правила входящих сетевых адресов (NAT).
  - Обеспечение [исходящего подключения](/azure/load-balancer/load-balancer-outbound-connections) для виртуальных машин в виртуальной сети путем использования общедоступной подсистемы балансировки нагрузки.

- **Балансируйте регионах с помощью диспетчера трафика, например диспетчер трафика Azure.** Для балансировки нагрузки трафика между регионами требуется решение по управлению трафиком и Azure предоставляет [диспетчера трафика](https://azure.microsoft.com/services/traffic-manager/). Можно также воспользоваться преимуществами услуги третьих лиц, которые предоставляют похожие возможности управления трафиком.

## <a name="implement-resiliency-strategies"></a>Реализация стратегий обеспечения отказоустойчивости

В этом разделе описаны некоторые распространенные стратегии устойчивости. Большинство из этих стратегий не ограничены определенной технологией. Описания суммировать общие идею каждой технологии и содержатся ссылки на дополнительные материалы.

- **Применяйте шаблоны отказоустойчивости** для удаленных операций, где уместно. Если ваше приложение зависит от связи между удаленными службами, выполните [шаблоны разработки](../patterns/category/resiliency.md) для устранения кратковременных сбоев.

- **Повторите временные сбои.** Это может быть вызвана кратковременной потерей подключения к сети, подключение к удаленной базе данных или истечения времени ожидания при служба занята. Часто временного сбоя можно разрешить путем повторения запроса.

  - Для многих служб Azure пакет средств разработки программного обеспечения клиента (SDK) реализует автоматические повторы способом, который является прозрачным для вызывающего объекта. См. в разделе [по повторным попыткам для определенных служб](../best-practices/retry-service-specific.md).
  - Или реализовать [шаблон повторных попыток](../patterns/retry.md) для приложения прозрачно обработки ожидаемых временных сбоев при попытке подключиться к службе или сетевому ресурсу.

- **Использование автоматического выключения** для обработки ошибок, может занять Разное количество времени, чтобы исправить. [Шаблон автоматического выключения](../patterns/circuit-breaker.md) можно запретить приложению несколько раз пытается операцию, которая, скорее всего, переход на другой. Прерыватель завершает вызовы службы и отслеживает количество последних сбоев. Если число сбоев превышает пороговое значение, прерыватель начинает возвращать код ошибки, не вызывая службу. Это дает время для восстановления службы и помогает избежать каскадных сбоев.
- **Изоляция критических ресурсов.** Сбои в одной подсистеме могут иногда иметь каскадный эффект, сбоям в других частях приложения. Это может произойти, если сбой запрещает ресурсы, такие как потоки или сокеты освобожден, что приводит к исчерпанию ресурсов. Чтобы избежать этого, можно разделить систему на изолированные группы, чтобы сбой в одном разделе не переводит работы всей системы.

    Ниже приведены некоторые примеры использования этой технологии, иногда называют [шаблон отсеков](../patterns/bulkhead.md):

  - Разделение базы данных (например, с клиента) и назначьте отдельный пул экземпляров веб-сервера для каждой секции.
  - Используйте отдельные пулы потоков для изоляции вызовов для разных служб. Это помогает предотвратить каскадные сбои, если одна из служб завершила работу с ошибкой. Например, см. в статье Netflix [библиотеке Hystrix](https://medium.com/netflix-techblog/introducing-hystrix-for-resiliency-engineering-13531c1ab362).
  - Используйте [контейнеры](https://en.wikipedia.org/wiki/Operating-system-level_virtualization) для ограничения ресурсов, доступных для конкретной подсистемы.

      ![Схема шаблона отсеков](_images/bulkhead.png)

- **Применить [ *компенсирующие транзакции*](../patterns/compensating-transaction.md)**. Компенсирующая транзакции — это транзакция, которая отменяет эффект другой завершенной транзакции. В распределенной системе может быть сложно добиться сильной согласованности транзакций. Компенсирующие транзакции помогают достижения согласованности, используя ряд небольших отдельных транзакций, которые можно отменить на каждом этапе. Например, чтобы забронировать поездку, клиент может зарезервировать автомобиль, гостиничный номер и билет на самолет. При сбое одного из этих шагов происходит сбой всей операции. Вместо того чтобы использовать одну распределенную транзакцию для всей операции, вы можете определить компенсирующую транзакцию для каждого шага.
- **Реализации асинхронных операций, когда это возможно.** Синхронные операции могут монополизировать ресурсы и блокировать другие операции, пока вызывающий объект ждет завершения процесса. Проектируйте каждую часть приложения для разрешения для асинхронных операций, когда это возможно. Дополнительные сведения о том, как реализовать асинхронное программирование на языке C\#, см. в разделе [асинхронное программирование](/dotnet/articles/csharp/async).

## <a name="ensure-that-availability-meets-slas"></a>Обеспечение доступности соответствия требованиям соглашения об уровне обслуживания

*Доступность* — это доля времени, для которого система функционирует и работает, и он является одним из [основных аспектов качества программного обеспечения](../guide/pillars.md). Используйте задачи в этом разделе, чтобы проверить архитектуру приложения с точки зрения доступности, чтобы убедиться в том, что доступность соответствует требованиям вашего соглашения об уровне обслуживания.

- **Избегайте единых точек отказа.**  Все компоненты, службы, ресурсы и вычислительные сущности должны развертываться в нескольких экземплярах, чтобы предотвратить влияние на доступность единой точки отказа. Механизмы проверки подлинности также может быть единой точкой отказа. Проектируйте приложения, можно настроить для использования нескольких экземпляров и для автоматического обнаружения сбоев и перенаправления запросов в исправные экземпляры, если платформа не делает это автоматически.
- **Разделяйте рабочие нагрузки в зависимости от задач уровня службы.** Если служба состоит из критически важных и менее важных рабочих нагрузок, управляйте ими по-разному и укажите функции службы и число экземпляров в соответствии с их требованиями доступности.
- **Сводите к минимуму и понимайте зависимости службы.** Свести к минимуму количество различных служб, используемых, где это возможно. Убедитесь, что вы понимаете все функции и зависимости службы, которые существуют в системе. В частности понимаете общее влияние сбоя или снижение производительности в каждой зависимости.
- **Проектируйте задачи и сообщения, чтобы быть *идемпотентными*, где это возможно.** Если операция может повторяться несколько раз и дает одинаковый результат, она является идемпотентной. Это гарантирует, что повторяющиеся запросы не создадут проблем. Объекты-получатели сообщений и операции, которые они выполняют, должны быть идемпотентными, чтобы повторение ранее выполненных операций не приводило к недопустимым результатам. Это может означать обнаружение повторяющихся сообщений или обеспечение согласованности с помощью оптимистичной методики обработки конфликтов.
- **Настройте время ожидания запросов.** Службы и ресурсы могут стать недоступными, что приводит к сбою запросов. Убедитесь, что время ожидания, которые можно применить подходят для каждой службы или ресурса, и для клиента, к ним обращается. В некоторых случаях можно увеличить время ожидания для конкретного экземпляра клиента в зависимости от контекста и других действий, выполняемых клиентом. Короткое время ожидания может привести к чрезмерному повторению операций для службы и ресурсы, которые имеют значительные задержки. Длинное время ожидания может привести к блокировке, если большое количество запросов помещаются в очередь, для службы или ресурсов для ответа.
- **Используйте брокер сообщений, реализующий высокий уровень доступности, для важных транзакций.** Во многих облачных приложениях используется обмен сообщениями для запуска асинхронных задач. Чтобы гарантировать доставку сообщений, системе обмена сообщениями следует обеспечивать высокий уровень доступности. [Обмена сообщениями служебной шины Azure](/azure/service-bus-messaging) реализует *по крайней мере один раз* семантику, что означает, что сообщение гарантированно доставляются по крайней мере один раз. При определенных обстоятельствах может доставляться повторяющихся сообщений. Если обработка сообщений идемпотентна (см. предыдущий пункт), то повторная доставка не должна стать проблемой.
- **Регулирование пользователей большого объема.** Иногда небольшое количество пользователей создает чрезмерную нагрузку. Это может негативно сказаться на других пользователей и может снизить общую доступность приложения. Когда один клиент делает чрезмерное количество запросов, приложение может регулировать клиент в течение определенного периода. В период регулирования приложение отклоняет некоторые или все запросы от этого клиента. Пороговое значение регулирования часто зависит от уровня обслуживания клиента. Дополнительные сведения см. в разделе [шаблон регулирования](../patterns/throttling.md).

    Регулирование не означает, что клиент действовал злонамеренно &mdash; только что он превысил свою квоту службы. В некоторых случаях потребитель может последовательно превышать свою квоту. В противном случае его поведение ухудшается. В этом случае вы можете пойти дальше и заблокировать пользователя. Как правило, для этого блокируется API-ключ или диапазон IP-адресов.
- **Проектируйте приложения так, чтобы производительность понижалась корректно.** Нагрузка на приложение может превышать возможности одной или нескольких частей, вызывая ограничение доступности и сбои подключений. Масштабирование можно смягчить последствия этой проблемы, но оно может достичь предела, обусловленного другими факторами, например доступность ресурсов или затраты. Когда приложение достигает лимита ресурсов, ему необходимо выполнить соответствующие действия, чтобы свести к минимуму влияние на пользователя. Например в системе электронной коммерции, если подсистема обработки заказов испытывает нагрузку или завершается с ошибкой, его можно временно отключить другие функциональные возможности, такие как просмотр каталога продуктов. Может использоваться отложить запросы к неисправной подсистеме &mdash; к примеру, по-прежнему позволяя клиентам размещать заказы, но сохраняют их для последующей обработки, когда подсистема заказов снова станет доступным.
- **Корректно обрабатывайте внезапные всплески активности.** Большинству приложений с течением времени необходимо обрабатывать меняющиеся рабочие нагрузки. Автоматическое масштабирование позволяет справиться с нагрузкой, но может занять некоторое время для дополнительных экземпляров сети и обработке запросов. Чтобы предотвратить перегрузку приложения всплески активности, сконструировать его так, чтобы очередь запросов к службам, которые она использует и корректно снижать производительность, когда очереди являются практически всю емкость. Убедитесь, что имеется достаточно производительности и мощности в условиях без разбивки, чтобы опустошить очереди и обработать необработанные запросы. Дополнительные сведения см. в статье [Шаблон балансировки нагрузки на основе очередей](../patterns/queue-based-load-leveling.md).
- **Создать или восстановить размещение нескольких компонентов.** Проектирование приложений для использования нескольких экземпляров, не влияя на операции и существующие подключения, где это возможно. Чтобы добиться максимальной доступности, используется несколько экземпляров и распределения запросов между ними и обнаружить и избежать, отправляя запросы к неисправных экземпляров.
- **Происходит переключение на другой службе или рабочего процесса.** Например в случае сбоя записи в базу данных SQL временно сохраняйте данные в хранилище BLOB-объектов или кэш Redis. Предоставьте способ воспроизведения записей в базу данных SQL, когда служба станет доступной. В некоторых случаях сбоя операции могут иметь альтернативное действие, которое позволяет приложению продолжать работать, даже при сбое компонента или службы. Если это возможно обнаружение сбоев и перенаправления запросов к другим службам, пока основная служба находится в автономном режиме.
- **Использование выравнивания нагрузки, чтобы сгладить пиковые скачки трафика.** Приложения могут испытывать внезапные всплески трафика, который может вызывать переполнение службы в серверной части. Если внутренняя служба не может достаточно быстро отвечать на запросы, ожидающие запросы накапливаются, или служба может регулировать количество запросов приложения. Чтобы избежать этого, можно использовать очередь как буфер. При наличии нового рабочего элемента, вместо того чтобы вызывать серверную службу немедленно, приложение ставит в очередь рабочий элемент для асинхронного выполнения. Очередь работает как буфер, который сглаживает высокие пики нагрузки. Дополнительные сведения см. в разделе [шаблон балансировки нагрузки на основе очереди](../patterns/queue-based-load-leveling.md).

## <a name="manage-your-data"></a>Управляйте своими данными

Как управлять данных играет непосредственно в доступности приложения. Задачи в этом разделе помогут вам создать план управления для повышения уровня доступности.

- **Репликация данных и изучите методы репликации для хранилищ данных вашего приложения.** Репликация данных является общей стратегией для обработки постоянных ошибок в хранилище данных. Рассмотрите возможность чтения и записи путей. В зависимости от технологии хранения возможно, несколько записываемых реплик или может содержать одну реплику для записи и несколько реплик только для чтения. Чтобы добиться максимальной доступности, реплики можно разместить в разных регионах. Тем не менее этот подход приводит к увеличению задержки при репликации данных. Как правило, репликация между регионами выполняется асинхронно, что подразумевает модель итоговой согласованности и возможную потерю данных в случае сбоя реплики.  

  Можно использовать [Azure Site Recovery](/azure/site-recovery/azure-to-azure-quickstart/) для репликации виртуальных машин Azure из одного региона в другой. Site Recovery непрерывно реплицирует данные в целевой регион. При возникновении сбоев в основном сайте, отработка отказа в дополнительное расположение.

- **Убедитесь, что ни одна учетная запись пользователя не имеет доступа к рабочим и резервным данным.** Резервные копии данных будут скомпрометированы, если одна учетная запись пользователя имеет разрешение на запись как в источники рабочих данных разработки, так и в источники резервных копий. Пользователь-злоумышленник может намеренно удалить все данные и обычный пользователь может случайно удалить его. Реализуйте в приложении, чтобы ограничить разрешения каждой учетной записи пользователя. Только предоставить доступ на запись для пользователей, которым он необходим и предоставить доступ к рабочей среде или резервной копии, но не оба.
- **Документируйте и протестируйте процесс отработки отказа и восстановления размещения хранилища данных.** Хранилище данных документированных в случае сбоя человека, должны соответствовать набору инструкций для отработки отказа в новое хранилище данных. Если в задокументированных шагах есть ошибки, оператор невозможно пройти успешно и отработка отказа ресурса. Регулярно проверяйте шаги инструкции, чтобы убедитесь, что оператор, который следует за документации можно успешно выполнить отработку отказа и восстановление размещения.
- **Резервное копирование данных и проверка данных резервных копий.** Регулярно запускать сценарий для проверки целостности данных, схемы и запросы для обеспечения резервного копирования данных соответствует ожиданиям. Регистрируйте и сообщайте о любых несоответствиях, чтобы можно было устранить неисправность службы восстановления.
- **Используйте периодическое резервное копирование и восстановление в определенный момент времени.** Автоматически и регулярно создавайте резервные копии данных, которые не сохраняются в другом месте. Убедитесь, что можете гарантированно восстановить данные и само приложение в случае сбоя. Убедитесь, что резервные копии соответствуют RPO. Репликация данных не функция резервного копирования, из-за ошибки пользователя или вредоносные операции могут повредить данные во всех репликах. Процесс резервного копирования должен быть безопасным, чтобы обеспечить защиту данных во время передачи и хранения. Базы данных можно провести до предыдущей точки во времени с помощью журналов транзакций. Дополнительные сведения см. в разделе [восстановление данных после повреждения или случайного удаления](../resiliency/recovery-data-corruption.md).
- **Рассмотрите возможность использования учетной записи геоизбыточного хранилища.** Данные, хранящиеся в учетной записи хранения Azure, всегда реплицируются локально. Тем не менее существует несколько стратегий репликации, можно выбрать при подготовке учетной записи хранения. Чтобы защитить данные приложения в тех редких случаях, когда весь регион становится недоступным, выберите [Геоизбыточного хранилища Azure доступ на чтение (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage).  

    > [!NOTE]
    > Для виртуальных машин не следует полагаться на репликацию RA-GRS для восстановления дисков виртуальных машин (файлы VHD). Вместо этого используйте [Azure Backup](/azure/backup).

- **Рассмотрите возможность развертывания ссылочных данных в нескольких регионах.** Ссылочные данные — это данные только для чтения, которые поддерживают функциональные возможности приложения. Он обычно редко изменяются. Несмотря на то, что восстановление из резервной копии — один из способов обработки нарушения работы служб во всем регионе, RTO при этом относительно велико. При развертывании приложения в дополнительном регионе можно применить несколько стратегий, которые позволяют добиться малого целевого времени восстановления для ссылочных данных.

    Поскольку ссылочные данные изменяются редко, можно улучшить RTO за счет постоянной копии в дополнительном регионе. Это исключает время, необходимое для восстановления резервных копий после аварии. В соответствии с требованиями к аварийному восстановлению после сбоев в нескольких регионах необходимо развернуть приложение и ссылочные данные одновременно во всех них.

- **Используйте оптимистичный параллелизм и итоговую согласованность.** Транзакции этого блока, получить доступ к ресурсам через блокировки (*пессимистичный параллелизм*) может привести к снижению производительности и снижения доступности. Эти проблемы могут стать особенно ощутимыми в распределенных системах. Во многих случаях тщательное проектирование и методы, такие как секционирование, можно свести к минимуму вероятность конфликта обновлений. Если данные реплицируются или считываются из отдельно обновляемого хранилища, данных будет только согласованных в конечном счете. Но преимущества обычно перевешивают влияние на доступность для обеспечения мгновенной согласованности транзакций.
- **Использование активной георепликации для базы данных SQL для репликации изменений в базу данных-получатель.** Активная георепликация для базы данных SQL автоматически реплицирует изменения базы данных для базы данных-получатели в том же регионе или в другом регионе. Дополнительные сведения см. в разделе [Создание и использование активной георепликации](/azure/sql-database/sql-database-active-geo-replication).

  Кроме того, можно принять более ручной метод, с помощью **КОПИЮ базы данных** команду, чтобы создать резервную копию базы данных с соблюдением транзакционной согласованности. Также вы можете использовать службу импорта и экспорта базы данных SQL Azure, которая поддерживает экспорт базы данных в BACPAC-файлы (содержат схему базы данных и соответствующие данные в сжатом виде), которые расположены в хранилище больших двоичных объектов Azure. Служба хранилища Azure создает две реплики файла резервной копии в одном регионе. Тем не менее частоты архивации зависит RPO, это объем данных, которые можно потерять при сбое. Например если резервную копию данных каждый час, а сбой происходит за две минуты до резервного копирования, вы потеряете данные за 58 минут. Кроме того, чтобы обеспечить защиту на случай нарушения работы службы на уровне региона, необходимо скопировать файлы BACPAC в другой регион. Дополнительные сведения см. в разделе [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](/azure/sql-database/sql-database-business-continuity).

- **Используйте геоархивов для хранилища данных SQL.** В Хранилище данных SQL применяется [геоизбыточное резервное копирование](/azure/sql-data-warehouse/backup-and-restore), которое позволяет использовать связанный регион для аварийного восстановления. Эти резервные копии создаются каждые 24 часа и можно было восстановить в течение 20 минут в парном регионе. Эта функция включена по умолчанию для всех экземпляров в хранилище данных SQL. Дополнительные сведения о том, как восстановить хранилище данных см. в разделе [восстановление из географического региона Azure с помощью PowerShell.](/azure/sql-data-warehouse/sql-data-warehouse-restore)

- **Репликация дисков виртуальных машин с помощью Azure Site Recovery** При репликации виртуальных машин Azure с помощью [Site Recovery](/azure/site-recovery/), все диски виртуальной Машины постоянно реплицируются асинхронно к целевой области. Точки восстановления создаются каждые несколько минут. Это дает целевой точки восстановления от нескольких минут.
- **Резервное копирование SQL Server на виртуальных машинах или настроить сеанс доставки журналов.** Для SQL Server, выполняющегося на виртуальных машинах, существует два варианта резервного копирования: традиционные резервные копии и доставка журналов. Традиционные резервные копии позволяют восстановить до определенной точки во времени, но процесс восстановления выполняется медленно. Восстановление традиционных резервных копий необходимо начать с первоначальной полной резервной копии и затем применить все резервные копии после этого. Второй вариант — настроить сеанс доставки журналов для задержки восстановления резервных копий журналов (например, на два часа). Так вы получите временной зазор для восстановления после ошибок, возникших в базе данных-источнике.
- **Используйте пользовательский процесс или стороннего инструмента — для резервного копирования хранилища Azure.** Для службы хранилища Azure можно разработать пользовательский процесс резервного копирования или использовать сторонние средства резервного копирования. Большинство приложений возникают дополнительные сложности, в какое хранилище ресурсов ссылаются друг на друга. Например рассмотрим базу данных SQL со столбцом, ссылающийся на большой двоичный объект в службе хранилища Azure. Если резервное копирование не выполняется для всех элементов одновременно, в базе данных может сохраниться указатель на большой двоичный объект, для которого не существует резервной копии. Приложение или план аварийного восстановления должны реализовать процессы для обработки этой несогласованности после восстановления.
- **Для других платформ данных, размещенных на виртуальных машинах с помощью собственного репликации или возможность создавать моментальные снимки.** Другие платформы данных, например Elasticsearch или MongoDB, имеют свои собственные возможности и соображения при создании интегрированное резервное копирование и восстановление процесса. Для этих платформ мы рекомендуем использовать либо собственные или доступных основанных на интеграции репликация или возможность создавать моментальные снимки. Если эти возможности не существует или не подходит, рассмотрите возможность использования службы архивации Azure или дисков моментальных снимков для создания копии данных приложения в определенный момент времени. В любом случае очень важно определить, как обеспечить согласованность резервных копий, в том случае, особенно в том случае, если данные приложения охватывает несколькими файловыми системами или несколько дисков объединяются в одну файловую систему.
- **Изучите методы репликации источников данных приложения.** Данные приложения будут храниться в разных источниках данных и будет имеют различные требования к доступности. Проанализируйте методы репликации для каждого типа хранилища данных в Azure, включая [избыточности службы хранилища Azure](/azure/storage/storage-redundancy/) и [базы данных SQL активная георепликация](/azure/sql-database/sql-database-geo-replication-overview/) чтобы убедиться, что приложения данных выполнены требования. При репликации виртуальных машин Azure с помощью [Site Recovery](/azure/site-recovery/), все диски виртуальной Машины постоянно реплицируются асинхронно к целевой области. Точки восстановления создаются каждые несколько минут.
- **Установите стратегиях аварийного восстановления данных.** Правильная обработка данных — это очень сложный любого плана аварийного восстановления. Обычно именно восстановление данных занимает больше всего времени при восстановлении после аварии. Доступны разные варианты поддержки ограниченной функциональности возникают трудности восстановления данных и согласованность.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Тестирования устойчивости и доступности](./testing.md)
