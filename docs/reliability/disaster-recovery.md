---
title: Сбой и аварийное восстановление для приложений Azure
description: Приближается к Обзор аварийного восстановления в Azure
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: f00341b06b8092c798d6260317226190cbace66b
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646652"
---
# <a name="failure-and-disaster-recovery-for-azure-applications"></a>Сбой и аварийное восстановление для приложений Azure

*Аварийное восстановление* — это процесс восстановления функциональности приложения в пробуждение существенной потери.

Касающимися устойчивости ограниченной функциональности во время аварии является бизнес-решения, отличное от одного приложения к другому. Он может быть приемлемым для некоторых приложений недоступен полностью или частично доступен в режиме ограниченной функциональности или задержка при обработке в течение заданного времени. Любой ограниченной функциональности неприемлем для других приложений.

## <a name="disaster-recovery-plan"></a>План аварийного восстановления

Начните с создания плана восстановления. План считается завершенной после он полностью протестирован. Включать сотрудников, процессов и приложений, необходимых для восстановления функциональности в соглашение уровня обслуживания (SLA), вы определили для своих клиентов.

Примите во внимание следующие рекомендации при создании и тестировании плана аварийного восстановления.

- В плане включите процесс обращения в службу поддержки и эскалацию проблем. Эта информация поможет избежать длительного простоя во время работы процесса восстановления в первый раз.
- Оцените влияние сбоев приложения на бизнес.
- Выберите архитектуру между регионами восстановления для критически важных приложений.
- Назначьте ответственного за реализацию плана аварийного восстановления, включая его автоматизацию и тестирование.
- Документирование процесса, особенно какие-то действия.
- Автоматизируйте процесс настолько, насколько возможно.
- Стратегии резервного копирования для всех ссылочных и транзакционных данных и восстановления резервных копий теста регулярно.
- Настройка оповещений для стека службы Azure, используемые вашим приложением.
- Обучите линейных сотрудников для выполнения плана.
- Моделирование аварийного регулярные проверить и улучшить план.

Если вы используете [Azure Site Recovery](/azure/site-recovery/) для репликации виртуальных машин (ВМ), создать план полностью автоматического восстановления для отработки отказа всего приложения.

## <a name="manual-responses"></a>Вручную ответов

Несмотря на то, что идеально подходит автоматизации, некоторые стратегии для аварийного восстановления требуется вручную ответов.

### <a name="alerts"></a>Оповещения

Отслеживайте приложение на предмет предупреждающих знаков, которые могут потребовать активного вмешательства. Например если база данных SQL Azure или Azure Cosmos DB постоянно регулирует ваше приложение, может потребоваться увеличить емкость базы данных или оптимизировать запросы. Несмотря на то, что приложение может обрабатывать ошибки регулирования прозрачно, данные телеметрии по-прежнему должны вызывать оповещение, чтобы вы могли предпринять ответные.

Ограничения службы и пороговые значения квот рекомендуется настроить оповещения на ресурсы Azure метрики и журналы диагностики. По возможности настройте оповещения для метрик, которые являются более низкую задержку, чем журналы диагностики.

Через [работоспособности ресурсов](/azure/service-health/resource-health-checks-resource-types), Azure предоставляет некоторые встроенные работоспособности проверки состояния, которые могут помочь при диагностике проблем регулирования службы Azure.

### <a name="failover"></a>Отработка отказа

Настройте стратегии аварийного восстановления для каждого приложения Azure и службами Azure. Рекомендации по развертыванию приемлемым для поддержки аварийного восстановления зависят от соглашения об уровне обслуживания, необходимые для всех компонентов каждого приложения.  

Azure предоставляет различные возможности в пределах многих служб Azure, чтобы разрешить на другой ресурс вручную, таких как [geo реплики кэша radis](/azure/azure-cache-for-redis/cache-how-to-geo-replication), или для автоматической отработки отказа, такие как [группы автоматической отработки отказа SQL](/azure/sql-database/sql-database-auto-failover-group). Например: 

- Для приложения, главным образом используются виртуальные машины можно использовать Azure Site Recovery для уровней web и логики. Дополнительные сведения см. в разделе [архитектуры в Azure аварийного восстановления](/azure/site-recovery/azure-to-azure-architecture). Для SQL Server на виртуальных машинах, использовать [группы обеспечения доступности SQL Server Always On](/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-dr).
- Для приложения, использующего службы приложений и базы данных SQL Azure можно использовать план службы приложений меньшего размера уровня, настроенный в дополнительном регионе, который автоматически масштабируется при отработке отказа. Используйте группы отработки отказа на уровне базы данных.

В любом случае [диспетчера трафика Azure](/azure/traffic-manager/traffic-manager-overview) профиль предоставляет для автоматической отработки отказа между регионами. [Подсистемы балансировки нагрузки](/azure/load-balancer/load-balancer-overview) или [шлюзы приложений](/azure/application-gateway/overview) следует настроить в дополнительном регионе для обеспечения доступности быстрее при отработке отказа.

### <a name="operational-readiness-testing"></a>Тестирование готовности к эксплуатации

Выполните тест готовности к отработке отказа в дополнительный регион, а также для восстановления размещения в основном регионе. Многие службы Azure поддерживают отработку отказа вручную или тестовую отработку отказа для аварийного восстановления. Кроме того можно имитировать сбой, завершение работы или удалив служб Azure.

## <a name="application-failure"></a>Сбой приложения

Сбои приложений являются восстанавливаемых или неустранимая. Этого можно избежать устранимая ошибка, но Неустранимая ошибки приводят к сбою приложения.

- Некоторые сбои могут направляться прозрачно автоматически обработка ошибок и применения альтернативных мер. Например диспетчер трафика автоматически обрабатывает сбои, возникающие в результате базовом программном обеспечении оборудования или операционной системы на виртуальной машине узла.
- С ошибками приложение может продолжить обработку запросов в режиме ограниченной функциональности.
- Более серьезные сбои в работе служб могут визуализации приложения недоступен.

Хорошо спроектированная система разделяет задачи на уровне службы &mdash; во время разработки и во время выполнения. Такое разделение предотвращает нарушения работы службы, зависимые от работы всего приложения. Например рассмотрим веб-приложения электронной коммерции с помощью следующих модулей:

![ДОБАВЛЕНИЕ ССЫЛКИ НА ИСКУССТВО](./_images/disaster-recovery.png)

Если в базе данных для размещения заказов выходит из строя, служба обработки заказов не может обработать о проводках по продажам. В зависимости от архитектуры может оказаться невозможным для служб приема и обработки заказов продолжить. Тем не менее если продуктов данные хранятся в другом месте, каталога продуктов доступен, несмотря на то, что другие части приложения могут быть недоступны.

Именно вы сможете легко определить, как приложение будет информировать пользователей о временных проблемах и соответствующие уведомления в систему сборки. В предыдущем примере приложение может разрешить для просмотра продуктов, а также для добавления их в корзину для покупок. Тем не менее когда клиент пытается совершить покупку, приложение должно уведомить их обработка заказов временно недоступна. Хотя это не идеальное решение для клиента, этот подход позволяет избежать перебоев в работе служб на уровне приложения.

## <a name="data-corruption-and-restoration"></a>Повреждение данных и восстановления

В случае сбоя в хранилище данных может существовать несогласованности данных, когда она снова станет доступным, особенно в том случае, если они были реплицированы. Основные сведения о времени восстановления (RTO) и точки восстановления (RPO) цель хранилищ данных, реплицированной может помочь можно прогнозировать объем потери данных.

Чтобы понять, запущена ли отработка отказа между регионами вручную или корпорацией Майкрософт, просмотрите соглашений об уровне обслуживания Azure. Для служб с нет соглашения об уровне обслуживания для отработки отказа между регионами Корпорация Майкрософт обычно решает, когда для отработки отказа и обычно устанавливает приоритеты для восстановления данных в основном регионе. Если данные в основном регионе считается неустранимой, Майкрософт выполняет отработку отказа в дополнительный регион.

### <a name="restoring-data-from-backups"></a>Восстановление данных из резервных копий

Резервные копии защиты от потери в состав приложения из-за случайного удаления или повреждения данных. Они сохраняют более функциональной версии компонента из более раннее время, которое служит для его восстановления.

Стратегии аварийного восстановления не являются заменой для резервных копий, но регулярно создавайте резервные копии данных приложения поддерживает некоторые сценарии аварийного восстановления. Выбор хранилища резервных копий должно быть основано на своей стратегии аварийного восстановления.

Частота архивации зависит RPO. Например если вы ежечасно выполняете резервное копирование, а сбой происходит за две минуты до резервного копирования, вы потеряете данные за 58 минут. План аварийного восстановления должен включать как вы будете решать потерянные данные.

Довольно часто для данных в одном хранилище данных для ссылочных данных в другое хранилище. Например рассмотрим базу данных SQL со столбцом, ссылающийся на большой двоичный объект в службе хранилища Azure. Если резервное копирование не осуществляется одновременно, база данных может содержать указатель на большой двоичный объект, не были архивированы до сбоя. Приложение или план аварийного восстановления должны реализовать процессы для обработки этой несогласованности после восстановления.

> [!NOTE]
> В некоторых сценариях, например, виртуальных машин, резервное копирование с использованием [резервного копирования Azure](/azure/backup/backup-azure-vms-first-look-arm), можно восстановить только из резервной копии в одном регионе. Службы Azure, такие как [Azure кэша для Redis](/azure/azure-cache-for-redis/cache-how-to-geo-replication), предоставляют геореплицированных резервных копий, в которые можно использовать для восстановления службы в регионах.

### <a name="azure-storage-and-azure-sql-database"></a>База данных SQL хранилища Azure и Azure

Azure автоматически сохраняет данные хранилища Azure и базы данных SQL три раза в различных доменах сбоя в одном регионе. При использовании георепликации создаются еще три экземпляра данных в другом регионе. Тем не менее если данные повреждена или удалена в первичной копии (например, из-за ошибки пользователя), в другие копии репликацию изменений.

У вас есть два варианта управления возможным повреждением данных или удаления:

- **Создайте пользовательскую стратегию архивации.** Можно хранить резервные копии в Azure или локально, в зависимости от бизнес-требований и нормативных.
- **Использовать параметр восстановления на определенный момент** восстановление базы данных SQL.

#### <a name="azure-storage-recovery"></a>Восстановление хранилища Azure

Можно разработать пользовательский процесс резервного копирования для службы хранилища Azure или использовать один из множества средств архивации сторонних.

Служба хранилища Azure обеспечивает устойчивость данных благодаря автоматическим репликам, но он не предотвращает коду приложения и пользователям повредить данные. Обслуживание точность данных после ошибки приложения или пользователя требуются более сложные приемы, например копирование данных в расположении дополнительного хранилища и ведение журнала аудита. Доступно несколько параметров.

- [**Блочные BLOB-объекты.**](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) Создайте моментальный снимок на определенный момент каждого блочного BLOB-объекта. Для каждого моментального снимка плата только за хранилище, необходимое для хранения различий в большой двоичный объект с момента предыдущего состояния моментального снимка. Моментальные снимки зависят исходного большого двоичного объекта, поэтому мы рекомендуем копировать на другой большой двоичный объект или даже на другую учетную запись хранения. Такой подход обеспечивает защиту данных резервных копий от случайного удаления. Используйте [AzCopy](/azure/storage/common/storage-use-azcopy) или [Azure PowerShell](/azure/storage/common/storage-powershell-guide-full) для копирования больших двоичных объектов в другую учетную запись хранения.

    Дополнительные сведения см. в статье [Создание моментального снимка большого двоичного объекта](/rest/api/storageservices/creating-a-snapshot-of-a-blob).

- [**Служба файлов Azure.**](/azure/storage/files/storage-files-introduction) Используйте [моментальные снимки общих ресурсов](/azure/storage/files/storage-snapshots-files), AzCopy или PowerShell для копирования файлов в другую учетную запись хранения.
- [**Хранилище таблиц Azure.**](/azure/storage/tables/table-storage-overview) Используйте AzCopy для экспорта данных таблиц в другую учетную запись хранения, относящуюся к другому региону.

#### <a name="sql-database-recovery"></a>Восстановление базы данных SQL

Для защиты вашей компании от потери данных, базы данных SQL автоматически создает полные резервные копии каждую неделю, разностные резервные копии каждый час и журнала транзакций резервное копирование каждые 5 до 10 минут. Для уровней Basic, Standard и Premium базы данных SQL используйте в определенный момент времени восстановления для восстановления базы данных в более раннее время. Дополнительные сведения см. в этих статьях:

- [Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий](/azure/sql-database/sql-database-recovery-using-backups)
- [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](/azure/sql-database/sql-database-business-continuity)

Другой вариант — использовать активную георепликацию для базы данных SQL, которая автоматически реплицирует изменения базы данных для базы данных-получатели в том же или другом регионе Azure. Дополнительные сведения см. в разделе [Создание и использование активной георепликации](/azure/sql-database/sql-database-active-geo-replication).

Можно также использовать более ручной метод для резервного копирования и восстановления:

- Используйте **КОПИЮ базы данных** команду, чтобы создать резервную копию базы данных с соблюдением транзакционной согласованности.
- Используйте Azure SQL Database импорта и экспорта Service, которая поддерживает экспорт базы данных в файлы BACPAC (сжатые файлы, содержащие схему базы данных и связанные данные), которые хранятся в хранилище BLOB-объектов Azure. Чтобы избежать нарушения работы службы на уровне региона, скопируйте файлы BACPAC в альтернативный регион.

### <a name="sql-server-on-vms"></a>SQL Server на виртуальных машинах

Для SQL Server на виртуальных машинах, у вас есть два варианта: традиционные резервные копии и доставка журналов.

- С помощью традиционных резервных копий можно восстановить до определенной точки во времени, но процесс восстановления выполняется медленно. Восстановление традиционных резервных копий необходимо начать с первоначальной полной резервной копии и затем применить все добавочные резервные копии.
- Вы можете настроить сеанса доставки журналов для задержки восстановления резервных копий журналов. Это предоставляет окно для восстановления после ошибок в первичной реплике.

### <a name="azure-database-for-mysql-and-azure-database-for-postgresql"></a>База данных Azure для MySQL и база данных Azure для PostgreSQL

В базе данных Azure для MySQL и база данных Azure для PostgreSQL службу базы данных автоматически создает резервную копию каждые пять минут. Эти автоматические резервные копии можно использовать для восстановления сервера и его базы данных на более ранний момент времени на новом сервере. Дополнительные сведения можно найти в разделе 

- [Как выполнить резервное копирование и восстановление сервера в базе данных Azure для MySQL с помощью портала Azure](/azure/mysql/howto-restore-server-portal)
- [Резервное копирование и восстановление сервера в базе данных Azure для PostgreSQL с помощью портала Azure](/azure/postgresql/howto-restore-server-portal)

### <a name="azure-cosmos-db"></a>Azure Cosmos DB

Cosmos DB автоматически создает резервную копию с регулярными интервалами. Резервные копии хранятся отдельно в другой службе хранилища и глобально реплицируются для защиты от региональных сбоев. Если вы случайно удалите данные или коллекцию, можете обратиться с запросом в службу поддержки или позвонить в службу поддержки Azure, чтобы восстановить данные из последней автоматически созданной резервной копии. Дополнительные сведения см. в разделе [оперативная архивация и восстановление по запросу в Azure Cosmos DB](/azure/cosmos-db/online-backup-and-restore).

### <a name="azure-virtual-machines"></a>Виртуальные машины Azure

Для защиты виртуальных машин Azure от ошибок приложений и случайного удаления используйте [Azure Backup](/azure/backup/). Созданные резервные копии являются согласованными на нескольких дисках виртуальной Машины. Кроме того хранилище службы архивации Azure можно реплицировать между регионами для поддержки восстановления после потери региональных.

## <a name="network-outage"></a>Сбой сети

Если части сети Azure недоступны, может не появиться возможность доступа к данным или приложению. В этом случае мы рекомендуем, Разработка стратегии аварийного восстановления для выполнения большинства приложений в режиме ограниченной функциональности.

Если ограничения функциональности невозможно, остается только простой приложения или отработки отказа в другой регион.

В сценарии ограниченной функциональности:

- Если приложение не может получить доступ к его данные из-за сбоя сети Azure, можно запустить локально с ограниченной функциональностью, используя кэшированные данные.
- Возможно, вы сможете хранить данные в альтернативное расположение до восстановления подключения.

## <a name="dependent-service-failure"></a>Сбой зависимых служб

Для каждой зависимой службы необходимо понимать последствия нарушения работы службы и то, что приложение будет отвечать. Многие службы предоставляют возможности, которые поддерживают устойчивости и доступности, поэтому оценки каждой службы независимо друг от друга вероятнее всего улучшить свой план аварийного восстановления. Например, концентраторы событий Azure поддерживают [отработка отказа](/azure/event-hubs/event-hubs-geo-dr#setup-and-failover-flow) на дополнительное пространство.

## <a name="region-wide-service-disruptions"></a>Нарушения работы служб во всем регионе

Многие сбои являются управляемыми в одном регионе Azure. Тем не менее в маловероятном случае сбоя службы во всем регионе, локальные избыточные копии данных недоступны. Если вы включили функцию георепликации, существует три дополнительные копии больших двоичных объектов и таблиц в другом регионе. Если Майкрософт объявляет регионом утеряна, Azure перераспределяет все записи DNS в дополнительный регион.

> [!NOTE]
> Этот процесс происходит только для нарушения работы служб во всем регионе, но в элементе управления. Рекомендуем использовать [Azure Site Recovery](/azure/site-recovery/) для улучшения показателей RPO и RTO. С помощью Site Recovery, вы решили, что сбой является допустимым и в момент перехода на реплицированные виртуальные машины.

Ответ на уровне региона перерывов в обслуживании зависит от вашего развертывания и план аварийного восстановления.

- Как стратегию управления затратами для некритических приложений, которые не требуют гарантированного времени восстановления может быть целесообразно выполнить повторное развертывание в другом регионе.
- Для приложений, размещенных в другом регионе с помощью ролей развернутого, но не распределения трафика по регионам (*активное или пассивное развертывание*), переключитесь в вторичная размещенная служба в альтернативном регионе.
- Для приложений, у полномасштабной дополнительной развернутой службы в другом регионе (*активное/активное развертывание*), маршрутизация трафика в этом регионе.

Дополнительные сведения о восстановлении после прерывания работы служб во всем регионе, см. в разделе [восстановление после прерывания работы служб во всем регионе](../resiliency/recovery-loss-azure-region.md).

### <a name="vm-recovery"></a>Восстановление виртуальной Машины

Для важных приложений необходимо запланировать для восстановления виртуальных машин в случае нарушения работы службы на уровне региона.

- Использование службы архивации Azure или другой метод резервного копирования для создания резервных копий между регионами, которые соответствуют приложению. (Репликацию резервного хранилища необходимо настроить во время создания.)
- Используйте Site Recovery для репликации по регионам для отработки отказа приложения одним щелчком и тестированию отработки отказа.
- Используйте диспетчер трафика для автоматизации отработки отказа трафика пользователей в другой регион.

Дополнительные сведения см. в разделе [восстановление после прерывания работы служб во всем регионе, виртуальные машины](../resiliency/recovery-loss-azure-region.md#virtual-machines).

### <a name="storage-recovery"></a>Восстановление хранилища

Для защиты хранилища в случае нарушения работы службы во всем регионе:

- Используйте геоизбыточное хранилище.
- Знаете, где геореплицируемые изолированные хранилища. Это влияет на, где развертывать другие экземпляры данных, которые должны находиться в одном регионе с хранилищем.
- Проверьте данные на предмет согласованности после отработки отказа и при необходимости восстановить из резервной копии.

Дополнительные сведения см. в разделе [проектирование высокодоступных приложений с использованием RA-GRS](/azure/storage/common/storage-designing-ha-apps-with-ragrs).

### <a name="sql-database-and-sql-server"></a>База данных SQL и SQL Server

База данных SQL Azure предоставляет два способа восстановления данных:

- Использование геовосстановления для восстановления базы данных из резервной копии в другом регионе. Дополнительные сведения см. в разделе [восстановить базу данных Azure SQL, с помощью создаваемых автоматически резервных копий](/azure/sql-database/sql-database-recovery-using-backups).
- Используйте активную георепликацию для отработки отказа для базы данных-получателя. Дополнительные сведения см. в разделе [Создание и использование активной георепликации](/azure/sql-database/sql-database-active-geo-replication).

SQL Server на виртуальных машинах, см. в разделе [высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).

## <a name="service-specific-guidance"></a>Рекомендации по отдельным службам

В следующих статьях описываются аварийного восстановления для определенных служб Azure:

| Service                       | Статья                                                                                                                                                                                       |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| База данных Azure для MySQL      | [Общие сведения об обеспечении непрерывности бизнес-процессов с помощью службы "База данных Azure для MySQL"](/azure/mysql/concepts-business-continuity)                                                  |
| База данных Azure для PostgreSQL | [Общие сведения об обеспечении непрерывности бизнес-процессов с помощью службы "База данных Azure для PostgreSQL"](/azure/postgresql/concepts-business-continuity)                                        |
| Облачные службы Azure          | [Что делать, если прерывание работы службы Azure влияет на облачные службы Azure](/azure/cloud-services/cloud-services-disaster-recovery-guidance) |
| База данных Cosmos                     | [Высокий уровень доступности с помощью Azure Cosmos DB](/azure/cosmos-db/high-availability)                                                                                |
| Хранилище ключей Azure               | [Доступность и избыточность хранилища ключей Azure](/azure/key-vault/key-vault-disaster-recovery-guidance)                                                        |
| Хранилище Azure                 | [Disaster recovery and storage account failover (preview) in Azure Storage](/azure/storage/common/storage-disaster-recovery-guidance) (Аварийное восстановление и отработка отказа учетной записи хранения (предварительная версия) в службе хранилища Azure)                       |
| База данных SQL                  | [Восстановление базы данных SQL Azure или отработки отказа в дополнительный регион](/azure/sql-database/sql-database-disaster-recovery)                                       |
| Виртуальные машины              | [Что в случае Azure Если прерывание работы службы влияет на облако Azure](/azure/cloud-services/cloud-services-disaster-recovery-guidance)               |
| Виртуальная сеть Azure         | [Виртуальная сеть: непрерывность бизнес-процессов](/azure/virtual-network/virtual-network-disaster-recovery-guidance)                                                  |

## <a name="next-steps"></a>Дальнейшие действия

- [Восстановление данных после повреждения или случайного удаления](../resiliency/recovery-data-corruption.md)
- [Восстановление после прерывания работы служб во всем регионе](../resiliency/recovery-loss-azure-region.md)