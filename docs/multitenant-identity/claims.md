---
title: Работа с удостоверениями на основе утверждений в мультитенантных приложениях
description: Как использовать утверждения для авторизации и проверки издателя.
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: authenticate
pnp.series.next: signup
ms.openlocfilehash: 8b8cbd2b857493d94103e80f53f187207feaa11e
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486511"
---
# <a name="work-with-claims-based-identities"></a>Работа с удостоверениями на основе утверждений

[![GitHub](../_images/github.png) Пример кода][sample application]

## <a name="claims-in-azure-ad"></a>Утверждения в Azure AD

Когда пользователь выполняет вход, Azure AD отправляет маркер идентификатора, содержащий набор утверждений о пользователе. Утверждение представляет собой фрагмент данных, выраженный в виде пары "ключ-значение". (например, `email`=`bob@contoso.com`).  У утверждений есть издатель (в этом случае &mdash; Azure AD &mdash;, который является сущностью, аутентифицирующей пользователя и создающей утверждения). Доверие к утверждениям основано на доверии к издателю. (И наоборот, если вы не доверяете издателю, вы не доверяете утверждениям!)

На высоком уровне:

1. Пользователь проходит проверку подлинности.
2. Поставщик удостоверений отправляет набор утверждений.
3. Приложение нормализует или расширяет утверждения (необязательно).
4. Приложение использует утверждения для принятия решений об авторизации.

В OpenID Connect получаемый набор утверждений управляет [параметром области] запроса на аутентификацию. Однако Azure AD выдает ограниченный набор утверждений через OpenID Connect. Подробнее об этом см. в статье [Поддерживаемые маркеры и типы утверждений]. Дополнительные сведения о пользователе можно получить в Graph API Azure AD.

Ниже приведены некоторые утверждения из AAD, которые могут иметь особое значение для приложения.

| Тип утверждения в маркере идентификатора | ОПИСАНИЕ |
| --- | --- |
| aud |Для кого выдан маркер. Это будет идентификатор клиента приложения. Как правило, на это утверждение не следует обращать внимание, так как его автоматически проверяет ПО промежуточного слоя. Пример: `"91464657-d17a-4327-91f3-2ed99386406f"` |
| groups |Список групп AAD, членом которых является пользователь. Пример: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]` |
| iss |[Издатель] маркера OIDC. Пример: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/` |
| name |Отображаемое имя пользователя. Пример: `"Alice A."` |
| oid |Идентификатор объекта для пользователя в AAD. Это значение является неизменяемым идентификатором пользователя без возможности повторного использования. Используйте это значение, а не адрес электронной почты, так как адрес может измениться. Если в приложении используется API Graph Azure AD, идентификатор объекта является значением, применяемым для запроса сведений о профиле. Пример: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"` |
| roles |Список ролей приложения для пользователя.    Пример: `["SurveyCreator"]` |
| tid |Идентификатор клиента. Это значение является уникальным идентификатором для клиента в Azure AD. Пример: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"` |
| unique_name |Читаемое отображаемое имя пользователя. Пример: `"alice@contoso.com"` |
| upn |Имя участника-пользователя. Пример: `"alice@contoso.com"` |

В этой таблице типы утверждений указаны в том виде, в каком они отображаются в маркере идентификатора. В ASP.NET Core ПО промежуточного слоя OpenID Connect преобразует некоторые типы утверждений при заполнении коллекции утверждений для участника-пользователя:

* oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`
* tid > `http://schemas.microsoft.com/identity/claims/tenantid`
* unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`
* upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`

## <a name="claims-transformations"></a>Преобразования утверждений

Во время аутентификации может потребоваться изменить утверждения, полученные от IDP. В ASP.NET Core можно выполнить преобразование утверждений внутри события **AuthenticationValidated** из ПО промежуточного слоя OpenID Connect. (Ознакомьтесь с разделом [События аутентификации].)

Все утверждения, добавленные во время **AuthenticationValidated** , хранятся в файле cookie сеанса проверки подлинности. Они не возвращаются обратно в Azure AD.

Ниже приведено несколько примеров преобразования утверждений.

* **Нормализация утверждений**или обеспечение согласованности утверждений среди пользователей. Это особенно важно при получении утверждений от нескольких поставщиков удостоверений, которые могут использовать разные типы утверждений для схожих сведений. Например, Azure AD отправляет утверждение "upn", содержащее адрес электронной почты пользователя. Другие поставщики удостоверений могут отправлять утверждение "email". Следующий код преобразует утверждение "upn" в утверждение "email":

  ```csharp
  var email = principal.FindFirst(ClaimTypes.Upn)?.Value;
  if (!string.IsNullOrWhiteSpace(email))
  {
      identity.AddClaim(new Claim(ClaimTypes.Email, email));
  }
  ```

* Для отсутствующих утверждений добавьте **утверждение по умолчанию**, например, назначьте пользователю роль по умолчанию. В некоторых случаях это может упростить логику авторизации.
* Добавление **настраиваемых типов утверждений** со сведениями о пользователе, относящимися к конкретному приложению. Например, можно сохранить некоторые сведения о пользователе в базе данных. Настраиваемое утверждение с этой информацией можно добавить в билет проверки подлинности. Утверждение хранится в файле cookie, поэтому его необходимо получать из базы данных один раз в каждом сеансе входа. С другой стороны, также необходимо избежать создания чрезмерно больших файлов cookie, поэтому следует добиваться компромисса между размером файла cookie и поисками в базе данных.

После завершения аутентификации утверждения доступны в `HttpContext.User`. На этом этапе необходимо рассматривать их как коллекцию, доступную только для чтения, например, используйте их для принятия решения об авторизации.

## <a name="issuer-validation"></a>Проверка издателя

В OpenID Connect утверждение издателя ("iss") определяет поставщика удостоверений, выдавшего маркер идентификатора. В рамках проверки подлинности OIDC осуществляется проверка соответствия утверждения издателя фактическому издателю. Эту задачу выполняет ПО промежуточного слоя OIDC.

В Azure AD значение издателя является уникальным для каждого клиента AD (`https://sts.windows.net/<tenantID>`). Таким образом, приложение должно дополнительно проверять, представляет ли издатель клиента, который может входить в приложение.

В однотенантном приложении можно просто проверить, что издатель является вашим собственным клиентом. На самом деле ПО промежуточного слоя OIDC выполняет эту задачу автоматически, по умолчанию. В мультитенантном приложении необходимо разрешить использование нескольких издателей, соответствующих разным клиентам. Ниже приведен общий подход.

* В параметрах ПО промежуточного слоя OIDC задайте параметру **ValidateIssuer** значение "false". Автоматическая проверка будет отключена.
* Во время регистрации клиента сохраните клиента и поставщика в базе данных пользователя.
* При каждом входе пользователя выполняйте поиск издателя в базе данных. Если издатель не найден, значит, клиент еще не зарегистрирован. Перенаправьте его на страницу регистрации.
* Некоторых клиентов можно занести в черный список, например, если пользователи не оплатили подписку.

Для получения дополнительной информации см. статью [Регистрация и адаптация клиента][signup].

## <a name="using-claims-for-authorization"></a>Использование утверждений для авторизации

С утверждениями удостоверение пользователя больше не является монолитной сущностью. Например, IDP пользователя может хранить такие данные, как адрес электронной почты, номер телефона, дата рождения, пол и т. д. Но при аутентификации пользователя обычно можно получить подмножество таких утверждений. Удостоверение пользователя в этой модели является просто набором утверждений. Необходимо искать отдельные наборы утверждений для авторизации пользователя. Другими словами, вопрос "Может ли пользователь Х выполнить действие У?" в конечном итоге превращается в вопрос "Есть ли у пользователя X утверждение Z?".

Ниже приведено несколько основных шаблонов для проверки утверждений.

* Проверка наличия у пользователя конкретного утверждения с конкретным значением:

   ```csharp
   if (User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
   ```

   Этот код проверяет, имеет ли пользователь утверждение Role со значением "Admin". Он правильно обрабатывает случай, когда у пользователя нет утверждения Role или есть несколько утверждений Role.
  
   Класс **ClaimTypes** определяет константы для часто используемых типов утверждений. Однако для типа утверждения можно использовать любое строковое значение.
* Получение одного значения для типа утверждения, если предполагается наличие не более одного значения:

  ```csharp
  string email = User.FindFirst(ClaimTypes.Email)?.Value;
  ```

* Получение всех значений для типа утверждения:

  ```csharp
  IEnumerable<Claim> groups = User.FindAll("groups");
  ```

Дополнительные сведения см. в статье [Role-based and resource-based authorization][authorization] (Авторизация на основе ролей и ресурсов).

[**Далее**][signup]

<!-- links -->

[параметром области]: https://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[Поддерживаемые маркеры и типы утверждений]: /azure/active-directory/active-directory-token-and-claims/
[Издатель]: https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[События аутентификации]: authenticate.md#authentication-events
[signup]: signup.md
[Claims-Based Authorization]: /aspnet/core/security/authorization/claims
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
[authorization]: authorize.md
