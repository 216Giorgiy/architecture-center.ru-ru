---
title: Работа с удостоверениями на основе утверждений в мультитенантных приложениях
description: Использование утверждений для проверки издателя и авторизации
author: MikeWasson
ms:date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: authenticate
pnp.series.next: signup
ms.openlocfilehash: 61788d9759715b21ef1bdda59c5b54d923fd8f62
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
ms.locfileid: "24541918"
---
# <a name="work-with-claims-based-identities"></a><span data-ttu-id="f8d59-103">Работа с удостоверениями на основе утверждений</span><span class="sxs-lookup"><span data-stu-id="f8d59-103">Work with claims-based identities</span></span>

<span data-ttu-id="f8d59-104">[![GitHub](../_images/github.png) Пример кода][sample application]</span><span class="sxs-lookup"><span data-stu-id="f8d59-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

## <a name="claims-in-azure-ad"></a><span data-ttu-id="f8d59-105">Утверждения в Azure AD</span><span class="sxs-lookup"><span data-stu-id="f8d59-105">Claims in Azure AD</span></span>
<span data-ttu-id="f8d59-106">Когда пользователь выполняет вход, Azure AD отправляет маркер идентификатора, содержащий набор утверждений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="f8d59-106">When a user signs in, Azure AD sends an ID token that contains a set of claims about the user.</span></span> <span data-ttu-id="f8d59-107">Утверждение представляет собой фрагмент данных, выраженный в виде пары "ключ-значение".</span><span class="sxs-lookup"><span data-stu-id="f8d59-107">A claim is simply a piece of information, expressed as a key/value pair.</span></span> <span data-ttu-id="f8d59-108">(например, `email`=`bob@contoso.com`).</span><span class="sxs-lookup"><span data-stu-id="f8d59-108">For example, `email`=`bob@contoso.com`.</span></span>  <span data-ttu-id="f8d59-109">У утверждений есть издатель (в этом случае &mdash; Azure AD &mdash;, который является сущностью, аутентифицирующей пользователя и создающей утверждения).</span><span class="sxs-lookup"><span data-stu-id="f8d59-109">Claims have an issuer &mdash; in this case, Azure AD &mdash; which is the entity that authenticates the user and creates the claims.</span></span> <span data-ttu-id="f8d59-110">Доверие к утверждениям основано на доверии к издателю.</span><span class="sxs-lookup"><span data-stu-id="f8d59-110">You trust the claims because you trust the issuer.</span></span> <span data-ttu-id="f8d59-111">(И наоборот, если вы не доверяете издателю, вы не доверяете утверждениям!)</span><span class="sxs-lookup"><span data-stu-id="f8d59-111">(Conversely, if you don't trust the issuer, don't trust the claims!)</span></span>

<span data-ttu-id="f8d59-112">На высоком уровне:</span><span class="sxs-lookup"><span data-stu-id="f8d59-112">At a high level:</span></span>

1. <span data-ttu-id="f8d59-113">Пользователь проходит проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8d59-113">The user authenticates.</span></span>
2. <span data-ttu-id="f8d59-114">Поставщик удостоверений отправляет набор утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-114">The IDP sends a set of claims.</span></span>
3. <span data-ttu-id="f8d59-115">Приложение нормализует или расширяет утверждения (необязательно).</span><span class="sxs-lookup"><span data-stu-id="f8d59-115">The app normalizes or augments the claims (optional).</span></span>
4. <span data-ttu-id="f8d59-116">Приложение использует утверждения для принятия решений об авторизации.</span><span class="sxs-lookup"><span data-stu-id="f8d59-116">The app uses the claims to make authorization decisions.</span></span>

<span data-ttu-id="f8d59-117">В OpenID Connect получаемый набор утверждений управляет [параметром области] запроса на аутентификацию.</span><span class="sxs-lookup"><span data-stu-id="f8d59-117">In OpenID Connect, the set of claims that you get is controlled by the [scope parameter] of the authentication request.</span></span> <span data-ttu-id="f8d59-118">Однако Azure AD выдает ограниченный набор утверждений через OpenID Connect. Подробнее об этом см. в статье [Справочник по токенам в Azure AD].</span><span class="sxs-lookup"><span data-stu-id="f8d59-118">However, Azure AD issues a limited set of claims through OpenID Connect; see [Supported Token and Claim Types].</span></span> <span data-ttu-id="f8d59-119">Дополнительные сведения о пользователе можно получить в Graph API Azure AD.</span><span class="sxs-lookup"><span data-stu-id="f8d59-119">If you want more information about the user, you'll need to use the Azure AD Graph API.</span></span>

<span data-ttu-id="f8d59-120">Ниже приведены некоторые утверждения из AAD, которые могут иметь особое значение для приложения.</span><span class="sxs-lookup"><span data-stu-id="f8d59-120">Here are some of the claims from AAD that an app might typically care about:</span></span>

| <span data-ttu-id="f8d59-121">Тип утверждения в маркере идентификатора</span><span class="sxs-lookup"><span data-stu-id="f8d59-121">Claim type in ID token</span></span> | <span data-ttu-id="f8d59-122">Описание</span><span class="sxs-lookup"><span data-stu-id="f8d59-122">Description</span></span> |
| --- | --- |
| <span data-ttu-id="f8d59-123">aud</span><span class="sxs-lookup"><span data-stu-id="f8d59-123">aud</span></span> |<span data-ttu-id="f8d59-124">Для кого выдан маркер.</span><span class="sxs-lookup"><span data-stu-id="f8d59-124">Who the token was issued for.</span></span> <span data-ttu-id="f8d59-125">Это будет идентификатор клиента приложения.</span><span class="sxs-lookup"><span data-stu-id="f8d59-125">This will be the application's client ID.</span></span> <span data-ttu-id="f8d59-126">Как правило, на это утверждение не следует обращать внимание, так как его автоматически проверяет ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-126">Generally, you shouldn't need to worry about this claim, because the middleware automatically validates it.</span></span> <span data-ttu-id="f8d59-127">Пример: `"91464657-d17a-4327-91f3-2ed99386406f"`</span><span class="sxs-lookup"><span data-stu-id="f8d59-127">Example:  `"91464657-d17a-4327-91f3-2ed99386406f"`</span></span> |
| <span data-ttu-id="f8d59-128">groups</span><span class="sxs-lookup"><span data-stu-id="f8d59-128">groups</span></span> |<span data-ttu-id="f8d59-129">Список групп AAD, членом которых является пользователь.</span><span class="sxs-lookup"><span data-stu-id="f8d59-129">A list of AAD groups of which the user is a member.</span></span> <span data-ttu-id="f8d59-130">Пример: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span><span class="sxs-lookup"><span data-stu-id="f8d59-130">Example: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span></span> |
| <span data-ttu-id="f8d59-131">iss</span><span class="sxs-lookup"><span data-stu-id="f8d59-131">iss</span></span> |<span data-ttu-id="f8d59-132">[Издатель] маркера OIDC.</span><span class="sxs-lookup"><span data-stu-id="f8d59-132">The [issuer] of the OIDC token.</span></span> <span data-ttu-id="f8d59-133">Пример: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span><span class="sxs-lookup"><span data-stu-id="f8d59-133">Example: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span></span> |
| <span data-ttu-id="f8d59-134">name</span><span class="sxs-lookup"><span data-stu-id="f8d59-134">name</span></span> |<span data-ttu-id="f8d59-135">Отображаемое имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-135">The user's display name.</span></span> <span data-ttu-id="f8d59-136">Пример: `"Alice A."`</span><span class="sxs-lookup"><span data-stu-id="f8d59-136">Example: `"Alice A."`</span></span> |
| <span data-ttu-id="f8d59-137">oid</span><span class="sxs-lookup"><span data-stu-id="f8d59-137">oid</span></span> |<span data-ttu-id="f8d59-138">Идентификатор объекта для пользователя в AAD.</span><span class="sxs-lookup"><span data-stu-id="f8d59-138">The object identifier for the user in AAD.</span></span> <span data-ttu-id="f8d59-139">Это значение является неизменяемым идентификатором пользователя без возможности повторного использования.</span><span class="sxs-lookup"><span data-stu-id="f8d59-139">This value is the immutable and non-reusable identifier of the user.</span></span> <span data-ttu-id="f8d59-140">Используйте это значение, а не адрес электронной почты, так как адрес может измениться.</span><span class="sxs-lookup"><span data-stu-id="f8d59-140">Use this value, not email, as a unique identifier for users; email addresses can change.</span></span> <span data-ttu-id="f8d59-141">Если в приложении используется API Graph Azure AD, идентификатор объекта является значением, применяемым для запроса сведений о профиле.</span><span class="sxs-lookup"><span data-stu-id="f8d59-141">If you use the Azure AD Graph API in your app, object ID is that value used to query profile information.</span></span> <span data-ttu-id="f8d59-142">Пример: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span><span class="sxs-lookup"><span data-stu-id="f8d59-142">Example: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span></span> |
| <span data-ttu-id="f8d59-143">roles</span><span class="sxs-lookup"><span data-stu-id="f8d59-143">roles</span></span> |<span data-ttu-id="f8d59-144">Список ролей приложения для пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-144">A list of app roles for the user.</span></span>    <span data-ttu-id="f8d59-145">Пример: `["SurveyCreator"]`</span><span class="sxs-lookup"><span data-stu-id="f8d59-145">Example: `["SurveyCreator"]`</span></span> |
| <span data-ttu-id="f8d59-146">tid</span><span class="sxs-lookup"><span data-stu-id="f8d59-146">tid</span></span> |<span data-ttu-id="f8d59-147">Идентификатор клиента.</span><span class="sxs-lookup"><span data-stu-id="f8d59-147">Tenant ID.</span></span> <span data-ttu-id="f8d59-148">Это значение является уникальным идентификатором для клиента в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="f8d59-148">This value is a unique identifier for the tenant in Azure AD.</span></span> <span data-ttu-id="f8d59-149">Пример: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span><span class="sxs-lookup"><span data-stu-id="f8d59-149">Example: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span></span> |
| <span data-ttu-id="f8d59-150">unique_name</span><span class="sxs-lookup"><span data-stu-id="f8d59-150">unique_name</span></span> |<span data-ttu-id="f8d59-151">Читаемое отображаемое имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-151">A human readable display name of the user.</span></span> <span data-ttu-id="f8d59-152">Пример: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="f8d59-152">Example: `"alice@contoso.com"`</span></span> |
| <span data-ttu-id="f8d59-153">upn</span><span class="sxs-lookup"><span data-stu-id="f8d59-153">upn</span></span> |<span data-ttu-id="f8d59-154">Имя участника-пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-154">User principal name.</span></span> <span data-ttu-id="f8d59-155">Пример: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="f8d59-155">Example: `"alice@contoso.com"`</span></span> |

<span data-ttu-id="f8d59-156">В этой таблице типы утверждений указаны в том виде, в каком они отображаются в маркере идентификатора.</span><span class="sxs-lookup"><span data-stu-id="f8d59-156">This table lists the claim types as they appear in the ID token.</span></span> <span data-ttu-id="f8d59-157">В ASP.NET Core ПО промежуточного слоя OpenID Connect преобразует некоторые типы утверждений при заполнении коллекции утверждений для участника-пользователя:</span><span class="sxs-lookup"><span data-stu-id="f8d59-157">In ASP.NET Core, the OpenID Connect middleware converts some of the claim types when it populates the Claims collection for the user principal:</span></span>

* <span data-ttu-id="f8d59-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span><span class="sxs-lookup"><span data-stu-id="f8d59-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span></span>
* <span data-ttu-id="f8d59-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span><span class="sxs-lookup"><span data-stu-id="f8d59-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span></span>
* <span data-ttu-id="f8d59-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span><span class="sxs-lookup"><span data-stu-id="f8d59-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span></span>
* <span data-ttu-id="f8d59-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span><span class="sxs-lookup"><span data-stu-id="f8d59-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span></span>

## <a name="claims-transformations"></a><span data-ttu-id="f8d59-162">Преобразования утверждений</span><span class="sxs-lookup"><span data-stu-id="f8d59-162">Claims transformations</span></span>
<span data-ttu-id="f8d59-163">Во время аутентификации может потребоваться изменить утверждения, полученные от IDP.</span><span class="sxs-lookup"><span data-stu-id="f8d59-163">During the authentication flow, you might want to modify the claims that you get from the IDP.</span></span> <span data-ttu-id="f8d59-164">В ASP.NET Core можно выполнить преобразование утверждений внутри события **AuthenticationValidated** из ПО промежуточного слоя OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="f8d59-164">In ASP.NET Core, you can perform claims transformation inside of the **AuthenticationValidated** event from the OpenID Connect middleware.</span></span> <span data-ttu-id="f8d59-165">(Ознакомьтесь с разделом [События аутентификации].)</span><span class="sxs-lookup"><span data-stu-id="f8d59-165">(See [Authentication events].)</span></span>

<span data-ttu-id="f8d59-166">Все утверждения, добавленные во время **AuthenticationValidated** , хранятся в файле cookie сеанса проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8d59-166">Any claims that you add during **AuthenticationValidated** are stored in the session authentication cookie.</span></span> <span data-ttu-id="f8d59-167">Они не возвращаются обратно в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="f8d59-167">They don't get pushed back to Azure AD.</span></span>

<span data-ttu-id="f8d59-168">Ниже приведено несколько примеров преобразования утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-168">Here are some examples of claims transformation:</span></span>

* <span data-ttu-id="f8d59-169">**Нормализация утверждений**или обеспечение согласованности утверждений среди пользователей.</span><span class="sxs-lookup"><span data-stu-id="f8d59-169">**Claims normalization**, or making claims consistent across users.</span></span> <span data-ttu-id="f8d59-170">Это особенно важно при получении утверждений от нескольких поставщиков удостоверений, которые могут использовать разные типы утверждений для схожих сведений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-170">This is particularly relevant if you are getting claims from multiple IDPs, which might use different claim types for similar information.</span></span>
  <span data-ttu-id="f8d59-171">Например, Azure AD отправляет утверждение "upn", содержащее адрес электронной почты пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-171">For example, Azure AD sends a "upn" claim that contains the user's email.</span></span> <span data-ttu-id="f8d59-172">Другие поставщики удостоверений могут отправлять утверждение "email".</span><span class="sxs-lookup"><span data-stu-id="f8d59-172">Other IDPs might send an "email" claim.</span></span> <span data-ttu-id="f8d59-173">Следующий код преобразует утверждение "upn" в утверждение "email":</span><span class="sxs-lookup"><span data-stu-id="f8d59-173">The following code converts the "upn" claim into an "email" claim:</span></span>
  
  ```csharp
  var email = principal.FindFirst(ClaimTypes.Upn)?.Value;
  if (!string.IsNullOrWhiteSpace(email))
  {
      identity.AddClaim(new Claim(ClaimTypes.Email, email));
  }
  ```
* <span data-ttu-id="f8d59-174">Для отсутствующих утверждений добавьте **утверждение по умолчанию**, например, назначьте пользователю роль по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="f8d59-174">Add **default claim values** for claims that aren't present &mdash; for example, assigning a user to a default role.</span></span> <span data-ttu-id="f8d59-175">В некоторых случаях это может упростить логику авторизации.</span><span class="sxs-lookup"><span data-stu-id="f8d59-175">In some cases this can simplify authorization logic.</span></span>
* <span data-ttu-id="f8d59-176">Добавление **настраиваемых типов утверждений** со сведениями о пользователе, относящимися к конкретному приложению.</span><span class="sxs-lookup"><span data-stu-id="f8d59-176">Add **custom claim types** with application-specific information about the user.</span></span> <span data-ttu-id="f8d59-177">Например, можно сохранить некоторые сведения о пользователе в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8d59-177">For example, you might store some information about the user in a database.</span></span> <span data-ttu-id="f8d59-178">Настраиваемое утверждение с этой информацией можно добавить в билет проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8d59-178">You could add a custom claim with this information to the authentication ticket.</span></span> <span data-ttu-id="f8d59-179">Утверждение хранится в файле cookie, поэтому его необходимо получать из базы данных один раз в каждом сеансе входа.</span><span class="sxs-lookup"><span data-stu-id="f8d59-179">The claim is stored in a cookie, so you only need to get it from the database once per login session.</span></span> <span data-ttu-id="f8d59-180">С другой стороны, также необходимо избежать создания чрезмерно больших файлов cookie, поэтому следует добиваться компромисса между размером файла cookie и поисками в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8d59-180">On the other hand, you also want to avoid creating excessively large cookies, so you need to consider the trade-off between cookie size versus database lookups.</span></span>   

<span data-ttu-id="f8d59-181">После завершения аутентификации утверждения доступны в `HttpContext.User`.</span><span class="sxs-lookup"><span data-stu-id="f8d59-181">After the authentication flow is complete, the claims are available in `HttpContext.User`.</span></span> <span data-ttu-id="f8d59-182">На этом этапе необходимо рассматривать их как коллекцию, доступную только для чтения, например, используйте их для принятия решения об авторизации.</span><span class="sxs-lookup"><span data-stu-id="f8d59-182">At that point, you should treat them as a read-only collection &mdash; e.g., use them to make authorization decisions.</span></span>

## <a name="issuer-validation"></a><span data-ttu-id="f8d59-183">Проверка издателя</span><span class="sxs-lookup"><span data-stu-id="f8d59-183">Issuer validation</span></span>
<span data-ttu-id="f8d59-184">В OpenID Connect утверждение издателя ("iss") определяет поставщика удостоверений, выдавшего маркер идентификатора.</span><span class="sxs-lookup"><span data-stu-id="f8d59-184">In OpenID Connect, the issuer claim ("iss") identifies the IDP that issued the ID token.</span></span> <span data-ttu-id="f8d59-185">В рамках проверки подлинности OIDC осуществляется проверка соответствия утверждения издателя фактическому издателю.</span><span class="sxs-lookup"><span data-stu-id="f8d59-185">Part of the OIDC authentication flow is to verify that the issuer claim matches the actual issuer.</span></span> <span data-ttu-id="f8d59-186">Эту задачу выполняет ПО промежуточного слоя OIDC.</span><span class="sxs-lookup"><span data-stu-id="f8d59-186">The OIDC middleware handles this for you.</span></span>

<span data-ttu-id="f8d59-187">В Azure AD значение издателя является уникальным для каждого клиента AD (`https://sts.windows.net/<tenantID>`).</span><span class="sxs-lookup"><span data-stu-id="f8d59-187">In Azure AD, the issuer value is unique per AD tenant (`https://sts.windows.net/<tenantID>`).</span></span> <span data-ttu-id="f8d59-188">Таким образом, приложение должно дополнительно проверять, представляет ли издатель клиента, который может входить в приложение.</span><span class="sxs-lookup"><span data-stu-id="f8d59-188">Therefore, an application should do an additional check, to make sure the issuer represents a tenant that is allowed to sign in to the app.</span></span>

<span data-ttu-id="f8d59-189">В однотенантном приложении можно просто проверить, что издатель является вашим собственным клиентом.</span><span class="sxs-lookup"><span data-stu-id="f8d59-189">For a single-tenant application, you can just check that the issuer is your own tenant.</span></span> <span data-ttu-id="f8d59-190">На самом деле ПО промежуточного слоя OIDC выполняет эту задачу автоматически, по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="f8d59-190">In fact, the OIDC middleware does this automatically by default.</span></span> <span data-ttu-id="f8d59-191">В мультитенантном приложении необходимо разрешить использование нескольких издателей, соответствующих разным клиентам.</span><span class="sxs-lookup"><span data-stu-id="f8d59-191">In a multi-tenant app, you need to allow for multiple issuers, corresponding to the different tenants.</span></span> <span data-ttu-id="f8d59-192">Ниже приведен общий подход.</span><span class="sxs-lookup"><span data-stu-id="f8d59-192">Here is a general approach to use:</span></span>

* <span data-ttu-id="f8d59-193">В параметрах ПО промежуточного слоя OIDC задайте параметру **ValidateIssuer** значение "false".</span><span class="sxs-lookup"><span data-stu-id="f8d59-193">In the OIDC middleware options, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="f8d59-194">Автоматическая проверка будет отключена.</span><span class="sxs-lookup"><span data-stu-id="f8d59-194">This turns off the automatic check.</span></span>
* <span data-ttu-id="f8d59-195">Во время регистрации клиента сохраните клиента и поставщика в базе данных пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-195">When a tenant signs up, store the tenant and the issuer in your user DB.</span></span>
* <span data-ttu-id="f8d59-196">При каждом входе пользователя выполняйте поиск издателя в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8d59-196">Whenever a user signs in, look up the issuer in the database.</span></span> <span data-ttu-id="f8d59-197">Если издатель не найден, значит, клиент еще не зарегистрирован.</span><span class="sxs-lookup"><span data-stu-id="f8d59-197">If the issuer isn't found, it means that tenant hasn't signed up.</span></span> <span data-ttu-id="f8d59-198">Перенаправьте его на страницу регистрации.</span><span class="sxs-lookup"><span data-stu-id="f8d59-198">You can redirect them to a sign up page.</span></span>
* <span data-ttu-id="f8d59-199">Некоторых клиентов можно занести в черный список, например, если пользователи не оплатили подписку.</span><span class="sxs-lookup"><span data-stu-id="f8d59-199">You could also blacklist certain tenants; for example, for customers that didn't pay their subscription.</span></span>

<span data-ttu-id="f8d59-200">Для получения дополнительной информации см. статью [Регистрация и адаптация клиента][signup].</span><span class="sxs-lookup"><span data-stu-id="f8d59-200">For a more detailed discussion, see [Sign-up and tenant onboarding in a multitenant application][signup].</span></span>

## <a name="using-claims-for-authorization"></a><span data-ttu-id="f8d59-201">Использование утверждений для авторизации</span><span class="sxs-lookup"><span data-stu-id="f8d59-201">Using claims for authorization</span></span>
<span data-ttu-id="f8d59-202">С утверждениями удостоверение пользователя больше не является монолитной сущностью.</span><span class="sxs-lookup"><span data-stu-id="f8d59-202">With claims, a user's identity is no longer a monolithic entity.</span></span> <span data-ttu-id="f8d59-203">Например, IDP пользователя может хранить такие данные, как адрес электронной почты, номер телефона, дата рождения, пол и т. д.</span><span class="sxs-lookup"><span data-stu-id="f8d59-203">For example, a user might have an email address, phone number, birthday, gender, etc. Maybe the user's IDP stores all of this information.</span></span> <span data-ttu-id="f8d59-204">Но при аутентификации пользователя обычно можно получить подмножество таких утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-204">But when you authenticate the user, you'll typically get a subset of these as claims.</span></span> <span data-ttu-id="f8d59-205">Удостоверение пользователя в этой модели является просто набором утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-205">In this model, the user's identity is simply a bundle of claims.</span></span> <span data-ttu-id="f8d59-206">Необходимо искать отдельные наборы утверждений для авторизации пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8d59-206">When you make authorization decisions about a user, you will look for particular sets of claims.</span></span> <span data-ttu-id="f8d59-207">Другими словами, вопрос "Может ли пользователь Х выполнить действие У?" в конечном итоге превращается в вопрос "Есть ли у пользователя X утверждение Z?".</span><span class="sxs-lookup"><span data-stu-id="f8d59-207">In other words, the question "Can user X perform action Y" ultimately becomes "Does user X have claim Z".</span></span>

<span data-ttu-id="f8d59-208">Ниже приведено несколько основных шаблонов для проверки утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-208">Here are some basic patterns for checking claims.</span></span>

* <span data-ttu-id="f8d59-209">Проверка наличия у пользователя конкретного утверждения с конкретным значением:</span><span class="sxs-lookup"><span data-stu-id="f8d59-209">To check that the user has a particular claim with a particular value:</span></span>
  
   ```csharp
   if (User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
   ```
   <span data-ttu-id="f8d59-210">Этот код проверяет, имеет ли пользователь утверждение Role со значением "Admin".</span><span class="sxs-lookup"><span data-stu-id="f8d59-210">This code checks whether the user has a Role claim with the value "Admin".</span></span> <span data-ttu-id="f8d59-211">Он правильно обрабатывает случай, когда у пользователя нет утверждения Role или есть несколько утверждений Role.</span><span class="sxs-lookup"><span data-stu-id="f8d59-211">It correctly handles the case where the user has no Role claim or multiple Role claims.</span></span>
  
   <span data-ttu-id="f8d59-212">Класс **ClaimTypes** определяет константы для часто используемых типов утверждений.</span><span class="sxs-lookup"><span data-stu-id="f8d59-212">The **ClaimTypes** class defines constants for commonly-used claim types.</span></span> <span data-ttu-id="f8d59-213">Однако для типа утверждения можно использовать любое строковое значение.</span><span class="sxs-lookup"><span data-stu-id="f8d59-213">However, you can use any string value for the claim type.</span></span>
* <span data-ttu-id="f8d59-214">Получение одного значения для типа утверждения, если предполагается наличие не более одного значения:</span><span class="sxs-lookup"><span data-stu-id="f8d59-214">To get a single value for a claim type, when you expect there to be at most one value:</span></span>
  
  ```csharp
  string email = User.FindFirst(ClaimTypes.Email)?.Value;
  ```
* <span data-ttu-id="f8d59-215">Получение всех значений для типа утверждения:</span><span class="sxs-lookup"><span data-stu-id="f8d59-215">To get all the values for a claim type:</span></span>
  
  ```csharp
  IEnumerable<Claim> groups = User.FindAll("groups");
  ```

<span data-ttu-id="f8d59-216">Дополнительные сведения см. в статье [Role-based and resource-based authorization][authorization] (Авторизация на основе ролей и ресурсов).</span><span class="sxs-lookup"><span data-stu-id="f8d59-216">For more information, see [Role-based and resource-based authorization in multitenant applications][authorization].</span></span>

<span data-ttu-id="f8d59-217">[**Далее**][signup]</span><span class="sxs-lookup"><span data-stu-id="f8d59-217">[**Next**][signup]</span></span>


<!-- Links -->

[параметром области]: http://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[scope parameter]: http://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[Справочник по токенам в Azure AD]: /azure/active-directory/active-directory-token-and-claims/
[Supported Token and Claim Types]: /azure/active-directory/active-directory-token-and-claims/
[Издатель]: http://openid.net/specs/openid-connect-core-1_0.html#IDToken
[issuer]: http://openid.net/specs/openid-connect-core-1_0.html#IDToken
[События аутентификации]: authenticate.md#authentication-events
[Authentication events]: authenticate.md#authentication-events
[signup]: signup.md
[Claims-Based Authorization]: /aspnet/core/security/authorization/claims
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
[authorization]: authorize.md
