---
title: Роли приложений
description: Выполнение авторизации с помощью ролей приложения
author: MikeWasson
ms:date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: signup
pnp.series.next: authorize
ms.openlocfilehash: ec563936e5f00aba79d65844762feeed97ad547d
ms.sourcegitcommit: bb348bd3a8a4e27ef61e8eee74b54b07b65dbf98
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2018
ms.locfileid: "34422972"
---
# <a name="application-roles"></a>Роли приложений

[![GitHub](../_images/github.png) Пример кода][sample application]

Роли приложения используются для назначения разрешений пользователям. Например, приложение [Tailspin Surveys][Tailspin] определяет следующие роли:

* Администратор. Может выполнять все операции CRUD в любом опросе, принадлежащем этому клиенту.
* Создатель. Может создавать опросы.
* Читатель. Может читать все опросы, принадлежащие этому клиенту.

В конечном счете роли преобразуются в разрешения во время [авторизации]. Однако сначала нужно ответить на первый вопрос, касающийся назначения ролей и управления ими. Мы определили три основных варианта:

* [роли приложения Azure AD](#roles-using-azure-ad-app-roles)
* [группы безопасности Azure AD](#roles-using-azure-ad-security-groups)
* [диспетчер ролей приложения](#roles-using-an-application-role-manager).

## <a name="roles-using-azure-ad-app-roles"></a>Роли, использующие роли приложения Azure AD
Это подход, который использовался в приложении Tailspin Surveys.

Здесь поставщик SaaS определяет роли приложения, добавляя их в манифест приложения. После регистрации клиента администратор каталога AD клиента назначает роли пользователям. Когда пользователь входит в систему, назначенные роли отправляются в виде утверждений.

> [!NOTE]
> Если у клиента установлена служба Azure AD Premium, администратор может назначить роль группе безопасности, и участники группы будут наследовать роль приложения. Это удобный способ управления ролями, поскольку владельцу группы не нужно быть администратором AD.
> 
> 

Преимущества этого подхода:

* Простая модель программирования.
* Роли соответствуют конкретному приложению. Утверждения ролей для одного приложения не отправляются в другое приложение.
* Если клиент удаляет приложение из своего клиента AD, роли также удаляются.
* Приложению не требуются дополнительные разрешения Active Directory, кроме разрешения на чтение профиля пользователя.

Недостатки:

* Клиенты, не имеющие Azure AD Premium, не могут назначать роли группам безопасности. Для этих клиентов все назначения пользователей должен выполнять администратор AD.
* Если вы используете отдельную серверную часть веб-API, назначения ролей для веб-приложения не применяются к веб-API. Более подробно этот вопрос рассматривается в статье об [обеспечении безопасности серверного веб-API].

### <a name="implementation"></a>Реализация
**Определение ролей.** Поставщик SaaS объявляет роли приложения в [манифесте приложения]. Например, вот запись манифеста для приложения Surveys:

```json
"appRoles": [
  {
    "allowedMemberTypes": [
      "User"
    ],
    "description": "Creators can create Surveys",
    "displayName": "SurveyCreator",
    "id": "1b4f816e-5eaf-48b9-8613-7923830595ad",
    "isEnabled": true,
    "value": "SurveyCreator"
  },
  {
    "allowedMemberTypes": [
      "User"
    ],
    "description": "Administrators can manage the Surveys in their tenant",
    "displayName": "SurveyAdmin",
    "id": "c20e145e-5459-4a6c-a074-b942bbd4cfe1",
    "isEnabled": true,
    "value": "SurveyAdmin"
  }
],
```

Свойство `value` отображается в утверждении роли. Свойство `id` является уникальным идентификатором для определенной роли. Всегда создает новое значение GUID для `id`.

**Назначение пользователей**. Во время регистрации нового клиента приложение регистрируется в клиенте AD. На этом этапе администратор AD этого клиента может назначить роли пользователям.

> [!NOTE]
> Как отмечалось ранее, клиенты с Azure AD Premium также могут назначать роли группам безопасности.
> 
> 

На приведенном ниже снимке экрана с портала Azure представлены пользователи и группы в приложении Survey. Группы администраторов и создателей присвоены ролям SurveyAdmin и SurveyCreator соответственно. Пользователю Алиса напрямую присвоена роль SurveyAdmin. Пользователям Боб и Чарльз роли напрямую не присвоены.

![Пользователи и группы](./images/running-the-app/users-and-groups.png)

Как вы видите на приведенном ниже снимке экрана, Чарльз входит в группу администраторов и наследует от нее роль SurveyAdmin. Что касается пользователя Боб, ему пока не присвоена роль.

![Участники группы администраторов](./images/running-the-app/admin-members.png)


> [!NOTE]
> Есть и другой вариант. Приложение может назначать роли программным способом с помощью API Graph Azure AD. Однако для этого приложение должно получить разрешения на запись в каталог AD клиента. Приложения с такими разрешениями могут вызвать большие проблемы, ведь клиент доверяет приложению поддерживать порядок в каталоге. Возможно, многие клиенты не захотят предоставлять этот уровень доступа.
> 

**Получение утверждения ролей**. При входе пользователя в систему приложение получает назначенные роли пользователя в утверждении с типом `http://schemas.microsoft.com/ws/2008/06/identity/claims/role`.  

Пользователь может иметь несколько ролей или вообще не иметь ролей. Создавая код авторизации, не следует предполагать, что у пользователя есть только одно утверждение роли. Наоборот, напишите код, который проверяет наличие значения определенного утверждения, как показано ниже.

```csharp
if (context.User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
```

## <a name="roles-using-azure-ad-security-groups"></a>Роли, использующие группы безопасности Azure AD
В этом случае роли представлены в виде групп безопасности AD. Приложение назначает разрешения пользователям на основе их членства в группах безопасности.

Преимущества:

* этот подход позволяет клиентам, у которых не установлена служба Azure AD Premium, использовать группы безопасности для управления назначениями ролей.

Недостатки:

* сложность. Поскольку каждый клиент отправляет разные утверждения групп, приложение должно отслеживать соответствие групп безопасности ролям приложения для каждого клиента.
* Если клиент удаляет приложение из своего клиента AD, группы безопасности остаются в каталоге AD.

### <a name="implementation"></a>Реализация
В манифесте приложения задайте свойству `groupMembershipClaims` значение "SecurityGroup". Это необходимо для получения утверждений членства в группах из Azure AD.

```json
{
   // ...
   "groupMembershipClaims": "SecurityGroup",
}
```

При регистрации нового клиента приложение указывает на необходимость создания групп безопасности для ролей, требуемых для приложения. Затем клиент должен ввести идентификаторы объектов групп в приложение. Приложение хранит их в таблице, которая сопоставляет идентификаторы групп с ролями приложения для каждого клиента.

> [!NOTE]
> Кроме того, приложение может создавать группы программным способом с помощью API Graph Azure AD.  В этом случае вероятность появления ошибок значительно уменьшается. Однако для этого приложение должно получить для всех групп разрешения на чтение и запись в каталог AD клиента. Возможно, многие клиенты не захотят предоставлять этот уровень доступа.
> 
> 

При входе пользователя:

1. Приложение получает группы пользователя в виде утверждений. Значением каждого утверждения является идентификатор объекта группы.
2. Azure AD ограничивает количество групп, отправляемых в маркере. Если число групп превышает этот предел, Azure AD отправляет специальное утверждение об "избытке". При наличии этого утверждения приложение обращается к API Graph Azure AD, чтобы получить сведения обо всех группах, к которым принадлежит пользователь. Дополнительные сведения см. в разделе [Authorization in Cloud Applications using AD Groups] (Авторизация в облачных приложениях с использованием групп AD) статьи "Groups claim overage" (Утверждение об избытке для групп).
3. Приложение начинает поиск идентификаторов объектов в своей базе данных, чтобы найти соответствующие роли приложения для назначения пользователю.
4. Приложение добавляет участнику-пользователю значение настраиваемого утверждения, выражающее роль приложения. Например: `survey_role` = "SurveyAdmin".

Политики авторизации должны использовать настраиваемое утверждение роли, а не утверждение группы.

## <a name="roles-using-an-application-role-manager"></a>Роли, использующие диспетчер ролей приложения
При использовании этого подхода роли приложения не хранятся в Azure AD. Вместо этого приложение сохраняет назначения ролей для каждого пользователя в своей собственной базе данных, например, используя класс **RoleManager** из удостоверений ASP.NET.

Преимущества:

* приложение полностью контролирует назначение ролей и пользователей.

Недостатки:

* более сложный и трудный в обслуживании подход;
* группы безопасности AD нельзя использовать для управления назначениями ролей;
* хранит сведения о пользователе в базе данных приложения, где по мере добавления или удаления пользователей может нарушиться синхронизация с каталогом AD клиента.   


[**Далее**][авторизации]

<!-- Links -->
[Tailspin]: tailspin.md

[авторизации]: authorize.md
[обеспечении безопасности серверного веб-API]: web-api.md
[манифесте приложения]: /azure/active-directory/active-directory-application-manifest/
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
