---
title: Проверка подлинности в мультитенантных приложениях
description: Проверка подлинности пользователей Azure Active Directory в мультитенантных приложениях
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: b4a833a18b44e40f544449a222fb082d71e4268d
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54481649"
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="16d6c-103">Аутентификация с помощью Azure AD и OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="16d6c-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="16d6c-104">[![GitHub](../_images/github.png) Пример кода][sample application]</span><span class="sxs-lookup"><span data-stu-id="16d6c-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="16d6c-105">В приложении Surveys используется протокол OpenID Connect (OIDC) для аутентификации пользователей через Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="16d6c-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="16d6c-106">В приложении Surveys используется ASP.NET Core со встроенным ПО промежуточного слоя для поддержки OIDC.</span><span class="sxs-lookup"><span data-stu-id="16d6c-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="16d6c-107">На схеме ниже в общих чертах представлен процесс входа пользователя в систему.</span><span class="sxs-lookup"><span data-stu-id="16d6c-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Поток проверки подлинности](./images/auth-flow.png)

1. <span data-ttu-id="16d6c-109">В приложении пользователь нажимает кнопку "Вход".</span><span class="sxs-lookup"><span data-stu-id="16d6c-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="16d6c-110">Это действие обрабатывается контроллером MVC.</span><span class="sxs-lookup"><span data-stu-id="16d6c-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="16d6c-111">Контроллер MVC возвращает действие **ChallengeResult** .</span><span class="sxs-lookup"><span data-stu-id="16d6c-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="16d6c-112">ПО промежуточного слоя перехватывает **ChallengeResult** и создает ответ 302, который перенаправляет пользователя на страницу входа в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="16d6c-113">Для пользователя выполняется проверка подлинности с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="16d6c-114">Azure AD отправляет маркер идентификатора в приложение.</span><span class="sxs-lookup"><span data-stu-id="16d6c-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="16d6c-115">ПО промежуточного слоя проверяет маркер идентификатора.</span><span class="sxs-lookup"><span data-stu-id="16d6c-115">The middleware validates the ID token.</span></span> <span data-ttu-id="16d6c-116">Теперь пользователь прошел проверку подлинности внутри приложения.</span><span class="sxs-lookup"><span data-stu-id="16d6c-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="16d6c-117">ПО промежуточного слоя перенаправляет пользователя назад в приложение.</span><span class="sxs-lookup"><span data-stu-id="16d6c-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="16d6c-118">Регистрация приложения в Azure AD</span><span class="sxs-lookup"><span data-stu-id="16d6c-118">Register the app with Azure AD</span></span>

<span data-ttu-id="16d6c-119">Чтобы активировать OpenID Connect, поставщик SaaS регистрирует приложение в собственном клиенте Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="16d6c-120">Чтобы зарегистрировать приложение, выполните инструкции в разделе [Добавление приложения](/azure/active-directory/active-directory-integrating-applications/#adding-an-application) статьи [Интеграция приложений с Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/).</span><span class="sxs-lookup"><span data-stu-id="16d6c-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="16d6c-121">В статье [Run the Surveys application](./run-the-app.md) (Запуск приложения Surveys) описаны конкретные шаги для приложения Surveys.</span><span class="sxs-lookup"><span data-stu-id="16d6c-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="16d6c-122">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="16d6c-122">Note the following:</span></span>

- <span data-ttu-id="16d6c-123">Для мультитенантного приложения следует явным образом настроить параметр мультитенантности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="16d6c-124">Это позволит другим организациям обращаться к приложению.</span><span class="sxs-lookup"><span data-stu-id="16d6c-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="16d6c-125">URL-адрес ответа — это URL-адрес, по которому Azure AD будет отправлять ответы OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="16d6c-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="16d6c-126">Если вы используете ASP.NET Core, он должен совпадать с адресом, который вы настроили в ПО промежуточного слоя для аутентификации (см. следующий раздел).</span><span class="sxs-lookup"><span data-stu-id="16d6c-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section).</span></span>

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="16d6c-127">Настройка ПО промежуточного слоя для аутентификации</span><span class="sxs-lookup"><span data-stu-id="16d6c-127">Configure the auth middleware</span></span>

<span data-ttu-id="16d6c-128">В этом разделе описана настройка ПО промежуточного слоя в ASP.NET Core для мультитенантной аутентификации через OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="16d6c-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="16d6c-129">В [классе запуска](/aspnet/core/fundamentals/startup) добавьте ПО промежуточного слоя для OpenID Connect:</span><span class="sxs-lookup"><span data-stu-id="16d6c-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="16d6c-130">Обратите внимание, что некоторые параметры извлекаются из конфигурации времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="16d6c-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="16d6c-131">Ниже представлено описание параметров ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-131">Here's what the middleware options mean:</span></span>

- <span data-ttu-id="16d6c-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-132">**ClientId**.</span></span> <span data-ttu-id="16d6c-133">Идентификатор клиента приложения, который был получен при регистрации приложения в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
- <span data-ttu-id="16d6c-134">**Authority**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-134">**Authority**.</span></span> <span data-ttu-id="16d6c-135">Для мультитенантного приложения установите значение `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="16d6c-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="16d6c-136">Это URL-адрес общей конечной точки Azure AD, которая позволяет выполнить вход пользователям любого клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="16d6c-137">Дополнительные сведения об этой общей конечной точке см. в [этой записи блога](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="16d6c-137">For more information about the common endpoint, see [this blog post](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
- <span data-ttu-id="16d6c-138">В разделе **TokenValidationParameters** установите для параметра **ValidateIssuer** значение false.</span><span class="sxs-lookup"><span data-stu-id="16d6c-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="16d6c-139">Это означает, что приложение будет отвечать за проверку значения издателя в маркере идентификатора.</span><span class="sxs-lookup"><span data-stu-id="16d6c-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="16d6c-140">(ПО промежуточного слоя в любом случае будет проверять сам маркер.) Дополнительные сведения см. в разделе [о проверке издателя](claims.md#issuer-validation).</span><span class="sxs-lookup"><span data-stu-id="16d6c-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
- <span data-ttu-id="16d6c-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="16d6c-142">Укажите URL-адрес для перенаправления пользователей после выхода. Он должен перенаправлять пользователей к странице, которая поддерживает анонимные запросы (обычно это страница приветствия).</span><span class="sxs-lookup"><span data-stu-id="16d6c-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
- <span data-ttu-id="16d6c-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-143">**SignInScheme**.</span></span> <span data-ttu-id="16d6c-144">Задайте для этого параметра значение `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="16d6c-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="16d6c-145">Этот параметр означает, что после проверки подлинности пользователя его утверждения локально сохраняются в файле cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="16d6c-146">Благодаря этому файлу cookie пользователь остается в системе во время сеанса браузера.</span><span class="sxs-lookup"><span data-stu-id="16d6c-146">This cookie is how the user stays logged in during the browser session.</span></span>
- <span data-ttu-id="16d6c-147">**Events.**</span><span class="sxs-lookup"><span data-stu-id="16d6c-147">**Events.**</span></span> <span data-ttu-id="16d6c-148">Обратные вызовы событий, которые описаны в разделе о [событиях проверки подлинности](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="16d6c-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="16d6c-149">Также добавьте в конвейер ПО промежуточного слоя проверки подлинности для файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="16d6c-150">Это ПО промежуточного слоя записывает утверждения пользователей в файл cookie и считывает этот файл при следующей загрузке страницы.</span><span class="sxs-lookup"><span data-stu-id="16d6c-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="16d6c-151">Инициирование потока аутентификации</span><span class="sxs-lookup"><span data-stu-id="16d6c-151">Initiate the authentication flow</span></span>

<span data-ttu-id="16d6c-152">Чтобы запустить поток проверки подлинности в ASP.NET MVC, контроллер должен вернуть действие **ChallengeResult** :</span><span class="sxs-lookup"><span data-stu-id="16d6c-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="16d6c-153">После этого ПО промежуточного слоя возвращает ответ 302 (найдено), который выполняет перенаправление к конечной точке проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="16d6c-154">Сеансы входа пользователей</span><span class="sxs-lookup"><span data-stu-id="16d6c-154">User login sessions</span></span>

<span data-ttu-id="16d6c-155">Как упоминалось выше, при первом входе пользователя в систему ПО промежуточного слоя проверки подлинности для файлов cookie записывает в файл cookie утверждения пользователя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="16d6c-156">После этого HTTP-запросы проходят проверку подлинности с помощью считывания файла cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="16d6c-157">По умолчанию ПО промежуточного слоя сохраняет [файл cookie сеанса][session-cookie], который будет удален, когда пользователь закроет браузер.</span><span class="sxs-lookup"><span data-stu-id="16d6c-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="16d6c-158">При следующем посещении сайта потребуется снова выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="16d6c-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="16d6c-159">Но если вы установите значение true для параметра **IsPersistent** в разделе **ChallengeResult**, ПО промежуточного слоя сохранит постоянный файл cookie. В таком случае пользователь остается в системе даже после закрытия браузера.</span><span class="sxs-lookup"><span data-stu-id="16d6c-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="16d6c-160">Вы можете настроить срок действия файла cookie, как описано в статье об [управлении параметрами файла cookie][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="16d6c-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="16d6c-161">Постоянные файлы cookie удобнее для пользователя, но их не следует применять в приложениях, для работы с которыми пользователь должен каждый раз выполнять вход (например, в приложениях для банковских операций).</span><span class="sxs-lookup"><span data-stu-id="16d6c-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="16d6c-162">ПО промежуточного слоя OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="16d6c-162">About the OpenID Connect middleware</span></span>

<span data-ttu-id="16d6c-163">ПО промежуточного слоя OpenID Connect в ASP.NET скрывает большую часть данных протокола.</span><span class="sxs-lookup"><span data-stu-id="16d6c-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="16d6c-164">Этот раздел содержит определенные сведения о реализации, которые помогут понять, что такое поток протокола.</span><span class="sxs-lookup"><span data-stu-id="16d6c-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="16d6c-165">Для начала рассмотрим поток проверки подлинности с точки зрения ASP.NET (не учитывая сведения потока протокола OIDC между приложением и Azure AD).</span><span class="sxs-lookup"><span data-stu-id="16d6c-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="16d6c-166">Этот процесс показан на схеме ниже.</span><span class="sxs-lookup"><span data-stu-id="16d6c-166">The following diagram shows the process.</span></span>

![Поток входа в систему](./images/sign-in-flow.png)

<span data-ttu-id="16d6c-168">Здесь представлено два контроллера MVC.</span><span class="sxs-lookup"><span data-stu-id="16d6c-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="16d6c-169">Контроллер Account обрабатывает запросы на вход, а контроллер Home обслуживает домашнюю страницу.</span><span class="sxs-lookup"><span data-stu-id="16d6c-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="16d6c-170">Ниже представлен процесс проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="16d6c-171">Пользователь нажимает кнопку "Вход", и браузер отправляет запрос GET.</span><span class="sxs-lookup"><span data-stu-id="16d6c-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="16d6c-172">Например, `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="16d6c-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="16d6c-173">Контроллер Account возвращает значение `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="16d6c-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="16d6c-174">ПО промежуточного слоя OIDC возвращает ответ HTTP 302, выполняя перенаправление в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="16d6c-175">Браузер отправляет запрос на проверку подлинности в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="16d6c-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="16d6c-176">Пользователь выполняет вход в Azure AD, и Azure AD отправляет обратно ответ после проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="16d6c-177">ПО промежуточного слоя OIDC создает субъект утверждений и передает его в ПО промежуточного слоя проверки подлинности для файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="16d6c-178">ПО промежуточного слоя для файлов cookie сериализует субъект утверждений и задает файл cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="16d6c-179">ПО промежуточного слоя OIDC выполняет перенаправление по URL-адресу обратного вызова приложения.</span><span class="sxs-lookup"><span data-stu-id="16d6c-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="16d6c-180">Браузер следует перенаправлению и отправляет в запросе файл cookie.</span><span class="sxs-lookup"><span data-stu-id="16d6c-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="16d6c-181">ПО промежуточного слоя десериализует файл cookie до субъекта утверждений и задает для `HttpContext.User` значение, равное субъекту утверждений.</span><span class="sxs-lookup"><span data-stu-id="16d6c-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="16d6c-182">Запрос перенаправляется в контроллер MVC.</span><span class="sxs-lookup"><span data-stu-id="16d6c-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="16d6c-183">Билет проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="16d6c-183">Authentication ticket</span></span>

<span data-ttu-id="16d6c-184">Если проверка подлинности прошла успешно, ПО промежуточного слоя OIDC создает билет проверки подлинности с субъектом, который содержит утверждения пользователя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="16d6c-185">Вы можете получить доступ к этому билету через событие **AuthenticationValidated** или **TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="16d6c-186">Пока не завершится выполнение всего процесса аутентификации, в `HttpContext.User` хранятся данные анонимного субъекта, а **не** авторизованного пользователя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="16d6c-187">Коллекция утверждений анонимного субъекта пуста.</span><span class="sxs-lookup"><span data-stu-id="16d6c-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="16d6c-188">После завершения проверки подлинности и перенаправления приложения ПО промежуточного слоя для файлов cookie выполняет десериализацию файла cookie проверки подлинности и задает для `HttpContext.User` значение субъекта утверждений, который представляет пользователя, прошедшего проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>

### <a name="authentication-events"></a><span data-ttu-id="16d6c-189">События проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="16d6c-189">Authentication events</span></span>

<span data-ttu-id="16d6c-190">В процессе проверки подлинности ПО промежуточного слоя OpenID Connect создает последовательность событий:</span><span class="sxs-lookup"><span data-stu-id="16d6c-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

- <span data-ttu-id="16d6c-191">**RedirectToIdentityProvider.**</span><span class="sxs-lookup"><span data-stu-id="16d6c-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="16d6c-192">Вызывается непосредственно перед тем, как ПО промежуточного слоя выполнит перенаправление в конечную точку проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="16d6c-193">Это событие можно использовать для изменения URL-адреса перенаправления (например, чтобы добавить параметры запроса).</span><span class="sxs-lookup"><span data-stu-id="16d6c-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="16d6c-194">С примером можно ознакомиться в разделе [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) (Добавление запроса на согласие администратора).</span><span class="sxs-lookup"><span data-stu-id="16d6c-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
- <span data-ttu-id="16d6c-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="16d6c-196">Вызывается с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="16d6c-196">Called with the authorization code.</span></span>
- <span data-ttu-id="16d6c-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="16d6c-198">Вызывается после того, как ПО промежуточного слоя получит маркер доступа от IdP, но до начала его проверки.</span><span class="sxs-lookup"><span data-stu-id="16d6c-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="16d6c-199">Применяется только к потоку кода авторизации.</span><span class="sxs-lookup"><span data-stu-id="16d6c-199">Applies only to authorization code flow.</span></span>
- <span data-ttu-id="16d6c-200">**TokenValidated.**</span><span class="sxs-lookup"><span data-stu-id="16d6c-200">**TokenValidated**.</span></span> <span data-ttu-id="16d6c-201">Вызывается после того, как ПО промежуточного слоя проверит маркер идентификатора.</span><span class="sxs-lookup"><span data-stu-id="16d6c-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="16d6c-202">На этом этапе приложение уже имеет набор проверенных утверждений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="16d6c-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="16d6c-203">Это событие можно использовать для дополнительных процедур проверки или преобразования таких утверждений.</span><span class="sxs-lookup"><span data-stu-id="16d6c-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="16d6c-204">См. статью о [работе с утверждениями](claims.md).</span><span class="sxs-lookup"><span data-stu-id="16d6c-204">See [Working with claims](claims.md).</span></span>
- <span data-ttu-id="16d6c-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-205">**UserInformationReceived**.</span></span> <span data-ttu-id="16d6c-206">Вызывается, если ПО промежуточного слоя получает профиль пользователя из конечной точки сведений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="16d6c-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="16d6c-207">Применяется только к потоку кода авторизации и только если в параметрах ПО промежуточного слоя установлено значение `GetClaimsFromUserInfoEndpoint = true` .</span><span class="sxs-lookup"><span data-stu-id="16d6c-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
- <span data-ttu-id="16d6c-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-208">**TicketReceived**.</span></span> <span data-ttu-id="16d6c-209">Вызывается при завершении проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-209">Called when authentication is completed.</span></span> <span data-ttu-id="16d6c-210">Это последнее событие, при условии что проверка подлинности завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="16d6c-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="16d6c-211">После обработки этого события пользователь входит в приложение.</span><span class="sxs-lookup"><span data-stu-id="16d6c-211">After this event is handled, the user is signed into the app.</span></span>
- <span data-ttu-id="16d6c-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="16d6c-213">Вызывается, если пользователь не проходит проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="16d6c-213">Called if authentication fails.</span></span> <span data-ttu-id="16d6c-214">Это событие используется для обработки ошибок аутентификации, например для перенаправления на страницу ошибки.</span><span class="sxs-lookup"><span data-stu-id="16d6c-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="16d6c-215">Чтобы предоставить функции обратного вызова для этих событий, настройте параметр **События** в ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="16d6c-216">Объявить обработчики событий можно двумя способами: встроенное объявление с лямбда-выражениями или объявление в классе, производном от **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="16d6c-217">Если при обратных вызовах событий выполняются существенные фрагменты логики, рекомендуем использовать второй подход, чтобы код не загромождал класс запуска.</span><span class="sxs-lookup"><span data-stu-id="16d6c-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="16d6c-218">Мы применили этот подход в нашей эталонной реализации.</span><span class="sxs-lookup"><span data-stu-id="16d6c-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="16d6c-219">Конечные точки OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="16d6c-219">OpenID connect endpoints</span></span>

<span data-ttu-id="16d6c-220">Azure AD поддерживает функцию [обнаружения OpenID Connect](https://openid.net/specs/openid-connect-discovery-1_0.html), при использовании которой поставщик удостоверений (IDP) возвращает документ метаданных в формате JSON через [известную конечную точку](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="16d6c-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="16d6c-221">Документ метаданных содержит указанные ниже сведения.</span><span class="sxs-lookup"><span data-stu-id="16d6c-221">The metadata document contains information such as:</span></span>

- <span data-ttu-id="16d6c-222">URL-адрес конечной точки авторизации.</span><span class="sxs-lookup"><span data-stu-id="16d6c-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="16d6c-223">Это расположение, в которое приложение выполняет перенаправление для проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-223">This is where the app redirects to authenticate the user.</span></span>
- <span data-ttu-id="16d6c-224">URL-адрес конечной точки "конец сеанса", где приложение переходит к выполнению выхода пользователя из системы.</span><span class="sxs-lookup"><span data-stu-id="16d6c-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
- <span data-ttu-id="16d6c-225">URL-адрес получения ключей подписывания, которые клиент использует для проверки маркеров OIDC, полученных от поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="16d6c-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="16d6c-226">По умолчанию ПО промежуточного слоя OIDC имеет сведения о том, как получить эти метаданные.</span><span class="sxs-lookup"><span data-stu-id="16d6c-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="16d6c-227">Задайте параметр **Центр** в ПО промежуточного слоя, и оно сформирует URL-адрес для метаданных.</span><span class="sxs-lookup"><span data-stu-id="16d6c-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="16d6c-228">(URL-адрес метаданных можно переопределить, задав параметр **MetadataAddress** .)</span><span class="sxs-lookup"><span data-stu-id="16d6c-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="16d6c-229">Потоки OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="16d6c-229">OpenID connect flows</span></span>

<span data-ttu-id="16d6c-230">По умолчанию ПО промежуточного слоя OIDC использует гибридный поток с режимом ответа на отправку формы.</span><span class="sxs-lookup"><span data-stu-id="16d6c-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

- <span data-ttu-id="16d6c-231">*Гибридный поток* означает, что клиент может получить маркер идентификатора и код авторизации в одном процессе обмена данными с сервером авторизации.</span><span class="sxs-lookup"><span data-stu-id="16d6c-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
- <span data-ttu-id="16d6c-232">*Режим ответа на отправку формы* означает, что сервер авторизации использует HTTP-запрос POST для отправки маркера идентификатора и кода авторизации для приложения.</span><span class="sxs-lookup"><span data-stu-id="16d6c-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="16d6c-233">Значения представлены в закодированном формате URL-адреса (тип содержимого = application/x-www-form-urlencoded).</span><span class="sxs-lookup"><span data-stu-id="16d6c-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="16d6c-234">Когда ПО промежуточного слоя OIDC выполняет перенаправление в конечную точку авторизации, URL-адрес перенаправления включает все требующиеся для OIDC параметры строки запроса.</span><span class="sxs-lookup"><span data-stu-id="16d6c-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="16d6c-235">Для гибридных потоков:</span><span class="sxs-lookup"><span data-stu-id="16d6c-235">For hybrid flow:</span></span>

- <span data-ttu-id="16d6c-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="16d6c-236">client_id.</span></span> <span data-ttu-id="16d6c-237">Это значение устанавливается для параметра **ClientId** .</span><span class="sxs-lookup"><span data-stu-id="16d6c-237">This value is set in the **ClientId** option</span></span>
- <span data-ttu-id="16d6c-238">scope = "openid profile" — это означает, что выполняется запрос OIDC и нам следует использовать профиль пользователя.</span><span class="sxs-lookup"><span data-stu-id="16d6c-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
- <span data-ttu-id="16d6c-239">response_type  = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="16d6c-239">response_type  = "code id_token".</span></span> <span data-ttu-id="16d6c-240">Определяет гибридный поток.</span><span class="sxs-lookup"><span data-stu-id="16d6c-240">This specifies hybrid flow.</span></span>
- <span data-ttu-id="16d6c-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="16d6c-241">response_mode = "form_post".</span></span> <span data-ttu-id="16d6c-242">Определяет ответ на отправку формы.</span><span class="sxs-lookup"><span data-stu-id="16d6c-242">This specifies form post response.</span></span>

<span data-ttu-id="16d6c-243">Чтобы указать другой поток, в параметрах задайте свойство **ResponseType**.</span><span class="sxs-lookup"><span data-stu-id="16d6c-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="16d6c-244">Например: </span><span class="sxs-lookup"><span data-stu-id="16d6c-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="16d6c-245">[**Далее**][claims]</span><span class="sxs-lookup"><span data-stu-id="16d6c-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
