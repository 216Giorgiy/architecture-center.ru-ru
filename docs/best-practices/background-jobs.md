---
title: Руководство по фоновым заданиям
description: Руководство по использованию фоновых задач, выполняемых независимо от пользовательского интерфейса.
author: dragon119
ms.date: 05/24/2017
pnp.series.title: Best Practices
ms.openlocfilehash: 57fd7a6cc400b53e51e08fb5a1377dce4ae61327
ms.sourcegitcommit: e9eb2b895037da0633ef3ccebdea2fcce047620f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2018
ms.locfileid: "50251929"
---
# <a name="background-jobs"></a><span data-ttu-id="c13ba-103">Фоновые задания</span><span class="sxs-lookup"><span data-stu-id="c13ba-103">Background jobs</span></span>
[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="c13ba-104">Многим типам приложений требуются фоновые задачи, которые выполняются независимо от пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="c13ba-104">Many types of applications require background tasks that run independently of the user interface (UI).</span></span> <span data-ttu-id="c13ba-105">К примерам относятся пакетные задания, ресурсоемкие задачи обработки и длительные процессы, например рабочие процессы.</span><span class="sxs-lookup"><span data-stu-id="c13ba-105">Examples include batch jobs, intensive processing tasks, and long-running processes such as workflows.</span></span> <span data-ttu-id="c13ba-106">Фоновые задания могут выполняться без вмешательства пользователя. Приложение может запустить задание, а затем продолжить обработку интерактивных запросов пользователей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-106">Background jobs can be executed without requiring user interaction--the application can start the job and then continue to process interactive requests from users.</span></span> <span data-ttu-id="c13ba-107">Это поможет свести к минимуму нагрузку на пользовательский интерфейс приложения, что может увеличить доступность и сократить время интерактивного отклика приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-107">This can help to minimize the load on the application UI, which can improve availability and reduce interactive response times.</span></span>

<span data-ttu-id="c13ba-108">Например, если приложению требуется создавать эскизы рисунков, передаваемых пользователями, оно может делать это как фоновое задание, после чего сохранять эскизы в хранилище, не вынуждая пользователя ожидать, пока процесс будет завершен.</span><span class="sxs-lookup"><span data-stu-id="c13ba-108">For example, if an application is required to generate thumbnails of images that are uploaded by users, it can do this as a background job and save the thumbnail to storage when it is complete--without the user needing to wait for the process to be completed.</span></span> <span data-ttu-id="c13ba-109">Точно так же пользователь, размещающий заказ, может запустить фоновый рабочий процесс, который обрабатывает заказ, а с помощью пользовательского интерфейса пользователь может продолжить просмотр веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-109">In the same way, a user placing an order can initiate a background workflow that processes the order, while the UI allows the user to continue browsing the web app.</span></span> <span data-ttu-id="c13ba-110">По завершении фонового задания оно может обновить хранимые данные заказов и отправить пользователю электронное сообщение, подтверждающее заказ.</span><span class="sxs-lookup"><span data-stu-id="c13ba-110">When the background job is complete, it can update the stored orders data and send an email to the user that confirms the order.</span></span>

<span data-ttu-id="c13ba-111">При выборе реализации в виде задачи или фонового задания основной критерий — может ли задача выполняться без взаимодействия с пользователем и должен ли пользовательский интерфейс ожидать завершения задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-111">When you consider whether to implement a task as a background job, the main criteria is whether the task can run without user interaction and without the UI needing to wait for the job to be completed.</span></span> <span data-ttu-id="c13ba-112">Задачи, требующие, чтобы пользователь или пользовательский интерфейс ожидал, пока они выполняются, не подходят для фоновых заданий.</span><span class="sxs-lookup"><span data-stu-id="c13ba-112">Tasks that require the user or the UI to wait while they are completed might not be appropriate as background jobs.</span></span>

## <a name="types-of-background-jobs"></a><span data-ttu-id="c13ba-113">Типы фоновых заданий</span><span class="sxs-lookup"><span data-stu-id="c13ba-113">Types of background jobs</span></span>
<span data-ttu-id="c13ba-114">Фоновые задания обычно включают одно или несколько заданий следующих типов:</span><span class="sxs-lookup"><span data-stu-id="c13ba-114">Background jobs typically include one or more of the following types of jobs:</span></span>

* <span data-ttu-id="c13ba-115">Задания, интенсивно использующие ЦП, например математические вычисления или анализ структурных моделей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-115">CPU-intensive jobs, such as mathematical calculations or structural model analysis.</span></span>
* <span data-ttu-id="c13ba-116">Задания с большим объемом операций ввода-вывода, например, выполняющие циклы транзакций с хранилищем или индексирование файлов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-116">I/O-intensive jobs, such as executing a series of storage transactions or indexing files.</span></span>
* <span data-ttu-id="c13ba-117">Пакетные задания, например обновление данных каждую ночь или обработка по расписанию.</span><span class="sxs-lookup"><span data-stu-id="c13ba-117">Batch jobs, such as nightly data updates or scheduled processing.</span></span>
* <span data-ttu-id="c13ba-118">Продолжительные рабочие процессы, например выполнение заказов или подготовка служб и систем.</span><span class="sxs-lookup"><span data-stu-id="c13ba-118">Long-running workflows, such as order fulfillment, or provisioning services and systems.</span></span>
* <span data-ttu-id="c13ba-119">Обработка конфиденциальных данных, при которой задача для обработки передается в более безопасное место.</span><span class="sxs-lookup"><span data-stu-id="c13ba-119">Sensitive-data processing where the task is handed off to a more secure location for processing.</span></span> <span data-ttu-id="c13ba-120">Например, вы можете не желать обрабатывать конфиденциальные данные в веб-приложении,</span><span class="sxs-lookup"><span data-stu-id="c13ba-120">For example, you might not want to process sensitive data within a web app.</span></span> <span data-ttu-id="c13ba-121">а вместо этого использовать шаблон, например шаблон [привратника](https://msdn.microsoft.com/library/dn589793.aspx), чтобы передавать данные в изолированный фоновый процесс, имеющий доступ к защищенному хранилищу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-121">Instead, you might use a pattern such as [Gatekeeper](https://msdn.microsoft.com/library/dn589793.aspx) to transfer the data to an isolated background process that has access to protected storage.</span></span>

## <a name="triggers"></a><span data-ttu-id="c13ba-122">триггеры;</span><span class="sxs-lookup"><span data-stu-id="c13ba-122">Triggers</span></span>
<span data-ttu-id="c13ba-123">Фоновые задания могут запускаться несколькими различными способами.</span><span class="sxs-lookup"><span data-stu-id="c13ba-123">Background jobs can be initiated in several different ways.</span></span> <span data-ttu-id="c13ba-124">Каждый из них можно отнести к одной из следующих категорий:</span><span class="sxs-lookup"><span data-stu-id="c13ba-124">They fall into one of the following categories:</span></span>

* <span data-ttu-id="c13ba-125">[**Запуск при определенном событии**](#event-driven-triggers).</span><span class="sxs-lookup"><span data-stu-id="c13ba-125">[**Event-driven triggers**](#event-driven-triggers).</span></span> <span data-ttu-id="c13ba-126">Задача запускается в ответ на событие — обычно действие, выполненное пользователем, или шаг в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="c13ba-126">The task is started in response to an event, typically an action taken by a user or a step in a workflow.</span></span>
* <span data-ttu-id="c13ba-127">[**Триггеры, управляемые расписанием**](#schedule-driven-triggers).</span><span class="sxs-lookup"><span data-stu-id="c13ba-127">[**Schedule-driven triggers**](#schedule-driven-triggers).</span></span> <span data-ttu-id="c13ba-128">Задача вызывается по расписанию на основе таймера.</span><span class="sxs-lookup"><span data-stu-id="c13ba-128">The task is invoked on a schedule based on a timer.</span></span> <span data-ttu-id="c13ba-129">Это может быть повторяющееся расписание или одноразовый вызов, указанный на более позднее время.</span><span class="sxs-lookup"><span data-stu-id="c13ba-129">This might be a recurring schedule or a one-off invocation that is specified for a later time.</span></span>

### <a name="event-driven-triggers"></a><span data-ttu-id="c13ba-130">Запуск при определенном событии</span><span class="sxs-lookup"><span data-stu-id="c13ba-130">Event-driven triggers</span></span>
<span data-ttu-id="c13ba-131">При управляемом событиями вызове для запуска фоновой задачи используется триггер.</span><span class="sxs-lookup"><span data-stu-id="c13ba-131">Event-driven invocation uses a trigger to start the background task.</span></span> <span data-ttu-id="c13ba-132">Примеры использования триггеров, управляемых событиями:</span><span class="sxs-lookup"><span data-stu-id="c13ba-132">Examples of using event-driven triggers include:</span></span>

* <span data-ttu-id="c13ba-133">Пользовательский интерфейс или другое задание помещает сообщение в очередь.</span><span class="sxs-lookup"><span data-stu-id="c13ba-133">The UI or another job places a message in a queue.</span></span> <span data-ttu-id="c13ba-134">Сообщение содержит данные о действии, которое было выполнено, например: пользователь разместил заказ.</span><span class="sxs-lookup"><span data-stu-id="c13ba-134">The message contains data about an action that has taken place, such as the user placing an order.</span></span> <span data-ttu-id="c13ba-135">Фоновая задача прослушивает эту очередь и обнаруживает поступление нового сообщения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-135">The background task listens on this queue and detects the arrival of a new message.</span></span> <span data-ttu-id="c13ba-136">Она считывает сообщение и использует его в качестве входных данных для фонового задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-136">It reads the message and uses the data in it as the input to the background job.</span></span>
* <span data-ttu-id="c13ba-137">Пользовательский интерфейс или другое задание сохраняет или обновляет значение в хранилище.</span><span class="sxs-lookup"><span data-stu-id="c13ba-137">The UI or another job saves or updates a value in storage.</span></span> <span data-ttu-id="c13ba-138">Фоновая задача отслеживает хранилище и обнаруживает изменения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-138">The background task monitors the storage and detects changes.</span></span> <span data-ttu-id="c13ba-139">Она считывает данные и использует их в качестве входных данных для фонового задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-139">It reads the data and uses it as the input to the background job.</span></span>
* <span data-ttu-id="c13ba-140">Пользовательский интерфейс или другое задание выполняет запрос к конечной точке (по универсальному коду ресурса (URI) HTTPS) или API, предоставляемому как веб-служба.</span><span class="sxs-lookup"><span data-stu-id="c13ba-140">The UI or another job makes a request to an endpoint, such as an HTTPS URI, or an API that is exposed as a web service.</span></span> <span data-ttu-id="c13ba-141">В запросе передаются данные, необходимые для выполнения фоновой задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-141">It passes the data that is required to complete the background task as part of the request.</span></span> <span data-ttu-id="c13ba-142">Конечная точка или веб-служба вызывает фоновую задачу, которая использует эти данные в качестве входных.</span><span class="sxs-lookup"><span data-stu-id="c13ba-142">The endpoint or web service invokes the background task, which uses the data as its input.</span></span>

<span data-ttu-id="c13ba-143">Типичные примеры задач, подходящих для управляемого событиями вызовами: обработка изображений, рабочие процессы, отправка информации в удаленные службы, отправка электронных сообщений и подготовка новых пользователей в многопользовательских приложениях.</span><span class="sxs-lookup"><span data-stu-id="c13ba-143">Typical examples of tasks that are suited to event-driven invocation include image processing, workflows, sending information to remote services, sending email messages, and provisioning new users in multitenant applications.</span></span>

### <a name="schedule-driven-triggers"></a><span data-ttu-id="c13ba-144">Триггеры, управляемые расписанием</span><span class="sxs-lookup"><span data-stu-id="c13ba-144">Schedule-driven triggers</span></span>
<span data-ttu-id="c13ba-145">При управляемом расписанием вызове для запуска фоновой задачи используется таймер.</span><span class="sxs-lookup"><span data-stu-id="c13ba-145">Schedule-driven invocation uses a timer to start the background task.</span></span> <span data-ttu-id="c13ba-146">Примеры использования управляемых расписанием триггеров:</span><span class="sxs-lookup"><span data-stu-id="c13ba-146">Examples of using schedule-driven triggers include:</span></span>

* <span data-ttu-id="c13ba-147">Таймер, выполняемый локально в приложении или в его операционной системе, вызывает фоновую задачу на регулярной основе.</span><span class="sxs-lookup"><span data-stu-id="c13ba-147">A timer that is running locally within the application or as part of the application’s operating system invokes a background task on a regular basis.</span></span>
* <span data-ttu-id="c13ba-148">Таймер, выполняемый в другом приложении, или служба таймера, например планировщик Azure, отправляет запрос к API или веб-службе на регулярной основе.</span><span class="sxs-lookup"><span data-stu-id="c13ba-148">A timer that is running in a different application, or a timer service such as Azure Scheduler, sends a request to an API or web service on a regular basis.</span></span> <span data-ttu-id="c13ba-149">API или веб-служба вызывает фоновую задачу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-149">The API or web service invokes the background task.</span></span>
* <span data-ttu-id="c13ba-150">Отдельный процесс или приложение запускает таймер, который вызывает фоновую задачу по истечении указанного времени задержки или в определенное время.</span><span class="sxs-lookup"><span data-stu-id="c13ba-150">A separate process or application starts a timer that causes the background task to be invoked once after a specified time delay, or at a specific time.</span></span>

<span data-ttu-id="c13ba-151">Типичные примеры задач, подходящих для управляемого расписанием вызова: подпрограммы пакетной обработки, например обновление списков связанных продуктов для пользователей на основе их последнего поведения, стандартные задачи обработки данных, например обновление индексов или формирование накопленных результатов, анализ данных для ежедневных отчетов, очистка хранения данных и проверка согласованности данных.</span><span class="sxs-lookup"><span data-stu-id="c13ba-151">Typical examples of tasks that are suited to schedule-driven invocation include batch-processing routines (such as updating related-products lists for users based on their recent behavior), routine data processing tasks (such as updating indexes or generating accumulated results), data analysis for daily reports, data retention cleanup, and data consistency checks.</span></span>

<span data-ttu-id="c13ba-152">При использовании управляемой расписанием задачи, которая должна выполняться как единственный экземпляр, надо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="c13ba-152">If you use a schedule-driven task that must run as a single instance, be aware of the following:</span></span>

* <span data-ttu-id="c13ba-153">Если вычислительный экземпляр, в котором выполняется планировщик (например виртуальная машина с планировщиком заданий Windows), масштабируется, у вас будет выполняться несколько экземпляров планировщика,</span><span class="sxs-lookup"><span data-stu-id="c13ba-153">If the compute instance that is running the scheduler (such as a virtual machine using Windows scheduled tasks) is scaled, you will have multiple instances of the scheduler running.</span></span> <span data-ttu-id="c13ba-154">что может привести к запуску нескольких экземпляров задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-154">These could start multiple instances of the task.</span></span>
* <span data-ttu-id="c13ba-155">Если длительность выполнения задач превышает период между событиями планировщика, планировщик может запустить еще один экземпляр задачи, когда предыдущий еще выполняется.</span><span class="sxs-lookup"><span data-stu-id="c13ba-155">If tasks run for longer than the period between scheduler events, the scheduler may start another instance of the task while the previous one is still running.</span></span>

## <a name="returning-results"></a><span data-ttu-id="c13ba-156">Возвращение результатов</span><span class="sxs-lookup"><span data-stu-id="c13ba-156">Returning results</span></span>
<span data-ttu-id="c13ba-157">Фоновые задания выполняются асинхронно в отдельном процессе или даже отдельном расположении, из пользовательского интерфейса или процесса, который вызывает фоновое задание.</span><span class="sxs-lookup"><span data-stu-id="c13ba-157">Background jobs execute asynchronously in a separate process, or even in a separate location, from the UI or the process that invoked the background task.</span></span> <span data-ttu-id="c13ba-158">В идеальном случае фоновые задачи — это операции типа «отправить и забыть», и их выполнение не оказывает влияния на пользовательский интерфейс или вызывающий процесс.</span><span class="sxs-lookup"><span data-stu-id="c13ba-158">Ideally, background tasks are “fire and forget” operations, and their execution progress has no impact on the UI or the calling process.</span></span> <span data-ttu-id="c13ba-159">Это означает, что вызывающий процесс не ждет завершения задач</span><span class="sxs-lookup"><span data-stu-id="c13ba-159">This means that the calling process does not wait for completion of the tasks.</span></span> <span data-ttu-id="c13ba-160">и, следовательно, не может обнаружить автоматически, когда задача завершена.</span><span class="sxs-lookup"><span data-stu-id="c13ba-160">Therefore, it cannot automatically detect when the task ends.</span></span>

<span data-ttu-id="c13ba-161">Если требуется связать фоновую задачу с вызывающей задачей, чтобы она сообщала о ходе выполнения или завершении, для этого необходимо реализовать механизм.</span><span class="sxs-lookup"><span data-stu-id="c13ba-161">If you require a background task to communicate with the calling task to indicate progress or completion, you must implement a mechanism for this.</span></span> <span data-ttu-id="c13ba-162">Ниже приведены некоторые примеры.</span><span class="sxs-lookup"><span data-stu-id="c13ba-162">Some examples are:</span></span>

* <span data-ttu-id="c13ba-163">Значение индикатора состояния записи в хранилище, доступное в пользовательском интерфейсе или вызывающей задаче, которая может отслеживать или проверять это значение при необходимости.</span><span class="sxs-lookup"><span data-stu-id="c13ba-163">Write a status indicator value to storage that is accessible to the UI or caller task, which can monitor or check this value when required.</span></span> <span data-ttu-id="c13ba-164">Другие данные, которые фоновая задача должна возвращать вызывающей стороне, могут помещаться в то же хранилище.</span><span class="sxs-lookup"><span data-stu-id="c13ba-164">Other data that the background task must return to the caller can be placed into the same storage.</span></span>
* <span data-ttu-id="c13ba-165">Создание очереди ответов, которую прослушивает пользовательский интерфейс или вызывающая задача.</span><span class="sxs-lookup"><span data-stu-id="c13ba-165">Establish a reply queue that the UI or caller listens on.</span></span> <span data-ttu-id="c13ba-166">Фоновая задача может отправлять сообщения в очередь, сообщая о состоянии и завершении.</span><span class="sxs-lookup"><span data-stu-id="c13ba-166">The background task can send messages to the queue that indicate status and completion.</span></span> <span data-ttu-id="c13ba-167">Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в сообщениях.</span><span class="sxs-lookup"><span data-stu-id="c13ba-167">Data that the background task must return to the caller can be placed into the messages.</span></span> <span data-ttu-id="c13ba-168">Если вы используете служебную шину Azure, то для реализации этой возможности можно использовать свойства **ReplyTo** и **CorrelationId**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-168">If you are using Azure Service Bus, you can use the **ReplyTo** and **CorrelationId** properties to implement this capability.</span></span>
* <span data-ttu-id="c13ba-169">Предоставление из фоновой задачи API или конечной точки, к которой может обратиться пользовательский интерфейс или вызывающая задача, чтобы получить информацию о состоянии.</span><span class="sxs-lookup"><span data-stu-id="c13ba-169">Expose an API or endpoint from the background task that the UI or caller can access to obtain status information.</span></span> <span data-ttu-id="c13ba-170">Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в ответе.</span><span class="sxs-lookup"><span data-stu-id="c13ba-170">Data that the background task must return to the caller can be included in the response.</span></span>
* <span data-ttu-id="c13ba-171">Фоновая задача выполняет обратный вызов пользовательского интерфейса или вызывающей задачи через API, чтобы сообщить о состоянии в предопределенных точках или о завершении.</span><span class="sxs-lookup"><span data-stu-id="c13ba-171">Have the background task call back to the UI or caller through an API to indicate status at predefined points or on completion.</span></span> <span data-ttu-id="c13ba-172">Это может быть реализовано через локальные события или с помощью механизма публикации и подписки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-172">This might be through events raised locally or through a publish-and-subscribe mechanism.</span></span> <span data-ttu-id="c13ba-173">Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в запросе или полезных данных событий.</span><span class="sxs-lookup"><span data-stu-id="c13ba-173">Data that the background task must return to the caller can be included in the request or event payload.</span></span>

## <a name="hosting-environment"></a><span data-ttu-id="c13ba-174">Среда размещения</span><span class="sxs-lookup"><span data-stu-id="c13ba-174">Hosting environment</span></span>
<span data-ttu-id="c13ba-175">Вы можете размещать фоновые задачи с помощью ряда разных служб платформы Azure:</span><span class="sxs-lookup"><span data-stu-id="c13ba-175">You can host background tasks by using a range of different Azure platform services:</span></span>

* <span data-ttu-id="c13ba-176">[**Веб-приложения Azure и веб-задания**](#azure-web-apps-and-webjobs).</span><span class="sxs-lookup"><span data-stu-id="c13ba-176">[**Azure Web Apps and WebJobs**](#azure-web-apps-and-webjobs).</span></span> <span data-ttu-id="c13ba-177">Вы можете использовать веб-задания, чтобы выполнять пользовательские задания на основе диапазона различных типов сценариев или исполняемых файлов в контексте веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-177">You can use WebJobs to execute custom jobs based on a range of different types of scripts or executable programs within the context of a web app.</span></span>
* <span data-ttu-id="c13ba-178">[**Виртуальные машины Azure**](#azure-virtual-machines).</span><span class="sxs-lookup"><span data-stu-id="c13ba-178">[**Azure Virtual Machines**](#azure-virtual-machines).</span></span> <span data-ttu-id="c13ba-179">Если вы используете службу Windows или хотите использовать планировщик заданий Windows, обычно для размещения фоновых задач используется выделенная виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="c13ba-179">If you have a Windows service or want to use the Windows Task Scheduler, it is common to host your background tasks within a dedicated virtual machine.</span></span>
* <span data-ttu-id="c13ba-180">[**Пакетная служба Azure**](#azure-batch).</span><span class="sxs-lookup"><span data-stu-id="c13ba-180">[**Azure Batch**](#azure-batch).</span></span> <span data-ttu-id="c13ba-181">Пакетная служба — это платформа, которая позволяет запланировать выполнение ресурсоемких вычислений в управляемой коллекции виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="c13ba-181">Batch is a platform service that schedules compute-intensive work to run on a managed collection of virtual machines.</span></span> <span data-ttu-id="c13ba-182">Она поддерживает автоматическое масштабирование вычислительных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-182">It can automatically scale compute resources.</span></span>
* <span data-ttu-id="c13ba-183">[**Служба контейнеров Azure.**](#azure-container-service)</span><span class="sxs-lookup"><span data-stu-id="c13ba-183">[**Azure Container Service**](#azure-container-service).</span></span> <span data-ttu-id="c13ba-184">Служба контейнеров Azure предоставляет среду для размещения контейнеров в Azure.</span><span class="sxs-lookup"><span data-stu-id="c13ba-184">Azure Container Service provides a container hosting environment on Azure.</span></span> 
* <span data-ttu-id="c13ba-185">[**Облачные службы Azure.**](#azure-cloud-services)</span><span class="sxs-lookup"><span data-stu-id="c13ba-185">[**Azure Cloud Services**](#azure-cloud-services).</span></span> <span data-ttu-id="c13ba-186">Можно написать код в роли, которая выполняется как фоновая задача.</span><span class="sxs-lookup"><span data-stu-id="c13ba-186">You can write code within a role that executes as a background task.</span></span>

<span data-ttu-id="c13ba-187">В следующих разделах более подробно описан каждый из этих вариантов, а также приведены рекомендации по их выбору.</span><span class="sxs-lookup"><span data-stu-id="c13ba-187">The following sections describe each of these options in more detail, and include considerations to help you choose the appropriate option.</span></span>

### <a name="azure-web-apps-and-webjobs"></a><span data-ttu-id="c13ba-188">Веб-приложения Azure и веб-задания</span><span class="sxs-lookup"><span data-stu-id="c13ba-188">Azure Web Apps and WebJobs</span></span>

<span data-ttu-id="c13ba-189">Вы можете использовать веб-задания Azure для выполнения пользовательских заданий как фоновых задач в веб-приложении Azure.</span><span class="sxs-lookup"><span data-stu-id="c13ba-189">You can use Azure WebJobs to execute custom jobs as background tasks within an Azure Web App.</span></span> <span data-ttu-id="c13ba-190">Веб-задания выполняются в контексте веб-приложения непрерывно</span><span class="sxs-lookup"><span data-stu-id="c13ba-190">WebJobs run within the context of your web app as a continuous process.</span></span> <span data-ttu-id="c13ba-191">или в ответ на событие триггера из планировщика Azure либо на какие-либо внешние факторы, например изменения в хранилище больших двоичных объектов и очередях сообщений.</span><span class="sxs-lookup"><span data-stu-id="c13ba-191">WebJobs also run in response to a trigger event from Azure Scheduler or external factors, such as changes to storage blobs and message queues.</span></span> <span data-ttu-id="c13ba-192">Задания можно запускать и останавливать по запросу, а также корректно завершать.</span><span class="sxs-lookup"><span data-stu-id="c13ba-192">Jobs can be started and stopped on demand, and shut down gracefully.</span></span> <span data-ttu-id="c13ba-193">При сбое непрерывно выполняемого веб-задания оно автоматически перезапускается.</span><span class="sxs-lookup"><span data-stu-id="c13ba-193">If a continuously running WebJob fails, it is automatically restarted.</span></span> <span data-ttu-id="c13ba-194">Действия при повторной попытке и ошибке можно настраивать.</span><span class="sxs-lookup"><span data-stu-id="c13ba-194">Retry and error actions are configurable.</span></span>

<span data-ttu-id="c13ba-195">При настройке веб-задания:</span><span class="sxs-lookup"><span data-stu-id="c13ba-195">When you configure a WebJob:</span></span>

* <span data-ttu-id="c13ba-196">Если требуется, чтобы задание реагировало на управляемый событиями триггер, необходимо выбрать параметр **Выполнять непрерывно**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-196">If you want the job to respond to an event-driven trigger, you should configure it as **Run continuously**.</span></span> <span data-ttu-id="c13ba-197">Сценарий или программа хранится в папке site/wwwroot/app_data/jobs/continuous.</span><span class="sxs-lookup"><span data-stu-id="c13ba-197">The script or program is stored in the folder named site/wwwroot/app_data/jobs/continuous.</span></span>
* <span data-ttu-id="c13ba-198">Если требуется, чтобы задание реагировало на триггер, управляемый событиями, необходимо выбрать параметр **Выполнять по расписанию**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-198">If you want the job to respond to a schedule-driven trigger, you should configure it as **Run on a schedule**.</span></span> <span data-ttu-id="c13ba-199">Сценарий или программа хранится в папке site/wwwroot/app_data/jobs/triggered.</span><span class="sxs-lookup"><span data-stu-id="c13ba-199">The script or program is stored in the folder named site/wwwroot/app_data/jobs/triggered.</span></span>
* <span data-ttu-id="c13ba-200">Если при настройке задания выбрать параметр **Выполнять по требованию**, оно будет выполнять тот же код, что и параметр **Выполнять по расписанию**, когда вы его запустите.</span><span class="sxs-lookup"><span data-stu-id="c13ba-200">If you choose the **Run on demand** option when you configure a job, it will execute the same code as the **Run on a schedule** option when you start it.</span></span>

<span data-ttu-id="c13ba-201">Веб-задания Azure выполняются в песочнице веб-приложения,</span><span class="sxs-lookup"><span data-stu-id="c13ba-201">Azure WebJobs run within the sandbox of the web app.</span></span> <span data-ttu-id="c13ba-202">а значит, они могут обращаться к переменным среды и обмениваться с веб-приложением такой информацией, как строки подключения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-202">This means that they can access environment variables and share information, such as connection strings, with the web app.</span></span> <span data-ttu-id="c13ba-203">Задание имеет доступ к уникальному идентификатору компьютера, на котором оно выполняется.</span><span class="sxs-lookup"><span data-stu-id="c13ba-203">The job has access to the unique identifier of the machine that is running the job.</span></span> <span data-ttu-id="c13ba-204">Строка подключения **AzureWebJobsStorage** предоставляет доступ к очередям, большим двоичным объектам и таблицам службы хранилища Azure для обращения к данным приложений, а также к служебной шине для обмена данными и сообщениями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-204">The connection string named **AzureWebJobsStorage** provides access to Azure storage queues, blobs, and tables for application data, and access to Service Bus for messaging and communication.</span></span> <span data-ttu-id="c13ba-205">Строка подключения **AzureWebJobsStorage** обеспечивает доступ к файлам журнала действий задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-205">The connection string named **AzureWebJobsDashboard** provides access to the job action log files.</span></span>

<span data-ttu-id="c13ba-206">Веб-задания Azure обладают следующими характеристиками:</span><span class="sxs-lookup"><span data-stu-id="c13ba-206">Azure WebJobs have the following characteristics:</span></span>

* <span data-ttu-id="c13ba-207">**Безопасность**: веб-задания защищены с помощью учетных данных развертывания веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-207">**Security**: WebJobs are protected by the deployment credentials of the web app.</span></span>
* <span data-ttu-id="c13ba-208">**Поддерживаемые типы файлов**: веб-задания можно определять с помощью командных скриптов (CMD-файлы), пакетных файлов (BAT-файлы), сценариев PowerShell (PS1-файлы), скриптов оболочки Bash (SH-файлы), скриптов PHP (PHP-файлы), скриптов Python (PY-файлы), кода JavaScript (JS-файлы) и исполняемых программ (EXE-, JAR-файлы и многие другие).</span><span class="sxs-lookup"><span data-stu-id="c13ba-208">**Supported file types**: You can define WebJobs by using command scripts (.cmd), batch files (.bat), PowerShell scripts (.ps1), bash shell scripts (.sh), PHP scripts (.php), Python scripts (.py), JavaScript code (.js), and executable programs (.exe, .jar, and more).</span></span>
* <span data-ttu-id="c13ba-209">**Развертывание**: сценарии и исполняемые файлы можно развертывать с помощью [портала Azure](/azure/app-service-web/web-sites-create-web-jobs), [Visual Studio](/azure/app-service-web/websites-dotnet-deploy-webjobs), [пакета SDK для Azure для веб-заданий](/azure/app-service/webjobs-sdk-get-started) или посредством прямого копирования в следующие расположения:</span><span class="sxs-lookup"><span data-stu-id="c13ba-209">**Deployment**: You can deploy scripts and executables by using the [Azure portal](/azure/app-service-web/web-sites-create-web-jobs), by using [Visual Studio](/azure/app-service-web/websites-dotnet-deploy-webjobs), by using the [Azure WebJobs SDK](/azure/app-service/webjobs-sdk-get-started), or by copying them directly to the following locations:</span></span>
  * <span data-ttu-id="c13ba-210">Для выполнения по триггеру: site/wwwroot/app_data/jobs/triggered/{имя задания}</span><span class="sxs-lookup"><span data-stu-id="c13ba-210">For triggered execution: site/wwwroot/app_data/jobs/triggered/{job name}</span></span>
  * <span data-ttu-id="c13ba-211">Для непрерывного выполнения: site/wwwroot/app_data/jobs/continuous/{имя задания}</span><span class="sxs-lookup"><span data-stu-id="c13ba-211">For continuous execution: site/wwwroot/app_data/jobs/continuous/{job name}</span></span>
* <span data-ttu-id="c13ba-212">**Ведение журнала**: Console.Out обрабатывается (помечается) как информация,</span><span class="sxs-lookup"><span data-stu-id="c13ba-212">**Logging**: Console.Out is treated (marked) as INFO.</span></span> <span data-ttu-id="c13ba-213">а Console.Error — как ошибка.</span><span class="sxs-lookup"><span data-stu-id="c13ba-213">Console.Error is treated as ERROR.</span></span> <span data-ttu-id="c13ba-214">К данным наблюдения и диагностики можно обратиться с помощью портала Azure,</span><span class="sxs-lookup"><span data-stu-id="c13ba-214">You can access monitoring and diagnostics information by using the Azure portal.</span></span> <span data-ttu-id="c13ba-215">а файлы журнала скачать непосредственно с сайта.</span><span class="sxs-lookup"><span data-stu-id="c13ba-215">You can download log files directly from the site.</span></span> <span data-ttu-id="c13ba-216">Они сохраняются в следующих расположениях:</span><span class="sxs-lookup"><span data-stu-id="c13ba-216">They are saved in the following locations:</span></span>
  * <span data-ttu-id="c13ba-217">Для выполнения по триггеру: Vfs/data/jobs/triggered/jobName</span><span class="sxs-lookup"><span data-stu-id="c13ba-217">For triggered execution: Vfs/data/jobs/triggered/jobName</span></span>
  * <span data-ttu-id="c13ba-218">Для непрерывного выполнения: Vfs/data/jobs/continuous/jobName</span><span class="sxs-lookup"><span data-stu-id="c13ba-218">For continuous execution: Vfs/data/jobs/continuous/jobName</span></span>
* <span data-ttu-id="c13ba-219">**Конфигурация**: веб-задания можно настраивать с помощью портала, REST API и PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c13ba-219">**Configuration**: You can configure WebJobs by using the portal, the REST API, and PowerShell.</span></span> <span data-ttu-id="c13ba-220">Файл конфигурации settings.job, находящийся в том же корневом каталоге, что и сценарий задания, можно использовать для предоставления данных о конфигурации задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-220">You can use a configuration file named settings.job in the same root directory as the job script to provide configuration information for a job.</span></span> <span data-ttu-id="c13ba-221">Например: </span><span class="sxs-lookup"><span data-stu-id="c13ba-221">For example:</span></span>
  * <span data-ttu-id="c13ba-222">{ "stopping_wait_time": 60 }</span><span class="sxs-lookup"><span data-stu-id="c13ba-222">{ "stopping_wait_time": 60 }</span></span>
  * <span data-ttu-id="c13ba-223">{ "is_singleton": true }</span><span class="sxs-lookup"><span data-stu-id="c13ba-223">{ "is_singleton": true }</span></span>

#### <a name="considerations"></a><span data-ttu-id="c13ba-224">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c13ba-224">Considerations</span></span>

* <span data-ttu-id="c13ba-225">По умолчанию веб-задания масштабируются вместе с веб-приложением.</span><span class="sxs-lookup"><span data-stu-id="c13ba-225">By default, WebJobs scale with the web app.</span></span> <span data-ttu-id="c13ba-226">Однако задания можно настроить для запуска на одном экземпляре, задав для свойства конфигурации **is_singleton** значение **true**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-226">However, you can configure jobs to run on single instance by setting the **is_singleton** configuration property to **true**.</span></span> <span data-ttu-id="c13ba-227">Одноэкземплярные веб-задания удобны для задач, которые не требуется масштабировать или выполнять одновременно в виде нескольких экземпляров: это может быть повторная индексация, анализ данных и схожие задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-227">Single instance WebJobs are useful for tasks that you do not want to scale or run as simultaneous multiple instances, such as reindexing, data analysis, and similar tasks.</span></span>
* <span data-ttu-id="c13ba-228">Чтобы свести к минимуму влияние заданий на производительность веб-приложения, рассмотрите возможность создания пустого экземпляра веб-приложения Azure в новом плане службы приложений, чтобы размещать веб-задания, которые могут долго выполняться или потреблять много ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-228">To minimize the impact of jobs on the performance of the web app, consider creating an empty Azure Web App instance in a new App Service plan to host WebJobs that may be long running or resource intensive.</span></span>

### <a name="more-information"></a><span data-ttu-id="c13ba-229">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-229">More information</span></span>
* <span data-ttu-id="c13ba-230">[рекомендуемых ресурсах по веб-заданиям Azure](/azure/app-service-web/websites-webjobs-resources) перечислены многие полезные ресурсы, файлы для скачивания и примеры для веб-заданий.</span><span class="sxs-lookup"><span data-stu-id="c13ba-230">[Azure WebJobs recommended resources](/azure/app-service-web/websites-webjobs-resources) lists the many useful resources, downloads, and samples for WebJobs.</span></span>

### <a name="azure-virtual-machines"></a><span data-ttu-id="c13ba-231">Виртуальные машины Azure</span><span class="sxs-lookup"><span data-stu-id="c13ba-231">Azure Virtual Machines</span></span>
<span data-ttu-id="c13ba-232">Фоновые задачи могут быть реализованы таким способом, который препятствует развертыванию в веб-приложениях или в облачных службах Azure, или это может быть неудобно.</span><span class="sxs-lookup"><span data-stu-id="c13ba-232">Background tasks might be implemented in a way that prevents them from being deployed to Azure Web Apps or Cloud Services, or these options might not be convenient.</span></span> <span data-ttu-id="c13ba-233">Типичные примеры — службы Windows, служебные программы и исполняемые программы сторонних производителей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-233">Typical examples are Windows services, and third-party utilities and executable programs.</span></span> <span data-ttu-id="c13ba-234">Другим примером могут служить программы, написанные для среды выполнения, отличной от среды, в которой размещено приложение.</span><span class="sxs-lookup"><span data-stu-id="c13ba-234">Another example might be programs written for an execution environment that is different than that hosting the application.</span></span> <span data-ttu-id="c13ba-235">Например, это может быть программа Unix или Linux, которую необходимо выполнить из приложения Windows или .NET.</span><span class="sxs-lookup"><span data-stu-id="c13ba-235">For example, it might be a Unix or Linux program that you want to execute from a Windows or .NET application.</span></span> <span data-ttu-id="c13ba-236">Вы можете выбрать из диапазона операционных систем для виртуальной машины Azure и запустить свою службу или исполняемый файл на этой виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="c13ba-236">You can choose from a range of operating systems for an Azure virtual machine, and run your service or executable on that virtual machine.</span></span>

<span data-ttu-id="c13ba-237">Чтобы решить, когда следует использовать виртуальные машины, см. статью [Сравнение служб приложений, облачных служб и виртуальных машин Azure](/azure/app-service-web/choose-web-site-cloud-service-vm/).</span><span class="sxs-lookup"><span data-stu-id="c13ba-237">To help you choose when to use Virtual Machines, see [Azure App Services, Cloud Services and Virtual Machines comparison](/azure/app-service-web/choose-web-site-cloud-service-vm/).</span></span> <span data-ttu-id="c13ba-238">Дополнительные сведения о параметрах виртуальных машин см. в статье [Размеры виртуальных машин Windows в Azure](/azure/virtual-machines/windows/sizes).</span><span class="sxs-lookup"><span data-stu-id="c13ba-238">For information about the options for Virtual Machines, see [Sizes for Windows virtual machines in Azure](/azure/virtual-machines/windows/sizes).</span></span> <span data-ttu-id="c13ba-239">Дополнительные сведения об операционных системах и готовых образах, доступных для виртуальных машин, см. в [магазине виртуальных машин Azure](https://azure.microsoft.com/gallery/virtual-machines/).</span><span class="sxs-lookup"><span data-stu-id="c13ba-239">For more information about the operating systems and prebuilt images that are available for Virtual Machines, see [Azure Virtual Machines Marketplace](https://azure.microsoft.com/gallery/virtual-machines/).</span></span>

<span data-ttu-id="c13ba-240">Для запуска фоновой задачи в отдельной виртуальной машине имеется целый ряд возможностей:</span><span class="sxs-lookup"><span data-stu-id="c13ba-240">To initiate the background task in a separate virtual machine, you have a range of options:</span></span>

* <span data-ttu-id="c13ba-241">Задачу можно выполнять по запросу непосредственно из приложения, отправляя запрос к конечной точке, которую предоставляет задача.</span><span class="sxs-lookup"><span data-stu-id="c13ba-241">You can execute the task on demand directly from your application by sending a request to an endpoint that the task exposes.</span></span> <span data-ttu-id="c13ba-242">При этом передаются все необходимые задаче данные.</span><span class="sxs-lookup"><span data-stu-id="c13ba-242">This passes in any data that the task requires.</span></span> <span data-ttu-id="c13ba-243">Эта конечная точка вызывает задачу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-243">This endpoint invokes the task.</span></span>
* <span data-ttu-id="c13ba-244">Можно настроить задачу для запуска по расписанию с помощью планировщика или таймера, доступных в выбранной операционной системе.</span><span class="sxs-lookup"><span data-stu-id="c13ba-244">You can configure the task to run on a schedule by using a scheduler or timer that is available in your chosen operating system.</span></span> <span data-ttu-id="c13ba-245">Например, в Windows для выполнения сценариев и задач можно использовать планировщик заданий Windows.</span><span class="sxs-lookup"><span data-stu-id="c13ba-245">For example, on Windows you can use Windows Task Scheduler to execute scripts and tasks.</span></span> <span data-ttu-id="c13ba-246">Если на виртуальной машине установлен SQL Server, для этой цели можно также использовать агент SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c13ba-246">Or, if you have SQL Server installed on the virtual machine, you can use the SQL Server Agent to execute scripts and tasks.</span></span>
* <span data-ttu-id="c13ba-247">Запустить задачу с помощью планировщика Azure можно, добавив сообщение в очередь, которую задача прослушивает, или отправив запрос к API, предоставляемому задачей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-247">You can use Azure Scheduler to initiate the task by adding a message to a queue that the task listens on, or by sending a request to an API that the task exposes.</span></span>

<span data-ttu-id="c13ba-248">В предыдущем разделе [Триггеры](#triggers) вы можете ознакомиться с дополнительной информацией о том, как можно инициировать фоновые задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-248">See the earlier section [Triggers](#triggers) for more information about how you can initiate background tasks.</span></span>  

#### <a name="considerations"></a><span data-ttu-id="c13ba-249">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c13ba-249">Considerations</span></span>
<span data-ttu-id="c13ba-250">Принимая решение о развертывании фоновых задач в виртуальной машине Azure, необходимо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="c13ba-250">Consider the following points when you are deciding whether to deploy background tasks in an Azure virtual machine:</span></span>

* <span data-ttu-id="c13ba-251">Размещение фоновых задач в отдельной виртуальной машине Azure обеспечивает гибкость и позволяет точно контролировать запуск, выполнение, планирование и распределение ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-251">Hosting background tasks in a separate Azure virtual machine provides flexibility and allows precise control over initiation, execution, scheduling, and resource allocation.</span></span> <span data-ttu-id="c13ba-252">Тем не менее это увеличивает затраты времени выполнения, если виртуальную машину необходимо разворачивать только для фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-252">However, it will increase runtime cost if a virtual machine must be deployed just to run background tasks.</span></span>
* <span data-ttu-id="c13ba-253">На портале Azure не предусмотрены средства для мониторинга задач и возможность автоматического перезапуска невыполненных задач. Но вы можете отслеживать основные данные о состоянии виртуальной машины и управлять ею с помощью [командлетов Azure Resource Manager](https://msdn.microsoft.com/library/mt125356.aspx).</span><span class="sxs-lookup"><span data-stu-id="c13ba-253">There is no facility to monitor the tasks in the Azure portal and no automated restart capability for failed tasks--although you can monitor the basic status of the virtual machine and manage it by using the  [Azure Resource Manager Cmdlets](https://msdn.microsoft.com/library/mt125356.aspx).</span></span> <span data-ttu-id="c13ba-254">Однако не существует средств для управления процессами и потоками в вычислительных узлах.</span><span class="sxs-lookup"><span data-stu-id="c13ba-254">However, there are no facilities to control processes and threads in compute nodes.</span></span> <span data-ttu-id="c13ba-255">Как правило, использование виртуальной машины требует дополнительных усилий, чтобы реализовать механизм, который собирает данные из инструментария в задаче, а также из операционной системы в виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="c13ba-255">Typically, using a virtual machine will require additional effort to implement a mechanism that collects data from instrumentation in the task, and from the operating system in the virtual machine.</span></span> <span data-ttu-id="c13ba-256">Одно из решений, которое может подойти, — использовать [пакет управления System Center для Azure](https://www.microsoft.com/download/details.aspx?id=50013).</span><span class="sxs-lookup"><span data-stu-id="c13ba-256">One solution that might be appropriate is to use the [System Center Management Pack for Azure](https://www.microsoft.com/download/details.aspx?id=50013).</span></span>
* <span data-ttu-id="c13ba-257">Вы можете рассмотреть создание зондов мониторинга, предоставляемых через конечные точки HTTP.</span><span class="sxs-lookup"><span data-stu-id="c13ba-257">You might consider creating monitoring probes that are exposed through HTTP endpoints.</span></span> <span data-ttu-id="c13ba-258">Код этих зондов может проверять работоспособность, собирать информацию об операциях и статистические данные или сопоставлять информацию об ошибках и возвращать ее в приложение управления.</span><span class="sxs-lookup"><span data-stu-id="c13ba-258">The code for these probes could perform health checks, collect operational information and statistics--or collate error information and return it to a management application.</span></span> <span data-ttu-id="c13ba-259">Дополнительную информацию см. в разделе [Шаблон мониторинга конечной точки работоспособности](../patterns/health-endpoint-monitoring.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-259">For more information, see [Health Endpoint Monitoring Pattern](../patterns/health-endpoint-monitoring.md).</span></span>

#### <a name="more-information"></a><span data-ttu-id="c13ba-260">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-260">More information</span></span>
* <span data-ttu-id="c13ba-261">[Виртуальные машины в Azure](https://azure.microsoft.com/services/virtual-machines/)</span><span class="sxs-lookup"><span data-stu-id="c13ba-261">[Virtual Machines](https://azure.microsoft.com/services/virtual-machines/) on Azure</span></span>
* [<span data-ttu-id="c13ba-262">Виртуальные машины Azure. Вопросы и ответы</span><span class="sxs-lookup"><span data-stu-id="c13ba-262">Azure Virtual Machines FAQ</span></span>](/azure/virtual-machines/virtual-machines-linux-classic-faq?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json)

### <a name="azure-batch"></a><span data-ttu-id="c13ba-263">Пакетная служба Azure</span><span class="sxs-lookup"><span data-stu-id="c13ba-263">Azure Batch</span></span> 

<span data-ttu-id="c13ba-264">Рекомендуем использовать [пакетную службу Azure](/azure/batch/) для параллельного выполнения больших рабочих нагрузок с высокопроизводительными вычислениями (HPC) на нескольких десятках, сотнях или тысячах виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="c13ba-264">Consider [Azure Batch](/azure/batch/) if you need to run large, parallel high-performance computing (HPC) workloads across tens, hundreds, or thousands of VMs.</span></span>  

<span data-ttu-id="c13ba-265">Пакетная служба подготавливает виртуальные машины, распределяет между ними задачи, запускает задачи и отслеживает ход выполнения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-265">The Batch service provisions the VMs, assign tasks to the VMs, runs the tasks, and monitors the progress.</span></span> <span data-ttu-id="c13ba-266">Пакетная служба может автоматически масштабировать виртуальные машины при изменении рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-266">Batch can automatically scale out the VMs in response to the workload.</span></span> <span data-ttu-id="c13ba-267">Кроме того, пакетная служба поддерживает планирование заданий.</span><span class="sxs-lookup"><span data-stu-id="c13ba-267">Batch also provides job scheduling.</span></span> <span data-ttu-id="c13ba-268">Пакетная служба Azure поддерживает виртуальные машины Windows и Linux.</span><span class="sxs-lookup"><span data-stu-id="c13ba-268">Azure Batch supports both Linux and Windows VMs.</span></span>

#### <a name="considerations"></a><span data-ttu-id="c13ba-269">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c13ba-269">Considerations</span></span> 

<span data-ttu-id="c13ba-270">Пакетная служба отлично работает с реальными параллельными рабочими нагрузками.</span><span class="sxs-lookup"><span data-stu-id="c13ba-270">Batch works well with intrinsically parallel workloads.</span></span> <span data-ttu-id="c13ba-271">Также она позволяет выполнять параллельные вычисления с завершающим шагом редукции или [приложения интерфейса передачи сообщений](/azure/batch/batch-mpi) для параллельных задач, в которых требуется передача сообщений между узлами.</span><span class="sxs-lookup"><span data-stu-id="c13ba-271">It can also perform parallel calculations with a reduce step at the end, or run [Message Passing Interface (MPI) applications](/azure/batch/batch-mpi) for parallel tasks that require message passing between nodes.</span></span> 

<span data-ttu-id="c13ba-272">Задания пакетной службы Azure выполняются в пуле узлов (виртуальных машин).</span><span class="sxs-lookup"><span data-stu-id="c13ba-272">An Azure Batch job runs on a pool of nodes (VMs).</span></span> <span data-ttu-id="c13ba-273">Один из возможных подходов — выделять этот пул только при необходимости и удалять его по завершении задания.</span><span class="sxs-lookup"><span data-stu-id="c13ba-273">One approach is to allocate a pool only when needed and then delete it after the job completes.</span></span> <span data-ttu-id="c13ba-274">Это позволяет более эффективно использовать ресурсы, так как узлы никогда не простаивают, но задание будет выполняться не сразу, а после задержки на выделение узлов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-274">This maximizes utilization, because nodes are not idle, but the job must wait for nodes to be allocated.</span></span> <span data-ttu-id="c13ba-275">Второй вариант — создавать пул заранее.</span><span class="sxs-lookup"><span data-stu-id="c13ba-275">Alternatively, you can create a pool ahead of time.</span></span> <span data-ttu-id="c13ba-276">Такой подход позволит быстрее запустить задание, но может привести к бездействию узлов на протяжении определенного периода.</span><span class="sxs-lookup"><span data-stu-id="c13ba-276">That approach minimizes the time that it takes for a job to start, but can result in having nodes that sit idle.</span></span> <span data-ttu-id="c13ba-277">Дополнительные сведения см. в разделе [Время существования пула и вычислительного узла](/azure/batch/batch-api-basics#pool-and-compute-node-lifetime).</span><span class="sxs-lookup"><span data-stu-id="c13ba-277">For more information, see [Pool and compute node lifetime](/azure/batch/batch-api-basics#pool-and-compute-node-lifetime).</span></span>

#### <a name="more-information"></a><span data-ttu-id="c13ba-278">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-278">More information</span></span> 

* <span data-ttu-id="c13ba-279">[Выполнение реальных параллельных рабочих нагрузок с использованием пакетной службы](/azure/batch/batch-technical-overview).</span><span class="sxs-lookup"><span data-stu-id="c13ba-279">[Run intrinsically parallel workloads with Batch](/azure/batch/batch-technical-overview)</span></span> 
* <span data-ttu-id="c13ba-280">[Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](/azure/batch/batch-api-basics).</span><span class="sxs-lookup"><span data-stu-id="c13ba-280">[Develop large-scale parallel compute solutions with Batch](/azure/batch/batch-api-basics)</span></span> 
* <span data-ttu-id="c13ba-281">[Решения для пакетных и высокопроизводительных вычислений при крупномасштабных рабочих нагрузках](/azure/batch/batch-hpc-solutions).</span><span class="sxs-lookup"><span data-stu-id="c13ba-281">[Batch and HPC solutions for large-scale computing workloads](/azure/batch/batch-hpc-solutions)</span></span>

### <a name="azure-container-service"></a><span data-ttu-id="c13ba-282">Служба контейнеров Azure</span><span class="sxs-lookup"><span data-stu-id="c13ba-282">Azure Container Service</span></span> 

<span data-ttu-id="c13ba-283">Служба контейнеров Azure дает возможность создать и настроить в Azure кластер виртуальных машин для запуска контейнерных приложений.</span><span class="sxs-lookup"><span data-stu-id="c13ba-283">Azure Container Service lets you configure and manage a cluster of VMs in Azure to run containerized applications.</span></span> <span data-ttu-id="c13ba-284">Она позволяет выбрать для оркестрации Docker Swarm, DC/OS или Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="c13ba-284">It provides a choice of Docker Swarm, DC/OS, or Kubernetes for orchestration.</span></span> 

<span data-ttu-id="c13ba-285">Контейнеры очень удобны для выполнения заданий в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="c13ba-285">Containers can be useful for running background jobs.</span></span> <span data-ttu-id="c13ba-286">Вот некоторые преимущества этой службы:</span><span class="sxs-lookup"><span data-stu-id="c13ba-286">Some of the benefits include:</span></span> 

- <span data-ttu-id="c13ba-287">Контейнеры поддерживают размещение высокой плотности.</span><span class="sxs-lookup"><span data-stu-id="c13ba-287">Containers support high-density hosting.</span></span> <span data-ttu-id="c13ba-288">Фоновую задачу можно изолировать в контейнере, при этом размещая на каждой виртуальной машине несколько контейнеров.</span><span class="sxs-lookup"><span data-stu-id="c13ba-288">You can isolate a background task in a container, while placing multiple containers in each VM.</span></span>
- <span data-ttu-id="c13ba-289">Оркестратор контейнеров обеспечивает внутреннюю балансировку нагрузки, настройку внутренней сети и выполнение других задач по настройке.</span><span class="sxs-lookup"><span data-stu-id="c13ba-289">The container orchestrator handles internal load balancing, configuring the internal network, and other configuration tasks.</span></span>
- <span data-ttu-id="c13ba-290">Контейнеры можно запускать и останавливать по мере необходимости.</span><span class="sxs-lookup"><span data-stu-id="c13ba-290">Containers can be started and stopped as needed.</span></span> 
- <span data-ttu-id="c13ba-291">Реестр контейнеров Azure позволяет зарегистрировать контейнеры в пределах платформы Azure.</span><span class="sxs-lookup"><span data-stu-id="c13ba-291">Azure Container Registry allows you to register your containers inside Azure boundaries.</span></span> <span data-ttu-id="c13ba-292">Это дает дополнительные преимущества, касающиеся безопасности, конфиденциальности и близкого взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="c13ba-292">This comes with security, privacy, and proximity benefits.</span></span> 

#### <a name="considerations"></a><span data-ttu-id="c13ba-293">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c13ba-293">Considerations</span></span>

- <span data-ttu-id="c13ba-294">Важно понимать, как работает оркестратор контейнеров.</span><span class="sxs-lookup"><span data-stu-id="c13ba-294">Requires an understanding of how to use a container orchestrator.</span></span> <span data-ttu-id="c13ba-295">В зависимости от квалификации разработчиков его использование может представлять некоторые трудности.</span><span class="sxs-lookup"><span data-stu-id="c13ba-295">Depending on the skillset of your DevOps team, this may or may not be an issue.</span></span>  
- <span data-ttu-id="c13ba-296">Служба контейнеров выполняется в среде IaaS.</span><span class="sxs-lookup"><span data-stu-id="c13ba-296">Container Service runs in an IaaS environment.</span></span> <span data-ttu-id="c13ba-297">Она предоставляет кластер виртуальных машин в выделенной виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c13ba-297">It provisions a cluster of VMs inside a dedicated VNet.</span></span> 

#### <a name="more-information"></a><span data-ttu-id="c13ba-298">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-298">More information</span></span> 

* <span data-ttu-id="c13ba-299">[Общие сведения о решениях для размещения контейнера Docker с помощью службы контейнеров Azure](/azure/container-service/container-service-intro).</span><span class="sxs-lookup"><span data-stu-id="c13ba-299">[Introduction to Docker container hosting solutions with Azure Container Service](/azure/container-service/container-service-intro)</span></span> 
* <span data-ttu-id="c13ba-300">[Общие сведения о частных реестрах контейнеров Docker](/azure/container-registry/container-registry-intro).</span><span class="sxs-lookup"><span data-stu-id="c13ba-300">[Introduction to private Docker container registries](/azure/container-registry/container-registry-intro)</span></span> 

### <a name="azure-cloud-services"></a><span data-ttu-id="c13ba-301">Облачные службы Azure</span><span class="sxs-lookup"><span data-stu-id="c13ba-301">Azure Cloud Services</span></span> 
<span data-ttu-id="c13ba-302">Фоновые задачи могут выполняться в веб-роли или в отдельной рабочей роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-302">You can execute background tasks within a web role or in a separate worker role.</span></span> <span data-ttu-id="c13ba-303">Выбирая рабочую роль, необходимо учитывать требования к масштабируемости и гибкости, время существования задачи, периодичность выпуска, безопасность, отказоустойчивость, конфликты, сложность и логическую архитектуру.</span><span class="sxs-lookup"><span data-stu-id="c13ba-303">When you are deciding whether to use a worker role, consider scalability and elasticity requirements, task lifetime, release cadence, security, fault tolerance, contention, complexity, and the logical architecture.</span></span> <span data-ttu-id="c13ba-304">в разделе [Шаблон консолидации вычислительных ресурсов](../patterns/compute-resource-consolidation.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-304">For more information, see [Compute Resource Consolidation Pattern](../patterns/compute-resource-consolidation.md).</span></span>

<span data-ttu-id="c13ba-305">Существует несколько способов реализовать фоновые задачи в роли облачных служб:</span><span class="sxs-lookup"><span data-stu-id="c13ba-305">There are several ways to implement background tasks within a Cloud Services role:</span></span>

* <span data-ttu-id="c13ba-306">Создание реализации класса **RoleEntryPoint** в роли и использование его методов для выполнения фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-306">Create an implementation of the **RoleEntryPoint** class in the role and use its methods to execute background tasks.</span></span> <span data-ttu-id="c13ba-307">Задачи выполняются в контексте WaIISHost.exe</span><span class="sxs-lookup"><span data-stu-id="c13ba-307">The tasks run in the context of WaIISHost.exe.</span></span> <span data-ttu-id="c13ba-308">Они могут использовать метод **GetSetting** класса **CloudConfigurationManager** для загрузки параметров конфигурации.</span><span class="sxs-lookup"><span data-stu-id="c13ba-308">They can use the **GetSetting** method of the **CloudConfigurationManager** class to load configuration settings.</span></span> <span data-ttu-id="c13ba-309">См. дополнительные сведения о [жизненном цикле](#lifecycle).</span><span class="sxs-lookup"><span data-stu-id="c13ba-309">For more information, see [Lifecycle](#lifecycle).</span></span>
* <span data-ttu-id="c13ba-310">Использование задач запуска для выполнения фоновых задач при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-310">Use startup tasks to execute background tasks when the application starts.</span></span> <span data-ttu-id="c13ba-311">Чтобы задачи продолжали принудительно запускаться в фоновом режиме, для свойства **taskType** задайте значение **background** (если этого не сделать, процесс запуска приложения остановится и будет ожидать завершения задачи).</span><span class="sxs-lookup"><span data-stu-id="c13ba-311">To force the tasks to continue to run in the background, set the **taskType** property to **background** (if you do not do this, the application startup process will halt and wait for the task to finish).</span></span> <span data-ttu-id="c13ba-312">Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](/azure/cloud-services/cloud-services-startup-tasks).</span><span class="sxs-lookup"><span data-stu-id="c13ba-312">For more information, see [Run startup tasks in Azure](/azure/cloud-services/cloud-services-startup-tasks).</span></span>
* <span data-ttu-id="c13ba-313">Использование пакета SDK для веб-заданий для реализации фоновых задач как веб-заданий, которые инициируются как задачи запуска.</span><span class="sxs-lookup"><span data-stu-id="c13ba-313">Use the WebJobs SDK to implement background tasks such as WebJobs that are initiated as a startup task.</span></span> <span data-ttu-id="c13ba-314">Дополнительные сведения см. в документации [по созданию веб-приложения .NET в службе приложений Azure](/azure/app-service-web/websites-dotnet-webjobs-sdk-get-started).</span><span class="sxs-lookup"><span data-stu-id="c13ba-314">For more information, see [Create a .NET WebJob in Azure App Service](/azure/app-service-web/websites-dotnet-webjobs-sdk-get-started).</span></span>
* <span data-ttu-id="c13ba-315">Использование задачи запуска для установки службы Windows, которая выполняет одну или несколько фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-315">Use a startup task to install a Windows service that executes one or more background tasks.</span></span> <span data-ttu-id="c13ba-316">Чтобы эта служба выполнялась в фоновом режиме, необходимо для свойства **taskType** задать значение **background**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-316">You must set the **taskType** property to **background** so that the service executes in the background.</span></span> <span data-ttu-id="c13ba-317">Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](/azure/cloud-services/cloud-services-startup-tasks).</span><span class="sxs-lookup"><span data-stu-id="c13ba-317">For more information, see [Run startup tasks in Azure](/azure/cloud-services/cloud-services-startup-tasks).</span></span>

<span data-ttu-id="c13ba-318">Основным преимуществом выполнения фоновых задач в веб-роли является сокращение затрат на размещение, так как не требуется развертывать дополнительные роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-318">The main advantage of running background tasks in the web role is the saving in hosting costs because there is no requirement to deploy additional roles.</span></span>

<span data-ttu-id="c13ba-319">Запуск фоновых задач в рабочей роли имеет несколько преимуществ:</span><span class="sxs-lookup"><span data-stu-id="c13ba-319">Running background tasks in a worker role has several advantages:</span></span>

* <span data-ttu-id="c13ba-320">Позволяет управлять масштабированием отдельно для каждого типа роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-320">It allows you to manage scaling separately for each type of role.</span></span> <span data-ttu-id="c13ba-321">Например, может потребоваться несколько экземпляров веб-роли для обслуживания текущей нагрузки, но меньше экземпляров рабочей роли для выполнения фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-321">For example, you might need more instances of a web role to support the current load, but fewer instances of the worker role that executes background tasks.</span></span> <span data-ttu-id="c13ba-322">Масштабирование вычислительных экземпляров фоновых задач отдельно от ролей пользовательского интерфейса может уменьшить стоимость размещения, сохраняя при этом приемлемую производительность.</span><span class="sxs-lookup"><span data-stu-id="c13ba-322">By scaling background task compute instances separately from the UI roles, you can reduce hosting costs, while maintaining acceptable performance.</span></span>
* <span data-ttu-id="c13ba-323">Освобождает веб-роль от дополнительной обработки фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-323">It offloads the processing overhead for background tasks from the web role.</span></span> <span data-ttu-id="c13ba-324">Веб-роль, которая предоставляет пользовательский интерфейс, может оставаться работоспособной, что может означать меньшее количество экземпляров, необходимых для обслуживания заданного объема запросов от пользователей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-324">The web role that provides the UI can remain responsive, and it may mean fewer instances are required to support a given volume of requests from users.</span></span>
* <span data-ttu-id="c13ba-325">Позволяет реализовать разделение областей ответственности.</span><span class="sxs-lookup"><span data-stu-id="c13ba-325">It allows you to implement separation of concerns.</span></span> <span data-ttu-id="c13ba-326">Каждый тип роли может реализовать ряд четко определенных и связанных задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-326">Each role type can implement a specific set of clearly defined and related tasks.</span></span> <span data-ttu-id="c13ba-327">Это упрощает проектирование и обслуживание кода, так как уменьшается взаимозависимость кода и функциональных возможностей между ролями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-327">This makes designing and maintaining the code easier because there is less interdependence of code and functionality between each role.</span></span>
* <span data-ttu-id="c13ba-328">Позволяет изолировать конфиденциальные процессы и данные.</span><span class="sxs-lookup"><span data-stu-id="c13ba-328">It can help to isolate sensitive processes and data.</span></span> <span data-ttu-id="c13ba-329">Например, веб-ролям, которые реализуют интерфейс пользователя, не требуется доступ к данным, управляемых и контролируемых рабочей ролью.</span><span class="sxs-lookup"><span data-stu-id="c13ba-329">For example, web roles that implement the UI do not need to have access to data that is managed and controlled by a worker role.</span></span> <span data-ttu-id="c13ba-330">Это может быть удобно для повышения уровня безопасности, особенно в том случае, если используется такой шаблон, как [шаблон привратника](../patterns/gatekeeper.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-330">This can be useful in strengthening security, especially when you use a pattern such as the [Gatekeeper Pattern](../patterns/gatekeeper.md).</span></span>  

#### <a name="considerations"></a><span data-ttu-id="c13ba-331">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c13ba-331">Considerations</span></span>
<span data-ttu-id="c13ba-332">При выборе как и где развертывать фоновые задачи при использовании рабочих и веб-ролей облачных служб следует учитывать следующие моменты:</span><span class="sxs-lookup"><span data-stu-id="c13ba-332">Consider the following points when choosing how and where to deploy background tasks when using Cloud Services web and worker roles:</span></span>

* <span data-ttu-id="c13ba-333">Размещение фоновых задач в существующей веб-роли может снизить расходы на стоимость выполнения отдельной рабочей роли для этих задач,</span><span class="sxs-lookup"><span data-stu-id="c13ba-333">Hosting background tasks in an existing web role can save the cost of running a separate worker role just for these tasks.</span></span> <span data-ttu-id="c13ba-334">но это может повлиять на производительность и доступность приложения в случае конфликтов за использование обрабатывающих и других ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-334">However, it is likely to affect the performance and availability of the application if there is contention for processing and other resources.</span></span> <span data-ttu-id="c13ba-335">Использование отдельной рабочей роли защищает веб-роль от влияния долго выполняющихся или ресурсоемких фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-335">Using a separate worker role protects the web role from the impact of long-running or resource-intensive background tasks.</span></span>
* <span data-ttu-id="c13ba-336">При размещении фоновых задач с помощью класса **RoleEntryPoint** вы можете легко переместить его в другую роль.</span><span class="sxs-lookup"><span data-stu-id="c13ba-336">If you host background tasks by using the **RoleEntryPoint** class, you can easily move this to another role.</span></span> <span data-ttu-id="c13ba-337">Например, если вы создали класс в веб-роли, а позже решили, что задачи необходимо выполнять в рабочей роли, вы можете переместить реализацию класса **RoleEntryPoint** в рабочую роль.</span><span class="sxs-lookup"><span data-stu-id="c13ba-337">For example, if you create the class in a web role and later decide that you need to run the tasks in a worker role, you can move the **RoleEntryPoint** class implementation into the worker role.</span></span>
* <span data-ttu-id="c13ba-338">Задачи запуска предназначены для выполнения программы или сценария.</span><span class="sxs-lookup"><span data-stu-id="c13ba-338">Startup tasks are designed to execute a program or a script.</span></span> <span data-ttu-id="c13ba-339">Развернуть фоновое задание как исполняемую программу может оказаться сложнее, особенно если также требуется развертывать зависимые сборки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-339">Deploying a background job as an executable program might be more difficult, especially if it also requires deployment of dependent assemblies.</span></span> <span data-ttu-id="c13ba-340">Возможно, проще будет развернуть и использовать сценарий для определения фонового задания с помощью задач запуска.</span><span class="sxs-lookup"><span data-stu-id="c13ba-340">It might be easier to deploy and use a script to define a background job when you use startup tasks.</span></span>
* <span data-ttu-id="c13ba-341">Исключения, которые вызывают сбой фоновой задачи, по-разному оказывают влияние. Это зависит от способа их размещения:</span><span class="sxs-lookup"><span data-stu-id="c13ba-341">Exceptions that cause a background task to fail have a different impact, depending on the way that they are hosted:</span></span>
  * <span data-ttu-id="c13ba-342">Если вы используете метод на основе класса **RoleEntryPoint** , завершенная сбоем задача приведет к перезапуску роли, чтобы задача могла быть автоматически перезапущена.</span><span class="sxs-lookup"><span data-stu-id="c13ba-342">If you use the **RoleEntryPoint** class approach, a failed task will cause the role to restart so that the task automatically restarts.</span></span> <span data-ttu-id="c13ba-343">Это может повлиять на доступность приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-343">This can affect availability of the application.</span></span> <span data-ttu-id="c13ba-344">Чтобы избежать этого, обязательно добавьте надежную обработку исключений в класс **RoleEntryPoint** и все фоновые задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-344">To prevent this, ensure that you include robust exception handling within the **RoleEntryPoint** class and all the background tasks.</span></span> <span data-ttu-id="c13ba-345">Используйте код для перезапуска завершенных сбоем задач, где это целесообразно, и порождайте исключение для перезапуска роли только в том случае, если нельзя корректно выполнить восстановление после сбоя в коде.</span><span class="sxs-lookup"><span data-stu-id="c13ba-345">Use code to restart tasks that fail where this is appropriate, and throw the exception to restart the role only if you cannot gracefully recover from the failure within your code.</span></span>
  * <span data-ttu-id="c13ba-346">При использовании задач запуска вы несете ответственность за управление выполнением задач и проверку на наличие сбоя.</span><span class="sxs-lookup"><span data-stu-id="c13ba-346">If you use startup tasks, you are responsible for managing the task execution and checking if it fails.</span></span>
* <span data-ttu-id="c13ba-347">Управление задачами запуска и наблюдение за ними сложнее, чем использование класса **RoleEntryPoint**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-347">Managing and monitoring startup tasks is more difficult than using the **RoleEntryPoint** class approach.</span></span> <span data-ttu-id="c13ba-348">Тем не менее, пакет SDK для Azure для веб-заданий содержит панель мониторинга, чтобы упростить управление веб-заданиями, инициируемыми с помощью задач запуска.</span><span class="sxs-lookup"><span data-stu-id="c13ba-348">However, the Azure WebJobs SDK includes a dashboard to make it easier to manage WebJobs that you initiate through startup tasks.</span></span>

#### <a name="lifecycle"></a><span data-ttu-id="c13ba-349">Жизненный цикл</span><span class="sxs-lookup"><span data-stu-id="c13ba-349">Lifecycle</span></span> 
 <span data-ttu-id="c13ba-350">Если вы решили реализовать фоновые задания для приложений облачных служб, использующих веб-роли и рабочие роли, с помощью класса **RoleEntryPoint** , важно понимать жизненный цикл этого класса, чтобы правильно его использовать.</span><span class="sxs-lookup"><span data-stu-id="c13ba-350">If you decide to implement background jobs for Cloud Services applications that use web and worker roles by using the **RoleEntryPoint** class, it is important to understand the lifecycle of this class in order to use it correctly.</span></span>

<span data-ttu-id="c13ba-351">От запуска, выполнения и до остановки веб-роли и рабочие роли проходят ряд различных этапов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-351">Web and worker roles go through a set of distinct phases as they start, run, and stop.</span></span> <span data-ttu-id="c13ba-352">Класс **RoleEntryPoint** предоставляет ряд событий, указывающих, когда выполняются эти этапы.</span><span class="sxs-lookup"><span data-stu-id="c13ba-352">The **RoleEntryPoint** class exposes a series of events that indicate when these stages are occurring.</span></span> <span data-ttu-id="c13ba-353">Они используются для инициализации, выполнения и остановки ваших настраиваемых фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-353">You use these to initialize, run, and stop your custom background tasks.</span></span> <span data-ttu-id="c13ba-354">Ниже приведен полный цикл:</span><span class="sxs-lookup"><span data-stu-id="c13ba-354">The complete cycle is:</span></span>

* <span data-ttu-id="c13ba-355">Azure загружает сборку роли и ищет в ней класс, производный от **RoleEntryPoint**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-355">Azure loads the role assembly and searches it for a class that derives from **RoleEntryPoint**.</span></span>
* <span data-ttu-id="c13ba-356">При обнаружении данного класса вызывается **RoleEntryPoint.OnStart()**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-356">If it finds this class, it calls **RoleEntryPoint.OnStart()**.</span></span> <span data-ttu-id="c13ba-357">Можно переопределить этот метод для инициализации своих фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-357">You override this method to initialize your background tasks.</span></span>
* <span data-ttu-id="c13ba-358">После завершения метода **OnStart** Azure вызывает **Application_Start()** в глобальном файле приложения, если он присутствует (например, Global.asax в веб-роли под управлением ASP.NET).</span><span class="sxs-lookup"><span data-stu-id="c13ba-358">After the **OnStart** method has completed, Azure calls **Application_Start()** in the application’s Global file if this is present (for example, Global.asax in a web role running ASP.NET).</span></span>
* <span data-ttu-id="c13ba-359">Azure вызывает **RoleEntryPoint.Run()** для нового потока переднего плана, выполняющегося параллельно с **OnStart()**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-359">Azure calls **RoleEntryPoint.Run()** on a new foreground thread that executes in parallel with **OnStart()**.</span></span> <span data-ttu-id="c13ba-360">Можно переопределить этот метод для запуска своих фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-360">You override this method to start your background tasks.</span></span>
* <span data-ttu-id="c13ba-361">После завершения метода Run Azure сначала вызывает **Application_End()** в глобальном файле приложения, если он присутствует, а затем вызывает **RoleEntryPoint.OnStop()**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-361">When the Run method ends, Azure first calls **Application_End()** in the application’s Global file if this is present, and then calls **RoleEntryPoint.OnStop()**.</span></span> <span data-ttu-id="c13ba-362">Вы можете переопределить метод **OnStop** , чтобы останавливать свои фоновые задачи, высвобождать ресурсы, удалять объекты и закрывать подключения, которые использовали задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-362">You override the **OnStop** method to stop your background tasks, clean up resources, dispose of objects, and close connections that the tasks may have used.</span></span>
* <span data-ttu-id="c13ba-363">Хост-процесс рабочей роли Azure останавливается.</span><span class="sxs-lookup"><span data-stu-id="c13ba-363">The Azure worker role host process is stopped.</span></span> <span data-ttu-id="c13ba-364">На этом этапе роль будет перезапущена.</span><span class="sxs-lookup"><span data-stu-id="c13ba-364">At this point, the role will be recycled and will restart.</span></span>

<span data-ttu-id="c13ba-365">Дополнительную информацию и примеры использования методов класса **RoleEntryPoint** см. в разделе [Шаблон консолидации вычислительных ресурсов](../patterns/compute-resource-consolidation.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-365">For more details and an example of using the methods of the **RoleEntryPoint** class, see [Compute Resource Consolidation Pattern](../patterns/compute-resource-consolidation.md).</span></span>

#### <a name="implementation-considerations"></a><span data-ttu-id="c13ba-366">Рекомендации по реализации</span><span class="sxs-lookup"><span data-stu-id="c13ba-366">Implementation considerations</span></span>

<span data-ttu-id="c13ba-367">При внедрении фоновых задач в рабочей или веб-роли необходимо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="c13ba-367">Consider the following points if you are implementing background tasks in a web or worker role:</span></span>

* <span data-ttu-id="c13ba-368">Используемая по умолчанию реализация метода **Run** в классе **RoleEntryPoint** содержит вызов **Thread.Sleep(Timeout.Infinite)**, который бесконечно проверяет активность роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-368">The default **Run** method implementation in the **RoleEntryPoint** class contains a call to **Thread.Sleep(Timeout.Infinite)** that keeps the role alive indefinitely.</span></span> <span data-ttu-id="c13ba-369">Если вы переопределяете метод **Run** (что обычно необходимо для выполнения фоновых задач), вы не должны допускать в коде выход из метода, если только не требуется перезапустить экземпляр роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-369">If you override the **Run** method (which is typically necessary to execute background tasks), you must not allow your code to exit from the method unless you want to recycle the role instance.</span></span>
* <span data-ttu-id="c13ba-370">Типичная реализация метода **Run** содержит код для запуска каждой из фоновых задач и конструкцию цикла, которая периодически проверяет состояние всех фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-370">A typical implementation of the **Run** method includes code to start each of the background tasks and a loop construct that periodically checks the state of all the background tasks.</span></span> <span data-ttu-id="c13ba-371">Она может перезапустить любую задачу, завершенную сбоем, или наблюдать за токенами отмены, свидетельствующими о завершении заданий.</span><span class="sxs-lookup"><span data-stu-id="c13ba-371">It can restart any that fail or monitor for cancellation tokens that indicate that jobs have completed.</span></span>
* <span data-ttu-id="c13ba-372">Если фоновая задача порождает необработанное исключение, она должна быть перезапущена, не мешая другим фоновым задачам в роли продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-372">If a background task throws an unhandled exception, that task should be recycled while allowing any other background tasks in the role to continue running.</span></span> <span data-ttu-id="c13ba-373">Тем не менее, если исключение вызвано повреждением объектов вне задачи, например общего хранилища, то оно должно быть обработано вашим классом **RoleEntryPoint**, все задачи должны быть отменены, а методу **Run** — разрешено завершение.</span><span class="sxs-lookup"><span data-stu-id="c13ba-373">However, if the exception is caused by corruption of objects outside the task, such as shared storage, the exception should be handled by your **RoleEntryPoint** class, all tasks should be cancelled, and the **Run** method should be allowed to end.</span></span> <span data-ttu-id="c13ba-374">После этого Azure перезапустит роль.</span><span class="sxs-lookup"><span data-stu-id="c13ba-374">Azure will then restart the role.</span></span>
* <span data-ttu-id="c13ba-375">Используйте метод **OnStop** для приостановки или уничтожения фоновых задач и высвобождения ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-375">Use the **OnStop** method to pause or kill background tasks and clean up resources.</span></span> <span data-ttu-id="c13ba-376">Для этого может потребоваться остановить продолжительные или многошаговые задания</span><span class="sxs-lookup"><span data-stu-id="c13ba-376">This might involve stopping long-running or multistep tasks.</span></span> <span data-ttu-id="c13ba-377">и как следует обдумать, как сделать это так, чтобы избежать несогласованности данных.</span><span class="sxs-lookup"><span data-stu-id="c13ba-377">It is vital to consider how this can be done to avoid data inconsistencies.</span></span> <span data-ttu-id="c13ba-378">Если экземпляр роли останавливается по любой причине, кроме инициированного пользователем завершения работы, код, выполняемый в методе **OnStop**, должен быть завершен в течение пяти минут, прежде чем это будет сделано принудительно.</span><span class="sxs-lookup"><span data-stu-id="c13ba-378">If a role instance stops for any reason other than a user-initiated shutdown, the code running in the **OnStop** method must be completed within five minutes before it is forcibly terminated.</span></span> <span data-ttu-id="c13ba-379">Убедитесь, что код может быть выполнен за это время он может не быть выполнен до завершения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-379">Ensure that your code can be completed in that time or can tolerate not running to completion.</span></span>  
* <span data-ttu-id="c13ba-380">Балансировщик нагрузки Azure начинает направлять трафик в экземпляр роли, когда метод **RoleEntryPoint.OnStart** возвращает значение **true**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-380">The Azure load balancer starts directing traffic to the role instance when the **RoleEntryPoint.OnStart** method returns the value **true**.</span></span> <span data-ttu-id="c13ba-381">Поэтому рекомендуется поместить весь код инициализации в метод **OnStart** , чтобы экземпляры роли, которые не инициализировались успешно, не получали никакого входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="c13ba-381">Therefore, consider putting all your initialization code in the **OnStart** method so that role instances that do not successfully initialize will not receive any traffic.</span></span>
* <span data-ttu-id="c13ba-382">В дополнение к методам класса **RoleEntryPoint** можно использовать задачи запуска.</span><span class="sxs-lookup"><span data-stu-id="c13ba-382">You can use startup tasks in addition to the methods of the **RoleEntryPoint** class.</span></span> <span data-ttu-id="c13ba-383">Задачи запуска следует использовать для инициализации любых параметров, которые необходимо изменить в балансировщике нагрузки Azure, так как эти задачи будут выполнены прежде, чем роль получит какие-либо запросы.</span><span class="sxs-lookup"><span data-stu-id="c13ba-383">You should use startup tasks to initialize any settings that you need to change in the Azure load balancer because these tasks will execute before the role receives any requests.</span></span> <span data-ttu-id="c13ba-384">Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](/azure/cloud-services/cloud-services-startup-tasks/).</span><span class="sxs-lookup"><span data-stu-id="c13ba-384">For more information, see [Run startup tasks in Azure](/azure/cloud-services/cloud-services-startup-tasks/).</span></span>
* <span data-ttu-id="c13ba-385">Если в задаче запуска имеется ошибка, она вынудит роль постоянно перезапускаться.</span><span class="sxs-lookup"><span data-stu-id="c13ba-385">If there is an error in a startup task, it might force the role to continually restart.</span></span> <span data-ttu-id="c13ba-386">Это может помешать обратному переключению виртуального IP-адреса на предыдущую промежуточную версию, так как для переключения требуется монопольный доступ к роли,</span><span class="sxs-lookup"><span data-stu-id="c13ba-386">This can prevent you from performing a virtual IP (VIP) address swap back to a previously staged version because the swap requires exclusive access to the role.</span></span> <span data-ttu-id="c13ba-387">а это невозможно, пока роль перезапускается.</span><span class="sxs-lookup"><span data-stu-id="c13ba-387">This cannot be obtained while the role is restarting.</span></span> <span data-ttu-id="c13ba-388">Чтобы устранить эту проблему:</span><span class="sxs-lookup"><span data-stu-id="c13ba-388">To resolve this:</span></span>
  
  * <span data-ttu-id="c13ba-389">Добавьте следующий код в начало методов **OnStart** и **Run** в своей роли.</span><span class="sxs-lookup"><span data-stu-id="c13ba-389">Add the following code to the beginning of the **OnStart** and **Run** methods in your role:</span></span>
    
    ```C#
    var freeze = CloudConfigurationManager.GetSetting("Freeze");
    if (freeze != null)
    {
      if (Boolean.Parse(freeze))
      {
        Thread.Sleep(System.Threading.Timeout.Infinite);
      }
    }
    ```
    
  * <span data-ttu-id="c13ba-390">Добавьте определение параметра **Freeze** с логическим значением в файлы роли ServiceDefinition.csdef и ServiceConfiguration.\*.cscfg. Присвойте параметру значение **false**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-390">Add the definition of the **Freeze** setting as a Boolean value to the ServiceDefinition.csdef and ServiceConfiguration.\*.cscfg files for the role and set it to **false**.</span></span> <span data-ttu-id="c13ba-391">Если роль неоднократно перезапускается, попробуйте изменить значение этого параметра на **true**, чтобы заморозить выполнение роли и позволить переключить ее на предыдущую версию.</span><span class="sxs-lookup"><span data-stu-id="c13ba-391">If the role goes into a repeated restart mode, you can change the setting to **true** to freeze role execution and allow it to be swapped with a previous version.</span></span>

#### <a name="more-information"></a><span data-ttu-id="c13ba-392">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-392">More information</span></span>
* [<span data-ttu-id="c13ba-393">Шаблон консолидации вычислительных ресурсов</span><span class="sxs-lookup"><span data-stu-id="c13ba-393">Compute Resource Consolidation Pattern</span></span>](../patterns/compute-resource-consolidation.md)
* [<span data-ttu-id="c13ba-394">Начало работы с пакетом SDK для Azure для веб-заданий</span><span class="sxs-lookup"><span data-stu-id="c13ba-394">Get started with the Azure WebJobs SDK</span></span>](/azure/app-service-web/websites-dotnet-webjobs-sdk-get-started/)


## <a name="partitioning"></a><span data-ttu-id="c13ba-395">Секционирование</span><span class="sxs-lookup"><span data-stu-id="c13ba-395">Partitioning</span></span>
<span data-ttu-id="c13ba-396">Если вы решили включить фоновые задачи в существующий вычислительный экземпляр (например, веб-приложение, веб-роль, существующую рабочую роль или виртуальную машину), необходимо учесть, как это повлияет на атрибуты качества вычислительного экземпляра и саму фоновую задачу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-396">If you decide to include background tasks within an existing compute instance (such as a web app, web role, existing worker role, or virtual machine), you must consider how this will affect the quality attributes of the compute instance and the background task itself.</span></span> <span data-ttu-id="c13ba-397">Эти факторы помогут решить, следует ли совместно размещать задачи с существующим вычислительным экземпляром или выделить им отдельный вычислительный экземпляр:</span><span class="sxs-lookup"><span data-stu-id="c13ba-397">These factors will help you to decide whether to colocate the tasks with the existing compute instance or separate them out into a separate compute instance:</span></span>

* <span data-ttu-id="c13ba-398">**Доступность**: фоновым задачам может не требоваться такой же уровень доступности, что и другим частям приложения, в частности, пользовательскому интерфейсу и другим частям, непосредственно участвующим во взаимодействии с пользователем.</span><span class="sxs-lookup"><span data-stu-id="c13ba-398">**Availability**: Background tasks might not need to have the same level of availability as other parts of the application, in particular the UI and other parts that are directly involved in user interaction.</span></span> <span data-ttu-id="c13ba-399">Фоновые задачи могут быть менее чувствительны к задержкам, сбоям при повторных подключениях и другим факторам, влияющим на доступность, так как операции могут быть поставлены в очередь.</span><span class="sxs-lookup"><span data-stu-id="c13ba-399">Background tasks might be more tolerant of latency, retried connection failures, and other factors that affect availability because the operations can be queued.</span></span> <span data-ttu-id="c13ba-400">Однако требуются достаточные ресурсы, чтобы предотвратить накопление запросов, которые могут блокировать очереди и влиять на приложение в целом.</span><span class="sxs-lookup"><span data-stu-id="c13ba-400">However, there must be sufficient capacity to prevent the backup of requests that could block queues and affect the application as a whole.</span></span>
* <span data-ttu-id="c13ba-401">**Масштабируемость**: вероятно, у фоновых задач будут разные требования к масштабируемости пользовательского интерфейса и интерактивных частей приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-401">**Scalability**: Background tasks are likely to have a different scalability requirement than the UI and the interactive parts of the application.</span></span> <span data-ttu-id="c13ba-402">Масштабирование пользовательского интерфейса может потребоваться для обработки всплесков нагрузки по запросу, тогда как невыполненные фоновые задачи могут быть осуществлены в периоды меньшей загруженности меньшим числом вычислительных экземпляров.</span><span class="sxs-lookup"><span data-stu-id="c13ba-402">Scaling the UI might be necessary to meet peaks in demand, while outstanding background tasks might be completed during less busy times by a fewer number of compute instances.</span></span>
* <span data-ttu-id="c13ba-403">**Устойчивость**: сбой вычислительного экземпляра, в котором просто размещены фоновые задачи, может не привести к неустранимым последствиям для приложения в целом, если запросы на выполнение этих задач можно поставить в очередь или отложить, пока задача снова не будет доступна.</span><span class="sxs-lookup"><span data-stu-id="c13ba-403">**Resiliency**: Failure of a compute instance that just hosts background tasks might not fatally affect the application as a whole if the requests for these tasks can be queued or postponed until the task is available again.</span></span> <span data-ttu-id="c13ba-404">Если за соответствующий интервал времени можно перезапустить вычислительный экземпляр и (или) задачи, на работе пользователей приложения это не отразится.</span><span class="sxs-lookup"><span data-stu-id="c13ba-404">If the compute instance and/or tasks can be restarted within an appropriate interval, users of the application might not be affected.</span></span>
* <span data-ttu-id="c13ba-405">**Безопасность**: у фоновых задач могут быть иные требования к безопасности или ограничения, чем у пользовательского интерфейса или других частей приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-405">**Security**: Background tasks might have different security requirements or restrictions than the UI or other parts of the application.</span></span> <span data-ttu-id="c13ba-406">Используя отдельный вычислительный экземпляр, можно указать другую среду безопасности для задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-406">By using a separate compute instance, you can specify a different security environment for the tasks.</span></span> <span data-ttu-id="c13ba-407">Также можно использовать шаблоны, например шаблон привратника, чтобы изолировать фоновые вычислительные экземпляры от пользовательского интерфейса. Это обеспечит максимальную безопасность и разделение.</span><span class="sxs-lookup"><span data-stu-id="c13ba-407">You can also use patterns such as Gatekeeper to isolate the background compute instances from the UI in order to maximize security and separation.</span></span>
* <span data-ttu-id="c13ba-408">**Производительность**: можно выбрать тип вычислительного экземпляра для фоновых задач, соответствующий требованиям к производительности задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-408">**Performance**: You can choose the type of compute instance for background tasks to specifically match the performance requirements of the tasks.</span></span> <span data-ttu-id="c13ba-409">Это может означать использование более дешевого варианта вычислений, если задачи не требуют таких же возможностей обработки, что и пользовательский интерфейс, либо использование более крупного экземпляра, если они требуют дополнительной емкости и ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c13ba-409">This might mean using a less expensive compute option if the tasks do not require the same processing capabilities as the UI, or a larger instance if they require additional capacity and resources.</span></span>
* <span data-ttu-id="c13ba-410">**Управляемость**: у фоновых задач может быть иной темп разработки и развертывания, чем у кода или пользовательского интерфейса основного приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-410">**Manageability**: Background tasks might have a different development and deployment rhythm from the main application code or the UI.</span></span> <span data-ttu-id="c13ba-411">Их развертывание в отдельном вычислительном экземпляре может упростить обновление и управление версиями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-411">Deploying them to a separate compute instance can simplify updates and versioning.</span></span>
* <span data-ttu-id="c13ba-412">**Стоимость**: добавление вычислительных экземпляров для выполнения фоновых задач увеличивает расходы на размещение.</span><span class="sxs-lookup"><span data-stu-id="c13ba-412">**Cost**: Adding compute instances to execute background tasks increases hosting costs.</span></span> <span data-ttu-id="c13ba-413">Необходимо тщательно обдумать компромисс между дополнительной емкостью и этими дополнительными затратами.</span><span class="sxs-lookup"><span data-stu-id="c13ba-413">You should carefully consider the trade-off between additional capacity and these extra costs.</span></span>

<span data-ttu-id="c13ba-414">Дополнительные сведения см. в статьях [Leader Election Pattern](../patterns/leader-election.md) (Шаблон выбора лидера) и [Competing Consumers Pattern](../patterns/competing-consumers.md) (Шаблон конкурирующих клиентов).</span><span class="sxs-lookup"><span data-stu-id="c13ba-414">For more information, see [Leader Election Pattern](../patterns/leader-election.md) and [Competing Consumers Pattern](../patterns/competing-consumers.md).</span></span>

## <a name="conflicts"></a><span data-ttu-id="c13ba-415">Конфликты</span><span class="sxs-lookup"><span data-stu-id="c13ba-415">Conflicts</span></span>
<span data-ttu-id="c13ba-416">Если имеется несколько экземпляров фонового задания, возможно, они будут конкурировать за доступ к ресурсам и службам, например базам данных и хранилищу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-416">If you have multiple instances of a background job, it is possible that they will compete for access to resources and services, such as databases and storage.</span></span> <span data-ttu-id="c13ba-417">Такой одновременный доступ может привести к состязанию за ресурсы, что в состоянии вызвать конфликты доступности служб и целостности данных в хранилище.</span><span class="sxs-lookup"><span data-stu-id="c13ba-417">This concurrent access can result in resource contention, which might cause conflicts in availability of the services and in the integrity of data in storage.</span></span> <span data-ttu-id="c13ba-418">Состязание за ресурсы можно разрешить по принципу пессимистической блокировки,</span><span class="sxs-lookup"><span data-stu-id="c13ba-418">You can resolve resource contention by using a pessimistic locking approach.</span></span> <span data-ttu-id="c13ba-419">чтобы предотвратить одновременный доступ к службе конкурирующих экземпляров задачи или повреждение данных.</span><span class="sxs-lookup"><span data-stu-id="c13ba-419">This prevents competing instances of a task from concurrently accessing a service or corrupting data.</span></span>

<span data-ttu-id="c13ba-420">Другой метод разрешения конфликтов — определить фоновые задачи как единственный экземпляр, тогда в любой момент выполняться будет только один экземпляр.</span><span class="sxs-lookup"><span data-stu-id="c13ba-420">Another approach to resolve conflicts is to define background tasks as a singleton, so that there is only ever one instance running.</span></span> <span data-ttu-id="c13ba-421">Однако это устраняет надежность и преимущества производительности, свойственные конфигурации с несколькими экземплярами,</span><span class="sxs-lookup"><span data-stu-id="c13ba-421">However, this eliminates the reliability and performance benefits that a multiple-instance configuration can provide.</span></span> <span data-ttu-id="c13ba-422">особенно в том случае, если пользовательский интерфейс может предоставить достаточный объем работы, чтобы загрузить несколько фоновых задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-422">This is especially true if the UI can supply sufficient work to keep more than one background task busy.</span></span>

<span data-ttu-id="c13ba-423">Крайне важно обеспечить, чтобы фоновая задача могла быть автоматически перезапущена и имела достаточно ресурсов, чтобы по запросу справиться со всплесками нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-423">It is vital to ensure that the background task can automatically restart and that it has sufficient capacity to cope with peaks in demand.</span></span> <span data-ttu-id="c13ba-424">Этого можно достигнуть, выделив вычислительный экземпляр с достаточными ресурсами, реализовав механизм очередей, который может сохранять запросы для последующего выполнения, когда потребность уменьшится, или совместив эти методы.</span><span class="sxs-lookup"><span data-stu-id="c13ba-424">You can achieve this by allocating a compute instance with sufficient resources, by implementing a queueing mechanism that can store requests for later execution when demand decreases, or by using a combination of these techniques.</span></span>

## <a name="coordination"></a><span data-ttu-id="c13ba-425">Координация</span><span class="sxs-lookup"><span data-stu-id="c13ba-425">Coordination</span></span>
<span data-ttu-id="c13ba-426">Фоновые задачи могут быть сложными и требовать выполнения нескольких отдельных задач для получения результата или для осуществления всех требований.</span><span class="sxs-lookup"><span data-stu-id="c13ba-426">The background tasks might be complex and might require multiple individual tasks to execute to produce a result or to fulfil all the requirements.</span></span> <span data-ttu-id="c13ba-427">Чаще всего в этих сценариях задача разделяется на более мелкие скрытые действия или подзадачи, которые могут быть выполнены несколькими объектами-получателями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-427">It is common in these scenarios to divide the task into smaller discreet steps or subtasks that can be executed by multiple consumers.</span></span> <span data-ttu-id="c13ba-428">Многошаговые задания могут быть более эффективными и гибкими, так как отдельные шаги можно многократно использовать в нескольких заданиях.</span><span class="sxs-lookup"><span data-stu-id="c13ba-428">Multistep jobs can be more efficient and more flexible because individual steps might be reusable in multiple jobs.</span></span> <span data-ttu-id="c13ba-429">Также можно легко добавлять и удалять шаги или изменять их порядок.</span><span class="sxs-lookup"><span data-stu-id="c13ba-429">It is also easy to add, remove, or modify the order of the steps.</span></span>

<span data-ttu-id="c13ba-430">Координирование нескольких задач и шагов может оказаться сложной задачей, но существует три общих схемы, которые дозволено использовать для реализации решения:</span><span class="sxs-lookup"><span data-stu-id="c13ba-430">Coordinating multiple tasks and steps can be challenging, but there are three common patterns that you can use to guide your implementation of a solution:</span></span>

* <span data-ttu-id="c13ba-431">**Разложение задачи на несколько шагов, которые можно повторно использовать**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-431">**Decomposing a task into multiple reusable steps**.</span></span> <span data-ttu-id="c13ba-432">От приложения может потребоваться выполнение различных задач разной сложности с информацией, которую оно обрабатывает.</span><span class="sxs-lookup"><span data-stu-id="c13ba-432">An application might be required to perform a variety of tasks of varying complexity on the information that it processes.</span></span> <span data-ttu-id="c13ba-433">Для осуществления такой обработки в виде неделимого модуля может применяться простой, но гибкий способ реализации этого приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-433">A straightforward but inflexible approach to implementing this application might be to perform this processing as a monolithic module.</span></span> <span data-ttu-id="c13ba-434">Однако этот метод, вероятно, сократит возможности для рефакторинга кода, его оптимизации или повторного использования, если части одной и той же обработки потребуются в другом месте приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-434">However, this approach is likely to reduce the opportunities for refactoring the code, optimizing it, or reusing it if parts of the same processing are required elsewhere within the application.</span></span> <span data-ttu-id="c13ba-435">в разделе [Шаблон каналов и фильтров](../patterns/pipes-and-filters.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-435">For more information, see [Pipes and Filters Pattern](../patterns/pipes-and-filters.md).</span></span>
* <span data-ttu-id="c13ba-436">**Управление выполнением шагов для задачи**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-436">**Managing execution of the steps for a task**.</span></span> <span data-ttu-id="c13ba-437">Приложение может выполнять задачи, которые образуют ряд шагов, некоторые из которых в состоянии вызывать удаленные службы или обращаться к удаленным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="c13ba-437">An application might perform tasks that comprise a number of steps (some of which might invoke remote services or access remote resources).</span></span> <span data-ttu-id="c13ba-438">Отдельные шаги могут быть независимы друг от друга, но они подчиняются логике приложения, которая реализует задачу.</span><span class="sxs-lookup"><span data-stu-id="c13ba-438">The individual steps might be independent of each other, but they are orchestrated by the application logic that implements the task.</span></span> <span data-ttu-id="c13ba-439">в разделе [Шаблон супервизора агента планировщика](../patterns/scheduler-agent-supervisor.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-439">For more information, see [Scheduler Agent Supervisor Pattern](../patterns/scheduler-agent-supervisor.md).</span></span>
* <span data-ttu-id="c13ba-440">**Управление восстановлением для шагов задания, завершившихся сбоем**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-440">**Managing recovery for task steps that fail**.</span></span> <span data-ttu-id="c13ba-441">Приложению может потребоваться отменить работу, выполненную рядом шагов, которые вместе образуют согласованную операцию, если один или несколько шагов завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="c13ba-441">An application might need to undo the work that is performed by a series of steps (which together define an eventually consistent operation) if one or more of the steps fail.</span></span> <span data-ttu-id="c13ba-442">в разделе [Шаблон компенсации транзакций](../patterns/compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-442">For more information, see [Compensating Transaction Pattern](../patterns/compensating-transaction.md).</span></span>


## <a name="resiliency-considerations"></a><span data-ttu-id="c13ba-443">Рекомендации по обеспечению устойчивости</span><span class="sxs-lookup"><span data-stu-id="c13ba-443">Resiliency considerations</span></span>
<span data-ttu-id="c13ba-444">Фоновые задачи должны быть устойчивыми, чтобы предоставлять надежные службы для приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-444">Background tasks must be resilient in order to provide reliable services to the application.</span></span> <span data-ttu-id="c13ba-445">При планировании и проектировании фоновых задач необходимо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="c13ba-445">When you are planning and designing background tasks, consider the following points:</span></span>

* <span data-ttu-id="c13ba-446">Фоновые задачи должны иметь возможность корректно обрабатывать перезапуск службы или роли, не повреждая данные или внося несогласованность в приложение.</span><span class="sxs-lookup"><span data-stu-id="c13ba-446">Background tasks must be able to gracefully handle role or service restarts without corrupting data or introducing inconsistency into the application.</span></span> <span data-ttu-id="c13ba-447">Для длительных или многошаговых задач рассмотрите возможность использования *контрольных точек*: можно сохранять состояния заданий в постоянном хранилище или в виде сообщений в очереди, если это целесообразно.</span><span class="sxs-lookup"><span data-stu-id="c13ba-447">For long-running or multistep tasks, consider using *check pointing* by saving the state of jobs in persistent storage, or as messages in a queue if this is appropriate.</span></span> <span data-ttu-id="c13ba-448">Например, можно сохранить сведения о состоянии в сообщении в очереди и постепенно обновлять их по мере выполнения задачи, чтобы задачу можно было обработать с последней известной корректной контрольной точки, а не перезапускать с самого начала.</span><span class="sxs-lookup"><span data-stu-id="c13ba-448">For example, you can persist state information in a message in a queue and incrementally update this state information with the task progress so that the task can be processed from the last known good checkpoint--instead of restarting from the beginning.</span></span> <span data-ttu-id="c13ba-449">При использовании очередей служебной шины Azure этот сценарий реализуется с использованием сеансов обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-449">When using Azure Service Bus queues, you can use message sessions to enable the same scenario.</span></span> <span data-ttu-id="c13ba-450">Сеансы позволяют сохранять и извлекать состояние обработки приложения с помощью методов [SetState](https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.messagesession.setstate?view=azureservicebus-4.0.0) и [GetState](https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.messagesession.getstate?view=azureservicebus-4.0.0).</span><span class="sxs-lookup"><span data-stu-id="c13ba-450">Sessions allow you to save and retrieve the application processing state by using the [SetState](https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.messagesession.setstate?view=azureservicebus-4.0.0) and [GetState](https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.messagesession.getstate?view=azureservicebus-4.0.0) methods.</span></span> <span data-ttu-id="c13ba-451">Дополнительные сведения о проектировании надежных многошаговых процессов и рабочих процессов см. в статье [Scheduler Agent Supervisor Pattern](../patterns/scheduler-agent-supervisor.md) (Шаблон супервизора агента планировщика).</span><span class="sxs-lookup"><span data-stu-id="c13ba-451">For more information about designing reliable multistep processes and workflows, see [Scheduler Agent Supervisor Pattern](../patterns/scheduler-agent-supervisor.md).</span></span>
* <span data-ttu-id="c13ba-452">При использовании веб-ролей или рабочих ролей для размещения нескольких фоновых задач спроектируйте переопределение метода **Run** , чтобы наблюдать за завершенным сбоем или остановленными задачами и перезапускать их.</span><span class="sxs-lookup"><span data-stu-id="c13ba-452">When you use web or worker roles to host multiple background tasks, design your override of the **Run** method to monitor for failed or stalled tasks, and restart them.</span></span> <span data-ttu-id="c13ba-453">Где это неудобно (и вы используете рабочую роль), принудительно перезапускайте рабочую роль с помощью выхода из метода **Run** .</span><span class="sxs-lookup"><span data-stu-id="c13ba-453">Where this is not practical, and you are using a worker role, force the worker role to restart by exiting from the **Run** method.</span></span>
* <span data-ttu-id="c13ba-454">Если для взаимодействия с фоновыми задачами используются очереди, они могут выполнять роль буфера для хранения запросов, отправленных к задачам, когда нагрузка на приложение выше, чем обычно.</span><span class="sxs-lookup"><span data-stu-id="c13ba-454">When you use queues to communicate with background tasks, the queues can act as a buffer to store requests that are sent to the tasks while the application is under higher than usual load.</span></span> <span data-ttu-id="c13ba-455">Это позволяет задачам перехватывать пользовательский интерфейс во время периодов снижения загруженности.</span><span class="sxs-lookup"><span data-stu-id="c13ba-455">This allows the tasks to catch up with the UI during less busy periods.</span></span> <span data-ttu-id="c13ba-456">Также это означает, что перезапуск роли не будет блокировать пользовательский интерфейс.</span><span class="sxs-lookup"><span data-stu-id="c13ba-456">It also means that recycling the role will not block the UI.</span></span> <span data-ttu-id="c13ba-457">в разделе [Queue-Based Load Leveling Pattern](../patterns/queue-based-load-leveling.md).</span><span class="sxs-lookup"><span data-stu-id="c13ba-457">For more information, see [Queue-Based Load Leveling Pattern](../patterns/queue-based-load-leveling.md).</span></span> <span data-ttu-id="c13ba-458">Если некоторые задачи важнее, чем другие, рассмотрите возможность реализации [шаблона очереди с приоритетом](../patterns/priority-queue.md), чтобы гарантировать выполнение этих задач раньше менее важных задач.</span><span class="sxs-lookup"><span data-stu-id="c13ba-458">If some tasks are more important than others, consider implementing the [Priority Queue Pattern](../patterns/priority-queue.md) to ensure that these tasks run before less important ones.</span></span>
* <span data-ttu-id="c13ba-459">В фоновых задачах, которые инициируются сообщениями или обрабатывают их, необходимо реализовать обработку несогласованностей, например сообщений, поступающих не по порядку, сообщений, повторно вызывающих ошибку (часто их называют *сообщениями о сбое*) и сообщений, доставляемых более одного раза.</span><span class="sxs-lookup"><span data-stu-id="c13ba-459">Background tasks that are initiated by messages or process messages must be designed to handle inconsistencies, such as messages arriving out of order, messages that repeatedly cause an error (often referred to as *poison messages*), and messages that are delivered more than once.</span></span> <span data-ttu-id="c13ba-460">Рассмотрим следующее:</span><span class="sxs-lookup"><span data-stu-id="c13ba-460">Consider the following:</span></span>
  * <span data-ttu-id="c13ba-461">Сообщения, которые должны быть обработаны в определенном порядке, например те, что изменяют данные с учетом их существующего значения (например, добавляют значение к существующему значению), могут не поступить в первоначальном порядке, в котором были отправлены.</span><span class="sxs-lookup"><span data-stu-id="c13ba-461">Messages that must be processed in a specific order, such as those that change data based on the existing data value (for example, adding a value to an existing value), might not arrive in the original order in which they were sent.</span></span> <span data-ttu-id="c13ba-462">Кроме того, они могут быть обработаны разными экземплярами фоновой задачи в другом порядке из-за различной нагрузки каждого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c13ba-462">Alternatively, they might be handled by different instances of a background task in a different order due to varying loads on each instance.</span></span> <span data-ttu-id="c13ba-463">Сообщения, которые должны быть обработаны в определенном порядке, должны содержать порядковый номер, ключ или другой индикатор, который фоновые задачи могут использовать, чтобы убедиться, что они обрабатываются в правильном порядке.</span><span class="sxs-lookup"><span data-stu-id="c13ba-463">Messages that must be processed in a specific order should include a sequence number, key, or some other indicator that background tasks can use to ensure that they are processed in the correct order.</span></span> <span data-ttu-id="c13ba-464">При использовании служебной шины Azure, чтобы гарантировать порядок доставки, можно использовать сеансы обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="c13ba-464">If you are using Azure Service Bus, you can use message sessions to guarantee the order of delivery.</span></span> <span data-ttu-id="c13ba-465">Однако обычно бывает целесообразнее спроектировать процесс таким образом, чтобы порядок сообщений не был важен.</span><span class="sxs-lookup"><span data-stu-id="c13ba-465">However, it is usually more efficient, where possible, to design the process so that the message order is not important.</span></span>
  * <span data-ttu-id="c13ba-466">Обычно фоновая задача считывает сообщения из очереди, которая временно скрывает их от других объектов-получателей сообщений</span><span class="sxs-lookup"><span data-stu-id="c13ba-466">Typically, a background task will peek at messages in the queue, which temporarily hides them from other message consumers.</span></span> <span data-ttu-id="c13ba-467">и удаляет после успешной обработки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-467">Then it deletes the messages after they have been successfully processed.</span></span> <span data-ttu-id="c13ba-468">Если при обработке сообщения фоновой задачей произошел сбой, по истечении времени ожидания считывания оно снова появится в очереди</span><span class="sxs-lookup"><span data-stu-id="c13ba-468">If a background task fails when processing a message, that message will reappear on the queue after the peek time-out expires.</span></span> <span data-ttu-id="c13ba-469">и будет обработано другим экземпляром задачи или во время следующего цикла обработки данного экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c13ba-469">It will be processed by another instance of the task or during the next processing cycle of this instance.</span></span> <span data-ttu-id="c13ba-470">Если сообщение постоянно приводит к ошибке в объекте-получателе, оно заблокирует задачу, очередь и, в конечном счете, само приложение, когда очередь заполнится.</span><span class="sxs-lookup"><span data-stu-id="c13ba-470">If the message consistently causes an error in the consumer, it will block the task, the queue, and eventually the application itself when the queue becomes full.</span></span> <span data-ttu-id="c13ba-471">Поэтому крайне важно выявлять и удалять из очереди сообщения о сбое.</span><span class="sxs-lookup"><span data-stu-id="c13ba-471">Therefore, it is vital to detect and remove poison messages from the queue.</span></span> <span data-ttu-id="c13ba-472">При использовании служебной шины Azure сообщения, вызвавшие ошибку, можно автоматически или вручную перемещать в связанную очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c13ba-472">If you are using Azure Service Bus, messages that cause an error can be moved automatically or manually to an associated dead letter queue.</span></span>
  * <span data-ttu-id="c13ba-473">Очереди регулируются механизмами доставки *хотя бы один раз*, но они могут доставлять одно и то же сообщение несколько раз.</span><span class="sxs-lookup"><span data-stu-id="c13ba-473">Queues are guaranteed at *least once* delivery mechanisms, but they might deliver the same message more than once.</span></span> <span data-ttu-id="c13ba-474">Кроме того, если сбой происходит после обработки сообщения фоновой задачей, но перед его удалением из очереди, сообщение станет доступным для повторной обработки.</span><span class="sxs-lookup"><span data-stu-id="c13ba-474">In addition, if a background task fails after processing a message but before deleting it from the queue, the message will become available for processing again.</span></span> <span data-ttu-id="c13ba-475">Фоновые задачи должны быть идемпотентными. Это означает, что повторная обработка одного и того же сообщения не вызывает ошибку или несогласованность в данных приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-475">Background tasks should be idempotent, which means that processing the same message more than once does not cause an error or inconsistency in the application’s data.</span></span> <span data-ttu-id="c13ba-476">Некоторые операции идемпотентны по своему характеру. Например, задание определенного нового значения для сохраненного значения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-476">Some operations are naturally idempotent, such as setting a stored value to a specific new value.</span></span> <span data-ttu-id="c13ba-477">Однако такие операции, как добавление значения к существующему хранимому значению без проверки, осталось ли сохраненное значение таким же, как при изначальной отправке сообщения, приведут к несогласованности.</span><span class="sxs-lookup"><span data-stu-id="c13ba-477">However, operations such as adding a value to an existing stored value without checking that the stored value is still the same as when the message was originally sent will cause inconsistencies.</span></span> <span data-ttu-id="c13ba-478">Очереди служебной шины Azure можно настроить для автоматического удаления повторяющихся сообщений.</span><span class="sxs-lookup"><span data-stu-id="c13ba-478">Azure Service Bus queues can be configured to automatically remove duplicated messages.</span></span>
  * <span data-ttu-id="c13ba-479">Некоторые системы обмена сообщениями, например очереди хранилища Azure и очереди служебной шины Azure, поддерживают свойство количества выводов из очереди, указывающее, сколько раз сообщение было считано из очереди.</span><span class="sxs-lookup"><span data-stu-id="c13ba-479">Some messaging systems, such as Azure storage queues and Azure Service Bus queues, support a de-queue count property that indicates the number of times a message has been read from the queue.</span></span> <span data-ttu-id="c13ba-480">Это может быть удобно для обработки повторяющихся сообщений и сообщений о сбое.</span><span class="sxs-lookup"><span data-stu-id="c13ba-480">This can be useful in handling repeated and poison messages.</span></span> <span data-ttu-id="c13ba-481">Дополнительную информацию см. в разделах [Учебник по асинхронному обмену сообщениями](https://msdn.microsoft.com/library/dn589781.aspx) и [Шаблоны идемпотентности](https://blog.jonathanoliver.com/idempotency-patterns/).</span><span class="sxs-lookup"><span data-stu-id="c13ba-481">For more information, see [Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx) and [Idempotency Patterns](https://blog.jonathanoliver.com/idempotency-patterns/).</span></span>

## <a name="scaling-and-performance-considerations"></a><span data-ttu-id="c13ba-482">Рекомендации по производительности и масштабированию</span><span class="sxs-lookup"><span data-stu-id="c13ba-482">Scaling and performance considerations</span></span>
<span data-ttu-id="c13ba-483">Фоновые задачи должны обеспечивать достаточную производительность, чтобы не блокировать работу приложения и не приводить к несогласованности из-за отложенных операций, когда система находится под нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="c13ba-483">Background tasks must offer sufficient performance to ensure they do not block the application, or cause inconsistencies due to delayed operation when the system is under load.</span></span> <span data-ttu-id="c13ba-484">Как правило, производительность повышается за счет масштабирования вычислительных экземпляров, в которых размещены фоновые задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-484">Typically, performance is improved by scaling the compute instances that host the background tasks.</span></span> <span data-ttu-id="c13ba-485">При планировании и проектировании фоновых задач необходимо учитывать следующие моменты, связанные с масштабируемостью и производительностью:</span><span class="sxs-lookup"><span data-stu-id="c13ba-485">When you are planning and designing background tasks, consider the following points around scalability and performance:</span></span>

* <span data-ttu-id="c13ba-486">Azure поддерживает автоматическое масштабирование (увеличение масштаба, а затем его уменьшение) на основе текущих запросов и загрузки или на основе предопределенного расписания для веб-приложений, веб-ролей и рабочих ролей облачных служб, а также развертываний, размещенных на виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="c13ba-486">Azure supports autoscaling (both scaling out and scaling back in) based on current demand and load--or on a predefined schedule, for Web Apps, Cloud Services web and worker roles, and Virtual Machines hosted deployments.</span></span> <span data-ttu-id="c13ba-487">Эту функцию можно использовать, чтобы обеспечить приложение в целом достаточными возможностями производительности, минимизируя затрачиваемое время выполнения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-487">Use this feature to ensure that the application as a whole has sufficient performance capabilities while minimizing runtime costs.</span></span>
* <span data-ttu-id="c13ba-488">Когда у фоновых задач иные возможности производительности, чем у других частей приложения облачных служб (например, пользовательского интерфейса или таких компонентов, как уровень доступа к данным), размещение фоновых задач вместе в отдельной рабочей роли позволяет независимо масштабировать роли пользовательского интерфейса и фоновых задач, чтобы управлять нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="c13ba-488">Where background tasks have a different performance capability from the other parts of a Cloud Services application (for example, the UI or components such as the data access layer), hosting the background tasks together in a separate worker role allows the UI and background task roles to scale independently to manage the load.</span></span> <span data-ttu-id="c13ba-489">Если возможности производительности нескольких фоновых задач значительно отличаются друг от друга, рекомендуется выделить их в отдельные рабочие роли и масштабировать независимо друг от друга.</span><span class="sxs-lookup"><span data-stu-id="c13ba-489">If multiple background tasks have significantly different performance capabilities from each other, consider dividing them into separate worker roles and scaling each role type independently.</span></span> <span data-ttu-id="c13ba-490">Однако обратите внимание, что это может увеличить затрачиваемое время выполнения по сравнению с объединением всех задач в меньшее число ролей.</span><span class="sxs-lookup"><span data-stu-id="c13ba-490">However, note that this might increase runtime costs compared to combining all the tasks into fewer roles.</span></span>
* <span data-ttu-id="c13ba-491">Просто масштабировать роли может оказаться недостаточно, чтобы предотвратить потерю производительности под нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="c13ba-491">Simply scaling the roles might not be sufficient to prevent loss of performance under load.</span></span> <span data-ttu-id="c13ba-492">Также может потребоваться масштабировать очереди хранилища и другие ресурсы, чтобы не дать одной точке в общей цепочке обработки стать узким местом.</span><span class="sxs-lookup"><span data-stu-id="c13ba-492">You might also need to scale storage queues and other resources to prevent a single point of the overall processing chain from becoming a bottleneck.</span></span> <span data-ttu-id="c13ba-493">Также рассмотрите другие ограничения, например максимальную пропускную способность хранилища и других служб, от которых зависит приложение и фоновые задачи.</span><span class="sxs-lookup"><span data-stu-id="c13ba-493">Also, consider other limitations, such as the maximum throughput of storage and other services that the application and the background tasks rely on.</span></span>
* <span data-ttu-id="c13ba-494">Фоновые задачи должен быть предназначены для масштабирования.</span><span class="sxs-lookup"><span data-stu-id="c13ba-494">Background tasks must be designed for scaling.</span></span> <span data-ttu-id="c13ba-495">Например, они должны иметь возможность динамически определять количество используемых очередей хранилища, чтобы прослушивать или отправлять сообщения в соответствующую очередь.</span><span class="sxs-lookup"><span data-stu-id="c13ba-495">For example, they must be able to dynamically detect the number of storage queues in use in order to listen on or send messages to the appropriate queue.</span></span>
* <span data-ttu-id="c13ba-496">По умолчанию веб-задания масштабируются вместе с соответствующим экземпляром веб-приложений Azure.</span><span class="sxs-lookup"><span data-stu-id="c13ba-496">By default, WebJobs scale with their associated Azure Web Apps instance.</span></span> <span data-ttu-id="c13ba-497">Тем не менее, если требуется, чтобы веб-задание выполнялось только в одном экземпляре, можно создать файл Settings.job, содержащий данные JSON **{ "is_singleton": true }**.</span><span class="sxs-lookup"><span data-stu-id="c13ba-497">However, if you want a WebJob to run as only a single instance, you can create a Settings.job file that contains the JSON data **{ "is_singleton": true }**.</span></span> <span data-ttu-id="c13ba-498">Это заставит Azure запускать только один экземпляр веб-задания, даже если имеется несколько экземпляров связанного веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="c13ba-498">This forces Azure to only run one instance of the WebJob, even if there are multiple instances of the associated web app.</span></span> <span data-ttu-id="c13ba-499">Этот метод удобно использовать для запланированных заданий, которые должны выполняться только в одном экземпляре.</span><span class="sxs-lookup"><span data-stu-id="c13ba-499">This can be a useful technique for scheduled jobs that must run as only a single instance.</span></span>

## <a name="related-patterns"></a><span data-ttu-id="c13ba-500">Связанные шаблоны</span><span class="sxs-lookup"><span data-stu-id="c13ba-500">Related patterns</span></span>
* [<span data-ttu-id="c13ba-501">Учебник по асинхронному обмену сообщениями</span><span class="sxs-lookup"><span data-stu-id="c13ba-501">Asynchronous Messaging Primer</span></span>](https://msdn.microsoft.com/library/dn589781.aspx)
* [<span data-ttu-id="c13ba-502">Руководство по автоматическому масштабированию</span><span class="sxs-lookup"><span data-stu-id="c13ba-502">Autoscaling Guidance</span></span>](https://msdn.microsoft.com/library/dn589774.aspx)
* [<span data-ttu-id="c13ba-503">Шаблон компенсации транзакций</span><span class="sxs-lookup"><span data-stu-id="c13ba-503">Compensating Transaction Pattern</span></span>](../patterns/compensating-transaction.md)
* [<span data-ttu-id="c13ba-504">Шаблон конкурирующих потребителей</span><span class="sxs-lookup"><span data-stu-id="c13ba-504">Competing Consumers Pattern</span></span>](../patterns/competing-consumers.md)
* [<span data-ttu-id="c13ba-505">Рекомендации по разделению вычислений</span><span class="sxs-lookup"><span data-stu-id="c13ba-505">Compute Partitioning Guidance</span></span>](https://msdn.microsoft.com/library/dn589773.aspx)
* [<span data-ttu-id="c13ba-506">Шаблон консолидации вычислительных ресурсов</span><span class="sxs-lookup"><span data-stu-id="c13ba-506">Compute Resource Consolidation Pattern</span></span>](https://msdn.microsoft.com/library/dn589778.aspx)
* [<span data-ttu-id="c13ba-507">Шаблон привратника</span><span class="sxs-lookup"><span data-stu-id="c13ba-507">Gatekeeper Pattern</span></span>](../patterns/gatekeeper.md)
* [<span data-ttu-id="c13ba-508">Шаблон выбора лидера</span><span class="sxs-lookup"><span data-stu-id="c13ba-508">Leader Election Pattern</span></span>](../patterns/leader-election.md)
* [<span data-ttu-id="c13ba-509">Шаблон каналов и фильтров</span><span class="sxs-lookup"><span data-stu-id="c13ba-509">Pipes and Filters Pattern</span></span>](../patterns/pipes-and-filters.md)
* [<span data-ttu-id="c13ba-510">Шаблон очереди с приоритетом</span><span class="sxs-lookup"><span data-stu-id="c13ba-510">Priority Queue Pattern</span></span>](../patterns/priority-queue.md)
* [<span data-ttu-id="c13ba-511">Шаблон балансировки нагрузки на основе очередей</span><span class="sxs-lookup"><span data-stu-id="c13ba-511">Queue-based Load Leveling Pattern</span></span>](../patterns/queue-based-load-leveling.md)
* [<span data-ttu-id="c13ba-512">Шаблон супервизора агента планировщика</span><span class="sxs-lookup"><span data-stu-id="c13ba-512">Scheduler Agent Supervisor Pattern</span></span>](../patterns/scheduler-agent-supervisor.md)

## <a name="more-information"></a><span data-ttu-id="c13ba-513">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="c13ba-513">More information</span></span>
* [<span data-ttu-id="c13ba-514">Выполнение фоновых задач</span><span class="sxs-lookup"><span data-stu-id="c13ba-514">Executing Background Tasks</span></span>](https://msdn.microsoft.com/library/ff803365.aspx)
* <span data-ttu-id="c13ba-515">[Жизненный цикл роли облачных служб Azure](https://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Windows-Azure-Cloud-Services-Role-Lifecycle) (видео)</span><span class="sxs-lookup"><span data-stu-id="c13ba-515">[Azure Cloud Services Role Lifecycle](https://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Windows-Azure-Cloud-Services-Role-Lifecycle) (video)</span></span>
* [<span data-ttu-id="c13ba-516">Информация о пакете SDK веб-заданий</span><span class="sxs-lookup"><span data-stu-id="c13ba-516">What is the Azure WebJobs SDK</span></span>](https://docs.microsoft.com/azure/app-service-web/websites-dotnet-webjobs-sdk)
* [<span data-ttu-id="c13ba-517">Выполнение фоновых задач с веб-заданиями</span><span class="sxs-lookup"><span data-stu-id="c13ba-517">Run Background tasks with WebJobs</span></span>](https://docs.microsoft.com/azure/app-service-web/web-sites-create-web-jobs)
* [<span data-ttu-id="c13ba-518">Очереди Azure и очереди служебной шины: сходства и различия</span><span class="sxs-lookup"><span data-stu-id="c13ba-518">Azure Queues and Service Bus Queues - Compared and Contrasted</span></span>](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted)
* [<span data-ttu-id="c13ba-519">Включение диагностики в облачной службе</span><span class="sxs-lookup"><span data-stu-id="c13ba-519">How to Enable Diagnostics in a Cloud Service</span></span>](https://docs.microsoft.com/azure/cloud-services/cloud-services-dotnet-diagnostics)

