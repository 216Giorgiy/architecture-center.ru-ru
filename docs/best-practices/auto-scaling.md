---
title: Руководство по автоматическому масштабированию
description: Рекомендации относительно автоматического масштабирования для динамического распределения ресурсов, необходимых приложению.
author: dragon119
ms.date: 05/17/2017
pnp.series.title: Best Practices
ms.openlocfilehash: a8489aaabab2b8523fbc9f026f4f435bb6d1ad29
ms.sourcegitcommit: 3d9ee03e2dda23753661a80c7106d1789f5223bb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2018
---
# <a name="autoscaling"></a>Автомасштабирование
[!INCLUDE [header](../_includes/header.md)]

Автомасштабированием называется процесс динамического выделения ресурсов в соответствии с требованиями к производительности. При увеличении объема работ приложению требуются дополнительные ресурсы, чтобы поддерживать необходимый уровень производительности и удовлетворять требования соглашений об уровне обслуживания (SLA). При снижении нагрузки исчезает и потребность в дополнительных ресурсах, а значит их можно освободить для экономии средств.

Автоматическое масштабирование использует преимущества эластичности облачной среды и сокращает издержки на управление, так как оператору не нужно отслеживать производительность системы и принимать решения о добавлении или удалении ресурсов.

Масштабировать приложение можно двумя способами: 

* **Вертикальное масштабирование** (увеличение или уменьшение масштаба), означает изменение производительности ресурса. Например, вы можете перенести приложение на виртуальную машину большего размера. Вертикальное масштабирование обычно сопряжено с временной неработоспособностью системы на период изменений в развертывании. По этой причине вертикальное масштабирование редко выполняется автоматически.
* **Горизонтальное масштабирование** (развертывание и свертывание), означает добавление или удаление экземпляров ресурса. При подготовке новых ресурсов приложение будет работать без перерывов. Когда процесс подготовки завершится, решение будет развернуто на новых дополнительных ресурсах. Если нагрузка снижается, дополнительные ресурсы можно выключить и отключить штатным образом. 

Многие облачные системы, включая Microsoft Azure, поддерживают автоматизацию горизонтального масштабирования. Оставшаяся часть этой статьи посвящена именно горизонтальному масштабированию.

> [!NOTE]
> Автоматическое масштабирование относится в основном к вычислительным ресурсам. Базу данных или очередь сообщений также можно масштабировать горизонтально, но обычно это подразумевает [секционирование данных][data-partitioning], которое не так просто автоматизировать.
>

## <a name="overview"></a>Обзор

Стратегия автомасштабирования обычно включает следующие компоненты:

* Системы инструментирования и мониторинга на уровне приложения, службы и инфраструктуры. Эти системы фиксируют такие ключевые метрики, как время ответа, длина очередей, использование ЦП и памяти.
* Логика принятия решений, которая сравнивает метрики с предопределенными пороговыми значениями или расписаниями и принимает решения о масштабировании.
* Компоненты, которые масштабируют систему.
* Тестирование, мониторинг и настройка стратегии автоматического масштабирования, чтобы убедиться в том, что она работает ожидаемым образом.

Azure предлагает встроенные механизмы для автомасштабирования, разработанные для многих распространенных сценариев. Если какая-то служба или технология не имеет встроенных средств автомасштабирования или если ваши требования не соответствуют их возможностям, вы можете создать пользовательскую реализацию. Ваша система может собирать рабочие и системные метрики, анализировать их и выполнять масштабирование ресурсов соответствующим образом.

## <a name="configure-autoscaling-for-an-azure-solution"></a>Автоматическое масштабирование в решении Azure

Azure поддерживает встроенное автомасштабирование для большинства вычислительных технологий.

* **Виртуальные машины** поддерживают автомасштабирование с использованием [масштабируемых наборов виртуальных машин][vm-scale-sets], которые позволяют управлять набором виртуальных машин Azure как группой. См. статью [Как использовать автомасштабирование и масштабируемые наборы виртуальных машин][vm-scale-sets-autoscale].

* **Service Fabric** также поддерживает автомасштабирование с использованием масштабируемых наборов виртуальных машин. Каждый тип узла в кластере Service Fabric настраивается как отдельный масштабируемый набор виртуальных машин. Это позволяет свертывать и развертывать каждый тип узла независимо от других типов. См. статью [Масштабирование кластера Service Fabric с помощью правил автомасштабирования][service-fabric-autoscale].

* В **службе приложений Azure** реализован встроенный механизм автомасштабирования. Параметры автомасштабирования применяются ко всем приложениям в службе приложений. См. статью [Масштабирование числа экземпляров вручную или автоматически][app-service-autoscale].

* В **облачных службах Azure** реализован встроенный механизм автомасштабирования на уровне роли. См. статью [Как настроить автомасштабирование для облачной службы на портале][cloud-services-autoscale].

Все эти вычислительные системы используют функцию [автомасштабирования Azure Monitor][monitoring], которая включает стандартный набор возможностей для автомасштабирования.

* Решение **Функции Azure** отличается от предыдущих вариантов тем, что для него не нужно настраивать правила автомасштабирования. Вместо этого оно автоматически распределяет вычислительную мощность при выполнении кода, при необходимости развертывая ресурсы в соответствии с нагрузкой. Дополнительные сведения см. в статье [Выбор подходящего плана размещения для Функций Azure][functions-scale].

И наконец, иногда есть смысл создать пользовательское решение для автомасштабирования. Например, вы можете использовать службы диагностики Azure и метрики приложений, чтобы в пользовательском коде отслеживать и экспортировать нужные метрики приложений. На основе этих метрик можно определять пользовательские правила, которые с помощью API REST диспетчера ресурсов будут запускать автомасштабирование. Однако пользовательское решение не так просто реализовать, и его следует рассматривать только в том случае, если ни один из предыдущих подходов вас не устраивает.

Используйте встроенные возможности платформы для автомасштабирования, если они отвечают вашим требованиям. Если же вы планируете применять более сложные функции масштабирования, оцените их целесообразность. Могут появиться, например, такие дополнительные требования, как более точный контроль, разные способы обнаружения событий триггеров для масштабирования, масштабирование с использованием нескольких подписок или масштабирование ресурсов других типов.

## <a name="use-azure-monitor-autoscale"></a>Использование автомасштабирования Azure Monitor

[Автомасштабирование Azure Monitor][monitoring] предоставляет стандартный набор функций для автоматического масштабирования масштабируемых наборов виртуальных машин, службы приложений Azure и облачной службы Azure. Масштабирование можно выполнять по расписанию или на основе метрик среды выполнения, таких как загрузка ЦП или использование памяти. Примеры:

- Развертывание до 10 экземпляров в рабочие дни и свертывание до 4 экземпляров в субботу и воскресенье. 
- Развертывание одного дополнительного экземпляра, если средняя загрузка ЦП превышает 70 %, и свертывание одного экземпляра, если загрузка ЦП опускается ниже 50 %.
- Развертывание одного экземпляра, если число сообщений в очереди превышает определенный порог.

Список встроенных метрик см. в статье [Общие метрики автомасштабирования Azure Monitor][autoscale-metrics]. Вы можете создать собственные метрики с помощью Application Insights. 

Автомасштабирование можно настроить с помощью PowerShell, Azure CLI, шаблонов Azure Resource Manager или портала Azure. Для более точного управления используйте [REST API Azure Resource Manager](https://msdn.microsoft.com//library/azure/dn790568.aspx). [Библиотека управления службами мониторинга Azure](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring) и [библиотека аналитики Microsoft](https://www.nuget.org/packages/Microsoft.Azure.Insights/) (в предварительной версии) — это пакеты SDK, которые позволяют собирать показатели различных ресурсов и выполнять автоматическое масштабирование, используя интерфейсы REST API. Для ресурсов, которые не поддерживают Azure Resource Manager, или при использовании облачных служб Azure для автоматического масштабирования можно воспользоваться REST API управления службами. Во всех остальных случаях для автоматического масштабирования рекомендуется применять Azure Resource Manager.

При использовании автомасштабирования учитывайте следующие аспекты.

* Определите, есть ли у вас возможность прогнозировать нагрузку на приложение с достаточной точностью, чтобы использовать автомасштабирование по расписанию, заранее добавляя и удаляя экземпляры в соответствии с ожидаемыми всплесками нагрузки. Если это невозможно, используйте автомасштабирование на основе метрик среды выполнения, чтобы оперативно реагировать на непредсказуемые изменения спроса. Но обычно мы советуем объединить эти подходы. Например, можно создать стратегию, которая по расписанию добавляет ресурсы перед известными периодами максимальной загрузки приложения. Так вы обеспечите достаточную производительность в нужный момент без задержек, связанных с запуском новых экземпляров. В дополнение к каждому запланированному правилу определите метрики для оперативного автомасштабирования на период действия этого правила, чтобы приложение могло обрабатывать длительные и непредсказуемые всплески нагрузки.
* Зачастую сложно понять связь между метриками и требованиями к мощности, особенно в случае, если приложение изначально развернуто. Для начала выделите мощность с некоторым запасом, а затем наблюдайте и корректируйте работу правил автомасштабирования, чтобы выделяемая мощность как можно точнее соответствовала реальной нагрузке.
* Настройте правила автомасштабирования, а затем отслеживайте изменения в производительности приложения. Используйте результаты такого отслеживания для настройки способа масштабирования системы при необходимости. Однако помните, что автоматическое масштабирование не выполняется мгновенно. Требуется время, чтобы среагировать на метрики, такие как средняя загрузка ЦП, превышающая указанное пороговое значение (или находящаяся ниже него).
* Правила автоматического масштабирования, использующие механизм обнаружения на основе измеренного атрибута триггера (например, загрузка ЦП или длина очереди), применяют агрегированное значение по времени, а не конкретное значение, чтобы запустить действие автоматического масштабирования. По умолчанию агрегированное значение — это среднее значение. Это позволяет предотвратить слишком быстрое реагирование системы или появление быстрых колебаний. При этом новым экземплярам, которые запускаются автоматически, также предоставляется время на переход в режим выполнения, что предотвращает выполнение дополнительных действий автоматического масштабирования в то время, когда происходит запуск новых экземпляров. Для облачных служб и виртуальных машин Azure период агрегирования по умолчанию составляет 45 минут, поэтому для запуска метрикой автоматического масштабирования в ответ на пиковую нагрузку может потребоваться как раз такое время. Период агрегирования можно изменить с помощью пакета SDK, но помните, что период длительностью менее 25 минут может привести к непредсказуемым результатам. Дополнительные сведения см. в статье [Auto Scaling Cloud Services on CPU Percentage with the Azure Monitoring Services Management Library](http://rickrainey.com/2013/12/15/auto-scaling-cloud-services-on-cpu-percentage-with-the-windows-azure-monitoring-services-management-library/) (Автоматическое масштабирование облачных служб на основе загрузки ЦП с помощью библиотеки управления службами мониторинга Azure). Для веб-приложений средний период намного меньше, благодаря чему новые экземпляры доступны приблизительно в течение пяти минут после изменения среднего показателя триггера.
* Если вы настраиваете автомасштабирование с помощью пакета SDK, а не на портале, вы можете указать более подробное расписание для использования правил. Можно также создать свои собственные метрики и использовать их как отдельно, так и в сочетании с любыми метриками, существующими в правилах автоматического масштабирования. Например, можно использовать альтернативные счетчики (числа запросов в секунду, объема доступной памяти и т. д.), либо настраиваемые счетчики, измеряющие определенные бизнес-процессы.
* Если вы настраиваете автомасштабирование для Service Fabric, учтите, что типы узлов в кластере соответствуют масштабируемым наборам виртуальных машин в серверной части. Это значит, что правила автомасштабирования нужно настраивать отдельно для каждого типа узлов. Перед настройкой автомасштабирования обратите внимание на необходимое количество узлов. Минимальное количество узлов, необходимое для основного типа узлов, зависит от выбранного уровня надежности. Дополнительные сведения см. в статье [Масштабирование кластера Service Fabric с помощью правил автомасштабирования](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-scale-up-down).
* С помощью портала вы можете связать ресурсы (такие как экземпляры базы данных SQL и очереди) с экземпляром облачной службы. Это позволяет упростить доступ к отдельным вариантам конфигурации масштабирования вручную и автоматически для всех связанных ресурсов. Дополнительные сведения см. в статье [Управление облачными службами](/azure/cloud-services/cloud-services-how-to-manage).
* При настройке нескольких политик и правил существует вероятность, что они могут конфликтовать друг с другом. Функция автоматического масштабирования использует следующие правила разрешения конфликтов, чтобы гарантировать, что всегда будет достаточное количество экземпляров.
  * Операции масштабирования наружу всегда имеют приоритет над операциями масштабирования внутрь.
  * При возникновении конфликта операций масштабирования наружу приоритет имеет правило, которое инициирует наибольшее увеличение числа экземпляров.
  * При возникновении конфликта операций масштабирования внутрь приоритет имеет правило, которое инициирует наименьшее уменьшение числа экземпляров.
* Чтобы определить правила автомасштабирования в среде службы приложений, можно использовать любые метрики рабочего пула или внешнего интерфейса. Дополнительные сведения см. в статье [Автомасштабирование и среда службы приложений версии 1](/azure/app-service/app-service-environment-auto-scale).

## <a name="application-design-considerations"></a>Рекомендации по проектированию приложений
Автоматическое масштабирование не реализуется мгновенно. Простое добавление ресурсов в систему или ввод в эксплуатацию большего числа экземпляров процесса не гарантирует, что это приведет к повышению производительности системы. При разработке стратегии автоматического масштабирования необходимо учитывать следующее.

* Система должна поддерживать возможность горизонтального масштабирования. Избегайте делать предположения относительно определения экземпляра; не создавайте решения, которые требуют, чтобы код всегда выполнялся в конкретном экземпляре процесса. При масштабировании облачной службы или веб-сайта не следует предполагать, что последовательность запросов из одного и того же источника всегда будет направляться в один и тот же экземпляр. По этой же причине службы следует разрабатывать без сохранения состояния. Это позволит избежать того, чтобы серия запросов из приложения всегда направлялась в тот же экземпляр службы. При разработке службы, которая считывает сообщения из очереди и обрабатывает их, не делайте никаких предположений о том, какой экземпляр службы обрабатывает определенное сообщение. Функция автоматического масштабирования может запустить дополнительные экземпляры службы при увеличении длины очереди. В описании [шаблона конкурирующих потребителей][competing-consumers] показано решение для этого сценария.
* Если решение реализует длительно выполняемую задачу, то такую задачу следует создать так, чтобы она поддерживала как масштабирование наружу, так и масштабирование внутрь. Без соответствующей разработки такая задача может помешать аккуратному завершению работы экземпляра процесса при свертывании системы или привести к потере данных, если процесс принудительно завершен. В идеале для длительно выполняемой задачи следует выполнить рефакторинг и разбить процесс обработки, которую он выполняет, на отдельные фрагменты. В описании [шаблона с каналами и фильтрами][pipes-and-filters] представлен пример того, как это можно сделать.
* Кроме того, можно реализовать механизм контрольных точек, который регулярно записывает сведения о состоянии задачи через определенные интервалы времени, а затем сохраняет это состояние в долговременном хранилище, доступ к которому может получить любой экземпляр процесса, выполняющего задачу. Таким образом, если процесс завершен, работу, которую он выполнял, можно возобновить с последней контрольной точки с помощью другого экземпляра.
* Когда фоновые задачи выполняются в отдельных вычислительных операциях, таких как рабочие роли облачных служб, в которых размещено приложение, может потребоваться масштабирование различных частей приложения с использованием различных политик масштабирования. Например, может потребоваться развернуть дополнительные вычислительные операции пользовательского интерфейса без увеличения числа фоновых экземпляров вычислительных операций или наоборот. Если предлагаются различные уровни обслуживания (например, пакеты служб Basic и Premium), может потребоваться масштабировать вычислительные ресурсы для пакетов служб Premium активнее, чем для пакета служб Basic, чтобы обеспечить соблюдение требований соглашения об уровне обслуживания.
* Рассмотрите возможность использования длины очереди, через которую взаимодействуют пользовательский интерфейс и фоновые вычислительные операции, в качестве ведущего критерия стратегии автоматического масштабирования. Это лучший показатель несоответствия или различия между текущей нагрузкой и производительностью обработки фоновой задачи.
* Если стратегия автоматического масштабирования основана на счетчиках, измеряющих бизнес-процессы (например, количество заказов, размещенных в час, или среднее время выполнения сложной транзакции), убедитесь в том, что вы полностью понимаете связь между результатами, получаемыми от этих типов счетчиков, и требованиями к фактической емкости вычислительных ресурсов. В ответ на изменения в данных, поступаемых от счетчиков бизнес-процессов, может потребоваться масштабировать несколько компонентов или единиц вычисления.  
* Чтобы предотвратить попытки системы выполнить чрезмерное масштабирование и избежать затрат, связанных с выполнением тысяч экземпляров, рекомендуется ограничить максимальное количество экземпляров, которые можно добавлять автоматически. Большинство механизмов автоматического масштабирования позволяют указать минимальное и максимальное число экземпляров для правила. Кроме того, рекомендуется корректно снизить функциональные возможности системы, если развернуто максимальное количество экземпляров, но система по-прежнему перегружена.
* Помните, что автоматическое масштабирование может оказаться не таким уж и полезным механизмом в случае внезапного резкого увеличения рабочей нагрузки. Для подготовки и запуска новых экземпляров службы или добавления ресурсов в систему требуется время, а к моменту, когда эти дополнительные ресурсы станут доступны, пик нагрузки может пройти. В этом случае лучше всего подходит регулирование службы. Дополнительные сведения см. в описании [шаблона регулирования][throttling].
* И наоборот, если требуется вычислительная мощность для обработки всех запросов, когда объем изменяется достаточно быстро, а стоимость не является определяющим фактором, рассмотрите возможность использования стратегии агрессивного автоматического масштабирования, в рамках которой дополнительные экземпляры запускаются быстрее. Можно также использовать вариант применения запланированной политики, которая запускает достаточное количество экземпляров для обработки максимальной нагрузки до того, когда эта нагрузка ожидается.
* Механизм автоматического масштабирования должен контролировать процесс автоматического масштабирования и фиксировать подробные сведения о каждом событии (что стало причиной, какие ресурсы были добавлены или удалены и когда). При создании настраиваемого механизма автоматического масштабирования обязательно реализуйте в нем эту функциональную возможность. Полученные сведения можно проанализировать, чтобы измерить эффективность стратегии автоматического масштабирования и при необходимости адаптировать ее. Ее можно настроить как в краткосрочной перспективе, по мере того, как шаблоны использования становятся более очевидными, так и в долгосрочной перспективе, по мере расширения бизнеса или изменения требований приложения. Если приложение достигает верхнего предела, определенного для автоматического масштабирования, механизм может также оповестить оператора, который может при необходимости вручную запустить дополнительные ресурсы. Обратите внимание, что при этих обстоятельствах оператор также может отвечать за удаление этих ресурсов вручную после снижения рабочей нагрузки.

## <a name="related-patterns-and-guidance"></a>Связанные шаблоны и рекомендации
При реализации автоматического масштабирования рекомендуется принять во внимание следующие шаблоны и рекомендации.

* [Шаблон регулирования][throttling]. Этот шаблон описывает, каким образом приложение может продолжить работать и обеспечивать выполнение требований соглашений об уровне обслуживания по мере увеличения нагрузки на ресурсы. Регулирование можно использовать совместно с автоматическим масштабированием для предотвращения перегрузки системы во время ее масштабирования наружу.
* [Шаблон конкурирующих потребителей][competing-consumers]. Этот шаблон описывает то, как реализуется пул экземпляров службы, которые могут обрабатывать сообщения от любого экземпляра приложения. Автоматическое масштабирование можно использовать для запуска и остановки экземпляров службы в соответствии с ожидаемой рабочей нагрузкой. Такой подход позволяет обрабатывать несколько сообщений одновременно, чтобы оптимизировать пропускную способность для повышения масштабируемости и доступности, а также для распределения рабочей нагрузки в системе.
* [Мониторинг и диагностика](./monitoring.md). Инструментирование и телеметрия очень важны для сбора информации, которая требуется в процессе автоматического масштабирования.


<!-- links -->

[monitoring]: /azure/monitoring-and-diagnostics/monitoring-overview-autoscale
[app-service-autoscale]: /azure/monitoring-and-diagnostics/insights-how-to-scale?toc=%2fazure%2fapp-service-web%2ftoc.json#scaling-based-on-a-pre-set-metric
[app-service-plan]: /azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview
[autoscale-metrics]: /azure/monitoring-and-diagnostics/insights-autoscale-common-metrics
[cloud-services-autoscale]: /azure/cloud-services/cloud-services-how-to-scale-portal
[competing-consumers]: ../patterns/competing-consumers.md
[data-partitioning]: ./data-partitioning.md
[functions-scale]: /azure/azure-functions/functions-scale
[link-resource-to-cloud-service]: /azure/cloud-services/cloud-services-how-to-manage#how-to-link-a-resource-to-a-cloud-service
[pipes-and-filters]: ../patterns/pipes-and-filters.md
[service-fabric-autoscale]: /azure/service-fabric/service-fabric-cluster-scale-up-down
[throttling]: ../patterns/throttling.md
[vm-scale-sets]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vm-scale-sets-autoscale]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview
