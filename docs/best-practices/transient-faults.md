---
title: Общие рекомендации по повторным попыткам
titleSuffix: Best practices for cloud applications
description: Рекомендации по работе с повторными попытками для обработки временных сбоев.
author: dragon119
ms.date: 07/13/2016
ms.custom: seodec18
ms.openlocfilehash: 00ea1e21bcef2c3de271bec8aebb4a3cb482f57f
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011826"
---
# <a name="transient-fault-handling"></a><span data-ttu-id="0c87c-103">Обработка временных сбоев</span><span class="sxs-lookup"><span data-stu-id="0c87c-103">Transient fault handling</span></span>

<span data-ttu-id="0c87c-104">Все приложения, взаимодействующие с удаленными службами и ресурсами, должны быть чувствительны ко временным сбоям.</span><span class="sxs-lookup"><span data-stu-id="0c87c-104">All applications that communicate with remote services and resources must be sensitive to transient faults.</span></span> <span data-ttu-id="0c87c-105">Это особенно важно для приложений, работающих в облаке, поскольку в этом случае подобные ошибки возникают чаще из-за природы среды и использования подключения через Интернет.</span><span class="sxs-lookup"><span data-stu-id="0c87c-105">This is especially the case for applications that run in the cloud, where the nature of the environment and connectivity over the Internet means these types of faults are likely to be encountered more often.</span></span> <span data-ttu-id="0c87c-106">Временные сбои включают в себя кратковременную потерю сетевого подключения для компонентов и служб, временную недоступность службы или наличие времени ожидания, вызванного занятостью службы.</span><span class="sxs-lookup"><span data-stu-id="0c87c-106">Transient faults include the momentary loss of network connectivity to components and services, the temporary unavailability of a service, or timeouts that arise when a service is busy.</span></span> <span data-ttu-id="0c87c-107">Эти ошибки часто устраняются без вмешательства со стороны пользователя, поэтому если повторить действие через некоторый промежуток времени, оно с большой вероятностью будет выполнено успешно.</span><span class="sxs-lookup"><span data-stu-id="0c87c-107">These faults are often self-correcting, and if the action is repeated after a suitable delay it is likely succeed.</span></span>

<span data-ttu-id="0c87c-108">В этом документе рассматриваются общие рекомендации по обработке временных ошибок.</span><span class="sxs-lookup"><span data-stu-id="0c87c-108">This document covers general guidance for transient fault handling.</span></span> <span data-ttu-id="0c87c-109">Сведения об обработке временных сбоев при использовании служб Microsoft Azure см. в статье [Конкретные рекомендации по использованию механизма повторов](./retry-service-specific.md).</span><span class="sxs-lookup"><span data-stu-id="0c87c-109">For information about handling transient faults when using Microsoft Azure services, see [Azure service-specific retry guidelines](./retry-service-specific.md).</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="why-do-transient-faults-occur-in-the-cloud"></a><span data-ttu-id="0c87c-110">Почему временные сбои возникают в облаке?</span><span class="sxs-lookup"><span data-stu-id="0c87c-110">Why do transient faults occur in the cloud?</span></span>

<!-- markdownlint-enable MD026 -->

<span data-ttu-id="0c87c-111">Временные сбои могут возникать в любой среде, на любой платформе, в любой операционной системе и в приложении любого типа.</span><span class="sxs-lookup"><span data-stu-id="0c87c-111">Transient faults can occur in any environment, on any platform or operating system, and in any kind of application.</span></span> <span data-ttu-id="0c87c-112">В решениях, выполняющихся в локальной инфраструктуре, производительность и доступность приложения и его компонентов обычно поддерживается за счет аппаратного резервирования, которое дорого обходится и часто приводит к неэффективному использованию ресурсов, а компоненты и ресурсы расположены рядом друг с другом.</span><span class="sxs-lookup"><span data-stu-id="0c87c-112">In solutions that run on local, on-premises infrastructure, performance and availability of the application and its components is typically maintained through expensive and often under-used hardware redundancy, and components and resources are located close to each another.</span></span> <span data-ttu-id="0c87c-113">Хотя это снижает вероятность сбоя, временные сбои все равно происходят, возможен даже простой, вызванный непредвиденным событием, таким как проблемы с внешним источником питания или сетью, либо при возникновении других аварийных ситуаций.</span><span class="sxs-lookup"><span data-stu-id="0c87c-113">While this makes a failure less likely, it can still result in transient faults - and even an outage through unforeseen events such as external power supply or network issues, or other disaster scenarios.</span></span>

<span data-ttu-id="0c87c-114">Размещение в облаке, включая системы на базе частного облака, предлагает повышенную общую доступность благодаря использованию общих ресурсов, резервированию, автоматической отработке отказа и динамическому распределению ресурсов между огромным количеством стандартных вычислительных узлов.</span><span class="sxs-lookup"><span data-stu-id="0c87c-114">Cloud hosting, including private cloud systems, can offer a higher overall availability by using shared resources, redundancy, automatic failover, and dynamic resource allocation across a huge number of commodity compute nodes.</span></span> <span data-ttu-id="0c87c-115">Однако по своей природе такие среды больше предрасположены к возникновению временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="0c87c-115">However, the nature of these environments can mean that transient faults are more likely to occur.</span></span> <span data-ttu-id="0c87c-116">Для этого существует несколько причин.</span><span class="sxs-lookup"><span data-stu-id="0c87c-116">There are several reasons for this:</span></span>

- <span data-ttu-id="0c87c-117">Многие ресурсы в облачной среде являются общими, и доступ к этим ресурсам может регулироваться в целях защиты ресурса.</span><span class="sxs-lookup"><span data-stu-id="0c87c-117">Many resources in a cloud environment are shared, and access to these resources is subject to throttling in order to protect the resource.</span></span> <span data-ttu-id="0c87c-118">Некоторые службы отклоняют подключения, когда нагрузка возрастает до определенного уровня или достигается максимальная пропускная способность, чтобы обеспечить обработку существующих запросов и поддерживать уровень производительности службы для всех пользователей.</span><span class="sxs-lookup"><span data-stu-id="0c87c-118">Some services will refuse connections when the load rises to a specific level, or a maximum throughput rate is reached, in order to allow processing of existing requests and to maintain performance of the service for all users.</span></span> <span data-ttu-id="0c87c-119">Регулирование помогает обеспечить качество обслуживания для соседних узлов и других клиентов с помощью общего ресурса.</span><span class="sxs-lookup"><span data-stu-id="0c87c-119">Throttling helps to maintain the quality of service for neighbors and other tenants using the shared resource.</span></span>

- <span data-ttu-id="0c87c-120">Облачные среды состоят из большого числа стандартных аппаратных блоков.</span><span class="sxs-lookup"><span data-stu-id="0c87c-120">Cloud environments are built using vast numbers of commodity hardware units.</span></span> <span data-ttu-id="0c87c-121">Они обеспечивают производительность путем динамического распределения нагрузки между несколькими вычислительными блоками и компонентами инфраструктуры, а также надежность благодаря автоматическому перезапуску или замене неисправных блоков.</span><span class="sxs-lookup"><span data-stu-id="0c87c-121">They deliver performance by dynamically distributing the load across multiple computing units and infrastructure components, and deliver reliability by automatically recycling or replacing failed units.</span></span> <span data-ttu-id="0c87c-122">Такой динамический характер подразумевает периодическое возникновение временных сбоев и ошибок подключения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-122">This dynamic nature means that transient faults and temporary connection failures may occasionally occur.</span></span>

- <span data-ttu-id="0c87c-123">Часто в таких средах между приложением и используемыми им ресурсами и службами применяется больше аппаратных компонентов, включая сетевую инфраструктуру, например маршрутизаторы и подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-123">There are often more hardware components, including network infrastructure such as routers and load balancers, between the application and the resources and services it uses.</span></span> <span data-ttu-id="0c87c-124">Эта дополнительная инфраструктура иногда может стать причиной дополнительной задержки подключения и временных сбоев соединения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-124">This additional infrastructure can occasionally introduce additional connection latency and transient connection faults.</span></span>

- <span data-ttu-id="0c87c-125">Состояние сети между клиентом и сервером может изменяться, особенно в том случае, когда связь осуществляется через Интернет.</span><span class="sxs-lookup"><span data-stu-id="0c87c-125">Network conditions between the client and the server may be variable, especially when communication crosses the Internet.</span></span> <span data-ttu-id="0c87c-126">Даже в локальных средах значительные объемы трафика могут замедлить взаимодействие и привести к сбоям промежуточных соединений.</span><span class="sxs-lookup"><span data-stu-id="0c87c-126">Even in on-premises locations, very heavy traffic loads may slow communication and cause intermittent connection failures.</span></span>

## <a name="challenges"></a><span data-ttu-id="0c87c-127">Сложности</span><span class="sxs-lookup"><span data-stu-id="0c87c-127">Challenges</span></span>

<span data-ttu-id="0c87c-128">Временные сбои могут оказывать крайне негативное влияние на воспринимаемый пользователями уровень доступности приложения, даже если оно тщательно протестировано во всех ожидаемых обстоятельствах.</span><span class="sxs-lookup"><span data-stu-id="0c87c-128">Transient faults can have a huge impact on the perceived availability of an application, even if it has been thoroughly tested under all foreseeable circumstances.</span></span> <span data-ttu-id="0c87c-129">Для обеспечения надежной работы размещенных в облаке приложений они должны отвечать следующим требованиям.</span><span class="sxs-lookup"><span data-stu-id="0c87c-129">To ensure that cloud-hosted applications operate reliably, they must be able to respond to the following challenges:</span></span>

- <span data-ttu-id="0c87c-130">Приложение должно иметь возможность обнаруживать ошибки при их возникновения и определять, являются ли эти ошибки временными, долгосрочными или окончательными.</span><span class="sxs-lookup"><span data-stu-id="0c87c-130">The application must be able to detect faults when they occur, and determine if these faults are likely to be transient, more long-lasting, or are terminal failures.</span></span> <span data-ttu-id="0c87c-131">Разные ресурсы, скорее всего, возвращают разные отклики при возникновении сбоя, кроме того, такие отклики могут зависеть и от контекста операции. Например, отклик на ошибку при чтении из хранилища может отличаться от отклика на ошибку при записи в хранилище.</span><span class="sxs-lookup"><span data-stu-id="0c87c-131">Different resources are likely to return different responses when a fault occurs, and these responses may also vary depending on the context of the operation; for example, the response for an error when reading from storage may be different from response for an error when writing to storage.</span></span> <span data-ttu-id="0c87c-132">Многие ресурсы и службы имеют хорошо задокументированные контракты временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="0c87c-132">Many resources and services have well-documented transient failure contracts.</span></span> <span data-ttu-id="0c87c-133">Однако в случае отсутствия таких сведений часто бывает трудно определить характер ошибки, как и то, является ли она временной.</span><span class="sxs-lookup"><span data-stu-id="0c87c-133">However, where such information is not available, it may be difficult to discover the nature of the fault and whether it is likely to be transient.</span></span>

- <span data-ttu-id="0c87c-134">Приложение должно иметь возможность повторить операцию, если оно определяет, что сбой с большой вероятностью является временным, и отслеживать количество повторных попыток выполнения операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-134">The application must be able to retry the operation if it determines that the fault is likely to be transient and keep track of the number of times the operation was retried.</span></span>

- <span data-ttu-id="0c87c-135">Приложение должно использовать соответствующую стратегию в отношении повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-135">The application must use an appropriate strategy for the retries.</span></span> <span data-ttu-id="0c87c-136">Эта стратегия указывает количество допустимых повторных попыток, задержку между попытками и действия, которые следует предпринять после неудачной попытки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-136">This strategy specifies the number of times it should retry, the delay between each attempt, and the actions to take after a failed attempt.</span></span> <span data-ttu-id="0c87c-137">Часто подходящее количество попыток и задержку между ними бывает трудно определить, поскольку эти значения зависят от типа ресурса, текущих условий работы ресурса и самого приложения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-137">The appropriate number of attempts and the delay between each one are often difficult to determine, and vary based on the type of resource as well as the current operating conditions of the resource and the application itself.</span></span>

## <a name="general-guidelines"></a><span data-ttu-id="0c87c-138">Общие рекомендации</span><span class="sxs-lookup"><span data-stu-id="0c87c-138">General guidelines</span></span>

<span data-ttu-id="0c87c-139">Следующие рекомендации помогут вам разработать подходящий механизм обработки временных сбоев для своих приложений.</span><span class="sxs-lookup"><span data-stu-id="0c87c-139">The following guidelines will help you to design a suitable transient fault handing mechanism for your applications:</span></span>

- <span data-ttu-id="0c87c-140">**Определите, имеется ли встроенный механизм повторных попыток.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-140">**Determine if there is a built-in retry mechanism:**</span></span>

  - <span data-ttu-id="0c87c-141">Многие службы предоставляют пакет SDK или клиентскую библиотеку с механизмом обработки временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="0c87c-141">Many services provide an SDK or client library that contains a transient fault handling mechanism.</span></span> <span data-ttu-id="0c87c-142">Политика повторов, как правило, специально подгоняется под характер и требования целевой службы.</span><span class="sxs-lookup"><span data-stu-id="0c87c-142">The retry policy it uses is typically tailored to the nature and requirements of the target service.</span></span> <span data-ttu-id="0c87c-143">Кроме того, интерфейсы REST для служб могут возвращать сведения, которые помогают определить, уместна ли повторная попытка и как долго следует ожидать следующей попытки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-143">Alternatively, REST interfaces for services may return information that is useful in determining whether a retry is appropriate, and how long to wait before the next retry attempt.</span></span>

  - <span data-ttu-id="0c87c-144">Используйте встроенный механизм повтора при его наличии, если только у вас нет четких и понятных требований, описывающих иную процедуру выполнения повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-144">Use the built-in retry mechanism where one is available unless you have specific and well-understood requirements that mean a different retry behavior is more appropriate.</span></span>

- <span data-ttu-id="0c87c-145">**Определите, подходит ли для операция для повторной попытки**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-145">**Determine if the operation is suitable for retrying**:</span></span>

  - <span data-ttu-id="0c87c-146">Операции следует повторять только в том случае, когда ошибки являются временными (обычно на это указывает характер ошибки) и имеется хотя бы некоторая вероятность того, что при повторной попытке операция будет выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="0c87c-146">You should only retry operations where the faults are transient (typically indicated by the nature of the error), and if there is at least some likelihood that the operation will succeed when reattempted.</span></span> <span data-ttu-id="0c87c-147">Нет смысла в повторным выполнении недопустимых операций, например обновления несуществующего элемента в базе данных либо запросов к службе или ресурсу, в которых произошла неустранимая ошибка.</span><span class="sxs-lookup"><span data-stu-id="0c87c-147">There is no point in reattempting operations that indicate an invalid operation such as a database update to an item that does not exist, or requests to a service or resource that has suffered a fatal error</span></span>

  - <span data-ttu-id="0c87c-148">Как правило, повторные попытки следует предпринимать только в том случае, когда можно определить все последствия, а условия хорошо понятны и могут быть проверены.</span><span class="sxs-lookup"><span data-stu-id="0c87c-148">In general, you should implement retries only where the full impact of this can be determined, and the conditions are well understood and can be validated.</span></span> <span data-ttu-id="0c87c-149">В противном случае повторные попытки должен реализовать вызывающий код.</span><span class="sxs-lookup"><span data-stu-id="0c87c-149">If not, leave it to the calling code to implement retries.</span></span> <span data-ttu-id="0c87c-150">Помните, что ошибки, возвращенные из неподконтрольных вам ресурсов и служб, могут видоизменяться с течением времени, поэтому вам может потребоваться пересматривать свою логическую схему обнаружения временных ошибок.</span><span class="sxs-lookup"><span data-stu-id="0c87c-150">Remember that the errors returned from resources and services outside your control may evolve over time, and you may need to revisit your transient fault detection logic.</span></span>

  - <span data-ttu-id="0c87c-151">При создании служб или компонентов рассмотрите возможность реализации кодов ошибок и сообщений, которые помогут клиентам определить потребность в повторном выполнении неудачных операций.</span><span class="sxs-lookup"><span data-stu-id="0c87c-151">When you create services or components, consider implementing error codes and messages that will help clients determine whether they should retry failed operations.</span></span> <span data-ttu-id="0c87c-152">В частности укажите, должен ли клиент повторить операцию (возможно, возвратив значение **isTransient** ), и предложите подходящую задержку перед следующей повторной попыткой.</span><span class="sxs-lookup"><span data-stu-id="0c87c-152">In particular, indicate if the client should retry the operation (perhaps by returning an **isTransient** value) and suggest a suitable delay before the next retry attempt.</span></span> <span data-ttu-id="0c87c-153">При создании веб-службы рассмотрите возможность возврата настраиваемых ошибок, определенных в сервисных контрактах.</span><span class="sxs-lookup"><span data-stu-id="0c87c-153">If you build a web service, consider returning custom errors defined within your service contracts.</span></span> <span data-ttu-id="0c87c-154">Хотя эти сведения не смогут считать универсальные клиенты, они будут полезны при создании пользовательских клиентов.</span><span class="sxs-lookup"><span data-stu-id="0c87c-154">Even though generic clients may not be able to read these, they will be useful when building custom clients.</span></span>

- <span data-ttu-id="0c87c-155">**Определите соответствующее число повторных попыток и интервал между ними.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-155">**Determine an appropriate retry count and interval:**</span></span>

  - <span data-ttu-id="0c87c-156">Крайне важно оптимизировать число повторных попыток и интервал согласно типу варианта использования.</span><span class="sxs-lookup"><span data-stu-id="0c87c-156">It is vital to optimize the retry count and the interval to the type of use case.</span></span> <span data-ttu-id="0c87c-157">Если не предпринять достаточное количество повторных попыток, приложение не сможет завершить операцию, в результате чего возникнет сбой.</span><span class="sxs-lookup"><span data-stu-id="0c87c-157">If you do not retry a sufficient number of times, the application will be unable to complete the operation and is likely to experience a failure.</span></span> <span data-ttu-id="0c87c-158">Если предпринять слишком много повторных попыток или установить слишком короткий интервал между ними, приложение может длительно занимать такие ресурсы, как потоки, подключения и память, что отрицательно повлияет на работоспособность приложения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-158">If you retry too many times, or with too short an interval between tries, the application can potentially hold resources such as threads, connections, and memory for long periods, which will adversely affect the health of the application.</span></span>

  - <span data-ttu-id="0c87c-159">Соответствующие значения для интервала времени и количества повторных попыток зависят от типа предпринятой операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-159">The appropriate values for the time interval and the number of retry attempts depend on the type of operation being attempted.</span></span> <span data-ttu-id="0c87c-160">Например, если операция является частью взаимодействия с пользователем, следует использовать короткий интервал и всего несколько повторных попыток, чтобы не заставлять пользователя дожидаться отклика (при этом удерживается открытым подключение и может снижаться доступность для других пользователей).</span><span class="sxs-lookup"><span data-stu-id="0c87c-160">For example, if the operation is part of a user interaction, the interval should be short and only a few retries attempted to avoid making users wait for a response (which holds open connections and can reduce availability for other users).</span></span> <span data-ttu-id="0c87c-161">Если операция является частью длительного или критически важного рабочего процесса, отмена и перезапуск которого выливаются в значительные затраты или требуют много времени, рекомендуется увеличить время ожидания между повторными попытками и число самих попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-161">If the operation is part of a long running or critical workflow, where cancelling and restarting the process is expensive or time-consuming, it is appropriate to wait longer between attempts and retry more times.</span></span>

  - <span data-ttu-id="0c87c-162">Определение соответствующих интервалов между повторными попытками является самой сложной задачей при разработке успешной стратегии.</span><span class="sxs-lookup"><span data-stu-id="0c87c-162">Determining the appropriate intervals between retries is the most difficult part of designing a successful strategy.</span></span> <span data-ttu-id="0c87c-163">В типичных стратегиях применяются следующие типы интервала между повторными попытками.</span><span class="sxs-lookup"><span data-stu-id="0c87c-163">Typical strategies use the following types of retry interval:</span></span>

    - <span data-ttu-id="0c87c-164">**Экспоненциальная задержка**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-164">**Exponential back-off**.</span></span> <span data-ttu-id="0c87c-165">Перед первой повторной попыткой приложение выдерживает небольшой интервал, а для каждой последующей попытки интервал увеличивается по экспоненциальному закону.</span><span class="sxs-lookup"><span data-stu-id="0c87c-165">The application waits a short time before the first retry, and then exponentially increasing times between each subsequent retry.</span></span> <span data-ttu-id="0c87c-166">Например, повторные попытки выполнения операции могут предприниматься через 3 секунды, 12 секунд, 30 секунд и так далее.</span><span class="sxs-lookup"><span data-stu-id="0c87c-166">For example, it may retry the operation after 3 seconds, 12 seconds, 30 seconds, and so on.</span></span>

    - <span data-ttu-id="0c87c-167">**Интервалы с приращениями**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-167">**Incremental intervals**.</span></span> <span data-ttu-id="0c87c-168">Перед первой повторной попыткой приложение выдерживает небольшой интервал, а для каждой последующей попытки интервал увеличивается с определенными приращениями.</span><span class="sxs-lookup"><span data-stu-id="0c87c-168">The application waits a short time before the first retry, and then incrementally increasing times between each subsequent retry.</span></span> <span data-ttu-id="0c87c-169">Например, повторные попытки выполнения операции могут предприниматься через 3 секунды, 7 секунд, 13 секунд и так далее.</span><span class="sxs-lookup"><span data-stu-id="0c87c-169">For example, it may retry the operation after 3 seconds, 7 seconds, 13 seconds, and so on.</span></span>

    - <span data-ttu-id="0c87c-170">**Постоянные интервалы**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-170">**Regular intervals**.</span></span> <span data-ttu-id="0c87c-171">Для всех повторных попыток применяется одинаковый интервал.</span><span class="sxs-lookup"><span data-stu-id="0c87c-171">The application waits for the same period of time between each attempt.</span></span> <span data-ttu-id="0c87c-172">Например, повторные попытки выполнения операции могут предприниматься через каждые 3 секунды.</span><span class="sxs-lookup"><span data-stu-id="0c87c-172">For example, it may retry the operation every 3 seconds.</span></span>

    - <span data-ttu-id="0c87c-173">**Немедленный повтор**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-173">**Immediate retry**.</span></span> <span data-ttu-id="0c87c-174">Иногда временный сбой имеет крайне малую продолжительность, что может быть вызвано определенным событием, таким как конфликт сетевых пакетов или всплеск нагрузки на аппаратном компоненте.</span><span class="sxs-lookup"><span data-stu-id="0c87c-174">Sometimes a transient fault is extremely short, perhaps caused by an event such as a network packet collision or a spike in a hardware component.</span></span> <span data-ttu-id="0c87c-175">В этом случае имеет смысл повторить операцию немедленно, поскольку она может завершиться успешно, если ошибка устраняется за то время, пока приложение подготавливает и отправляет следующий запрос.</span><span class="sxs-lookup"><span data-stu-id="0c87c-175">In this case, retrying the operation immediately is appropriate because it may succeed if the fault has cleared in the time it takes the application to assemble and send the next request.</span></span> <span data-ttu-id="0c87c-176">Однако в любой ситуации следует предпринимать не более одной немедленной повторной попытки, а в случае ее неудачи необходимо переключиться на альтернативные стратегии, такие как экспоненциальная задержка, или на резервные действия.</span><span class="sxs-lookup"><span data-stu-id="0c87c-176">However, there should never be more than one immediate retry attempt, and you should switch to alternative strategies, such as such as exponential back-off or fallback actions, if the immediate retry fails.</span></span>

    - <span data-ttu-id="0c87c-177">**Случайный выбор**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-177">**Randomization**.</span></span> <span data-ttu-id="0c87c-178">Любая из указанных выше стратегий может включать в себя элемент случайности, чтобы предотвратить ситуацию, когда несколько экземпляров клиента одновременно предпринимают последовательные повторные попытки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-178">Any of the retry strategies listed above may include a randomization to prevent multiple instances of the client sending subsequent retry attempts at the same time.</span></span> <span data-ttu-id="0c87c-179">Например, один экземпляр может повторять операцию через 3 секунды, 11 секунд, 28 секунд и так далее, а другой — через 4 секунды, 12 секунд, 26 секунд и так далее.</span><span class="sxs-lookup"><span data-stu-id="0c87c-179">For example, one instance may retry the operation after 3 seconds, 11 seconds, 28 seconds, and so on while another instance may retry the operation after 4 seconds, 12 seconds, 26 seconds, and so on.</span></span> <span data-ttu-id="0c87c-180">Случайный выбор является полезным приемом, который можно совместить с другими стратегиями.</span><span class="sxs-lookup"><span data-stu-id="0c87c-180">Randomization is a useful technique that may be combined with other strategies.</span></span>

  - <span data-ttu-id="0c87c-181">В общем случае используйте стратегию экспоненциальной задержки для фоновых операций и стратегии немедленного повтора или постоянных интервалов для интерактивных операций.</span><span class="sxs-lookup"><span data-stu-id="0c87c-181">As a general guideline, use an exponential back-off strategy for background operations, and immediate or regular interval retry strategies for interactive operations.</span></span> <span data-ttu-id="0c87c-182">В обоих случаях необходимо выбрать задержку и число повторных попыток таким образом, чтобы максимальная задержка для всех повторных попыток находилась в пределах требуемой общей задержки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-182">In both cases, you should choose the delay and the retry count so that the maximum latency for all retry attempts is within the required end-to-end latency requirement.</span></span>

  - <span data-ttu-id="0c87c-183">Принимайте во внимание сочетание всех факторов, влияющих на общее максимальное время ожидания для выполняемой повторно операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-183">Take into account the combination of all the factors that contribute to the overall maximum timeout for a retried operation.</span></span> <span data-ttu-id="0c87c-184">Эти факторы включают в себя время, требуемое на выдачу отклика при сбое соединения (обычно оно задается значением времени ожидания на стороне клиента), а также задержку между повторными попытками и максимальное число повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-184">These factors include the time taken for a failed connection to produce a response (typically set by a timeout value in the client) as well as the delay between retry attempts and the maximum number of retries.</span></span> <span data-ttu-id="0c87c-185">Совместно все эти значения времени могут приводить к очень большой общей продолжительности операции, особенно когда применяется стратегия экспоненциальной задержки, при которой интервал между повторными попытками значительно увеличивается после каждой ошибки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-185">The total of all these times can result in very large overall operation times, especially when using an exponential delay strategy where the interval between retries grows rapidly after each failure.</span></span> <span data-ttu-id="0c87c-186">Если процесс должен соответствовать определенному соглашению об уровне обслуживания, общая длительность операции, включая все время ожидания и все задержки, должна находиться в пределах, которые определенны в этом соглашении.</span><span class="sxs-lookup"><span data-stu-id="0c87c-186">If a process must meet a specific service level agreement (SLA), the overall operation time, including all timeouts and delays, must be within that defined in the SLA.</span></span>

  - <span data-ttu-id="0c87c-187">Чрезмерно агрессивные стратегии повторных попыток со слишком короткими интервалами или слишком большим числом попыток могут отрицательно влиять на целевой ресурс или службу.</span><span class="sxs-lookup"><span data-stu-id="0c87c-187">Over-aggressive retry strategies, which have too short intervals or too many retries, can have an adverse effect on the target resource or service.</span></span> <span data-ttu-id="0c87c-188">Такая стратегия может мешать восстановлению ресурса или службы из состояния перегрузки, в результате чего они будут продолжать блокировать или отклонять запросы.</span><span class="sxs-lookup"><span data-stu-id="0c87c-188">This may prevent the resource or service from recovering from its overloaded state, and it will continue to block or refuse requests.</span></span> <span data-ttu-id="0c87c-189">Образуется замкнутый круг, когда ресурсу или службе отправляется все больше и больше запросов, что все больше ухудшает их способность к восстановлению.</span><span class="sxs-lookup"><span data-stu-id="0c87c-189">This results in a vicious circle where more and more requests are sent to the resource or service, and consequently its ability to recover is further reduced.</span></span>

  - <span data-ttu-id="0c87c-190">При выборе интервалов повтора учитывайте время ожидания операций, чтобы предотвратить немедленное выполнение последующей попытки (например, если период ожидания равен интервалу между попытками).</span><span class="sxs-lookup"><span data-stu-id="0c87c-190">Take into account the timeout of the operations when choosing the retry intervals to avoid launching a subsequent attempt immediately (for example, if the timeout period is similar to the retry interval).</span></span> <span data-ttu-id="0c87c-191">Также принимайте во внимание, должен ли общий возможный период (время ожидания плюс интервалы повтора) быть меньше определенного общего времени.</span><span class="sxs-lookup"><span data-stu-id="0c87c-191">Also consider if you need to keep the total possible period (the timeout plus the retry intervals) to below a specific total time.</span></span> <span data-ttu-id="0c87c-192">Наличие слишком короткого или слишком длинного времени ожидания может оказывать влияние на длительность ожидания и частоту повторения операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-192">Operations that have unusually short or very long timeouts may influence how long to wait, and how often to retry the operation.</span></span>

  - <span data-ttu-id="0c87c-193">Используйте тип исключения и все содержащиеся в нем данные или коды ошибок и сообщения, возвращаемые службой, для оптимизации интервала и числа повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-193">Use the type of the exception and any data it contains, or the error codes and messages returned from the service, to optimize the interval and the number of retries.</span></span> <span data-ttu-id="0c87c-194">Например, некоторые исключения или коды ошибок (такие как код HTTP 503 «Служба недоступна» с заголовком Retry-After в ответе) могут указывать длительность ошибки либо сообщать о том, что в службе произошел сбой, из-за чего она не будет отвечать на все последующие попытки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-194">For example, some exceptions or error codes (such as the HTTP code 503 Service Unavailable with a Retry-After header in the response) may indicate how long the error might last, or that the service has failed and will not respond to any subsequent attempt.</span></span>

- <span data-ttu-id="0c87c-195">**Избегайте антишаблонов**.</span><span class="sxs-lookup"><span data-stu-id="0c87c-195">**Avoid anti-patterns**:</span></span>

  - <span data-ttu-id="0c87c-196">В подавляющем большинстве случаев следует избегать реализаций, которые включают в себя повторяющиеся слои кода повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-196">In the vast majority of cases, you should avoid implementations that include duplicated layers of retry code.</span></span> <span data-ttu-id="0c87c-197">Избегайте схем, включающих в себя каскадные механизмы повторных попыток или реализующих повтор на каждом этапе операции, включающей в себя иерархию запросов, если только для этого нет отдельных требований.</span><span class="sxs-lookup"><span data-stu-id="0c87c-197">Avoid designs that include cascading retry mechanisms, or that implement retry at every stage of an operation that involves a hierarchy of requests, unless you have specific requirements that demand this.</span></span> <span data-ttu-id="0c87c-198">В этих исключительных случаях используйте политики, предотвращающие чрезмерное количество повторных попыток и периодов задержки, и убедитесь, что вы хорошо осознаете последствия.</span><span class="sxs-lookup"><span data-stu-id="0c87c-198">In these exceptional circumstances, use policies that prevent excessive numbers of retries and delay periods, and make sure you understand the consequences.</span></span> <span data-ttu-id="0c87c-199">Например, если один компонент выполняет запрос к другому компоненту, который затем обращается к целевой службе, и вы разрешаете три повторных попытки для обоих вызовов, общее число повторных попыток для этой службы будет равно девяти.</span><span class="sxs-lookup"><span data-stu-id="0c87c-199">For example, if one component makes a request to another, which then accesses the target service, and you implement retry with a count of three on both calls there will be nine retry attempts in total against the service.</span></span> <span data-ttu-id="0c87c-200">Многие службы и ресурсы реализуют встроенный механизм повторных попыток, и вам следует выяснить, как отключить или изменить его, если необходимо реализовать повторные попытки на более высоком уровне.</span><span class="sxs-lookup"><span data-stu-id="0c87c-200">Many services and resources implement a built-in retry mechanism and you should investigate how you can disable or modify this if you need to implement retries at a higher level.</span></span>

  - <span data-ttu-id="0c87c-201">Никогда не применяйте механизм с бесконечными повторными попытками.</span><span class="sxs-lookup"><span data-stu-id="0c87c-201">Never implement an endless retry mechanism.</span></span> <span data-ttu-id="0c87c-202">Это с большой вероятностью приведет к неспособности ресурса или службы восстановиться из состояния перегрузки, в результате чего регулирование и отклонение подключений будут продолжаться дольше.</span><span class="sxs-lookup"><span data-stu-id="0c87c-202">This is likely to prevent the resource or service recovering from overload situations, and cause throttling and refused connections to continue for a longer period.</span></span> <span data-ttu-id="0c87c-203">Используйте конечное число повторных попыток или реализуйте шаблон, такой как [прерыватель](../patterns/circuit-breaker.md) , чтобы дать службе возможность восстановления.</span><span class="sxs-lookup"><span data-stu-id="0c87c-203">Use a finite number or retries, or implement a pattern such as [Circuit Breaker](../patterns/circuit-breaker.md) to allow the service to recover.</span></span>

  - <span data-ttu-id="0c87c-204">Никогда не выполняйте немедленный повтор больше одного раза.</span><span class="sxs-lookup"><span data-stu-id="0c87c-204">Never perform an immediate retry more than once.</span></span>

  - <span data-ttu-id="0c87c-205">При доступе к службам и ресурсам в Azure избегайте использования постоянного интервала, особенно при наличии большого количества повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-205">Avoid using a regular retry interval, especially when you have a large number of retry attempts, when accessing services and resources in Azure.</span></span> <span data-ttu-id="0c87c-206">Оптимальным подходом в данном сценарии является стратегия экспоненциальной задержки с возможностью прерывания.</span><span class="sxs-lookup"><span data-stu-id="0c87c-206">The optimum approach is this scenario is an exponential back-off strategy with a circuit-breaking capability.</span></span>

  - <span data-ttu-id="0c87c-207">Не допускайте ситуации, когда несколько экземпляров одного клиента или несколько экземпляров разных клиентов выполняют повторные попытки одновременно.</span><span class="sxs-lookup"><span data-stu-id="0c87c-207">Prevent multiple instances of the same client, or multiple instances of different clients, from sending retries at the same times.</span></span> <span data-ttu-id="0c87c-208">Если существует вероятность возникновения такой ситуации, введите в интервалы повтора элемент случайности.</span><span class="sxs-lookup"><span data-stu-id="0c87c-208">If this is likely to occur, introduce randomization into the retry intervals.</span></span>

- <span data-ttu-id="0c87c-209">**Протестируйте стратегию повторных попыток и ее реализацию.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-209">**Test your retry strategy and implementation:**</span></span>

  - <span data-ttu-id="0c87c-210">Обязательно полностью протестируйте реализацию стратегии повторных попыток в обширном спектре условий, особенно если и приложение, и используемые им целевые ресурсы или службы находятся под чрезмерной нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="0c87c-210">Ensure you fully test your retry strategy implementation under as wide a set of circumstances as possible, especially when both the application and the target resources or services it uses are under extreme load.</span></span> <span data-ttu-id="0c87c-211">Чтобы проверить поведение во время тестирования, можно сделать следующее.</span><span class="sxs-lookup"><span data-stu-id="0c87c-211">To check behavior during testing, you can:</span></span>

    - <span data-ttu-id="0c87c-212">Внесите в службу временные и не временные ошибки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-212">Inject transient and non-transient faults into the service.</span></span> <span data-ttu-id="0c87c-213">Например, отправьте недопустимые запросы или добавьте код, который обнаруживает тестовые запросы и дает отклик с различными типами ошибок.</span><span class="sxs-lookup"><span data-stu-id="0c87c-213">For example, send invalid requests or add code that detects test requests and responds with different types of errors.</span></span> <span data-ttu-id="0c87c-214">Пример использования TestApi см. в статье [Fault Injection Testing with TestApi](https://msdn.microsoft.com/magazine/ff898404.aspx) (Тестирование с внесением ошибок на базе TestApi) и [Introduction to TestApi – Part 5: Managed Code Fault Injection APIs](https://blogs.msdn.microsoft.com/ivo_manolov/2009/11/25/introduction-to-testapi-part-5-managed-code-fault-injection-apis/) (Введение в TestApi. Часть 5. API-интерфейсы для внесения ошибок в управляемый код).</span><span class="sxs-lookup"><span data-stu-id="0c87c-214">For an example using TestApi, see [Fault Injection Testing with TestApi](https://msdn.microsoft.com/magazine/ff898404.aspx) and [Introduction to TestApi – Part 5: Managed Code Fault Injection APIs](https://blogs.msdn.microsoft.com/ivo_manolov/2009/11/25/introduction-to-testapi-part-5-managed-code-fault-injection-apis/).</span></span>

    - <span data-ttu-id="0c87c-215">Создайте макет ресурса или службы, возвращающий диапазон ошибок, которые может возвращать реальная служба.</span><span class="sxs-lookup"><span data-stu-id="0c87c-215">Create a mock of the resource or service that returns a range of errors that the real service may return.</span></span> <span data-ttu-id="0c87c-216">Убедитесь, что охвачены все типы ошибок, которые ваша стратегия повторных попыток должна определять.</span><span class="sxs-lookup"><span data-stu-id="0c87c-216">Ensure you cover all the types of error that your retry strategy is designed to detect.</span></span>

    - <span data-ttu-id="0c87c-217">Принудительно вызовите появление временных ошибок, кратковременно отключив или перегрузив службу, если это пользовательская служба, созданная и развернутая вами (при этом, конечно же, не следует пытаться перегрузить общие ресурсы или общие службы в Azure).</span><span class="sxs-lookup"><span data-stu-id="0c87c-217">Force transient errors to occur by temporarily disabling or overloading the service if it is a custom service that you created and deployed (you should not, of course, attempt to overload any shared resources or shared services within Azure).</span></span>

    - <span data-ttu-id="0c87c-218">Для API на основе HTTP рекомендуется применять библиотеку FiddlerCore в рамках автоматических тестов, чтобы изменять результат HTTP-запросов, добавляя дополнительное время циклического прохождения или меняя отклик (например, код состояния HTTP, заголовки, текст или другие факторы).</span><span class="sxs-lookup"><span data-stu-id="0c87c-218">For HTTP-based APIs, consider using the FiddlerCore library in your automated tests to change the outcome of HTTP requests, either by adding extra roundtrip times or by changing the response (such as the HTTP status code, headers, body, or other factors).</span></span> <span data-ttu-id="0c87c-219">Это позволяет осуществить детерминированное тестирование подмножества условий сбоя для временных ошибок или других типов ошибок.</span><span class="sxs-lookup"><span data-stu-id="0c87c-219">This enables deterministic testing of a subset of the failure conditions, whether transient faults or other types of failure.</span></span> <span data-ttu-id="0c87c-220">Дополнительные сведения см. в описании [FiddlerCore](https://www.telerik.com/fiddler/fiddlercore).</span><span class="sxs-lookup"><span data-stu-id="0c87c-220">For more information, see [FiddlerCore](https://www.telerik.com/fiddler/fiddlercore).</span></span> <span data-ttu-id="0c87c-221">Примеры использования библиотеки, в частности класса **HttpMangler**, см. в [исходном коде для пакета SDK службы хранилища Azure](https://github.com/Azure/azure-storage-net/tree/master/Test).</span><span class="sxs-lookup"><span data-stu-id="0c87c-221">For examples of how to use the library, particularly the **HttpMangler** class, examine the [source code for the Azure Storage SDK](https://github.com/Azure/azure-storage-net/tree/master/Test).</span></span>

    - <span data-ttu-id="0c87c-222">Выполняйте тесты с высокой нагрузкой и параллельные тесты, чтобы убедиться, что механизм и стратегия повторных попыток работают правильно в данных условиях, не оказывают неблагоприятного воздействия на работу клиента и не вызывают перекрестных конфликтов между запросами.</span><span class="sxs-lookup"><span data-stu-id="0c87c-222">Perform high load factor and concurrent tests to ensure that the retry mechanism and strategy works correctly under these conditions, and does not have an adverse effect on the operation of the client or cause cross-contamination between requests.</span></span>

- <span data-ttu-id="0c87c-223">**Управляйте конфигурациями политики повторных попыток.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-223">**Manage retry policy configurations:**</span></span>

  - <span data-ttu-id="0c87c-224">*Политика повторных попыток* представляет собой сочетание всех элементов вашей стратегии повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-224">A *retry policy* is a combination of all of the elements of your retry strategy.</span></span> <span data-ttu-id="0c87c-225">Она указывает механизм обнаружения, который определяет, является ли ошибка временной, задает используемый тип интервала (например, постоянный, экспоненциальный и случайный), фактические значения интервала и количество повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-225">It defines the detection mechanism that determines whether a fault is likely to be transient, the type of interval to use (such as regular, exponential back-off, and randomization), the actual interval value(s), and the number of times to retry.</span></span>

  - <span data-ttu-id="0c87c-226">Повторные попытки требуется реализовать во многих местах даже самого простого приложения и на каждом слое более сложных приложений.</span><span class="sxs-lookup"><span data-stu-id="0c87c-226">Retries must be implemented in many places within even the simplest application, and in every layer of more complex applications.</span></span> <span data-ttu-id="0c87c-227">Вместо того чтобы жестко запрограммировать элементы каждой политики в нескольких местах, рекомендуется использовать центральное расположение для хранения всех политик.</span><span class="sxs-lookup"><span data-stu-id="0c87c-227">Rather than hard-coding the elements of each policy at multiple locations, consider using a central point for storing all the policies.</span></span> <span data-ttu-id="0c87c-228">Например, храните такие значения, как интервал и число попыток, в файлах конфигурации приложения, считывайте их во время выполнения и формируйте политики повторных попыток программным образом.</span><span class="sxs-lookup"><span data-stu-id="0c87c-228">For example, store the values such as the interval and retry count in application configuration files, read them at runtime, and programmatically build the retry policies.</span></span> <span data-ttu-id="0c87c-229">Это упрощает управление параметрами, а также изменение и настройку значений, когда требуется обеспечить соответствие изменяющимся требованиям и сценариям.</span><span class="sxs-lookup"><span data-stu-id="0c87c-229">This makes it easier to manage the settings, and to modify and fine tune the values in order to respond to changing requirements and scenarios.</span></span> <span data-ttu-id="0c87c-230">Однако если получить значения из конфигурации нельзя, разрабатывайте систему таким образом, чтобы хранить значения вместо считывания файла конфигурации, и обеспечьте использование подходящих значений по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="0c87c-230">However, design the system to store the values rather than rereading a configuration file every time, and ensure suitable defaults are used if the values cannot be obtained from configuration.</span></span>

  - <span data-ttu-id="0c87c-231">В приложении облачных служб Azure рекомендуется хранить значения, которые используются для формирования политики повторных попыток во время выполнения, в файле конфигурации службы, чтобы их можно было изменить без перезапуска приложения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-231">In an Azure Cloud Services application, consider storing the values that are used to build the retry policies at runtime in the service configuration file so that they can be changed without needing to restart the application.</span></span>

  - <span data-ttu-id="0c87c-232">Используйте преимущества встроенной стратегии повторных попыток или стратегий по умолчанию, доступных в используемых клиентских API, но только тогда, когда они подходят для вашего сценария.</span><span class="sxs-lookup"><span data-stu-id="0c87c-232">Take advantage of built-in or default retry strategies available in the client APIs you use, but only where they are appropriate for your scenario.</span></span> <span data-ttu-id="0c87c-233">Эти стратегии обычно имеют общее назначение.</span><span class="sxs-lookup"><span data-stu-id="0c87c-233">These strategies are typically general-purpose.</span></span> <span data-ttu-id="0c87c-234">Иногда их может быть вполне достаточно, однако в других случаях они не обеспечивают полный спектр необходимых вам возможностей.</span><span class="sxs-lookup"><span data-stu-id="0c87c-234">In some scenarios they may be all that is required, but in other scenarios they may not offer the full range of options to suit your specific requirements.</span></span> <span data-ttu-id="0c87c-235">Необходимо понимать, как параметры влияют на приложение, и проводить тестирование для определения наиболее подходящих значений.</span><span class="sxs-lookup"><span data-stu-id="0c87c-235">You must understand how the settings will affect your application through testing to determine the most appropriate values.</span></span>

- <span data-ttu-id="0c87c-236">**Регистрируйте и отслеживайте временные и не временные ошибки.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-236">**Log and track transient and non-transient faults:**</span></span>

  - <span data-ttu-id="0c87c-237">Включите в состав стратегии повторных попыток обработку исключений и другое инструментирование, регистрирующие предпринимаемые повторные попытки.</span><span class="sxs-lookup"><span data-stu-id="0c87c-237">As part of your retry strategy, include exception handling and other instrumentation that logs when retry attempts are made.</span></span> <span data-ttu-id="0c87c-238">Хотя нерегулярные временные сбои и повторные попытки являются ожидаемыми и не указывают на наличие проблем, увеличение числа регулярных повторных попыток часто указывает на наличие проблемы, которая негативно влияет на производительность и доступность приложения либо может привести к сбою.</span><span class="sxs-lookup"><span data-stu-id="0c87c-238">While an occasional transient failure and retry are to be expected, and do not indicate a problem, regular and increasing numbers of retries are often an indicator of an issue that may cause a failure, or is currently impacting application performance and availability.</span></span>

  - <span data-ttu-id="0c87c-239">Регистрируйте временные сбои, такие как предупреждения, а не ошибки, чтобы системы мониторинга не определяли их как ошибки приложений, способные вызвать ложные оповещения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-239">Log transient faults as Warning entries rather than Error entries so that monitoring systems do not detect them as application errors that may trigger false alerts.</span></span>

  - <span data-ttu-id="0c87c-240">Рекомендуется сохранять в записях журнала значение, указывающее, были ли повторные попытки вызваны регулированием в службе или другими типами сбоев, такими как ошибки подключения, чтобы можно было различить их во время анализа данных.</span><span class="sxs-lookup"><span data-stu-id="0c87c-240">Consider storing a value in your log entries that indicates if the retries were caused by throttling in the service, or by other types of faults such as connection failures, so that you can differentiate them during analysis of the data.</span></span> <span data-ttu-id="0c87c-241">Увеличение числа ошибок регулирования часто указывает на ошибку проектирования приложения или на необходимость перехода на платную службу, предоставляющую выделенное оборудование.</span><span class="sxs-lookup"><span data-stu-id="0c87c-241">An increase in the number of throttling errors is often an indicator of a design flaw in the application or the need to switch to a premium service that offers dedicated hardware.</span></span>

  - <span data-ttu-id="0c87c-242">Рекомендуется замерять и регистрировать общее время выполнения операций, включающих в себя механизм повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-242">Consider measuring and logging the overall time taken for operations that include a retry mechanism.</span></span> <span data-ttu-id="0c87c-243">Это хороший показатель общего влияния временных сбоев на время отклика для пользователя, задержку процесса и эффективность вариантов использования приложения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-243">This is a good indicator of the overall effect of transient faults on user response times, process latency, and the efficiency of the application use cases.</span></span> <span data-ttu-id="0c87c-244">Кроме того, регистрируйте количество предпринятых повторных попыток, чтобы понять, какие факторы влияют на время отклика.</span><span class="sxs-lookup"><span data-stu-id="0c87c-244">Also log the number of retries occurred in order to understand the factors that contributed to the response time.</span></span>

  - <span data-ttu-id="0c87c-245">Рекомендуется реализовать систему телеметрии и мониторинга, способную выдавать предупреждения в случае увеличения числа и частоты возникновения сбоев, среднего числа повторных попыток или общего времени, затрачиваемого на успешное выполнение операций.</span><span class="sxs-lookup"><span data-stu-id="0c87c-245">Consider implementing a telemetry and monitoring system that can raise alerts when the number and rate of failures, the average number of retries, or the overall times taken for operations to succeed, is increasing.</span></span>

- <span data-ttu-id="0c87c-246">**Управляйте операциями, которые постоянно завершаются неудачей.**</span><span class="sxs-lookup"><span data-stu-id="0c87c-246">**Manage operations that continually fail:**</span></span>
  
  - <span data-ttu-id="0c87c-247">Возникнут обстоятельства, в которых операция продолжает завершаться ошибкой при каждой попытке, и крайне важно предусмотреть способ обработки такой ситуации.</span><span class="sxs-lookup"><span data-stu-id="0c87c-247">There will be circumstances where the operation continues to fail at every attempt, and it is vital to consider how you will handle this situation:</span></span>

    - <span data-ttu-id="0c87c-248">Хотя стратегия повторных попыток будет определять максимальное число повторных попыток выполнения операции, она не запрещает приложению выполнить операцию еще раз с тем же числом повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="0c87c-248">Although a retry strategy will define the maximum number of times that an operation should be retried, it does not prevent the application repeating the operation again, with the same number of retries.</span></span> <span data-ttu-id="0c87c-249">Например, если в службе обработки заказов возникает неустранимая ошибка, после чего служба становится полностью неработоспособной, стратегия повторных попыток может обнаруживать время ожидания подключения и расценивать его как временную ошибку.</span><span class="sxs-lookup"><span data-stu-id="0c87c-249">For example, if an order processing service fails with a fatal error that puts it out of action permanently, the retry strategy may detect a connection timeout and consider it to be a transient fault.</span></span> <span data-ttu-id="0c87c-250">Код попытается повторить операцию указанное число раз и затем остановится.</span><span class="sxs-lookup"><span data-stu-id="0c87c-250">The code will retry the operation a specified number of times and then give up.</span></span> <span data-ttu-id="0c87c-251">Однако при размещении заказа другим клиентом попытка выполнения операции будет предпринята снова, даже если она все равно закончится неудачей.</span><span class="sxs-lookup"><span data-stu-id="0c87c-251">However, when another customer places an order, the operation will be attempted again - even though it is sure to fail every time.</span></span>

    - <span data-ttu-id="0c87c-252">Чтобы предотвратить постоянные повторные попытки выполнения операций, которые каждый раз заканчиваются неудачей, рекомендуется реализовать [шаблон прерывателя](../patterns/circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="0c87c-252">To prevent continual retries for operations that continually fail, consider implementing the [Circuit Breaker pattern](../patterns/circuit-breaker.md).</span></span> <span data-ttu-id="0c87c-253">Если при таком шаблоне число ошибок за определенный период превышает пороговое значение, запросы сразу же возвращаются вызывающему объекту в виде ошибок без попытки доступа к ресурсу или службе, где возник сбой.</span><span class="sxs-lookup"><span data-stu-id="0c87c-253">In this pattern, if the number of failures within a specified time window exceeds the threshold, requests are returned to the caller immediately as errors, without attempting to access the failed resource or service.</span></span>

    - <span data-ttu-id="0c87c-254">Приложение может периодически тестировать службу с очень длинными интервалами между запросами, чтобы определить, когда она станет доступной.</span><span class="sxs-lookup"><span data-stu-id="0c87c-254">The application can periodically test the service, on an intermittent basis and with very long intervals between requests, to detect when it becomes available.</span></span> <span data-ttu-id="0c87c-255">Соответствующий интервал зависит от сценария, например от важности операции и характера службы, и может быть любым — от нескольких минут до нескольких часов.</span><span class="sxs-lookup"><span data-stu-id="0c87c-255">An appropriate interval will depend on the scenario, such as the criticality of the operation and the nature of the service, and might be anything between a few minutes and several hours.</span></span> <span data-ttu-id="0c87c-256">После успешного выполнения теста приложение может продолжить работу и передавать запросы в недавно восстановленную службу.</span><span class="sxs-lookup"><span data-stu-id="0c87c-256">At the point where the test succeeds, the application can resume normal operations and pass requests to the newly recovered service.</span></span>

    - <span data-ttu-id="0c87c-257">Тем временем можно переключиться на другой экземпляр службы (возможно, расположенный в другом центре обработки данных или другом приложении), использовать аналогичную службу с совместимой (возможно, упрощенной) функциональностью или выполнить некоторые альтернативные операции, в расчете, что служба станет доступной в ближайшее время.</span><span class="sxs-lookup"><span data-stu-id="0c87c-257">In the meantime, it may be possible to fall back to another instance of the service (perhaps in a different datacenter or application), use a similar service that offers compatible (perhaps simpler) functionality, or perform some alternative operations in the hope that the service will become available soon.</span></span> <span data-ttu-id="0c87c-258">Например, может быть уместным сохранить запросы для службы в очереди или хранилище данных и позже воспроизвести их.</span><span class="sxs-lookup"><span data-stu-id="0c87c-258">For example, it may be appropriate to store requests for the service in a queue or data store and replay them later.</span></span> <span data-ttu-id="0c87c-259">Кроме того, вы можете перенаправить пользователя в альтернативный экземпляр приложения, снизив производительность этого приложения, однако предоставив необходимые функциональные возможности, либо просто возвратить пользователю сообщение о том, что приложение в настоящее время не доступно.</span><span class="sxs-lookup"><span data-stu-id="0c87c-259">Otherwise you might be able to redirect the user to an alternative instance of the application, degrade the performance of the application but still offer acceptable functionality, or just return a message to the user indicating that the application is not available at present.</span></span>

- <span data-ttu-id="0c87c-260">**Дополнительные рекомендации**</span><span class="sxs-lookup"><span data-stu-id="0c87c-260">**Other considerations**</span></span>
  
  - <span data-ttu-id="0c87c-261">При выборе значений для числа повторных попыток и интервалов повтора в политике следует учитывать, является ли операция для службы или ресурса частью длительной или многоэтапной операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-261">When deciding on the values for the number of retries and the retry intervals for a policy, consider if the operation on the service or resource is part of a long-running or multi-step operation.</span></span> <span data-ttu-id="0c87c-262">Для компенсаций всех выполненных этапов операции после сбоя одного из них может потребоваться много ресурсов или усилий.</span><span class="sxs-lookup"><span data-stu-id="0c87c-262">It may be difficult or expensive to compensate all the other operational steps that have already succeeded when one fails.</span></span> <span data-ttu-id="0c87c-263">В этом случае может быть приемлемым использование очень большого интервала и очень большого количества повторных попыток, если только это не приводит к блокировке других операций из-за удержания дефицитных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="0c87c-263">In this case, a very long interval and a large number of retries may be acceptable as long as it does not block other operations by holding or locking scarce resources.</span></span>

  - <span data-ttu-id="0c87c-264">Определите, может ли повторная попытка выполнения операции привести к несогласованности данных.</span><span class="sxs-lookup"><span data-stu-id="0c87c-264">Consider if retrying the same operation may cause inconsistencies in data.</span></span> <span data-ttu-id="0c87c-265">Если повторяются некоторые части многоэтапного процесса, а соответствующие операции не являются идемпотентными, это может привести к возникновению несогласованности.</span><span class="sxs-lookup"><span data-stu-id="0c87c-265">If some parts of a multi-step process are repeated, and the operations are not idempotent, it may result in an inconsistency.</span></span> <span data-ttu-id="0c87c-266">Например, повторение операции, которая обеспечивает приращение значения, даст неверный результат.</span><span class="sxs-lookup"><span data-stu-id="0c87c-266">For example, an operation that increments a value, if repeated, will produce an invalid result.</span></span> <span data-ttu-id="0c87c-267">Повторение операции, которая отправляет сообщение в очередь, может вызвать несогласованность у получателя сообщения, если он не способен обнаруживать дублирующиеся сообщения.</span><span class="sxs-lookup"><span data-stu-id="0c87c-267">Repeating an operation that sends a message to a queue may cause an inconsistency in the message consumer if it cannot detect duplicate messages.</span></span> <span data-ttu-id="0c87c-268">Во избежание этого убедитесь, что каждый этап проектируется в виде идемпотентной операции.</span><span class="sxs-lookup"><span data-stu-id="0c87c-268">To prevent this, ensure that you design each step as an idempotent operation.</span></span> <span data-ttu-id="0c87c-269">Дополнительные сведения о шаблонах идемпотентности см. [здесь][idempotency-patterns].</span><span class="sxs-lookup"><span data-stu-id="0c87c-269">For more information about idempotency, see [Idempotency patterns][idempotency-patterns].</span></span>

  - <span data-ttu-id="0c87c-270">Учитывайте область действия операций, которые будут повторяться.</span><span class="sxs-lookup"><span data-stu-id="0c87c-270">Consider the scope of the operations that will be retried.</span></span> <span data-ttu-id="0c87c-271">Например, может быть проще реализовать код повторных попыток на уровне, охватывающем несколько операций, и повторять все операции в случае сбоя одной из них.</span><span class="sxs-lookup"><span data-stu-id="0c87c-271">For example, it may be easier to implement retry code at a level that encompasses several operations, and retry them all if one fails.</span></span> <span data-ttu-id="0c87c-272">Однако это может привести к проблемам идемпотентности или ненужным операциям отката.</span><span class="sxs-lookup"><span data-stu-id="0c87c-272">However, doing this may result in idempotency issues or unnecessary rollback operations.</span></span>

  - <span data-ttu-id="0c87c-273">В случае выбора области повторных попыток, охватывающей несколько операций, учитывайте общую задержку всех этих операций при определении интервалов повтора, при отслеживании длительности выполнения и перед выдачей оповещений об ошибках.</span><span class="sxs-lookup"><span data-stu-id="0c87c-273">If you choose a retry scope that encompasses several operations, take into account the total latency of all of them when determining the retry intervals, when monitoring the time taken, and before raising alerts for failures.</span></span>

  - <span data-ttu-id="0c87c-274">Определите, как ваша стратегия повторных попыток может повлиять на соседние узлы и других клиентов в общем приложении или при использовании общих ресурсов и служб.</span><span class="sxs-lookup"><span data-stu-id="0c87c-274">Consider how your retry strategy may affect neighbors and other tenants in a shared application, or when using shared resources and services.</span></span> <span data-ttu-id="0c87c-275">Агрессивные политики повторных попыток могут привести к увеличению числа временных сбоев для других пользователей и приложений, совместно использующих ресурсы и службы.</span><span class="sxs-lookup"><span data-stu-id="0c87c-275">Aggressive retry policies can cause an increasing number of transient faults to occur for these other users and for applications that share the resources and services.</span></span> <span data-ttu-id="0c87c-276">Аналогичным образом на ваше приложение могут оказывать влияние политики повторных попыток, внедренные другими пользователями этих ресурсов и служб.</span><span class="sxs-lookup"><span data-stu-id="0c87c-276">Likewise, your application may be affected by the retry policies implemented by other users of the resources and services.</span></span> <span data-ttu-id="0c87c-277">Для критически важных приложений можно использовать платные службы, которые не являются общими.</span><span class="sxs-lookup"><span data-stu-id="0c87c-277">For mission-critical applications, you may decide to use premium services that are not shared.</span></span> <span data-ttu-id="0c87c-278">Это значительно расширяет возможности управления загрузкой и соответствующим регулированием этих ресурсов и служб, что может оправдать дополнительные затраты.</span><span class="sxs-lookup"><span data-stu-id="0c87c-278">This provides you with much more control over the load and consequent throttling of these resources and services, which can help to justify the additional cost.</span></span>

## <a name="more-information"></a><span data-ttu-id="0c87c-279">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="0c87c-279">More information</span></span>

- [<span data-ttu-id="0c87c-280">Рекомендации по повторным попыткам для служб Azure</span><span class="sxs-lookup"><span data-stu-id="0c87c-280">Azure service-specific retry guidelines</span></span>](./retry-service-specific.md)
- [<span data-ttu-id="0c87c-281">Шаблон автоматического выключения</span><span class="sxs-lookup"><span data-stu-id="0c87c-281">Circuit Breaker pattern</span></span>](../patterns/circuit-breaker.md)
- [<span data-ttu-id="0c87c-282">Шаблон компенсирующих транзакций</span><span class="sxs-lookup"><span data-stu-id="0c87c-282">Compensating Transaction pattern</span></span>](../patterns/compensating-transaction.md)
- <span data-ttu-id="0c87c-283">[Idempotency Patterns][idempotency-patterns] (Шаблоны идемпотентности)</span><span class="sxs-lookup"><span data-stu-id="0c87c-283">[Idempotency patterns][idempotency-patterns]</span></span>

<!-- links -->

[idempotency-patterns]: https://blog.jonathanoliver.com/idempotency-patterns/
