---
title: "Запуск виртуальных машин Windows в n-уровневой архитектуре"
description: "Эта статья содержит способы реализации многоуровневой архитектуры в Azure и уделяет особое внимание доступности, безопасности, масштабируемости и безопасности управляемости."
author: MikeWasson
ms.date: 11/22/2016
pnp.series.title: Windows VM workloads
pnp.series.next: multi-region-application
pnp.series.prev: multi-vm
ms.openlocfilehash: 0654239a5bbd966a2aa776415b7f15ae723ffd63
ms.sourcegitcommit: c9e6d8edb069b8c513de748ce8114c879bad5f49
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2018
---
# <a name="run-windows-vms-for-an-n-tier-application"></a>Запуск виртуальных машин Windows для n-уровневого приложения

В этой эталонной архитектуре показан набор методик по запуску виртуальных машин Windows для n-уровневого приложения. [**Разверните это решение**.](#deploy-the-solution) 

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура 

Существует много способов реализовать n-уровневую архитектуру. На диаграмме показано стандартное трехуровневое веб-приложение. Эта архитектура создана на основе архитектуры из статьи [Запуск виртуальных машин с балансировкой нагрузки для обеспечения масштабируемости и доступности][multi-vm]. На веб- и бизнес-уровнях используются виртуальные машины с балансировкой нагрузки.

* **Группы доступности.** Создайте [группу доступности][azure-availability-sets] для каждого уровня и подготовьте по крайней мере две виртуальные машины для каждого уровня. Таким образом виртуальные машины станут подходящими для [соглашения об уровне обслуживания (SLA)][vm-sla] более высокого уровня для виртуальных машин. Вы можете развернуть одну виртуальную машину в группе доступности, но в таком случае вы не сможете воспользоваться преимуществами соглашения об уровне обслуживания. Это возможно, только если для всех дисков операционной системы и данных такой виртуальной машины будет использоваться хранилище Azure класса Premium.  
* **Подсети.** Создайте отдельные подсети для каждого уровня. Укажите диапазон адресов и маску подсети с помощью нотации [CIDR]. 
* **Подсистемы балансировки нагрузки.** [Подсистема балансировки нагрузки с доступом к Интернету][load-balancer-external] передает входящий интернет-трафик на веб-уровень, а [внутренняя подсистема балансировки нагрузки][load-balancer-internal] передает сетевой трафик из веб-уровня на бизнес-уровень.
* **Jumpbox.** Он также называется [узлом-бастионом]. Безопасная виртуальная машина в сети, которую администраторы используют для подключения к другим виртуальным машинам. В jumpbox есть группа безопасности сети, обеспечивающая удаленный трафик только из общедоступных IP-адресов из списка надежных отправителей. NSG должна пропускать трафик с удаленного рабочего стола (RDP).
* **Мониторинг.** Программное обеспечение для мониторинга, например [Nagios], [Zabbix] или [Icinga], позволяет получить глубокое представление о времени отклика, времени доступности виртуальной машины и общей работоспособности вашей системы. Установите программное обеспечение для мониторинга на виртуальной машине, которая размещена в отдельной подсети управления.
* **Группы безопасности сети.** [Группы безопасности сети][nsg] (NSG) позволяют ограничить сетевой трафик в виртуальной сети. Например, в приведенной здесь трехуровневой архитектуре уровень базы данных не принимает трафик из веб-интерфейса, а только с бизнес-уровня и подсети управления.
* **Группа доступности AlwaysOn SQL Server.** Обеспечивает высокий уровень доступности на уровне данных, включив репликацию и отработку отказа.
* **Серверы доменных служб Active Directory (AD DS).** До Windows Server 2016 группы доступности Always On SQL Server требовалось присоединять к домену. Это связано с тем, что группы доступности зависят от технологии отказоустойчивого кластера Windows Server. Windows Server 2016 предоставляет возможность создать отказоустойчивый кластер без Active Directory. В этом случае серверы доменных служб Active Directory не нужны для этой архитектуры. Дополнительные сведения см. в разделе [What's new in Failover Clustering in Windows Server 2016][wsfc-whats-new] (Новые возможности отказоустойчивой кластеризации в Windows Server 2016).
* **Azure DNS**. [Azure DNS][azure-dns] — это служба размещения для доменов DNS, которая предоставляет разрешение имен с помощью инфраструктуры Microsoft Azure. Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.

## <a name="recommendations"></a>Рекомендации

Описанная здесь архитектура может не соответствовать вашим требованиям. Воспользуйтесь этими рекомендациями в качестве отправной точки. 

### <a name="vnet--subnets"></a>Виртуальная сеть и подсети

При создании виртуальной сети определите, сколько IP-адресов требуется для ресурсов в каждой подсети. Укажите маску подсети и достаточно большой диапазон адресов виртуальной сети для требуемых IP-адресов с помощью нотации [CIDR]. Используйте адресное пространство, которое входит в диапазон стандартных [блоков частных IP-адресов][private-ip-space], например 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Выберите диапазон адресов, который не перекрывает локальную сеть, если вам нужно позже настроить шлюз между виртуальной сетью и локальной сетью. Создав виртуальную сеть, изменить диапазон адресов нельзя.

Проектируйте подсети с учетом требований к функциональности и безопасности. Все виртуальные машины в пределах одного уровня или одной роли должны входить в одну и ту же подсеть, которая может быть надежным периметром безопасности. Дополнительные сведения о проектировании виртуальных сетей и подсетей см. в статье [Планирование и проектирование виртуальных сетей Azure][plan-network].

Для каждой подсети укажите адресное пространство подсети в нотации CIDR. Например, 10.0.0.0/24 создает диапазон из 256 IP-адресов. Виртуальные машины могут использовать 251 из них (пять зарезервированы). Убедитесь, что диапазоны адресов не перекрываются между подсетями. Ознакомьтесь со статьей [Виртуальная сеть Azure: часто задаваемые вопросы][vnet faq].

### <a name="network-security-groups"></a>Группы безопасности сети

С помощью правил NSG можно ограничить трафик между уровнями. Например, в показанной выше трехуровневой архитектуре веб-уровень не взаимодействует напрямую с уровнем базы данных. Чтобы обеспечить эту возможность, уровень базы данных должен блокировать входящий трафик из подсети веб-уровня.  

1. Создайте NSG и свяжите ее с подсетью уровня базы данных.
2. Добавьте правило, которое запрещает весь входящий трафик от виртуальной сети. (В правиле используйте тег `VIRTUAL_NETWORK`.) 
3. Добавьте правило с более высоким приоритетом, которое разрешает входящий трафик из подсети бизнес-уровня. Это правило переопределяет предыдущее и позволяет бизнес-уровню взаимодействовать с уровнем базы данных.
4. Добавьте правило, которое разрешает входящий трафик из самой подсети уровня базы данных. Это правило обеспечивает взаимодействие между виртуальными машинами на уровне базы данных, которое необходимо для репликации и отработки отказа базы данных.
5. Добавьте правило, которое разрешает трафик RDP из подсети jumpbox. Это правило позволяет администраторам подключаться к уровню базы данных из jumpbox.
   
   > [!NOTE]
   > NSG имеет стандартные правила, которые разрешают любой входящий трафик из виртуальной сети. Эти правила нельзя удалить, однако их можно переопределить, создав правила с более высоким приоритетом.
   > 
   > 

### <a name="load-balancers"></a>Балансировщики нагрузки

Внешняя подсистема балансировки нагрузки передает трафик Интернета на веб-уровень. Создайте общедоступный IP-адрес для этой подсистемы балансировки нагрузки. Ознакомьтесь со статьей [Создание балансировщика нагрузки для Интернета на портале Azure][lb-external-create].

Внутренняя подсистема балансировки нагрузки передает сетевой трафик с веб-уровня на бизнес-уровень. Чтобы предоставить этой системе балансировки нагрузки частный IP-адрес, создайте внешнюю IP-конфигурацию и свяжите ее с подсетью для бизнес-уровня. Ознакомьтесь со статьей [Создание подсистемы балансировки нагрузки на портале Azure][lb-internal-create].

### <a name="sql-server-always-on-availability-groups"></a>Группы доступности AlwaysOn SQL Server

Мы рекомендуем использовать [группы доступности AlwaysOn][sql-alwayson] для обеспечения высокого уровня доступности SQL Server. До Windows Server 2016 для групп доступности Always On требовался контроллер домена, а все узлы в группе доступности должны были находиться в одном домене AD.

Другие уровни подключаются к базе данных с помощью [прослушивателя групп доступности][sql-alwayson-listeners]. Прослушиватель позволяет клиенту SQL подключаться, не зная имени физического экземпляра SQL Server. Виртуальные машины, которые обращаются к базе данных, должны быть присоединены к домену. Клиент (в этом случае другой уровень) использует DNS для разрешения имени виртуальной сети прослушивателя в IP-адресах.

Настройте группы доступности AlwaysOn SQL Server следующим образом:

1. Создайте кластер отказоустойчивой кластеризации Windows Server, группу доступности AlwaysOn SQL Server и первичную реплику. Дополнительные сведения см. в статье [Начало работы с группами доступности AlwaysOn (SQL Server)][sql-alwayson-getting-started]. 
2. Создайте внутреннюю подсистему балансировки нагрузки со статическим частным IP-адресом.
3. Создайте прослушиватель группы доступности и сопоставьте его DNS-имя с IP-адресом внутренней подсистемы балансировки нагрузки. 
4. Создайте правило подсистемы балансировки нагрузки для порта прослушивания SQL Server (по умолчанию используется TCP-порт 1433). Правило подсистемы балансировки нагрузки должно включать *плавающий IP-адрес*, также называемый прямым ответом от сервера. В результате виртуальная машина будет отправлять ответ клиенту напрямую, что позволяет использовать прямое соединение с первичной репликой.
  
  > [!NOTE]
  > Если плавающий IP-адрес включен, номер внешнего порта должен совпадать с номером внутреннего порта в правиле подсистемы балансировки нагрузки.
  > 
  > 

Если клиент SQL пытается выполнить подключение, подсистема балансировки нагрузки направляет запрос на подключение в первичную реплику. Если происходит отработка отказа с переходом на другую реплику, подсистема балансировки нагрузки автоматически направляет последующие запросы в новую первичную реплику. Дополнительные сведения см. в статье [Настройка подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure][sql-alwayson-ilb].

Во время отработки отказа имеющиеся клиентские подключения закрыты. После отработки отказа новые соединения направляются в новую первичную реплику.

Если приложение выполняет значительно больше операций чтения, чем записи, вы можете разгрузить некоторые запросы только для чтения во вторичную реплику. Ознакомьтесь с разделом [Соединение с помощью прослушивателя со вторичной репликой только для чтения (маршрутизация только для чтения)][sql-alwayson-read-only-routing].

Протестируйте развертывание, [принудительно выполнив отработку отказа][sql-alwayson-force-failover] группы доступности вручную.

### <a name="jumpbox"></a>Jumpbox

jumpbox будет иметь минимальные требования к производительности, поэтому выберите небольшой размер виртуальной машины для jumpbox, например Standard A1. 

Создайте [общедоступный IP-адрес] для jumpbox. Поместите jumpbox в виртуальную сеть вместе с другими виртуальными машинами, однако в отдельную подсеть управления.

Запретите доступ по протоколу RDP из общедоступного Интернета к виртуальным машинам, которые выполняют рабочую нагрузку приложения. Вместо этого все доступы по протоколу RDP к этим виртуальным машинам должны проходить через jumpbox. Администратор выполняет вход в jumpbox, а затем вход в другую виртуальную машину из jumpbox. jumpbox разрешает RDP трафик из Интернета, однако только из известных и безопасных IP-адресов.

Чтобы защитить jumpbox, создайте NSG и примените ее к подсети jumpbox. Добавьте правило NSG, разрешающее подключения по протоколу RDP только из безопасного набора общедоступных IP-адресов. NSG можно подключить к подсети или сетевому адаптеру jumpbox. В этом случае рекомендуется подключить ее к сетевому адаптеру, чтобы трафик RDP разрешался только для jumpbox, даже если вы добавили другие виртуальные машины в ту же подсеть.

Настройте NSG для других подсетей, чтобы разрешить трафик RDP из подсети управления.

## <a name="availability-considerations"></a>Вопросы доступности

Использование нескольких виртуальных машин на уровне базы данных не приводит автоматически к высокой доступности базы данных. Для реляционной базы данных обычно требуется выполнить репликацию и отработку отказа, чтобы обеспечить высокий уровень доступности. Для SQL Server мы рекомендуем использовать [группы доступности AlwaysOn][sql-alwayson]. 

Если требуется более высокий уровень доступности, чем обеспечивает [соглашение об уровне обслуживания Azure для виртуальных машин][vm-sla], реплицируйте приложение в два региона и используйте диспетчер трафика Azure для отработки отказа. Дополнительные сведения см. в статье [Запуск виртуальных машин Windows в нескольких регионах для обеспечения высокой доступности][multi-dc].   

## <a name="security-considerations"></a>Вопросы безопасности

Выполните шифрование конфиденциальных неактивных данных и используйте [Azure Key Vault][azure-key-vault] для управления ключами шифрования базы данных. Key Vault может хранить ключи шифрования в аппаратных модулях безопасности. Дополнительные сведения см. в статье [Настройка интеграции Azure Key Vault для SQL Server на виртуальных машинах Azure (Resource Manager)][sql-keyvault]. Рекомендуется также хранить секреты приложения, например строки подключения к базе данных, в Key Vault.

Попробуйте добавить сетевой виртуальный модуль (NVA), чтобы создать сеть периметра между Интернетом и виртуальною сетью Azure. Сетевой виртуальный модуль — это универсальный термин для виртуального модуля, который может выполнять сетевые задачи, например брандмауэра, проверки пакетов, аудита и пользовательской маршрутизации. Дополнительные сведения см. в статье [Сеть периметра между Azure и Интернетом][dmz].

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Подсистемы балансировки нагрузки передают сетевой трафик на веб- и бизнес-уровни. Выполните горизонтальное масштабирование, добавив новые экземпляры виртуальной машины. Обратите внимание, что можно масштабировать веб- и бизнес-уровни независимо друг от друга в зависимости от нагрузки. Чтобы снизить уровень усложнений, которые могут возникать из-за необходимости использовать привязку клиента, виртуальные машины на веб-уровне должны быть без отслеживания состояния. Виртуальные машины, на которых размещена бизнес-логика, также должны быть без отслеживания состояния.

## <a name="manageability-considerations"></a>Вопросы управляемости

Упростите управление всей системой, используя централизованные инструменты администрирования, например [службу автоматизации Azure][azure-administration], [Microsoft Operations Management Suite][operations-management-suite], [Chef][chef] или [Puppet][puppet]. Эти инструменты могут консолидировать сведения о диагностике и работоспособности, собранные из нескольких виртуальных машин, чтобы обеспечить полное представление системы.

## <a name="deploy-the-solution"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder]. 

### <a name="prerequisites"></a>Необходимые компоненты

Перед развертыванием эталонной архитектуры в собственной подписке необходимо выполнить следующие действия.

1. Клонируйте и скачайте ZIP-файл [с эталонными архитектурами AzureCAT][ref-arch-repo] в репозитории GitHub, а также выполните его разветвление.

2. Убедитесь, что Azure CLI 2.0 установлен на компьютере. Чтобы установить CLI, следуйте инструкциям в статье об [установке Azure CLI 2.0][azure-cli-2].

3. Установите пакет npm [стандартных блоков Azure][azbb].

  ```bash
  npm install -g @mspnp/azure-building-blocks
  ```

4. В командной строке, строке bash или строке PowerShell войдите в свою учетную запись Azure с помощью одной из приведенных ниже команд и следуйте инструкциям.

  ```bash
  az login
  ```

### <a name="deploy-the-solution-using-azbb"></a>Развертывание решения с помощью azbb

Чтобы развернуть виртуальные машины Windows для эталонной архитектуры n-уровневого приложения, сделайте следующее:

1. Перейдите в папку `virtual-machines\n-tier-windows` репозитория, клонированного на шаге 1 (см. список необходимых компонентов).

2. Файл параметров присваивает стандартные имя пользователя и пароль для администратора каждой виртуальной машине в развертывании. Перед развертыванием эталонной архитектуры эти значения нужно изменить. Откройте файл `n-tier-windows.json` и замените все поля **adminUsername** и **adminPassword** новыми значениями.
  
  > [!NOTE]
  > Есть несколько сценариев, которые выполняются в ходе развертывания в объектах **VirtualMachineExtension** и параметрах **extension** для некоторых объектов **VirtualMachine**. Для работы некоторых из этих скриптов требуются учетные данные администратора, которые вы только что изменили. Рекомендуется просмотреть скрипты, чтобы проверить, указаны ли там правильные учетные данные. Развертывание может завершиться ошибкой, если будут указаны неправильные учетные данные.
  > 
  > 

Сохраните файл.

3. Разверните эталонную архитектуру, используя средство командной строки **azbb**, как показано ниже.

  ```bash
  azbb -s <your subscription_id> -g <your resource_group_name> -l <azure region> -p n-tier-windows.json --deploy
  ```

Дополнительные сведения о развертывании этого примера эталонной архитектуры с использованием стандартных блоков Azure см. в [нашем репозитории GitHub][git].


<!-- links -->
[dmz]: ../dmz/secure-vnet-dmz.md
[multi-dc]: multi-region-application.md
[multi-vm]: multi-vm.md
[n-tier]: n-tier.md
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[azure-administration]: /azure/automation/automation-intro
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-windows-manage-availability#configure-each-application-tier-into-separate-availability-sets
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-cli-2]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest
[azure-dns]: /azure/dns/dns-overview
[azure-key-vault]: https://azure.microsoft.com/services/key-vault
[узлом-бастионом]: https://en.wikipedia.org/wiki/Bastion_host
[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[chef]: https://www.chef.io/solutions/azure/
[git]: https://github.com/mspnp/template-building-blocks
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-windows
[lb-external-create]: /azure/load-balancer/load-balancer-get-started-internet-portal
[lb-internal-create]: /azure/load-balancer/load-balancer-get-started-ilb-arm-portal
[load-balancer-external]: /azure/load-balancer/load-balancer-internet-overview
[load-balancer-internal]: /azure/load-balancer/load-balancer-internal-overview
[nsg]: /azure/virtual-network/virtual-networks-nsg
[operations-management-suite]: https://www.microsoft.com/server-cloud/operations-management-suite/overview.aspx
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[общедоступный IP-адрес]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[puppet]: https://puppetlabs.com/blog/managing-azure-virtual-machines-puppet
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[sql-alwayson]: https://msdn.microsoft.com/library/hh510230.aspx
[sql-alwayson-force-failover]: https://msdn.microsoft.com/library/ff877957.aspx
[sql-alwayson-getting-started]: https://msdn.microsoft.com/library/gg509118.aspx
[sql-alwayson-ilb]: /azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener
[sql-alwayson-listeners]: https://msdn.microsoft.com/library/hh213417.aspx
[sql-alwayson-read-only-routing]: https://technet.microsoft.com/library/hh213417.aspx#ConnectToSecondary
[sql-keyvault]: /azure/virtual-machines/virtual-machines-windows-ps-sql-keyvault
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vnet faq]: /azure/virtual-network/virtual-networks-faq
[wsfc-whats-new]: https://technet.microsoft.com/windows-server-docs/failover-clustering/whats-new-in-failover-clustering
[Nagios]: https://www.nagios.org/
[Zabbix]: http://www.zabbix.com/
[Icinga]: http://www.icinga.org/
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[0]: ./images/n-tier-diagram.png "N-уровневая архитектура с использованием Microsoft Azure"