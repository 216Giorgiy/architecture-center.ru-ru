---
title: "Запуск виртуальных машин с балансировкой нагрузки в Azure для обеспечения масштабируемости и доступности"
description: "Узнайте, как запустить несколько виртуальных машин Windows в Azure для обеспечения масштабируемости и доступности."
author: telmosampaio
ms.date: 09/07/2017
pnp.series.title: Windows VM workloads
pnp.series.next: n-tier
pnp.series.prev: single-vm
ms.openlocfilehash: d38cfb41255c547f1f1e87ef289c7a79033df778
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="run-load-balanced-vms-for-scalability-and-availability"></a><span data-ttu-id="d4818-103">Запуск виртуальных машин с балансировкой нагрузки для обеспечения масштабируемости и доступности</span><span class="sxs-lookup"><span data-stu-id="d4818-103">Run load-balanced VMs for scalability and availability</span></span>

<span data-ttu-id="d4818-104">В этой эталонной архитектуре показан набор методик по запуску нескольких виртуальных машин Windows в масштабируемом наборе в подсистеме балансировки нагрузки для улучшения доступности и масштабируемости.</span><span class="sxs-lookup"><span data-stu-id="d4818-104">This reference architecture shows a set of proven practices for running several Windows virtual machines (VMs) in a scale set behind a load balancer, to improve availability and scalability.</span></span> <span data-ttu-id="d4818-105">Эта архитектура может использоваться для любой рабочей нагрузки без учета состояния, такой как веб-сервер, и является строительным блоком при развертывании n-уровневых приложений.</span><span class="sxs-lookup"><span data-stu-id="d4818-105">This architecture can be used for any stateless workload, such as a web server, and is a building block for deploying n-tier applications.</span></span> [<span data-ttu-id="d4818-106">**Разверните это решение**.</span><span class="sxs-lookup"><span data-stu-id="d4818-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="d4818-107">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="d4818-107">![[0]][0]</span></span>

<span data-ttu-id="d4818-108">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="d4818-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="d4818-109">Архитектура</span><span class="sxs-lookup"><span data-stu-id="d4818-109">Architecture</span></span>

<span data-ttu-id="d4818-110">Эта архитектура создана на основе архитектуры, описанной в статье [Run a Windows VM on Azure][single vm] (Запуск виртуальной машины Windows в Azure).</span><span class="sxs-lookup"><span data-stu-id="d4818-110">This architecture builds on the one shown in [Run a Windows VM on Azure][single vm].</span></span> <span data-ttu-id="d4818-111">Рекомендации также применимы к этой архитектуре.</span><span class="sxs-lookup"><span data-stu-id="d4818-111">The recommendations there also apply to this architecture.</span></span>

<span data-ttu-id="d4818-112">В этой архитектуре рабочая нагрузка распределяется по нескольким экземплярам виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-112">In this architecture, a workload is distributed across several VM instances.</span></span> <span data-ttu-id="d4818-113">Здесь приведен один общедоступный IP-адрес, а интернет-трафик распределяется между виртуальными машинами с помощью подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d4818-113">There is a single public IP address, and Internet traffic is distributed to the VMs using a load balancer.</span></span> <span data-ttu-id="d4818-114">Эта архитектура может использоваться для одноуровневых приложений, например веб-приложения без сохранения состояния.</span><span class="sxs-lookup"><span data-stu-id="d4818-114">This architecture can be used for a single-tier application, such as a stateless web application.</span></span>

<span data-ttu-id="d4818-115">Архитектура состоит из следующих компонентов:</span><span class="sxs-lookup"><span data-stu-id="d4818-115">The architecture has the following components:</span></span>

* <span data-ttu-id="d4818-116">**Группа ресурсов.**</span><span class="sxs-lookup"><span data-stu-id="d4818-116">**Resource group.**</span></span> <span data-ttu-id="d4818-117">[*Группы ресурсов*][resource-manager-overview] используются для группировки ресурсов, чтобы ими можно было управлять по времени существования, владельцу и другим критериям.</span><span class="sxs-lookup"><span data-stu-id="d4818-117">[*Resource groups*][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, and other criteria.</span></span>
* <span data-ttu-id="d4818-118">**Виртуальная сеть и подсеть.**</span><span class="sxs-lookup"><span data-stu-id="d4818-118">**Virtual network (VNet) and subnet.**</span></span> <span data-ttu-id="d4818-119">Каждая виртуальная машина в Azure развертывается в виртуальной сети, а виртуальные сети разделяются на подсети.</span><span class="sxs-lookup"><span data-stu-id="d4818-119">Every VM in Azure is deployed into a VNet that is further divided into subnets.</span></span>
* <span data-ttu-id="d4818-120">**Azure Load Balancer.**</span><span class="sxs-lookup"><span data-stu-id="d4818-120">**Azure Load Balancer**.</span></span> <span data-ttu-id="d4818-121">[Подсистема балансировки нагрузки] распределяет входящие запросы Интернета по экземплярам виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-121">The [load balancer] distributes incoming Internet requests to the VM instances.</span></span> 
* <span data-ttu-id="d4818-122">**Общедоступный IP-адрес.**</span><span class="sxs-lookup"><span data-stu-id="d4818-122">**Public IP address**.</span></span> <span data-ttu-id="d4818-123">Общедоступный IP-адрес необходим подсистеме балансировки нагрузки для приема интернет-трафика.</span><span class="sxs-lookup"><span data-stu-id="d4818-123">A public IP address is needed for the load balancer to receive Internet traffic.</span></span>
* <span data-ttu-id="d4818-124">**Масштабируемый набор виртуальных машин.**</span><span class="sxs-lookup"><span data-stu-id="d4818-124">**VM scale set**.</span></span> <span data-ttu-id="d4818-125">[Масштабируемый набор виртуальных машин][vm-scaleset] — это набор идентичных виртуальных машин, используемых для размещения рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d4818-125">A [VM scale set][vm-scaleset] is a set of identical VMs used to host a workload.</span></span> <span data-ttu-id="d4818-126">Масштабируемые наборы позволяют масштабировать некоторое количество виртуальных машин вручную или на основе предопределенных правил.</span><span class="sxs-lookup"><span data-stu-id="d4818-126">Scale sets allow the number of VMs to be scaled in or out manually, or based on predefined rules.</span></span>
* <span data-ttu-id="d4818-127">**Группа доступности**.</span><span class="sxs-lookup"><span data-stu-id="d4818-127">**Availability set**.</span></span> <span data-ttu-id="d4818-128">[Группа доступности][availability set] содержит виртуальные машины, что позволяет им использовать [соглашение об уровне обслуживания][vm-sla] более высокого уровня.</span><span class="sxs-lookup"><span data-stu-id="d4818-128">The [availability set][availability set] contains the VMs, making the VMs eligible for a higher [service level agreement (SLA)][vm-sla].</span></span> <span data-ttu-id="d4818-129">Для применения соглашений об уровне обслуживания более высокого уровня группа доступности должна включать как минимум две виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-129">For the higher SLA to apply, the availability set must include a minimum of two VMs.</span></span> <span data-ttu-id="d4818-130">Группы доступности неявны в масштабируемых наборах.</span><span class="sxs-lookup"><span data-stu-id="d4818-130">Availability sets are implicit in scale sets.</span></span> <span data-ttu-id="d4818-131">Если создать виртуальную машину за пределами масштабируемого набора, необходимо отдельно создать группу доступности.</span><span class="sxs-lookup"><span data-stu-id="d4818-131">If you create VMs outside a scale set, you need to create the availability set independently.</span></span>
* <span data-ttu-id="d4818-132">**Управляемые диски.**</span><span class="sxs-lookup"><span data-stu-id="d4818-132">**Managed disks**.</span></span> <span data-ttu-id="d4818-133">Управляемые диски Azure управляют файлами VHD виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-133">Azure Managed Disks manage the virtual hard disk (VHD) files for the VM disks.</span></span> 
* <span data-ttu-id="d4818-134">**Хранилище.**</span><span class="sxs-lookup"><span data-stu-id="d4818-134">**Storage**.</span></span> <span data-ttu-id="d4818-135">Создайте учетную запись хранения Azure, чтобы хранить журналы диагностики виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-135">Create an Azure Storage acount to hold diagnostic logs for the VMs.</span></span>

## <a name="recommendations"></a><span data-ttu-id="d4818-136">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="d4818-136">Recommendations</span></span>

<span data-ttu-id="d4818-137">Требования могут отличаться от архитектуры, описанной здесь.</span><span class="sxs-lookup"><span data-stu-id="d4818-137">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="d4818-138">Воспользуйтесь этими рекомендациями в качестве отправной точки.</span><span class="sxs-lookup"><span data-stu-id="d4818-138">Use these recommendations as a starting point.</span></span> 

### <a name="availability-and-scalability-recommendations"></a><span data-ttu-id="d4818-139">Рекомендации по доступности и масштабируемости</span><span class="sxs-lookup"><span data-stu-id="d4818-139">Availability and scalability recommendations</span></span>

<span data-ttu-id="d4818-140">Для обеспечения высокой доступности и масштабируемости можно использовать [масштабируемый набор виртуальных машин][vmss].</span><span class="sxs-lookup"><span data-stu-id="d4818-140">An option for availability and scalability is to use a [virtual machine scale set][vmss].</span></span> <span data-ttu-id="d4818-141">Масштабируемые наборы виртуальных машин позволяют развернуть набор идентичных виртуальных машин и управлять им.</span><span class="sxs-lookup"><span data-stu-id="d4818-141">VM scale sets help you to deploy and manage a set of identical VMs.</span></span> <span data-ttu-id="d4818-142">Они также поддерживают автоматическое масштабирование на основе метрик производительности.</span><span class="sxs-lookup"><span data-stu-id="d4818-142">Scale sets support autoscaling based on performance metrics.</span></span> <span data-ttu-id="d4818-143">По мере увеличения нагрузки на виртуальные машины в подсистему балансировки нагрузки автоматически добавляются дополнительные виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-143">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="d4818-144">Подумайте об использовании масштабируемых наборов, если необходимо быстро развернуть виртуальные машины или выполнить автомасштабирование.</span><span class="sxs-lookup"><span data-stu-id="d4818-144">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="d4818-145">По умолчанию масштабируемые наборы используют избыточную подготовку, что означает, что масштабируемый набор изначально подготавливает виртуальных машин больше, чем необходимо, а затем удаляет лишние.</span><span class="sxs-lookup"><span data-stu-id="d4818-145">By default, scale sets use "overprovisioning," which means the scale set initially provisions more VMs than you ask for, then deletes the extra VMs.</span></span> <span data-ttu-id="d4818-146">Это увеличивает общее количество успешных попыток при подготовке виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-146">This improves the overall success rate when provisioning the VMs.</span></span> <span data-ttu-id="d4818-147">При использовании [управляемых дисков](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks) рекомендуется размещать не более 20 виртуальных машин в одной учетной записи хранения при включенной избыточной подготовке и не более 40 виртуальных машин при отключенной.</span><span class="sxs-lookup"><span data-stu-id="d4818-147">If you are not using [managed disks](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), we recommend no more than 20 VMs per storage account with overprovisioning enabled, or no more than 40 VMs with overprovisioning disabled.</span></span>

<span data-ttu-id="d4818-148">Настройку виртуальных машин, развернутых в масштабируемый набор, можно выполнить двумя основными способами:</span><span class="sxs-lookup"><span data-stu-id="d4818-148">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="d4818-149">Использовать расширения для настройки виртуальной машины после ее подготовки.</span><span class="sxs-lookup"><span data-stu-id="d4818-149">Use extensions to configure the VM after it is provisioned.</span></span> <span data-ttu-id="d4818-150">В этом случае новые экземпляры виртуальной машины могут дольше запускаться, чем виртуальные машины без расширений.</span><span class="sxs-lookup"><span data-stu-id="d4818-150">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="d4818-151">Развернуть [управляемый диск](/azure/storage/storage-managed-disks-overview) с помощью пользовательского образа диска.</span><span class="sxs-lookup"><span data-stu-id="d4818-151">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="d4818-152">При этом развертывание выполняется быстрее.</span><span class="sxs-lookup"><span data-stu-id="d4818-152">This option may be quicker to deploy.</span></span> <span data-ttu-id="d4818-153">Однако требуется обновление образа.</span><span class="sxs-lookup"><span data-stu-id="d4818-153">However, it requires you to keep the image up to date.</span></span>

<span data-ttu-id="d4818-154">Дополнительные сведения см. в статье [Рекомендации по проектированию масштабируемых наборов][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="d4818-154">For additional considerations, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="d4818-155">При использовании любого решения автоматического масштабирования заблаговременно протестируйте его с рабочими нагрузками производственного уровня.</span><span class="sxs-lookup"><span data-stu-id="d4818-155">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="d4818-156">Рассмотрите возможность использования группы доступности, если масштабируемый набор не используется.</span><span class="sxs-lookup"><span data-stu-id="d4818-156">If you do not use a scale set, consider at least using an availability set.</span></span> <span data-ttu-id="d4818-157">Создайте по крайней мере две виртуальные машины в группе доступности для поддержки [соглашения об уровне обслуживания по доступности для виртуальных машин Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="d4818-157">Create at least two VMs in the availability set, to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="d4818-158">Для подсистемы балансировки нагрузки Azure также требуется, чтобы виртуальные машины с балансировкой нагрузки входили в одну группу доступности.</span><span class="sxs-lookup"><span data-stu-id="d4818-158">The Azure load balancer also requires that load-balanced VMs belong to the same availability set.</span></span>

<span data-ttu-id="d4818-159">В каждой подписке Azure настроены ограничения по умолчанию, включая максимальное количество виртуальных машин в каждом регионе.</span><span class="sxs-lookup"><span data-stu-id="d4818-159">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="d4818-160">Их лимит можно увеличить, создав запрос на поддержку.</span><span class="sxs-lookup"><span data-stu-id="d4818-160">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="d4818-161">Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="d4818-161">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

### <a name="network-recommendations"></a><span data-ttu-id="d4818-162">Рекомендации по сети</span><span class="sxs-lookup"><span data-stu-id="d4818-162">Network recommendations</span></span>

<span data-ttu-id="d4818-163">Поместите виртуальные машины в одну подсеть.</span><span class="sxs-lookup"><span data-stu-id="d4818-163">Place the VMs within the same subnet.</span></span> <span data-ttu-id="d4818-164">Не подключайте виртуальные машины напрямую к Интернету. Вместо этого предоставьте каждой из них частный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="d4818-164">Do not expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="d4818-165">Клиенты подключаются с помощью общедоступного IP-адреса подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d4818-165">Clients connect using the public IP address of the load balancer.</span></span>

<span data-ttu-id="d4818-166">Если вам нужно войти в виртуальные машины за подсистемой балансировки нагрузки, рассмотрите возможность добавления одной виртуальной машины в качестве узла-бастиона или jumpbox с общедоступным IP-адресом, с помощью которого можно выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="d4818-166">If you need to log into the VMs behind the load balancer, consider adding a single VM as a bastion host/jumpbox with a public IP address you can log into.</span></span> <span data-ttu-id="d4818-167">Затем войдите в виртуальные машины за подсистемой балансировки нагрузки из jumpbox.</span><span class="sxs-lookup"><span data-stu-id="d4818-167">And then log into the VMs behind the load balancer from the jumpbox.</span></span> <span data-ttu-id="d4818-168">В качестве альтернативы настройте правила NAT для входящих подключений в подсистеме балансировки нагрузки для той же цели.</span><span class="sxs-lookup"><span data-stu-id="d4818-168">Alternatively, configure inbound NAT rules in the load balancer for the same purpose.</span></span> <span data-ttu-id="d4818-169">Однако наличие jumpbox является лучшим решением в случае размещения n-уровневых рабочих нагрузок или нескольких рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="d4818-169">However, having a jumpbox is a better solution when you are hosting n-tier workloads, or multiple workloads.</span></span>

### <a name="load-balancer-recommendations"></a><span data-ttu-id="d4818-170">Рекомендации по использованию подсистемы балансировки нагрузки</span><span class="sxs-lookup"><span data-stu-id="d4818-170">Load balancer recommendations</span></span>

<span data-ttu-id="d4818-171">Добавьте все виртуальные машины в группе доступности в серверный пул адресов подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d4818-171">Add all VMs in the availability set to the back-end address pool of the load balancer.</span></span>

<span data-ttu-id="d4818-172">Определите правила подсистемы балансировки нагрузки для направления трафика к виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="d4818-172">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="d4818-173">Например, чтобы включить трафик HTTP, создайте правило, которое сопоставляет порт 80 интерфейсной конфигурации с портом 80 серверного пула адресов.</span><span class="sxs-lookup"><span data-stu-id="d4818-173">For example, to enable HTTP traffic, create a rule that maps port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="d4818-174">Когда клиент отправляет HTTP-запрос на порт 80, подсистема балансировки нагрузки выбирает IP-адрес серверной части с помощью [хэш-алгоритма][load balancer hashing], который включает исходный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="d4818-174">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load balancer hashing] that includes the source IP address.</span></span> <span data-ttu-id="d4818-175">Таким образом клиентские запросы распределяются по всем виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="d4818-175">In that way, client requests are distributed across all the VMs.</span></span>

<span data-ttu-id="d4818-176">Для передачи трафика в определенную виртуальную машину используйте правила NAT.</span><span class="sxs-lookup"><span data-stu-id="d4818-176">To route traffic to a specific VM, use NAT rules.</span></span> <span data-ttu-id="d4818-177">Например, чтобы включить подключение к виртуальным машинам по RDP, создайте отдельное правило NAT для каждой виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-177">For example, to enable RDP to the VMs, create a separate NAT rule for each VM.</span></span> <span data-ttu-id="d4818-178">Каждое правило должно быть сопоставлено с уникальным номером порта 3389 (порт по умолчанию для RDP).</span><span class="sxs-lookup"><span data-stu-id="d4818-178">Each rule should map a distinct port number to port 3389, the default port for RDP.</span></span> <span data-ttu-id="d4818-179">Например, используйте порт 50001 для VM1, порт 50002 для VM2 и т. д.</span><span class="sxs-lookup"><span data-stu-id="d4818-179">For example, use port 50001 for "VM1," port 50002 for "VM2," and so on.</span></span> <span data-ttu-id="d4818-180">Назначьте правила NAT для сетевых адаптеров в виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="d4818-180">Assign the NAT rules to the NICs on the VMs.</span></span>

### <a name="storage-account-recommendations"></a><span data-ttu-id="d4818-181">Рекомендации для учетной записи хранения</span><span class="sxs-lookup"><span data-stu-id="d4818-181">Storage account recommendations</span></span>

<span data-ttu-id="d4818-182">Создайте отдельные учетные записи хранения Azure для виртуальных жестких дисков каждой виртуальной машины, чтобы не превышать [ограничения по операциям ввода-вывода в секунду][vm-disk-limits] для учетных записей хранения.</span><span class="sxs-lookup"><span data-stu-id="d4818-182">Create separate Azure storage accounts for each VM to hold the virtual hard disks (VHDs), in order to avoid hitting the input/output operations per second [(IOPS) limits][vm-disk-limits] for storage accounts.</span></span>

<span data-ttu-id="d4818-183">Мы рекомендуем использовать [управляемые диски](/azure/storage/storage-managed-disks-overview) с [хранилищем класса Premium][premium].</span><span class="sxs-lookup"><span data-stu-id="d4818-183">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview) with [premium storage][premium].</span></span> <span data-ttu-id="d4818-184">Управляемым дискам не требуется учетная запись хранения.</span><span class="sxs-lookup"><span data-stu-id="d4818-184">Managed disks do not require a storage account.</span></span> <span data-ttu-id="d4818-185">Просто укажите размер и тип диска, и он будет развернут в качестве высокодоступного.</span><span class="sxs-lookup"><span data-stu-id="d4818-185">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span>

<span data-ttu-id="d4818-186">Создайте одну учетную запись хранения для журналов диагностики.</span><span class="sxs-lookup"><span data-stu-id="d4818-186">Create one storage account for diagnostic logs.</span></span> <span data-ttu-id="d4818-187">Эта учетная запись может совместно использоваться всеми виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="d4818-187">This storage account can be shared by all the VMs.</span></span> <span data-ttu-id="d4818-188">Это может быть неуправляемая учетная запись хранения, использующая стандартные диски.</span><span class="sxs-lookup"><span data-stu-id="d4818-188">This can be an unmanaged storage account using standard disks.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="d4818-189">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="d4818-189">Availability considerations</span></span>

<span data-ttu-id="d4818-190">Группа доступности делает приложение более устойчивым к запланированным и внеплановым событиям обслуживания.</span><span class="sxs-lookup"><span data-stu-id="d4818-190">The availability set makes your application more resilient to both planned and unplanned maintenance events.</span></span>

* <span data-ttu-id="d4818-191">*Плановое техническое обслуживание* возникает, когда корпорация Майкрософт обновляет базовую платформу, что иногда приводит к перезапуску виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-191">*Planned maintenance* occurs when Microsoft updates the underlying platform, sometimes causing VMs to be restarted.</span></span> <span data-ttu-id="d4818-192">Azure гарантирует, что виртуальные машины в группе доступности не перезагружаются одновременно.</span><span class="sxs-lookup"><span data-stu-id="d4818-192">Azure makes sure the VMs in an availability set are not all restarted at the same time.</span></span> <span data-ttu-id="d4818-193">По крайней мере одна из них остается включенной, пока другие перезагружаются.</span><span class="sxs-lookup"><span data-stu-id="d4818-193">At least one is kept running while others are restarting.</span></span>
* <span data-ttu-id="d4818-194">*Внеплановое обслуживание* происходит в случае сбоя оборудования.</span><span class="sxs-lookup"><span data-stu-id="d4818-194">*Unplanned maintenance* happens if there is a hardware failure.</span></span> <span data-ttu-id="d4818-195">Azure гарантирует, что виртуальные машины в группе доступности подготавливаются на нескольких серверных стойках.</span><span class="sxs-lookup"><span data-stu-id="d4818-195">Azure makes sure that VMs in an availability set are provisioned across more than one server rack.</span></span> <span data-ttu-id="d4818-196">Это помогает снизить влияние сбоев оборудования, сети, электропитания и т. д.</span><span class="sxs-lookup"><span data-stu-id="d4818-196">This helps to reduce the impact of hardware failures, network outages, power interruptions, and so on.</span></span>

<span data-ttu-id="d4818-197">Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure][availability set].</span><span class="sxs-lookup"><span data-stu-id="d4818-197">For more information, see [Manage the availability of virtual machines][availability set].</span></span> <span data-ttu-id="d4818-198">В следующем видео представлен оптимальный обзор групп доступности: [Microsoft Azure Fundamentals: Virtual Machines: (08) How Do I: Configure an Availability Set to Scale VMs][availability set ch9] (Основы Microsoft Azure — виртуальные машины. (08) Настройка группы доступности для масштабирования виртуальных машин).</span><span class="sxs-lookup"><span data-stu-id="d4818-198">The following video also has a good overview of availability sets: [How Do I Configure an Availability Set to Scale VMs][availability set ch9].</span></span>

> [!WARNING]
> <span data-ttu-id="d4818-199">Не забудьте настроить группу доступности при подготовке виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-199">Make sure to configure the availability set when you provision the VM.</span></span> <span data-ttu-id="d4818-200">В настоящее время после подготовки виртуальную машину диспетчера ресурсов невозможно добавить в группу доступности.</span><span class="sxs-lookup"><span data-stu-id="d4818-200">Currently, there is no way to add a Resource Manager VM to an availability set after the VM is provisioned.</span></span>

<span data-ttu-id="d4818-201">Подсистема балансировки нагрузки использует [проверку работоспособности] для мониторинга доступности экземпляров виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-201">The load balancer uses [health probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="d4818-202">Если проверка не выполняется в экземпляре в течение времени ожидания, подсистема балансировки нагрузки перестает отправлять трафик на эту виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="d4818-202">If a probe cannot reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="d4818-203">Тем не менее подсистема балансировки нагрузки продолжит выполнять проверку, и если виртуальная машина станет снова доступна, отправка трафика к этой виртуальной машине будет возобновлена.</span><span class="sxs-lookup"><span data-stu-id="d4818-203">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="d4818-204">Вот несколько рекомендаций по проверке работоспособности подсистемы балансировки нагрузки:</span><span class="sxs-lookup"><span data-stu-id="d4818-204">Here are some recommendations on load balancer health probes:</span></span>

* <span data-ttu-id="d4818-205">При проверке может тестироваться HTTP или TCP.</span><span class="sxs-lookup"><span data-stu-id="d4818-205">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="d4818-206">Если на виртуальных машинах запущен HTTP-сервер, создайте проверку HTTP.</span><span class="sxs-lookup"><span data-stu-id="d4818-206">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="d4818-207">В противном случае создайте проверку TCP.</span><span class="sxs-lookup"><span data-stu-id="d4818-207">Otherwise create a TCP probe.</span></span>
* <span data-ttu-id="d4818-208">В проверке HTTP укажите путь к конечной точке HTTP.</span><span class="sxs-lookup"><span data-stu-id="d4818-208">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="d4818-209">При этом проверяется код ответа HTTP 200 с этого пути.</span><span class="sxs-lookup"><span data-stu-id="d4818-209">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="d4818-210">Это может быть путь к корневому каталогу ("/") или конечная точка мониторинга работоспособности, которая реализует определенную пользовательскую логику для проверки работоспособности приложения.</span><span class="sxs-lookup"><span data-stu-id="d4818-210">This can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="d4818-211">Конечная точка должна разрешать анонимные HTTP-запросы.</span><span class="sxs-lookup"><span data-stu-id="d4818-211">The endpoint must allow anonymous HTTP requests.</span></span>
* <span data-ttu-id="d4818-212">Проверка отправляется с [известного][health-probe-ip] IP-адреса — 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="d4818-212">The probe is sent from a [known][health-probe-ip] IP address, 168.63.129.16.</span></span> <span data-ttu-id="d4818-213">Убедитесь, что вы не блокируете входящий и исходящий трафик для этого IP-адреса в каких-либо правилах брандмауэра или группе безопасности сети (NSG).</span><span class="sxs-lookup"><span data-stu-id="d4818-213">Make sure you don't block traffic to or from this IP in any firewall policies or network security group (NSG) rules.</span></span>
* <span data-ttu-id="d4818-214">Используйте [журналы проверки работоспособности][health probe log] для просмотра состояния проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="d4818-214">Use [health probe logs][health probe log] to view the status of the health probes.</span></span> <span data-ttu-id="d4818-215">Включите ведение журнала на портале Azure для каждой подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d4818-215">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="d4818-216">Журналы записываются в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="d4818-216">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="d4818-217">В журналах показано, сколько виртуальных машин на серверной стороне не получают сетевой трафик из-за неудачных ответов проверки.</span><span class="sxs-lookup"><span data-stu-id="d4818-217">The logs show how many VMs on the back end are not receiving network traffic due to failed probe responses.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="d4818-218">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="d4818-218">Manageability considerations</span></span>

<span data-ttu-id="d4818-219">При наличии нескольких виртуальных машин важно автоматизировать процессы, чтобы они были надежными и повторяемыми.</span><span class="sxs-lookup"><span data-stu-id="d4818-219">With multiple VMs, it is important to automate processes so they are reliable and repeatable.</span></span> <span data-ttu-id="d4818-220">Для автоматизации развертывания можно использовать [службу автоматизации Azure][azure-automation], исправления ОС и другие задачи.</span><span class="sxs-lookup"><span data-stu-id="d4818-220">You can use [Azure Automation][azure-automation] to automate deployment, OS patching, and other tasks.</span></span> <span data-ttu-id="d4818-221">Вы можете использовать для этих целей [службу автоматизации Azure][azure-automation] на базе Windows Powershell.</span><span class="sxs-lookup"><span data-stu-id="d4818-221">[Azure Automation][azure-automation] is an automation service based on Windows Powershell that can be used for this.</span></span> <span data-ttu-id="d4818-222">Пример сценария автоматизации можно просмотреть в [коллекции Runbook] на сайте TechNet.</span><span class="sxs-lookup"><span data-stu-id="d4818-222">Example automation scripts are available from the [Runbook Gallery] on TechNet.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="d4818-223">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="d4818-223">Security considerations</span></span>

<span data-ttu-id="d4818-224">Виртуальные сети являются границей, изолирующей трафик в Azure.</span><span class="sxs-lookup"><span data-stu-id="d4818-224">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="d4818-225">Виртуальные машины в одной виртуальной сети не могут обмениваться данными напрямую с виртуальными машинами в другой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="d4818-225">VMs in one VNet cannot communicate directly to VMs in a different VNet.</span></span> <span data-ttu-id="d4818-226">Виртуальные машины в одной виртуальной сети могут обмениваться данными, если только не созданы [группы безопасности сети][nsg], ограничивающие этот трафик.</span><span class="sxs-lookup"><span data-stu-id="d4818-226">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="d4818-227">Дополнительные сведения см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][network-security].</span><span class="sxs-lookup"><span data-stu-id="d4818-227">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="d4818-228">Для входящего интернет-трафика правила подсистемы балансировки нагрузки определяют, какой трафик может достичь серверной части.</span><span class="sxs-lookup"><span data-stu-id="d4818-228">For incoming Internet traffic, the load balancer rules define which traffic can reach the back end.</span></span> <span data-ttu-id="d4818-229">Однако правила подсистемы балансировки нагрузки не поддерживают списки безопасных IP-адресов, поэтому если вы хотите добавить некоторые общедоступные IP-адреса в список надежных, добавьте группу безопасности сети в подсеть.</span><span class="sxs-lookup"><span data-stu-id="d4818-229">However, load balancer rules don't support IP safe lists, so if you want to add certain public IP addresses to a safe list, add an NSG to the subnet.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="d4818-230">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="d4818-230">Deploy the solution</span></span>

<span data-ttu-id="d4818-231">Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="d4818-231">A deployment for this architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="d4818-232">Он позволяет развернуть следующее:</span><span class="sxs-lookup"><span data-stu-id="d4818-232">It deploys the following:</span></span>

  * <span data-ttu-id="d4818-233">Виртуальную сеть с одной подсетью, называющейся **web**, которая используется для размещения виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d4818-233">A virtual network with a single subnet named **web** used to host the VMs.</span></span>
  * <span data-ttu-id="d4818-234">Масштабируемый набор виртуальной машины, который содержит последнюю версию Windows Server 2016 Datacenter Edition.</span><span class="sxs-lookup"><span data-stu-id="d4818-234">A VM scale set that contains VMs running the latest version of Windows Server 2016 Datacenter Edition.</span></span> <span data-ttu-id="d4818-235">Автомасштабирование включено.</span><span class="sxs-lookup"><span data-stu-id="d4818-235">Autoscale is enabled.</span></span>
  * <span data-ttu-id="d4818-236">Подсистема балансировки нагрузки, которая находится перед масштабируемым набором виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-236">A load balancer that sits in front of the VM scale set.</span></span>
  * <span data-ttu-id="d4818-237">Группу безопасности сети с входящими правилами, позволяющими передавать HTTP-трафик в масштабируемый набор виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d4818-237">An NSG with incoming rules to allow HTTP traffic to the VM scale set.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="d4818-238">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="d4818-238">Prerequisites</span></span>

<span data-ttu-id="d4818-239">Перед развертыванием эталонной архитектуры в собственной подписке необходимо выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="d4818-239">Before you can deploy the reference architecture to your own subscription, you must perform the following steps.</span></span>

1. <span data-ttu-id="d4818-240">Клонируйте и скачайте ZIP-файл [с эталонными архитектурами AzureCAT][ref-arch-repo] в репозитории GitHub, а также выполните его разветвление.</span><span class="sxs-lookup"><span data-stu-id="d4818-240">Clone, fork, or download the zip file for the [AzureCAT reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="d4818-241">Убедитесь, что Azure CLI 2.0 установлен на компьютере.</span><span class="sxs-lookup"><span data-stu-id="d4818-241">Make sure you have the Azure CLI 2.0 installed on your computer.</span></span> <span data-ttu-id="d4818-242">Чтобы установить CLI, следуйте инструкциям в статье об [установке Azure CLI 2.0][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="d4818-242">To install the CLI, follow the instructions in [Install Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="d4818-243">Установите пакет npm [стандартных блоков Azure][azbb].</span><span class="sxs-lookup"><span data-stu-id="d4818-243">Install the [Azure building blocks][azbb] npm package.</span></span>

4. <span data-ttu-id="d4818-244">В командной строке, строке bash или строке PowerShell войдите в свою учетную запись Azure с помощью одной из приведенных ниже команд и следуйте инструкциям.</span><span class="sxs-lookup"><span data-stu-id="d4818-244">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using one of the commands below, and follow the prompts.</span></span>

  ```bash
  az login
  ```

### <a name="deploy-the-solution-using-azbb"></a><span data-ttu-id="d4818-245">Развертывание решения с помощью azbb</span><span class="sxs-lookup"><span data-stu-id="d4818-245">Deploy the solution using azbb</span></span>

<span data-ttu-id="d4818-246">Чтобы развернуть пример одной рабочей нагрузки виртуальной машины, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="d4818-246">To deploy the sample single VM workload, follow these steps:</span></span>

1. <span data-ttu-id="d4818-247">Перейдите в папку `virtual-machines\multi-vm\parameters\windows` репозитория, скачанного на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="d4818-247">Navigate to the `virtual-machines\multi-vm\parameters\windows` folder for the repository you downloaded in the pre-requisites step above.</span></span>

2. <span data-ttu-id="d4818-248">Откройте файл `multi-vm-v2.json` и введите имя пользователя и пароль в кавычках, как показано ниже, а затем сохраните файл.</span><span class="sxs-lookup"><span data-stu-id="d4818-248">Open the `multi-vm-v2.json` file and enter a username and password between the quotes, as shown below, then save the file.</span></span>

  ```bash
  "adminUsername": "",
  "adminPassword": "",
  ```

3. <span data-ttu-id="d4818-249">Запустите `azbb`, чтобы развернуть виртуальные машины, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="d4818-249">Run `azbb` to deploy the VMs as shown below.</span></span>

  ```bash
  azbb -s <subscription_id> -g <resource_group_name> -l <location> -p multi-vm-v2.json --deploy
  ```

<span data-ttu-id="d4818-250">Дополнительные сведения о развертывании этого примера эталонной архитектуры см. в [нашем репозитории GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="d4818-250">For more information on deploying this sample reference architecture, visit our [GitHub repository][git].</span></span>

<!-- Links -->
[github-folder]: http://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[n-tier-linux]: ../virtual-machines-linux/n-tier.md
[n-tier-windows]: n-tier.md
[single vm]: single-vm.md
[premium]: /azure/storage/common/storage-premium-storage
[naming conventions]: /azure/guidance/guidance-naming-conventions
[vm-scaleset]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[availability set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[availability set ch9]: https://channel9.msdn.com/Series/Microsoft-Azure-Fundamentals-Virtual-Machines/08
[azure-automation]: https://azure.microsoft.com/documentation/services/automation/
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-automation]: /azure/automation/automation-intro
[bastion host]: https://en.wikipedia.org/wiki/Bastion_host
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[health probe log]: /azure/load-balancer/load-balancer-monitor-log
[проверку работоспособности]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[Подсистема балансировки нагрузки]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load balancer hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[network-security]: /azure/best-practices-network-security
[nsg]: /azure/virtual-network/virtual-networks-nsg
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview 
[коллекции Runbook]: /azure/automation/automation-runbook-gallery#runbooks-in-runbook-gallery
[subscription-limits]: /azure/azure-subscription-service-limits
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[vm-disk-limits]: /azure/azure-subscription-service-limits#virtual-machine-disk-limits
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_2/
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[vmss-quickstart]: https://azure.microsoft.com/documentation/templates/?term=scale+set
[VM-sizes]: https://azure.microsoft.com/documentation/articles/virtual-machines-windows-sizes/
[0]: ./images/multi-vm-diagram.png "Архитектура решения с несколькими виртуальными машинами в Azure, включающая группу доступности с двумя виртуальными машинами и подсистемой балансировки нагрузки"
[azure-cli-2]: /azure/install-azure-cli?view=azure-cli-latest
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Template-Building-Blocks-Version-2-(Windows)
[git]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm