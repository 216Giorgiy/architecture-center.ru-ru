---
title: Запуск виртуальных машин Linux в нескольких регионах Azure для обеспечения высокой доступности
description: Узнайте, как развертывать виртуальные машины в нескольких регионах Azure для обеспечения высокого уровня доступности и устойчивости.
author: MikeWasson
ms.date: 11/22/2016
pnp.series.title: Linux VM workloads
pnp.series.prev: n-tier
ms.openlocfilehash: 07ccf44f28203e6d5001475b47adce01437e9600
ms.sourcegitcommit: c441fd165e6bebbbbbc19854ec6f3676be9c3b25
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2018
---
# <a name="run-linux-vms-in-multiple-regions-for-high-availability"></a>Запуск виртуальных машин Linux в нескольких регионах для обеспечения высокой доступности

Эта эталонная архитектура демонстрирует набор проверенных рекомендаций по работе с n-уровневыми приложениями в нескольких регионах Azure, благодаря которым можно достигнуть высокой доступности и получить надежную архитектуру аварийного восстановления. 

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура 

Эта архитектура создана на основе архитектуры, описанной в статье [Запуск виртуальных машин Linux для n-уровневого приложения](n-tier.md). 

* **Основной и дополнительный регионы.** Чтобы достичь более высокого уровня доступности, используйте два региона Azure, один из которых является основным, а второй предназначен для отработки отказа.
* **Azure DNS**. [Azure DNS][azure-dns] — это служба размещения для доменов DNS, которая предоставляет разрешение имен с помощью инфраструктуры Microsoft Azure. Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.
* **Диспетчер трафика Azure.** [Диспетчер трафика][traffic-manager] направляет входящие запросы к одному из регионов. При обычной работе он направляет запросы в основной регион. Если этот регион становится недоступным, диспетчер трафика выполняет отработку отказа в дополнительный регион. Дополнительные сведения см. в разделе [Конфигурация диспетчера трафика](#traffic-manager-configuration).
* **Группы ресурсов.** Создайте отдельные [группы ресурсов][resource groups] для основного и вторичного регионов, а также для диспетчера трафика. Так вы получите возможность управлять каждым регионом как одной коллекцией ресурсов. Например, можно повторно развернуть один регион, не отключая другой. [Свяжите группы ресурсов][resource-group-links], чтобы запустить запрос на перечисление всех ресурсов приложения.
* **Виртуальные сети.** Создайте отдельные виртуальные сети для каждого региона. Убедитесь, что указанные пространства адресов не перекрываются.
* **Apache Cassandra.** Разверните Cassandra в центрах обработки данных в регионах Azure для обеспечения высокого уровня доступности. В каждом регионе узлы настраиваются в режиме с поддержкой стоек с доменами сбоя и обновления для обеспечения устойчивости внутри региона.

## <a name="recommendations"></a>Рекомендации

Архитектура с несколькими регионами может обеспечить более высокий уровень доступности, чем развертывание в одном регионе. Если региональный сбой влияет на основной регион, можно использовать [диспетчер трафика][traffic-manager] для выполнения отработки отказа в дополнительный регион. Эта архитектура также помогает при сбое отдельной подсистемы или приложения.

Есть несколько общих подходов к достижению высокого уровня доступности в регионах:   

* Шаблон "активный — пассивный" с "горячим" резервом. Трафик отправляется в один регион, в то время как другой ожидает в режиме "горячего" резерва. "Горячий" резерв применяется, когда виртуальные машины в дополнительном регионе выделены и выполняются постоянно.
* Шаблон "активный — пассивный" с "холодным" резервом. Трафик отправляется в один регион, в то время как другой ожидает в режиме "холодного" резерва. "Холодный" резерв предполагает, что виртуальные машины в дополнительном регионе выделяются, только когда они требуются для отработки отказа. Этот подход экономичнее, однако при сбое для выхода в динамический режим требуется больше времени.
* Шаблон "активный — активный". Оба региона активны, нагрузка запросов балансируется между ними. Если один регион отключается, он изымается из ротации. 

В этой архитектуре уделяется внимание режиму "активный — пассивный" с "горячим" резервом, а также использованию диспетчера трафика для отработки отказа. Обратите внимание, что можно развернуть несколько виртуальных машин в качестве "горячего" резерва, а затем масштабировать их при необходимости.


### <a name="regional-pairing"></a>Региональные пары

Каждый регион Azure образует пару с другим регионом в пределах одной географической территории. В общем случае выбирайте регионы из одной региональной пары (например, восточная часть США 2, центральная часть США). Преимущества:

* в случае масштабного сбоя назначаются приоритеты восстановления по крайней мере одного региона из каждой пары;
* запланированные обновления системы Azure распространяются в парах регионов последовательно во избежание возможных простоев;
* пары находятся в пределах одной географической территории в соответствии с требованиями к местонахождению данных.

Убедитесь, что оба региона поддерживают все службы Azure, необходимые приложению (см. статью [Доступность продуктов по регионам][services-by-region]). Дополнительные сведения о парах регионов см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure][regional-pairs].

### <a name="traffic-manager-configuration"></a>Конфигурация диспетчера трафика

При настройке диспетчера трафика необходимо учитывать следующее:

* **Маршрутизация.** Диспетчер трафика поддерживает несколько [алгоритмов маршрутизации][tm-routing]. Для сценария, описанного в этой статье, используется маршрутизация по *приоритету* (ранее называлась маршрутизацией *отработки отказа*). С помощью этой функции диспетчер трафика отправляет все запросы в основной регион, если дополнительный регион не станет недоступным. В этот момент он автоматически выполняет отработку отказа в дополнительный регион. Дополнительные сведения см. в статье [Настройка метода маршрутизации трафика по приоритету в диспетчере трафика][tm-configure-failover].
* **Проверка работоспособности.** Диспетчер трафика использует [проверку][tm-monitoring] HTTP (или HTTPS) для мониторинга доступности каждого региона. При этом проверяется код ответа HTTP 200 в заданном пути URL-адреса. Рекомендуется создать конечную точку, которая сообщает о работоспособности приложения, и использовать ее для проверки работоспособности. В противном случае при проверке может быть сообщено о работоспособной конечной точке, тогда как критические части приложения фактически не будут работать. Дополнительную информацию см. в статье [Health Endpoint Monitoring pattern][health-endpoint-monitoring-pattern] (Шаблон мониторинга конечной точки работоспособности).

При выполнении отработки отказа диспетчера трафика в течение определенного времени клиенты не могут связаться с приложением. Этот период зависит от следующих факторов:

* При проверке работоспособности определяется, что с основным регионом невозможно связаться.
* DNS-серверы должны обновить кэшированные записи DNS для IP-адресов, которые зависят от срока существования DNS. Срок существования по умолчанию — 300 секунд (5 минут), однако это значение можно настроить при создании профиля диспетчера трафика.

Дополнительные сведения см. в статье [Мониторинг конечных точек в диспетчере трафика][tm-monitoring].

При отработке отказа диспетчера трафика ее рекомендуется выполнять вручную, а не внедрять автоматическую отработку отказа. В противном случае могут возникнуть ситуации, в которых приложение будет переходить между регионами. Убедитесь, что все подсистемы приложения полностью работоспособны, и лишь затем выполните восстановление размещения.

Обратите внимание, что диспетчер трафика по умолчанию автоматически восстанавливает размещение. Чтобы избежать этого, вручную понизьте приоритет основного региона после отработки отказа. Например, предположим, что основной регион имеет приоритет 1, а дополнительные — приоритет 2. После отработки отказа задайте основному региону приоритет 3, чтобы избежать автоматического восстановления размещения. Когда будете готовы переключить приоритет обратно, измените приоритет до 1.

Следующая команда [Azure CLI][install-azure-cli] обновляет приоритет:

```bat
azure network traffic-manager  endpoint set --resource-group <resource-group> --profile-name <profile>
    --name <traffic-manager-name> --type AzureEndpoints --priority 3
```    

Другой подход заключается во временном отключении конечной точки, пока не появится возможность восстановить размещение:

```bat
azure network traffic-manager  endpoint set --resource-group <resource-group> --profile-name <profile>
    --name <traffic-manager-name> --type AzureEndpoints --status Disabled
```    

В зависимости от причины отработки отказа может потребоваться повторное развертывание ресурсов в пределах региона. До восстановления размещения выполните тест готовности к работе. При этом проверяется следующее:

* правильная настройка виртуальных машин (все необходимое программное обеспечение установлено, IIS выполняются и т. д.);
* работоспособность подсистем приложения;
* функциональное тестирование (например, доступен ли уровень базы данных с веб-уровня).

### <a name="cassandra-deployment-across-multiple-regions"></a>Развертывание Cassandra в нескольких регионах

Центры обработки данных Cassandra — это группа связанных узлов данных, которые настроены вместе внутри кластера для репликации и разделения рабочей нагрузки.

Рекомендуем использовать [DataStax Enterprise][datastax] в рабочей среде. Дополнительные сведения о запуске DataStax в Azure см. в [руководстве по развертыванию DataStax Enterprise для Azure][cassandra-in-azure]. Следующие общие рекомендации применимы к любой версии Cassandra: 

* Присвойте общедоступный IP-адрес каждому узлу. Это позволяет кластерам обмениваться данными между регионами, используя магистральную инфраструктуру Azure, обеспечивающую высокую пропускную способность при низких затратах.
* Защитите узлы с помощью соответствующих конфигураций брандмауэра и групп безопасности сети (NSG), разрешая трафик только от известных узлов, включая клиенты и другие узлы кластера. Обратите внимание, что Cassandra использует разные порты для связи, например OpsCenter, Spark и т. д. Сведения об использовании портов в Cassandra см. в статье [Configuring firewall port access][cassandra-ports] (Настройка портов доступа к брандмауэру).
* Используйте шифрование SSL для обмена данными между [узлом и клиентом][ssl-client-node] и [между узлами][ssl-node-node].
* В рамках региона следуйте рекомендациям, изложенным в [этой статье](n-tier.md#cassandra).

## <a name="availability-considerations"></a>Вопросы доступности

С помощью сложного n-уровневого приложения можно не реплицировать все приложение в дополнительном регионе. Вместо этого вы можете просто реплицировать критическую подсистему, необходимую для обеспечения непрерывной работы бизнеса.

Диспетчер трафика — это точка возможного сбоя в системе. Если происходит сбой диспетчера трафика, клиенты не смогут получить доступ к приложению во время простоя. Просмотрите [соглашение об уровне обслуживания диспетчера трафика][tm-sla] и подумайте, достаточно ли диспетчера трафика в соответствии с требованиями к высокой доступности в вашей организации. Если это не так, добавьте резервное решение для управления трафиком. Если в службе диспетчера трафика Azure произошел сбой, измените записи CNAME в службе доменных имен, чтобы они указывали на резервную службу управления трафиком. (Этот шаг нужно выполнить вручную, приложение будет отключено, пока изменения DNS не распространятся.)

Для кластера Cassandra сценарии отработки отказа зависят от уровней согласованности, используемых приложением, а также от количества используемых реплик. Сведения об уровнях согласованности и потреблении в Cassandra см. в статьях [Configuring firewall port access][cassandra-consistency] (Настройка портов доступа к брандмауэру) и [Cassandra: How many nodes are talked to with Quorum? Also should I use it?][cassandra-consistency-usage] (Cassandra. Сколько узлов обмениваются данными с кворумом и следует ли его использовать?). Доступность данных в Cassandra определяется уровнем согласованности, используемым приложением, и механизмом репликации. Сведения о репликации в Cassandra см. в статье [Data Replication in NoSQL Databases Explained][cassandra-replication] (Описание репликации данных в базах данных NoSQL).

## <a name="manageability-considerations"></a>Вопросы управляемости

При обновлении развертывания обновляйте один регион за раз, чтобы уменьшить вероятность глобального сбоя из-за неправильной конфигурации или ошибки в приложении.

Проверьте устойчивость системы к сбоям. Ниже приведены некоторые распространенные сценарии сбоев для тестирования:

* завершение работы экземпляров виртуальной машины;
* нехватка ресурсов, таких как ЦП и память;
* отключение или задержка сети;
* прекращение работы процессов;
* завершение срока действия сертификатов;
* моделирование сбоев оборудования;
* завершение работы службы DNS на контроллерах домена.

Измерьте время восстановления и убедитесь, что оно соответствует вашим бизнес-требованиям. Следует также протестировать комбинации режимов отказа.


<!-- Links -->
[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[cassandra-in-azure]: https://academy.datastax.com/resources/deployment-guide-azure
[cassandra-consistency]: http://docs.datastax.com/en/cassandra/2.0/cassandra/dml/dml_config_consistency_c.html
[cassandra-replication]: http://www.planetcassandra.org/data-replication-in-nosql-databases-explained/
[cassandra-consistency-usage]: https://medium.com/@foundev/cassandra-how-many-nodes-are-talked-to-with-quorum-also-should-i-use-it-98074e75d7d5#.b4pb4alb2
[cassandra-ports]: https://docs.datastax.com/en/datastax_enterprise/5.0/datastax_enterprise/sec/configFirewallPorts.html
[datastax]: https://www.datastax.com/products/datastax-enterprise
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[install-azure-cli]: /azure/xplat-cli-install
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[services-by-region]: https://azure.microsoft.com/regions/#services
[ssl-client-node]: http://docs.datastax.com/en/cassandra/2.0/cassandra/security/secureSSLClientToNode_t.html
[ssl-node-node]: http://docs.datastax.com/en/cassandra/2.0/cassandra/security/secureSSLNodeToNode_t.html
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager/v1_0/
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager/
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx
[0]: ./images/multi-region-application-diagram.png "Высокодоступная сетевая архитектура для n-уровневых приложений Azure"
