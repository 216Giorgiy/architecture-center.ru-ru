---
title: "Запуск виртуальных машин Linux в нескольких регионах Azure для обеспечения высокой доступности"
description: "Узнайте, как развертывать виртуальные машины в нескольких регионах Azure для обеспечения высокого уровня доступности и устойчивости."
author: MikeWasson
ms.date: 11/22/2016
pnp.series.title: Linux VM workloads
pnp.series.prev: n-tier
ms.openlocfilehash: 7d720a004d21edbffc0ddeba54e291aa817550e0
ms.sourcegitcommit: c9e6d8edb069b8c513de748ce8114c879bad5f49
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2018
---
# <a name="run-linux-vms-in-multiple-regions-for-high-availability"></a><span data-ttu-id="32926-103">Запуск виртуальных машин Linux в нескольких регионах для обеспечения высокой доступности</span><span class="sxs-lookup"><span data-stu-id="32926-103">Run Linux VMs in multiple regions for high availability</span></span>

<span data-ttu-id="32926-104">Эта эталонная архитектура демонстрирует набор проверенных рекомендаций по работе с n-уровневыми приложениями в нескольких регионах Azure, благодаря которым можно достигнуть высокой доступности и получить надежную архитектуру аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="32926-104">This reference architecture shows a set of proven practices for running an N-tier application in multiple Azure regions, in order to achieve availability and a robust disaster recovery infrastructure.</span></span> 

<span data-ttu-id="32926-105">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="32926-105">![[0]][0]</span></span>

<span data-ttu-id="32926-106">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="32926-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="32926-107">Архитектура</span><span class="sxs-lookup"><span data-stu-id="32926-107">Architecture</span></span> 

<span data-ttu-id="32926-108">Эта архитектура создана на основе архитектуры, описанной в статье [Запуск виртуальных машин Linux для n-уровневого приложения](n-tier.md).</span><span class="sxs-lookup"><span data-stu-id="32926-108">This architecture builds on the one shown in [Run Linux VMs for an N-tier application](n-tier.md).</span></span> 

* <span data-ttu-id="32926-109">**Основной и дополнительный регионы.**</span><span class="sxs-lookup"><span data-stu-id="32926-109">**Primary and secondary regions**.</span></span> <span data-ttu-id="32926-110">Чтобы достичь более высокого уровня доступности, используйте два региона Azure,</span><span class="sxs-lookup"><span data-stu-id="32926-110">Use two regions to achieve higher availability.</span></span> <span data-ttu-id="32926-111">один из которых является основным, а второй предназначен для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-111">One is the primary region.The other region is for failover.</span></span>
* <span data-ttu-id="32926-112">**Azure DNS**.</span><span class="sxs-lookup"><span data-stu-id="32926-112">**Azure DNS**.</span></span> <span data-ttu-id="32926-113">[Azure DNS][azure-dns] — это служба размещения для доменов DNS, которая предоставляет разрешение имен с помощью инфраструктуры Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="32926-113">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="32926-114">Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.</span><span class="sxs-lookup"><span data-stu-id="32926-114">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>
* <span data-ttu-id="32926-115">**Диспетчер трафика Azure.**</span><span class="sxs-lookup"><span data-stu-id="32926-115">**Azure Traffic Manager**.</span></span> <span data-ttu-id="32926-116">[Диспетчер трафика][traffic-manager] направляет входящие запросы к одному из регионов.</span><span class="sxs-lookup"><span data-stu-id="32926-116">[Traffic Manager][traffic-manager] routes incoming requests to one of the regions.</span></span> <span data-ttu-id="32926-117">При обычной работе он направляет запросы в основной регион.</span><span class="sxs-lookup"><span data-stu-id="32926-117">During normal operations, it routes requests to the primary region.</span></span> <span data-ttu-id="32926-118">Если этот регион становится недоступным, диспетчер трафика выполняет отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="32926-118">If that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span> <span data-ttu-id="32926-119">Дополнительные сведения см. в разделе [Конфигурация диспетчера трафика](#traffic-manager-configuration).</span><span class="sxs-lookup"><span data-stu-id="32926-119">For more information, see the section [Traffic Manager configuration](#traffic-manager-configuration).</span></span>
* <span data-ttu-id="32926-120">**Группы ресурсов.**</span><span class="sxs-lookup"><span data-stu-id="32926-120">**Resource groups**.</span></span> <span data-ttu-id="32926-121">Создайте отдельные [группы ресурсов][resource groups] для основного и вторичного регионов, а также для диспетчера трафика.</span><span class="sxs-lookup"><span data-stu-id="32926-121">Create separate [resource groups][resource groups] for the primary region, the secondary region, and for Traffic Manager.</span></span> <span data-ttu-id="32926-122">Так вы получите возможность управлять каждым регионом как одной коллекцией ресурсов.</span><span class="sxs-lookup"><span data-stu-id="32926-122">This gives you the flexibility to manage each region as a single collection of resources.</span></span> <span data-ttu-id="32926-123">Например, можно повторно развернуть один регион, не отключая другой.</span><span class="sxs-lookup"><span data-stu-id="32926-123">For example, you could redeploy one region, without taking down the other one.</span></span> <span data-ttu-id="32926-124">[Свяжите группы ресурсов][resource-group-links], чтобы запустить запрос на перечисление всех ресурсов приложения.</span><span class="sxs-lookup"><span data-stu-id="32926-124">[Link the resource groups][resource-group-links], so that you can run a query to list all the resources for the application.</span></span>
* <span data-ttu-id="32926-125">**Виртуальные сети.**</span><span class="sxs-lookup"><span data-stu-id="32926-125">**VNets**.</span></span> <span data-ttu-id="32926-126">Создайте отдельные виртуальные сети для каждого региона.</span><span class="sxs-lookup"><span data-stu-id="32926-126">Create a separate VNet for each region.</span></span> <span data-ttu-id="32926-127">Убедитесь, что указанные пространства адресов не перекрываются.</span><span class="sxs-lookup"><span data-stu-id="32926-127">Make sure the address spaces do not overlap.</span></span>
* <span data-ttu-id="32926-128">**Apache Cassandra.**</span><span class="sxs-lookup"><span data-stu-id="32926-128">**Apache Cassandra**.</span></span> <span data-ttu-id="32926-129">Разверните Cassandra в центрах обработки данных в регионах Azure для обеспечения высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="32926-129">Deploy Cassandra in data centers across Azure regions for high availability.</span></span> <span data-ttu-id="32926-130">В каждом регионе узлы настраиваются в режиме с поддержкой стоек с доменами сбоя и обновления для обеспечения устойчивости внутри региона.</span><span class="sxs-lookup"><span data-stu-id="32926-130">Within each region, nodes are configured in rack-aware mode with fault and upgrade domains, for resiliency inside the region.</span></span>

## <a name="recommendations"></a><span data-ttu-id="32926-131">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="32926-131">Recommendations</span></span>

<span data-ttu-id="32926-132">Архитектура с несколькими регионами может обеспечить более высокий уровень доступности, чем развертывание в одном регионе.</span><span class="sxs-lookup"><span data-stu-id="32926-132">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="32926-133">Если региональный сбой влияет на основной регион, можно использовать [диспетчер трафика][traffic-manager] для выполнения отработки отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="32926-133">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="32926-134">Эта архитектура также помогает при сбое отдельной подсистемы или приложения.</span><span class="sxs-lookup"><span data-stu-id="32926-134">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="32926-135">Есть несколько общих подходов к достижению высокого уровня доступности в регионах:</span><span class="sxs-lookup"><span data-stu-id="32926-135">There are several general approaches to achieving high availability across regions:</span></span>   

* <span data-ttu-id="32926-136">Шаблон "активный — пассивный" с "горячим" резервом.</span><span class="sxs-lookup"><span data-stu-id="32926-136">Active/passive with hot standby.</span></span> <span data-ttu-id="32926-137">Трафик отправляется в один регион, в то время как другой ожидает в режиме "горячего" резерва.</span><span class="sxs-lookup"><span data-stu-id="32926-137">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="32926-138">"Горячий" резерв применяется, когда виртуальные машины в дополнительном регионе выделены и выполняются постоянно.</span><span class="sxs-lookup"><span data-stu-id="32926-138">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
* <span data-ttu-id="32926-139">Шаблон "активный — пассивный" с "холодным" резервом.</span><span class="sxs-lookup"><span data-stu-id="32926-139">Active/passive with cold standby.</span></span> <span data-ttu-id="32926-140">Трафик отправляется в один регион, в то время как другой ожидает в режиме "холодного" резерва.</span><span class="sxs-lookup"><span data-stu-id="32926-140">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="32926-141">"Холодный" резерв предполагает, что виртуальные машины в дополнительном регионе выделяются, только когда они требуются для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-141">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="32926-142">Этот подход экономичнее, однако при сбое для выхода в динамический режим требуется больше времени.</span><span class="sxs-lookup"><span data-stu-id="32926-142">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
* <span data-ttu-id="32926-143">Шаблон "активный — активный".</span><span class="sxs-lookup"><span data-stu-id="32926-143">Active/active.</span></span> <span data-ttu-id="32926-144">Оба региона активны, нагрузка запросов балансируется между ними.</span><span class="sxs-lookup"><span data-stu-id="32926-144">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="32926-145">Если один регион отключается, он изымается из ротации.</span><span class="sxs-lookup"><span data-stu-id="32926-145">If one region becomes unavailable, it is taken out of rotation.</span></span> 

<span data-ttu-id="32926-146">В этой архитектуре уделяется внимание режиму "активный — пассивный" с "горячим" резервом, а также использованию диспетчера трафика для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-146">This architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> <span data-ttu-id="32926-147">Обратите внимание, что можно развернуть несколько виртуальных машин в качестве "горячего" резерва, а затем масштабировать их при необходимости.</span><span class="sxs-lookup"><span data-stu-id="32926-147">Note that you could deploy a small number of VMs for hot standby and then scale out as needed.</span></span>


### <a name="regional-pairing"></a><span data-ttu-id="32926-148">Региональные пары</span><span class="sxs-lookup"><span data-stu-id="32926-148">Regional pairing</span></span>

<span data-ttu-id="32926-149">Каждый регион Azure образует пару с другим регионом в пределах одной географической территории.</span><span class="sxs-lookup"><span data-stu-id="32926-149">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="32926-150">В общем случае выбирайте регионы из одной региональной пары (например, восточная часть США 2, центральная часть США).</span><span class="sxs-lookup"><span data-stu-id="32926-150">In general, choose regions from the same regional pair (for example, East US 2 and US Central).</span></span> <span data-ttu-id="32926-151">Преимущества:</span><span class="sxs-lookup"><span data-stu-id="32926-151">Benefits of doing so include:</span></span>

* <span data-ttu-id="32926-152">в случае масштабного сбоя назначаются приоритеты восстановления по крайней мере одного региона из каждой пары;</span><span class="sxs-lookup"><span data-stu-id="32926-152">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
* <span data-ttu-id="32926-153">запланированные обновления системы Azure распространяются в парах регионов последовательно во избежание возможных простоев;</span><span class="sxs-lookup"><span data-stu-id="32926-153">Planned Azure system updates are rolled out to paired regions sequentially, to minimize possible downtime.</span></span>
* <span data-ttu-id="32926-154">пары находятся в пределах одной географической территории в соответствии с требованиями к местонахождению данных.</span><span class="sxs-lookup"><span data-stu-id="32926-154">Pairs reside within the same geography, to meet data residency requirements.</span></span>

<span data-ttu-id="32926-155">Убедитесь, что оба региона поддерживают все службы Azure, необходимые приложению (см. статью [Доступность продуктов по регионам][services-by-region]).</span><span class="sxs-lookup"><span data-stu-id="32926-155">However, make sure that both regions support all of the Azure services needed for your application (see [Services by region][services-by-region]).</span></span> <span data-ttu-id="32926-156">Дополнительные сведения о парах регионов см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure][regional-pairs].</span><span class="sxs-lookup"><span data-stu-id="32926-156">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="32926-157">Конфигурация диспетчера трафика</span><span class="sxs-lookup"><span data-stu-id="32926-157">Traffic Manager configuration</span></span>

<span data-ttu-id="32926-158">При настройке диспетчера трафика необходимо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="32926-158">Consider the following points when configuring Traffic Manager:</span></span>

* <span data-ttu-id="32926-159">**Маршрутизация.**</span><span class="sxs-lookup"><span data-stu-id="32926-159">**Routing**.</span></span> <span data-ttu-id="32926-160">Диспетчер трафика поддерживает несколько [алгоритмов маршрутизации][tm-routing].</span><span class="sxs-lookup"><span data-stu-id="32926-160">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="32926-161">Для сценария, описанного в этой статье, используется маршрутизация по *приоритету* (ранее называлась маршрутизацией *отработки отказа*).</span><span class="sxs-lookup"><span data-stu-id="32926-161">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="32926-162">С помощью этой функции диспетчер трафика отправляет все запросы в основной регион, если дополнительный регион не станет недоступным.</span><span class="sxs-lookup"><span data-stu-id="32926-162">With this setting, Traffic Manager sends all requests to the primary region, unless the primary region becomes unreachable.</span></span> <span data-ttu-id="32926-163">В этот момент он автоматически выполняет отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="32926-163">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="32926-164">Дополнительные сведения см. в статье [Настройка метода маршрутизации трафика по приоритету в диспетчере трафика][tm-configure-failover].</span><span class="sxs-lookup"><span data-stu-id="32926-164">See [Configure Failover routing method][tm-configure-failover].</span></span>
* <span data-ttu-id="32926-165">**Проверка работоспособности.**</span><span class="sxs-lookup"><span data-stu-id="32926-165">**Health probe**.</span></span> <span data-ttu-id="32926-166">Диспетчер трафика использует [проверку][tm-monitoring] HTTP (или HTTPS) для мониторинга доступности каждого региона.</span><span class="sxs-lookup"><span data-stu-id="32926-166">Traffic Manager uses an HTTP (or HTTPS) [probe][tm-monitoring] to monitor the availability of each region.</span></span> <span data-ttu-id="32926-167">При этом проверяется код ответа HTTP 200 в заданном пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="32926-167">The probe checks for an HTTP 200 response for a specified URL path.</span></span> <span data-ttu-id="32926-168">Рекомендуется создать конечную точку, которая сообщает о работоспособности приложения, и использовать ее для проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="32926-168">As a best practice, create an endpoint that reports the overall health of the application, and use this endpoint for the health probe.</span></span> <span data-ttu-id="32926-169">В противном случае при проверке может быть сообщено о работоспособной конечной точке, тогда как критические части приложения фактически не будут работать.</span><span class="sxs-lookup"><span data-stu-id="32926-169">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span> <span data-ttu-id="32926-170">Дополнительную информацию см. в статье [Health Endpoint Monitoring pattern][health-endpoint-monitoring-pattern] (Шаблон мониторинга конечной точки работоспособности).</span><span class="sxs-lookup"><span data-stu-id="32926-170">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="32926-171">При выполнении отработки отказа диспетчера трафика в течение определенного времени клиенты не могут связаться с приложением.</span><span class="sxs-lookup"><span data-stu-id="32926-171">When Traffic Manager fails over there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="32926-172">Этот период зависит от следующих факторов:</span><span class="sxs-lookup"><span data-stu-id="32926-172">The duration is affected by the following factors:</span></span>

* <span data-ttu-id="32926-173">При проверке работоспособности определяется, что с основным регионом невозможно связаться.</span><span class="sxs-lookup"><span data-stu-id="32926-173">The health probe must detect that the primary region has become unreachable.</span></span>
* <span data-ttu-id="32926-174">DNS-серверы должны обновить кэшированные записи DNS для IP-адресов, которые зависят от срока существования DNS.</span><span class="sxs-lookup"><span data-stu-id="32926-174">DNS servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="32926-175">Срок существования по умолчанию — 300 секунд (5 минут), однако это значение можно настроить при создании профиля диспетчера трафика.</span><span class="sxs-lookup"><span data-stu-id="32926-175">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="32926-176">Дополнительные сведения см. в статье [Мониторинг конечных точек в диспетчере трафика][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="32926-176">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="32926-177">При отработке отказа диспетчера трафика ее рекомендуется выполнять вручную, а не внедрять автоматическую отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-177">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="32926-178">В противном случае могут возникнуть ситуации, в которых приложение будет переходить между регионами.</span><span class="sxs-lookup"><span data-stu-id="32926-178">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="32926-179">Убедитесь, что все подсистемы приложения полностью работоспособны, и лишь затем выполните восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="32926-179">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="32926-180">Обратите внимание, что диспетчер трафика по умолчанию автоматически восстанавливает размещение.</span><span class="sxs-lookup"><span data-stu-id="32926-180">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="32926-181">Чтобы избежать этого, вручную понизьте приоритет основного региона после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-181">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="32926-182">Например, предположим, что основной регион имеет приоритет 1, а дополнительные — приоритет 2.</span><span class="sxs-lookup"><span data-stu-id="32926-182">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="32926-183">После отработки отказа задайте основному региону приоритет 3, чтобы избежать автоматического восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="32926-183">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="32926-184">Когда будете готовы переключить приоритет обратно, измените приоритет до 1.</span><span class="sxs-lookup"><span data-stu-id="32926-184">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="32926-185">Следующая команда [Azure CLI][install-azure-cli] обновляет приоритет:</span><span class="sxs-lookup"><span data-stu-id="32926-185">The following [Azure CLI][install-azure-cli] command updates the priority:</span></span>

```bat
azure network traffic-manager  endpoint set --resource-group <resource-group> --profile-name <profile>
    --name <traffic-manager-name> --type AzureEndpoints --priority 3
```    

<span data-ttu-id="32926-186">Другой подход заключается во временном отключении конечной точки, пока не появится возможность восстановить размещение:</span><span class="sxs-lookup"><span data-stu-id="32926-186">Another approach is to temporarily disable the endpoint until you are ready to fail back:</span></span>

```bat
azure network traffic-manager  endpoint set --resource-group <resource-group> --profile-name <profile>
    --name <traffic-manager-name> --type AzureEndpoints --status Disabled
```    

<span data-ttu-id="32926-187">В зависимости от причины отработки отказа может потребоваться повторное развертывание ресурсов в пределах региона.</span><span class="sxs-lookup"><span data-stu-id="32926-187">Depending on the cause of a failover, you might need to redeploy the resources within a region.</span></span> <span data-ttu-id="32926-188">До восстановления размещения выполните тест готовности к работе.</span><span class="sxs-lookup"><span data-stu-id="32926-188">Before failing back, perform an operational readiness test.</span></span> <span data-ttu-id="32926-189">При этом проверяется следующее:</span><span class="sxs-lookup"><span data-stu-id="32926-189">The test should verify things like:</span></span>

* <span data-ttu-id="32926-190">правильная настройка виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="32926-190">VMs are configured correctly.</span></span> <span data-ttu-id="32926-191">(все необходимое программное обеспечение установлено, IIS выполняются и т. д.);</span><span class="sxs-lookup"><span data-stu-id="32926-191">(All required software is installed, IIS is running, and so on.)</span></span>
* <span data-ttu-id="32926-192">работоспособность подсистем приложения;</span><span class="sxs-lookup"><span data-stu-id="32926-192">Application subsystems are healthy.</span></span>
* <span data-ttu-id="32926-193">функциональное тестирование</span><span class="sxs-lookup"><span data-stu-id="32926-193">Functional testing.</span></span> <span data-ttu-id="32926-194">(например, доступен ли уровень базы данных с веб-уровня).</span><span class="sxs-lookup"><span data-stu-id="32926-194">(For example, the database tier is reachable from the web tier.)</span></span>

### <a name="cassandra-deployment-across-multiple-regions"></a><span data-ttu-id="32926-195">Развертывание Cassandra в нескольких регионах</span><span class="sxs-lookup"><span data-stu-id="32926-195">Cassandra deployment across multiple regions</span></span>

<span data-ttu-id="32926-196">Центры обработки данных Cassandra — это группа связанных узлов данных, которые настроены вместе внутри кластера для репликации и разделения рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="32926-196">Cassandra data centers are a group of related data nodes that are configured together within a cluster for replication and workload segregation.</span></span>

<span data-ttu-id="32926-197">Рекомендуем использовать [DataStax Enterprise][datastax] в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="32926-197">We recommend [DataStax Enterprise][datastax] for production use.</span></span> <span data-ttu-id="32926-198">Дополнительные сведения о запуске DataStax в Azure см. в [руководстве по развертыванию DataStax Enterprise для Azure][cassandra-in-azure].</span><span class="sxs-lookup"><span data-stu-id="32926-198">For more information on running DataStax in Azure, see [DataStax Enterprise Deployment Guide for Azure][cassandra-in-azure].</span></span> <span data-ttu-id="32926-199">Следующие общие рекомендации применимы к любой версии Cassandra:</span><span class="sxs-lookup"><span data-stu-id="32926-199">The following general recommendations apply to any Cassandra edition:</span></span> 

* <span data-ttu-id="32926-200">Присвойте общедоступный IP-адрес каждому узлу.</span><span class="sxs-lookup"><span data-stu-id="32926-200">Assign a public IP address to each node.</span></span> <span data-ttu-id="32926-201">Это позволяет кластерам обмениваться данными между регионами, используя магистральную инфраструктуру Azure, обеспечивающую высокую пропускную способность при низких затратах.</span><span class="sxs-lookup"><span data-stu-id="32926-201">This enables the clusters to communicate across regions using the Azure backbone infrastructure, providing high throughput at low cost.</span></span>
* <span data-ttu-id="32926-202">Защитите узлы с помощью соответствующих конфигураций брандмауэра и групп безопасности сети (NSG), разрешая трафик только от известных узлов, включая клиенты и другие узлы кластера.</span><span class="sxs-lookup"><span data-stu-id="32926-202">Secure nodes using the appropriate firewall and network security group (NSG) configurations, allowing traffic only to and from known hosts, including clients and other cluster nodes.</span></span> <span data-ttu-id="32926-203">Обратите внимание, что Cassandra использует разные порты для связи, например OpsCenter, Spark и т. д.</span><span class="sxs-lookup"><span data-stu-id="32926-203">Note that Cassandra uses different ports for communication, OpsCenter, Spark, and so forth.</span></span> <span data-ttu-id="32926-204">Сведения об использовании портов в Cassandra см. в статье [Configuring firewall port access][cassandra-ports] (Настройка портов доступа к брандмауэру).</span><span class="sxs-lookup"><span data-stu-id="32926-204">For port usage in Cassandra, see [Configuring firewall port access][cassandra-ports].</span></span>
* <span data-ttu-id="32926-205">Используйте шифрование SSL для обмена данными между [узлом и клиентом][ssl-client-node] и [между узлами][ssl-node-node].</span><span class="sxs-lookup"><span data-stu-id="32926-205">Use SSL encryption for all [client-to-node][ssl-client-node] and [node-to-node][ssl-node-node] communications.</span></span>
* <span data-ttu-id="32926-206">В рамках региона следуйте рекомендациям, изложенным в [этой статье](n-tier.md#cassandra).</span><span class="sxs-lookup"><span data-stu-id="32926-206">Within a region, follow the guidelines in [Cassandra recommendations](n-tier.md#cassandra).</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="32926-207">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="32926-207">Availability considerations</span></span>

<span data-ttu-id="32926-208">С помощью сложного n-уровневого приложения можно не реплицировать все приложение в дополнительном регионе.</span><span class="sxs-lookup"><span data-stu-id="32926-208">With a complex N-tier app, you may not need to replicate the entire application in the secondary region.</span></span> <span data-ttu-id="32926-209">Вместо этого вы можете просто реплицировать критическую подсистему, необходимую для обеспечения непрерывной работы бизнеса.</span><span class="sxs-lookup"><span data-stu-id="32926-209">Instead, you might just replicate a critical subsystem that is needed to support business continuity.</span></span>

<span data-ttu-id="32926-210">Диспетчер трафика — это точка возможного сбоя в системе.</span><span class="sxs-lookup"><span data-stu-id="32926-210">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="32926-211">Если происходит сбой диспетчера трафика, клиенты не смогут получить доступ к приложению во время простоя.</span><span class="sxs-lookup"><span data-stu-id="32926-211">If the Traffic Manager service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="32926-212">Просмотрите [соглашение об уровне обслуживания диспетчера трафика][tm-sla] и подумайте, достаточно ли диспетчера трафика в соответствии с требованиями к высокой доступности в вашей организации.</span><span class="sxs-lookup"><span data-stu-id="32926-212">Review the [Traffic Manager SLA][tm-sla], and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="32926-213">Если это не так, добавьте резервное решение для управления трафиком.</span><span class="sxs-lookup"><span data-stu-id="32926-213">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="32926-214">Если в службе диспетчера трафика Azure произошел сбой, измените записи CNAME в службе доменных имен, чтобы они указывали на резервную службу управления трафиком.</span><span class="sxs-lookup"><span data-stu-id="32926-214">If the Azure Traffic Manager service fails, change your CNAME records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="32926-215">(Этот шаг нужно выполнить вручную, приложение будет отключено, пока изменения DNS не распространятся.)</span><span class="sxs-lookup"><span data-stu-id="32926-215">(This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.)</span></span>

<span data-ttu-id="32926-216">Для кластера Cassandra сценарии отработки отказа зависят от уровней согласованности, используемых приложением, а также от количества используемых реплик.</span><span class="sxs-lookup"><span data-stu-id="32926-216">For the Cassandra cluster, the failover scenarios to consider depend on the consistency levels used by the application, as well as the number of replicas used.</span></span> <span data-ttu-id="32926-217">Сведения об уровнях согласованности и потреблении в Cassandra см. в статьях [Configuring firewall port access][cassandra-consistency] (Настройка портов доступа к брандмауэру) и [Cassandra: How many nodes are talked to with Quorum? Also should I use it?][cassandra-consistency-usage] (Cassandra. Сколько узлов обмениваются данными с кворумом и следует ли его использовать?).</span><span class="sxs-lookup"><span data-stu-id="32926-217">For consistency levels and usage in Cassandra, see [Configuring data consistency][cassandra-consistency] and [Cassandra: How many nodes are talked to with Quorum?][cassandra-consistency-usage]</span></span> <span data-ttu-id="32926-218">Доступность данных в Cassandra определяется уровнем согласованности, используемым приложением, и механизмом репликации.</span><span class="sxs-lookup"><span data-stu-id="32926-218">Data availability in Cassandra is determined by the consistency level used by the application and the replication mechanism.</span></span> <span data-ttu-id="32926-219">Сведения о репликации в Cassandra см. в статье [Data Replication in NoSQL Databases Explained][cassandra-replication] (Описание репликации данных в базах данных NoSQL).</span><span class="sxs-lookup"><span data-stu-id="32926-219">For replication in Cassandra, see [Data Replication in NoSQL Databases Explained][cassandra-replication].</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="32926-220">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="32926-220">Manageability considerations</span></span>

<span data-ttu-id="32926-221">При обновлении развертывания обновляйте один регион за раз, чтобы уменьшить вероятность глобального сбоя из-за неправильной конфигурации или ошибки в приложении.</span><span class="sxs-lookup"><span data-stu-id="32926-221">When you update your deployment, update one region at a time to reduce the chance of a global failure from an incorrect configuration or an error in the application.</span></span>

<span data-ttu-id="32926-222">Проверьте устойчивость системы к сбоям.</span><span class="sxs-lookup"><span data-stu-id="32926-222">Test the resiliency of the system to failures.</span></span> <span data-ttu-id="32926-223">Ниже приведены некоторые распространенные сценарии сбоев для тестирования:</span><span class="sxs-lookup"><span data-stu-id="32926-223">Here are some common failure scenarios to test:</span></span>

* <span data-ttu-id="32926-224">завершение работы экземпляров виртуальной машины;</span><span class="sxs-lookup"><span data-stu-id="32926-224">Shut down VM instances.</span></span>
* <span data-ttu-id="32926-225">нехватка ресурсов, таких как ЦП и память;</span><span class="sxs-lookup"><span data-stu-id="32926-225">Pressure resources such as CPU and memory.</span></span>
* <span data-ttu-id="32926-226">отключение или задержка сети;</span><span class="sxs-lookup"><span data-stu-id="32926-226">Disconnect/delay network.</span></span>
* <span data-ttu-id="32926-227">прекращение работы процессов;</span><span class="sxs-lookup"><span data-stu-id="32926-227">Crash processes.</span></span>
* <span data-ttu-id="32926-228">завершение срока действия сертификатов;</span><span class="sxs-lookup"><span data-stu-id="32926-228">Expire certificates.</span></span>
* <span data-ttu-id="32926-229">моделирование сбоев оборудования;</span><span class="sxs-lookup"><span data-stu-id="32926-229">Simulate hardware faults.</span></span>
* <span data-ttu-id="32926-230">завершение работы службы DNS на контроллерах домена.</span><span class="sxs-lookup"><span data-stu-id="32926-230">Shut down the DNS service on the domain controllers.</span></span>

<span data-ttu-id="32926-231">Измерьте время восстановления и убедитесь, что оно соответствует вашим бизнес-требованиям.</span><span class="sxs-lookup"><span data-stu-id="32926-231">Measure the recovery times and verify they meet your business requirements.</span></span> <span data-ttu-id="32926-232">Следует также протестировать комбинации режимов отказа.</span><span class="sxs-lookup"><span data-stu-id="32926-232">Test combinations of failure modes, as well.</span></span>


<!-- Links -->
[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[cassandra-in-azure]: https://academy.datastax.com/resources/deployment-guide-azure
[cassandra-consistency]: http://docs.datastax.com/en/cassandra/2.0/cassandra/dml/dml_config_consistency_c.html
[cassandra-replication]: http://www.planetcassandra.org/data-replication-in-nosql-databases-explained/
[cassandra-consistency-usage]: https://medium.com/@foundev/cassandra-how-many-nodes-are-talked-to-with-quorum-also-should-i-use-it-98074e75d7d5#.b4pb4alb2
[cassandra-ports]: https://docs.datastax.com/en/datastax_enterprise/5.0/datastax_enterprise/sec/configFirewallPorts.html
[datastax]: https://www.datastax.com/products/datastax-enterprise
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[install-azure-cli]: /azure/xplat-cli-install
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[services-by-region]: https://azure.microsoft.com/regions/#services
[ssl-client-node]: http://docs.datastax.com/en/cassandra/2.0/cassandra/security/secureSSLClientToNode_t.html
[ssl-node-node]: http://docs.datastax.com/en/cassandra/2.0/cassandra/security/secureSSLNodeToNode_t.html
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager/v1_0/
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager/
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx
[0]: ./images/multi-region-application-diagram.png "Высокодоступная сетевая архитектура для n-уровневых приложений Azure"
