---
title: "Запуск виртуальных машин Linux для n-уровневого приложения в Azure"
description: "Как запустить виртуальные машины Linux в n-уровневой архитектуре в Microsoft Azure."
author: MikeWasson
ms.date: 11/22/2016
pnp.series.title: Linux VM workloads
pnp.series.next: multi-region-application
pnp.series.prev: multi-vm
ms.openlocfilehash: 673e090e306ffc421603371658c8273b10b980d4
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="run-linux-vms-for-an-n-tier-application"></a>Запуск виртуальных машин Linux для n-уровневого приложения

В этой эталонной архитектуре показан набор методик по запуску виртуальных машин Linux для n-уровневого приложения. [**Разверните это решение**.](#deploy-the-solution)  

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура

Существует много способов реализовать n-уровневую архитектуру. На диаграмме показано стандартное трехуровневое веб-приложение. Эта архитектура создана на основе архитектуры из статьи [Запуск виртуальных машин с балансировкой нагрузки для обеспечения масштабируемости и доступности][multi-vm]. На веб- и бизнес-уровнях используются виртуальные машины с балансировкой нагрузки.

* **Группы доступности.** Создайте [группу доступности][azure-availability-sets] для каждого уровня и подготовьте по крайней мере две виртуальные машины для каждого уровня.  Таким образом виртуальные машины станут подходящими для [соглашения об уровне обслуживания (SLA)][vm-sla] более высокого уровня для виртуальных машин.
* **Подсети.** Создайте отдельные подсети для каждого уровня. Укажите диапазон адресов и маску подсети с помощью нотации [CIDR]. 
* **Подсистемы балансировки нагрузки.** [Подсистема балансировки нагрузки с доступом к Интернету][load-balancer-external] передает входящий интернет-трафик на веб-уровень, а [внутренняя подсистема балансировки нагрузки][load-balancer-internal] передает сетевой трафик из веб-уровня на бизнес-уровень.
* **Jumpbox.** Он также называется [узлом-бастионом]. Безопасная виртуальная машина в сети, которую администраторы используют для подключения к другим виртуальным машинам. В jumpbox есть NSG, обеспечивающая удаленный трафик только из общедоступных IP-адресов из списка надежных отправителей. NSG должна пропускать трафик Secure Shell (SSH).
* **Мониторинг.** Программное обеспечение для мониторинга, например [Nagios], [Zabbix] или [Icinga], позволяет получить глубокое представление о времени отклика, времени доступности виртуальной машины и общей работоспособности вашей системы. Установите программное обеспечение для мониторинга на виртуальной машине, которая размещена в отдельной подсети управления.
* **Группы безопасности сети.** [Группы безопасности сети][nsg] (NSG) позволяют ограничить сетевой трафик в виртуальной сети. Например, в приведенной здесь трехуровневой архитектуре уровень базы данных не принимает трафик из веб-интерфейса, а только с бизнес-уровня и подсети управления.
* **База данных Apache Cassandra.** Обеспечивает высокий уровень доступности на уровне данных, включив репликацию и отработку отказа.

## <a name="recommendations"></a>Рекомендации

Требования могут отличаться от архитектуры, описанной здесь. Воспользуйтесь этими рекомендациями в качестве отправной точки. 

### <a name="vnet--subnets"></a>Виртуальная сеть и подсети

При создании виртуальной сети определите, сколько IP-адресов требуется для ресурсов в каждой подсети. Укажите маску подсети и достаточно большой диапазон адресов виртуальной сети для требуемых IP-адресов с помощью нотации [CIDR]. Используйте адресное пространство, которое входит в диапазон стандартных [блоков частных IP-адресов][private-ip-space], например 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Выберите диапазон адресов, который не перекрывает локальную сеть, если вам нужно позже настроить шлюз между виртуальной сетью и локальной сетью. Создав виртуальную сеть, изменить диапазон адресов нельзя.

Проектируйте подсети с учетом требований к функциональности и безопасности. Все виртуальные машины в пределах одного уровня или одной роли должны входить в одну и ту же подсеть, которая может быть надежным периметром безопасности. Дополнительные сведения о проектировании виртуальных сетей и подсетей см. в статье [Планирование и проектирование виртуальных сетей Azure][plan-network].

Для каждой подсети укажите адресное пространство подсети в нотации CIDR. Например, 10.0.0.0/24 создает диапазон из 256 IP-адресов. Виртуальные машины могут использовать 251 из них (пять зарезервированы). Убедитесь, что диапазоны адресов не перекрываются между подсетями. Ознакомьтесь со статьей [Виртуальная сеть Azure: часто задаваемые вопросы][vnet faq].

### <a name="network-security-groups"></a>Группы безопасности сети

С помощью правил NSG можно ограничить трафик между уровнями. Например, в показанной выше трехуровневой архитектуре веб-уровень не взаимодействует напрямую с уровнем базы данных. Чтобы обеспечить эту возможность, уровень базы данных должен блокировать входящий трафик из подсети веб-уровня.  

1. Создайте NSG и свяжите ее с подсетью уровня базы данных.
2. Добавьте правило, которое запрещает весь входящий трафик от виртуальной сети. (В правиле используйте тег `VIRTUAL_NETWORK`.) 
3. Добавьте правило с более высоким приоритетом, которое разрешает входящий трафик из подсети бизнес-уровня. Это правило переопределяет предыдущее и позволяет бизнес-уровню взаимодействовать с уровнем базы данных.
4. Добавьте правило, которое разрешает входящий трафик из самой подсети уровня базы данных. Это правило обеспечивает взаимодействие между виртуальными машинами на уровне базы данных, которое необходимо для репликации и отработки отказа базы данных.
5. Добавьте правило, которое разрешает трафик SSH из подсети jumpbox. Это правило позволяет администраторам подключаться к уровню базы данных из jumpbox.
   
   > [!NOTE]
   > NSG имеет [стандартные правила][nsg-rules], которые разрешают любой входящий трафик из виртуальной сети. Эти правила нельзя удалить, однако их можно переопределить, создав правила с более высоким приоритетом.
   > 
   > 

### <a name="load-balancers"></a>Балансировщики нагрузки

Внешняя подсистема балансировки нагрузки передает трафик Интернета на веб-уровень. Создайте общедоступный IP-адрес для этой подсистемы балансировки нагрузки. Ознакомьтесь со статьей [Создание балансировщика нагрузки для Интернета на портале Azure][lb-external-create].

Внутренняя подсистема балансировки нагрузки передает сетевой трафик с веб-уровня на бизнес-уровень. Чтобы предоставить этой системе балансировки нагрузки частный IP-адрес, создайте внешнюю IP-конфигурацию и свяжите ее с подсетью для бизнес-уровня. Ознакомьтесь со статьей [Создание подсистемы балансировки нагрузки на портале Azure][lb-internal-create].

### <a name="cassandra"></a>Cassandra

Для производственных целей мы рекомендуем использовать [DataStax Enterprise][datastax]. Эти рекомендации применимы для каждого выпуска Cassandra. Дополнительные сведения о запуске DataStax в Azure см. в [руководстве по развертыванию DataStax Enterprise для Azure][cassandra-in-azure]. 

Поместите виртуальные машины для кластера Cassandra в группе доступности, чтобы обеспечить распределение реплик между несколькими доменами сбоя и обновления. Дополнительные сведения о доменах сбоя и обновления см. в статье [Управление доступностью виртуальных машин Linux][azure-availability-sets]. 

Для одной группы доступности настройте эти три домена сбоя (максимальное количество) и 18 доменов обновления. Это обеспечивает максимальное количество доменов обновления, которые можно равномерно распределить между доменами сбоя.   

Настройте узлы в режиме с поддержкой стоек. Сопоставьте домены сбоя со стойками в файле `cassandra-rackdc.properties`.

Вам не потребуется подсистема балансировки нагрузки для кластера. Клиент подключается напрямую к узлу в кластере.

### <a name="jumpbox"></a>Jumpbox

jumpbox будет иметь минимальные требования к производительности, поэтому выберите небольшой размер виртуальной машины для jumpbox, например Standard A1. 

Создайте [общедоступный IP-адрес] для jumpbox. Поместите jumpbox в виртуальную сеть вместе с другими виртуальными машинами, однако в отдельную подсеть управления.

Запретите доступ по протоколу SSH из общедоступного Интернета в виртуальные машины, которые выполняют рабочую нагрузку приложения. Вместо этого все доступы по протоколу SSH к этим виртуальным машинам должны проходить через jumpbox. Администратор выполняет вход в jumpbox, а затем вход в другую виртуальную машину из jumpbox. jumpbox разрешает SSH трафик из Интернета, однако только из известных и безопасных IP-адресов.

Чтобы защитить jumpbox, создайте NSG и примените ее к подсети jumpbox. Добавьте правило NSG, разрешающее подключения по протоколу SSH только из безопасного набора общедоступных IP-адресов. NSG можно подключить к подсети или сетевому адаптеру jumpbox. В этом случае рекомендуется подключить ее к сетевому адаптеру, чтобы трафик SSH разрешался только для jumpbox, даже если вы добавили другие виртуальные машины в ту же подсеть.

Настройте NSG для других подсетей, чтобы разрешить трафик SSH из подсети управления.

## <a name="availability-considerations"></a>Вопросы доступности

Поместите каждый уровень или роль виртуальной машины в отдельную группу доступности. 

Использование нескольких виртуальных машин на уровне базы данных не приводит автоматически к высокой доступности базы данных. Для реляционной базы данных обычно требуется выполнить репликацию и отработку отказа, чтобы обеспечить высокий уровень доступности.  

Если требуется более высокий уровень доступности, чем обеспечивает [соглашение об уровне обслуживания Azure для виртуальных машин][vm-sla], реплицируйте приложение в два региона и используйте диспетчер трафика Azure для отработки отказа. Дополнительные сведения см. в статье [Запуск виртуальных машин Linux в нескольких регионах для обеспечения высокой доступности][multi-dc].  

## <a name="security-considerations"></a>Вопросы безопасности

Попробуйте добавить сетевой виртуальный модуль (NVA), чтобы создать сеть периметра между общедоступным Интернетом и виртуальною сетью Azure. Сетевой виртуальный модуль — это универсальный термин для виртуального модуля, который может выполнять сетевые задачи, например брандмауэра, проверки пакетов, аудита и пользовательской маршрутизации. Дополнительные сведения см. в статье [Сеть периметра между Azure и Интернетом][dmz].

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Подсистемы балансировки нагрузки передают сетевой трафик на веб- и бизнес-уровни. Выполните горизонтальное масштабирование, добавив новые экземпляры виртуальной машины. Обратите внимание, что можно масштабировать веб- и бизнес-уровни независимо друг от друга в зависимости от нагрузки. Чтобы снизить уровень усложнений, которые могут возникать из-за необходимости использовать привязку клиента, виртуальные машины на веб-уровне должны быть без отслеживания состояния. Виртуальные машины, на которых размещена бизнес-логика, также должны быть без отслеживания состояния.

## <a name="manageability-considerations"></a>Вопросы управляемости

Упростите управление всей системой, используя централизованные инструменты администрирования, например [службу автоматизации Azure][azure-administration], [Microsoft Operations Management Suite][operations-management-suite], [Chef][chef] или [Puppet][puppet]. Эти инструменты могут консолидировать сведения о диагностике и работоспособности, собранные из нескольких виртуальных машин, чтобы обеспечить полное представление системы.

## <a name="deploy-the-solution"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder]. Архитектура развертывается в три этапа. Чтобы развернуть эту архитектуру, выполните следующие действия. 

1. Нажмите кнопку ниже:<br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fvirtual-machines%2Fn-tier-linux%2Fazuredeploy.json" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>
2. Ссылка откроется на портале Azure, где нужно задать следующие значения. 
   * Имя **группы ресурсов** уже определено в файле параметров, поэтому выберите **Создать** и введите `ra-ntier-cassandra-rg` в текстовом поле.
   * В раскрывающемся списке **Расположение** выберите регион.
   * Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).
   * Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.
   * Нажмите кнопку **Приобрести**.
3. Проверьте уведомления с портала Azure на наличие сообщения о том, что развертывание завершено.
4. В файлах параметров содержится жестко заданное имя пользователя с ролью администратора и пароль. Мы настоятельно рекомендуем немедленно изменить эти параметры на всех виртуальных машинах. Щелкните каждую виртуальную машину на портале Azure и выберите **Сброс пароля** в колонке **Поддержка и устранение неполадок**. В раскрывающемся списке **Режим** выберите **Сбросить пароль** и введите новое **имя пользователя** и **пароль**. Нажмите кнопку **Обновить**, чтобы сохранить новое имя пользователя и пароль.

<!-- links -->
[multi-dc]: multi-region-application.md
[dmz]: ../dmz/secure-vnet-dmz.md
[multi-vm]: ./multi-vm.md
[naming conventions]: /azure/guidance/guidance-naming-conventions

[azure-administration]: /azure/automation/automation-intro
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-linux-manage-availability
[узлом-бастионом]: https://en.wikipedia.org/wiki/Bastion_host
[cassandra-in-azure]: https://docs.datastax.com/en/datastax_enterprise/4.5/datastax_enterprise/install/installAzure.html
[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[chef]: https://www.chef.io/solutions/azure/
[datastax]: http://www.datastax.com/products/datastax-enterprise
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-linux
[lb-external-create]: /azure/load-balancer/load-balancer-get-started-internet-portal
[lb-internal-create]: /azure/load-balancer/load-balancer-get-started-ilb-arm-portal
[load-balancer-external]: /azure/load-balancer/load-balancer-internet-overview
[load-balancer-internal]: /azure/load-balancer/load-balancer-internal-overview
[nsg]: /azure/virtual-network/virtual-networks-nsg
[nsg-rules]: /azure/azure-resource-manager/best-practices-resource-manager-security#network-security-groups
[operations-management-suite]: https://www.microsoft.com/server-cloud/operations-management-suite/overview.aspx
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[общедоступный IP-адрес]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[puppet]: https://puppetlabs.com/blog/managing-azure-virtual-machines-puppet
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vnet faq]: /azure/virtual-network/virtual-networks-faq
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[Nagios]: https://www.nagios.org/
[Zabbix]: http://www.zabbix.com/
[Icinga]: http://www.icinga.org/
[0]: ./images/n-tier-diagram.png "N-уровневая архитектура с использованием Microsoft Azure"

