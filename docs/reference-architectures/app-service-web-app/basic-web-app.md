---
title: Базовое веб-приложение
description: Рекомендуемые архитектуры для базовых веб-приложений, работающих в Microsoft Azure.
author: MikeWasson
ms.date: 12/12/2017
cardTitle: Basic web application
ms.openlocfilehash: bc8cf9b5c66fc451d097cbc992ecb9a249645dce
ms.sourcegitcommit: e9d9e214529edd0dc78df5bda29615b8fafd0e56
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2018
ms.locfileid: "37091127"
---
# <a name="basic-web-application"></a>Базовое веб-приложение
[!INCLUDE [header](../../_includes/header.md)]

Эталонная архитектура демонстрирует набор проверенных методов для создания веб-приложения, в котором используются [служба приложений Azure][app-service] и служба [База данных SQL Azure][sql-db]. [**Разверните это решение**.](#deploy-the-solution)

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура 

> [!NOTE]
> Эта архитектура не предназначена для разработки приложений и не требует использования какой-либо конкретной исполняющей среды. Она просто помогает разобраться в том, как разные службы Azure работают вместе.
>
>

Архитектура состоит из следующих компонентов.

* **Группа ресурсов**. [Группа ресурсов](/azure/azure-resource-manager/resource-group-overview) — это логический контейнер для ресурсов Azure.

* **Приложение службы приложений.** [Служба приложений Azure][app-service] — это полностью управляемая платформа для создания и развертывания облачных приложений.     

* **План службы приложений.** [План служб приложений][app-service-plans] предоставляет управляемые виртуальные машины для размещения приложения. Все приложения, связанные с одним планом, выполняются на одних тех же экземплярах виртуальной машины.

* **Слоты развертывания.**  [Слот развертывания][deployment-slots] позволяет заранее подготовить развертывание, а затем переключить его на рабочую среду. Это дает возможность избежать развертываний непосредственно в рабочей среде. В разделе об [управляемости](#manageability-considerations) приводится несколько конкретных рекомендаций.

* **IP-адрес.** Для приложения службы приложений используется общедоступный IP-адрес и доменное имя. К доменному имени добавляется имя поддомена `azurewebsites.net`, например: `contoso.azurewebsites.net`.  

* **Azure DNS**. [Azure DNS][azure-dns] — это служба размещения для доменов DNS, которая предоставляет разрешение имен с помощью инфраструктуры Microsoft Azure. Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure. Чтобы использовать пользовательское доменное имя, например `contoso.com`, создайте записи DNS, которые позволяют сопоставить это доменное имя с IP-адресом. Дополнительные сведения см. в статье [Сопоставление существующего настраиваемого DNS-имени с веб-приложениями Azure][custom-domain-name].  

* **База данных SQL Azure**. Служба [База данных SQL Azure][sql-db] — это реляционная база данных, которая предоставляется как облачная служба. База данных SQL использует свою базу кода совместно с ядром СУБД Microsoft SQL Server. В зависимости от требований приложения можно также использовать службу [База данных Azure для MySQL](/azure/mysql) или [База данных Azure для PostgreSQL](/azure/postgresql). Это полностью управляемые службы баз данных, основанные на ядрах СУБД с открытым исходным кодом MySQL и Postgres соответственно.

* **Логический сервер.** На логическом сервере в службе "База данных SQL Azure" размещаются базы данных. Вы можете создать несколько баз данных на одном логическом сервере.

* **Хранилище Azure.** Создайте учетную запись хранения Azure и в ней — контейнер больших двоичных объектов для хранения журналов диагностики.

* **Azure Active Directory** (Azure AD). Выполняйте аутентификацию при помощи Azure AD или другого поставщика удостоверений.

## <a name="recommendations"></a>Рекомендации

Описанная здесь архитектура может не соответствовать вашим требованиям. Используйте рекомендации из этого раздела в качестве отправной точки.

### <a name="app-service-plan"></a>План службы приложений
Используйте уровни "Стандартный" или "Премиум", которые поддерживают масштабирование, автомасштабирование и протокол SSL. Каждый уровень поддерживает несколько *размеров экземпляров*, которые отличаются количеством ядер и объемом памяти. После создания плана можно изменить его уровень или размер экземпляров. Дополнительные сведения см. на странице с [ценами на службу приложений][app-service-plans-tiers].

Плата взимается за все экземпляры в плане службы приложений, даже если приложение остановлено. Обязательно удаляйте планы, которые более не используются (например, тестовые развертывания).

### <a name="sql-database"></a>База данных SQL
Используйте службу "База данных SQL" [версии 12][sql-db-v12]. Служба "База данных SQL" поддерживает [уровни службы][sql-db-service-tiers] "Базовый", "Стандартный" или "Премиум", а также несколько уровней производительности для каждого из них, которые измеряются в [единицах передачи данных (DTU)][sql-dtu]. Оцените потребности в производительности и выберите подходящие уровни базы данных и производительности.

### <a name="region"></a>Регион
Создайте план службы приложений и базу данных SQL в одном регионе, чтобы минимизировать задержки в сети. Обычно лучше выбирать регион, ближайший к пользователям приложения.

Группа ресурсов также привязана к региону, в котором хранятся метаданные развертывания. Поместите группу ресурсов и все ее ресурсы в один регион. Это повысит доступность во время развертывания. 

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Главным преимуществом службы приложений Azure является возможность масштабировать приложение с учетом нагрузки. Ниже приведены некоторые рекомендации, которые следует учитывать, если вы планируете масштабировать приложение.

### <a name="scaling-the-app-service-app"></a>Масштабирование приложения в службе приложений

Есть два способа масштабировать приложение службы приложений:

* *Вертикальное масштабирование*, что означает изменение размера экземпляра. Размер определяет доступный объем памяти, хранилища и количество ядер для каждого экземпляра виртуальной машины. Вертикальное масштабирование выполняется вручную путем изменения размера экземпляров или уровня плана.  

* *Горизонтальное масштабирование*, что означает добавление экземпляров при повышении нагрузки. В каждой ценовой категории есть ограничение на число экземпляров. 

  Горизонтальное масштабирование можно выполнять вручную, изменяя число экземпляров, или с помощью функции [автомасштабирования][web-app-autoscale]. Эта функция позволяет автоматически добавлять или удалять экземпляры в Azure по заданному расписанию и (или) метрикам производительности. Операции масштабирования выполняются достаточно быстро, обычно за несколько секунд. 

  Чтобы включить функцию автомасштабирования, создайте *профиль* автомасштабирования, в котором указано минимальное и максимальное число экземпляров. Для профилей можно применить расписания. Например, вы можете создать отдельные профили для будних и выходных дней. Также профиль может содержать правила добавления или удаления экземпляров. (Например: добавлять два экземпляра, если в течение 5 минут загрузка ЦП превышает 70 %.)
  
Рекомендации по масштабированию веб-приложения:

* По возможности избегайте вертикального масштабирования, при котором часто происходит перезапуск приложения. Вместо этого выберите уровень и размер экземпляров, которые соответствуют требованиям к производительности при типичной нагрузке, а затем используйте горизонтальное масштабирование, чтобы изменить число экземпляров в соответствии с объемом трафика.    
* Примените функцию автомасштабирования. Если объем рабочей нагрузки для вашего приложения стабилен и прогнозируем, создайте профили и расписание для своевременного добавления экземпляров. Если рабочая нагрузка плохо прогнозируется, используйте автомасштабирование на основе правил, чтобы оперативно реагировать на изменения нагрузки. Можно использовать оба подхода одновременно.
* Обычно в качестве метрики для правил автомасштабирования хорошо подходит загрузка ЦП. Но мы рекомендуем провести нагрузочный тест для приложения, определить потенциальные узкие места и в соответствии с ними создать правила автомасштабирования.  
* Правила автомасштабирования охватывают *период ожидания* после очередного действия, в течение которого новые действия масштабирования не выполняются. Период ожидания позволяет стабилизировать систему перед новым масштабированием. Применяйте более короткий период ожидания для добавления экземпляров и более длительный — для их удаления. Например, 5 минут при добавлении экземпляра и 60 минут при его удалении. При значительной нагрузке можно быстро добавить сразу несколько экземпляров для ускоренной обработки трафика, а затем постепенно уменьшать их количество.

### <a name="scaling-sql-database"></a>База данных SQL Azure
Если вам нужен более высокий уровень службы или производительности для базы данных SQL, вы можете масштабировать отдельные базы данных без простоя приложения. Дополнительные сведения см. в статье о [возможностях, производительности и особенностях уровней службы "База данных SQL"][sql-db-scale].

## <a name="availability-considerations"></a>Вопросы доступности
На момент написания статьи для службы приложений действует соглашение об уровне обслуживания с доступностью 99,95 %, а для службы "База данных SQL" — с доступностью 99,99 % для уровней "Базовый", "Стандартный" и "Премиум". 

> [!NOTE]
> Соглашения об уровне обслуживания в службе приложений действуют как для одного, так и для нескольких экземпляров.  
>
>

### <a name="backups"></a>Резервные копии
В случае потери данных служба "База данных SQL" обеспечивает восстановление до точки во времени и геовосстановление. Эти функции доступны на всех уровнях и включаются автоматически. Нет необходимости настраивать расписание или параметры резервного копирования. 

- Используйте восстановление до точки во времени, чтобы [исправить ошибку оператора][sql-human-error]. При этом база данных возвращается к состоянию, в котором она находилась в определенный момент в прошлом. 
- Геовосстановление позволяет [восстановить данные после отключения служб][sql-outage-recovery], развертывая базу данных из геоизбыточной резервной копии. 

Дополнительные сведения см. в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure][sql-backup].

Служба приложений предоставляет возможность [резервного копирования и восстановления][web-app-backup] файлов приложения. Однако учтите, что резервные копии создаются в том числе для файлов с параметрами в виде простого текста, где могут содержаться секретные данные, например строки соединения. Старайтесь не использовать функцию резервного копирования службы приложений для баз данных SQL, так как при этом база данных SQL экспортируется в BACPAC-файл и на это расходуются единицы [DTU][sql-dtu]. Вместо этого применяйте описанную выше функцию для восстановления базы данных SQL до точки во времени.

## <a name="manageability-considerations"></a>Вопросы управляемости
Создайте отдельные группы ресурсов для рабочей среды, сред разработки и тестирования. Так будет проще управлять развертыванием, удалять тестовые развертывания и назначать права доступа.

При назначении ресурсов в группы ресурсов учитывайте следующие факторы:

* Жизненный цикл. Обычно в группу ресурсов лучше объединять ресурсы с одинаковым жизненным циклом.
* Доступ. С помощью [управления доступом на основе ролей][rbac] (RBAC) вы можете применить политики доступа к ресурсам в группе.
* Выставление счетов. Вы сможете просматривать сведенные затраты для группы ресурсов.  

Дополнительные сведения см. в [обзоре Azure Resource Manager](/azure/azure-resource-manager/resource-group-overview).

### <a name="deployment"></a>Развертывание
Развертывание состоит из двух этапов.

1. Подготовка ресурсов Azure. Для выполнения этого шага мы рекомендуем использовать [шаблоны Azure Resource Manager][arm-template]. Шаблоны облегчают автоматическое развертывание с помощью PowerShell или интерфейса командной строки Azure.
2. Развертывание приложения (код, двоичные файлы и файлы содержимого). Здесь у вас есть несколько вариантов, в том числе: развертывание из локального репозитория Git, с помощью Visual Studio или непрерывное развертывание из системы управления версиями в облаке. Дополнительные сведения см. в статье о [развертывании приложения в службе приложений Azure][deploy].  

В приложении службы приложений всегда есть один слот развертывания с именем `production`, который представляет действующий сайт в рабочей среде. Мы рекомендуем создать еще и промежуточный слот для развертывания обновлений. Промежуточный слот предоставит следующие преимущества:

* Вы можете проверить успешность развертывания, прежде чем перемещать его в рабочую среду.
* Развертывание в промежуточный слот гарантирует, что все экземпляры будут подготовлены перед перемещением в рабочую среду. Для многих приложений довольно долго выполняются начальная загрузка и "холодный" запуск.

Рекомендуем создать третий слот, в котором будет развернута последняя удачная версия приложения. После переключения с промежуточного слота на рабочий переместите в слот последней удачной версии предыдущее рабочее развертывание (которое теперь стало промежуточным). Теперь, если позже обнаружится проблема, вы сможете быстро вернуться к последней удачной версии.

![[1]][1]

Если потребуется вернуться к предыдущей версии, убедитесь, что все изменения схемы базы данных имеют обратную совместимость.

Не используйте слоты рабочего развертывания для тестирования, так как для всех приложений в одном плане службы приложений используются одни и те же экземпляры виртуальных машин. Например, нагрузочные тесты могут привести к ухудшению производительности активного рабочего сайта. Вместо этого создайте дополнительные планы службы приложений для рабочей и тестовой сред. Поместив тестовые развертывания в отдельный план, можно изолировать их от рабочей версии.

### <a name="configuration"></a>Параметр Configuration
Сохраняйте конфигурацию в виде [настроек приложений][app-settings]. Определите параметры приложения в шаблонах Resource Manager или с помощью PowerShell. В среде выполнения параметры приложений доступны из приложения как переменные среды.

Ни в коем случае не помещайте пароли, ключи доступа или строки подключения в систему управления версиями. Вместо этого передавайте их в качестве параметров в скрипт развертывания, где эти значения сохранятся как параметры приложения.

При переключении слотов развертывания по умолчанию заменяются и параметры приложения. Если вам нужно использовать для рабочего и промежуточного слотов разные параметры, создайте набор параметров и прикрепите его к слоту, чтобы они не изменялись при переключении слотов.

### <a name="diagnostics-and-monitoring"></a>Диагностика и мониторинг
Включите [ведение журнала диагностики][diagnostic-logs], в частности для приложения и веб-сервера. Настройте ведение журнала таким образом, чтобы он сохранялся в хранилище BLOB-объектов. Для повышения производительности создайте отдельную учетную запись хранения для журналов диагностики. Не используйте одну учетную запись хранения для журналов и данных приложения. Более подробные инструкции по ведению журналов см. в [руководстве по мониторингу и диагностике][monitoring-guidance].

Используйте службу [New Relic][new-relic] или [Application Insights][app-insights], чтобы контролировать производительность и поведение загруженных приложений. Не забывайте об [ограничениях на скорость передачи данных][app-insights-data-rate] в Application Insights.

Выполните нагрузочное тестирование с использованием специального средства, например [Visual Studio Team Services][vsts]. Общее описание анализа производительности в облачных приложениях вы найдете в [руководстве по анализу производительности для начинающих][perf-analysis].

Советы по устранению неполадок в приложениях.

* Используйте [колонку устранения неполадок][troubleshoot-blade] на портале Azure, чтобы найти решения для распространенных проблем.
* Включите [потоковую передачу журналов][web-app-log-stream], чтобы получать данные из журналов практически в режиме реального времени.
* [Панель мониторинга Kudu][kudu] предоставляет несколько средств для мониторинга и отладки приложения. Дополнительные сведения см. в статье [Azure Websites online tools you should know about][kudu] (Интерактивные инструменты веб-сайтов Azure, о которых вам нужно знать). Панель мониторинга Kudu можно открыть на портале Azure. Для этого откройте колонку приложения и щелкните <strong>Средства</strong>, затем выберите <strong>Kudu</strong>.
* Если вы используете Visual Studio, изучите статью [Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio][troubleshoot-web-app], в которой предлагаются советы по отладке и устранению неполадок.

## <a name="security-considerations"></a>Вопросы безопасности
В этом разделе перечислены рекомендации по безопасности, относящиеся к службам Azure, описанным в этой статье. Это не полный список рекомендаций по обеспечению безопасности. Дополнительные рекомендации см. в статье [Проверка подлинности и авторизация в службе приложений Azure][app-service-security].

### <a name="sql-database-auditing"></a>аудит баз данных SQL;
Аудит поможет вам обеспечить соответствие нормативным требованиям и получать важные сведения об отклонениях и аномалиях, которые могут указывать на бизнес-проблемы или потенциальные нарушения безопасности. См. статью [Приступая к работе с аудитом базы данных SQL][sql-audit].

### <a name="deployment-slots"></a>Слоты развертывания
Каждый слот развертывания имеет общедоступный IP-адрес. Слоты, не используемые в рабочей среде, следует защитить с помощью [входа в Azure Active Directory][aad-auth], чтобы доступ к этим конечным точкам могли получить только члены команд разработки и DevOps.

### <a name="logging"></a>Ведение журналов
Ни в коем случае не сохраняйте в журналы такую информацию, как пароли пользователей или другие сведения, которые могут использовать мошенники. Перед сохранением данных удалите такие сведения.   

### <a name="ssl"></a>SSL
Приложение службы приложений бесплатно получает одну конечную точку SSL в поддомене `azurewebsites.net`. Конечная точка SSL содержит групповой сертификат для доменного имени `*.azurewebsites.net`. Чтобы применить пользовательское доменное имя, самостоятельно предоставьте для него сертификат. Для этого проще всего приобрести сертификат непосредственно на портале Azure. Также вы можете импортировать сертификаты других центров сертификации. Дополнительные сведения см. в статье [Приобретение и настройка сертификата SSL для службы приложений Azure][ssl-cert].

Из соображений безопасности следует принудительно применять в приложении протокол HTTPS, перенаправляя все HTTP-запросы. Такое перенаправление можно реализовать в самом приложении или с помощью правила подстановки URL-адресов, как описано в разделе [Принудительное использование HTTPS][ssl-redirect].

### <a name="authentication"></a>Authentication
Мы рекомендуем выполнять аутентификацию при помощи поставщика удостоверений, например Azure AD, Facebook, Google или Twitter. Используйте в потоке аутентификации маркеры OAuth 2 или OpenID Connect (OIDC). Azure AD предоставляет функциональные возможности для управления пользователями и группами, создания ролей приложений, интеграции локальных служб идентификации и подключения серверных служб, например Office 365 и Skype для бизнеса.

Избегайте прямого управления учетными данными в приложении, так как это может повысить уязвимость.  Если вам необходим такой подход, реализуйте по меньшей мере подтверждение по электронной почте, восстановление паролей и многофакторную проверку подлинности, а также проверяйте надежность паролей и храните только их хэши. Крупные поставщики удостоверений берут на себя заботу обо всех этих компонентах, постоянно контролируют и улучшают все меры по обеспечению безопасности.

Чтобы реализовать поток аутентификации с использованием OAuth или OIDC, рекомендуем применить [аутентификацию службы приложений][app-service-auth]. Аутентификация службы приложений дает следующие преимущества:

* Простота настройки.
* Вам не нужно писать код для сценариев аутентификации.
* Поддержка делегированной авторизации с помощью маркеров доступа OAuth для использования ресурсов от имени пользователя.
* Встроенные кэши маркеров.

Аутентификация службы приложений имеет и ряд ограничений:  

* Ограниченные возможности настройки.
* Делегированная авторизация поддерживается только для одного внутреннего ресурса в каждом сеансе входа.
* Для сценария с несколькими поставщиками удостоверений нет встроенных механизмов обнаружения домашней области.
* При работе с несколькими клиентами логику для проверки издателя маркера нужно реализовать в приложении.

## <a name="deploy-the-solution"></a>Развертывание решения
Пример шаблона Resource Manager для этой архитектуры вы найдете [на сайте GitHub][paas-basic-arm-template].

Чтобы развернуть этот шаблон с помощью PowerShell, выполните следующие команды.

```
New-AzureRmResourceGroup -Name <resource-group-name> -Location "West US"

$parameters = @{"appName"="<app-name>";"environment"="dev";"locationShort"="uw";"databaseName"="app-db";"administratorLogin"="<admin>";"administratorLoginPassword"="<password>"}

New-AzureRmResourceGroupDeployment -Name <deployment-name> -ResourceGroupName <resource-group-name> -TemplateFile .\PaaS-Basic.json -TemplateParameterObject  $parameters
```

Дополнительные сведения см. в статье [Развертывание ресурсов с использованием шаблонов Resource Manager и Azure PowerShell][deploy-arm-template].

<!-- links -->

[aad-auth]: /azure/app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication
[app-insights]: /azure/application-insights/app-insights-overview
[app-insights-data-rate]: /azure/application-insights/app-insights-pricing
[app-service]: https://azure.microsoft.com/documentation/services/app-service/
[app-service-auth]: /azure/app-service-api/app-service-api-authentication
[app-service-plans]: /azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview
[app-service-plans-tiers]: https://azure.microsoft.com/pricing/details/app-service/
[app-service-security]: /azure/app-service-web/web-sites-security
[app-settings]: /azure/app-service-web/web-sites-configure
[arm-template]: /azure/azure-resource-manager/resource-group-overview#resource-groups
[azure-dns]: /azure/dns/dns-overview
[custom-domain-name]: /azure/app-service-web/web-sites-custom-domain-name
[deploy]: /azure/app-service-web/web-sites-deploy
[deploy-arm-template]: /azure/resource-group-template-deploy
[deployment-slots]: /azure/app-service-web/web-sites-staged-publishing
[diagnostic-logs]: /azure/app-service-web/web-sites-enable-diagnostic-log
[kudu]: https://azure.microsoft.com/blog/windows-azure-websites-online-tools-you-should-know-about/
[monitoring-guidance]: ../../best-practices/monitoring.md
[new-relic]: http://newrelic.com/
[paas-basic-arm-template]: https://github.com/mspnp/reference-architectures/tree/master/managed-web-app/basic-web-app/Paas-Basic/Templates
[perf-analysis]: https://github.com/mspnp/performance-optimization/blob/master/Performance-Analysis-Primer.md
[rbac]: /azure/active-directory/role-based-access-control-what-is
[resource-group]: /azure/azure-resource-manager/resource-group-overview
[sla]: https://azure.microsoft.com/support/legal/sla/
[sql-audit]: /azure/sql-database/sql-database-auditing-get-started
[sql-backup]: /azure/sql-database/sql-database-business-continuity
[sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[sql-db-overview]: /azure/sql-database/sql-database-technical-overview
[sql-db-scale]: /azure/sql-database/sql-database-service-tiers#scaling-up-or-scaling-down-a-single-database
[sql-db-service-tiers]: /azure/sql-database/sql-database-service-tiers
[sql-db-v12]: /azure/sql-database/sql-database-features
[sql-dtu]: /azure/sql-database/sql-database-service-tiers
[sql-human-error]: /azure/sql-database/sql-database-business-continuity#recover-a-database-after-a-user-or-application-error
[sql-outage-recovery]: /azure/sql-database/sql-database-business-continuity#recover-a-database-to-another-region-from-an-azure-regional-data-center-outage
[ssl-redirect]: /azure/app-service-web/web-sites-configure-ssl-certificate#bkmk_enforce
[sql-resource-limits]: /azure/sql-database/sql-database-resource-limits
[ssl-cert]: /azure/app-service-web/web-sites-purchase-ssl-web-site
[troubleshoot-blade]: https://azure.microsoft.com/updates/self-service-troubleshooting-for-app-service-web-apps-customers/
[troubleshoot-web-app]: /azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio
[visio-download]: https://archcenter.blob.core.windows.net/cdn/app-service-reference-architectures.vsdx
[vsts]: https://www.visualstudio.com/features/vso-cloud-load-testing-vs.aspx
[web-app-autoscale]: /azure/app-service-web/web-sites-scale
[web-app-backup]: /azure/app-service-web/web-sites-backup
[web-app-log-stream]: /azure/app-service-web/web-sites-enable-diagnostic-log#streamlogs
[0]: ./images/basic-web-app.png "Архитектура базового веб-приложения Azure"
[1]: ./images/paas-basic-web-app-staging-slots.png "Переключение слотов рабочей среды и промежуточного развертывания"
