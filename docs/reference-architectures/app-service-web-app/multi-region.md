---
title: Веб-приложение с поддержкой нескольких регионов
description: Рекомендуемая архитектура для веб-приложения с высоким уровнем доступности, выполняемого в Microsoft Azure.
author: MikeWasson
ms.date: 11/23/2016
cardTitle: Run in multiple regions
ms.openlocfilehash: 2efcc591695e1c592053ea32832fe15e624df2e1
ms.sourcegitcommit: c4106b58ad08f490e170e461009a4693578294ea
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2018
ms.locfileid: "43016049"
---
# <a name="run-a-web-application-in-multiple-regions"></a><span data-ttu-id="7bfc4-103">Выполнение веб-приложения в нескольких регионах</span><span class="sxs-lookup"><span data-stu-id="7bfc4-103">Run a web application in multiple regions</span></span>
[!INCLUDE [header](../../_includes/header.md)]

<span data-ttu-id="7bfc4-104">На схеме этой эталонной архитектуры представлены сведения о том, как работать с приложением службы приложений Azure в нескольких регионах для достижения высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-104">This reference architecture shows how to run an Azure App Service application in multiple regions to achieve high availability.</span></span> 

![Эталонная архитектура: веб-приложение с высоким уровнем доступности](./images/multi-region-web-app-diagram.png) 

<span data-ttu-id="7bfc4-106">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="7bfc4-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="7bfc4-107">Архитектура</span><span class="sxs-lookup"><span data-stu-id="7bfc4-107">Architecture</span></span> 

<span data-ttu-id="7bfc4-108">Эта архитектура создана на основе архитектуры из статьи [Improve scalability in a web application][guidance-web-apps-scalability] (Повышение масштабируемости в веб-приложении).</span><span class="sxs-lookup"><span data-stu-id="7bfc4-108">This architecture builds on the one shown in [Improve scalability in a web application][guidance-web-apps-scalability].</span></span> <span data-ttu-id="7bfc4-109">Основные различия:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-109">The main differences are:</span></span>

* <span data-ttu-id="7bfc4-110">**Основной и дополнительный регионы.**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-110">**Primary and secondary regions**.</span></span> <span data-ttu-id="7bfc4-111">Эта архитектура использует два региона для достижения более высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-111">This architecture uses two regions to achieve higher availability.</span></span> <span data-ttu-id="7bfc4-112">Приложение развертывается в каждом регионе.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-112">The application is deployed to each region.</span></span> <span data-ttu-id="7bfc4-113">При обычной работе трафик направляется в основной регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-113">During normal operations, network traffic is routed to the primary region.</span></span> <span data-ttu-id="7bfc4-114">Если основной регион становится недоступным, трафик направляется в дополнительный.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-114">If the primary region becomes unavailable, traffic is routed to the secondary region.</span></span> 
* <span data-ttu-id="7bfc4-115">**Azure DNS**.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-115">**Azure DNS**.</span></span> <span data-ttu-id="7bfc4-116">[Azure DNS][azure-dns] — это служба размещения для доменов DNS, которая предоставляет разрешение имен с помощью инфраструктуры Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-116">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="7bfc4-117">Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-117">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>
* <span data-ttu-id="7bfc4-118">**Диспетчер трафика Azure.**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-118">**Azure Traffic Manager**.</span></span> <span data-ttu-id="7bfc4-119">[Диспетчер трафика][traffic-manager] направляет входящие запросы в основной регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-119">[Traffic Manager][traffic-manager] routes incoming requests to the primary region.</span></span> <span data-ttu-id="7bfc4-120">Если приложение, работающее в этом регионе, становится недоступным, диспетчер трафика выполняет отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-120">If the application running that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span>
* <span data-ttu-id="7bfc4-121">**Георепликация** базы данных SQL и Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-121">**Geo-replication** of SQL Database and Cosmos DB.</span></span> 

<span data-ttu-id="7bfc4-122">Архитектура с несколькими регионами может обеспечить более высокий уровень доступности, чем развертывание в одном регионе.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-122">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="7bfc4-123">Если региональный сбой влияет на основной регион, можно использовать [диспетчер трафика][traffic-manager] для выполнения отработки отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-123">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="7bfc4-124">Эта архитектура также помогает при сбое отдельной подсистемы или приложения.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-124">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="7bfc4-125">Есть несколько общих подходов к достижению высокого уровня доступности в регионах:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-125">There are several general approaches to achieving high availability across regions:</span></span> 

* <span data-ttu-id="7bfc4-126">Шаблон "активный — пассивный" с "горячим" резервом.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-126">Active/passive with hot standby.</span></span> <span data-ttu-id="7bfc4-127">Трафик отправляется в один регион, в то время как другой ожидает в режиме "горячего" резерва.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-127">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="7bfc4-128">"Горячий" резерв применяется, когда виртуальные машины в дополнительном регионе выделены и выполняются постоянно.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-128">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
* <span data-ttu-id="7bfc4-129">Шаблон "активный — пассивный" с "холодным" резервом.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-129">Active/passive with cold standby.</span></span> <span data-ttu-id="7bfc4-130">Трафик отправляется в один регион, в то время как другой ожидает в режиме "холодного" резерва.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-130">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="7bfc4-131">"Холодный" резерв предполагает, что виртуальные машины в дополнительном регионе выделяются, только когда они требуются для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-131">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="7bfc4-132">Этот подход экономичнее, однако при сбое для выхода в динамический режим требуется больше времени.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-132">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
* <span data-ttu-id="7bfc4-133">Шаблон "активный — активный".</span><span class="sxs-lookup"><span data-stu-id="7bfc4-133">Active/active.</span></span> <span data-ttu-id="7bfc4-134">Оба региона активны, нагрузка запросов балансируется между ними.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-134">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="7bfc4-135">Если один регион отключается, он изымается из ротации.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-135">If one region becomes unavailable, it is taken out of rotation.</span></span> 

<span data-ttu-id="7bfc4-136">В этой эталонной архитектуре уделяется внимание режиму "активный — пассивный" с "горячим" резервом, а также использованию диспетчера трафика для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-136">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> 


## <a name="recommendations"></a><span data-ttu-id="7bfc4-137">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="7bfc4-137">Recommendations</span></span>

<span data-ttu-id="7bfc4-138">Описанная здесь архитектура может не соответствовать вашим требованиям.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-138">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="7bfc4-139">Используйте рекомендации из этого раздела в качестве отправной точки.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-139">Use the recommendations in this section as a starting point.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="7bfc4-140">Региональные пары</span><span class="sxs-lookup"><span data-stu-id="7bfc4-140">Regional pairing</span></span>
<span data-ttu-id="7bfc4-141">Каждый регион Azure образует пару с другим регионом в пределах одной географической территории.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-141">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="7bfc4-142">В общем случае выбирайте регионы из одной региональной пары (например, восточная часть США 2, центральная часть США).</span><span class="sxs-lookup"><span data-stu-id="7bfc4-142">In general, choose regions from the same regional pair (for example, East US 2 and Central US).</span></span> <span data-ttu-id="7bfc4-143">Преимущества:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-143">Benefits of doing so include:</span></span>

* <span data-ttu-id="7bfc4-144">в случае масштабного сбоя назначаются приоритеты восстановления по крайней мере одного региона из каждой пары;</span><span class="sxs-lookup"><span data-stu-id="7bfc4-144">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
* <span data-ttu-id="7bfc4-145">запланированные обновления системы Azure распространяются в парах регионов последовательно во избежание возможных простоев;</span><span class="sxs-lookup"><span data-stu-id="7bfc4-145">Planned Azure system updates are rolled out to paired regions sequentially to minimize possible downtime.</span></span>
* <span data-ttu-id="7bfc4-146">во многих случаях пары находятся в пределах одной географической территории в соответствии с требованиями к местонахождению данных.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-146">In most cases, regional pairs reside within the same geography to meet data residency requirements.</span></span>

<span data-ttu-id="7bfc4-147">Убедитесь, что оба региона поддерживают все службы Azure, необходимые приложению.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-147">However, make sure that both regions support all of the Azure services needed for your application.</span></span> <span data-ttu-id="7bfc4-148">Дополнительные сведения см. на станице [Доступность продуктов по регионам][services-by-region].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-148">See [Services by region][services-by-region].</span></span> <span data-ttu-id="7bfc4-149">Дополнительные сведения о парах регионов см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure][regional-pairs].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-149">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="resource-groups"></a><span data-ttu-id="7bfc4-150">Группы ресурсов</span><span class="sxs-lookup"><span data-stu-id="7bfc4-150">Resource groups</span></span>
<span data-ttu-id="7bfc4-151">Рассмотрите возможность размещения основного и дополнительного регионов, а также диспетчера трафика в отдельных [группах ресурсов][resource groups].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-151">Consider placing the primary region, secondary region, and Traffic Manager into separate [resource groups][resource groups].</span></span> <span data-ttu-id="7bfc4-152">Это позволяет управлять ресурсами, развернутыми в каждом регионе, как единой коллекцией.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-152">This lets you manage the resources deployed to each region as a single collection.</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="7bfc4-153">Конфигурация диспетчера трафика</span><span class="sxs-lookup"><span data-stu-id="7bfc4-153">Traffic Manager configuration</span></span> 

<span data-ttu-id="7bfc4-154">**Маршрутизация.**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-154">**Routing**.</span></span> <span data-ttu-id="7bfc4-155">Диспетчер трафика поддерживает несколько [алгоритмов маршрутизации][tm-routing].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-155">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="7bfc4-156">Для сценария, описанного в этой статье, используется маршрутизация по *приоритету* (ранее называлась маршрутизацией *отработки отказа*).</span><span class="sxs-lookup"><span data-stu-id="7bfc4-156">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="7bfc4-157">С помощью этой функции диспетчер трафика отправляет все запросы в основной регион, если конечная точка региона не станет недоступной.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-157">With this setting, Traffic Manager sends all requests to the primary region unless the endpoint for that region becomes unreachable.</span></span> <span data-ttu-id="7bfc4-158">В этот момент он автоматически выполняет отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-158">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="7bfc4-159">Дополнительные сведения см. в статье [Настройка метода маршрутизации трафика по приоритету в диспетчере трафика][tm-configure-failover].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-159">See [Configure Failover routing method][tm-configure-failover].</span></span>

<span data-ttu-id="7bfc4-160">**Проверка работоспособности.**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-160">**Health probe**.</span></span> <span data-ttu-id="7bfc4-161">Диспетчер трафика использует проверку HTTP (или HTTPS) для мониторинга доступности каждого региона.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-161">Traffic Manager uses an HTTP (or HTTPS) probe to monitor the availability of each endpoint.</span></span> <span data-ttu-id="7bfc4-162">При проверке диспетчер трафика получает сведения о состоянии отработки отказа в дополнительный регион (успех или сбой).</span><span class="sxs-lookup"><span data-stu-id="7bfc4-162">The probe gives Traffic Manager a pass/fail test for failing over to the secondary region.</span></span> <span data-ttu-id="7bfc4-163">При этом отправляется запрос по указанному пути URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-163">It works by sending a request to a specified URL path.</span></span> <span data-ttu-id="7bfc4-164">Если в течение периода ожидания вернется ответ, отличный от ответа с кодом 200, проверка завершается со сбоем.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-164">If it gets a non-200 response within a timeout period, the probe fails.</span></span> <span data-ttu-id="7bfc4-165">После четырех неудачных запросов диспетчер трафика отмечает конечную точку как находящуюся в состоянии пониженной функциональности и выполняет отработку отказа в другую конечную точку.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-165">After four failed requests, Traffic Manager marks the endpoint as degraded and fails over to the other endpoint.</span></span> <span data-ttu-id="7bfc4-166">Дополнительные сведения см. в статье [Мониторинг конечных точек в диспетчере трафика][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-166">For details, see [Traffic Manager endpoint monitoring and failover][tm-monitoring].</span></span>

<span data-ttu-id="7bfc4-167">Рекомендуется создать конечную точку проверки работоспособности, которая сообщает о работоспособности приложения, и использовать ее для проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-167">As a best practice, create a health probe endpoint that reports the overall health of the application and use this endpoint for the health probe.</span></span> <span data-ttu-id="7bfc4-168">Конечная точка должна проверять критические зависимости, такие как приложения службы приложений, очередь хранения и базу данных SQL.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-168">The endpoint should check critical dependencies such as the App Service apps, storage queue, and SQL Database.</span></span> <span data-ttu-id="7bfc4-169">В противном случае при проверке может быть сообщено о работоспособной конечной точке, тогда как критические части приложения фактически не будут работать.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-169">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span>

<span data-ttu-id="7bfc4-170">С другой стороны, не используйте проверку работоспособности для проверки низкоприоритетных служб.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-170">On the other hand, don't use the health probe to check lower priority services.</span></span> <span data-ttu-id="7bfc4-171">Например, если служба электронной почты отключается, приложение может переключиться на другого поставщика или отправить сообщение электронной почты позже.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-171">For example, if an email service goes down the application can switch to a second provider or just send emails later.</span></span> <span data-ttu-id="7bfc4-172">Это недостаточно высокий приоритет для выполнения отработки отказа в приложении.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-172">This is not a high enough priority to cause the application to fail over.</span></span> <span data-ttu-id="7bfc4-173">Дополнительную информацию см. в статье [Health Endpoint Monitoring pattern][health-endpoint-monitoring-pattern] (Шаблон мониторинга конечной точки работоспособности).</span><span class="sxs-lookup"><span data-stu-id="7bfc4-173">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>
 
### <a name="sql-database"></a><span data-ttu-id="7bfc4-174">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="7bfc4-174">SQL Database</span></span>
<span data-ttu-id="7bfc4-175">Используйте [активную георепликацию][sql-replication], чтобы создать доступную для чтения вторичную реплику в другом регионе.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-175">Use [Active Geo-Replication][sql-replication] to create a readable secondary replica in a different region.</span></span> <span data-ttu-id="7bfc4-176">У вас может быть до четырех доступных для чтения вторичных реплик.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-176">You can have up to four readable secondary replicas.</span></span> <span data-ttu-id="7bfc4-177">Выполните отработку отказа в базу данных-получатель, если в базе данных-источнике возникает сбой или ее необходимо перевести в автономный режим.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-177">Fail over to a secondary database if your primary database fails or needs to be taken offline.</span></span> <span data-ttu-id="7bfc4-178">Для любой базы данных в любом пуле эластичных баз данных можно настроить активную георепликацию.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-178">Active Geo-Replication can be configured for any database in any elastic database pool.</span></span>

### <a name="cosmos-db"></a><span data-ttu-id="7bfc4-179">База данных Cosmos</span><span class="sxs-lookup"><span data-stu-id="7bfc4-179">Cosmos DB</span></span>
<span data-ttu-id="7bfc4-180">Cosmos DB поддерживает географическую репликацию данных между регионами.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-180">Cosmos DB supports geo-replication across regions.</span></span> <span data-ttu-id="7bfc4-181">Один регион обозначается как доступный для записи, а другие являются доступными только для чтения репликами.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-181">One region is designated as writable and the others are read-only replicas.</span></span>

<span data-ttu-id="7bfc4-182">При региональном сбое можно выполнить отработку отказа, выбрав другой доступный для записи регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-182">If there is a regional outage, you can fail over by selecting another region to be the write region.</span></span> <span data-ttu-id="7bfc4-183">Пакет SDK клиента автоматически отправляет запросы на запись в текущий регион записи, поэтому вам не нужно обновлять конфигурацию клиента после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-183">The client SDK automatically sends write requests to the current write region, so you don't need to update the client configuration after a failover.</span></span> <span data-ttu-id="7bfc4-184">Дополнительные сведения см. в статье [Как работает глобальное распределение данных в Azure с помощью Cosmos DB][cosmosdb-geo].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-184">For more information, see [How to distribute data globally with Azure Cosmos DB][cosmosdb-geo].</span></span>

> [!NOTE]
> <span data-ttu-id="7bfc4-185">Все реплики принадлежат к одной группе ресурсов.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-185">All of the replicas belong to the same resource group.</span></span>
>
>

### <a name="storage"></a><span data-ttu-id="7bfc4-186">служба хранилища.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-186">Storage</span></span>
<span data-ttu-id="7bfc4-187">Используйте [геоизбыточное хранилище с доступом для чтения][ra-grs] для службы хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-187">For Azure Storage, use [read-access geo-redundant storage][ra-grs] (RA-GRS).</span></span> <span data-ttu-id="7bfc4-188">С геоизбыточным хранилищем с доступом на чтение данные реплицируются в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-188">With RA-GRS storage, the data is replicated to a secondary region.</span></span> <span data-ttu-id="7bfc4-189">У вас есть доступ только для чтения к данным во вторичном регионе через отдельную конечную точку.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-189">You have read-only access to the data in the secondary region through a separate endpoint.</span></span> <span data-ttu-id="7bfc4-190">Если произойдет региональный сбой или авария, команда службы хранилища Azure может решить выполнить географическую отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-190">If there is a regional outage or disaster, the Azure Storage team might decide to perform a geo-failover to the secondary region.</span></span> <span data-ttu-id="7bfc4-191">Для этой отработки отказа не требуется никаких действий клиента.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-191">There is no customer action required for this failover.</span></span>

<span data-ttu-id="7bfc4-192">Создайте резервную очередь во вторичной области, чтобы создать хранилище очередей.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-192">For Queue storage, create a backup queue in the secondary region.</span></span> <span data-ttu-id="7bfc4-193">При отработке отказа приложение может использовать резервную очередь, пока основной регион снова не станет доступен.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-193">During failover, the app can use the backup queue until the primary region becomes available again.</span></span> <span data-ttu-id="7bfc4-194">Таким образом приложение может обрабатывать новые запросы.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-194">That way, the application can still process new requests.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="7bfc4-195">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="7bfc4-195">Availability considerations</span></span>


### <a name="traffic-manager"></a><span data-ttu-id="7bfc4-196">Диспетчер трафика</span><span class="sxs-lookup"><span data-stu-id="7bfc4-196">Traffic Manager</span></span>

<span data-ttu-id="7bfc4-197">Диспетчер трафика автоматически выполняет отработку отказа, если основной регион становится недоступен.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-197">Traffic Manager automatically fails over if the primary region becomes unavailable.</span></span> <span data-ttu-id="7bfc4-198">При выполнении отработки отказа диспетчера трафика в течение определенного времени клиенты не могут связаться с приложением.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-198">When Traffic Manager fails over, there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="7bfc4-199">Этот период зависит от следующих факторов:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-199">The duration is affected by the following factors:</span></span>

* <span data-ttu-id="7bfc4-200">При проверке работоспособности определяется, что с основным центром обработки данных невозможно связаться.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-200">The health probe must detect that the primary data center has become unreachable.</span></span>
* <span data-ttu-id="7bfc4-201">Серверы службы доменных имен (DNS) должны обновить кэшированные записи DNS для IP-адресов, которые зависят от срока существования DNS.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-201">Domain name service (DNS) servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="7bfc4-202">Срок существования по умолчанию — 300 секунд (5 минут), однако это значение можно настроить при создании профиля диспетчера трафика.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-202">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="7bfc4-203">Дополнительные сведения см. в статье [Мониторинг конечных точек в диспетчере трафика][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-203">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="7bfc4-204">Диспетчер трафика — это точка возможного сбоя в системе.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-204">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="7bfc4-205">Если происходит сбой, клиенты не смогут получить доступ к приложению во время простоя.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-205">If the service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="7bfc4-206">Просмотрите [соглашение об уровне обслуживания диспетчера трафика][tm-sla] и подумайте, достаточно ли диспетчера трафика в соответствии с требованиями к высокой доступности в вашей организации.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-206">Review the [Traffic Manager service level agreement (SLA)][tm-sla] and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="7bfc4-207">Если это не так, добавьте резервное решение для управления трафиком.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-207">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="7bfc4-208">Если в службе диспетчера трафика Azure произошел сбой, измените записи CNAME в службе доменных имен, чтобы они указывали на резервную службу управления трафиком.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-208">If the Azure Traffic Manager service fails, change your canonical name (CNAME) records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="7bfc4-209">(Этот шаг нужно выполнить вручную, приложение будет отключено, пока изменения DNS не распространятся.)</span><span class="sxs-lookup"><span data-stu-id="7bfc4-209">This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.</span></span>

### <a name="sql-database"></a><span data-ttu-id="7bfc4-210">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="7bfc4-210">SQL Database</span></span>
<span data-ttu-id="7bfc4-211">Целевая точка восстановления (RPO) и расчетное время восстановления (ERT) для базы данных SQL задокументированы в разделе [Функции базы данных SQL, которые можно использовать для обеспечения непрерывности бизнес-процессов][sql-rpo].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-211">The recovery point objective (RPO) and estimated recovery time (ERT) for SQL Database are documented in [Overview of business continuity with Azure SQL Database][sql-rpo].</span></span> 

### <a name="storage"></a><span data-ttu-id="7bfc4-212">служба хранилища.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-212">Storage</span></span>
<span data-ttu-id="7bfc4-213">Геоизбыточное хранилище с доступом на чтение предоставляет надежное хранилище, однако важно понимать, что может произойти во время сбоя:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-213">RA-GRS storage provides durable storage, but it's important to understand what can happen during an outage:</span></span>

* <span data-ttu-id="7bfc4-214">При сбое хранилища в течение определенного времени у вас не будет доступа на запись данных.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-214">If a storage outage occurs, there will be a period of time when you don't have write-access to the data.</span></span> <span data-ttu-id="7bfc4-215">Вы по-прежнему может считывать данные из дополнительной конечной точки во время простоя.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-215">You can still read from the secondary endpoint during the outage.</span></span>
* <span data-ttu-id="7bfc4-216">Если региональный сбой или авария затрагивают основное расположение и данные оттуда невозможно восстановить, команда службы хранилища Azure может выполнить географическую отработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-216">If a regional outage or disaster affects the primary location and the data there cannot be recovered, the Azure Storage team may decide to perform a geo-failover to the secondary region.</span></span>
* <span data-ttu-id="7bfc4-217">Репликация данных в дополнительный регион выполняется асинхронно.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-217">Data replication to the secondary region is performed asynchronously.</span></span> <span data-ttu-id="7bfc4-218">Таким образом, если при выполнении географической отработки отказа данные невозможно восстановить из основного региона, возможна потеря некоторых данных.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-218">Therefore, if a geo-failover is performed, some data loss is possible if the data can't be recovered from the primary region.</span></span>
* <span data-ttu-id="7bfc4-219">Временные сбои, такие как сбои сети, не активируют отработку отказа хранилища.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-219">Transient failures, such as a network outage, will not trigger a storage failover.</span></span> <span data-ttu-id="7bfc4-220">Создайте устойчивое к кратковременным сбоям приложение.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-220">Design your application to be resilient to transient failures.</span></span> <span data-ttu-id="7bfc4-221">Возможные способы устранения:</span><span class="sxs-lookup"><span data-stu-id="7bfc4-221">Possible mitigations:</span></span>
  
  * <span data-ttu-id="7bfc4-222">чтение из дополнительного региона;</span><span class="sxs-lookup"><span data-stu-id="7bfc4-222">Read from the secondary region.</span></span>
  * <span data-ttu-id="7bfc4-223">временное переключение на другую учетную запись хранения для выполнения новых операций записи (например, очереди сообщений);</span><span class="sxs-lookup"><span data-stu-id="7bfc4-223">Temporarily switch to another storage account for new write operations (for example, to queue messages).</span></span>
  * <span data-ttu-id="7bfc4-224">копирование данных из дополнительного региона в другую учетную запись хранения;</span><span class="sxs-lookup"><span data-stu-id="7bfc4-224">Copy data from the secondary region to another storage account.</span></span>
  * <span data-ttu-id="7bfc4-225">настройка режима сниженной функциональности до восстановления размещения системы.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-225">Provide reduced functionality until the system fails back.</span></span>

<span data-ttu-id="7bfc4-226">Дополнительные сведения см. в разделе [Что делать в случае сбоя службы хранилища Azure][storage-outage].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-226">For more information, see [What to do if an Azure Storage outage occurs][storage-outage].</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="7bfc4-227">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="7bfc4-227">Manageability Considerations</span></span>

### <a name="traffic-manager"></a><span data-ttu-id="7bfc4-228">Диспетчер трафика</span><span class="sxs-lookup"><span data-stu-id="7bfc4-228">Traffic Manager</span></span>

<span data-ttu-id="7bfc4-229">При отработке отказа диспетчера трафика ее рекомендуется выполнять вручную, а не внедрять автоматическую отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-229">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="7bfc4-230">В противном случае могут возникнуть ситуации, в которых приложение будет переходить между регионами.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-230">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="7bfc4-231">Убедитесь, что все подсистемы приложения полностью работоспособны, и лишь затем выполните восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-231">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="7bfc4-232">Обратите внимание, что диспетчер трафика по умолчанию автоматически восстанавливает размещение.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-232">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="7bfc4-233">Чтобы избежать этого, вручную понизьте приоритет основного региона после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-233">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="7bfc4-234">Например, предположим, что основной регион имеет приоритет 1, а дополнительные — приоритет 2.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-234">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="7bfc4-235">После отработки отказа задайте основному региону приоритет 3, чтобы избежать автоматического восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-235">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="7bfc4-236">Когда будете готовы переключить приоритет обратно, измените приоритет до 1.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-236">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="7bfc4-237">Следующие команды обновляют приоритет.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-237">The following commands update the priority.</span></span>

<span data-ttu-id="7bfc4-238">**PowerShell**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-238">**PowerShell**</span></span>

```bat
$endpoint = Get-AzureRmTrafficManagerEndpoint -Name <endpoint> -ProfileName <profile> -ResourceGroupName <resource-group> -Type AzureEndpoints
$endpoint.Priority = 3
Set-AzureRmTrafficManagerEndpoint -TrafficManagerEndpoint $endpoint
```

<span data-ttu-id="7bfc4-239">Дополнительные сведения см. в статье [AzureRM.TrafficManager][tm-ps].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-239">For more information, see [Azure Traffic Manager Cmdlets][tm-ps].</span></span>

<span data-ttu-id="7bfc4-240">**Интерфейс командной строки Azure (CLI)**</span><span class="sxs-lookup"><span data-stu-id="7bfc4-240">**Azure command line interface (CLI)**</span></span>

```bat
azure network traffic-manager endpoint set --name <endpoint> --profile-name <profile> --resource-group <resource-group> --type AzureEndpoints --priority 3
```    

### <a name="sql-database"></a><span data-ttu-id="7bfc4-241">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="7bfc4-241">SQL Database</span></span>
<span data-ttu-id="7bfc4-242">При сбое базы данных-источника выполните отработку отказа вручную с переходом в базу данных-получатель.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-242">If the primary database fails, perform a manual failover to the secondary database.</span></span> <span data-ttu-id="7bfc4-243">Ознакомьтесь со статьей [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе][sql-failover].</span><span class="sxs-lookup"><span data-stu-id="7bfc4-243">See [Restore an Azure SQL Database or failover to a secondary][sql-failover].</span></span> <span data-ttu-id="7bfc4-244">До отработки отказа база данных-получатель остается доступной только для чтения.</span><span class="sxs-lookup"><span data-stu-id="7bfc4-244">The secondary database remains read-only until you fail over.</span></span>


<!-- links -->

[azure-sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[azure-dns]: /azure/dns/dns-overview
[cosmosdb-geo]: /azure/cosmos-db/distribute-data-globally
[guidance-web-apps-scalability]: ./scalable-web-app.md
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[ra-grs]: /azure/storage/storage-redundancy#read-access-geo-redundant-storage
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview#resource-groups
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-failover]: /azure/sql-database/sql-database-disaster-recovery
[sql-replication]: /azure/sql-database/sql-database-geo-replication-overview
[sql-rpo]: /azure/sql-database/sql-database-business-continuity#sql-database-features-that-you-can-use-to-provide-business-continuity
[storage-outage]: /azure/storage/storage-disaster-recovery-guidance
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-ps]: /powershell/module/azurerm.trafficmanager
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager/v1_0/
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager/
[visio-download]: https://archcenter.blob.core.windows.net/cdn/app-service-reference-architectures.vsdx
