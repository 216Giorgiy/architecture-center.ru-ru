---
title: Создание леса ресурсов доменных служб Active Directory в Azure
description: >-
  Инструкции по созданию доверенного домена Active Directory в Azure.

  рекомендации,vpn-шлюз,expressroute,подсистема балансировки нагрузки,виртуальная сеть,active directory
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Identity management
pnp.series.prev: adds-extend-domain
pnp.series.next: adfs
cardTitle: Create an AD DS forest in Azure
ms.openlocfilehash: e32a6420821e70c84e77d2c39614f0c45efbb7e2
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="create-an-active-directory-domain-services-ad-ds-resource-forest-in-azure"></a><span data-ttu-id="4e972-104">Создание леса ресурсов доменных служб Active Directory (AD DS) в Azure</span><span class="sxs-lookup"><span data-stu-id="4e972-104">Create an Active Directory Domain Services (AD DS) resource forest in Azure</span></span>

<span data-ttu-id="4e972-105">На схеме эталонной архитектуры представлены данные о создании отдельного домена Active Directory в Azure, который является доверенным для доменов в локальном лесу AD.</span><span class="sxs-lookup"><span data-stu-id="4e972-105">This reference architecture shows how to create a separate Active Directory domain in Azure that is trusted by domains in your on-premises AD forest.</span></span> [<span data-ttu-id="4e972-106">**Разверните это решение**.</span><span class="sxs-lookup"><span data-stu-id="4e972-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="4e972-107">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="4e972-107">[![0]][0]</span></span> 

<span data-ttu-id="4e972-108">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="4e972-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="4e972-109">Доменные службы Active Directory (AD DS) хранят сведения об удостоверении в виде иерархической структуры.</span><span class="sxs-lookup"><span data-stu-id="4e972-109">Active Directory Domain Services (AD DS) stores identity information in a hierarchical structure.</span></span> <span data-ttu-id="4e972-110">Верхний узел в иерархической структуре называется лесом.</span><span class="sxs-lookup"><span data-stu-id="4e972-110">The top node in the hierarchical structure is known as a forest.</span></span> <span data-ttu-id="4e972-111">Лес содержит домены, которые, в свою очередь, содержат объекты других типов.</span><span class="sxs-lookup"><span data-stu-id="4e972-111">A forest contains domains, and domains contain other types of objects.</span></span> <span data-ttu-id="4e972-112">Эталонная архитектура создает лес AD DS в Azure с односторонним исходящим отношением доверия с локальным доменом.</span><span class="sxs-lookup"><span data-stu-id="4e972-112">This reference architecture creates an AD DS forest in Azure with a one-way outgoing trust relationship with an on-premises domain.</span></span> <span data-ttu-id="4e972-113">Лес в Azure содержит домен, отсутствующий в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="4e972-113">The forest in Azure contains a domain that does not exist on-premises.</span></span> <span data-ttu-id="4e972-114">Благодаря отношению доверия операции входа в локальные домены могут быть доверенными и получать доступ к ресурсам в отдельном домене Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-114">Because of the trust relationship, logons made against on-premises domains can be trusted for access to resources in the separate Azure domain.</span></span> 

<span data-ttu-id="4e972-115">Типичные способы применения этой архитектуры включают поддержку разделения по безопасности для облачных объектов и удостоверений, а также перенос отдельных доменов из локальной среды в облако.</span><span class="sxs-lookup"><span data-stu-id="4e972-115">Typical uses for this architecture include maintaining security separation for objects and identities held in the cloud, and migrating individual domains from on-premises to the cloud.</span></span> 

<span data-ttu-id="4e972-116">Дополнительные рекомендации см. в статье [Выбор решения для интеграции локальной среды Active Directory с Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="4e972-116">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span> 

## <a name="architecture"></a><span data-ttu-id="4e972-117">Архитектура</span><span class="sxs-lookup"><span data-stu-id="4e972-117">Architecture</span></span>

<span data-ttu-id="4e972-118">Архитектура состоит из следующих компонентов.</span><span class="sxs-lookup"><span data-stu-id="4e972-118">The architecture has the following components.</span></span>

* <span data-ttu-id="4e972-119">**Локальная сеть**.</span><span class="sxs-lookup"><span data-stu-id="4e972-119">**On-premises network**.</span></span> <span data-ttu-id="4e972-120">Локальная сеть содержит собственные лес и домены Active Directory.</span><span class="sxs-lookup"><span data-stu-id="4e972-120">The on-premises network contains its own Active Directory forest and domains.</span></span>
* <span data-ttu-id="4e972-121">**Серверы Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="4e972-121">**Active Directory servers**.</span></span> <span data-ttu-id="4e972-122">Они являются контроллерами домена, которые реализуют службы домена, работающие в облаке в качестве виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="4e972-122">These are domain controllers implementing domain services running as VMs in the cloud.</span></span> <span data-ttu-id="4e972-123">На этих серверах размещается лес с одним или несколькими доменами, отдельными от локальных.</span><span class="sxs-lookup"><span data-stu-id="4e972-123">These servers host a forest containing one or more domains, separate from those located on-premises.</span></span>
* <span data-ttu-id="4e972-124">**Одностороннее отношение доверия**.</span><span class="sxs-lookup"><span data-stu-id="4e972-124">**One-way trust relationship**.</span></span> <span data-ttu-id="4e972-125">В примере на этой диаграмме показано одностороннее отношение доверия между доменом в Azure и локальным доменом.</span><span class="sxs-lookup"><span data-stu-id="4e972-125">The example in the diagram shows a one-way trust from the domain in Azure to the on-premises domain.</span></span> <span data-ttu-id="4e972-126">Это отношение позволяет локальным пользователям получать доступ к ресурсам в домене в Azure, но не наоборот.</span><span class="sxs-lookup"><span data-stu-id="4e972-126">This relationship enables on-premises users to access resources in the domain in Azure, but not the other way around.</span></span> <span data-ttu-id="4e972-127">Если пользователям облака также требуется доступ к локальным ресурсам, можно создать двустороннее отношение доверия.</span><span class="sxs-lookup"><span data-stu-id="4e972-127">It is possible to create a two-way trust if cloud users also require access to on-premises resources.</span></span>
* <span data-ttu-id="4e972-128">**Подсеть Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="4e972-128">**Active Directory subnet**.</span></span> <span data-ttu-id="4e972-129">Серверы доменных служб Active Directory находятся в отдельной подсети.</span><span class="sxs-lookup"><span data-stu-id="4e972-129">The AD DS servers are hosted in a separate subnet.</span></span> <span data-ttu-id="4e972-130">Правила группы безопасности сети (NSG) защищают серверы доменных служб Active Directory и предоставляют брандмауэр для трафика из неизвестных источников.</span><span class="sxs-lookup"><span data-stu-id="4e972-130">Network security group (NSG) rules protect the AD DS servers and provide a firewall against traffic from unexpected sources.</span></span>
* <span data-ttu-id="4e972-131">**Шлюз Azure**.</span><span class="sxs-lookup"><span data-stu-id="4e972-131">**Azure gateway**.</span></span> <span data-ttu-id="4e972-132">Шлюз Azure обеспечивает соединение между локальной и виртуальной сетями Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-132">The Azure gateway provides a connection between the on-premises network and the Azure VNet.</span></span> <span data-ttu-id="4e972-133">Это может быть [VPN-подключение][azure-vpn-gateway] или [Azure ExpressRoute][azure-expressroute].</span><span class="sxs-lookup"><span data-stu-id="4e972-133">This can be a [VPN connection][azure-vpn-gateway] or [Azure ExpressRoute][azure-expressroute].</span></span> <span data-ttu-id="4e972-134">Дополнительные сведения см. в статье [DMZ between Azure and your on-premises datacenter] (Сеть периметра между Azure и локальным центром обработки данных) [implementing-a-secure-hybrid-network-architecture].</span><span class="sxs-lookup"><span data-stu-id="4e972-134">For more information, see [Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture].</span></span>

## <a name="recommendations"></a><span data-ttu-id="4e972-135">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="4e972-135">Recommendations</span></span>

<span data-ttu-id="4e972-136">Конкретные рекомендации по реализации Active Directory в Azure см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="4e972-136">For specific recommendations on implementing Active Directory in Azure, see the following articles:</span></span>

- <span data-ttu-id="4e972-137">[Расширение доменных служб Active Directory в Azure][adds-extend-domain].</span><span class="sxs-lookup"><span data-stu-id="4e972-137">[Extending Active Directory Domain Services (AD DS) to Azure][adds-extend-domain].</span></span> 
- <span data-ttu-id="4e972-138">[Руководства по развертыванию Windows Server Active Directory на виртуальных машинах Azure][ad-azure-guidelines].</span><span class="sxs-lookup"><span data-stu-id="4e972-138">[Guidelines for Deploying Windows Server Active Directory on Azure Virtual Machines][ad-azure-guidelines].</span></span>

### <a name="trust"></a><span data-ttu-id="4e972-139">Доверие</span><span class="sxs-lookup"><span data-stu-id="4e972-139">Trust</span></span>

<span data-ttu-id="4e972-140">Локальные домены находятся в другом лесу, отличном от леса с доменами в облаке.</span><span class="sxs-lookup"><span data-stu-id="4e972-140">The on-premises domains are contained within a different forest from the domains in the cloud.</span></span> <span data-ttu-id="4e972-141">Чтобы включить аутентификацию локальных пользователей в облаке, домены в Azure должны доверять домену входа в систему в локальном лесу.</span><span class="sxs-lookup"><span data-stu-id="4e972-141">To enable authentication of on-premises users in the cloud, the domains in Azure must trust the logon domain in the on-premises forest.</span></span> <span data-ttu-id="4e972-142">Аналогично, если облако предоставляет домен входа в систему для внешних пользователей, возможно, понадобится настроить отношение доверия между локальным лесом и облачным доменом.</span><span class="sxs-lookup"><span data-stu-id="4e972-142">Similarly, if the cloud provides a logon domain for external users, it may be necessary for the on-premises forest to trust the cloud domain.</span></span>

<span data-ttu-id="4e972-143">Вы можете установить доверие на уровне леса, [создав отношения доверия лесов][creating-forest-trusts], или на уровне домена, [создав отношения внешнего доверия][creating-external-trusts].</span><span class="sxs-lookup"><span data-stu-id="4e972-143">You can establish trusts at the forest level by [creating forest trusts][creating-forest-trusts], or at the domain level by [creating external trusts][creating-external-trusts].</span></span> <span data-ttu-id="4e972-144">Уровень доверия леса создает связь между всеми доменами в двух лесах.</span><span class="sxs-lookup"><span data-stu-id="4e972-144">A forest level trust creates a relationship between all domains in two forests.</span></span> <span data-ttu-id="4e972-145">Доверительные отношения на уровне внешнего домена создают связь только между двумя указанными доменами.</span><span class="sxs-lookup"><span data-stu-id="4e972-145">An external domain level trust only creates a relationship between two specified domains.</span></span> <span data-ttu-id="4e972-146">Вам необходимо только создать доверительные отношения на уровне внешнего домена между доменами в разных лесах.</span><span class="sxs-lookup"><span data-stu-id="4e972-146">You should only create external domain level trusts between domains in different forests.</span></span>

<span data-ttu-id="4e972-147">Отношения доверия могут быть однонаправленными (односторонними) или двунаправленными (двусторонними):</span><span class="sxs-lookup"><span data-stu-id="4e972-147">Trusts can be unidirectional (one-way) or bidirectional (two-way):</span></span>

* <span data-ttu-id="4e972-148">Одностороннее отношение доверия позволяет пользователям из одного домена или леса (известного как *входящий* домен или лес) получать доступ к ресурсам, которые содержатся в другом (*исходящем* домене или лесу).</span><span class="sxs-lookup"><span data-stu-id="4e972-148">A one-way trust enables users in one domain or forest (known as the *incoming* domain or forest) to access the resources held in another (the *outgoing* domain or forest).</span></span>
* <span data-ttu-id="4e972-149">Двустороннее отношение доверия позволяет пользователям в домене или лесу получать доступ к ресурсам, которые содержатся в другом домене или лесу.</span><span class="sxs-lookup"><span data-stu-id="4e972-149">A two-way trust enables users in either domain or forest to access resources held in the other.</span></span>

<span data-ttu-id="4e972-150">В следующей таблице перечислены конфигурации доверия для некоторых простых сценариев:</span><span class="sxs-lookup"><span data-stu-id="4e972-150">The following table summarizes trust configurations for some simple scenarios:</span></span>

| <span data-ttu-id="4e972-151">Сценарий</span><span class="sxs-lookup"><span data-stu-id="4e972-151">Scenario</span></span> | <span data-ttu-id="4e972-152">Локальное отношение доверия</span><span class="sxs-lookup"><span data-stu-id="4e972-152">On-premises trust</span></span> | <span data-ttu-id="4e972-153">Отношение доверия облака</span><span class="sxs-lookup"><span data-stu-id="4e972-153">Cloud trust</span></span> |
| --- | --- | --- |
| <span data-ttu-id="4e972-154">Локальным пользователям требуется доступ к ресурсам в облаке, но не наоборот</span><span class="sxs-lookup"><span data-stu-id="4e972-154">On-premises users require access to resources in the cloud, but not vice versa</span></span> |<span data-ttu-id="4e972-155">Односторонний, входящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-155">One-way, incoming</span></span> |<span data-ttu-id="4e972-156">Односторонний, исходящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-156">One-way, outgoing</span></span> |
| <span data-ttu-id="4e972-157">Пользователям в облаке требуется доступ к локальным ресурсам, но не наоборот</span><span class="sxs-lookup"><span data-stu-id="4e972-157">Users in the cloud require access to resources located on-premises, but not vice versa</span></span> |<span data-ttu-id="4e972-158">Односторонний, исходящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-158">One-way, outgoing</span></span> |<span data-ttu-id="4e972-159">Односторонний, входящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-159">One-way, incoming</span></span> |
| <span data-ttu-id="4e972-160">Пользователям в облаке и локальной среде требуется доступ к ресурсам, хранящимся в облаке и в локальной среде</span><span class="sxs-lookup"><span data-stu-id="4e972-160">Users in the cloud and on-premises both requires access to resources held in the cloud and on-premises</span></span> |<span data-ttu-id="4e972-161">Двусторонний, входящий и исходящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-161">Two-way, incoming and outgoing</span></span> |<span data-ttu-id="4e972-162">Двусторонний, входящий и исходящий трафик</span><span class="sxs-lookup"><span data-stu-id="4e972-162">Two-way, incoming and outgoing</span></span> |

## <a name="scalability-considerations"></a><span data-ttu-id="4e972-163">Вопросы масштабируемости</span><span class="sxs-lookup"><span data-stu-id="4e972-163">Scalability considerations</span></span>

<span data-ttu-id="4e972-164">Active Directory автоматически масштабируется для контроллеров, которые являются частью одного домена.</span><span class="sxs-lookup"><span data-stu-id="4e972-164">Active Directory is automatically scalable for domain controllers that are part of the same domain.</span></span> <span data-ttu-id="4e972-165">Запросы распространяются на все контроллеры в домене.</span><span class="sxs-lookup"><span data-stu-id="4e972-165">Requests are distributed across all controllers within a domain.</span></span> <span data-ttu-id="4e972-166">Вы можете добавить еще один контроллер домена, и он автоматически синхронизируется с доменом.</span><span class="sxs-lookup"><span data-stu-id="4e972-166">You can add another domain controller, and it synchronizes automatically with the domain.</span></span> <span data-ttu-id="4e972-167">Не настраивайте отдельную подсистему балансировки нагрузки для направления трафика в контроллерах в домене.</span><span class="sxs-lookup"><span data-stu-id="4e972-167">Do not configure a separate load balancer to direct traffic to controllers within the domain.</span></span> <span data-ttu-id="4e972-168">Убедитесь, что все контроллеры домена имеют достаточно ресурсов памяти и хранилища для обработки базы данных домена.</span><span class="sxs-lookup"><span data-stu-id="4e972-168">Ensure that all domain controllers have sufficient memory and storage resources to handle the domain database.</span></span> <span data-ttu-id="4e972-169">Сделайте все виртуальные машины контроллера домена одного размера.</span><span class="sxs-lookup"><span data-stu-id="4e972-169">Make all domain controller VMs the same size.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="4e972-170">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="4e972-170">Availability considerations</span></span>

<span data-ttu-id="4e972-171">Подготовьте по крайней мере два контроллера домена для каждого домена.</span><span class="sxs-lookup"><span data-stu-id="4e972-171">Provision at least two domain controllers for each domain.</span></span> <span data-ttu-id="4e972-172">Это позволяет выполнять репликацию между серверами автоматически.</span><span class="sxs-lookup"><span data-stu-id="4e972-172">This enables automatic replication between servers.</span></span> <span data-ttu-id="4e972-173">Создайте группу доступности для виртуальных машин, действующих в качестве серверов Active Directory, обрабатывающих каждый домен.</span><span class="sxs-lookup"><span data-stu-id="4e972-173">Create an availability set for the VMs acting as Active Directory servers handling each domain.</span></span> <span data-ttu-id="4e972-174">Поместите по крайней мере два сервера в эту группу доступности.</span><span class="sxs-lookup"><span data-stu-id="4e972-174">Put at least two servers in this availability set.</span></span>

<span data-ttu-id="4e972-175">Кроме того, рассмотрите вопрос о назначении одного или нескольких серверов в каждом домене в качестве [владельцев резервных операций][standby-operations-masters] в случае сбоя подключения к серверу, который выступает в качестве владельца роли FSMO.</span><span class="sxs-lookup"><span data-stu-id="4e972-175">Also, consider designating one or more servers in each domain as [standby operations masters][standby-operations-masters] in case connectivity to a server acting as a flexible single master operation (FSMO) role fails.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="4e972-176">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="4e972-176">Manageability considerations</span></span>

<span data-ttu-id="4e972-177">Дополнительные сведения и рекомендации по управлению и мониторингу см. в статье [Расширение доменных служб Active Directory в Azure][adds-extend-domain].</span><span class="sxs-lookup"><span data-stu-id="4e972-177">For information about management and monitoring considerations, see [Extending Active Directory to Azure][adds-extend-domain].</span></span> 
 
<span data-ttu-id="4e972-178">Дополнительные сведения см. в документе [Monitoring Active Directory][monitoring_ad] (Мониторинг Active Directory).</span><span class="sxs-lookup"><span data-stu-id="4e972-178">For additional information, see [Monitoring Active Directory][monitoring_ad].</span></span> <span data-ttu-id="4e972-179">Вы можете установить инструменты (например, [Microsoft Systems Center][microsoft_systems_center]) на сервере мониторинга в подсети управления для выполнения этих задач.</span><span class="sxs-lookup"><span data-stu-id="4e972-179">You can install tools such as [Microsoft Systems Center][microsoft_systems_center] on a monitoring server in the management subnet to help perform these tasks.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="4e972-180">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="4e972-180">Security considerations</span></span>

<span data-ttu-id="4e972-181">Отношения доверия на уровне леса являются транзитивными.</span><span class="sxs-lookup"><span data-stu-id="4e972-181">Forest level trusts are transitive.</span></span> <span data-ttu-id="4e972-182">Если установить отношение доверия на уровне леса между локальным и облачным лесами, оно распространяется на другие новые домены в любом лесу.</span><span class="sxs-lookup"><span data-stu-id="4e972-182">If you establish a forest level trust between an on-premises forest and a forest in the cloud, this trust is extended to other new domains created in either forest.</span></span> <span data-ttu-id="4e972-183">Если вы используете домены для обеспечения разделения в целях безопасности, рекомендуется создать доверительные отношения только на уровне домена.</span><span class="sxs-lookup"><span data-stu-id="4e972-183">If you use domains to provide separation for security purposes, consider creating trusts at the domain level only.</span></span> <span data-ttu-id="4e972-184">Отношения доверия на уровне домена являются нетранзитивными.</span><span class="sxs-lookup"><span data-stu-id="4e972-184">Domain level trusts are non-transitive.</span></span>

<span data-ttu-id="4e972-185">Рекомендации по безопасности, связанные с Active Directory, см. в разделе "Вопросы безопасности" в статье [Расширение доменных служб Active Directory в Azure][adds-extend-domain].</span><span class="sxs-lookup"><span data-stu-id="4e972-185">For Active Directory-specific security considerations, see the security considerations section in [Extending Active Directory to Azure][adds-extend-domain].</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="4e972-186">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="4e972-186">Deploy the solution</span></span>

<span data-ttu-id="4e972-187">Решение для развертывания этой эталонной архитектуры доступно на портале [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="4e972-187">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="4e972-188">Для выполнения сценария Powershell, который развертывает решение, вам потребуется последняя версия Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="4e972-188">You will need the latest version of the Azure CLI to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="4e972-189">Чтобы развернуть эту эталонную архитектуру, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="4e972-189">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="4e972-190">Скачайте или клонируйте папку решения с портала [Github][github] на локальный компьютер.</span><span class="sxs-lookup"><span data-stu-id="4e972-190">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="4e972-191">Откройте Azure CLI и перейдите к папке локального решения.</span><span class="sxs-lookup"><span data-stu-id="4e972-191">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="4e972-192">Выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="4e972-192">Run the following command:</span></span>
   
    ```Powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    <span data-ttu-id="4e972-193">Замените `<subscription id>` идентификатором своей подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-193">Replace `<subscription id>` with your Azure subscription ID.</span></span>
   
    <span data-ttu-id="4e972-194">В качестве значения `<location>` укажите регион Azure (например, `eastus` или `westus`).</span><span class="sxs-lookup"><span data-stu-id="4e972-194">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>
   
    <span data-ttu-id="4e972-195">Параметр `<mode>` управляет степенью детализации развертывания и может принимать одно из следующих значений:</span><span class="sxs-lookup"><span data-stu-id="4e972-195">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>
   
   * <span data-ttu-id="4e972-196">`Onpremise` — развертывает имитированную локальную среду.</span><span class="sxs-lookup"><span data-stu-id="4e972-196">`Onpremise`: deploys the simulated on-premises environment.</span></span>
   * <span data-ttu-id="4e972-197">`Infrastructure` — развертывает виртуальную сеть и переходит к полю в Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-197">`Infrastructure`: deploys the VNet infrastructure and jump box in Azure.</span></span>
   * <span data-ttu-id="4e972-198">`CreateVpn` — развертывает шлюз виртуальной сети Azure и подключает его к имитированной локальной сети.</span><span class="sxs-lookup"><span data-stu-id="4e972-198">`CreateVpn`: deploys the Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   * <span data-ttu-id="4e972-199">`AzureADDS` — выполняет развертывание виртуальных машин, действующих как серверы доменных служб Active Directory, развертывает Active Directory в этих виртуальных машинах, а также развертывает домен в Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-199">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and deploys the domain in Azure.</span></span>
   * <span data-ttu-id="4e972-200">`WebTier` — развертывает виртуальные машины и балансировщик нагрузки веб-уровня.</span><span class="sxs-lookup"><span data-stu-id="4e972-200">`WebTier`: deploys the web tier VMs and load balancer.</span></span>
   * <span data-ttu-id="4e972-201">`Prepare` — выполняет все предыдущие развертывания.</span><span class="sxs-lookup"><span data-stu-id="4e972-201">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="4e972-202">**Мы рекомендуем использовать этот параметр при отсутствии имеющейся локальной сети и при необходимости развернуть полную эталонную архитектуру, описанную выше, для тестирования или вычисления.**</span><span class="sxs-lookup"><span data-stu-id="4e972-202">**This is the recommended option if If you do not have an existing on-premises network but you want to deploy the complete reference architecture described above for testing or evaluation.**</span></span> 
   * <span data-ttu-id="4e972-203">`Workload` — развертывает виртуальные машины и балансировщик нагрузки бизнес-уровня и уровня данных.</span><span class="sxs-lookup"><span data-stu-id="4e972-203">`Workload`: deploys the business and data tier VMs and load balancers.</span></span> <span data-ttu-id="4e972-204">Обратите внимание, что эти виртуальные машины не включаются в развертывание `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="4e972-204">Note that these VMs are not included in the `Prepare` deployment.</span></span>

4. <span data-ttu-id="4e972-205">Дождитесь завершения развертывания.</span><span class="sxs-lookup"><span data-stu-id="4e972-205">Wait for the deployment to complete.</span></span> <span data-ttu-id="4e972-206">Если вы выполняете развертывание `Prepare`, это займет несколько часов.</span><span class="sxs-lookup"><span data-stu-id="4e972-206">If you are deploying the `Prepare` deployment, it will take several hours.</span></span>
     
5. <span data-ttu-id="4e972-207">При использовании имитированной локальной конфигурации настройте входящее отношение доверия.</span><span class="sxs-lookup"><span data-stu-id="4e972-207">If you are using the simulated on-premises configuration, configure the incoming trust relationship:</span></span>
   
   1. <span data-ttu-id="4e972-208">Подключитесь к полю перехода (<em>ra-adtrust-mgmt-vm1</em> в группе ресурсов <em>ra-adtrust-security-rg</em>).</span><span class="sxs-lookup"><span data-stu-id="4e972-208">Connect to the jump box (<em>ra-adtrust-mgmt-vm1</em> in the <em>ra-adtrust-security-rg</em> resource group).</span></span> <span data-ttu-id="4e972-209">Войдите в систему в качестве тестового пользователя <em>testuser</em>, используя пароль <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="4e972-209">Log in as <em>testuser</em> with password <em>AweS0me@PW</em>.</span></span>
   2. <span data-ttu-id="4e972-210">В окне перехода откройте сеанс RDP на первой виртуальной машине в домене <em>contoso.com</em> (локальный домен).</span><span class="sxs-lookup"><span data-stu-id="4e972-210">On the jump box open an RDP session on the first VM in the <em>contoso.com</em> domain (the on-premises domain).</span></span> <span data-ttu-id="4e972-211">Эта виртуальная машина имеет IP-адрес 192.168.0.4.</span><span class="sxs-lookup"><span data-stu-id="4e972-211">This VM has the IP address 192.168.0.4.</span></span> <span data-ttu-id="4e972-212">Именем пользователя является <em>contoso\testuser</em>, а паролем — <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="4e972-212">The username is <em>contoso\testuser</em> with password <em>AweS0me@PW</em>.</span></span>
   3. <span data-ttu-id="4e972-213">Скачайте сценарий [incoming-trust.ps1][incoming-trust] и запустите его, чтобы создать входящее отношение доверия из домена *treyresearch.com*.</span><span class="sxs-lookup"><span data-stu-id="4e972-213">Download the [incoming-trust.ps1][incoming-trust] script and run it to create the incoming trust from the *treyresearch.com* domain.</span></span>

6. <span data-ttu-id="4e972-214">Если вы используете собственную локальную инфраструктуру, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="4e972-214">If you are using your own on-premises infrastructure:</span></span>
   
   1. <span data-ttu-id="4e972-215">Скачайте сценарий [incoming-trust.ps1][incoming-trust].</span><span class="sxs-lookup"><span data-stu-id="4e972-215">Download the [incoming-trust.ps1][incoming-trust] script.</span></span>
   2. <span data-ttu-id="4e972-216">Измените его и замените значения переменной `$TrustedDomainName` именем собственного домена.</span><span class="sxs-lookup"><span data-stu-id="4e972-216">Edit the script and replace the value of the `$TrustedDomainName` variable with the name of your own domain.</span></span>
   3. <span data-ttu-id="4e972-217">Выполните скрипт.</span><span class="sxs-lookup"><span data-stu-id="4e972-217">Run the script.</span></span>

7. <span data-ttu-id="4e972-218">В поле перехода подключитесь к первой виртуальной машине в домене <em>treyresearch.com</em> (домен в облаке).</span><span class="sxs-lookup"><span data-stu-id="4e972-218">From the jump-box, connect to the first VM in the <em>treyresearch.com</em> domain (the domain in the cloud).</span></span> <span data-ttu-id="4e972-219">Эта виртуальная машина имеет IP-адрес 10.0.4.4.</span><span class="sxs-lookup"><span data-stu-id="4e972-219">This VM has the IP address 10.0.4.4.</span></span> <span data-ttu-id="4e972-220">Именем пользователя является <em>treyresearch\testuser</em>, а паролем <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="4e972-220">The username is <em>treyresearch\testuser</em> with password <em>AweS0me@PW</em>.</span></span>

8. <span data-ttu-id="4e972-221">Скачайте сценарий [outgoing-trust.ps1][outgoing-trust] и запустите его, чтобы создать входящее отношение доверия из домена *treyresearch.com*.</span><span class="sxs-lookup"><span data-stu-id="4e972-221">Download the [outgoing-trust.ps1][outgoing-trust] script and run it to create the incoming trust from the *treyresearch.com* domain.</span></span> <span data-ttu-id="4e972-222">Если используются собственные локальные компьютеры, сначала нужно изменить сценарий.</span><span class="sxs-lookup"><span data-stu-id="4e972-222">If you are using your own on-premises machines, then edit the script first.</span></span> <span data-ttu-id="4e972-223">Задайте переменную `$TrustedDomainName` для имени вашего домена в локальной среде и укажите IP-адреса серверов доменных служб Active Directory для этого домена в переменной `$TrustedDomainDnsIpAddresses`.</span><span class="sxs-lookup"><span data-stu-id="4e972-223">Set the `$TrustedDomainName` variable to the name of your on-premises domain, and specify the IP addresses of the Active Directory DS servers for this domain in the `$TrustedDomainDnsIpAddresses` variable.</span></span>

9. <span data-ttu-id="4e972-224">Подождите несколько минут, пока не завершится выполнение предыдущих шагов, а затем подключитесь к виртуальной машине в локальной среде и выполните шаги, описанные в статье [Проверка доверия][verify-a-trust], чтобы определить, правильно ли настроено отношение доверия между доменами *contoso.com* и *treyresearch.com*.</span><span class="sxs-lookup"><span data-stu-id="4e972-224">Wait a few minutes for the previous steps to complete, then connect to an on-premises VM and perform the steps outlined in the article [Verify a Trust][verify-a-trust] to determine whether the trust relationship between the *contoso.com* and *treyresearch.com* domains is correctly configured.</span></span>

## <a name="next-steps"></a><span data-ttu-id="4e972-225">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="4e972-225">Next steps</span></span>

* <span data-ttu-id="4e972-226">Изучите рекомендации по [расширению локальных доменов доменных служб Active Directory в Azure][adds-extend-domain]</span><span class="sxs-lookup"><span data-stu-id="4e972-226">Learn the best practices for [extending your on-premises AD DS domain to Azure][adds-extend-domain]</span></span>
* <span data-ttu-id="4e972-227">Изучите рекомендации по [созданию инфраструктуры служб федерации Active Directory (AD FS)][adfs] в Azure.</span><span class="sxs-lookup"><span data-stu-id="4e972-227">Learn the best practices for [creating an AD FS infrastructure][adfs] in Azure.</span></span>

<!-- links -->
[adds-extend-domain]: adds-extend-domain.md
[adfs]: adfs.md

[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md

[running-VMs-for-an-N-tier-architecture-on-Azure]: ../virtual-machines-windows/n-tier.md

[ad-azure-guidelines]: https://msdn.microsoft.com/library/azure/jj156090.aspx
[azure-expressroute]: https://azure.microsoft.com/documentation/articles/expressroute-introduction/
[azure-vpn-gateway]: https://azure.microsoft.com/documentation/articles/vpn-gateway-about-vpngateways/
[considerations]: ./considerations.md
[creating-external-trusts]: https://technet.microsoft.com/library/cc816837(v=ws.10).aspx
[creating-forest-trusts]: https://technet.microsoft.com/library/cc816810(v=ws.10).aspx
[github]: https://github.com/mspnp/reference-architectures/tree/master/identity/adds-forest
[incoming-trust]: https://raw.githubusercontent.com/mspnp/reference-architectures/master/identity/adds-forest/extensions/incoming-trust.ps1
[microsoft_systems_center]: https://www.microsoft.com/server-cloud/products/system-center-2016/
[monitoring_ad]: https://msdn.microsoft.com/library/bb727046.aspx
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[solution-script]: https://raw.githubusercontent.com/mspnp/reference-architectures/master/identity/adds-forest/Deploy-ReferenceArchitecture.ps1
[standby-operations-masters]: https://technet.microsoft.com/library/cc794737(v=ws.10).aspx
[outgoing-trust]: https://raw.githubusercontent.com/mspnp/reference-architectures/master/identity/adds-forest/extensions/outgoing-trust.ps1
[verify-a-trust]: https://technet.microsoft.com/library/cc753821.aspx
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
[0]: ./images/adds-forest.png "Безопасная гибридная сетевая архитектура с несколькими доменами Active Directory"