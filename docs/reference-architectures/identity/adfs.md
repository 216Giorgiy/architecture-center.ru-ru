---
title: Развертывание локальных служб федерации Active Directory в Azure
titleSuffix: Azure Reference Architectures
description: Реализуйте защищенную гибридную сетевую архитектуру с помощью авторизации службы федерации Active Directory в Azure.
author: telmosampaio
ms.date: 12/18.2018
ms.custom: seodec18
ms.openlocfilehash: 0cdb8ce61c48189a7b708dfa022a68080040ec3d
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54111852"
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a>Расширение служб федерации Active Directory (AD FS) в Azure

Эта эталонная архитектура реализует безопасную гибридную сеть, которая расширяет вашу локальную сеть в Azure и использует [службы федерации Active Directory (AD FS)][active-directory-federation-services] для выполнения федеративной проверки подлинности и авторизации компонентов, работающих в Azure. [**Разверните это решение**](#deploy-the-solution).

![Защищенная гибридная сетевая архитектура с Active Directory](./images/adfs.png)

*Скачайте [файл Visio][visio-download] этой архитектуры.*

AD FS может размещаться в локальной среде, но если ваше приложение является гибридным, в котором некоторые части реализованы в Azure, эффективнее реплицировать AD FS в облако.

На схеме показаны следующие сценарии:

- Код приложения организации-партнера обращается к веб-приложению, размещенному внутри виртуальной сети Azure.
- Внешний зарегистрированный пользователь с учетными данными, хранящимися в доменных службах Active Directory (DS), обращается к веб-приложению, размещенному внутри виртуальной сети Azure.
- Пользователь, подключенный к виртуальной сети с помощью авторизованного устройства, запускает веб-приложение, размещенное внутри виртуальной сети Azure.

Типичные способы использования этой архитектуры:

- Гибридные приложения, в которых рабочие нагрузки выполняются частично локально и частично в Azure.
- Решения, использующие федеративную авторизацию для публикации веб-приложений в партнерских организациях.
- Системы, которые поддерживают доступ из веб-браузеров за пределами брандмауэра организации.
- Системы, которые позволяют пользователям получать доступ к веб-приложениям, подключаясь к авторизованным внешним устройствам, таким как удаленные компьютеры, ноутбуки и другие мобильные устройства.

В этой эталонной архитектуре основное внимание уделяется *пассивной федерации*, в которой серверы федерации определяют, как и когда выполнять проверку подлинности пользователя. Пользователь предоставляет сведения для входа при запуске приложения. Этот механизм чаще всего используется веб-браузерами и включает в себя протокол, который перенаправляет браузер на сайт, на котором пользователь проходит проверку подлинности. Службы федерации Active Directory поддерживают также *активную федерацию*, где приложение отвечает за предоставление учетных данных без дальнейшего участия пользователя, но этот сценарий выходит за рамки этой архитектуры.

Дополнительные рекомендации см. в статье [Выбор решения для интеграции локальной среды Active Directory с Azure][considerations].

## <a name="architecture"></a>Архитектура

Эта архитектура расширяет реализацию, описанную в статье [Расширение доменных служб Active Directory в Azure][extending-ad-to-azure]. Она содержит следующие компоненты:

- **Подсеть AD DS.** Серверы AD DS содержатся в собственной подсети с правилами группы сетевой безопасности (NSG), действующими в качестве брандмауэра.

- **Серверы AD DS.** Контроллеры домена, выполняющие функции виртуальных машин в Azure. Эти серверы предоставляют проверку подлинности локальных удостоверений в домене.

- **Подсеть AD FS.** Серверы AD FS расположены в своей собственной подсети с правилами NSG, действующими в качестве брандмауэра.

- **Серверы AD FS.** Серверы AD FS предоставляют федеративную авторизацию и проверку подлинности. В этой архитектуре они выполняют следующие задачи:

  - Получение маркеров безопасности, содержащих утверждения, сделанные сервером федерации партнера от имени пользователя партнера. Службы федерации Active Directory проверяют действительность токенов, прежде чем передавать утверждения в веб-приложение, запущенное в Azure, для авторизации запросов.

    Приложение, выполняемое в Azure, является *проверяющей стороной*. Сервер федерации партнера должен выдавать утверждения, которые распознаются веб-приложением. Серверы федерации партнера называются *партнерами по учетным записям*, так как они отправляют запросы на доступ от имени прошедших проверку подлинности учетных записей в организации партнера. Серверы AD FS называются *партнерами по ресурсам*, так как они обеспечивают доступ к ресурсам (веб-приложение).

  - Проверка подлинности и авторизация входящих запросов от внешних пользователей, работающих с веб-браузером или устройством, которым необходим доступ к веб-приложениям, с использованием доменных служб Active Directory и [службы регистрации устройств Active Directory][ADDRS].

  Серверы AD FS настроены как ферма, доступ к которой осуществляется через подсистему балансировки нагрузки Azure. Эта реализация позволяет повысить доступность и масштабируемость. Серверы AD FS недоступны напрямую в Интернете. Весь интернет-трафик фильтруется через прокси-серверы веб-приложений AD FS и промежуточную сеть (также называемую сетью периметра).

  Дополнительные сведения о работе служб федерации Active Directory см. в статье [Active Directory Federation Services Overview][active-directory-federation-services-overview] (Службы федерации Active Directory). Подробные пошаговые инструкции по реализации см. в статье [Развертывание служб федерации Active Directory в Azure][adfs-intro].

- **Подсеть прокси-сервера AD FS.** Прокси-серверы AD FS могут содержаться в собственной подсети с правилами NSG, обеспечивающими защиту. Серверы этой подсети доступны в Интернете через набор сетевых виртуальных устройств, которые обеспечивают брандмауэр между вашей виртуальной сетью Azure и Интернетом.

- **Прокси-серверы веб-приложения (WAP) AD FS.** Эти виртуальные машины действуют как серверы AD FS для входящих запросов от партнерских организаций и внешних устройств. WAP-серверы действуют как фильтр, защищая серверы AD FS от прямого доступа из Интернета. Как и для серверов AD FS, развертывание WAP-серверов в ферме с подсистемой балансировки нагрузки обеспечивает большую доступность и масштабируемость, чем развертывание коллекции автономных серверов.

  > [!NOTE]
  > Подробные сведения об установке WAP-серверов см. в статье [Установка и настройка прокси-сервера веб-приложений][install_and_configure_the_web_application_proxy_server].
  >

- **Партнерская организация.** Партнерская организация, запускающая веб-приложение, которое запрашивает доступ к веб-приложению, запущенному в Azure. Сервер федерации в партнерской организации проверяет подлинность запросов локально и отправляет маркеры безопасности, содержащие утверждения, в AD FS, работающие в Azure. Службы AD FS в Azure проверяют маркеры безопасности, и если они действительны, передают утверждения в веб-приложение, запущенное в Azure, для их авторизации.

  > [!NOTE]
  > Вы также можете настроить VPN-туннель с помощью шлюза Azure для предоставления прямого доступа к AD FS доверенным партнерам. Запросы, полученные от этих партнеров, не проходят через WAP-серверы.
  >

## <a name="recommendations"></a>Рекомендации

Следующие рекомендации применимы для большинства ситуаций. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.

### <a name="networking-recommendations"></a>Рекомендации по сети

Настройте сетевой интерфейс для каждой виртуальной машины, на которой размещены AD FS и WAP-серверы со статическими частными IP-адресами.

Не предоставляйте общедоступные IP-адреса виртуальным машинам AD FS. Дополнительные сведения см. в разделе [Вопросы безопасности](#security-considerations).

Задайте IP-адрес основных и вторичных серверов служб доменных имен (DNS) для сетевых интерфейсов каждой виртуальной машины AD FS и WAP, чтобы указать виртуальные машины AD DS. На виртуальных машинах AD DS должен быть запущен DNS. Этот шаг является обязательным для подключения каждой виртуальной машины к домену.

### <a name="ad-fs-installation"></a>Установка AD FS

В статье [Развертывание служб федерации Active Directory в Azure][Deploying_a_federation_server_farm] приведены подробные инструкции по установке и настройке служб федерации Active Directory. Выполните следующие задачи перед началом настройки первого сервера AD FS в ферме:

1. Получите общедоступный доверенный сертификат для проверки подлинности сервера. *Имя субъекта* должно содержать имя, используемое клиентами для доступа к службе федерации. Это может быть DNS-имя, зарегистрированное для подсистемы балансировки нагрузки, например *adfs.contoso.com* (из соображений безопасности не используйте подстановочные имена, такие как **.contoso.com* ). Используйте один сертификат на всех виртуальных машинах сервера AD FS. Вы можете приобрести сертификат в доверенном центре сертификации, но если ваша организация использует службы сертификатов Active Directory, вы можете создать собственный.

    *Альтернативное имя субъекта* используется службой регистрации устройств (DRS) для разрешения доступа с внешних устройств. Оно должно указываться в формате *enterpriseregistration.contoso.com*.

    Дополнительные сведения см. в статье [Managing SSL Certificates in AD FS and WAP in Windows Server 2016][adfs_certificates] (Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016).

2. На контроллере домена создайте корневой ключ для службы распределения ключей. Установите срок действия на текущее время минус 10 часов (эта конфигурация уменьшает задержку, которая может возникать при распространении и синхронизации ключей по всему домену). Этот шаг необходим для поддержки создания групповой учетной записи службы, используемой для запуска службы AD FS. В следующей команде PowerShell показан пример того, как это сделать:

    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. Добавьте все виртуальные машины сервера AD FS в домен.

> [!NOTE]
> Чтобы установить AD FS, контроллер домена, на котором выполняется роль FSMO эмулятора основного контроллера домена, должен быть запущен и доступен из виртуальных машин AD FS. <<RBC: можно ли сократить повторяемость?>>
>

### <a name="ad-fs-trust"></a>Доверие AD FS

Установите доверие федерации между установкой AD FS и серверами федерации любых партнерских организаций. Настройте требуемую фильтрацию и сопоставление утверждений.

- Сотрудники отдела DevOps в каждой партнерской организации должны добавить доверие проверяющей стороны для веб-приложений, доступных через ваши серверы AD FS.
- Сотрудники отдела DevOps в вашей организации должны настроить доверие поставщика утверждений, чтобы ваши серверы AD FS могли доверять утверждениям, предоставляемым партнерскими организациями,
- а также настроить в AD FS передачу утверждений в веб-приложения вашей организации.

Дополнительные сведения см. в статье [Establishing Federation Trust][establishing-federation-trust] (Настройка доверия федерации).

Публикуйте веб-приложения своей организации и предоставляйте их внешним партнерам, используя предварительную проверку подлинности через WAP-серверы. Дополнительные сведения см. в статье [Публикация приложений с использованием предварительной проверки подлинности AD FS][publish_applications_using_AD_FS_preauthentication].

Службы федерации Active Directory поддерживают преобразования токенов и приращение. Azure Active Directory не поддерживает эту функцию. В AD FS при настройке отношения доверия вы можете:

- Настраивать преобразования утверждений для правил авторизации. Например, вы можете сопоставить безопасность группы из представления, используемого сторонней партнерской организацией, с тем, что Active Directory DS может авторизовать в вашей организации.
- Преобразовывать утверждения из одного формата в другой. Например, вы можете сопоставить SAML 2.0 с SAML 1.1, если ваше приложение поддерживает только утверждения SAML 1.1.

### <a name="ad-fs-monitoring"></a>Мониторинг AD FS

[Пакет управления Microsoft System Center для AD FS 2012 R2][oms-adfs-pack] предоставляет средства активного и реактивного мониторинга развертывания сервера федерации AD FS. Этот пакет управления отслеживает:

- События, которые служба AD FS записывает в свои журналы событий.
- Данные о производительности, которые собирают счетчики производительности AD FS.
- Общую работоспособность системы AD FS и веб-приложений (проверяющих сторон), а также оповещения о критических проблемах и предупреждения.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Следующие аспекты, изложенные в статье [Планирование развертывания служб федерации Active Directory][plan-your-adfs-deployment], позволяют приступить к изменению размера ферм AD FS:

- Если у вас менее 1000 пользователей, не создавайте выделенные серверы, а вместо этого установите AD FS на каждом из серверов Active Directory DS в облаке. Убедитесь, что у вас есть как минимум два сервера AD DS для обеспечения доступности. Создайте один сервер WAP.
- Если у вас от 1000 до 15 000 пользователей, создайте два выделенных сервера AD FS и два выделенных сервера WAP.
- Если у вас от 15 000 до 60 000 пользователей, создайте от трех до пяти выделенных серверов AD FS и не менее двух выделенных WAP-серверов.

Предполагается, что вы используете две четырехъядерные виртуальные машины (Standard D4_v2 или лучше) в Azure.

Если вы используете внутреннюю базу данных Windows для хранения данных конфигурации AD FS, вы ограничены восемью серверами AD FS в ферме. Если предполагается, что в будущем вам понадобится больше, используйте SQL Server. Дополнительные сведения см. в статье [The Role of the AD FS Configuration Database][adfs-configuration-database] (Роль базы данных конфигурации AD FS).

## <a name="availability-considerations"></a>Вопросы доступности

Создайте ферму AD FS с как минимум двумя серверами, чтобы увеличить доступность службы. Используйте разные учетные записи для каждой виртуальной машины AD FS в ферме. Такой подход помогает гарантировать, что сбой в одной учетной записи хранения не сделает недоступной всю ферму.

Создайте отдельные группы доступности Azure для виртуальных машин AD FS и WAP. Убедитесь, что в каждой группе есть по крайней мере две виртуальные машины. Для каждой группы доступности нужно настроить по крайней мере два домена обновления и два домена сбоя.

Настройте подсистемы балансировки нагрузки для виртуальных машин AD FS и WAP следующим образом:

- Используйте подсистему балансировки нагрузки Azure для обеспечения внешнего доступа к виртуальным машинам WAP и внутреннюю систему балансировки нагрузки для распределения нагрузки между серверами AD FS в ферме.
- Передавайте на серверы AD FS и WAP только трафик с порта 443 (HTTPS).
- Предоставьте статический IP-адрес подсистеме балансировки нагрузки.
- Создайте проверку работоспособности для `/adfs/probe` с помощью HTTP. Дополнительные сведения см. в статье [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/) (Проверки работоспособности аппаратной подсистемы балансировки нагрузки и прокси-службы веб-приложения или AD FS 2012 R2).

  > [!NOTE]
  > Серверы AD FS используют протокол указания имени сервера (SNI), поэтому попытка проверки с использованием конечной точки HTTPS из подсистемы балансировки нагрузки не выполняется.
  >

- Добавьте запись *A* DNS в домен для подсистемы балансировки нагрузки AD FS. Укажите IP-адрес подсистемы балансировки нагрузки и присвойте ей имя домена (например, adfs.contoso.com). Это имя, которое клиенты и серверы WAP используют для доступа к ферме серверов AD FS.

Вы можете использовать SQL Server или внутреннюю базу данных Windows для хранения данных о конфигурации AD FS. Внутренняя база данных Windows обеспечивает основную избыточность. Изменения записываются непосредственно только в одну из баз данных AD FS в кластере AD FS, в то время как другие серверы используют репликацию по запросу, чтобы обновлять свои базы данных. Использование SQL Server обеспечивает избыточность и высокую доступность всей базы данных за счет отказоустойчивой кластеризации или зеркального отображения.

## <a name="manageability-considerations"></a>Вопросы управляемости

Сотрудники DevOps должны быть готовы выполнить следующие задачи:

- Управление серверами федерации, включая управление фермой AD FS, управление политикой доверия на серверах федерации и управление сертификатами, используемыми службами федерации.
- Управление WAP-серверами, включая управление фермой и сертификатами WAP.
- Управление веб-приложениями, включая настройку проверяющих сторон, методы проверки подлинности и сопоставления утверждений.
- Резервное копирование компонентов AD FS.

## <a name="security-considerations"></a>Вопросы безопасности

AD FS используют протокол HTTPS, поэтому убедитесь, что правила NSG для подсети, содержащей виртуальные машины веб-уровня, разрешают HTTPS-запросы. Эти запросы могут быть получены из локальной сети, подсетей, содержащих веб-уровень, бизнес-уровень, уровень данных, частную и общедоступную сеть периметра, а также подсеть, содержащую серверы AD FS.

Предотвратите прямой доступ серверов AD FS к Интернету. Серверы AD FS — это компьютеры, присоединенные к доменам, которые имеют полную авторизацию для предоставления маркеров безопасности. Если сервер взломан, злоумышленник может выдавать маркеры доступа всем веб-приложениям и всем серверам федерации, которые защищены AD FS. Если ваша система должна обрабатывать запросы от внешних пользователей, не подключающихся с сайтов доверенных партнеров, используйте WAP-серверы для обработки этих запросов. Дополнительные сведения см. в статье [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy] (Место размещения прокси-сервера федерации).

Поместите серверы AD FS и WAP-серверы в отдельные подсети со своими брандмауэрами. Для определения правил брандмауэра можно использовать правила NSG. Все брандмауэры должны пропускать трафик через порт 443 (HTTPS).

Ограничьте прямой вход на серверы AD FS и WAP. Только сотрудники DevOps должны иметь возможность подключения. Не присоединяйте серверы WAP к домену.

Для выполнения аудита рассмотрите возможность использования набора сетевых виртуальных устройств, которые регистрируют подробные сведения о трафике, пересекающем край вашей виртуальной сети.

## <a name="deploy-the-solution"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][github]. Обратите внимание, что для полного развертывания может потребоваться до двух часов, включая создание VPN-шлюза и запуск скриптов, которые настраивают доменные службы Active Directory и AD FS.

### <a name="prerequisites"></a>Предварительные требования

1. Клонируйте или скачайте ZIP-файл в [репозитории GitHub](https://github.com/mspnp/identity-reference-architectures) либо создайте для него вилку.

1. Установите [Azure CLI 2.0](/cli/azure/install-azure-cli?view=azure-cli-latest).

1. Установите пакет npm [стандартных блоков Azure](https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks).

   ```bash
   npm install -g @mspnp/azure-building-blocks
   ```

1. Из командной строки, строки bash или строки PowerShell войдите в свою учетную запись Azure, как показано ниже:

   ```bash
   az login
   ```

### <a name="deploy-the-simulated-on-premises-datacenter"></a>Развертывание имитации локального центра обработки данных

1. Перейдите в папку `adfs` в репозитории GitHub.

1. Откройте файл `onprem.json` . Найдите экземпляры `adminPassword`, `Password` и `SafeModeAdminPassword` и обновите пароли.

1. Выполните следующую команду и дождитесь завершения развертывания:

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p onprem.json --deploy
    ```

### <a name="deploy-the-azure-infrastructure"></a>Развертывание инфраструктуры Azure

1. Откройте файл `azure.json` .  Найдите экземпляры `adminPassword` и `Password` и добавьте значения для паролей.

1. Выполните следующую команду и дождитесь завершения развертывания:

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p azure.json --deploy
    ```

### <a name="set-up-the-ad-fs-farm"></a>Настройка фермы AD FS

1. Откройте файл `adfs-farm-first.json` .  Найдите `AdminPassword` и замените пароль по умолчанию.

1. Выполните следующую команду:

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p adfs-farm-first.json --deploy
    ```

1. Откройте файл `adfs-farm-rest.json` .  Найдите `AdminPassword` и замените пароль по умолчанию.

1. Выполните следующую команду и дождитесь завершения развертывания:

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p adfs-farm-rest.json --deploy
    ```

### <a name="configure-ad-fs-part-1"></a>Настройка AD FS (часть 1)

1. Откройте сеанс удаленного входа в систему к виртуальной машине `ra-adfs-jb-vm1`, который является виртуальной машиной окна перехода. Имя пользователя — `testuser`.

1. В окне перехода откройте сеанс удаленного входа в систему для виртуальной машины `ra-adfs-proxy-vm1`. Частный IP-адрес – 10.0.6.4.

1. Из этого сеанса удаленного входа в систему запустите [Интегрированную среду сценариев PowerShell](/powershell/scripting/components/ise/windows-powershell-integrated-scripting-environment--ise-).

1. В PowerShell перейдите в следующий каталог.

    ```powershell
    C:\Packages\Plugins\Microsoft.Powershell.DSC\2.77.0.0\DSCWork\adfs-v2.0
    ```

1. Вставьте следующий код в область сценариев и запустите его.

    ```powershell
    . .\adfs-webproxy.ps1
    $cd = @{
        AllNodes = @(
            @{
                NodeName = 'localhost'
                PSDscAllowPlainTextPassword = $true
                PSDscAllowDomainUser = $true
            }
        )
    }

    $c1 = Get-Credential -UserName testuser -Message "Enter password"
    InstallWebProxyApp -DomainName contoso.com -FederationName adfs.contoso.com -WebApplicationProxyName "Contoso App" -AdminCreds $c1 -ConfigurationData $cd
    Start-DscConfiguration .\InstallWebProxyApp
    ```

    В строке `Get-Credential` введите пароль, указанный в файле параметров развертывания.

1. Выполните следующую команду, чтобы отслеживать ход выполнения конфигурации [DSC](/powershell/dsc/overview/overview).

    ```powershell
    Get-DscConfigurationStatus
    ```

    Необходимо несколько минут, чтобы достичь согласованности. В течение этого времени из команды могут возникнуть ошибки. После успешного завершения конфигурации результат должен выглядеть так, как показано ниже.

    ```powershell
    PS C:\Packages\Plugins\Microsoft.Powershell.DSC\2.77.0.0\DSCWork\adfs-v2.0> Get-DscConfigurationStatus

    Status     StartDate                 Type            Mode  RebootRequested      NumberOfResources
    ------     ---------                 ----            ----  ---------------      -----------------
    Success    12/17/2018 8:21:09 PM     Consistency     PUSH  True                 4
    ```

### <a name="configure-ad-fs-part-2"></a>Настройка AD FS (часть 2)

1. В окне перехода откройте сеанс удаленного входа в систему для виртуальной машины `ra-adfs-proxy-vm2`. Частный IP-адрес – 10.0.6.5.

1. Из этого сеанса удаленного входа в систему запустите [Интегрированную среду сценариев PowerShell](/powershell/scripting/components/ise/windows-powershell-integrated-scripting-environment--ise-).

1. Перейдите в следующую папку:

    ```powershell
    C:\Packages\Plugins\Microsoft.Powershell.DSC\2.77.0.0\DSCWork\adfs-v2.0
    ```

1. Вставьте следующее в область сценариев и выполните этот сценарий:

    ```powershell
    . .\adfs-webproxy-rest.ps1
    $cd = @{
        AllNodes = @(
            @{
                NodeName = 'localhost'
                PSDscAllowPlainTextPassword = $true
                PSDscAllowDomainUser = $true
            }
        )
    }

    $c1 = Get-Credential -UserName testuser -Message "Enter password"
    InstallWebProxy -DomainName contoso.com -FederationName adfs.contoso.com -WebApplicationProxyName "Contoso App" -AdminCreds $c1 -ConfigurationData $cd
    Start-DscConfiguration .\InstallWebProxy
    ```

    В строке `Get-Credential` введите пароль, указанный в файле параметров развертывания.

1. Выполните следующую команду, чтобы отслеживать ход выполнения конфигурации.

    ```powershell
    Get-DscConfigurationStatus
    ```

    Необходимо несколько минут, чтобы достичь согласованности. В течение этого времени из команды могут возникнуть ошибки. После успешного завершения конфигурации результат должен выглядеть так, как показано ниже.

    ```powershell
    PS C:\Packages\Plugins\Microsoft.Powershell.DSC\2.77.0.0\DSCWork\adfs-v2.0> Get-DscConfigurationStatus

    Status     StartDate                 Type            Mode  RebootRequested      NumberOfResources
    ------     ---------                 ----            ----  ---------------      -----------------
    Success    12/17/2018 8:21:09 PM     Consistency     PUSH  True                 4
    ```

    Иногда происходит сбой DSC. Если проверка состояния возвращает `Status=Failure` и `Type=Consistency`, попробуйте перезапустить шаг 4.

### <a name="sign-into-ad-fs"></a>Вход в AD FS

1. В окне перехода откройте сеанс удаленного входа в систему для виртуальной машины `ra-adfs-adfs-vm1`. Частный IP-адрес – 10.0.5.4.

1. Выполните действия, описанные в разделе [Enable the Idp-Intiated Sign on page](/windows-server/identity/ad-fs/troubleshooting/ad-fs-tshoot-initiatedsignon#enable-the-idp-intiated-sign-on-page) (Включение страницы входа для поставщика удостоверений), чтобы включить страницу входа.

1. В окне перехода просмотрите `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm`. Здесь может отобразиться предупреждение сертификата, которое в этом примере можно проигнорировать.

1. Убедитесь, что отображается страница входа в корпорацию Contoso. Выполните вход с именем пользователя **contoso\testuser**.

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: /windows-server/identity/active-directory-federation-services
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  /windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: /powershell/azure/overview
[aad]: /azure/active-directory/
[aadb2c]: /azure/active-directory-b2c/
[adfs-intro]: /azure/active-directory/hybrid/whatis-hybrid-identity
[github]: https://github.com/mspnp/identity-reference-architectures/tree/master/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
