---
title: Развертывание локальных служб федерации Active Directory в Azure
titleSuffix: Azure Reference Architectures
description: Способы реализации защищенной гибридной сетевой архитектуры с помощью авторизации AD FS в Azure.
author: telmosampaio
ms.date: 11/28/2016
ms.custom: seodec18
ms.openlocfilehash: 95866961cd92f44e0925c5e47eafdc5df71652db
ms.sourcegitcommit: 88a68c7e9b6b772172b7faa4b9fd9c061a9f7e9d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2018
ms.locfileid: "53120226"
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a><span data-ttu-id="78f50-103">Расширение служб федерации Active Directory (AD FS) в Azure</span><span class="sxs-lookup"><span data-stu-id="78f50-103">Extend Active Directory Federation Services (AD FS) to Azure</span></span>

<span data-ttu-id="78f50-104">Эта эталонная архитектура реализует безопасную гибридную сеть, которая расширяет вашу локальную сеть в Azure и использует [службы федерации Active Directory (AD FS)][active-directory-federation-services] для выполнения федеративной проверки подлинности и авторизации компонентов, работающих в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-104">This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)][active-directory-federation-services] to perform federated authentication and authorization for components running in Azure.</span></span> <span data-ttu-id="78f50-105">[**Разверните это решение**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="78f50-105">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Защищенная гибридная сетевая архитектура с Active Directory](./images/adfs.png)

<span data-ttu-id="78f50-107">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="78f50-107">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="78f50-108">AD FS может размещаться в локальной среде, но если ваше приложение является гибридным, в котором некоторые части реализованы в Azure, эффективнее реплицировать AD FS в облако.</span><span class="sxs-lookup"><span data-stu-id="78f50-108">AD FS can be hosted on-premises, but if your application is a hybrid in which some parts are implemented in Azure, it may be more efficient to replicate AD FS in the cloud.</span></span>

<span data-ttu-id="78f50-109">На схеме показаны следующие сценарии:</span><span class="sxs-lookup"><span data-stu-id="78f50-109">The diagram shows the following scenarios:</span></span>

- <span data-ttu-id="78f50-110">Код приложения организации-партнера обращается к веб-приложению, размещенному внутри виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-110">Application code from a partner organization accesses a web application hosted inside your Azure VNet.</span></span>
- <span data-ttu-id="78f50-111">Внешний зарегистрированный пользователь с учетными данными, хранящимися в доменных службах Active Directory (DS), обращается к веб-приложению, размещенному внутри виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-111">An external, registered user with credentials stored inside Active Directory Domain Services (DS) accesses a web application hosted inside your Azure VNet.</span></span>
- <span data-ttu-id="78f50-112">Пользователь, подключенный к виртуальной сети с помощью авторизованного устройства, запускает веб-приложение, размещенное внутри виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-112">A user connected to your VNet using an authorized device executes a web application hosted inside your Azure VNet.</span></span>

<span data-ttu-id="78f50-113">Типичные способы использования этой архитектуры:</span><span class="sxs-lookup"><span data-stu-id="78f50-113">Typical uses for this architecture include:</span></span>

- <span data-ttu-id="78f50-114">Гибридные приложения, в которых рабочие нагрузки выполняются частично локально и частично в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-114">Hybrid applications where workloads run partly on-premises and partly in Azure.</span></span>
- <span data-ttu-id="78f50-115">Решения, использующие федеративную авторизацию для публикации веб-приложений в партнерских организациях.</span><span class="sxs-lookup"><span data-stu-id="78f50-115">Solutions that use federated authorization to expose web applications to partner organizations.</span></span>
- <span data-ttu-id="78f50-116">Системы, которые поддерживают доступ из веб-браузеров за пределами брандмауэра организации.</span><span class="sxs-lookup"><span data-stu-id="78f50-116">Systems that support access from web browsers running outside of the organizational firewall.</span></span>
- <span data-ttu-id="78f50-117">Системы, которые позволяют пользователям получать доступ к веб-приложениям, подключаясь к авторизованным внешним устройствам, таким как удаленные компьютеры, ноутбуки и другие мобильные устройства.</span><span class="sxs-lookup"><span data-stu-id="78f50-117">Systems that enable users to access to web applications by connecting from authorized external devices such as remote computers, notebooks, and other mobile devices.</span></span>

<span data-ttu-id="78f50-118">В этой эталонной архитектуре основное внимание уделяется *пассивной федерации*, в которой серверы федерации определяют, как и когда выполнять проверку подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="78f50-118">This reference architecture focuses on *passive federation*, in which the federation servers decide how and when to authenticate a user.</span></span> <span data-ttu-id="78f50-119">Пользователь предоставляет сведения для входа при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="78f50-119">The user provides sign in information when the application is started.</span></span> <span data-ttu-id="78f50-120">Этот механизм чаще всего используется веб-браузерами и включает в себя протокол, который перенаправляет браузер на сайт, на котором пользователь проходит проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="78f50-120">This mechanism is most commonly used by web browsers and involves a protocol that redirects the browser to a site where the user authenticates.</span></span> <span data-ttu-id="78f50-121">Службы федерации Active Directory поддерживают также *активную федерацию*, где приложение отвечает за предоставление учетных данных без дальнейшего участия пользователя, но этот сценарий выходит за рамки этой архитектуры.</span><span class="sxs-lookup"><span data-stu-id="78f50-121">AD FS also supports *active federation*, where an application takes on responsibility for supplying credentials without further user interaction, but that scenario is outside the scope of this architecture.</span></span>

<span data-ttu-id="78f50-122">Дополнительные рекомендации см. в статье [Выбор решения для интеграции локальной среды Active Directory с Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="78f50-122">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].-</span></span>

## <a name="architecture"></a><span data-ttu-id="78f50-123">Архитектура</span><span class="sxs-lookup"><span data-stu-id="78f50-123">Architecture</span></span>

<span data-ttu-id="78f50-124">Эта архитектура расширяет реализацию, описанную в статье [Расширение доменных служб Active Directory в Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="78f50-124">This architecture extends the implementation described in [Extending AD DS to Azure][extending-ad-to-azure].</span></span> <span data-ttu-id="78f50-125">Она содержит следующие компоненты:</span><span class="sxs-lookup"><span data-stu-id="78f50-125">It contains the followign components.</span></span>

- <span data-ttu-id="78f50-126">**Подсеть AD DS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-126">**AD DS subnet**.</span></span> <span data-ttu-id="78f50-127">Серверы AD DS содержатся в собственной подсети с правилами группы сетевой безопасности (NSG), действующими в качестве брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="78f50-127">The AD DS servers are contained in their own subnet with network security group (NSG) rules acting as a firewall.</span></span>

- <span data-ttu-id="78f50-128">**Серверы AD DS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-128">**AD DS servers**.</span></span> <span data-ttu-id="78f50-129">Контроллеры домена, выполняющие функции виртуальных машин в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-129">Domain controllers running as VMs in Azure.</span></span> <span data-ttu-id="78f50-130">Эти серверы предоставляют проверку подлинности локальных удостоверений в домене.</span><span class="sxs-lookup"><span data-stu-id="78f50-130">These servers provide authentication of local identities within the domain.</span></span>

- <span data-ttu-id="78f50-131">**Подсеть AD FS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-131">**AD FS subnet**.</span></span> <span data-ttu-id="78f50-132">Серверы AD FS расположены в своей собственной подсети с правилами NSG, действующими в качестве брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="78f50-132">The AD FS servers are located within their own subnet with NSG rules acting as a firewall.</span></span>

- <span data-ttu-id="78f50-133">**Серверы AD FS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-133">**AD FS servers**.</span></span> <span data-ttu-id="78f50-134">Серверы AD FS предоставляют федеративную авторизацию и проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="78f50-134">The AD FS servers provide federated authorization and authentication.</span></span> <span data-ttu-id="78f50-135">В этой архитектуре они выполняют следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="78f50-135">In this architecture, they perform the following tasks:</span></span>

  - <span data-ttu-id="78f50-136">Получение маркеров безопасности, содержащих утверждения, сделанные сервером федерации партнера от имени пользователя партнера.</span><span class="sxs-lookup"><span data-stu-id="78f50-136">Receiving security tokens containing claims made by a partner federation server on behalf of a partner user.</span></span> <span data-ttu-id="78f50-137">Службы федерации Active Directory проверяют действительность токенов, прежде чем передавать утверждения в веб-приложение, запущенное в Azure, для авторизации запросов.</span><span class="sxs-lookup"><span data-stu-id="78f50-137">AD FS verifies that the tokens are valid before passing the claims to the web application running in Azure to authorize requests.</span></span>

    <span data-ttu-id="78f50-138">Веб-приложение, работающее в Azure, является *проверяющей стороной*.</span><span class="sxs-lookup"><span data-stu-id="78f50-138">The web application running in Azure is the *relying party*.</span></span> <span data-ttu-id="78f50-139">Сервер федерации партнера должен выдавать утверждения, которые распознаются веб-приложением.</span><span class="sxs-lookup"><span data-stu-id="78f50-139">The partner federation server must issue claims that are understood by the web application.</span></span> <span data-ttu-id="78f50-140">Серверы федерации партнера называются *партнерами по учетным записям*, так как они отправляют запросы на доступ от имени прошедших проверку подлинности учетных записей в организации партнера.</span><span class="sxs-lookup"><span data-stu-id="78f50-140">The partner federation servers are referred to as *account partners*, because they submit access requests on behalf of authenticated accounts in the partner organization.</span></span> <span data-ttu-id="78f50-141">Серверы AD FS называются *партнерами по ресурсам*, так как они обеспечивают доступ к ресурсам (веб-приложение).</span><span class="sxs-lookup"><span data-stu-id="78f50-141">The AD FS servers are called *resource partners* because they provide access to resources (the web application).</span></span>

  - <span data-ttu-id="78f50-142">Проверка подлинности и авторизация входящих запросов от внешних пользователей, работающих с веб-браузером или устройством, которым необходим доступ к веб-приложениям, с использованием доменных служб Active Directory и [службы регистрации устройств Active Directory][ADDRS].</span><span class="sxs-lookup"><span data-stu-id="78f50-142">Authenticating and authorizing incoming requests from external users running a web browser or device that needs access to web applications, by using AD DS and the [Active Directory Device Registration Service][ADDRS].</span></span>

  <span data-ttu-id="78f50-143">Серверы AD FS настроены как ферма, доступ к которой осуществляется через подсистему балансировки нагрузки Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-143">The AD FS servers are configured as a farm accessed through an Azure load balancer.</span></span> <span data-ttu-id="78f50-144">Эта реализация позволяет повысить доступность и масштабируемость.</span><span class="sxs-lookup"><span data-stu-id="78f50-144">This implementation improves availability and scalability.</span></span> <span data-ttu-id="78f50-145">Серверы AD FS недоступны напрямую в Интернете.</span><span class="sxs-lookup"><span data-stu-id="78f50-145">The AD FS servers are not exposed directly to the Internet.</span></span> <span data-ttu-id="78f50-146">Весь интернет-трафик фильтруется через прокси-серверы веб-приложений AD FS и промежуточную сеть (также называемую сетью периметра).</span><span class="sxs-lookup"><span data-stu-id="78f50-146">All Internet traffic is filtered through AD FS web application proxy servers and a DMZ (also referred to as a perimeter network).</span></span>

  <span data-ttu-id="78f50-147">Дополнительные сведения о работе служб федерации Active Directory см. в статье [Active Directory Federation Services Overview][active-directory-federation-services-overview] (Службы федерации Active Directory).</span><span class="sxs-lookup"><span data-stu-id="78f50-147">For more information about how AD FS works, see [Active Directory Federation Services Overview][active-directory-federation-services-overview].</span></span> <span data-ttu-id="78f50-148">Подробные пошаговые инструкции по реализации см. в статье [Развертывание служб федерации Active Directory в Azure][adfs-intro].</span><span class="sxs-lookup"><span data-stu-id="78f50-148">Also, the article [AD FS deployment in Azure][adfs-intro] contains a detailed step-by-step introduction to implementation.</span></span>

- <span data-ttu-id="78f50-149">**Подсеть прокси-сервера AD FS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-149">**AD FS proxy subnet**.</span></span> <span data-ttu-id="78f50-150">Прокси-серверы AD FS могут содержаться в собственной подсети с правилами NSG, обеспечивающими защиту.</span><span class="sxs-lookup"><span data-stu-id="78f50-150">The AD FS proxy servers can be contained within their own subnet, with NSG rules providing protection.</span></span> <span data-ttu-id="78f50-151">Серверы этой подсети доступны в Интернете через набор сетевых виртуальных устройств, которые обеспечивают брандмауэр между вашей виртуальной сетью Azure и Интернетом.</span><span class="sxs-lookup"><span data-stu-id="78f50-151">The servers in this subnet are exposed to the Internet through a set of network virtual appliances that provide a firewall between your Azure virtual network and the Internet.</span></span>

- <span data-ttu-id="78f50-152">**Прокси-серверы веб-приложения (WAP) AD FS.**</span><span class="sxs-lookup"><span data-stu-id="78f50-152">**AD FS web application proxy (WAP) servers**.</span></span> <span data-ttu-id="78f50-153">Эти виртуальные машины действуют как серверы AD FS для входящих запросов от партнерских организаций и внешних устройств.</span><span class="sxs-lookup"><span data-stu-id="78f50-153">These VMs act as AD FS servers for incoming requests from partner organizations and external devices.</span></span> <span data-ttu-id="78f50-154">WAP-серверы действуют как фильтр, защищая серверы AD FS от прямого доступа из Интернета.</span><span class="sxs-lookup"><span data-stu-id="78f50-154">The WAP servers act as a filter, shielding the AD FS servers from direct access from the Internet.</span></span> <span data-ttu-id="78f50-155">Как и для серверов AD FS, развертывание WAP-серверов в ферме с подсистемой балансировки нагрузки обеспечивает большую доступность и масштабируемость, чем развертывание коллекции автономных серверов.</span><span class="sxs-lookup"><span data-stu-id="78f50-155">As with the AD FS servers, deploying the WAP servers in a farm with load balancing gives you greater availability and scalability than deploying a collection of stand-alone servers.</span></span>

  > [!NOTE]
  > <span data-ttu-id="78f50-156">Подробные сведения об установке WAP-серверов см. в статье [Установка и настройка прокси-сервера веб-приложений][install_and_configure_the_web_application_proxy_server].</span><span class="sxs-lookup"><span data-stu-id="78f50-156">For detailed information about installing WAP servers, see [Install and Configure the Web Application Proxy Server][install_and_configure_the_web_application_proxy_server]</span></span>
  >

- <span data-ttu-id="78f50-157">**Партнерская организация.**</span><span class="sxs-lookup"><span data-stu-id="78f50-157">**Partner organization**.</span></span> <span data-ttu-id="78f50-158">Партнерская организация, запускающая веб-приложение, которое запрашивает доступ к веб-приложению, запущенному в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-158">A partner organization running a web application that requests access to a web application running in Azure.</span></span> <span data-ttu-id="78f50-159">Сервер федерации в партнерской организации проверяет подлинность запросов локально и отправляет маркеры безопасности, содержащие утверждения, в AD FS, работающие в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-159">The federation server at the partner organization authenticates requests locally, and submits security tokens containing claims to AD FS running in Azure.</span></span> <span data-ttu-id="78f50-160">Службы AD FS в Azure проверяют маркеры безопасности, и если они действительны, передают утверждения в веб-приложение, запущенное в Azure, для их авторизации.</span><span class="sxs-lookup"><span data-stu-id="78f50-160">AD FS in Azure validates the security tokens, and if valid can pass the claims to the web application running in Azure to authorize them.</span></span>

  > [!NOTE]
  > <span data-ttu-id="78f50-161">Вы также можете настроить VPN-туннель с помощью шлюза Azure для предоставления прямого доступа к AD FS доверенным партнерам.</span><span class="sxs-lookup"><span data-stu-id="78f50-161">You can also configure a VPN tunnel using Azure gateway to provide direct access to AD FS for trusted partners.</span></span> <span data-ttu-id="78f50-162">Запросы, полученные от этих партнеров, не проходят через WAP-серверы.</span><span class="sxs-lookup"><span data-stu-id="78f50-162">Requests received from these partners do not pass through the WAP servers.</span></span>
  >

<span data-ttu-id="78f50-163">Дополнительные сведения о компонентах архитектуры, не относящихся к AD FS, см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="78f50-163">For more information about the parts of the architecture that are not related to AD FS, see the following:</span></span>

- <span data-ttu-id="78f50-164">[Реализация архитектуры защищенной гибридной сети в Azure][implementing-a-secure-hybrid-network-architecture]</span><span class="sxs-lookup"><span data-stu-id="78f50-164">[Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture]</span></span>
- <span data-ttu-id="78f50-165">[Сеть периметра между Azure и Интернетом][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span><span class="sxs-lookup"><span data-stu-id="78f50-165">[Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span></span>
- <span data-ttu-id="78f50-166">[Расширение доменных служб Active Directory в Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="78f50-166">[Implementing a secure hybrid network architecture with Active Directory identities in Azure][extending-ad-to-azure].</span></span>

## <a name="recommendations"></a><span data-ttu-id="78f50-167">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="78f50-167">Recommendations</span></span>

<span data-ttu-id="78f50-168">Следующие рекомендации применимы для большинства ситуаций.</span><span class="sxs-lookup"><span data-stu-id="78f50-168">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="78f50-169">Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.</span><span class="sxs-lookup"><span data-stu-id="78f50-169">Follow these recommendations unless you have a specific requirement that overrides them.</span></span>

### <a name="vm-recommendations"></a><span data-ttu-id="78f50-170">Рекомендации по виртуальным машинам</span><span class="sxs-lookup"><span data-stu-id="78f50-170">VM recommendations</span></span>

<span data-ttu-id="78f50-171">Создайте виртуальные машины с достаточным объемом ресурсов для обработки ожидаемого объема трафика.</span><span class="sxs-lookup"><span data-stu-id="78f50-171">Create VMs with sufficient resources to handle the expected volume of traffic.</span></span> <span data-ttu-id="78f50-172">В качестве отправной точки используйте размер имеющихся компьютеров, на которых размещаются AD FS в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="78f50-172">Use the size of the existing machines hosting AD FS on premises as a starting point.</span></span> <span data-ttu-id="78f50-173">Отслеживайте использование ресурсов.</span><span class="sxs-lookup"><span data-stu-id="78f50-173">Monitor the resource utilization.</span></span> <span data-ttu-id="78f50-174">Вы можете изменить размер виртуальных машин и уменьшить масштаб, если они слишком велики.</span><span class="sxs-lookup"><span data-stu-id="78f50-174">You can resize the VMs and scale down if they are too large.</span></span>

<span data-ttu-id="78f50-175">Следуйте рекомендациям, приведенным в статье [Запуск виртуальной машины Windows в Azure][vm-recommendations].</span><span class="sxs-lookup"><span data-stu-id="78f50-175">Follow the recommendations listed in [Running a Windows VM on Azure][vm-recommendations].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="78f50-176">Рекомендации по сети</span><span class="sxs-lookup"><span data-stu-id="78f50-176">Networking recommendations</span></span>

<span data-ttu-id="78f50-177">Настройте сетевой интерфейс для каждой виртуальной машины, на которой размещены AD FS и WAP-серверы со статическими частными IP-адресами.</span><span class="sxs-lookup"><span data-stu-id="78f50-177">Configure the network interface for each of the VMs hosting AD FS and WAP servers with static private IP addresses.</span></span>

<span data-ttu-id="78f50-178">Не предоставляйте общедоступные IP-адреса виртуальным машинам AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-178">Do not give the AD FS VMs public IP addresses.</span></span> <span data-ttu-id="78f50-179">Дополнительные сведения см. в разделе рекомендаций по обеспечению безопасности.</span><span class="sxs-lookup"><span data-stu-id="78f50-179">For more information, see the Security considerations section.</span></span>

<span data-ttu-id="78f50-180">Задайте IP-адрес основных и вторичных серверов служб доменных имен (DNS) для сетевых интерфейсов каждой виртуальной машины AD FS и WAP, чтобы указать виртуальные машины AD DS.</span><span class="sxs-lookup"><span data-stu-id="78f50-180">Set the IP address of the preferred and secondary domain name service (DNS) servers for the network interfaces for each AD FS and WAP VM to reference the Active Directory DS VMs.</span></span> <span data-ttu-id="78f50-181">На виртуальных машинах AD DS должен быть запущен DNS.</span><span class="sxs-lookup"><span data-stu-id="78f50-181">The Active Directory DS VMS should be running DNS.</span></span> <span data-ttu-id="78f50-182">Этот шаг является обязательным для подключения каждой виртуальной машины к домену.</span><span class="sxs-lookup"><span data-stu-id="78f50-182">This step is necessary to enable each VM to join the domain.</span></span>

### <a name="ad-fs-availability"></a><span data-ttu-id="78f50-183">Доступность AD FS</span><span class="sxs-lookup"><span data-stu-id="78f50-183">AD FS availability</span></span>

<span data-ttu-id="78f50-184">Создайте ферму AD FS с как минимум двумя серверами, чтобы увеличить доступность службы.</span><span class="sxs-lookup"><span data-stu-id="78f50-184">Create an AD FS farm with at least two servers to increase availability of the service.</span></span> <span data-ttu-id="78f50-185">Используйте разные учетные записи для каждой виртуальной машины AD FS в ферме.</span><span class="sxs-lookup"><span data-stu-id="78f50-185">Use different storage accounts for each AD FS VM in the farm.</span></span> <span data-ttu-id="78f50-186">Такой подход помогает гарантировать, что сбой в одной учетной записи хранения не сделает недоступной всю ферму.</span><span class="sxs-lookup"><span data-stu-id="78f50-186">This approach helps to ensure that a failure in a single storage account does not make the entire farm inaccessible.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="78f50-187">Мы также рекомендуем использовать [управляемые диски](/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="78f50-187">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="78f50-188">Управляемым дискам не требуется учетная запись хранения.</span><span class="sxs-lookup"><span data-stu-id="78f50-188">Managed disks do not require a storage account.</span></span> <span data-ttu-id="78f50-189">Просто укажите размер и тип диска, и он будет развернут в качестве высокодоступного.</span><span class="sxs-lookup"><span data-stu-id="78f50-189">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span> <span data-ttu-id="78f50-190">Сейчас наши [эталонные архитектуры](/azure/architecture/reference-architectures/) не развертывают управляемые диски, но [стандартные блоки шаблона](https://github.com/mspnp/template-building-blocks/wiki) будут обновлены для развертывания управляемых дисков в версии 2.</span><span class="sxs-lookup"><span data-stu-id="78f50-190">Our [reference architectures](/azure/architecture/reference-architectures/) do not currently deploy managed disks but the [template building blocks](https://github.com/mspnp/template-building-blocks/wiki) will be updated to deploy managed disks in version 2.</span></span>

<span data-ttu-id="78f50-191">Создайте отдельные группы доступности Azure для виртуальных машин AD FS и WAP.</span><span class="sxs-lookup"><span data-stu-id="78f50-191">Create separate Azure availability sets for the AD FS and WAP VMs.</span></span> <span data-ttu-id="78f50-192">Убедитесь, что в каждой группе есть по крайней мере две виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="78f50-192">Ensure that there are at least two VMs in each set.</span></span> <span data-ttu-id="78f50-193">Для каждой группы доступности нужно настроить по крайней мере два домена обновления и два домена сбоя.</span><span class="sxs-lookup"><span data-stu-id="78f50-193">Each availability set must have at least two update domains and two fault domains.</span></span>

<span data-ttu-id="78f50-194">Настройте подсистемы балансировки нагрузки для виртуальных машин AD FS и WAP следующим образом:</span><span class="sxs-lookup"><span data-stu-id="78f50-194">Configure the load balancers for the AD FS VMs and WAP VMs as follows:</span></span>

- <span data-ttu-id="78f50-195">Используйте подсистему балансировки нагрузки Azure для обеспечения внешнего доступа к виртуальным машинам WAP и внутреннюю систему балансировки нагрузки для распределения нагрузки между серверами AD FS в ферме.</span><span class="sxs-lookup"><span data-stu-id="78f50-195">Use an Azure load balancer to provide external access to the WAP VMs, and an internal load balancer to distribute the load across the AD FS servers in the farm.</span></span>
- <span data-ttu-id="78f50-196">Передавайте на серверы AD FS и WAP только трафик с порта 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="78f50-196">Only pass traffic appearing on port 443 (HTTPS) to the AD FS/WAP servers.</span></span>
- <span data-ttu-id="78f50-197">Предоставьте статический IP-адрес подсистеме балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="78f50-197">Give the load balancer a static IP address.</span></span>
- <span data-ttu-id="78f50-198">Создайте проверку работоспособности для `/adfs/probe` с помощью HTTP.</span><span class="sxs-lookup"><span data-stu-id="78f50-198">Create a health probe using HTTP against `/adfs/probe`.</span></span> <span data-ttu-id="78f50-199">Дополнительные сведения см. в статье [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/) (Проверки работоспособности аппаратной подсистемы балансировки нагрузки и прокси-службы веб-приложения или AD FS 2012 R2).</span><span class="sxs-lookup"><span data-stu-id="78f50-199">For more information, see [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/).</span></span>

  > [!NOTE]
  > <span data-ttu-id="78f50-200">Серверы AD FS используют протокол указания имени сервера (SNI), поэтому попытка проверки с использованием конечной точки HTTPS из подсистемы балансировки нагрузки не выполняется.</span><span class="sxs-lookup"><span data-stu-id="78f50-200">AD FS servers use the Server Name Indication (SNI) protocol, so attempting to probe using an HTTPS endpoint from the load balancer fails.</span></span>
  >

- <span data-ttu-id="78f50-201">Добавьте запись *A* DNS в домен для подсистемы балансировки нагрузки AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-201">Add a DNS *A* record to the domain for the AD FS load balancer.</span></span> <span data-ttu-id="78f50-202">Укажите IP-адрес подсистемы балансировки нагрузки и присвойте ей имя домена (например, adfs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="78f50-202">Specify the IP address of the load balancer, and give it a name in the domain (such as adfs.contoso.com).</span></span> <span data-ttu-id="78f50-203">Это имя, которое клиенты и серверы WAP используют для доступа к ферме серверов AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-203">This is the name clients and the WAP servers use to access the AD FS server farm.</span></span>

### <a name="ad-fs-security"></a><span data-ttu-id="78f50-204">Безопасность AD FS</span><span class="sxs-lookup"><span data-stu-id="78f50-204">AD FS security</span></span>

<span data-ttu-id="78f50-205">Предотвратите прямой доступ серверов AD FS к Интернету.</span><span class="sxs-lookup"><span data-stu-id="78f50-205">Prevent direct exposure of the AD FS servers to the Internet.</span></span> <span data-ttu-id="78f50-206">Серверы AD FS — это компьютеры, присоединенные к доменам, которые имеют полную авторизацию для предоставления маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="78f50-206">AD FS servers are domain-joined computers that have full authorization to grant security tokens.</span></span> <span data-ttu-id="78f50-207">Если сервер взломан, злоумышленник может выдавать маркеры доступа всем веб-приложениям и всем серверам федерации, которые защищены AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-207">If a server is compromised, a malicious user can issue full access tokens to all web applications and to all federation servers that are protected by AD FS.</span></span> <span data-ttu-id="78f50-208">Если ваша система должна обрабатывать запросы от внешних пользователей, не подключающихся с сайтов доверенных партнеров, используйте WAP-серверы для обработки этих запросов.</span><span class="sxs-lookup"><span data-stu-id="78f50-208">If your system must handle requests from external users not connecting from trusted partner sites, use WAP servers to handle these requests.</span></span> <span data-ttu-id="78f50-209">Дополнительные сведения см. в статье [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy] (Место размещения прокси-сервера федерации).</span><span class="sxs-lookup"><span data-stu-id="78f50-209">For more information, see [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy].</span></span>

<span data-ttu-id="78f50-210">Поместите серверы AD FS и WAP-серверы в отдельные подсети со своими брандмауэрами.</span><span class="sxs-lookup"><span data-stu-id="78f50-210">Place AD FS servers and WAP servers in separate subnets with their own firewalls.</span></span> <span data-ttu-id="78f50-211">Для определения правил брандмауэра можно использовать правила NSG.</span><span class="sxs-lookup"><span data-stu-id="78f50-211">You can use NSG rules to define firewall rules.</span></span> <span data-ttu-id="78f50-212">Если вам требуется полная защита, вы можете реализовать дополнительный периметр безопасности вокруг серверов, используя пару подсетей и сетевых виртуальных устройств (NVA), как описано в статье [Сеть периметра между Azure и Интернетом][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="78f50-212">If you require more comprehensive protection you can implement an additional security perimeter around servers by using a pair of subnets and network virtual appliances (NVAs), as described in the document [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="78f50-213">Все брандмауэры должны пропускать трафик через порт 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="78f50-213">All firewalls should allow traffic on port 443 (HTTPS).</span></span>

<span data-ttu-id="78f50-214">Ограничьте прямой вход на серверы AD FS и WAP.</span><span class="sxs-lookup"><span data-stu-id="78f50-214">Restrict direct sign in access to the AD FS and WAP servers.</span></span> <span data-ttu-id="78f50-215">Только сотрудники DevOps должны иметь возможность подключения.</span><span class="sxs-lookup"><span data-stu-id="78f50-215">Only DevOps staff should be able to connect.</span></span>

<span data-ttu-id="78f50-216">Не присоединяйте серверы WAP к домену.</span><span class="sxs-lookup"><span data-stu-id="78f50-216">Do not join the WAP servers to the domain.</span></span>

### <a name="ad-fs-installation"></a><span data-ttu-id="78f50-217">Установка AD FS</span><span class="sxs-lookup"><span data-stu-id="78f50-217">AD FS installation</span></span>

<span data-ttu-id="78f50-218">В статье [Развертывание служб федерации Active Directory в Azure][Deploying_a_federation_server_farm] приведены подробные инструкции по установке и настройке служб федерации Active Directory.</span><span class="sxs-lookup"><span data-stu-id="78f50-218">The article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] provides detailed instructions for installing and configuring AD FS.</span></span> <span data-ttu-id="78f50-219">Выполните следующие задачи перед началом настройки первого сервера AD FS в ферме:</span><span class="sxs-lookup"><span data-stu-id="78f50-219">Perform the following tasks before configuring the first AD FS server in the farm:</span></span>

1. <span data-ttu-id="78f50-220">Получите общедоступный доверенный сертификат для проверки подлинности сервера.</span><span class="sxs-lookup"><span data-stu-id="78f50-220">Obtain a publicly trusted certificate for performing server authentication.</span></span> <span data-ttu-id="78f50-221">*Имя субъекта* должно содержать имя, используемое клиентами для доступа к службе федерации.</span><span class="sxs-lookup"><span data-stu-id="78f50-221">The *subject name* must contain the name clients use to access the federation service.</span></span> <span data-ttu-id="78f50-222">Это может быть DNS-имя, зарегистрированное для подсистемы балансировки нагрузки, например *adfs.contoso.com* (из соображений безопасности не используйте подстановочные имена, такие как \**.contoso.com* ).</span><span class="sxs-lookup"><span data-stu-id="78f50-222">This can be the DNS name registered for the load balancer, for example, *adfs.contoso.com* (avoid using wildcard names such as \**.contoso.com*, for security reasons).</span></span> <span data-ttu-id="78f50-223">Используйте один сертификат на всех виртуальных машинах сервера AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-223">Use the same certificate on all AD FS server VMs.</span></span> <span data-ttu-id="78f50-224">Вы можете приобрести сертификат в доверенном центре сертификации, но если ваша организация использует службы сертификатов Active Directory, вы можете создать собственный.</span><span class="sxs-lookup"><span data-stu-id="78f50-224">You can purchase a certificate from a trusted certification authority, but if your organization uses Active Directory Certificate Services you can create your own.</span></span>

    <span data-ttu-id="78f50-225">*Альтернативное имя субъекта* используется службой регистрации устройств (DRS) для разрешения доступа с внешних устройств.</span><span class="sxs-lookup"><span data-stu-id="78f50-225">The *subject alternative name* is used by the device registration service (DRS) to enable access from external devices.</span></span> <span data-ttu-id="78f50-226">Оно должно указываться в формате *enterpriseregistration.contoso.com*.</span><span class="sxs-lookup"><span data-stu-id="78f50-226">This should be of the form *enterpriseregistration.contoso.com*.</span></span>

    <span data-ttu-id="78f50-227">Дополнительные сведения см. в статье [Managing SSL Certificates in AD FS and WAP in Windows Server 2016][adfs_certificates] (Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016).</span><span class="sxs-lookup"><span data-stu-id="78f50-227">For more information, see [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates].</span></span>

2. <span data-ttu-id="78f50-228">На контроллере домена создайте корневой ключ для службы распределения ключей.</span><span class="sxs-lookup"><span data-stu-id="78f50-228">On the domain controller, generate a new root key for the Key Distribution Service.</span></span> <span data-ttu-id="78f50-229">Установите срок действия на текущее время минус 10 часов (эта конфигурация уменьшает задержку, которая может возникать при распространении и синхронизации ключей по всему домену).</span><span class="sxs-lookup"><span data-stu-id="78f50-229">Set the effective time to the current time minus 10 hours (this configuration reduces the delay that can occur in distributing and synchronizing keys across the domain).</span></span> <span data-ttu-id="78f50-230">Этот шаг необходим для поддержки создания групповой учетной записи службы, используемой для запуска службы AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-230">This step is necessary to support creating the group service account that is used to run the AD FS service.</span></span> <span data-ttu-id="78f50-231">В следующей команде PowerShell показан пример того, как это сделать:</span><span class="sxs-lookup"><span data-stu-id="78f50-231">The following PowerShell command shows an example of how to do this:</span></span>

    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. <span data-ttu-id="78f50-232">Добавьте все виртуальные машины сервера AD FS в домен.</span><span class="sxs-lookup"><span data-stu-id="78f50-232">Add each AD FS server VM to the domain.</span></span>

> [!NOTE]
> <span data-ttu-id="78f50-233">Чтобы установить AD FS, контроллер домена, на котором выполняется роль FSMO эмулятора основного контроллера домена, должен быть запущен и доступен из виртуальных машин AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-233">To install AD FS, the domain controller running the primary domain controller (PDC) emulator flexible single master operation (FSMO) role for the domain must be running and accessible from the AD FS VMs.</span></span> <span data-ttu-id="78f50-234"><<RBC: можно ли сократить повторяемость?>></span><span class="sxs-lookup"><span data-stu-id="78f50-234"><<RBC: Is there a way to make this less repetitive?>></span></span>
>

### <a name="ad-fs-trust"></a><span data-ttu-id="78f50-235">Доверие AD FS</span><span class="sxs-lookup"><span data-stu-id="78f50-235">AD FS trust</span></span>

<span data-ttu-id="78f50-236">Установите доверие федерации между установкой AD FS и серверами федерации любых партнерских организаций.</span><span class="sxs-lookup"><span data-stu-id="78f50-236">Establish federation trust between your AD FS installation, and the federation servers of any partner organizations.</span></span> <span data-ttu-id="78f50-237">Настройте требуемую фильтрацию и сопоставление утверждений.</span><span class="sxs-lookup"><span data-stu-id="78f50-237">Configure any claims filtering and mapping required.</span></span>

- <span data-ttu-id="78f50-238">Сотрудники отдела DevOps в каждой партнерской организации должны добавить доверие проверяющей стороны для веб-приложений, доступных через ваши серверы AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-238">DevOps staff at each partner organization must add a relying party trust for the web applications accessible through your AD FS servers.</span></span>
- <span data-ttu-id="78f50-239">Сотрудники отдела DevOps в вашей организации должны настроить доверие поставщика утверждений, чтобы ваши серверы AD FS могли доверять утверждениям, предоставляемым партнерскими организациями,</span><span class="sxs-lookup"><span data-stu-id="78f50-239">DevOps staff in your organization must configure claims-provider trust to enable your AD FS servers to trust the claims that partner organizations provide.</span></span>
- <span data-ttu-id="78f50-240">а также настроить в AD FS передачу утверждений в веб-приложения вашей организации.</span><span class="sxs-lookup"><span data-stu-id="78f50-240">DevOps staff in your organization must also configure AD FS to pass claims on to your organization's web applications.</span></span>

<span data-ttu-id="78f50-241">Дополнительные сведения см. в статье [Establishing Federation Trust][establishing-federation-trust] (Настройка доверия федерации).</span><span class="sxs-lookup"><span data-stu-id="78f50-241">For more information, see [Establishing Federation Trust][establishing-federation-trust].</span></span>

<span data-ttu-id="78f50-242">Публикуйте веб-приложения своей организации и предоставляйте их внешним партнерам, используя предварительную проверку подлинности через WAP-серверы.</span><span class="sxs-lookup"><span data-stu-id="78f50-242">Publish your organization's web applications and make them available to external partners by using preauthentication through the WAP servers.</span></span> <span data-ttu-id="78f50-243">Дополнительные сведения см. в статье [Публикация приложений с использованием предварительной проверки подлинности AD FS][publish_applications_using_AD_FS_preauthentication].</span><span class="sxs-lookup"><span data-stu-id="78f50-243">For more information, see [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication]</span></span>

<span data-ttu-id="78f50-244">Службы федерации Active Directory поддерживают преобразования токенов и приращение.</span><span class="sxs-lookup"><span data-stu-id="78f50-244">AD FS supports token transformation and augmentation.</span></span> <span data-ttu-id="78f50-245">Azure Active Directory не поддерживает эту функцию.</span><span class="sxs-lookup"><span data-stu-id="78f50-245">Azure Active Directory does not provide this feature.</span></span> <span data-ttu-id="78f50-246">В AD FS при настройке отношения доверия вы можете:</span><span class="sxs-lookup"><span data-stu-id="78f50-246">With AD FS, when you set up the trust relationships, you can:</span></span>

- <span data-ttu-id="78f50-247">Настраивать преобразования утверждений для правил авторизации.</span><span class="sxs-lookup"><span data-stu-id="78f50-247">Configure claim transformations for authorization rules.</span></span> <span data-ttu-id="78f50-248">Например, вы можете сопоставить безопасность группы из представления, используемого сторонней партнерской организацией, с тем, что Active Directory DS может авторизовать в вашей организации.</span><span class="sxs-lookup"><span data-stu-id="78f50-248">For example, you can map group security from a representation used by a non-Microsoft partner organization to something that that Active Directory DS can authorize in your organization.</span></span>
- <span data-ttu-id="78f50-249">Преобразовывать утверждения из одного формата в другой.</span><span class="sxs-lookup"><span data-stu-id="78f50-249">Transform claims from one format to another.</span></span> <span data-ttu-id="78f50-250">Например, вы можете сопоставить SAML 2.0 с SAML 1.1, если ваше приложение поддерживает только утверждения SAML 1.1.</span><span class="sxs-lookup"><span data-stu-id="78f50-250">For example, you can map from SAML 2.0 to SAML 1.1 if your application only supports SAML 1.1 claims.</span></span>

### <a name="ad-fs-monitoring"></a><span data-ttu-id="78f50-251">Мониторинг AD FS</span><span class="sxs-lookup"><span data-stu-id="78f50-251">AD FS monitoring</span></span>

<span data-ttu-id="78f50-252">[Пакет управления Microsoft System Center для AD FS 2012 R2][oms-adfs-pack] предоставляет средства активного и реактивного мониторинга развертывания сервера федерации AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-252">The [Microsoft System Center Management Pack for Active Directory Federation Services 2012 R2][oms-adfs-pack] provides both proactive and reactive monitoring of your AD FS deployment for the federation server.</span></span> <span data-ttu-id="78f50-253">Этот пакет управления отслеживает:</span><span class="sxs-lookup"><span data-stu-id="78f50-253">This management pack monitors:</span></span>

- <span data-ttu-id="78f50-254">События, которые служба AD FS записывает в свои журналы событий.</span><span class="sxs-lookup"><span data-stu-id="78f50-254">Events that the AD FS service records in its event logs.</span></span>
- <span data-ttu-id="78f50-255">Данные о производительности, которые собирают счетчики производительности AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-255">The performance data that the AD FS performance counters collect.</span></span>
- <span data-ttu-id="78f50-256">Общую работоспособность системы AD FS и веб-приложений (проверяющих сторон), а также оповещения о критических проблемах и предупреждения.</span><span class="sxs-lookup"><span data-stu-id="78f50-256">The overall health of the AD FS system and web applications (relying parties), and provides alerts for critical issues and warnings.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="78f50-257">Вопросы масштабируемости</span><span class="sxs-lookup"><span data-stu-id="78f50-257">Scalability considerations</span></span>

<span data-ttu-id="78f50-258">Следующие аспекты, изложенные в статье [Планирование развертывания служб федерации Active Directory][plan-your-adfs-deployment], позволяют приступить к изменению размера ферм AD FS:</span><span class="sxs-lookup"><span data-stu-id="78f50-258">The following considerations, summarized from the article [Plan your AD FS deployment][plan-your-adfs-deployment], give a starting point for sizing AD FS farms:</span></span>

- <span data-ttu-id="78f50-259">Если у вас менее 1000 пользователей, не создавайте выделенные серверы, а вместо этого установите AD FS на каждом из серверов Active Directory DS в облаке.</span><span class="sxs-lookup"><span data-stu-id="78f50-259">If you have fewer than 1000 users, do not create dedicated servers, but instead install AD FS on each of the Active Directory DS servers in the cloud.</span></span> <span data-ttu-id="78f50-260">Убедитесь, что у вас есть как минимум два сервера AD DS для обеспечения доступности.</span><span class="sxs-lookup"><span data-stu-id="78f50-260">Make sure that you have at least two Active Directory DS servers to maintain availability.</span></span> <span data-ttu-id="78f50-261">Создайте один сервер WAP.</span><span class="sxs-lookup"><span data-stu-id="78f50-261">Create a single WAP server.</span></span>
- <span data-ttu-id="78f50-262">Если у вас от 1000 до 15 000 пользователей, создайте два выделенных сервера AD FS и два выделенных сервера WAP.</span><span class="sxs-lookup"><span data-stu-id="78f50-262">If you have between 1000 and 15000 users, create two dedicated AD FS servers and two dedicated WAP servers.</span></span>
- <span data-ttu-id="78f50-263">Если у вас от 15 000 до 60 000 пользователей, создайте от трех до пяти выделенных серверов AD FS и не менее двух выделенных WAP-серверов.</span><span class="sxs-lookup"><span data-stu-id="78f50-263">If you have between 15000 and 60000 users, create between three and five dedicated AD FS servers and at least two dedicated WAP servers.</span></span>

<span data-ttu-id="78f50-264">Предполагается, что вы используете две четырехъядерные виртуальные машины (Standard D4_v2 или лучше) в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-264">These considerations assume that you are using dual quad-core VM (Standard D4_v2, or better) sizes in Azure.</span></span>

<span data-ttu-id="78f50-265">Если вы используете внутреннюю базу данных Windows для хранения данных конфигурации AD FS, вы ограничены восемью серверами AD FS в ферме.</span><span class="sxs-lookup"><span data-stu-id="78f50-265">If you are using the Windows Internal Database to store AD FS configuration data, you are limited to eight AD FS servers in the farm.</span></span> <span data-ttu-id="78f50-266">Если предполагается, что в будущем вам понадобится больше, используйте SQL Server.</span><span class="sxs-lookup"><span data-stu-id="78f50-266">If you anticipate that you will need more in the future, use SQL Server.</span></span> <span data-ttu-id="78f50-267">Дополнительные сведения см. в статье [The Role of the AD FS Configuration Database][adfs-configuration-database] (Роль базы данных конфигурации AD FS).</span><span class="sxs-lookup"><span data-stu-id="78f50-267">For more information, see [The Role of the AD FS Configuration Database][adfs-configuration-database].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="78f50-268">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="78f50-268">Availability considerations</span></span>

<span data-ttu-id="78f50-269">Вы можете использовать SQL Server или внутреннюю базу данных Windows для хранения данных о конфигурации AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-269">You can use either SQL Server or the Windows Internal Database to hold AD FS configuration information.</span></span> <span data-ttu-id="78f50-270">Внутренняя база данных Windows обеспечивает основную избыточность.</span><span class="sxs-lookup"><span data-stu-id="78f50-270">The Windows Internal Database provides basic redundancy.</span></span> <span data-ttu-id="78f50-271">Изменения записываются непосредственно только в одну из баз данных AD FS в кластере AD FS, в то время как другие серверы используют репликацию по запросу, чтобы обновлять свои базы данных.</span><span class="sxs-lookup"><span data-stu-id="78f50-271">Changes are written directly to only one of the AD FS databases in the AD FS cluster, while the other servers use pull replication to keep their databases up to date.</span></span> <span data-ttu-id="78f50-272">Использование SQL Server обеспечивает избыточность и высокую доступность всей базы данных за счет отказоустойчивой кластеризации или зеркального отображения.</span><span class="sxs-lookup"><span data-stu-id="78f50-272">Using SQL Server can provide full database redundancy and high availability using failover clustering or mirroring.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="78f50-273">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="78f50-273">Manageability considerations</span></span>

<span data-ttu-id="78f50-274">Сотрудники DevOps должны быть готовы выполнить следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="78f50-274">DevOps staff should be prepared to perform the following tasks:</span></span>

- <span data-ttu-id="78f50-275">Управление серверами федерации, включая управление фермой AD FS, управление политикой доверия на серверах федерации и управление сертификатами, используемыми службами федерации.</span><span class="sxs-lookup"><span data-stu-id="78f50-275">Managing the federation servers, including managing the AD FS farm, managing trust policy on the federation servers, and managing the certificates used by the federation services.</span></span>
- <span data-ttu-id="78f50-276">Управление WAP-серверами, включая управление фермой и сертификатами WAP.</span><span class="sxs-lookup"><span data-stu-id="78f50-276">Managing the WAP servers including managing the WAP farm and certificates.</span></span>
- <span data-ttu-id="78f50-277">Управление веб-приложениями, включая настройку проверяющих сторон, методы проверки подлинности и сопоставления утверждений.</span><span class="sxs-lookup"><span data-stu-id="78f50-277">Managing web applications including configuring relying parties, authentication methods, and claims mappings.</span></span>
- <span data-ttu-id="78f50-278">Резервное копирование компонентов AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-278">Backing up AD FS components.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="78f50-279">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="78f50-279">Security considerations</span></span>

<span data-ttu-id="78f50-280">AD FS используют протокол HTTPS, поэтому убедитесь, что правила NSG для подсети, содержащей виртуальные машины веб-уровня, разрешают HTTPS-запросы.</span><span class="sxs-lookup"><span data-stu-id="78f50-280">AD FS utilizes the HTTPS protocol, so make sure that the NSG rules for the subnet containing the web tier VMs permit HTTPS requests.</span></span> <span data-ttu-id="78f50-281">Эти запросы могут быть получены из локальной сети, подсетей, содержащих веб-уровень, бизнес-уровень, уровень данных, частную и общедоступную сеть периметра, а также подсеть, содержащую серверы AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-281">These requests can originate from the on-premises network, the subnets containing the web tier, business tier, data tier, private DMZ, public DMZ, and the subnet containing the AD FS servers.</span></span>

<span data-ttu-id="78f50-282">Для выполнения аудита рассмотрите возможность использования набора сетевых виртуальных устройств, которые регистрируют подробные сведения о трафике, пересекающем край вашей виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="78f50-282">Consider using a set of network virtual appliances that logs detailed information on traffic traversing the edge of your virtual network for auditing purposes.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="78f50-283">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="78f50-283">Deploy the solution</span></span>

<span data-ttu-id="78f50-284">Решение для развертывания этой эталонной архитектуры доступно на портале [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="78f50-284">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="78f50-285">Для выполнения сценария Powershell, который развертывает решение, вам потребуется последняя версия [Azure CLI][azure-cli].</span><span class="sxs-lookup"><span data-stu-id="78f50-285">You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="78f50-286">Чтобы развернуть эту эталонную архитектуру, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="78f50-286">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="78f50-287">Скачайте или клонируйте папку решения с портала [Github][github] на локальный компьютер.</span><span class="sxs-lookup"><span data-stu-id="78f50-287">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="78f50-288">Откройте Azure CLI и перейдите к папке локального решения.</span><span class="sxs-lookup"><span data-stu-id="78f50-288">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="78f50-289">Выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="78f50-289">Run the following command:</span></span>

    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```

    <span data-ttu-id="78f50-290">Замените `<subscription id>` идентификатором своей подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-290">Replace `<subscription id>` with your Azure subscription ID.</span></span>

    <span data-ttu-id="78f50-291">В качестве значения `<location>` укажите регион Azure (например, `eastus` или `westus`).</span><span class="sxs-lookup"><span data-stu-id="78f50-291">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>

    <span data-ttu-id="78f50-292">Параметр `<mode>` управляет степенью детализации развертывания и может принимать одно из следующих значений:</span><span class="sxs-lookup"><span data-stu-id="78f50-292">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>

   - <span data-ttu-id="78f50-293">`Onpremise`: развертывает имитированную локальную среду.</span><span class="sxs-lookup"><span data-stu-id="78f50-293">`Onpremise`: Deploys a simulated on-premises environment.</span></span> <span data-ttu-id="78f50-294">Вы можете использовать это развертывание для тестирования и экспериментирования, если у вас нет имеющейся локальной сети или если вы хотите протестировать эту эталонную архитектуру без изменения конфигурации имеющейся локальной сети.</span><span class="sxs-lookup"><span data-stu-id="78f50-294">You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.</span></span>
   - <span data-ttu-id="78f50-295">`Infrastructure` — развертывает инфраструктуру и переходную среду виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="78f50-295">`Infrastructure`: deploys the VNet infrastructure and jump box.</span></span>
   - <span data-ttu-id="78f50-296">`CreateVpn` — развертывает шлюз виртуальной сети Azure и подключает его к имитированной локальной сети.</span><span class="sxs-lookup"><span data-stu-id="78f50-296">`CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   - <span data-ttu-id="78f50-297">`AzureADDS` — выполняет развертывание виртуальных машин, действующих как серверы доменных служб Active Directory, развертывает Active Directory в этих виртуальных машинах, а также создает домен в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-297">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.</span></span>
   - <span data-ttu-id="78f50-298">`AdfsVm` — развертывает виртуальные машины AD FS и присоединяет их к домену в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-298">`AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.</span></span>
   - <span data-ttu-id="78f50-299">`PublicDMZ` — выполняет развертывание общедоступной сети периметра в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-299">`PublicDMZ`: deploys the public DMZ in Azure.</span></span>
   - <span data-ttu-id="78f50-300">`ProxyVm` — развертывает виртуальные машины прокси-сервера AD FS и присоединяет их к домену в Azure.</span><span class="sxs-lookup"><span data-stu-id="78f50-300">`ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.</span></span>
   - <span data-ttu-id="78f50-301">`Prepare` — выполняет все предыдущие развертывания.</span><span class="sxs-lookup"><span data-stu-id="78f50-301">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="78f50-302">**Это рекомендуемый вариант, если вы создаете совершенно новое развертывание и у вас нет имеющейся внутренней инфраструктуры.**</span><span class="sxs-lookup"><span data-stu-id="78f50-302">**This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.**</span></span>
   - <span data-ttu-id="78f50-303">`Workload` — дополнительно развертывает виртуальные машины веб-уровня, бизнес-уровня и уровня данных и поддерживающую сеть.</span><span class="sxs-lookup"><span data-stu-id="78f50-303">`Workload`: optionally deploys web, business, and data tier VMs and supporting network.</span></span> <span data-ttu-id="78f50-304">Не включены в режим развертывания `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="78f50-304">Not included in the `Prepare` deployment mode.</span></span>
   - <span data-ttu-id="78f50-305">`PrivateDMZ` — дополнительно развертывает общедоступную сеть периметра в Azure перед виртуальными машинами `Workload`, развернутыми выше.</span><span class="sxs-lookup"><span data-stu-id="78f50-305">`PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above.</span></span> <span data-ttu-id="78f50-306">Не включены в режим развертывания `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="78f50-306">Not included in the `Prepare` deployment mode.</span></span>

4. <span data-ttu-id="78f50-307">Дождитесь завершения развертывания.</span><span class="sxs-lookup"><span data-stu-id="78f50-307">Wait for the deployment to complete.</span></span> <span data-ttu-id="78f50-308">Если вы использовали параметр `Prepare`, развертывание будет выполнено через несколько часов и завершится сообщением `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`.</span><span class="sxs-lookup"><span data-stu-id="78f50-308">If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span></span>

5. <span data-ttu-id="78f50-309">Перезапустите переходную среду (*ra-adfs-mgmt-vm1* в группе *ra-adfs-security-rg*), чтобы разрешить применение ее настроек DNS.</span><span class="sxs-lookup"><span data-stu-id="78f50-309">Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.</span></span>

6. <span data-ttu-id="78f50-310">[Получите SSL-сертификат для служб AD FS][adfs_certificates] и установите этот сертификат на виртуальных машинах AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-310">[Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs.</span></span> <span data-ttu-id="78f50-311">Обратите внимание, что можно подключаться к ним через переходную среду.</span><span class="sxs-lookup"><span data-stu-id="78f50-311">Note that you can connect to them through the jump box.</span></span> <span data-ttu-id="78f50-312">IP-адреса: **10.0.5.4** и **10.0.5.5**.</span><span class="sxs-lookup"><span data-stu-id="78f50-312">The IP addresses are **10.0.5.4** and **10.0.5.5**.</span></span> <span data-ttu-id="78f50-313">Именем пользователя по умолчанию является **contoso\testuser**, а паролем — **AweSome@PW**.</span><span class="sxs-lookup"><span data-stu-id="78f50-313">The default username is **contoso\testuser** with password **AweSome@PW**.</span></span>

   > [!NOTE]
   > <span data-ttu-id="78f50-314">Комментарии в скрипте Deploy-ReferenceArchitecture.ps1 на этом этапе содержат подробные инструкции по созданию самозаверяющего тестового сертификата и полномочий с помощью команды `makecert`.</span><span class="sxs-lookup"><span data-stu-id="78f50-314">The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command.</span></span> <span data-ttu-id="78f50-315">Однако выполните эти действия только в виде **тестирования** и не используйте сертификаты, созданные с помощью makecert, в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="78f50-315">However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.</span></span>

7. <span data-ttu-id="78f50-316">Выполните следующую команду PowerShell для развертывания фермы серверов AD FS:</span><span class="sxs-lookup"><span data-stu-id="78f50-316">Run the following PowerShell command to deploy the AD FS server farm:</span></span>

    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ```

8. <span data-ttu-id="78f50-317">В переходной среде перейдите по адресу `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm`, чтобы проверить установку AD FS (может появиться предупреждение о сертификате, которое можно игнорировать в этом тестировании).</span><span class="sxs-lookup"><span data-stu-id="78f50-317">On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test).</span></span> <span data-ttu-id="78f50-318">Убедитесь, что отображается страница входа в корпорацию Contoso.</span><span class="sxs-lookup"><span data-stu-id="78f50-318">Verify that the Contoso Corporation sign-in page appears.</span></span> <span data-ttu-id="78f50-319">Выполните вход с именем пользователя **contoso\testuser** и паролем — **AweS0me@PW**.</span><span class="sxs-lookup"><span data-stu-id="78f50-319">Sign in as **contoso\testuser** with password **AweS0me@PW**.</span></span>

9. <span data-ttu-id="78f50-320">Установите SSL-сертификат на виртуальных машинах прокси-сервера AD FS.</span><span class="sxs-lookup"><span data-stu-id="78f50-320">Install the SSL certificate on the AD FS proxy VMs.</span></span> <span data-ttu-id="78f50-321">IP-адреса: *10.0.6.4* и *10.0.6.5*.</span><span class="sxs-lookup"><span data-stu-id="78f50-321">The IP addresses are *10.0.6.4* and *10.0.6.5*.</span></span>

10. <span data-ttu-id="78f50-322">Выполните следующую команду PowerShell для развертывания первого прокси-сервера AD FS:</span><span class="sxs-lookup"><span data-stu-id="78f50-322">Run the following PowerShell command to deploy the first AD FS proxy server:</span></span>

    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. <span data-ttu-id="78f50-323">Следуйте инструкциям, отображаемым в скрипте, для проверки установки первого прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="78f50-323">Follow the instructions displayed by the script to test the installation of the first proxy server.</span></span>

12. <span data-ttu-id="78f50-324">Выполните следующую команду PowerShell для развертывания второго прокси-сервера:</span><span class="sxs-lookup"><span data-stu-id="78f50-324">Run the following PowerShell command to deploy the second proxy server:</span></span>

    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. <span data-ttu-id="78f50-325">Следуйте инструкциям в скрипте, чтобы проверить всю конфигурацию прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="78f50-325">Follow the instructions displayed by the script to test the complete proxy configuration.</span></span>

## <a name="next-steps"></a><span data-ttu-id="78f50-326">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="78f50-326">Next steps</span></span>

- <span data-ttu-id="78f50-327">[Документация Azure Active Directory][aad].</span><span class="sxs-lookup"><span data-stu-id="78f50-327">Learn about [Azure Active Directory][aad].</span></span>
- <span data-ttu-id="78f50-328">[Документация по Active Directory B2C][aadb2c].</span><span class="sxs-lookup"><span data-stu-id="78f50-328">Learn about [Azure Active Directory B2C][aadb2c].</span></span>

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: https://technet.microsoft.com/windowsserver/dd448613.aspx
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  /windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[aad]: https://azure.microsoft.com/documentation/services/active-directory/
[aadb2c]: https://azure.microsoft.com/documentation/services/active-directory-b2c/
[adfs-intro]: /azure/active-directory/hybrid/whatis-hybrid-identity
[github]: https://github.com/mspnp/identity-reference-architectures/tree/master/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
