---
title: N-уровневое приложение с Apache Cassandra
titleSuffix: Azure Reference Architectures
description: Запуск виртуальных машин Linux в n-уровневой архитектуре с помощью Apache Cassandra в Microsoft Azure.
author: MikeWasson
ms.date: 11/12/2018
ms.custom: seodec18
ms.openlocfilehash: bbd1029fe17b5d88d54246127c5d8983a573b012
ms.sourcegitcommit: 88a68c7e9b6b772172b7faa4b9fd9c061a9f7e9d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2018
ms.locfileid: "53120175"
---
# <a name="linux-n-tier-application-in-azure-with-apache-cassandra"></a>Использование n-уровневого приложения Linux с Apache Cassandra в Azure

На примере этой эталонной архитектуры показано, как развернуть виртуальные машины и виртуальную сеть, настроенные для n-уровневого приложения с помощью Apache Cassandra на платформе Linux для уровня данных. [**Разверните это решение**](#deploy-the-solution).

![N-уровневая архитектура с использованием Microsoft Azure](./images/n-tier-cassandra.png)

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов.

- **Группа ресурсов**. [Группы ресурсов][resource-manager-overview] используются для группирования ресурсов по времени существования, владельцу и другим критериям для управления.

- **Виртуальная сеть и подсети**. Каждая виртуальная машина Azure развертывается в виртуальной сети, которую можно сегментировать на несколько подсетей. Создайте отдельные подсети для каждого уровня.

- **Группы безопасности сети.** [Группы безопасности сети][nsg] (NSG) позволяют ограничить сетевой трафик в виртуальной сети. Например, в приведенной здесь трехуровневой архитектуре уровень базы данных принимает трафик из бизнес-уровня и подсети управления, но не из веб-интерфейса.

- **Защита от атак DDoS**. Хотя платформа Azure и обеспечивает основную защиту от распределенных атак отказа в обслуживании (DDoS), рекомендуется использовать [Защиту Azure от атак DDoS ценовой категории "Стандартный"][ddos] с расширенными функциями защиты от атак DDoS. См. раздел [Вопросы безопасности](#security-considerations) ниже.

- **Виртуальные машины**. Рекомендации по настройке виртуальных машин см. в руководствах по запуску виртуальных машин [Windows](./windows-vm.md) и [Linux](./linux-vm.md) в Azure.

- **Группы доступности**. Создайте [группу доступности][azure-availability-sets] для каждого уровня и по крайней мере две виртуальные машины на каждом из уровней, что позволит применить к этим виртуальным машинам [Соглашение об уровне обслуживания (SLA)][vm-sla] более высокого уровня.

- **Подсистемы балансировки нагрузки Azure**. [Подсистемы балансировки нагрузки][load-balancer] распределяют входящие запросы из Интернета между экземплярами виртуальных машин. [Общедоступная подсистема балансировки нагрузки][load-balancer-external] передает входящий интернет-трафик на веб-уровень, а [внутренняя подсистема балансировки нагрузки][load-balancer-internal] передает сетевой трафик с веб-уровня на бизнес-уровень.

- **Общедоступный IP-адрес.** Для приема интернет-трафика общедоступной подсистеме балансировки нагрузки требуется общедоступный IP-адрес.

- **Jumpbox**. Он также называется [узлом-бастионом]. Безопасная виртуальная машина в сети, которую администраторы используют для подключения к другим виртуальным машинам. В jumpbox есть группа безопасности сети, обеспечивающая удаленный трафик только из общедоступных IP-адресов из списка надежных отправителей. NSG должна пропускать трафик SSH.

- **База данных Apache Cassandra.** Обеспечивает высокий уровень доступности на уровне данных, включив репликацию и отработку отказа.

- **Azure DNS**. [Azure DNS][azure-dns] — это служба размещения для доменов DNS. Она осуществляет разрешение имен на базе инфраструктуры Microsoft Azure. Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.

## <a name="recommendations"></a>Рекомендации

Описанная здесь архитектура может не соответствовать вашим требованиям. Воспользуйтесь этими рекомендациями в качестве отправной точки.

### <a name="vnet--subnets"></a>Виртуальная сеть и подсети

При создании виртуальной сети определите, сколько IP-адресов требуется для ресурсов в каждой подсети. Укажите маску подсети и достаточно большой диапазон адресов виртуальной сети для требуемых IP-адресов с помощью нотации [CIDR]. Используйте адресное пространство, которое входит в диапазон стандартных [блоков частных IP-адресов][private-ip-space], например 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Выберите диапазон адресов, который не перекрывает локальную сеть, если вам нужно позже настроить шлюз между виртуальной и локальной сетями. Создав виртуальную сеть, изменить диапазон адресов нельзя.

Проектируйте подсети с учетом требований к функциональности и безопасности. Все виртуальные машины в пределах одного уровня или одной роли должны входить в одну и ту же подсеть, которая может быть надежным периметром безопасности. Дополнительные сведения о проектировании виртуальных сетей и подсетей см. в статье [Планирование и проектирование виртуальных сетей Azure][plan-network].

### <a name="load-balancers"></a>Балансировщики нагрузки

Не предоставляйте виртуальным машинам непосредственный доступ в Интернет. Вместо этого назначьте каждой виртуальной машине частный IP-адрес. Клиенты подключаются с помощью IP-адреса общедоступной подсистемы балансировки нагрузки.

Определите правила подсистемы балансировки нагрузки для направления трафика к виртуальным машинам. Например, чтобы включить трафик HTTP, создайте правило, которое сопоставляет порт 80 интерфейсной конфигурации с портом 80 серверного пула адресов. Когда клиент отправляет HTTP-запрос на порт 80, подсистема балансировки нагрузки выбирает IP-адрес серверной части с помощью [хэш-алгоритма][load-balancer-hashing], который включает исходный IP-адрес. Клиентские запросы распределяются между всеми виртуальными машинами.

### <a name="network-security-groups"></a>Группы безопасности сети

С помощью правил NSG можно ограничить трафик между уровнями. Например, в показанной выше трехуровневой архитектуре веб-уровень не взаимодействует напрямую с уровнем базы данных. Чтобы обеспечить эту возможность, уровень базы данных должен блокировать входящий трафик из подсети веб-уровня.

1. Запретите весь входящий трафик от виртуальной сети. (В правиле используйте тег `VIRTUAL_NETWORK`.)
2. Разрешите входящий трафик из подсети бизнес-уровня.
3. Разрешите входящий трафик из самой подсети уровня базы данных. Это правило обеспечивает взаимодействие между виртуальными машинами баз данных, которое необходимо для репликации и отработки отказа базы данных.
4. Разрешите трафик SSH (порт 22) из подсети jumpbox. Это правило позволяет администраторам подключаться к уровню базы данных из jumpbox.

Создайте правила 2 и 4 с более высоким приоритетом, чем у правила 1, чтобы они переопределяли его.

### <a name="cassandra"></a>Cassandra

Для производственных целей мы рекомендуем использовать [DataStax Enterprise][datastax]. Эти рекомендации применимы для каждого выпуска Cassandra. Дополнительные сведения о запуске DataStax в Azure см. в [руководстве по развертыванию DataStax Enterprise для Azure][cassandra-in-azure].

Поместите виртуальные машины для кластера Cassandra в группе доступности, чтобы обеспечить распределение реплик между несколькими доменами сбоя и обновления. Дополнительные сведения о доменах сбоя и обновления см. в статье [Управление доступностью виртуальных машин Linux][azure-availability-sets].

Для одной группы доступности настройте эти три домена сбоя (максимальное количество) и 18 доменов обновления. Это обеспечивает максимальное количество доменов обновления, которые можно равномерно распределить между доменами сбоя.

Настройте узлы в режиме с поддержкой стоек. Сопоставьте домены сбоя со стойками в файле `cassandra-rackdc.properties`.

Вам не потребуется подсистема балансировки нагрузки для кластера. Клиент подключается напрямую к узлу в кластере.

Чтобы обеспечить высокий уровень доступности, разверните Cassandra в нескольких регионах Azure. В каждом регионе узлы настраиваются в режиме с поддержкой стоек с доменами сбоя и обновления для обеспечения устойчивости в пределах региона.

### <a name="jumpbox"></a>Jumpbox

Запретите доступ по протоколу SSH из общедоступного Интернета к виртуальным машинам, которые выполняют рабочую нагрузку приложения. Вместо этого все доступы по протоколу SSH к этим виртуальным машинам должны проходить через jumpbox. Администратор выполняет вход в jumpbox, а затем вход в другую виртуальную машину из jumpbox. Jumpbox разрешает трафик SSH из Интернета, но только из известных и безопасных IP-адресов.

Jumpbox имеет минимальные требования к производительности, поэтому выберите небольшой размер виртуальной машины. Создайте [общедоступный IP-адрес] для jumpbox. Поместите jumpbox в виртуальную сеть вместе с другими виртуальными машинами, однако в отдельную подсеть управления.

Чтобы защитить jumpbox, добавьте правило NSG, разрешающее подключения по протоколу SSH только из безопасного набора общедоступных IP-адресов. Настройте NSG для других подсетей, чтобы разрешить трафик SSH из подсети управления.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Рассмотрите возможность использования [масштабируемых наборов виртуальных машин][vmss] для веб-уровня и бизнес-уровня, вместо развертывания отдельных виртуальных машин в группе доступности. Масштабируемый набор упрощает процессы развертывания и администрирования набора идентичных виртуальных машин, а также автоматического масштабирования виртуальных машин на основе метрик производительности. По мере увеличения нагрузки на виртуальные машины в подсистему балансировки нагрузки автоматически добавляются дополнительные виртуальные машины. Подумайте об использовании масштабируемых наборов, если необходимо быстро развернуть виртуальные машины или выполнить автомасштабирование.

Настройку виртуальных машин, развернутых в масштабируемый набор, можно выполнить двумя основными способами:

- Используйте расширения для настройки виртуальной машины после ее развертывания. В этом случае новые экземпляры виртуальной машины могут дольше запускаться, чем виртуальные машины без расширений.

- Развернуть [управляемый диск](/azure/storage/storage-managed-disks-overview) с помощью пользовательского образа диска. При этом развертывание выполняется быстрее. Но образ необходимо обновлять.

Дополнительные сведения см. в статье [Рекомендации по проектированию масштабируемых наборов][vmss-design].

> [!TIP]
> При использовании любого решения автоматического масштабирования заблаговременно протестируйте его с рабочими нагрузками производственного уровня.

В каждой подписке Azure настроены ограничения по умолчанию, включая максимальное количество виртуальных машин в каждом регионе. Их лимит можно увеличить, создав запрос на поддержку. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы][subscription-limits].

## <a name="availability-considerations"></a>Вопросы доступности

Если вы не используете масштабируемые наборы виртуальных машин, разместите виртуальные машины для одного уровня в группе доступности. Создайте по крайней мере две виртуальные машины в группе доступности для реализации [соглашения об уровне обслуживания, гарантирующем доступность виртуальных машин Azure][vm-sla]. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure][availability-set]. Масштабируемые наборы автоматически используют *группы размещения*, которые функционируют как неявная группа доступности.

Подсистема балансировки нагрузки выполняет [проверку работоспособности][health-probes], чтобы отслеживать доступность экземпляров виртуальных машин. Если пробу не удается выполнить в экземпляре в течение определенного времени, подсистема балансировки нагрузки останавливает отправку трафика на эту виртуальную машину. Подсистема балансировки нагрузки продолжит выполнять пробу и, если виртуальная машина станет снова доступна, отправка трафика к этой виртуальной машине будет возобновлена.

Вот несколько рекомендаций по проверке работоспособности подсистемы балансировки нагрузки:

- При проверке может тестироваться HTTP или TCP. Если на виртуальных машинах запущен HTTP-сервер, создайте проверку HTTP. В противном случае создайте проверку TCP.
- В проверке HTTP укажите путь к конечной точке HTTP. При этом проверяется код ответа HTTP 200 с этого пути. Это может быть путь к корневому каталогу ("/") или конечная точка мониторинга работоспособности, которая реализует определенную пользовательскую логику для проверки работоспособности приложения. Конечная точка должна разрешать анонимные HTTP-запросы.
- Проверка отправляется с [известного][health-probe-ip] IP-адреса — 168.63.129.16. Не блокируйте входящий и исходящий трафик для этого IP-адреса в политиках брандмауэра или правилах группы безопасности сети.
- Используйте [журналы проверки работоспособности][health-probe-log] для просмотра состояния проверки работоспособности. Включите ведение журнала на портале Azure для каждой подсистемы балансировки нагрузки. Журналы записываются в хранилище BLOB-объектов Azure. В журналах показано, сколько виртуальных машин не получают сетевой трафик из-за ответов о неудачной попытке пробы.

Для кластера Cassandra сценарии отработки отказа зависят от уровней согласованности, используемых приложением, а также от количества используемых реплик. Сведения об уровнях согласованности и потреблении в Cassandra см. в руководстве по [обеспечению согласованности данных][cassandra-consistency] и [описании узлов, которые обмениваются данными с кворумом (Cassandra)][cassandra-consistency-usage]. Доступность данных в Cassandra определяется уровнем согласованности, используемым приложением, и механизмом репликации. Сведения о репликации в Cassandra см. в статье [Data Replication in NoSQL Databases Explained][cassandra-replication] (Описание репликации данных в базах данных NoSQL).

## <a name="security-considerations"></a>Вопросы безопасности

Виртуальные сети являются границей, изолирующей трафик в Azure. Виртуальные машины из разных виртуальных сетей не могут напрямую обмениваться данными. Виртуальные машины в одной виртуальной сети могут обмениваться данными, если только не созданы [группы безопасности сети][nsg], ограничивающие этот трафик. Дополнительные сведения см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][network-security].

Для входящего интернет-трафика правила подсистемы балансировки нагрузки определяют, какой трафик может достичь серверной части. Однако правила подсистемы балансировки нагрузки не поддерживают списки безопасных IP-адресов, поэтому если вы хотите добавить некоторые общедоступные IP-адреса в список надежных, добавьте группу безопасности сети в подсеть.

**DMZ**. Попробуйте добавить сетевой виртуальный модуль (NVA), чтобы создать сеть периметра между Интернетом и виртуальною сетью Azure. Сетевой виртуальный модуль — это универсальный термин для виртуального модуля, который может выполнять сетевые задачи, например брандмауэра, проверки пакетов, аудита и пользовательской маршрутизации. Дополнительные сведения см. в статье [Сеть периметра между Azure и Интернетом][dmz].

**Шифрование**. Выполните шифрование конфиденциальных неактивных данных и используйте [Azure Key Vault][azure-key-vault] для управления ключами шифрования базы данных. Key Vault может хранить ключи шифрования в аппаратных модулях безопасности. В Key Vault также рекомендуется хранить секреты приложения, например строки подключения к базе данных.

**Защита от атак DDoS.** Платформа Azure по умолчанию предоставляет основные средства защиты от атак DDoS. Эти основные средства защиты предназначены для защиты всей инфраструктуры Azure. Хотя базовая защита от атак DDoS включается автоматически, рекомендуется использовать [Защиту Azure от атак DDoS ценовой категории "Стандартный"][ddos]. Для ценовой категории "Стандартный" предусмотрена адаптивная настройка для обнаружения угроз на основе моделей сетевого трафика вашего приложения. Это позволяет устранять риски атак DDoS, которые могут остаться незамеченными для соответствующих политик уровня инфраструктуры. Для этой ценовой категории также включена поддержка оповещений, телеметрии и аналитики на основе Azure Monitor. Дополнительные сведения см. в руководстве по [использованию Защиты от атак DDoS Azure с рекомендациями и эталонной архитектурой][ddos-best-practices].

## <a name="deploy-the-solution"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder].

### <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [ref-arch-prerequisites.md](../../../includes/ref-arch-prerequisites.md)]

### <a name="deploy-the-solution-using-azbb"></a>Развертывание решения с помощью azbb

Чтобы развернуть виртуальные машины Linux для эталонной архитектуры n-уровневого приложения, сделайте следующее:

1. Перейдите в папку `virtual-machines\n-tier-linux` репозитория, клонированного на шаге 1 (см. список необходимых компонентов).

2. Файл параметров присваивает стандартные имя пользователя и пароль для администратора каждой виртуальной машине в развертывании. Измените эти значения перед развертыванием эталонной архитектуры. Откройте файл `n-tier-linux.json` и замените все поля **adminUsername** и **adminPassword** новыми значениями.   Сохраните файл.

3. Разверните эталонную архитектуру, используя средство **azbb**, как показано ниже.

   ```azurecli
   azbb -s <your subscription_id> -g <your resource_group_name> -l <azure region> -p n-tier-linux.json --deploy
   ```

Дополнительные сведения о развертывании этого примера эталонной архитектуры с использованием стандартных блоков Azure см. в [нашем репозитории GitHub][git].

<!-- links -->

[dmz]: ../dmz/secure-vnet-dmz.md
[multi-vm]: ./multi-vm.md
[naming conventions]: /azure/guidance/guidance-naming-conventions
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-linux-manage-availability
[azure-dns]: /azure/dns/dns-overview
[azure-key-vault]: https://azure.microsoft.com/services/key-vault

[узлом-бастионом]: https://en.wikipedia.org/wiki/Bastion_host
[cassandra-in-azure]: https://academy.datastax.com/resources/deployment-guide-azure
[cassandra-consistency]: https://docs.datastax.com/en/cassandra/2.0/cassandra/dml/dml_config_consistency_c.html
[cassandra-replication]: https://academy.datastax.com/planet-cassandra/data-replication-in-nosql-databases-explained
[cassandra-consistency-usage]: https://medium.com/@foundev/cassandra-how-many-nodes-are-talked-to-with-quorum-also-should-i-use-it-98074e75d7d5#.b4pb4alb2

[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[datastax]: https://www.datastax.com/products/datastax-enterprise
[ddos]: /azure/virtual-network/ddos-protection-overview
[ddos-best-practices]: /azure/security/azure-ddos-best-practices
[git]: https://github.com/mspnp/template-building-blocks
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-linux
[load-balancer-external]: /azure/load-balancer/load-balancer-internet-overview
[load-balancer-internal]: /azure/load-balancer/load-balancer-internal-overview
[nsg]: /azure/virtual-network/virtual-networks-nsg
[nsg-rules]: /azure/azure-resource-manager/best-practices-resource-manager-security#network-security-groups
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[Общедоступный IP-адрес]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx

[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[load-balancer]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load-balancer-hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[subscription-limits]: /azure/azure-subscription-service-limits
[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[health-probes]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-log]: /azure/load-balancer/load-balancer-monitor-log
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[network-security]: /azure/best-practices-network-security
