---
title: N-уровневое приложение Windows с SQL Server
titleSuffix: Azure Reference Architectures
description: Сведения о том, как реализовать многоуровневую архитектуру в Azure для обеспечения доступности, безопасности, масштабируемости и управляемости.
author: MikeWasson
ms.date: 11/12/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.openlocfilehash: 200d2e18890582a7c1551ef5053e388c4a5f29a3
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58242955"
---
# <a name="windows-n-tier-application-on-azure-with-sql-server"></a><span data-ttu-id="c0d33-103">Использование n-уровневого приложения с SQL Server в Azure</span><span class="sxs-lookup"><span data-stu-id="c0d33-103">Windows N-tier application on Azure with SQL Server</span></span>

<span data-ttu-id="c0d33-104">На примере этой эталонной архитектуры показано, как развернуть виртуальные машины и виртуальную сеть, настроенные для [N-уровневого](../../guide/architecture-styles/n-tier.md) приложения с помощью SQL Server на платформе Windows для уровня данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-104">This reference architecture shows how to deploy VMs and a virtual network configured for an [N-tier](../../guide/architecture-styles/n-tier.md) application, using SQL Server on Windows for the data tier.</span></span> <span data-ttu-id="c0d33-105">[**Разверните это решение**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="c0d33-105">[**Deploy this solution**](#deploy-the-solution).</span></span>

![N-уровневая архитектура с использованием Microsoft Azure](./images/n-tier-sql-server.png)

<span data-ttu-id="c0d33-107">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="c0d33-107">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="c0d33-108">Архитектура</span><span class="sxs-lookup"><span data-stu-id="c0d33-108">Architecture</span></span>

<span data-ttu-id="c0d33-109">Архитектура состоит из следующих компонентов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-109">The architecture has the following components:</span></span>

- <span data-ttu-id="c0d33-110">**Группа ресурсов**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-110">**Resource group**.</span></span> <span data-ttu-id="c0d33-111">[Группы ресурсов][resource-manager-overview] используются для группирования ресурсов по времени существования, владельцу и другим критериям для управления.</span><span class="sxs-lookup"><span data-stu-id="c0d33-111">[Resource groups][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, or other criteria.</span></span>

- <span data-ttu-id="c0d33-112">**Виртуальная сеть и подсети**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-112">**Virtual network (VNet) and subnets**.</span></span> <span data-ttu-id="c0d33-113">Каждая виртуальная машина Azure развертывается в виртуальной сети, которую можно сегментировать на несколько подсетей.</span><span class="sxs-lookup"><span data-stu-id="c0d33-113">Every Azure VM is deployed into a VNet that can be segmented into subnets.</span></span> <span data-ttu-id="c0d33-114">Создайте отдельные подсети для каждого уровня.</span><span class="sxs-lookup"><span data-stu-id="c0d33-114">Create a separate subnet for each tier.</span></span>

- <span data-ttu-id="c0d33-115">**Шлюз приложений.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-115">**Application gateway**.</span></span> <span data-ttu-id="c0d33-116">[Шлюз приложений](/azure/application-gateway/)— это подсистема балансировки нагрузки уровня 7.</span><span class="sxs-lookup"><span data-stu-id="c0d33-116">[Azure Application Gateway](/azure/application-gateway/) is a layer 7 load balancer.</span></span> <span data-ttu-id="c0d33-117">В этой архитектуре шлюз перенаправляет HTTP-запросы к внешнему веб-интерфейсу.</span><span class="sxs-lookup"><span data-stu-id="c0d33-117">In this architecture, it routes HTTP requests to the web front end.</span></span> <span data-ttu-id="c0d33-118">Шлюз приложений также предоставляет [брандмауэр веб-приложения](/azure/application-gateway/waf-overview) (WAF), который защищает приложения от распространенных эксплойтов и уязвимостей.</span><span class="sxs-lookup"><span data-stu-id="c0d33-118">Application Gateway also provides a [web application firewall](/azure/application-gateway/waf-overview) (WAF) that protects the application from common exploits and vulnerabilities.</span></span>

- <span data-ttu-id="c0d33-119">**Группы безопасности сети.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-119">**NSGs**.</span></span> <span data-ttu-id="c0d33-120">[Группы безопасности сети][nsg] (NSG) позволяют ограничить сетевой трафик в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c0d33-120">Use [network security groups][nsg] (NSGs) to restrict network traffic within the VNet.</span></span> <span data-ttu-id="c0d33-121">Например, в приведенной здесь трехуровневой архитектуре уровень базы данных не принимает трафик из веб-интерфейса, а только с бизнес-уровня и из подсети управления.</span><span class="sxs-lookup"><span data-stu-id="c0d33-121">For example, in the three-tier architecture shown here, the database tier does not accept traffic from the web front end, only from the business tier and the management subnet.</span></span>

- <span data-ttu-id="c0d33-122">**Защита от атак DDoS**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-122">**DDoS Protection**.</span></span> <span data-ttu-id="c0d33-123">Хотя платформа Azure и обеспечивает основную защиту от распределенных атак отказа в обслуживании (DDoS), рекомендуется использовать [Защиту Azure от атак DDoS ценовой категории "Стандартный"][ddos] с расширенными функциями защиты от атак DDoS.</span><span class="sxs-lookup"><span data-stu-id="c0d33-123">Although the Azure platform provides basic protection against distributed denial of service (DDoS) attacks, we recommend using [DDoS Protection Standard][ddos], which has enhanced DDoS mitigation features.</span></span> <span data-ttu-id="c0d33-124">См. раздел [Вопросы безопасности](#security-considerations) ниже.</span><span class="sxs-lookup"><span data-stu-id="c0d33-124">See [Security considerations](#security-considerations).</span></span>

- <span data-ttu-id="c0d33-125">**Виртуальные машины**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-125">**Virtual machines**.</span></span> <span data-ttu-id="c0d33-126">Рекомендации по настройке виртуальных машин см. в руководствах по запуску виртуальных машин [Windows](./windows-vm.md) и [Linux](./linux-vm.md) в Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-126">For recommendations on configuring VMs, see [Run a Windows VM on Azure](./windows-vm.md) and [Run a Linux VM on Azure](./linux-vm.md).</span></span>

- <span data-ttu-id="c0d33-127">**Группы доступности**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-127">**Availability sets**.</span></span> <span data-ttu-id="c0d33-128">Создайте [группу доступности][azure-availability-sets] для каждого уровня и по крайней мере две виртуальные машины на каждом из уровней, что позволит применить к этим виртуальным машинам [Соглашение об уровне обслуживания (SLA)][vm-sla] более высокого уровня.</span><span class="sxs-lookup"><span data-stu-id="c0d33-128">Create an [availability set][azure-availability-sets] for each tier, and provision at least two VMs in each tier, which makes the VMs eligible for a higher [service level agreement (SLA)][vm-sla].</span></span>

- <span data-ttu-id="c0d33-129">**Подсистемы балансировки нагрузки.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-129">**Load balancers**.</span></span> <span data-ttu-id="c0d33-130">[Azure Load Balancer][load-balancer] позволяет распределять трафик с уровня Web на уровень Business, а также с уровня Business к SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c0d33-130">Use [Azure Load Balancer][load-balancer] to distribute network traffic from the web tier to the business tier, and from the business tier to SQL Server.</span></span>

- <span data-ttu-id="c0d33-131">**Общедоступный IP-адрес.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-131">**Public IP address**.</span></span> <span data-ttu-id="c0d33-132">Общедоступный IP-адрес, через который приложение принимает интернет-трафик.</span><span class="sxs-lookup"><span data-stu-id="c0d33-132">A public IP address is needed for the application to receive Internet traffic.</span></span>

- <span data-ttu-id="c0d33-133">**Jumpbox**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-133">**Jumpbox**.</span></span> <span data-ttu-id="c0d33-134">Он также называется [узлом-бастионом].</span><span class="sxs-lookup"><span data-stu-id="c0d33-134">Also called a [bastion host].</span></span> <span data-ttu-id="c0d33-135">Безопасная виртуальная машина в сети, которую администраторы используют для подключения к другим виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="c0d33-135">A secure VM on the network that administrators use to connect to the other VMs.</span></span> <span data-ttu-id="c0d33-136">В jumpbox есть группа безопасности сети, обеспечивающая удаленный трафик только из общедоступных IP-адресов из списка надежных отправителей.</span><span class="sxs-lookup"><span data-stu-id="c0d33-136">The jumpbox has an NSG that allows remote traffic only from public IP addresses on a safe list.</span></span> <span data-ttu-id="c0d33-137">NSG должна пропускать трафик с удаленного рабочего стола (RDP).</span><span class="sxs-lookup"><span data-stu-id="c0d33-137">The NSG should permit remote desktop (RDP) traffic.</span></span>

- <span data-ttu-id="c0d33-138">**Группа доступности AlwaysOn SQL Server.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-138">**SQL Server Always On Availability Group**.</span></span> <span data-ttu-id="c0d33-139">Обеспечивает высокий уровень доступности на уровне данных, включив репликацию и отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="c0d33-139">Provides high availability at the data tier, by enabling replication and failover.</span></span> <span data-ttu-id="c0d33-140">Для отработки отказа используется технология отказоустойчивого кластера Windows Server (WSFC).</span><span class="sxs-lookup"><span data-stu-id="c0d33-140">It uses Windows Server Failover Cluster (WSFC) technology for failover.</span></span>

- <span data-ttu-id="c0d33-141">**Серверы доменных служб Active Directory (AD DS).**</span><span class="sxs-lookup"><span data-stu-id="c0d33-141">**Active Directory Domain Services (AD DS) Servers**.</span></span> <span data-ttu-id="c0d33-142">Объекты-компьютеры для отказоустойчивого кластера и связанные с ним кластерные роли создаются в доменных службах Active Directory (AD DS).</span><span class="sxs-lookup"><span data-stu-id="c0d33-142">The computer objects for the failover cluster and its associated clustered roles are created in Active Directory Domain Services (AD DS).</span></span>

- <span data-ttu-id="c0d33-143">**Облачный ресурс-свидетель.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-143">**Cloud Witness**.</span></span> <span data-ttu-id="c0d33-144">На отказоустойчивом кластере должны работать больше половины узлов. Это называется кворумом.</span><span class="sxs-lookup"><span data-stu-id="c0d33-144">A failover cluster requires more than half of its nodes to be running, which is known as having quorum.</span></span> <span data-ttu-id="c0d33-145">Если в кластере только два узла, разделение сети может привести к тому, что каждый из узлов будет считаться главным.</span><span class="sxs-lookup"><span data-stu-id="c0d33-145">If the cluster has just two nodes, a network partition could cause each node to think it's the master node.</span></span> <span data-ttu-id="c0d33-146">В этом случае требуется *ресурс-свидетель*, чтобы разорвать связи и создать кворум.</span><span class="sxs-lookup"><span data-stu-id="c0d33-146">In that case, you need a *witness* to break ties and establish quorum.</span></span> <span data-ttu-id="c0d33-147">Свидетель — это ресурс, например общий диск, который может использоваться в качестве средства разбиения связей для установления кворума.</span><span class="sxs-lookup"><span data-stu-id="c0d33-147">A witness is a resource such as a shared disk that can act as a tie breaker to establish quorum.</span></span> <span data-ttu-id="c0d33-148">Облачный ресурс-свидетель — тип ресурса-свидетеля, в котором используется хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-148">Cloud Witness is a type of witness that uses Azure Blob Storage.</span></span> <span data-ttu-id="c0d33-149">Дополнительные сведения о концепции кворума см. в статье, посвященной [кворуму кластера и кворуму пула](/windows-server/storage/storage-spaces/understand-quorum).</span><span class="sxs-lookup"><span data-stu-id="c0d33-149">To learn more about the concept of quorum, see [Understanding cluster and pool quorum](/windows-server/storage/storage-spaces/understand-quorum).</span></span> <span data-ttu-id="c0d33-150">Дополнительные сведения об облачном ресурсе-свидетеле см. в статье, посвященной [развертыванию облачного ресурса-свидетеля для отказоустойчивого кластера](/windows-server/failover-clustering/deploy-cloud-witness).</span><span class="sxs-lookup"><span data-stu-id="c0d33-150">For more information about Cloud Witness, see [Deploy a Cloud Witness for a Failover Cluster](/windows-server/failover-clustering/deploy-cloud-witness).</span></span>

- <span data-ttu-id="c0d33-151">**Azure DNS**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-151">**Azure DNS**.</span></span> <span data-ttu-id="c0d33-152">[Azure DNS][azure-dns] — это служба размещения для доменов DNS.</span><span class="sxs-lookup"><span data-stu-id="c0d33-152">[Azure DNS][azure-dns] is a hosting service for DNS domains.</span></span> <span data-ttu-id="c0d33-153">Она осуществляет разрешение имен на базе инфраструктуры Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-153">It provides name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="c0d33-154">Размещая домены в Azure, вы можете управлять своими записями DNS с помощью тех же учетных данных, API и инструментов и оплачивать использование, как и другие службы Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-154">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>

## <a name="recommendations"></a><span data-ttu-id="c0d33-155">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="c0d33-155">Recommendations</span></span>

<span data-ttu-id="c0d33-156">Описанная здесь архитектура может не соответствовать вашим требованиям.</span><span class="sxs-lookup"><span data-stu-id="c0d33-156">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="c0d33-157">Воспользуйтесь этими рекомендациями в качестве отправной точки.</span><span class="sxs-lookup"><span data-stu-id="c0d33-157">Use these recommendations as a starting point.</span></span>

### <a name="vnet--subnets"></a><span data-ttu-id="c0d33-158">Виртуальная сеть и подсети</span><span class="sxs-lookup"><span data-stu-id="c0d33-158">VNet / Subnets</span></span>

<span data-ttu-id="c0d33-159">При создании виртуальной сети определите, сколько IP-адресов требуется для ресурсов в каждой подсети.</span><span class="sxs-lookup"><span data-stu-id="c0d33-159">When you create the VNet, determine how many IP addresses your resources in each subnet require.</span></span> <span data-ttu-id="c0d33-160">Укажите маску подсети и достаточно большой диапазон адресов виртуальной сети для требуемых IP-адресов с помощью нотации [CIDR].</span><span class="sxs-lookup"><span data-stu-id="c0d33-160">Specify a subnet mask and a VNet address range large enough for the required IP addresses, using [CIDR] notation.</span></span> <span data-ttu-id="c0d33-161">Используйте адресное пространство, которое входит в диапазон стандартных [блоков частных IP-адресов][private-ip-space], например 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="c0d33-161">Use an address space that falls within the standard [private IP address blocks][private-ip-space], which are 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16.</span></span>

<span data-ttu-id="c0d33-162">Выберите диапазон адресов, который не перекрывает локальную сеть, если вам нужно позже настроить шлюз между виртуальной сетью и локальной сетью.</span><span class="sxs-lookup"><span data-stu-id="c0d33-162">Choose an address range that does not overlap with your on-premises network, in case you need to set up a gateway between the VNet and your on-premises network later.</span></span> <span data-ttu-id="c0d33-163">Создав виртуальную сеть, изменить диапазон адресов нельзя.</span><span class="sxs-lookup"><span data-stu-id="c0d33-163">Once you create the VNet, you can't change the address range.</span></span>

<span data-ttu-id="c0d33-164">Проектируйте подсети с учетом требований к функциональности и безопасности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-164">Design subnets with functionality and security requirements in mind.</span></span> <span data-ttu-id="c0d33-165">Все виртуальные машины в пределах одного уровня или одной роли должны входить в одну и ту же подсеть, которая может быть надежным периметром безопасности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-165">All VMs within the same tier or role should go into the same subnet, which can be a security boundary.</span></span> <span data-ttu-id="c0d33-166">Дополнительные сведения о проектировании виртуальных сетей и подсетей см. в статье [Планирование и проектирование виртуальных сетей Azure][plan-network].</span><span class="sxs-lookup"><span data-stu-id="c0d33-166">For more information about designing VNets and subnets, see [Plan and design Azure Virtual Networks][plan-network].</span></span>

### <a name="load-balancers"></a><span data-ttu-id="c0d33-167">Балансировщики нагрузки</span><span class="sxs-lookup"><span data-stu-id="c0d33-167">Load balancers</span></span>

<span data-ttu-id="c0d33-168">Не подключайте виртуальные машины напрямую к Интернету. Вместо этого предоставьте каждой из них частный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c0d33-168">Don't expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="c0d33-169">Клиент подключается через общедоступный IP-адрес, связанный со Шлюзом приложений.</span><span class="sxs-lookup"><span data-stu-id="c0d33-169">Clients connect using the public IP address associated with the Application Gateway.</span></span>

<span data-ttu-id="c0d33-170">Определите правила подсистемы балансировки нагрузки для направления трафика к виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="c0d33-170">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="c0d33-171">Например, чтобы включить трафик HTTP, сопоставьте порт 80 интерфейсной конфигурации с портом 80 серверного пула адресов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-171">For example, to enable HTTP traffic, map port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="c0d33-172">Когда клиент отправляет HTTP-запрос на порт 80, подсистема балансировки нагрузки выбирает IP-адрес серверной части с помощью [хэш-алгоритма][load-balancer-hashing], который включает исходный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c0d33-172">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load-balancer-hashing] that includes the source IP address.</span></span> <span data-ttu-id="c0d33-173">Клиентские запросы распределяются между всеми виртуальными машинами в серверном пуле адресов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-173">Client requests are distributed across all the VMs in the back-end address pool.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="c0d33-174">Группы безопасности сети</span><span class="sxs-lookup"><span data-stu-id="c0d33-174">Network security groups</span></span>

<span data-ttu-id="c0d33-175">С помощью правил NSG можно ограничить трафик между уровнями.</span><span class="sxs-lookup"><span data-stu-id="c0d33-175">Use NSG rules to restrict traffic between tiers.</span></span> <span data-ttu-id="c0d33-176">В показанной выше трехуровневой архитектуре веб-уровень не взаимодействует напрямую с уровнем базы данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-176">In the three-tier architecture shown above, the web tier does not communicate directly with the database tier.</span></span> <span data-ttu-id="c0d33-177">Чтобы обеспечить эту возможность, уровень базы данных должен блокировать входящий трафик из подсети веб-уровня.</span><span class="sxs-lookup"><span data-stu-id="c0d33-177">To enforce this, the database tier should block incoming traffic from the web tier subnet.</span></span>

1. <span data-ttu-id="c0d33-178">Запретите весь входящий трафик от виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c0d33-178">Deny all inbound traffic from the VNet.</span></span> <span data-ttu-id="c0d33-179">(В правиле используйте тег `VIRTUAL_NETWORK`.)</span><span class="sxs-lookup"><span data-stu-id="c0d33-179">(Use the `VIRTUAL_NETWORK` tag in the rule.)</span></span>
2. <span data-ttu-id="c0d33-180">Разрешите входящий трафик из подсети бизнес-уровня.</span><span class="sxs-lookup"><span data-stu-id="c0d33-180">Allow inbound traffic from the business tier subnet.</span></span>
3. <span data-ttu-id="c0d33-181">Разрешите входящий трафик из самой подсети уровня базы данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-181">Allow inbound traffic from the database tier subnet itself.</span></span> <span data-ttu-id="c0d33-182">Это правило обеспечивает взаимодействие между виртуальными машинами баз данных, которое необходимо для репликации и отработки отказа базы данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-182">This rule allows communication between the database VMs, which is needed for database replication and failover.</span></span>
4. <span data-ttu-id="c0d33-183">Разрешите трафик RDP (порт 3389) из подсети jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c0d33-183">Allow RDP traffic (port 3389) from the jumpbox subnet.</span></span> <span data-ttu-id="c0d33-184">Это правило позволяет администраторам подключаться к уровню базы данных из jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c0d33-184">This rule lets administrators connect to the database tier from the jumpbox.</span></span>

<span data-ttu-id="c0d33-185">Создайте правила 2 и 4 с более высоким приоритетом, чем у правила 1, чтобы они переопределяли его.</span><span class="sxs-lookup"><span data-stu-id="c0d33-185">Create rules 2 &ndash; 4 with higher priority than the first rule, so they override it.</span></span>

### <a name="sql-server-always-on-availability-groups"></a><span data-ttu-id="c0d33-186">Группы доступности AlwaysOn SQL Server</span><span class="sxs-lookup"><span data-stu-id="c0d33-186">SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="c0d33-187">Мы рекомендуем использовать [группы доступности AlwaysOn][sql-alwayson] для обеспечения высокого уровня доступности SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c0d33-187">We recommend [Always On Availability Groups][sql-alwayson] for SQL Server high availability.</span></span> <span data-ttu-id="c0d33-188">До Windows Server 2016 для групп доступности Always On требовался контроллер домена, а все узлы в группе доступности должны были находиться в одном домене AD.</span><span class="sxs-lookup"><span data-stu-id="c0d33-188">Prior to Windows Server 2016, Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same AD domain.</span></span>

<span data-ttu-id="c0d33-189">Другие уровни подключаются к базе данных с помощью [прослушивателя групп доступности][sql-alwayson-listeners].</span><span class="sxs-lookup"><span data-stu-id="c0d33-189">Other tiers connect to the database through an [availability group listener][sql-alwayson-listeners].</span></span> <span data-ttu-id="c0d33-190">Прослушиватель позволяет клиенту SQL подключаться, не зная имени физического экземпляра SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c0d33-190">The listener enables a SQL client to connect without knowing the name of the physical instance of SQL Server.</span></span> <span data-ttu-id="c0d33-191">Виртуальные машины, которые обращаются к базе данных, должны быть присоединены к домену.</span><span class="sxs-lookup"><span data-stu-id="c0d33-191">VMs that access the database must be joined to the domain.</span></span> <span data-ttu-id="c0d33-192">Клиент (в этом случае другой уровень) использует DNS для разрешения имени виртуальной сети прослушивателя в IP-адресах.</span><span class="sxs-lookup"><span data-stu-id="c0d33-192">The client (in this case, another tier) uses DNS to resolve the listener's virtual network name into IP addresses.</span></span>

<span data-ttu-id="c0d33-193">Настройте группы доступности AlwaysOn SQL Server следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c0d33-193">Configure the SQL Server Always On Availability Group as follows:</span></span>

1. <span data-ttu-id="c0d33-194">Создайте кластер отказоустойчивой кластеризации Windows Server, группу доступности AlwaysOn SQL Server и первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="c0d33-194">Create a Windows Server Failover Clustering (WSFC) cluster, a SQL Server Always On Availability Group, and a primary replica.</span></span> <span data-ttu-id="c0d33-195">Дополнительные сведения см. в статье [Начало работы с группами доступности AlwaysOn (SQL Server)][sql-alwayson-getting-started].</span><span class="sxs-lookup"><span data-stu-id="c0d33-195">For more information, see [Getting Started with Always On Availability Groups][sql-alwayson-getting-started].</span></span>
2. <span data-ttu-id="c0d33-196">Создайте внутреннюю подсистему балансировки нагрузки со статическим частным IP-адресом.</span><span class="sxs-lookup"><span data-stu-id="c0d33-196">Create an internal load balancer with a static private IP address.</span></span>
3. <span data-ttu-id="c0d33-197">Создайте прослушиватель группы доступности и сопоставьте его DNS-имя с IP-адресом внутренней подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c0d33-197">Create an availability group listener, and map the listener's DNS name to the IP address of an internal load balancer.</span></span>
4. <span data-ttu-id="c0d33-198">Создайте правило подсистемы балансировки нагрузки для порта прослушивания SQL Server (по умолчанию используется TCP-порт 1433).</span><span class="sxs-lookup"><span data-stu-id="c0d33-198">Create a load balancer rule for the SQL Server listening port (TCP port 1433 by default).</span></span> <span data-ttu-id="c0d33-199">Правило подсистемы балансировки нагрузки должно включать *плавающий IP-адрес*, также называемый прямым ответом от сервера.</span><span class="sxs-lookup"><span data-stu-id="c0d33-199">The load balancer rule must enable *floating IP*, also called Direct Server Return.</span></span> <span data-ttu-id="c0d33-200">В результате виртуальная машина будет отправлять ответ клиенту напрямую, что позволяет использовать прямое соединение с первичной репликой.</span><span class="sxs-lookup"><span data-stu-id="c0d33-200">This causes the VM to reply directly to the client, which enables a direct connection to the primary replica.</span></span>

   > [!NOTE]
   > <span data-ttu-id="c0d33-201">Если плавающий IP-адрес включен, номер внешнего порта должен совпадать с номером внутреннего порта в правиле подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c0d33-201">When floating IP is enabled, the front-end port number must be the same as the back-end port number in the load balancer rule.</span></span>
   >

<span data-ttu-id="c0d33-202">Если клиент SQL пытается выполнить подключение, подсистема балансировки нагрузки направляет запрос на подключение в первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="c0d33-202">When a SQL client tries to connect, the load balancer routes the connection request to the primary replica.</span></span> <span data-ttu-id="c0d33-203">Если происходит отработка отказа с переходом на другую реплику, подсистема балансировки нагрузки автоматически направляет новые запросы в новую первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="c0d33-203">If there is a failover to another replica, the load balancer automatically routes new requests to a new primary replica.</span></span> <span data-ttu-id="c0d33-204">Дополнительные сведения см. в статье [Настройка подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure][sql-alwayson-ilb].</span><span class="sxs-lookup"><span data-stu-id="c0d33-204">For more information, see [Configure an ILB listener for SQL Server Always On Availability Groups][sql-alwayson-ilb].</span></span>

<span data-ttu-id="c0d33-205">Во время отработки отказа имеющиеся клиентские подключения закрыты.</span><span class="sxs-lookup"><span data-stu-id="c0d33-205">During a failover, existing client connections are closed.</span></span> <span data-ttu-id="c0d33-206">После отработки отказа новые соединения направляются в новую первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="c0d33-206">After the failover completes, new connections will be routed to the new primary replica.</span></span>

<span data-ttu-id="c0d33-207">Если приложение выполняет значительно больше операций чтения, чем записи, вы можете разгрузить некоторые запросы только для чтения во вторичную реплику.</span><span class="sxs-lookup"><span data-stu-id="c0d33-207">If your application makes significantly more reads than writes, you can offload some of the read-only queries to a secondary replica.</span></span> <span data-ttu-id="c0d33-208">Ознакомьтесь с разделом [Соединение с помощью прослушивателя со вторичной репликой только для чтения (маршрутизация только для чтения)][sql-alwayson-read-only-routing].</span><span class="sxs-lookup"><span data-stu-id="c0d33-208">See [Using a Listener to Connect to a Read-Only Secondary Replica (Read-Only Routing)][sql-alwayson-read-only-routing].</span></span>

<span data-ttu-id="c0d33-209">Протестируйте развертывание, [принудительно выполнив отработку отказа][sql-alwayson-force-failover] группы доступности вручную.</span><span class="sxs-lookup"><span data-stu-id="c0d33-209">Test your deployment by [forcing a manual failover][sql-alwayson-force-failover] of the availability group.</span></span>

### <a name="jumpbox"></a><span data-ttu-id="c0d33-210">Jumpbox</span><span class="sxs-lookup"><span data-stu-id="c0d33-210">Jumpbox</span></span>

<span data-ttu-id="c0d33-211">Запретите доступ по протоколу RDP из общедоступного Интернета к виртуальным машинам, которые выполняют рабочую нагрузку приложения.</span><span class="sxs-lookup"><span data-stu-id="c0d33-211">Don't allow RDP access from the public Internet to the VMs that run the application workload.</span></span> <span data-ttu-id="c0d33-212">Вместо этого все доступы по протоколу RDP к этим виртуальным машинам должны проходить через jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c0d33-212">Instead, all RDP access to these VMs must come through the jumpbox.</span></span> <span data-ttu-id="c0d33-213">Администратор выполняет вход в jumpbox, а затем вход в другую виртуальную машину из jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c0d33-213">An administrator logs into the jumpbox, and then logs into the other VM from the jumpbox.</span></span> <span data-ttu-id="c0d33-214">jumpbox разрешает RDP трафик из Интернета, однако только из известных и безопасных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-214">The jumpbox allows RDP traffic from the Internet, but only from known, safe IP addresses.</span></span>

<span data-ttu-id="c0d33-215">Jumpbox имеет минимальные требования к производительности, поэтому выберите небольшой размер виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c0d33-215">The jumpbox has minimal performance requirements, so select a small VM size.</span></span> <span data-ttu-id="c0d33-216">Создайте [общедоступный IP-адрес] для jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c0d33-216">Create a [public IP address] for the jumpbox.</span></span> <span data-ttu-id="c0d33-217">Поместите jumpbox в виртуальную сеть вместе с другими виртуальными машинами, однако в отдельную подсеть управления.</span><span class="sxs-lookup"><span data-stu-id="c0d33-217">Place the jumpbox in the same VNet as the other VMs, but in a separate management subnet.</span></span>

<span data-ttu-id="c0d33-218">Чтобы защитить jumpbox, добавьте правило NSG, разрешающее подключения по протоколу RDP только из безопасного набора общедоступных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-218">To secure the jumpbox, add an NSG rule that allows RDP connections only from a safe set of public IP addresses.</span></span> <span data-ttu-id="c0d33-219">Настройте NSG для других подсетей, чтобы разрешить трафик RDP из подсети управления.</span><span class="sxs-lookup"><span data-stu-id="c0d33-219">Configure the NSGs for the other subnets to allow RDP traffic from the management subnet.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="c0d33-220">Вопросы масштабируемости</span><span class="sxs-lookup"><span data-stu-id="c0d33-220">Scalability considerations</span></span>

<span data-ttu-id="c0d33-221">Рассмотрите возможность использования [масштабируемых наборов виртуальных машин][vmss] для веб-уровня и бизнес-уровня, вместо развертывания отдельных виртуальных машин в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-221">For the web and business tiers, consider using [virtual machine scale sets][vmss], instead of deploying separate VMs into an availability set.</span></span> <span data-ttu-id="c0d33-222">Масштабируемый набор упрощает процессы развертывания и администрирования набора идентичных виртуальных машин, а также автоматического масштабирования виртуальных машин на основе метрик производительности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-222">A scale set makes it easy to deploy and manage a set of identical VMs, and autoscale the VMs based on performance metrics.</span></span> <span data-ttu-id="c0d33-223">По мере увеличения нагрузки на виртуальные машины в подсистему балансировки нагрузки автоматически добавляются дополнительные виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="c0d33-223">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="c0d33-224">Подумайте об использовании масштабируемых наборов, если необходимо быстро развернуть виртуальные машины или выполнить автомасштабирование.</span><span class="sxs-lookup"><span data-stu-id="c0d33-224">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="c0d33-225">Настройку виртуальных машин, развернутых в масштабируемый набор, можно выполнить двумя основными способами:</span><span class="sxs-lookup"><span data-stu-id="c0d33-225">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="c0d33-226">Используйте расширения для настройки виртуальной машины после ее развертывания.</span><span class="sxs-lookup"><span data-stu-id="c0d33-226">Use extensions to configure the VM after it's deployed.</span></span> <span data-ttu-id="c0d33-227">В этом случае новые экземпляры виртуальной машины могут дольше запускаться, чем виртуальные машины без расширений.</span><span class="sxs-lookup"><span data-stu-id="c0d33-227">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="c0d33-228">Развернуть [управляемый диск](/azure/storage/storage-managed-disks-overview) с помощью пользовательского образа диска.</span><span class="sxs-lookup"><span data-stu-id="c0d33-228">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="c0d33-229">При этом развертывание выполняется быстрее.</span><span class="sxs-lookup"><span data-stu-id="c0d33-229">This option may be quicker to deploy.</span></span> <span data-ttu-id="c0d33-230">Но образ необходимо обновлять.</span><span class="sxs-lookup"><span data-stu-id="c0d33-230">However, it requires you to keep the image up-to-date.</span></span>

<span data-ttu-id="c0d33-231">Дополнительные сведения см. в статье [Рекомендации по проектированию масштабируемых наборов][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="c0d33-231">For more information, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="c0d33-232">При использовании любого решения автоматического масштабирования заблаговременно протестируйте его с рабочими нагрузками производственного уровня.</span><span class="sxs-lookup"><span data-stu-id="c0d33-232">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="c0d33-233">В каждой подписке Azure настроены ограничения по умолчанию, включая максимальное количество виртуальных машин в каждом регионе.</span><span class="sxs-lookup"><span data-stu-id="c0d33-233">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="c0d33-234">Их лимит можно увеличить, создав запрос на поддержку.</span><span class="sxs-lookup"><span data-stu-id="c0d33-234">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="c0d33-235">Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="c0d33-235">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="c0d33-236">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="c0d33-236">Availability considerations</span></span>

<span data-ttu-id="c0d33-237">Если вы не используете масштабируемые наборы виртуальных машин, разместите виртуальные машины для одного уровня в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-237">If you don't use virtual machine scale sets, put VMs for the same tier into an availability set.</span></span> <span data-ttu-id="c0d33-238">Создайте по крайней мере две виртуальные машины в группе доступности для реализации [соглашения об уровне обслуживания, гарантирующем доступность виртуальных машин Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="c0d33-238">Create at least two VMs in the availability set to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="c0d33-239">Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure][availability-set].</span><span class="sxs-lookup"><span data-stu-id="c0d33-239">For more information, see [Manage the availability of virtual machines][availability-set].</span></span> <span data-ttu-id="c0d33-240">Масштабируемые наборы автоматически используют *группы размещения*, которые функционируют как неявная группа доступности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-240">Scale sets automatically use *placement groups*, which act as an implicit availability set.</span></span>

<span data-ttu-id="c0d33-241">Подсистема балансировки нагрузки выполняет [проверку работоспособности][health-probes], чтобы отслеживать доступность экземпляров виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="c0d33-241">The load balancer uses [health probes][health-probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="c0d33-242">Если пробу не удается выполнить в экземпляре в течение определенного времени, подсистема балансировки нагрузки останавливает отправку трафика на эту виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="c0d33-242">If a probe can't reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="c0d33-243">Тем не менее подсистема балансировки нагрузки продолжит выполнять проверку, и если виртуальная машина станет снова доступна, отправка трафика к этой виртуальной машине будет возобновлена.</span><span class="sxs-lookup"><span data-stu-id="c0d33-243">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="c0d33-244">Вот несколько рекомендаций по проверке работоспособности подсистемы балансировки нагрузки:</span><span class="sxs-lookup"><span data-stu-id="c0d33-244">Here are some recommendations on load balancer health probes:</span></span>

- <span data-ttu-id="c0d33-245">При проверке может тестироваться HTTP или TCP.</span><span class="sxs-lookup"><span data-stu-id="c0d33-245">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="c0d33-246">Если на виртуальных машинах запущен HTTP-сервер, создайте проверку HTTP.</span><span class="sxs-lookup"><span data-stu-id="c0d33-246">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="c0d33-247">В противном случае создайте проверку TCP.</span><span class="sxs-lookup"><span data-stu-id="c0d33-247">Otherwise create a TCP probe.</span></span>
- <span data-ttu-id="c0d33-248">В проверке HTTP укажите путь к конечной точке HTTP.</span><span class="sxs-lookup"><span data-stu-id="c0d33-248">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="c0d33-249">При этом проверяется код ответа HTTP 200 с этого пути.</span><span class="sxs-lookup"><span data-stu-id="c0d33-249">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="c0d33-250">Этим путем может быть путь к корневому каталогу (/) или конечная точка мониторинга работоспособности, которая реализует определенную пользовательскую логику для проверки работоспособности приложения.</span><span class="sxs-lookup"><span data-stu-id="c0d33-250">This path can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="c0d33-251">Конечная точка должна разрешать анонимные HTTP-запросы.</span><span class="sxs-lookup"><span data-stu-id="c0d33-251">The endpoint must allow anonymous HTTP requests.</span></span>
- <span data-ttu-id="c0d33-252">Проверка отправляется с [известного][health-probe-ip] IP-адреса — 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="c0d33-252">The probe is sent from a [known IP address][health-probe-ip], 168.63.129.16.</span></span> <span data-ttu-id="c0d33-253">Не блокируйте входящий и исходящий трафик для этого IP-адреса в политиках брандмауэра или правилах группы безопасности сети.</span><span class="sxs-lookup"><span data-stu-id="c0d33-253">Don't block traffic to or from this IP address in any firewall policies or NSG rules.</span></span>
- <span data-ttu-id="c0d33-254">Используйте [журналы проверки работоспособности][health-probe-log] для просмотра состояния проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-254">Use [health probe logs][health-probe-log] to view the status of the health probes.</span></span> <span data-ttu-id="c0d33-255">Включите ведение журнала на портале Azure для каждой подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c0d33-255">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="c0d33-256">Журналы записываются в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-256">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="c0d33-257">В журналах показано, сколько виртуальных машин не получают сетевой трафик из-за ответов о неудачной попытке пробы.</span><span class="sxs-lookup"><span data-stu-id="c0d33-257">The logs show how many VMs aren't getting network traffic because of failed probe responses.</span></span>

<span data-ttu-id="c0d33-258">Если требуется более высокий уровень доступности, чем обеспечивает [соглашение об уровне обслуживания Azure для виртуальных машин][vm-sla], реплицируйте приложение в два региона, используя диспетчер трафика Azure для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="c0d33-258">If you need higher availability than the [Azure SLA for VMs][vm-sla] provides, consider replication the application across two regions, using Azure Traffic Manager for failover.</span></span> <span data-ttu-id="c0d33-259">Дополнительные сведения см. в статье [Высокодоступное N-уровневое приложение с поддержкой нескольких регионов][multi-dc].</span><span class="sxs-lookup"><span data-stu-id="c0d33-259">For more information, see [Multi-region N-tier application for high availability][multi-dc].</span></span>

## <a name="security-considerations"></a><span data-ttu-id="c0d33-260">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="c0d33-260">Security considerations</span></span>

<span data-ttu-id="c0d33-261">Виртуальные сети являются границей, изолирующей трафик в Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-261">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="c0d33-262">Виртуальные машины из разных виртуальных сетей не могут напрямую обмениваться данными.</span><span class="sxs-lookup"><span data-stu-id="c0d33-262">VMs in one VNet can't communicate directly with VMs in a different VNet.</span></span> <span data-ttu-id="c0d33-263">Виртуальные машины в одной виртуальной сети могут обмениваться данными, если только не созданы [группы безопасности сети][nsg], ограничивающие этот трафик.</span><span class="sxs-lookup"><span data-stu-id="c0d33-263">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="c0d33-264">Дополнительные сведения см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][network-security].</span><span class="sxs-lookup"><span data-stu-id="c0d33-264">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="c0d33-265">**DMZ**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-265">**DMZ**.</span></span> <span data-ttu-id="c0d33-266">Попробуйте добавить сетевой виртуальный модуль (NVA), чтобы создать сеть периметра между Интернетом и виртуальною сетью Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-266">Consider adding a network virtual appliance (NVA) to create a DMZ between the Internet and the Azure virtual network.</span></span> <span data-ttu-id="c0d33-267">Сетевой виртуальный модуль — это универсальный термин для виртуального модуля, который может выполнять сетевые задачи, например брандмауэра, проверки пакетов, аудита и пользовательской маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="c0d33-267">NVA is a generic term for a virtual appliance that can perform network-related tasks, such as firewall, packet inspection, auditing, and custom routing.</span></span> <span data-ttu-id="c0d33-268">Дополнительные сведения см. в статье [Сеть периметра между Azure и Интернетом][dmz].</span><span class="sxs-lookup"><span data-stu-id="c0d33-268">For more information, see [Implementing a DMZ between Azure and the Internet][dmz].</span></span>

<span data-ttu-id="c0d33-269">**Шифрование**.</span><span class="sxs-lookup"><span data-stu-id="c0d33-269">**Encryption**.</span></span> <span data-ttu-id="c0d33-270">Выполните шифрование конфиденциальных неактивных данных и используйте [Azure Key Vault][azure-key-vault] для управления ключами шифрования базы данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-270">Encrypt sensitive data at rest and use [Azure Key Vault][azure-key-vault] to manage the database encryption keys.</span></span> <span data-ttu-id="c0d33-271">Key Vault может хранить ключи шифрования в аппаратных модулях безопасности.</span><span class="sxs-lookup"><span data-stu-id="c0d33-271">Key Vault can store encryption keys in hardware security modules (HSMs).</span></span> <span data-ttu-id="c0d33-272">Дополнительные сведения см. в статье [Настройка интеграции Azure Key Vault для SQL Server на виртуальных машинах Azure (Resource Manager)][sql-keyvault].</span><span class="sxs-lookup"><span data-stu-id="c0d33-272">For more information, see [Configure Azure Key Vault Integration for SQL Server on Azure VMs][sql-keyvault].</span></span> <span data-ttu-id="c0d33-273">В Key Vault также рекомендуется хранить секреты приложения, например строки подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="c0d33-273">It's also recommended to store application secrets, such as database connection strings, in Key Vault.</span></span>

<span data-ttu-id="c0d33-274">**Защита от атак DDoS.**</span><span class="sxs-lookup"><span data-stu-id="c0d33-274">**DDoS protection**.</span></span> <span data-ttu-id="c0d33-275">Платформа Azure по умолчанию предоставляет основные средства защиты от атак DDoS.</span><span class="sxs-lookup"><span data-stu-id="c0d33-275">The Azure platform provides basic DDoS protection by default.</span></span> <span data-ttu-id="c0d33-276">Эти основные средства защиты предназначены для защиты всей инфраструктуры Azure.</span><span class="sxs-lookup"><span data-stu-id="c0d33-276">This basic protection is targeted at protecting the Azure infrastructure as a whole.</span></span> <span data-ttu-id="c0d33-277">Хотя базовая защита от атак DDoS включается автоматически, рекомендуется использовать [Защиту Azure от атак DDoS ценовой категории "Стандартный"][ddos].</span><span class="sxs-lookup"><span data-stu-id="c0d33-277">Although basic DDoS protection is automatically enabled, we recommend using [DDoS Protection Standard][ddos].</span></span> <span data-ttu-id="c0d33-278">Для ценовой категории "Стандартный" предусмотрена адаптивная настройка для обнаружения угроз на основе моделей сетевого трафика вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="c0d33-278">Standard protection uses adaptive tuning, based on your application's network traffic patterns, to detect threats.</span></span> <span data-ttu-id="c0d33-279">Это позволяет устранять риски атак DDoS, которые могут остаться незамеченными для соответствующих политик уровня инфраструктуры.</span><span class="sxs-lookup"><span data-stu-id="c0d33-279">This allows it to apply mitigations against DDoS attacks that might go unnoticed by the infrastructure-wide DDoS policies.</span></span> <span data-ttu-id="c0d33-280">Для этой ценовой категории также включена поддержка оповещений, телеметрии и аналитики на основе Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="c0d33-280">Standard protection also provides alerting, telemetry, and analytics through Azure Monitor.</span></span> <span data-ttu-id="c0d33-281">Дополнительные сведения см. в руководстве по [использованию Защиты от атак DDoS Azure с рекомендациями и эталонной архитектурой][ddos-best-practices].</span><span class="sxs-lookup"><span data-stu-id="c0d33-281">For more information, see [Azure DDoS Protection: Best practices and reference architectures][ddos-best-practices].</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="c0d33-282">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="c0d33-282">Deploy the solution</span></span>

<span data-ttu-id="c0d33-283">Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="c0d33-283">A deployment for this reference architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="c0d33-284">Вся процедура развертывания, включая выполнение скриптов для настройки AD DS, развертывание отказоустойчивого кластера Windows Server и группы доступности SQL Server, может занять до двух часов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-284">The entire deployment can take up to two hours, which includes running the scripts to configure AD DS, the Windows Server failover cluster, and the SQL Server availability group.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="c0d33-285">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="c0d33-285">Prerequisites</span></span>

[!INCLUDE [ref-arch-prerequisites.md](../../../includes/ref-arch-prerequisites.md)]

### <a name="deployment-steps"></a><span data-ttu-id="c0d33-286">Шаги по развертыванию</span><span class="sxs-lookup"><span data-stu-id="c0d33-286">Deployment steps</span></span>

1. <span data-ttu-id="c0d33-287">Выполните следующую команду, чтобы создать группу ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c0d33-287">Run the following command to create a resource group.</span></span>

    ```azurecli
    az group create --location <location> --name <resource-group-name>
    ```

2. <span data-ttu-id="c0d33-288">Выполните следующую команду, чтобы создать учетную запись хранения для облачного ресурса-свидетеля.</span><span class="sxs-lookup"><span data-stu-id="c0d33-288">Run the following command to create a Storage account for the Cloud Witness.</span></span>

    ```azurecli
    az storage account create --location <location> \
      --name <storage-account-name> \
      --resource-group <resource-group-name> \
      --sku Standard_LRS
    ```

3. <span data-ttu-id="c0d33-289">Перейдите в папку `virtual-machines\n-tier-windows` в репозитории эталонных архитектур на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="c0d33-289">Navigate to the `virtual-machines\n-tier-windows` folder of the reference architectures GitHub repository.</span></span>

4. <span data-ttu-id="c0d33-290">Откройте файл `n-tier-windows.json` .</span><span class="sxs-lookup"><span data-stu-id="c0d33-290">Open the `n-tier-windows.json` file.</span></span>

5. <span data-ttu-id="c0d33-291">С помощью поиска найдите все вхождения "witnessStorageBlobEndPoint" и замените текст заполнителя именем учетной записи хранения, созданным на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="c0d33-291">Search for all instances of "witnessStorageBlobEndPoint" and replace the placeholder text with the name of the Storage account from step 2.</span></span>

    ```json
    "witnessStorageBlobEndPoint": "https://[replace-with-storageaccountname].blob.core.windows.net",
    ```

6. <span data-ttu-id="c0d33-292">Выполните следующую команду, чтобы вывести список ключей учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="c0d33-292">Run the following command to list the account keys for the storage account.</span></span>

    ```azurecli
    az storage account keys list \
      --account-name <storage-account-name> \
      --resource-group <resource-group-name>
    ```

    <span data-ttu-id="c0d33-293">Полученный результат должен выглядеть примерно так:</span><span class="sxs-lookup"><span data-stu-id="c0d33-293">The output should look like the following.</span></span> <span data-ttu-id="c0d33-294">Скопируйте значение `key1`.</span><span class="sxs-lookup"><span data-stu-id="c0d33-294">Copy the value of `key1`.</span></span>

    ```json
    [
    {
        "keyName": "key1",
        "permissions": "Full",
        "value": "..."
    },
    {
        "keyName": "key2",
        "permissions": "Full",
        "value": "..."
    }
    ]
    ```

7. <span data-ttu-id="c0d33-295">В файле `n-tier-windows.json` найдите все вхождения "witnessStorageAccountKey" и вставьте ключ учетной записи.</span><span class="sxs-lookup"><span data-stu-id="c0d33-295">In the `n-tier-windows.json` file, search for all instances of "witnessStorageAccountKey" and paste in the account key.</span></span>

    ```json
    "witnessStorageAccountKey": "[replace-with-storagekey]"
    ```

8. <span data-ttu-id="c0d33-296">В файле `n-tier-windows.json` найдите все вхождения `[replace-with-password]` и `[replace-with-sql-password]`. Замените их надежным паролем.</span><span class="sxs-lookup"><span data-stu-id="c0d33-296">In the `n-tier-windows.json` file, search for all instances of `[replace-with-password]` and `[replace-with-sql-password]` replace them with a strong password.</span></span> <span data-ttu-id="c0d33-297">Сохраните файл.</span><span class="sxs-lookup"><span data-stu-id="c0d33-297">Save the file.</span></span>

    > [!NOTE]
    > <span data-ttu-id="c0d33-298">Если вы измените имя администратора, необходимо также обновить блоки `extensions` в файле JSON.</span><span class="sxs-lookup"><span data-stu-id="c0d33-298">If you change the administrator user name, you must also update the `extensions` blocks in the JSON file.</span></span>

9. <span data-ttu-id="c0d33-299">Выполните следующую команду, чтобы развернуть архитектуру.</span><span class="sxs-lookup"><span data-stu-id="c0d33-299">Run the following command to deploy the architecture.</span></span>

    ```azurecli
    azbb -s <your subscription_id> -g <resource_group_name> -l <location> -p n-tier-windows.json --deploy
    ```

<span data-ttu-id="c0d33-300">Дополнительные сведения о развертывании этого примера эталонной архитектуры с использованием стандартных блоков Azure см. в [нашем репозитории GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="c0d33-300">For more information on deploying this sample reference architecture using Azure Building Blocks, visit the [GitHub repository][git].</span></span>

## <a name="next-steps"></a><span data-ttu-id="c0d33-301">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="c0d33-301">Next steps</span></span>

- [<span data-ttu-id="c0d33-302">Модуль Microsoft Learn. Обзор N-уровневой архитектуры</span><span class="sxs-lookup"><span data-stu-id="c0d33-302">Microsoft Learn module: Tour the N-tier architecture style</span></span>](/learn/modules/n-tier-architecture/)

<!-- links -->
[dmz]: ../dmz/secure-vnet-dmz.md
[multi-dc]: multi-region-sql-server.md
[n-tier]: n-tier.md
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-windows-manage-availability#configure-each-application-tier-into-separate-availability-sets
[azure-dns]: /azure/dns/dns-overview
[azure-key-vault]: https://azure.microsoft.com/services/key-vault
[узлом-бастионом]: https://en.wikipedia.org/wiki/Bastion_host
[bastion host]: https://en.wikipedia.org/wiki/Bastion_host
[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[cidr]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[ddos]: /azure/virtual-network/ddos-protection-overview
[ddos-best-practices]: /azure/security/azure-ddos-best-practices
[git]: https://github.com/mspnp/template-building-blocks
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-windows
[nsg]: /azure/virtual-network/virtual-networks-nsg
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[Общедоступный IP-адрес]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[public IP address]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[sql-alwayson]: https://msdn.microsoft.com/library/hh510230.aspx
[sql-alwayson-force-failover]: https://msdn.microsoft.com/library/ff877957.aspx
[sql-alwayson-getting-started]: https://msdn.microsoft.com/library/gg509118.aspx
[sql-alwayson-ilb]: /azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener
[sql-alwayson-listeners]: https://msdn.microsoft.com/library/hh213417.aspx
[sql-alwayson-read-only-routing]: https://technet.microsoft.com/library/hh213417.aspx#ConnectToSecondary
[sql-keyvault]: /azure/virtual-machines/virtual-machines-windows-ps-sql-keyvault
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vnet faq]: /azure/virtual-network/virtual-networks-faq
[wsfc-whats-new]: https://technet.microsoft.com/windows-server-docs/failover-clustering/whats-new-in-failover-clustering
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[load-balancer]: /azure/load-balancer/
[load-balancer-hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[subscription-limits]: /azure/azure-subscription-service-limits
[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[health-probes]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-log]: /azure/load-balancer/load-balancer-monitor-log
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[network-security]: /azure/best-practices-network-security
