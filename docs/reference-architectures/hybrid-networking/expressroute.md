---
title: "Подключение локальной сети к Azure с помощью ExpressRoute"
description: "Инструкции по реализации архитектуры защищенной сети \"сеть — сеть\", которая включает виртуальную сеть Azure и локальную сеть, подключенные с помощью Azure ExpressRoute."
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Connect an on-premises network to Azure
pnp.series.next: expressroute-vpn-failover
pnp.series.prev: vpn
cardTitle: ExpressRoute
ms.openlocfilehash: 671be5118faaefab5ba5348de81642d8a8124b59
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="connect-an-on-premises-network-to-azure-using-expressroute"></a>Подключение локальной сети к Azure с помощью ExpressRoute

На схеме с этой эталонной архитектурой показано, как подключить локальную сеть к виртуальным сетям в Azure с помощью [Azure ExpressRoute][expressroute-introduction]. Подключения ExpressRoute создают закрытые выделенные подключения через сети сторонних поставщиков услуг подключения. Такое частное подключение расширяет вашу локальную сеть в Azure. [**Разверните это решение**.](#deploy-the-solution)

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры.*

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов:

* **Локальная корпоративная сеть**. Частная локальная сеть, работающая внутри организации.

* **Канал ExpressRoute.** Это канал уровня 2 или 3, который предоставляет поставщик подключения. Он позволяет подключиться к локальной сети с Azure через пограничные маршрутизаторы. Канал использует инфраструктуру оборудования, настроенную поставщиком подключения.

* **Локальные пограничные маршрутизаторы**. Маршрутизаторы, позволяющие подключить локальную сеть к каналу, которым управляет поставщик. В зависимости от способа подготовки подключения может потребоваться предоставить общедоступные IP-адреса, используемые маршрутизаторами.
* **Пограничные маршрутизаторы Майкрософт**. Два маршрутизатора в конфигурации "активный — активный" с высоким уровнем доступности. Эти маршрутизаторы позволяют поставщикам услуг подключения напрямую подключать свои каналы к центру обработки данных. В зависимости от способа подготовки подключения может потребоваться предоставить общедоступные IP-адреса, используемые маршрутизаторами.

* **Виртуальные сети Azure**. Каждая виртуальная сеть находится в одном регионе Azure и может содержать несколько уровней приложения. Уровни приложения могут быть разделены на сегменты с помощью подсетей в каждой виртуальной сети.

* **Общедоступные службы Azure**. Службы Azure, которые могут использоваться в гибридных приложениях. Эти службы также доступны в Интернете. Но при получении к ним доступа через канал ExpressRoute вы получите минимальную задержку и более предсказуемую производительность, так как трафик не проходит через Интернет. Подключения устанавливаются с использованием [общедоступного пиринга][expressroute-peering] и адресов, которые принадлежат организации или предоставляются поставщиком услуг подключения.

* **Службы Office 365**. Общедоступные приложения и службы Office 365, предоставляемые корпорацией Майкрософт. Подключения устанавливаются с использованием [пиринга Майкрософт][expressroute-peering] и адресов, которые принадлежат организации или предоставляются поставщиком услуг подключения. С помощью пиринга Майкрософт можно также напрямую подключиться к Microsoft CRM Online.

* **Поставщики услуг подключения** (не показаны). Компании, которые предоставляют услуги подключения на уровне 2 или 3 между вашим центром обработки данных и центром обработки данных Azure.

## <a name="recommendations"></a>Рекомендации

Следующие рекомендации применимы для большинства ситуаций. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.

### <a name="connectivity-providers"></a>Поставщики услуг подключения

Выберите подходящего поставщика услуг подключения ExpressRoute для вашего расположения. Чтобы получить список поставщиков услуг подключения, доступных в вашем расположении, используйте следующую команду Azure PowerShell:

```powershell
Get-AzureRmExpressRouteServiceProvider
```

Поставщики услуг подключения ExpressRoute подключают ваш центр обработки данных к Майкрософт одним из следующих способов:

* **Совместное размещение в Cloud Exchange**. При размещении на одном сервере с Cloud Exchange можно заказать виртуальное кросс-подключение к Azure через инфраструктуру Ethernet Exchange, предоставляемую поставщиком услуг совместного размещения. Поставщики услуг совместного размещения могут предлагать кросс-подключения уровня 2 или управляемые кросс-подключения уровня 3 между для вашей инфраструктуры на сервере совместного размещения и Azure.
* **Подключения Ethernet "точка — точка"** Локальные центры обработки данных и офисы можно связать с Azure в рамках Ethernet-подключения "точка — точка". Поставщики услуг подключения Ethernet "точка — точка" могут предлагать подключения уровня 2 или управляемые подключения уровня 3 между вашей сетью и Azure.
* **Сети "любой к любому" (IPVPN)** Глобальную сеть (WAN) можно интегрировать с Azure. Поставщики услуг IP VPN (как правило, предлагающие MPLS VPN) обеспечивают подключения "любой к любому" между филиалами и центрами обработки данных. Azure можно связать с вашей сетью WAN, так чтобы это выглядело как подключение к любому другому филиалу. Обычно поставщики сетей WAN предлагают управляемые подключения уровня 3.

Дополнительные сведения о поставщиках услуг подключения см. в статье [Обзор ExpressRoute][expressroute-introduction].

### <a name="expressroute-circuit"></a>Канал ExpressRoute

Чтобы подключиться к Azure, убедитесь, что в вашей организации удовлетворены [обязательные требования ExpressRoute][expressroute-prereqs].

Добавьте подсеть с именем `GatewaySubnet` в виртуальную сеть Azure и создайте шлюз виртуальной сети ExpressRoute с помощью службы VPN-шлюза Azure, если вы еще это не сделали. Дополнительные сведения об этом процессе см. в статье [Процедуры ExpressRoute для подготовки каналов и состояний каналов][ExpressRoute-provisioning].

Создайте канал ExpressRoute, сделав следующее:

1. Выполните следующую команду PowerShell:
   
    ```powershell
    New-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>> -Location <<location>> -SkuTier <<sku-tier>> -SkuFamily <<sku-family>> -ServiceProviderName <<service-provider-name>> -PeeringLocation <<peering-location>> -BandwidthInMbps <<bandwidth-in-mbps>>
    ```
2. Отправьте `ServiceKey` для нового канала поставщику услуг.

3. Подождите, пока поставщик подготовит канал. Чтобы проверить состояние подготовки канала, выполните следующую команду PowerShell:
   
    ```powershell
    Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    ```

    Когда канал будет готов, значение в поле `Provisioning state` в разделе `Service Provider` выходных данных изменится с `NotProvisioned` на `Provisioned`.

    > [!NOTE]
    > Если вы используете подключение уровня 3, поставщик должен настраивать и администрировать маршрутизацию для вас. Вы должны предоставить поставщику необходимые сведения для реализации соответствующих маршрутов.
    > 
    > 

4. Если вы используете подключение уровня 2, сделайте следующее:

    1. Зарезервируйте две подсети /30, которые содержат допустимые общедоступные IP-адреса для каждого типа пиринга, который необходимо реализовать. Эти подсети /30 будут применяться, чтобы предоставлять IP-адресов маршрутизаторам, которые используются для канала. При реализации частного, общедоступного пиринга и пиринга Майкрософт вам понадобится 6 подсетей /30 с допустимыми общедоступными IP-адресами.     

    2. Настройте маршрутизацию для канала ExpressRoute. Выполните следующие команды PowerShell для каждого типа пиринга, который нужно настроить (частный и общедоступный пиринг, а также пиринг Майкрософт). Дополнительные сведения см. в статье [Создание и изменение пиринга для канала ExpressRoute с помощью PowerShell][configure-expressroute-routing].
   
        ```powershell
        Set-AzureRmExpressRouteCircuitPeeringConfig -Name <<peering-name>> -Circuit <<circuit-name>> -PeeringType <<peering-type>> -PeerASN <<peer-asn>> -PrimaryPeerAddressPrefix <<primary-peer-address-prefix>> -SecondaryPeerAddressPrefix <<secondary-peer-address-prefix>> -VlanId <<vlan-id>>

        Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit <<circuit-name>>
        ```

    3. Зарезервируйте другой пул допустимых общедоступных IP-адресов, чтобы применять преобразование сетевых адресов (NAT) для общедоступного пиринга и пиринга Майкрософт. Рекомендуется использовать разные пулы для каждого пиринга. Предоставьте пул поставщику услуг подключения, чтобы он смог настроить объявления BGP (протокол пограничного шлюза) для этих диапазонов.

5. Выполните следующие команды PowerShell, чтобы связать частные виртуальные сети с каналом ExpressRoute. Дополнительные сведения см. в статье [Подключение виртуальной сети к каналу ExpressRoute][link-vnet-to-expressroute].

    ```powershell
    $circuit = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    $gw = Get-AzureRmVirtualNetworkGateway -Name <<gateway-name>> -ResourceGroupName <<resource-group>>
    New-AzureRmVirtualNetworkGatewayConnection -Name <<connection-name>> -ResourceGroupName <<resource-group>> -Location <<location> -VirtualNetworkGateway1 $gw -PeerId $circuit.Id -ConnectionType ExpressRoute
    ```

Вы можете подключить несколько виртуальных сетей, размещенных в разных регионах, к одному каналу ExpressRoute, если только все виртуальные сети и канал ExpressRoute расположены в одном геополитическом регионе.

### <a name="troubleshooting"></a>Устранение неполадок 

Если работоспособному каналу ExpressRoute сейчас не удается установить подключение при отсутствии изменений конфигурации в локальной или частной виртуальной частной сети, обратитесь к поставщику услуг подключения и поддерживайте с ним связь, чтобы устранить проблему. Чтобы проверить, подготовлен ли канал ExpressRoute, используйте следующие команды Powershell:

```powershell
Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
```

В результатах выполнения команды отображается несколько свойств канала, включая `ProvisioningState`, `CircuitProvisioningState` и `ServiceProviderProvisioningState`, как показано ниже.

```
ProvisioningState                : Succeeded
Sku                              : {
                                     "Name": "Standard_MeteredData",
                                     "Tier": "Standard",
                                     "Family": "MeteredData"
                                   }
CircuitProvisioningState         : Enabled
ServiceProviderProvisioningState : NotProvisioned
```

Если для свойства `ProvisioningState` не отображается значение `Succeeded` после того, как вы попытались создать канал, удалите этот канал с помощью следующей команды, и создайте его еще раз.

```powershell
Remove-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
```

Если канал подготовлен, но для свойства `ProvisioningState` отображается значение `Failed` или для свойства `CircuitProvisioningState` не отображается значение `Enabled`, обратитесь к поставщику за дополнительной помощью.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Каналы ExpressRoute обеспечивают путь с высокой пропускной способностью между сетями. Как правило, чем выше пропускная способность, тем выше стоимость. 

В ExpressRoute клиентам предлагаются две [тарифных плана][expressroute-pricing]: с оплатой за трафик и безлимитный. Стоимость зависит от пропускной способности канала. Доступная пропускная способность скорее всего будет зависеть от поставщика. Используйте командлет `Get-AzureRmExpressRouteServiceProvider`, чтобы просмотреть список поставщиков, доступных в вашем регионе и узнать, какие варианты пропускной способности они предлагают.
 
Один канал ExpressRoute может поддерживать определенное число пиринговых подключений и связей виртуальных сетей. Дополнительные сведения см. в перечне [ограничений ExpressRoute](/azure/azure-subscription-service-limits).

За дополнительную плату надстройка ExpressRoute Premium предоставляет дополнительные возможности:

* увеличивает ограничение на число маршрутов для общедоступных и частных пирингов; 
* увеличивает число связей виртуальных сетей на канал ExpressRoute; 
* обеспечивает глобальные подключения для служб.

Дополнительные сведения см. на странице [цен на ExpressRoute][expressroute-pricing]. 

Каналы ExpressRoute созданы так, чтобы временно повысить приобретенную пропускную способность сети без дополнительной оплаты в два раза. Это достигается благодаря использованию избыточных связей. Но эту функцию поддерживают не все поставщики услуг подключения. Убедитесь, что ваш поставщик услуг подключения поддерживает эту функцию, прежде чем применять ее.

Хотя некоторые поставщики позволяют изменять пропускную способность, ее изначально следует рассчитывать с некоторым запасом. Если в будущем вам понадобится увеличить пропускную способность, у вас будет два варианта:

- Увеличить пропускную способность. Старайтесь по возможности не использовать этот вариант. Не все поставщики позволяют динамически увеличивать пропускную способность. Но если это необходимо сделать, обратитесь к поставщику и узнайте, позволяет ли он изменять пропускную способность ExpressRoute с помощью команд Powershell. Если позволяет, выполните следующие команды:

    ```powershell
    $ckt = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    $ckt.ServiceProviderProperties.BandwidthInMbps = <<bandwidth-in-mbps>>
    Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt
    ```

    Можно увеличить пропускную способность без потери подключения. Уменьшение пропускной способности приведет к прерыванию подключения, потому что необходимо удалить канал и создать его заново с новой конфигурацией.

- Изменить ценовой план и (или) обновить до уровня "Премиум". Для этого выполните следующие команды. Свойство `Sku.Tier` может иметь значение `Standard` или `Premium`, а свойство `Sku.Name` — значение `MeteredData` или `UnlimitedData`.

    ```powershell
    $ckt = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>

    $ckt.Sku.Tier = "Premium"
    $ckt.Sku.Family = "MeteredData"
    $ckt.Sku.Name = "Premium_MeteredData"

    Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt
    ```

    > [!IMPORTANT]
    > Убедитесь, что значение свойства `Sku.Name` соответствует значениям свойств `Sku.Tier` и `Sku.Family`. Если изменить семейство и уровень, но оставить имя, подключение будет разорвано.
    > 
    > 

    Вы можете обновить номер SKU без прерываний. Но перейти с безлимитного тарифного плана на тарифный план с оплатой за трафик нельзя. При понижении уровня SKU показатели использования пропускной способности не должны превышать предопределенное ограничение для номера SKU "Стандартный".

## <a name="availability-considerations"></a>Вопросы доступности

ExpressRoute не поддерживает применение протоколов избыточности маршрутизаторов, например HSRP и VRRP, для реализации высокого уровня доступности. Вместо этого используется избыточная пара сеансов BGP на каждый пиринг. Чтобы устанавливать высокодоступные подключения к вашей сети было проще, Azure предоставляет два избыточных порта на двух маршрутизаторах (из числа пограничных маршрутизаторов Майкрософт) в конфигурации "активный — активный".

По умолчанию в сеансах BGP значение времени ожидания в режиме простоя равно 60 секундам. Если время ожидания будет превышено в три раза (180 секунд), маршрутизатор будет отмечен как недоступный, а весь трафик будет перенаправляться на оставшийся маршрутизатор. Время ожидания в 180 секунд может оказаться слишком долгим для важных приложений. В этом случае можно изменить параметры времени ожидания BGP на локальном маршрутизаторе на меньшее значение.

Высокий уровень доступности для подключения к Azure можно настроить по-разному в зависимости от типа поставщика, числа каналов ExpressRoute и подключений к шлюзу виртуальной сети, которые необходимо настроить. Ниже описаны доступные варианты:

* Если вы используете подключение уровня 2, развертывайте избыточные маршрутизаторы в локальной сети в конфигурации "активный — активный". Подключите основной канал к одному маршрутизатору, а дополнительный — к другому. Таким образом вы обеспечите подключение с высоким уровнем доступности для обеих сторон. Это необходимо, если требуется соблюдение условий соглашения об уровне обслуживания для ExpressRoute. Дополнительные сведения см. в [соглашении об уровне обслуживания для ExpressRoute][sla-for-expressroute].

    На следующей схеме показана конфигурация с избыточными локальными маршрутизаторами, подключенными к основному и дополнительному каналам. Каждый канал обрабатывает трафик для общедоступного и частного пиринга (на каждый пиринг задается пара диапазонов адресов /30, как описано в предыдущем разделе).

    ![[1]][1]

* Если вы используете подключение уровня 3, должны быть предоставлены избыточные сеансы BGP, которые обеспечат доступность.

* Подключите виртуальную сеть к нескольким каналам ExpressRoute, которые предоставляются разными поставщиками услуг. В рамках этой стратегии для обеспечения высокого уровня доступности и аварийного восстановления предоставляются дополнительные возможности.

* Настройте VPN "сеть — сеть" как путь отработки отказа для ExpressRoute. Дополнительные сведения об этом варианте см. в статье [Подключение локальной сети к Azure с помощью ExpressRoute с отработкой отказа VPN][highly-available-network-architecture].
 Этот вариант применяется только для частного пиринга. Для служб Azure и Office 365 единственный путь отработки отказа — Интернет. 

## <a name="manageability-considerations"></a>Вопросы управляемости

Для мониторинга подключения между локальным центром обработки данных и Azure используйте [набор средств подключения Azure (AzureCT)][azurect]. 

## <a name="security-considerations"></a>Вопросы безопасности

Чтобы обеспечить необходимый уровень безопасности и соответствия требованиям, вы можете настроить параметры защиты подключений Azure разными способами. 

ExpressRoute работает на уровне 3. Угрозы на уровне приложения можно предотвратить с помощью устройства безопасности сети, которое разрешает передачу трафика только из допустимых ресурсов. Кроме того, подключения ExpressRoute, использующие общедоступный пиринг, можно инициировать только из локальной среды. Таким образом посторонние службы не смогут получить доступ к локальным данным и скомпрометировать их из Интернета.

Чтобы повысить уровень безопасности, добавьте устройства безопасности сети между локальной сетью и пограничными маршрутизаторами поставщика. Это поможет ограничить поступление несанкционированного трафика из виртуальной сети.

![[2]][2]

Чтобы проводить аудит или обеспечить соответствие требованиям, может потребоваться запретить прямой доступ из компонентов, работающих в виртуальной сети, к Интернету и реализовать [принудительное туннелирование][forced-tuneling]. В этом случае следует настроить перенаправление интернет-трафика обратно через локальный прокси-сервер, где можно будет выполнить его аудит. На прокси-сервере можно настроить блокировку несанкционированного исходящего трафика и фильтрацию потенциально вредоносного входящего трафика.

![[3]][3]

Чтобы повысить уровень безопасности, не включайте общедоступные IP-адреса для виртуальных машин и используйте группы безопасности сети, чтобы виртуальные машины не были общедоступными. Виртуальные машины должны быть доступны только при использовании внутреннего IP-адреса. Эти адреса можно сделать доступными через сеть ExpressRoute, разрешив сотрудникам отдела DevOps вашей организации выполнять обслуживание или настройку.

Чтобы предоставить конечные точки управления для виртуальных машин во внешней сети, используйте группы безопасности сети или списки управления доступом. Таким образом эти порты будут видны только IP-адресам или сетям из списка разрешений.

> [!NOTE]
> По умолчанию виртуальные машины Azure, развернутые с помощью портала Azure, включают общедоступный IP-адрес, который предоставляет право на вход.  
> 
> 


## <a name="deploy-the-solution"></a>Развертывание решения

**Предварительные требования.** Вам необходима настроенная локальная инфраструктура с подходящим сетевым устройством.

Чтобы развернуть решение, сделайте следующее.

1. Нажмите кнопку ниже:<br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fhybrid-networking%2Fexpressroute%2Fazuredeploy.json" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>
2. Подождите, пока на портале Azure не откроется ссылка, а затем сделайте следующее:
   * Имя **группы ресурсов** уже определено в файле параметров, поэтому выберите **Создать** и введите `ra-hybrid-er-rg` в текстовом поле.
   * В раскрывающемся списке **Расположение** выберите регион.
   * Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).
   * Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.
   * Нажмите кнопку **Приобрести**.
3. Дождитесь завершения развертывания.
4. Нажмите кнопку ниже:<br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fhybrid-networking%2Fexpressroute%2Fazuredeploy-expressRouteCircuit.json" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>
5. Подождите, пока на портале Azure не откроется ссылка, а затем сделайте следующее:
   * В разделе **Группа ресурсов** выберите **Использовать имеющийся**, а затем в текстовом поле введите `ra-hybrid-er-rg`.
   * В раскрывающемся списке **Расположение** выберите регион.
   * Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).
   * Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.
   * Нажмите кнопку **Приобрести**.
6. Дождитесь завершения развертывания.


<!-- links -->
[forced-tuneling]: ../dmz/secure-vnet-hybrid.md
[highly-available-network-architecture]: ./expressroute-vpn-failover.md

[expressroute-technical-overview]: /azure/expressroute/expressroute-introduction
[expressroute-prereqs]: /azure/expressroute/expressroute-prerequisites
[configure-expressroute-routing]: /azure/expressroute/expressroute-howto-routing-arm
[sla-for-expressroute]: https://azure.microsoft.com/support/legal/sla/expressroute/v1_0/
[link-vnet-to-expressroute]: /azure/expressroute/expressroute-howto-linkvnet-arm
[ExpressRoute-provisioning]: /azure/expressroute/expressroute-workflows
[expressroute-introduction]: /azure/expressroute/expressroute-introduction
[expressroute-peering]: /azure/expressroute/expressroute-circuit-peerings
[expressroute-pricing]: https://azure.microsoft.com/pricing/details/expressroute/
[expressroute-limits]: /azure/azure-subscription-service-limits#networking-limits
[azurect]: https://github.com/Azure/NetworkMonitoring/tree/master/AzureCT
[visio-download]: https://archcenter.azureedge.net/cdn/hybrid-network-architectures.vsdx
[er-circuit-parameters]: https://github.com/mspnp/reference-architectures/tree/master/hybrid-networking/expressroute/parameters/expressRouteCircuit.parameters.json
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[azure-cli]: https://azure.microsoft.com/documentation/articles/xplat-cli-install/
[0]: ./images/expressroute.png "Реализация гибридной сетевой архитектуры с помощью Azure ExpressRoute"
[1]: ../_images/guidance-hybrid-network-expressroute/figure2.png "Использование избыточных маршрутизаторов с основным и дополнительным каналами ExpressRoute"
[2]: ../_images/guidance-hybrid-network-expressroute/figure3.png "Добавление устройств безопасности для локальной сети"
[3]: ../_images/guidance-hybrid-network-expressroute/figure4.png "Использование принудительного туннелирования для аудита входящего интернет-трафика"
[4]: ../_images/guidance-hybrid-network-expressroute/figure5.png "Поиск ServiceKey для канала ExpressRoute"  