---
title: Подключение локальной сети к Azure с помощью ExpressRoute
description: Инструкции по реализации архитектуры защищенной сети "сеть — сеть", которая включает виртуальную сеть Azure и локальную сеть, подключенные с помощью Azure ExpressRoute.
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Connect an on-premises network to Azure
pnp.series.next: expressroute-vpn-failover
pnp.series.prev: vpn
cardTitle: ExpressRoute
ms.openlocfilehash: ada07f399925da6da28b24260f5c73f1e106fd7d
ms.sourcegitcommit: c441fd165e6bebbbbbc19854ec6f3676be9c3b25
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2018
---
# <a name="connect-an-on-premises-network-to-azure-using-expressroute"></a><span data-ttu-id="6ec8c-103">Подключение локальной сети к Azure с помощью ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="6ec8c-103">Connect an on-premises network to Azure using ExpressRoute</span></span>

<span data-ttu-id="6ec8c-104">На схеме с этой эталонной архитектурой показано, как подключить локальную сеть к виртуальным сетям в Azure с помощью [Azure ExpressRoute][expressroute-introduction].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-104">This reference architecture shows how to connect an on-premises network to virtual networks on Azure, using [Azure ExpressRoute][expressroute-introduction].</span></span> <span data-ttu-id="6ec8c-105">Подключения ExpressRoute создают закрытые выделенные подключения через сети сторонних поставщиков услуг подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-105">ExpressRoute connections use a private, dedicated connection through a third-party connectivity provider.</span></span> <span data-ttu-id="6ec8c-106">Такое частное подключение расширяет вашу локальную сеть в Azure.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-106">The private connection extends your on-premises network into Azure.</span></span> [<span data-ttu-id="6ec8c-107">**Разверните это решение**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-107">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="6ec8c-108">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="6ec8c-108">![[0]][0]</span></span>

<span data-ttu-id="6ec8c-109">*Скачайте [файл Visio][visio-download] этой архитектуры.*</span><span class="sxs-lookup"><span data-stu-id="6ec8c-109">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="6ec8c-110">Архитектура</span><span class="sxs-lookup"><span data-stu-id="6ec8c-110">Architecture</span></span>

<span data-ttu-id="6ec8c-111">Архитектура состоит из следующих компонентов:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-111">The architecture consists of the following components.</span></span>

* <span data-ttu-id="6ec8c-112">**Локальная корпоративная сеть**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-112">**On-premises corporate network**.</span></span> <span data-ttu-id="6ec8c-113">Частная локальная сеть, работающая внутри организации.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-113">A private local-area network running within an organization.</span></span>

* <span data-ttu-id="6ec8c-114">**Канал ExpressRoute.**</span><span class="sxs-lookup"><span data-stu-id="6ec8c-114">**ExpressRoute circuit**.</span></span> <span data-ttu-id="6ec8c-115">Это канал уровня 2 или 3, который предоставляет поставщик подключения. Он позволяет подключиться к локальной сети с Azure через пограничные маршрутизаторы.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-115">A layer 2 or layer 3 circuit supplied by the connectivity provider that joins the on-premises network with Azure through the edge routers.</span></span> <span data-ttu-id="6ec8c-116">Канал использует инфраструктуру оборудования, настроенную поставщиком подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-116">The circuit uses the hardware infrastructure managed by the connectivity provider.</span></span>

* <span data-ttu-id="6ec8c-117">**Локальные пограничные маршрутизаторы**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-117">**Local edge routers**.</span></span> <span data-ttu-id="6ec8c-118">Маршрутизаторы, позволяющие подключить локальную сеть к каналу, которым управляет поставщик.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-118">Routers that connect the on-premises network to the circuit managed by the provider.</span></span> <span data-ttu-id="6ec8c-119">В зависимости от способа подготовки подключения может потребоваться предоставить общедоступные IP-адреса, используемые маршрутизаторами.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-119">Depending on how your connection is provisioned, you may need to provide the public IP addresses used by the routers.</span></span>
* <span data-ttu-id="6ec8c-120">**Пограничные маршрутизаторы Майкрософт**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-120">**Microsoft edge routers**.</span></span> <span data-ttu-id="6ec8c-121">Два маршрутизатора в конфигурации "активный — активный" с высоким уровнем доступности.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-121">Two routers in an active-active highly available configuration.</span></span> <span data-ttu-id="6ec8c-122">Эти маршрутизаторы позволяют поставщикам услуг подключения напрямую подключать свои каналы к центру обработки данных.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-122">These routers enable a connectivity provider to connect their circuits directly to their datacenter.</span></span> <span data-ttu-id="6ec8c-123">В зависимости от способа подготовки подключения может потребоваться предоставить общедоступные IP-адреса, используемые маршрутизаторами.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-123">Depending on how your connection is provisioned, you may need to provide the public IP addresses used by the routers.</span></span>

* <span data-ttu-id="6ec8c-124">**Виртуальные сети Azure**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-124">**Azure virtual networks (VNets)**.</span></span> <span data-ttu-id="6ec8c-125">Каждая виртуальная сеть находится в одном регионе Azure и может содержать несколько уровней приложения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-125">Each VNet resides in a single Azure region, and can host multiple application tiers.</span></span> <span data-ttu-id="6ec8c-126">Уровни приложения могут быть разделены на сегменты с помощью подсетей в каждой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-126">Application tiers can be segmented using subnets in each VNet.</span></span>

* <span data-ttu-id="6ec8c-127">**Общедоступные службы Azure**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-127">**Azure public services**.</span></span> <span data-ttu-id="6ec8c-128">Службы Azure, которые могут использоваться в гибридных приложениях.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-128">Azure services that can be used within a hybrid application.</span></span> <span data-ttu-id="6ec8c-129">Эти службы также доступны в Интернете. Но при получении к ним доступа через канал ExpressRoute вы получите минимальную задержку и более предсказуемую производительность, так как трафик не проходит через Интернет.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-129">These services are also available over the Internet, but accessing them using an ExpressRoute circuit provides low latency and more predictable performance, because traffic does not go through the Internet.</span></span> <span data-ttu-id="6ec8c-130">Подключения устанавливаются с использованием [общедоступного пиринга][expressroute-peering] и адресов, которые принадлежат организации или предоставляются поставщиком услуг подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-130">Connections are performed using [public peering][expressroute-peering], with addresses that are either owned by your organization or supplied by your connectivity provider.</span></span>

* <span data-ttu-id="6ec8c-131">**Службы Office 365**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-131">**Office 365 services**.</span></span> <span data-ttu-id="6ec8c-132">Общедоступные приложения и службы Office 365, предоставляемые корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-132">The publicly available Office 365 applications and services provided by Microsoft.</span></span> <span data-ttu-id="6ec8c-133">Подключения устанавливаются с использованием [пиринга Майкрософт][expressroute-peering] и адресов, которые принадлежат организации или предоставляются поставщиком услуг подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-133">Connections are performed using [Microsoft peering][expressroute-peering], with addresses that are either owned by your organization or supplied by your connectivity provider.</span></span> <span data-ttu-id="6ec8c-134">С помощью пиринга Майкрософт можно также напрямую подключиться к Microsoft CRM Online.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-134">You can also connect directly to Microsoft CRM Online through Microsoft peering.</span></span>

* <span data-ttu-id="6ec8c-135">**Поставщики услуг подключения** (не показаны).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-135">**Connectivity providers** (not shown).</span></span> <span data-ttu-id="6ec8c-136">Компании, которые предоставляют услуги подключения на уровне 2 или 3 между вашим центром обработки данных и центром обработки данных Azure.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-136">Companies that provide a connection either using layer 2 or layer 3 connectivity between your datacenter and an Azure datacenter.</span></span>

## <a name="recommendations"></a><span data-ttu-id="6ec8c-137">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="6ec8c-137">Recommendations</span></span>

<span data-ttu-id="6ec8c-138">Следующие рекомендации применимы для большинства ситуаций.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-138">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="6ec8c-139">Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-139">Follow these recommendations unless you have a specific requirement that overrides them.</span></span>

### <a name="connectivity-providers"></a><span data-ttu-id="6ec8c-140">Поставщики услуг подключения</span><span class="sxs-lookup"><span data-stu-id="6ec8c-140">Connectivity providers</span></span>

<span data-ttu-id="6ec8c-141">Выберите подходящего поставщика услуг подключения ExpressRoute для вашего расположения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-141">Select a suitable ExpressRoute connectivity provider for your location.</span></span> <span data-ttu-id="6ec8c-142">Чтобы получить список поставщиков услуг подключения, доступных в вашем расположении, используйте следующую команду Azure PowerShell:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-142">To get a list of connectivity providers available at your location, use the following Azure PowerShell command:</span></span>

```powershell
Get-AzureRmExpressRouteServiceProvider
```

<span data-ttu-id="6ec8c-143">Поставщики услуг подключения ExpressRoute подключают ваш центр обработки данных к Майкрософт одним из следующих способов:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-143">ExpressRoute connectivity providers connect your datacenter to Microsoft in the following ways:</span></span>

* <span data-ttu-id="6ec8c-144">**Совместное размещение в Cloud Exchange**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-144">**Co-located at a cloud exchange**.</span></span> <span data-ttu-id="6ec8c-145">При размещении на одном сервере с Cloud Exchange можно заказать виртуальное кросс-подключение к Azure через инфраструктуру Ethernet Exchange, предоставляемую поставщиком услуг совместного размещения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-145">If you're co-located in a facility with a cloud exchange, you can order virtual cross-connections to Azure through the co-location provider’s Ethernet exchange.</span></span> <span data-ttu-id="6ec8c-146">Поставщики услуг совместного размещения могут предлагать кросс-подключения уровня 2 или управляемые кросс-подключения уровня 3 между для вашей инфраструктуры на сервере совместного размещения и Azure.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-146">Co-location providers can offer either layer 2 cross-connections, or managed layer 3 cross-connections between your infrastructure in the co-location facility and Azure.</span></span>
* <span data-ttu-id="6ec8c-147">**Подключения Ethernet "точка — точка"**</span><span class="sxs-lookup"><span data-stu-id="6ec8c-147">**Point-to-point Ethernet connections**.</span></span> <span data-ttu-id="6ec8c-148">Локальные центры обработки данных и офисы можно связать с Azure в рамках Ethernet-подключения "точка — точка".</span><span class="sxs-lookup"><span data-stu-id="6ec8c-148">You can connect your on-premises datacenters/offices to Azure through point-to-point Ethernet links.</span></span> <span data-ttu-id="6ec8c-149">Поставщики услуг подключения Ethernet "точка — точка" могут предлагать подключения уровня 2 или управляемые подключения уровня 3 между вашей сетью и Azure.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-149">Point-to-point Ethernet providers can offer layer 2 connections, or managed layer 3 connections between your site and Azure.</span></span>
* <span data-ttu-id="6ec8c-150">**Сети "любой к любому" (IPVPN)**</span><span class="sxs-lookup"><span data-stu-id="6ec8c-150">**Any-to-any (IPVPN) networks**.</span></span> <span data-ttu-id="6ec8c-151">Глобальную сеть (WAN) можно интегрировать с Azure.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-151">You can integrate your wide area network (WAN) with Azure.</span></span> <span data-ttu-id="6ec8c-152">Поставщики услуг IP VPN (как правило, предлагающие MPLS VPN) обеспечивают подключения "любой к любому" между филиалами и центрами обработки данных.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-152">Internet protocol virtual private network (IPVPN) providers (typically a multiprotocol label switching VPN) offer any-to-any connectivity between your branch offices and datacenters.</span></span> <span data-ttu-id="6ec8c-153">Azure можно связать с вашей сетью WAN, так чтобы это выглядело как подключение к любому другому филиалу.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-153">Azure can be interconnected to your WAN to make it look just like any other branch office.</span></span> <span data-ttu-id="6ec8c-154">Обычно поставщики сетей WAN предлагают управляемые подключения уровня 3.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-154">WAN providers typically offer managed layer 3 connectivity.</span></span>

<span data-ttu-id="6ec8c-155">Дополнительные сведения о поставщиках услуг подключения см. в статье [Обзор ExpressRoute][expressroute-introduction].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-155">For more information about connectivity providers, see the [ExpressRoute introduction][expressroute-introduction].</span></span>

### <a name="expressroute-circuit"></a><span data-ttu-id="6ec8c-156">Канал ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="6ec8c-156">ExpressRoute circuit</span></span>

<span data-ttu-id="6ec8c-157">Чтобы подключиться к Azure, убедитесь, что в вашей организации удовлетворены [обязательные требования ExpressRoute][expressroute-prereqs].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-157">Ensure that your organization has met the [ExpressRoute prerequisite requirements][expressroute-prereqs] for connecting to Azure.</span></span>

<span data-ttu-id="6ec8c-158">Добавьте подсеть с именем `GatewaySubnet` в виртуальную сеть Azure и создайте шлюз виртуальной сети ExpressRoute с помощью службы VPN-шлюза Azure, если вы еще это не сделали.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-158">If you haven't already done so, add a subnet named `GatewaySubnet` to your Azure VNet and create an ExpressRoute virtual network gateway using the Azure VPN gateway service.</span></span> <span data-ttu-id="6ec8c-159">Дополнительные сведения об этом процессе см. в статье [Процедуры ExpressRoute для подготовки каналов и состояний каналов][ExpressRoute-provisioning].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-159">For more information about this process, see [ExpressRoute workflows for circuit provisioning and circuit states][ExpressRoute-provisioning].</span></span>

<span data-ttu-id="6ec8c-160">Создайте канал ExpressRoute, сделав следующее:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-160">Create an ExpressRoute circuit as follows:</span></span>

1. <span data-ttu-id="6ec8c-161">Выполните следующую команду PowerShell:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-161">Run the following PowerShell command:</span></span>
   
    ```powershell
    New-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>> -Location <<location>> -SkuTier <<sku-tier>> -SkuFamily <<sku-family>> -ServiceProviderName <<service-provider-name>> -PeeringLocation <<peering-location>> -BandwidthInMbps <<bandwidth-in-mbps>>
    ```
2. <span data-ttu-id="6ec8c-162">Отправьте `ServiceKey` для нового канала поставщику услуг.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-162">Send the `ServiceKey` for the new circuit to the service provider.</span></span>

3. <span data-ttu-id="6ec8c-163">Подождите, пока поставщик подготовит канал.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-163">Wait for the provider to provision the circuit.</span></span> <span data-ttu-id="6ec8c-164">Чтобы проверить состояние подготовки канала, выполните следующую команду PowerShell:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-164">To verify the provisioning state of a circuit, run the following PowerShell command:</span></span>
   
    ```powershell
    Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    ```

    <span data-ttu-id="6ec8c-165">Когда канал будет готов, значение в поле `Provisioning state` в разделе `Service Provider` выходных данных изменится с `NotProvisioned` на `Provisioned`.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-165">The `Provisioning state` field in the `Service Provider` section of the output will change from `NotProvisioned` to `Provisioned` when the circuit is ready.</span></span>

    > [!NOTE]
    > <span data-ttu-id="6ec8c-166">Если вы используете подключение уровня 3, поставщик должен настраивать и администрировать маршрутизацию для вас.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-166">If you're using a layer 3 connection, the provider should configure and manage routing for you.</span></span> <span data-ttu-id="6ec8c-167">Вы должны предоставить поставщику необходимые сведения для реализации соответствующих маршрутов.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-167">You provide the information necessary to enable the provider to implement the appropriate routes.</span></span>
    > 
    > 

4. <span data-ttu-id="6ec8c-168">Если вы используете подключение уровня 2, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-168">If you're using a layer 2 connection:</span></span>

    1. <span data-ttu-id="6ec8c-169">Зарезервируйте две подсети /30, которые содержат допустимые общедоступные IP-адреса для каждого типа пиринга, который необходимо реализовать.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-169">Reserve two /30 subnets composed of valid public IP addresses for each type of peering you want to implement.</span></span> <span data-ttu-id="6ec8c-170">Эти подсети /30 будут применяться, чтобы предоставлять IP-адресов маршрутизаторам, которые используются для канала.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-170">These /30 subnets will be used to provide IP addresses for the routers used for the circuit.</span></span> <span data-ttu-id="6ec8c-171">При реализации частного, общедоступного пиринга и пиринга Майкрософт вам понадобится 6 подсетей /30 с допустимыми общедоступными IP-адресами.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-171">If you are implementing private, public, and Microsoft peering, you'll need 6 /30 subnets with valid public IP addresses.</span></span>     

    2. <span data-ttu-id="6ec8c-172">Настройте маршрутизацию для канала ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-172">Configure routing for the ExpressRoute circuit.</span></span> <span data-ttu-id="6ec8c-173">Выполните следующие команды PowerShell для каждого типа пиринга, который нужно настроить (частный и общедоступный пиринг, а также пиринг Майкрософт).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-173">Run the following PowerShell commands for each type of peering you want to configure (private, public, and Microsoft).</span></span> <span data-ttu-id="6ec8c-174">Дополнительные сведения см. в статье [Создание и изменение пиринга для канала ExpressRoute с помощью PowerShell][configure-expressroute-routing].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-174">For more information, see [Create and modify routing for an ExpressRoute circuit][configure-expressroute-routing].</span></span>
   
        ```powershell
        Set-AzureRmExpressRouteCircuitPeeringConfig -Name <<peering-name>> -Circuit <<circuit-name>> -PeeringType <<peering-type>> -PeerASN <<peer-asn>> -PrimaryPeerAddressPrefix <<primary-peer-address-prefix>> -SecondaryPeerAddressPrefix <<secondary-peer-address-prefix>> -VlanId <<vlan-id>>

        Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit <<circuit-name>>
        ```

    3. <span data-ttu-id="6ec8c-175">Зарезервируйте другой пул допустимых общедоступных IP-адресов, чтобы применять преобразование сетевых адресов (NAT) для общедоступного пиринга и пиринга Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-175">Reserve another pool of valid public IP addresses to use for network address translation (NAT) for public and Microsoft peering.</span></span> <span data-ttu-id="6ec8c-176">Рекомендуется использовать разные пулы для каждого пиринга.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-176">It is recommended to have a different pool for each peering.</span></span> <span data-ttu-id="6ec8c-177">Предоставьте пул поставщику услуг подключения, чтобы он смог настроить объявления BGP (протокол пограничного шлюза) для этих диапазонов.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-177">Specify the pool to your connectivity provider, so they can configure border gateway protocol (BGP) advertisements for those ranges.</span></span>

5. <span data-ttu-id="6ec8c-178">Выполните следующие команды PowerShell, чтобы связать частные виртуальные сети с каналом ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-178">Run the following PowerShell commands to link your private VNet(s) to the ExpressRoute circuit.</span></span> <span data-ttu-id="6ec8c-179">Дополнительные сведения см. в статье [Подключение виртуальной сети к каналу ExpressRoute][link-vnet-to-expressroute].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-179">For more information,see [Link a virtual network to an ExpressRoute circuit][link-vnet-to-expressroute].</span></span>

    ```powershell
    $circuit = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    $gw = Get-AzureRmVirtualNetworkGateway -Name <<gateway-name>> -ResourceGroupName <<resource-group>>
    New-AzureRmVirtualNetworkGatewayConnection -Name <<connection-name>> -ResourceGroupName <<resource-group>> -Location <<location> -VirtualNetworkGateway1 $gw -PeerId $circuit.Id -ConnectionType ExpressRoute
    ```

<span data-ttu-id="6ec8c-180">Вы можете подключить несколько виртуальных сетей, размещенных в разных регионах, к одному каналу ExpressRoute, если только все виртуальные сети и канал ExpressRoute расположены в одном геополитическом регионе.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-180">You can connect multiple VNets located in different regions to the same ExpressRoute circuit, as long as all VNets and the ExpressRoute circuit are located within the same geopolitical region.</span></span>

### <a name="troubleshooting"></a><span data-ttu-id="6ec8c-181">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="6ec8c-181">Troubleshooting</span></span> 

<span data-ttu-id="6ec8c-182">Если работоспособному каналу ExpressRoute сейчас не удается установить подключение при отсутствии изменений конфигурации в локальной или частной виртуальной частной сети, обратитесь к поставщику услуг подключения и поддерживайте с ним связь, чтобы устранить проблему.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-182">If a previously functioning ExpressRoute circuit now fails to connect, in the absence of any configuration changes on-premises or within your private VNet, you may need to contact the connectivity provider and work with them to correct the issue.</span></span> <span data-ttu-id="6ec8c-183">Чтобы проверить, подготовлен ли канал ExpressRoute, используйте следующие команды Powershell:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-183">Use the following Powershell commands to verify that the ExpressRoute circuit has been provisioned:</span></span>

```powershell
Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
```

<span data-ttu-id="6ec8c-184">В результатах выполнения команды отображается несколько свойств канала, включая `ProvisioningState`, `CircuitProvisioningState` и `ServiceProviderProvisioningState`, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-184">The output of this command shows several properties for your circuit, including `ProvisioningState`, `CircuitProvisioningState`, and `ServiceProviderProvisioningState` as shown below.</span></span>

```
ProvisioningState                : Succeeded
Sku                              : {
                                     "Name": "Standard_MeteredData",
                                     "Tier": "Standard",
                                     "Family": "MeteredData"
                                   }
CircuitProvisioningState         : Enabled
ServiceProviderProvisioningState : NotProvisioned
```

<span data-ttu-id="6ec8c-185">Если для свойства `ProvisioningState` не отображается значение `Succeeded` после того, как вы попытались создать канал, удалите этот канал с помощью следующей команды, и создайте его еще раз.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-185">If the `ProvisioningState` is not set to `Succeeded` after you tried to create a new circuit, remove the circuit by using the command below and try to create it again.</span></span>

```powershell
Remove-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
```

<span data-ttu-id="6ec8c-186">Если канал подготовлен, но для свойства `ProvisioningState` отображается значение `Failed` или для свойства `CircuitProvisioningState` не отображается значение `Enabled`, обратитесь к поставщику за дополнительной помощью.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-186">If your provider had already provisioned the circuit, and the `ProvisioningState` is set to `Failed`, or the `CircuitProvisioningState` is not `Enabled`, contact your provider for further assistance.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="6ec8c-187">Вопросы масштабируемости</span><span class="sxs-lookup"><span data-stu-id="6ec8c-187">Scalability considerations</span></span>

<span data-ttu-id="6ec8c-188">Каналы ExpressRoute обеспечивают путь с высокой пропускной способностью между сетями.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-188">ExpressRoute circuits provide a high bandwidth path between networks.</span></span> <span data-ttu-id="6ec8c-189">Как правило, чем выше пропускная способность, тем выше стоимость.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-189">Generally, the higher the bandwidth the greater the cost.</span></span> 

<span data-ttu-id="6ec8c-190">В ExpressRoute клиентам предлагаются две [тарифных плана][expressroute-pricing]: с оплатой за трафик и безлимитный.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-190">ExpressRoute offers two [pricing plans][expressroute-pricing] to customers, a metered plan and an unlimited data plan.</span></span> <span data-ttu-id="6ec8c-191">Стоимость зависит от пропускной способности канала.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-191">Charges vary according to circuit bandwidth.</span></span> <span data-ttu-id="6ec8c-192">Доступная пропускная способность скорее всего будет зависеть от поставщика.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-192">Available bandwidth will likely vary from provider to provider.</span></span> <span data-ttu-id="6ec8c-193">Используйте командлет `Get-AzureRmExpressRouteServiceProvider`, чтобы просмотреть список поставщиков, доступных в вашем регионе и узнать, какие варианты пропускной способности они предлагают.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-193">Use the `Get-AzureRmExpressRouteServiceProvider` cmdlet to see the providers available in your region and the bandwidths that they offer.</span></span>
 
<span data-ttu-id="6ec8c-194">Один канал ExpressRoute может поддерживать определенное число пиринговых подключений и связей виртуальных сетей.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-194">A single ExpressRoute circuit can support a certain number of peerings and VNet links.</span></span> <span data-ttu-id="6ec8c-195">Дополнительные сведения см. в перечне [ограничений ExpressRoute](/azure/azure-subscription-service-limits).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-195">See [ExpressRoute limits](/azure/azure-subscription-service-limits) for more information.</span></span>

<span data-ttu-id="6ec8c-196">За дополнительную плату надстройка ExpressRoute Premium предоставляет дополнительные возможности:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-196">For an extra charge, the ExpressRoute Premium add-on provides some additional capability:</span></span>

* <span data-ttu-id="6ec8c-197">увеличивает ограничение на число маршрутов для общедоступных и частных пирингов;</span><span class="sxs-lookup"><span data-stu-id="6ec8c-197">Increased route limits for public and private peering.</span></span> 
* <span data-ttu-id="6ec8c-198">увеличивает число связей виртуальных сетей на канал ExpressRoute;</span><span class="sxs-lookup"><span data-stu-id="6ec8c-198">Increased number of VNet links per ExpressRoute circuit.</span></span> 
* <span data-ttu-id="6ec8c-199">глобальные подключения для служб.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-199">Global connectivity for services.</span></span>

<span data-ttu-id="6ec8c-200">Дополнительные сведения см. на странице [цен на ExpressRoute][expressroute-pricing].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-200">See [ExpressRoute pricing][expressroute-pricing] for details.</span></span> 

<span data-ttu-id="6ec8c-201">Каналы ExpressRoute созданы так, чтобы временно повысить приобретенную пропускную способность сети без дополнительной оплаты в два раза.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-201">ExpressRoute circuits are designed to allow temporary network bursts up to two times the bandwidth limit that you procured for no additional cost.</span></span> <span data-ttu-id="6ec8c-202">Это достигается благодаря использованию избыточных связей.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-202">This is achieved by using redundant links.</span></span> <span data-ttu-id="6ec8c-203">Но эту функцию поддерживают не все поставщики услуг подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-203">However, not all connectivity providers support this feature.</span></span> <span data-ttu-id="6ec8c-204">Убедитесь, что ваш поставщик услуг подключения поддерживает эту функцию, прежде чем применять ее.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-204">Verify that your connectivity provider enables this feature before depending on it.</span></span>

<span data-ttu-id="6ec8c-205">Хотя некоторые поставщики позволяют изменять пропускную способность, ее изначально следует рассчитывать с некоторым запасом.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-205">Although some providers allow you to change your bandwidth, make sure you pick an initial bandwidth that surpasses your needs and provides room for growth.</span></span> <span data-ttu-id="6ec8c-206">Если в будущем вам понадобится увеличить пропускную способность, у вас будет два варианта:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-206">If you need to increase bandwidth in the future, you are left with two options:</span></span>

- <span data-ttu-id="6ec8c-207">Увеличить пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-207">Increase the bandwidth.</span></span> <span data-ttu-id="6ec8c-208">Старайтесь по возможности не использовать этот вариант. Не все поставщики позволяют динамически увеличивать пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-208">You should avoid this option as much as possible, and not all providers allow you to increase bandwidth dynamically.</span></span> <span data-ttu-id="6ec8c-209">Но если это необходимо сделать, обратитесь к поставщику и узнайте, позволяет ли он изменять пропускную способность ExpressRoute с помощью команд Powershell.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-209">But if a bandwidth increase is needed, check with your provider to verify they support changing ExpressRoute bandwidth properties via Powershell commands.</span></span> <span data-ttu-id="6ec8c-210">Если позволяет, выполните следующие команды:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-210">If they do, run the commands below.</span></span>

    ```powershell
    $ckt = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>
    $ckt.ServiceProviderProperties.BandwidthInMbps = <<bandwidth-in-mbps>>
    Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt
    ```

    <span data-ttu-id="6ec8c-211">Можно увеличить пропускную способность без потери подключения.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-211">You can increase the bandwidth without loss of connectivity.</span></span> <span data-ttu-id="6ec8c-212">Уменьшение пропускной способности приведет к прерыванию подключения, потому что необходимо удалить канал и создать его заново с новой конфигурацией.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-212">Downgrading the bandwidth will result in disruption in connectivity, because you must delete the circuit and recreate it with the new configuration.</span></span>

- <span data-ttu-id="6ec8c-213">Изменить ценовой план и (или) обновить до уровня "Премиум".</span><span class="sxs-lookup"><span data-stu-id="6ec8c-213">Change your pricing plan and/or upgrade to Premium.</span></span> <span data-ttu-id="6ec8c-214">Для этого выполните следующие команды.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-214">To do so, run the following commands.</span></span> <span data-ttu-id="6ec8c-215">Свойство `Sku.Tier` может иметь значение `Standard` или `Premium`, а свойство `Sku.Name` — значение `MeteredData` или `UnlimitedData`.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-215">The `Sku.Tier` property can be `Standard` or `Premium`; the `Sku.Name` property can be `MeteredData` or `UnlimitedData`.</span></span>

    ```powershell
    $ckt = Get-AzureRmExpressRouteCircuit -Name <<circuit-name>> -ResourceGroupName <<resource-group>>

    $ckt.Sku.Tier = "Premium"
    $ckt.Sku.Family = "MeteredData"
    $ckt.Sku.Name = "Premium_MeteredData"

    Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="6ec8c-216">Убедитесь, что значение свойства `Sku.Name` соответствует значениям свойств `Sku.Tier` и `Sku.Family`.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-216">Make sure the `Sku.Name` property matches the `Sku.Tier` and `Sku.Family`.</span></span> <span data-ttu-id="6ec8c-217">Если изменить семейство и уровень, но оставить имя, подключение будет разорвано.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-217">If you change the family and tier, but not the name, your connection will be disabled.</span></span>
    > 
    > 

    <span data-ttu-id="6ec8c-218">Вы можете обновить номер SKU без прерываний. Но перейти с безлимитного тарифного плана на тарифный план с оплатой за трафик нельзя.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-218">You can upgrade the SKU without disruption, but you cannot switch from the unlimited pricing plan to metered.</span></span> <span data-ttu-id="6ec8c-219">При понижении уровня SKU показатели использования пропускной способности не должны превышать предопределенное ограничение для номера SKU "Стандартный".</span><span class="sxs-lookup"><span data-stu-id="6ec8c-219">When downgrading the SKU, your bandwidth consumption must remain within the default limit of the standard SKU.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="6ec8c-220">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="6ec8c-220">Availability considerations</span></span>

<span data-ttu-id="6ec8c-221">ExpressRoute не поддерживает применение протоколов избыточности маршрутизаторов, например HSRP и VRRP, для реализации высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-221">ExpressRoute does not support router redundancy protocols such as hot standby routing protocol (HSRP) and virtual router redundancy protocol (VRRP) to implement high availability.</span></span> <span data-ttu-id="6ec8c-222">Вместо этого используется избыточная пара сеансов BGP на каждый пиринг.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-222">Instead, it uses a redundant pair of BGP sessions per peering.</span></span> <span data-ttu-id="6ec8c-223">Чтобы устанавливать высокодоступные подключения к вашей сети было проще, Azure предоставляет два избыточных порта на двух маршрутизаторах (из числа пограничных маршрутизаторов Майкрософт) в конфигурации "активный — активный".</span><span class="sxs-lookup"><span data-stu-id="6ec8c-223">To facilitate highly-available connections to your network, Azure provisions you with two redundant ports on two routers (part of the Microsoft edge) in an active-active configuration.</span></span>

<span data-ttu-id="6ec8c-224">По умолчанию в сеансах BGP значение времени ожидания в режиме простоя равно 60 секундам.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-224">By default, BGP sessions use an idle timeout value of 60 seconds.</span></span> <span data-ttu-id="6ec8c-225">Если время ожидания будет превышено в три раза (180 секунд), маршрутизатор будет отмечен как недоступный, а весь трафик будет перенаправляться на оставшийся маршрутизатор.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-225">If a session times out three times (180 seconds total), the router is marked as unavailable, and all traffic is redirected to the remaining router.</span></span> <span data-ttu-id="6ec8c-226">Время ожидания в 180 секунд может оказаться слишком долгим для важных приложений.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-226">This 180-second timeout might be too long for critical applications.</span></span> <span data-ttu-id="6ec8c-227">В этом случае можно изменить параметры времени ожидания BGP на локальном маршрутизаторе на меньшее значение.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-227">If so, you can change your BGP time-out settings on the on-premises router to a smaller value.</span></span>

<span data-ttu-id="6ec8c-228">Высокий уровень доступности для подключения к Azure можно настроить по-разному в зависимости от типа поставщика, числа каналов ExpressRoute и подключений к шлюзу виртуальной сети, которые необходимо настроить.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-228">You can configure high availability for your Azure connection in different ways, depending on the type of provider you use, and the number of ExpressRoute circuits and virtual network gateway connections you're willing to configure.</span></span> <span data-ttu-id="6ec8c-229">Ниже описаны доступные варианты:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-229">The following summarizes your availability options:</span></span>

* <span data-ttu-id="6ec8c-230">Если вы используете подключение уровня 2, развертывайте избыточные маршрутизаторы в локальной сети в конфигурации "активный — активный".</span><span class="sxs-lookup"><span data-stu-id="6ec8c-230">If you're using a layer 2 connection, deploy redundant routers in your on-premises network in an active-active configuration.</span></span> <span data-ttu-id="6ec8c-231">Подключите основной канал к одному маршрутизатору, а дополнительный — к другому.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-231">Connect the primary circuit to one router, and the secondary circuit to the other.</span></span> <span data-ttu-id="6ec8c-232">Таким образом вы обеспечите подключение с высоким уровнем доступности для обеих сторон.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-232">This will give you a highly available connection at both ends of the connection.</span></span> <span data-ttu-id="6ec8c-233">Это необходимо, если требуется соблюдение условий соглашения об уровне обслуживания для ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-233">This is necessary if you require the ExpressRoute service level agreement (SLA).</span></span> <span data-ttu-id="6ec8c-234">Дополнительные сведения см. в [соглашении об уровне обслуживания для ExpressRoute][sla-for-expressroute].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-234">See [SLA for Azure ExpressRoute][sla-for-expressroute] for details.</span></span>

    <span data-ttu-id="6ec8c-235">На следующей схеме показана конфигурация с избыточными локальными маршрутизаторами, подключенными к основному и дополнительному каналам.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-235">The following diagram shows a configuration with redundant on-premises routers connected to the primary and secondary circuits.</span></span> <span data-ttu-id="6ec8c-236">Каждый канал обрабатывает трафик для общедоступного и частного пиринга (на каждый пиринг задается пара диапазонов адресов /30, как описано в предыдущем разделе).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-236">Each circuit handles the traffic for a public peering and a private peering (each peering is designated a pair of /30 address spaces, as described in the previous section).</span></span>

    <span data-ttu-id="6ec8c-237">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="6ec8c-237">![[1]][1]</span></span>

* <span data-ttu-id="6ec8c-238">Если вы используете подключение уровня 3, должны быть предоставлены избыточные сеансы BGP, которые обеспечат доступность.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-238">If you're using a layer 3 connection, verify that it provides redundant BGP sessions that handle availability for you.</span></span>

* <span data-ttu-id="6ec8c-239">Подключите виртуальную сеть к нескольким каналам ExpressRoute, которые предоставляются разными поставщиками услуг.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-239">Connect the VNet to multiple ExpressRoute circuits, supplied by different service providers.</span></span> <span data-ttu-id="6ec8c-240">В рамках этой стратегии для обеспечения высокого уровня доступности и аварийного восстановления предоставляются дополнительные возможности.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-240">This strategy provides additional high-availability and disaster recovery capabilities.</span></span>

* <span data-ttu-id="6ec8c-241">Настройте VPN "сеть — сеть" как путь отработки отказа для ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-241">Configure a site-to-site VPN as a failover path for ExpressRoute.</span></span> <span data-ttu-id="6ec8c-242">Дополнительные сведения об этом варианте см. в статье [Подключение локальной сети к Azure с помощью ExpressRoute с отработкой отказа VPN][highly-available-network-architecture].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-242">For more about this option, see [Connect an on-premises network to Azure using ExpressRoute with VPN failover][highly-available-network-architecture].</span></span>
 <span data-ttu-id="6ec8c-243">Этот вариант применяется только для частного пиринга.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-243">This option only applies to private peering.</span></span> <span data-ttu-id="6ec8c-244">Для служб Azure и Office 365 единственный путь отработки отказа — Интернет.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-244">For Azure and Office 365 services, the Internet is the only failover path.</span></span> 

## <a name="manageability-considerations"></a><span data-ttu-id="6ec8c-245">Вопросы управляемости</span><span class="sxs-lookup"><span data-stu-id="6ec8c-245">Manageability considerations</span></span>

<span data-ttu-id="6ec8c-246">Для мониторинга подключения между локальным центром обработки данных и Azure используйте [набор средств подключения Azure (AzureCT)][azurect].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-246">You can use the [Azure Connectivity Toolkit (AzureCT)][azurect] to monitor connectivity between your on-premises datacenter and Azure.</span></span> 

## <a name="security-considerations"></a><span data-ttu-id="6ec8c-247">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="6ec8c-247">Security considerations</span></span>

<span data-ttu-id="6ec8c-248">Чтобы обеспечить необходимый уровень безопасности и соответствия требованиям, вы можете настроить параметры защиты подключений Azure разными способами.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-248">You can configure security options for your Azure connection in different ways, depending on your security concerns and compliance needs.</span></span> 

<span data-ttu-id="6ec8c-249">ExpressRoute работает на уровне 3.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-249">ExpressRoute operates in layer 3.</span></span> <span data-ttu-id="6ec8c-250">Угрозы на уровне приложения можно предотвратить с помощью устройства безопасности сети, которое разрешает передачу трафика только из допустимых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-250">Threats in the application layer can be prevented by using a network security appliance that restricts traffic to legitimate resources.</span></span> <span data-ttu-id="6ec8c-251">Кроме того, подключения ExpressRoute, использующие общедоступный пиринг, можно инициировать только из локальной среды.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-251">Additionally, ExpressRoute connections using public peering can only be initiated from on-premises.</span></span> <span data-ttu-id="6ec8c-252">Таким образом посторонние службы не смогут получить доступ к локальным данным и скомпрометировать их из Интернета.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-252">This prevents a rogue service from accessing and compromising on-premises data from the Internet.</span></span>

<span data-ttu-id="6ec8c-253">Чтобы повысить уровень безопасности, добавьте устройства безопасности сети между локальной сетью и пограничными маршрутизаторами поставщика.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-253">To maximize security, add network security appliances between the on-premises network and the provider edge routers.</span></span> <span data-ttu-id="6ec8c-254">Это поможет ограничить поступление несанкционированного трафика из виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-254">This will help to restrict the inflow of unauthorized traffic from the VNet:</span></span>

<span data-ttu-id="6ec8c-255">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="6ec8c-255">![[2]][2]</span></span>

<span data-ttu-id="6ec8c-256">Чтобы проводить аудит или обеспечить соответствие требованиям, может потребоваться запретить прямой доступ из компонентов, работающих в виртуальной сети, к Интернету и реализовать [принудительное туннелирование][forced-tuneling].</span><span class="sxs-lookup"><span data-stu-id="6ec8c-256">For auditing or compliance purposes, it may be necessary to prohibit direct access from components running in the VNet to the Internet and implement [forced tunneling][forced-tuneling].</span></span> <span data-ttu-id="6ec8c-257">В этом случае следует настроить перенаправление интернет-трафика обратно через локальный прокси-сервер, где можно будет выполнить его аудит.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-257">In this situation, Internet traffic should be redirected back through a proxy running  on-premises where it can be audited.</span></span> <span data-ttu-id="6ec8c-258">На прокси-сервере можно настроить блокировку несанкционированного исходящего трафика и фильтрацию потенциально вредоносного входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-258">The proxy can be configured to block unauthorized traffic flowing out, and filter potentially malicious inbound traffic.</span></span>

<span data-ttu-id="6ec8c-259">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="6ec8c-259">![[3]][3]</span></span>

<span data-ttu-id="6ec8c-260">Чтобы повысить уровень безопасности, не включайте общедоступные IP-адреса для виртуальных машин и используйте группы безопасности сети, чтобы виртуальные машины не были общедоступными.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-260">To maximize security, do not enable a public IP address for your VMs, and use NSGs to ensure that these VMs aren't publicly accessible.</span></span> <span data-ttu-id="6ec8c-261">Виртуальные машины должны быть доступны только при использовании внутреннего IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-261">VMs should only be available using the internal IP address.</span></span> <span data-ttu-id="6ec8c-262">Эти адреса можно сделать доступными через сеть ExpressRoute, разрешив сотрудникам отдела DevOps вашей организации выполнять обслуживание или настройку.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-262">These addresses can be made accessible through the ExpressRoute network, enabling on-premises DevOps staff to perform configuration or maintenance.</span></span>

<span data-ttu-id="6ec8c-263">Чтобы предоставить конечные точки управления для виртуальных машин во внешней сети, используйте группы безопасности сети или списки управления доступом. Таким образом эти порты будут видны только IP-адресам или сетям из списка разрешений.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-263">If you must expose management endpoints for VMs to an external network, use NSGs or access control lists to restrict the visibility of these ports to a whitelist of IP addresses or networks.</span></span>

> [!NOTE]
> <span data-ttu-id="6ec8c-264">По умолчанию виртуальные машины Azure, развернутые с помощью портала Azure, включают общедоступный IP-адрес, который предоставляет право на вход.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-264">By default, Azure VMs deployed through the Azure portal include a public IP address that provides login access.</span></span>  
> 
> 


## <a name="deploy-the-solution"></a><span data-ttu-id="6ec8c-265">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="6ec8c-265">Deploy the solution</span></span>

<span data-ttu-id="6ec8c-266">**Предварительные требования.**</span><span class="sxs-lookup"><span data-stu-id="6ec8c-266">**Prequisites.**</span></span> <span data-ttu-id="6ec8c-267">Вам необходима настроенная локальная инфраструктура с подходящим сетевым устройством.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-267">You must have an existing on-premises infrastructure already configured with a suitable network appliance.</span></span>

<span data-ttu-id="6ec8c-268">Чтобы развернуть решение, сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-268">To deploy the solution, perform the following steps.</span></span>

1. <span data-ttu-id="6ec8c-269">Нажмите кнопку ниже:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-269">Click the button below:</span></span><br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fhybrid-networking%2Fexpressroute%2Fazuredeploy.json" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>
2. <span data-ttu-id="6ec8c-270">Подождите, пока на портале Azure не откроется ссылка, а затем сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-270">Wait for the link to open in the Azure portal, then follow these steps:</span></span>
   * <span data-ttu-id="6ec8c-271">Имя **группы ресурсов** уже определено в файле параметров, поэтому выберите **Создать** и введите `ra-hybrid-er-rg` в текстовом поле.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-271">The **Resource group** name is already defined in the parameter file, so select **Create New** and enter `ra-hybrid-er-rg` in the text box.</span></span>
   * <span data-ttu-id="6ec8c-272">В раскрывающемся списке **Расположение** выберите регион.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-272">Select the region from the **Location** drop down box.</span></span>
   * <span data-ttu-id="6ec8c-273">Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-273">Do not edit the **Template Root Uri** or the **Parameter Root Uri** text boxes.</span></span>
   * <span data-ttu-id="6ec8c-274">Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-274">Review the terms and conditions, then click the **I agree to the terms and conditions stated above** checkbox.</span></span>
   * <span data-ttu-id="6ec8c-275">Нажмите кнопку **Приобрести**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-275">Click the **Purchase** button.</span></span>
3. <span data-ttu-id="6ec8c-276">Дождитесь завершения развертывания.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-276">Wait for the deployment to complete.</span></span>
4. <span data-ttu-id="6ec8c-277">Нажмите кнопку ниже:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-277">Click the button below:</span></span><br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fhybrid-networking%2Fexpressroute%2Fazuredeploy-expressRouteCircuit.json" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>
5. <span data-ttu-id="6ec8c-278">Подождите, пока на портале Azure не откроется ссылка, а затем сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="6ec8c-278">Wait for the link to open in the Azure portal, then follow these steps:</span></span>
   * <span data-ttu-id="6ec8c-279">В разделе **Группа ресурсов** выберите **Использовать имеющийся**, а затем в текстовом поле введите `ra-hybrid-er-rg`.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-279">Select **Use existing** in the **Resource group** section and enter `ra-hybrid-er-rg` in the text box.</span></span>
   * <span data-ttu-id="6ec8c-280">В раскрывающемся списке **Расположение** выберите регион.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-280">Select the region from the **Location** drop down box.</span></span>
   * <span data-ttu-id="6ec8c-281">Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).</span><span class="sxs-lookup"><span data-stu-id="6ec8c-281">Do not edit the **Template Root Uri** or the **Parameter Root Uri** text boxes.</span></span>
   * <span data-ttu-id="6ec8c-282">Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-282">Review the terms and conditions, then click the **I agree to the terms and conditions stated above** checkbox.</span></span>
   * <span data-ttu-id="6ec8c-283">Нажмите кнопку **Приобрести**.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-283">Click the **Purchase** button.</span></span>
6. <span data-ttu-id="6ec8c-284">Дождитесь завершения развертывания.</span><span class="sxs-lookup"><span data-stu-id="6ec8c-284">Wait for the deployment to complete.</span></span>


<!-- links -->
[forced-tuneling]: ../dmz/secure-vnet-hybrid.md
[highly-available-network-architecture]: ./expressroute-vpn-failover.md

[expressroute-technical-overview]: /azure/expressroute/expressroute-introduction
[expressroute-prereqs]: /azure/expressroute/expressroute-prerequisites
[configure-expressroute-routing]: /azure/expressroute/expressroute-howto-routing-arm
[sla-for-expressroute]: https://azure.microsoft.com/support/legal/sla/expressroute/v1_0/
[link-vnet-to-expressroute]: /azure/expressroute/expressroute-howto-linkvnet-arm
[ExpressRoute-provisioning]: /azure/expressroute/expressroute-workflows
[expressroute-introduction]: /azure/expressroute/expressroute-introduction
[expressroute-peering]: /azure/expressroute/expressroute-circuit-peerings
[expressroute-pricing]: https://azure.microsoft.com/pricing/details/expressroute/
[expressroute-limits]: /azure/azure-subscription-service-limits#networking-limits
[azurect]: https://github.com/Azure/NetworkMonitoring/tree/master/AzureCT
[visio-download]: https://archcenter.blob.core.windows.net/cdn/hybrid-network-architectures.vsdx
[er-circuit-parameters]: https://github.com/mspnp/reference-architectures/tree/master/hybrid-networking/expressroute/parameters/expressRouteCircuit.parameters.json
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[azure-cli]: https://azure.microsoft.com/documentation/articles/xplat-cli-install/
[0]: ./images/expressroute.png "Реализация гибридной сетевой архитектуры с помощью Azure ExpressRoute"
[1]: ../_images/guidance-hybrid-network-expressroute/figure2.png "Использование избыточных маршрутизаторов с основным и дополнительным каналами ExpressRoute"
[2]: ../_images/guidance-hybrid-network-expressroute/figure3.png "Добавление устройств безопасности для локальной сети"
[3]: ../_images/guidance-hybrid-network-expressroute/figure4.png "Использование принудительного туннелирования для аудита входящего интернет-трафика"
[4]: ../_images/guidance-hybrid-network-expressroute/figure5.png "Поиск ServiceKey для канала ExpressRoute"  