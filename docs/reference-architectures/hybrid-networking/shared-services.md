---
title: Реализация звездообразной топологии сети с помощью общих служб в Azure
description: Сведения о реализации звездообразной топологии сети с помощью общих служб в Azure.
author: telmosampaio
ms.date: 02/25/2018
pnp.series.title: Implement a hub-spoke network topology with shared services in Azure
pnp.series.prev: hub-spoke
ms.openlocfilehash: b492427f12e026be97629ccdc2b8d19c8c66f47d
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="implement-a-hub-spoke-network-topology-with-shared-services-in-azure"></a>Реализация звездообразной топологии сети с помощью общих служб в Azure

Эта эталонная архитектура создана на основе [звездообразной][guidance-hub-spoke] эталонной архитектуры. Это позволяет включить в концентраторе общие службы, которые можно использовать во всех периферийных зонах. Чтобы приступить к перемещению центра обработки данных в облако и создать [виртуальный центр обработки данных], необходимо предоставить общий доступ к службам удостоверений и безопасности. Эта эталонная архитектура содержит сведения о том, как расширить службы Active Directory из локального центра обработки данных в Azure и как добавить виртуальные сетевые модули (NVA), которые могут действовать как брандмауэры, в звездообразную топологию.  [**Разверните это решение**](#deploy-the-solution).

![[0]][0]

*Скачайте [файл Visio][visio-download] этой архитектуры*

Преимущества этой топологии:

* **Сокращение затрат** путем централизации служб, которые могут совместно использоваться несколькими рабочими нагрузками, такими как сетевые виртуальные устройства (NVA) и DNS-серверы в одном расположении.
* **Превышение лимитов подписки** путем пиринга виртуальных сетей из разных подписок к центральному концентратору.
* **Разделение областей ответственности** между центральным ИТ-отделом (SecOps, InfraOps) и рабочими нагрузками (DevOps).

Типичные способы использования этой архитектуры:

* Рабочая нагрузка, развернутая в разных средах, например в среде для разработки, тестирования и в рабочей среде, для которых требуются общие службы, например DNS, IDS, NTP или AD DS. Общие службы размещаются в виртуальной сети концентратора, в то время как каждая среда развертывается в периферийной зоне для обеспечения изоляции.
* Рабочие нагрузки, которые не требуют подключения друг к другу, но требуют доступа к общим службам.
* Предприятия, которые требуют централизованного контроля над аспектами безопасности, такими как брандмауэр в концентраторе, таком как сеть периметра, и отдельного управления для рабочих нагрузок в каждой периферийной зоне.

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов:

* **Локальная сеть.** Частная локальная сеть, работающая внутри организации.

* **VPN-устройство**. Устройство или служба, предоставляющая возможность внешнего подключения к локальной сети. VPN-устройство может быть аппаратным устройством или программным решением, таким как служба маршрутизации и удаленного доступа (RRAS) в Windows Server 2012. Список поддерживаемых VPN-устройств и информацию о настройке выбранных VPN-устройств для подключения к Azure см. в статье [VPN-устройства и параметры IPsec/IKE для подключений типа "сеть — сеть" через VPN-шлюз][vpn-appliance].

* **Сетевой шлюз виртуальной сети VPN или шлюз ExpressRoute**. Шлюз виртуальной сети позволяет виртуальной сети подключаться к VPN-устройству или к каналу ExpressRoute, которые используются для подключения к вашей локальной сети. Дополнительные сведения см. в статье [Подключение локальной сети к виртуальной сети Microsoft Azure][connect-to-an-Azure-vnet].

> [!NOTE]
> В сценариях развертывания для этой эталонной архитектуры используется VPN-шлюз для подключения, а виртуальная сеть в Azure используется для имитации вашей локальной сети.

* **Виртуальная сеть концентратора**. Виртуальная сеть Azure используется в качестве концентратора в звездообразной топологии. Концентратор является центральной точкой подключения к вашей локальной сети и местом для размещения служб, которые могут использоваться различными рабочими нагрузками, размещенными в виртуальных сетях.

* **Подсеть шлюза**. Шлюзы виртуальных сетей хранятся в одной подсети.

* **Подсеть общих служб**. Подсеть в концентраторе виртуальной сети используется для размещения служб, которые могут использоваться совместно во всех периферийных зонах, например DNS или AD DS.

* **Подсеть сети периметра.** Подсеть в виртуальной сети концентратора, используемая для размещения виртуальных сетевых модулей, которые могут действовать как устройства безопасности, например как брандмауэры.

* **Виртуальные сети периферийных зон**. Одна или несколько виртуальных сетей Azure, которые используются в качестве периферийных зон в звездообразной топологии. Периферийные зоны можно использовать для изоляции рабочих нагрузок в их виртуальных сетях, управляемых отдельно от других периферийных зон. Каждая рабочая нагрузка может содержать несколько уровней с несколькими подсетями, подключенными через подсистемы балансировки нагрузки Azure. Дополнительные сведения об инфраструктуре приложений см. в статьях [Запуск рабочих нагрузок на виртуальных машинах Windows][windows-vm-ra] и [Запуск рабочих нагрузок на виртуальной машине Linux][linux-vm-ra].

* **Пиринговая связь между виртуальными сетями**. Две виртуальные сети в одном регионе Azure можно подключить с помощью [пиринга][vnet-peering]. Пиринговые подключения представляют собой нетранзитивные подключения между виртуальными подсетями с низкой задержкой. После установки пирингового подключения виртуальные сети обмениваются трафиком по магистрали Azure без необходимости использования маршрутизатора. В звездообразной топологии сети пиринг виртуальной сети используется для подключения концентратора к каждой периферийной зоне.

> [!NOTE]
> В этой статье рассматриваются только [развертывания Resource Manager](/azure/azure-resource-manager/resource-group-overview), но вы также можете подключить классическую виртуальную сеть к виртуальной сети Resource Manager в той же подписке. Таким образом, ваши периферийные зоны могут размещать классические развертывания и по-прежнему пользоваться преимуществами общих служб в концентраторе.

## <a name="recommendations"></a>Рекомендации

Все рекомендации для [звездообразной][guidance-hub-spoke] эталонной архитектуры также можно применить к эталонной архитектуре общих служб. 

Кроме того, следующие рекомендации применимы для большинства ситуаций с общими службами. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.

### <a name="identity"></a>Удостоверение

В локальном центре обработки данных большинства коммерческих организаций есть среда Active Directory Services (ADDS). Чтобы упростить управление ресурсами, перемещенными в Azure из локальной сети, которая зависит от ADDS, рекомендуется разместить контроллеры домена ADDS в Azure.

Если вы используете объекты групповой политики, которыми вы хотите управлять отдельно для Azure и локальной среды, для каждого региона Azure необходимо использовать разные сайты AD. Разместите контроллеры домена в центральной виртуальной сети (концентраторе), доступ к которой могут получить зависимые рабочие нагрузки.

### <a name="security"></a>Безопасность

При перемещении рабочих нагрузок из локальной среды в Azure некоторые из них потребуется разместить на виртуальных машинах. В целях обеспечения соответствия может потребоваться наложить ограничения на передачу трафика этих рабочих нагрузок. 

Вы можете использовать виртуальные сетевые модули в Azure для размещения разных типов служб безопасности и производительности. Если вы знакомы с заданным набором устройств в локальной среде, рекомендуется использовать те же виртуальные модули в Azure, где это применимо.

> [!NOTE]
> В скриптах развертывания этой эталонной архитектуры используется виртуальная машина Ubuntu с IP-пересылкой, которая позволяет сымитировать виртуальный сетевой модуль.

## <a name="considerations"></a>Рекомендации

### <a name="overcoming-vnet-peering-limits"></a>Преодоление ограничения пиринговых подключений виртуальной сети

Убедитесь, что вы учли [ограничение числа пиринговых подключений виртуальных сетей на одну виртуальную сеть][vnet-peering-limit] в Azure. Если вам нужно превысить лимит по периферийным зонам, подумайте о создании вложенной звездообразной топологии, где первый уровень периферийных зон также выступает в качестве концентраторов. Этот подход показан на схеме ниже.

![[3]][3]

Кроме того, следует учитывать, какие службы используются совместно в концентраторе, чтобы убедиться, что концентратор масштабируется в соответствии с большим количеством периферийных зон. Например, если ваш концентратор предоставляет службы брандмауэра, рассмотрите возможность ограничения пропускной способности решения брандмауэра при добавлении нескольких периферийных зон. Возможно, вам захочется перенести некоторые из этих общих служб на второй уровень концентраторов.

## <a name="deploy-the-solution"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][ref-arch-repo]. В нем используются виртуальные машины Ubuntu в каждой виртуальной сети для проверки возможности подключения. В подсети **shared-services** в **виртуальной сети концентратора** нет настоящих служб.

### <a name="prerequisites"></a>предварительным требованиям

Перед развертыванием эталонной архитектуры в собственной подписке необходимо выполнить следующие действия.

1. Клонируйте или скачайте ZIP-файл [с эталонными архитектурами][ref-arch-repo] в репозитории GitHub либо создайте для него вилку.

2. Убедитесь, что Azure CLI 2.0 установлен на компьютере. См. инструкции по [установке Azure CLI 2.0][azure-cli-2].

3. Установите пакет npm [стандартных блоков Azure][azbb].

4. Из командной строки, строки bash или PowerShell войдите в свою учетную запись Azure с помощью приведенной ниже команды и следуйте инструкциям.

   ```bash
   az login
   ```

### <a name="deploy-the-simulated-on-premises-datacenter-using-azbb"></a>Развертывание имитации локального центра обработки данных с помощью azbb

Чтобы развернуть имитацию локального центра обработки данных в виртуальной сети Azure, следуйте этим инструкциям:

1. Перейдите в папку `hybrid-networking\shared-services-stack\` репозитория, скачанного на предыдущем шаге.

2. Откройте файл `onprem.json` и введите имя пользователя и пароль в кавычках в строках 45 и 46, как показано ниже, а затем сохраните файл.

   ```bash
   "adminUsername": "XXX",
   "adminPassword": "YYY",
   ```

3. Выполните команду `azbb`, чтобы развернуть имитированную локальную среду, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g onprem-vnet-rg - l <location> -p onoprem.json --deploy
   ```
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `onprem-vnet-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

4. Дождитесь завершения развертывания. При развертывании создается виртуальная сеть, виртуальная машина под управлением Windows и VPN-шлюз. Создание VPN-шлюза может занять более 40 минут.

### <a name="azure-hub-vnet"></a>Виртуальная сеть концентратора Azure

Чтобы развернуть виртуальную сеть концентратора Azure и подключиться к имитации локальной виртуальной сети, созданной выше, сделайте следующее.

1. Откройте файл `hub-vnet.json` и введите имя пользователя и пароль в кавычках в строках 50 и 51, как показано ниже.

   ```bash
   "adminUsername": "XXX",
   "adminPassword": "YYY",
   ```

2. В строке 52 для параметра `osType` введите `Windows` или `Linux`, чтобы установить Windows Server 2016 Datacenter или Ubuntu 16.04 в качестве операционной системы для jumpbox.

3. Введите общий ключ в кавычках в строке 83, как показано ниже, а затем сохраните файл.

   ```bash
   "sharedKey": "",
   ```

4. Выполните команду `azbb`, чтобы развернуть имитированную локальную среду, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g hub-vnet-rg - l <location> -p hub-vnet.json --deploy
   ```
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `hub-vnet-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

5. Дождитесь завершения развертывания. В ходе этого развертывания создается виртуальная сеть, виртуальная машина, VPN-шлюз и подключение к шлюзу, созданному в предыдущем разделе. Создание VPN-шлюза может занять более 40 минут.

### <a name="adds-in-azure"></a>ADDS в Azure

Чтобы развернуть контроллеры домена ADDS в Azure, сделайте следующее.

1. Откройте файл `hub-adds.json` и введите имя пользователя и пароль в кавычках в строках 14 и 15, как показано ниже, а затем сохраните файл.

   ```bash
   "adminUsername": "XXX",
   "adminPassword": "YYY",
   ```

2. Запустите `azbb`, чтобы развернуть контроллеры домена ADDS, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g hub-adds-rg - l <location> -p hub-adds.json --deploy
   ```
  
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `hub-adds-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

   > [!NOTE]
   > Этот этап развертывания может занять несколько минут, так как для него требуется подключение двух виртуальных машин к домену, размещенному в имитации локального центра обработки данных, а затем необходимо установить на них AD DS.

### <a name="nva"></a>Виртуальные сетевые модули

Чтобы развернуть виртуальный сетевой модуль в подсети `dmz`, сделайте следующее.

1. Откройте файл `hub-nva.json` и введите имя пользователя и пароль в кавычках в строках 13 и 14, как показано ниже, а затем сохраните файл.

   ```bash
   "adminUsername": "XXX",
   "adminPassword": "YYY",
   ```
2. Выполните команду `azbb`, чтобы развернуть виртуальную машину NVA и определяемые пользователем маршруты.

   ```bash
   azbb -s <subscription_id> -g hub-nva-rg - l <location> -p hub-nva.json --deploy
   ```
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `hub-nva-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

### <a name="azure-spoke-vnets"></a>Виртуальные сети периферийных зон Azure

Чтобы развернуть виртуальные сети периферийных зон, сделайте следующее.

1. Откройте файл `spoke1.json` и введите имя пользователя и пароль в кавычках в строках 52 и 53, как показано ниже, а затем сохраните файл.

   ```bash
   "adminUsername": "XXX",
   "adminPassword": "YYY",
   ```

2. В строке 54 для параметра `osType` введите `Windows` или `Linux`, чтобы установить Windows Server 2016 Datacenter или Ubuntu 16.04 в качестве операционной системы для jumpbox.

3. Выполните команду `azbb`, чтобы развернуть первую среду виртуальной сети периферийных зон, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g spoke1-vnet-rg - l <location> -p spoke1.json --deploy
   ```
  
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `spoke1-vnet-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

4. Повторите шаг 1 для файла `spoke2.json`.

5. Выполните команду `azbb`, чтобы развернуть вторую среду виртуальной сети периферийных зон, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g spoke2-vnet-rg - l <location> -p spoke2.json --deploy
   ```
   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `spoke2-vnet-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

### <a name="azure-hub-vnet-peering-to-spoke-vnets"></a>Пиринговое подключение виртуальной сети концентратора Azure к виртуальным сетям периферийных зон

Чтобы создать пиринговую связь между виртуальной сетью концентратора и виртуальными сетями периферийных зон, сделайте следующее.

1. Откройте файл `hub-vnet-peering.json`, чтобы проверить правильность имени группы ресурсов и имени виртуальной сети для каждого пиринга виртуальных сетей, начиная с 29 строки.

2. Выполните команду `azbb`, чтобы развернуть первую среду виртуальной сети периферийных зон, как показано ниже.

   ```bash
   azbb -s <subscription_id> -g hub-vnet-rg - l <location> -p hub-vnet-peering.json --deploy
   ```

   > [!NOTE]
   > Если вы решили использовать другое имя группы ресурсов (отличное от `hub-vnet-rg`), обязательно найдите все файлы параметров, которые используют это имя, и отредактируйте их, чтобы использовать собственное имя группы ресурсов.

<!-- links -->

[azure-cli-2]: /azure/install-azure-cli
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[guidance-hub-spoke]: ./hub-spoke.md
[azure-vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[best-practices-security]: /azure/best-practices-network-securit
[connect-to-an-Azure-vnet]: https://technet.microsoft.com/library/dn786406.aspx
[guidance-expressroute]: ./expressroute.md
[guidance-vpn]: ./vpn.md
[linux-vm-ra]: ../virtual-machines-linux/index.md
[hybrid-ha]: ./expressroute-vpn-failover.md
[naming conventions]: /azure/guidance/guidance-naming-conventions
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[виртуальный центр обработки данных]: https://aka.ms/vdc
[vnet-peering]: /azure/virtual-network/virtual-network-peering-overview
[vnet-peering-limit]: /azure/azure-subscription-service-limits#networking-limits
[vpn-appliance]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices
[windows-vm-ra]: ../virtual-machines-windows/index.md

[visio-download]: https://archcenter.blob.core.windows.net/cdn/hybrid-network-hub-spoke.vsdx
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[0]: ./images/shared-services.png "Топология общих служб в Azure"
[3]: ./images/hub-spokehub-spoke.svg "Вложенная звездообразная топология в Azure"
[ARM-Templates]: https://azure.microsoft.com/documentation/articles/resource-group-authoring-templates/
