---
title: Пакетная оценка с моделями R в Azure
description: Выполнение пакетной оценки при помощи R-модели, с помощью пакетной службы Azure и набор данных по прогнозированию продаж магазина розничной торговли.
author: njray
ms.date: 03/29/2019
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: azcat-ai
ms.openlocfilehash: 4fa57168c337b01c8e7d0fc86ba54fee59a7ae47
ms.sourcegitcommit: 1a3cc91530d56731029ea091db1f15d41ac056af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2019
ms.locfileid: "58888068"
---
# <a name="batch-scoring-of-r-machine-learning-models-on-azure"></a>Пакетная оценка моделей машинного обучения R в Azure

На схеме эталонной архитектуры показано выполнение пакетной оценки с помощью моделей R с помощью пакетной службы Azure. Сценарий основан на прогнозированию продаж магазина розничной торговли, но эту архитектуру можно обобщить для любого сценария, необходимости создания прогнозов на больших scaler, с помощью R-модели. Эталонную реализацию для этой архитектуры можно найти на сайте [GitHub][github].

![Схема архитектуры][0]

**Сценарий**. Супермаркетов должен для прогнозирования продаж продуктов предстоящих квартала. Прогноз позволяет компании лучше управлять своей цепочке поставок и убедитесь, что сможет удовлетворить спрос на продукты в каждом из магазинов. Компании обновляет ее прогнозируемые каждую неделю по мере поступления новых данных о продажах из предыдущей недели и маркетинговые стратегии для следующего квартала продукта имеет значение. Квантильная прогнозы создаются для оценки неопределенность отдельные прогнозы продаж.

Обработка предусматривает указанные ниже действия.

1. Приложения логики Azure активирует в процессе создания прогноза, один раз в неделю.

1. Приложение логики запускается экземпляр контейнера Azure, контейнер Docker, который активирует оценки заданий в кластере пакета планировщик.

1. Оценки задания выполняются в параллельном режиме на узлах кластера пакетной службы. Каждый узел:

    1. Извлекает рабочую роль образ Docker из Docker Hub и запускает контейнер.

    1. Считывает входные данные и предварительно обученных моделей R из хранилища BLOB-объектов Azure.

    1. Оценивает данные для создания прогнозов.

    1. Записывает результаты прогноза в хранилище BLOB-объектов.

Ниже показаны прогнозируемые продажи для четырех продуктов (номера SKU) в одном хранилище. Черная линия — это журнал продаж, пунктирная линия является Медиана (q50) прогноза, розовый аппаратного контроллера управления представляет процентили двадцать пятой и пятой семьдесят, а синяя полоса процентили пятая и девяносто пятой.

![Прогнозы продаж][1]

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов.

[Пакетная служба Azure] [ batch] используется для запуска задания создания прогноза в параллельном режиме в кластере виртуальных машин. Прогнозы выполняются с помощью предварительно обученную машинного обучения моделей, реализован в пакетной службе Azure R. можно автоматически масштабировать число виртуальных машин на основе числа заданий, отправленных в кластер. На каждом узле скрипт R выполняется в контейнере Docker для оценки данных и создания прогнозов.

[Хранилище BLOB-объектов] [ blob] используется для хранения входных данных, моделей предварительно обученной машинного обучения и прогнозирования результатов. Он обеспечивает очень экономичное хранилище за производительность, которая требуется для этой рабочей нагрузки.

[Экземпляры контейнеров Azure] [ aci] предоставляют беcсерверные вычисления по требованию. В этом случае экземпляр контейнера развертывается в соответствии с расписанием запуска пакетных заданий, которые создают прогнозы. Пакетные задания запускаются из сценария R с помощью [doAzureParallel][doAzureParallel] пакета. Экземпляр контейнера автоматически завершает работу после окончания задания.

[Служба Azure Logic Apps] [ logic-apps] весь рабочий процесс запускается путем развертывания экземпляров контейнера по расписанию. Соединитель экземпляров контейнеров Azure в приложениях логики позволяет экземпляру развертывается от диапазона событий триггера.

## <a name="performance-considerations"></a>Рекомендации по производительности

### <a name="containerized-deployment"></a>Контейнерное развертывание

Благодаря такой архитектуре попадают все скрипты R [Docker](https://www.docker.com/) контейнеры. Это гарантирует, что сценарии запускать в согласованной среде, с той же версией R и версии пакетов, каждый раз. Отдельные образы Docker используются для контейнеров, планировщик и рабочей роли, так как каждый имеет другой набор зависимостей пакетов R.

Экземпляры контейнеров Azure предоставляют бессерверной среде для запуска контейнера планировщика. Контейнер планировщик выполняет сценарий R, запускает отдельные оценки заданий, запущенных на кластере пакетной службы Azure.

На каждом узле кластера пакета выполняется контейнера рабочей роли, которые выполняет скрипт оценки.

### <a name="parallelizing-the-workload"></a>Параллелизация рабочей нагрузки

При пакетной оценки данных с помощью модели R, рассмотрите возможность параллельного выполнения рабочей нагрузки. Входные данные должны быть секционированы каким-либо образом, чтобы операция оценки можно распространять на узлах кластера. Попробуйте разные способы обнаружения лучшим выбором для распределения рабочей нагрузки. Для каждого конкретного случая необходимо учитывайте следующее:

- Какой объем данных может быть загружаются и обрабатываются в память из одного узла.
- Затраты на запуск пакетных заданий.
- Загрузка моделей R издержки.

В сценарий, используемый в этом примере объекты моделей являются большие и занимает всего несколько секунд, чтобы создать прогноз для отдельных продуктов. По этой причине можно сгруппировать продукты и выполнения одного задания пакетной службы на каждом узле. Цикл в каждое задание создает прогнозы для продуктов последовательно. Этот метод оказывается наиболее эффективный способ для параллельного выполнения этой конкретной рабочей нагрузки. Это позволяет избежать нагрузки для запуска многих небольших пакетных заданий и многократно Загрузка моделей R.

Альтернативный подход — для запуска одного пакетного задания на продукт. Пакетная служба Azure автоматически формирует очередь заданий и отправляет их выполнение в кластере как узлы становятся доступными. Используйте [автоматическое масштабирование] [ autoscale] корректировать количество узлов в кластере, в зависимости от количества заданий. Этот подход более рационален Если занимает достаточно долго для завершения каждой операции оценки, выравнивание нагрузки для запуска задания и повторной загрузки объекты модели. Этот подход также проще реализовать и дает возможность использовать автоматическое масштабирование, важно учитывать, если размер рабочая нагрузка не известны заранее.

## <a name="monitoring-and-logging-considerations"></a>Мониторинг и ведение журнала запросов

### <a name="monitoring-azure-batch-jobs"></a>Отслеживание заданий пакетной службы Azure

Мониторинг и завершить пакетных заданий из **заданий** области учетной записи пакетной службы на портале Azure. Мониторинг кластера пакетной службы, состояние отдельных узлов, в том числе из **пулы** области.

### <a name="logging-with-doazureparallel"></a>Ведение журнала с помощью doAzureParallel

Пакет doAzureParallel автоматически собирает журналы из всех stdout и stderr для каждого задания, отправленные в пакетной службе Azure. Их можно найти в учетной записи хранения, которая создается при установке. Чтобы просмотреть их, используйте средства навигации хранилища, такие как [обозреватель службы хранилища Azure] [ storage-explorer] или на портале Azure.

Чтобы быстро отладить пакетных заданий во время разработки, печать журналы в локальный сеанс R с помощью [getJobFiles][getJobFiles] функции doAzureParallel.

## <a name="cost-considerations"></a>Рекомендации по стоимости

Вычислительные ресурсы, используемые в этой эталонной архитектуре — это вызывающих наибольшие издержки компоненты. В этом сценарии кластер фиксированного размера создается каждый раз, когда задание запускается, а затем завершите работу после завершения задания. Плата взимается только при запуске, запуск или завершении работы узлов кластера. Этот подход используется в сценарии, где вычислительные ресурсы, необходимые для создания прогнозов не изменяются из задания.

В сценариях, когда объем вычислений, необходимых для выполнения задания не известен заранее возможно, более подходящий для использования автоматического масштабирования. При таком подходе размер кластера масштабируется вверх или вниз в зависимости от размера задания. Пакетная служба Azure поддерживает широкий спектр формулы автоматического масштабирования, которые можно задать при определении кластера с помощью [doAzureParallel][doAzureParallel] API.

В некоторых случаях время между заданиями, может быть слишком коротким для запуска кластера и завершить работу. В таких случаях все кластере работает между заданиями, при необходимости.

Azure пакетной службы и doAzureParallel поддерживают использование низкоприоритетных виртуальных машин. Эти виртуальные машины в состав более значительную скидку, но риск appropriated с других рабочих нагрузок с высоким приоритетом. Поэтому использование этих виртуальных машин не рекомендуются для критических рабочих нагрузок. Тем не менее, они очень полезны для экспериментальных или рабочих нагрузок при разработке.

## <a name="deployment"></a>Развертывание

Для развертывания этой эталонной архитектуры, выполните действия, описанные в [GitHub][github] репозитория.


[0]: ./_images/batch-scoring-r-models.png
[1]: ./_images/sales-forecasts.png
[aci]: /azure/container-instances/container-instances-overview
[autoscale]: /azure/batch/batch-automatic-scaling
[batch]: /azure/batch/batch-technical-overview
[blob]: /azure/storage/blobs/storage-blobs-introduction
[doAzureParallel]: https://github.com/Azure/doAzureParallel/blob/master/docs/32-autoscale.md
[getJobFiles]: /azure/machine-learning/service/how-to-train-ml-models
[github]: https://github.com/Azure/RBatchScoring
[logic-apps]: /azure/logic-apps/logic-apps-overview
[storage-explorer]: /azure/vs-azure-tools-storage-manage-with-storage-explorer?tabs=windows