---
title: Пакетная оценка моделей Python в Azure
description: Создайте масштабируемое решение для параллельной пакетной оценки моделей по расписанию, используя службу Машинного обучения Azure.
author: njray
ms.date: 01/30/2019
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: azcat-ai, AI
ms.openlocfilehash: 9341b9e4c17025e9623902a6202076c352b237b9
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59640555"
---
# <a name="batch-scoring-of-python-machine-learning-models-on-azure"></a>Пакетная оценка моделей машинного обучения Python в Azure

В этой эталонной архитектуре показано, как создать масштабируемое решение для параллельной пакетной оценки нескольких моделей по расписанию, используя службу Машинного обучения Azure. Это решение можно использовать как шаблон и подготовить к использованию для различных проблем.

Эталонную реализацию для этой архитектуры можно найти на сайте [GitHub][github].

![Пакетная оценка моделей Python в Azure](./_images/batch-scoring-python.png)

**Сценарий**. Это решение отслеживает работу большого количества устройств в параметре Центра Интернета вещей, куда каждое устройство непрерывно отправляет показания датчиков. Предполагается, что каждое устройство связано с предварительно обученными моделями обнаружения аномалий. Они необходимы для прогнозирования того, свидетельствует ли об аномалии серия измерений, агрегированных за предварительно заданный интервал времени. В реальных сценариях это может быть поток показаний датчика, который необходимо отфильтровать и агрегировать перед использованием в обучении или оценке в реальном времени. Для простоты это решение использует тот же файл данных при выполнении заданий оценки.

Эта эталонная архитектура предназначена для рабочих нагрузок, которые активируются по расписанию. Обработка предусматривает указанные ниже действия.

1. Отправка показаний датчиков для приема в Центры событий Azure.
2. Потоковая обработка и сохранение необработанных данных.
3. Отправка данных в кластер Машинного обучения, который подготовлен для работы. Каждый узел в кластере выполняет задание оценки для определенного датчика. 
4. Выполнение конвейера оценки, выполняющего задания оценки в параллельном режиме, с помощью скриптов Python для Машинного обучения. Конвейер создается, публикуется и планируется к выполнению в течение определенного интервала времени.
5. Создание прогнозов и их сохранение в хранилище BLOB-объектов для последующего использования.

## <a name="architecture"></a>Архитектура

Эта архитектура состоит из следующих компонентов.

[Центры событий Azure][event-hubs]. Эта служба приема сообщений может принимать миллионы сообщений о событиях в секунду. В этой архитектуре датчики передают поток данных в концентратор событий.

[Azure Stream Analytics][stream-analytics]. Подсистема обработки событий. Задание Stream Analytics считывает потоки данных из концентратора событий и обрабатывает их.

[База данных SQL Azure][sql-database]. Данные показаний датчиков загружаются в Базу данных SQL. SQL — это привычный способ хранения обработанных потоковых данных (в табличном и структурированном виде), который также позволяет использовать другие хранилища данных.

[Служба машинного обучения Azure][amls]. Машинное обучение — это облачная служба для обучения, оценки, развертывания и администрирования моделей машинного обучения в нужном масштабе. Для пакетной оценки служба Машинного обучения Azure создает кластер виртуальных машин с возможностью автоматического масштабирования, в котором каждый узел выполняет задание оценки для определенного датчика. Задания оценки выполняются в параллельном режиме в виде действий скрипта Python, которые включаются в очередь и управляются службой Машинного обучения Azure. Эти действия являются частью конвейера Машинного обучения, который создается, публикуется и планируется к выполнению в течение определенного интервала времени.

[Хранилище BLOB-объектов Azure][storage]. Контейнеры BLOB-объектов используются для хранения предварительно обученных моделей, данных и результатов прогнозирования. Модели загружаются в хранилище BLOB-объектов в записную книжку [01_create_resources.ipynb][create-resources]. Эти модели [одноклассового SVM][one-class-svm] обучаются на данных, которые представляют собой значения различных датчиков для различных устройств. Это решение предполагает, что значения данных агрегируются за фиксированный интервал времени.

[Реестр контейнеров Azure][acr]. [Скрипт][pyscript] оценки Python выполняется в контейнерах Docker, создаваемых на каждом узле кластера, в котором он считывает данные соответствующих датчиков, создает прогнозы и сохраняет их в хранилище BLOB-объектов.

## <a name="performance-considerations"></a>Рекомендации по производительности

Принято считать, что для обработки рабочей нагрузки стандартных моделей Python достаточно обычных ЦП. Эта архитектура использует ЦП. Однако для [рабочие нагрузки глубокого обучения][deep], GPU обычно более эффективны, чем ЦП, значительное &mdash; изменяемого размера кластера ЦП обычно требуется, чтобы получить сравнимую производительность.

### <a name="parallelizing-across-vms-versus-cores"></a>Параллелизации между виртуальными машинами и ядер

При выполнении процессов оценки многих моделей в пакетном режиме задания должны быть распараллелены между виртуальными машинами. Возможны два подхода:

* Создайте большой кластер, используя недорогие виртуальные машины.

* Создайте маленький кластер, используя высокопроизводительные виртуальные машины с дополнительным количеством ядер, доступных в каждой.

В целом оценка стандартных моделей Python не так сложна, как оценка моделей глубокого обучения, и небольшой кластер должен быть способен эффективно обрабатывать большое количество моделей в очереди. Вы можете увеличить количество узлов кластера по мере увеличения размеров набора данных.

Для удобства в этом сценарии отправляется одно задние оценки в рамках выполнения одного этапа конвейера Машинного обучения. Но более целесообразной была бы оценка нескольких блоков данных в ходе одного этапа конвейера. Для таких случаев необходимо написать пользовательский код для чтения нескольких наборов данных и выполнения для них скрипта оценки в ходе выполнения одного этапа конвейера.

## <a name="management-considerations"></a>Рекомендации по управлению

- **Мониторинг заданий**. Важно следить за ходом выполнения заданий, но это может быть проблемой для мониторинга в кластере активных узлов. Чтобы проверить состояние узлов в кластере, используйте [портал Azure][portal] для управления [рабочей областью машинного обучения][ml-workspace]. Если узел неактивен или произошел сбой задания, журналы ошибок будут сохранены в хранилище BLOB-объектов и также будут доступными в разделе конвейеров. Для оптимизации мониторинга подключите журналы к [Application Insights][app-insights] или запустите отдельные процессы для опроса состояния кластера и его заданий.
- **Ведение журналов.** Служба Машинного обучения автоматически регистрирует в журнале все потоки stdout и stderr в соответствующей учетной записи службы хранилища Azure. С помощью средств навигации, например [Обозревателя службы хранилища Azure][explorer], можно удобно просматривать файлы журнала.

## <a name="cost-considerations"></a>Рекомендации по стоимости

Самые дорогие компоненты, используемые в этой эталонной архитектуре, – вычислительные ресурсы. Вычислительный кластер можно масштабировать в зависимости от заданий в очереди. Включите автоматическое масштабирование программным способом с помощью пакета SDK для Python, изменив конфигурацию подготовки вычислений. Или используйте [Azure CLI][cli] для установки параметров автоматического масштабирования кластера.

Для работы, которая не требует немедленной обработки, настройте формулу автоматического масштабирования, чтобы состояние по умолчанию (минимальное) было кластером нулевых узлов. При использовании этой конфигурации кластер запускается с нулевых узлов и масштабируется только при обнаружении заданий в очереди. Если процесс пакетной оценки происходит несколько раз в день или реже, этот параметр позволяет значительно сократить затраты.

Автоматическое масштабирование может не подойти для пакетных заданий, которые происходят слишком близко друг к другу. За время, необходимое на развертывание кластера и его отключение, также начисляется плата. Поэтому, если пакетная рабочая нагрузка запускается через несколько минут после окончания предыдущего задания, было бы экономически целесообразно не отключать кластер между заданиями. Это зависит от того, запланированы ли процессы оценки с высокой частотой (например, каждый час) или реже (например, раз в месяц).

## <a name="deployment"></a>Развертывание

Для развертывания этой эталонной архитектуры, выполните действия, описанные в [репозитории GitHub][github].

[acr]: /azure/container-registry/container-registry-intro
[ai]: /azure/application-insights/app-insights-overview
[aml-compute]: /azure/machine-learning/service/how-to-set-up-training-targets#amlcompute
[amls]: /azure/machine-learning/service/overview-what-is-azure-ml
[automatic-scaling]: /azure/batch/batch-automatic-scaling
[azure-files]: /azure/storage/files/storage-files-introduction
[cli]: /cli/azure
[create-resources]: https://github.com/Microsoft/AMLBatchScoringPipeline/blob/master/01_create_resources.ipynb
[deep]: /azure/architecture/reference-architectures/ai/batch-scoring-deep-learning
[event-hubs]: /azure/event-hubs/event-hubs-geo-dr
[explorer]: https://azure.microsoft.com/en-us/features/storage-explorer/
[github]: https://github.com/Microsoft/AMLBatchScoringPipeline
[one-class-svm]: http://scikit-learn.org/stable/modules/generated/sklearn.svm.OneClassSVM.html
[portal]: https://portal.azure.com
[ml-workspace]: /azure/machine-learning/studio/create-workspace
[python-script]: https://github.com/Azure/BatchAIAnomalyDetection/blob/master/batchai/predict.py
[pyscript]: https://github.com/Microsoft/AMLBatchScoringPipeline/blob/master/scripts/predict.py
[storage]: /azure/storage/blobs/storage-blobs-overview
[stream-analytics]: /azure/stream-analytics/
[sql-database]: /azure/sql-database/
[app-insights]: /azure/application-insights/app-insights-overview
