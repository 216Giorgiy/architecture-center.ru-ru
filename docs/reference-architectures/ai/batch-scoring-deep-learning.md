---
title: Пакетная оценка для моделей глубокого обучения в Azure
description: Эта эталонная архитектура показывает, как применять передачу нейронного стиля к видео, используя Azure Batch AI
author: jiata
ms.date: 10/02/2018
ms.author: jiata
ms.openlocfilehash: 1f3f3d3882b2b30eb29acd26c9eab9ff128028e2
ms.sourcegitcommit: 9eecff565392273d11b8702f1fcecb4d75e27a15
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2018
ms.locfileid: "48243742"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="e9c99-103">Пакетная оценка для моделей глубокого обучения в Azure</span><span class="sxs-lookup"><span data-stu-id="e9c99-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="e9c99-104">Эта эталонная архитектура показывает, как применять передачу нейронного стиля к видео, используя Azure Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="e9c99-105">*Передача стиля* —это глубокое обучения, которое объединяет существующий образ в стиле другого.</span><span class="sxs-lookup"><span data-stu-id="e9c99-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="e9c99-106">Эту архитектуру можно подготовить к использованию для любого сценария, который использует пакетную оценку с глубоким обучением.</span><span class="sxs-lookup"><span data-stu-id="e9c99-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="e9c99-107">[**Разверните это решение**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="e9c99-107">[**Deploy this solution**](#deploy-the-solution).</span></span>
 
![](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="e9c99-108">**Сценарий**. Организация мультимедиа имеет видео, стиль которого необходимо изменить для того, чтобы оно выглядело как определенная картинка.</span><span class="sxs-lookup"><span data-stu-id="e9c99-108">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="e9c99-109">Организации необходимо применить этот стиль ко всем кадрам из видео своевременно и в автоматическом режиме.</span><span class="sxs-lookup"><span data-stu-id="e9c99-109">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="e9c99-110">Дополнительные сведения об алгоритмах нейронной передачи стиля см. статью [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (Передача стиля образа с помощью сверточных нейронных сетей) (PDF-файл).</span><span class="sxs-lookup"><span data-stu-id="e9c99-110">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="e9c99-111">Стиль образа.</span><span class="sxs-lookup"><span data-stu-id="e9c99-111">Style image:</span></span> | <span data-ttu-id="e9c99-112">Входные данные и содержимое видео.</span><span class="sxs-lookup"><span data-stu-id="e9c99-112">Input/content video:</span></span> | <span data-ttu-id="e9c99-113">Выходной видеопоток.</span><span class="sxs-lookup"><span data-stu-id="e9c99-113">Output video:</span></span> | 
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="e9c99-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Входные данные видео") *щелкните, чтобы просмотреть видео*.</span><span class="sxs-lookup"><span data-stu-id="e9c99-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="e9c99-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Выходные данные видео") *щелкните, чтобы просмотреть видео*.</span><span class="sxs-lookup"><span data-stu-id="e9c99-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="e9c99-116">Эта эталонная архитектура предназначена для рабочих нагрузок, которые активируются при наличие нового носителя в службе хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="e9c99-116">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="e9c99-117">Обработка предусматривает указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="e9c99-117">Processing involves the following steps:</span></span>

1. <span data-ttu-id="e9c99-118">Отправьте выбранный стиль образа (например, картины Ван Гога), а также сценарий стиля передачи в хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-118">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="e9c99-119">Создание автоматически масштабированного кластера Batch AI, который будет готов для начала выполнения работы.</span><span class="sxs-lookup"><span data-stu-id="e9c99-119">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="e9c99-120">Разделите видеофайл на отдельные кадры и отправьте их в хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-120">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="e9c99-121">После отправки всех кадров, передайте файл триггера в хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-121">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="e9c99-122">Этот файл активирует приложение логики, которое создает контейнер в Экземплярах контейнеров Azure.</span><span class="sxs-lookup"><span data-stu-id="e9c99-122">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="e9c99-123">Контейнер запускает сценарий, который создает задания Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-123">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="e9c99-124">Каждое задание применяет передачи нейронного стиля в параллельном режиме на узлах кластера Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-124">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="e9c99-125">После создания образов, они отправляются обратно в хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-125">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="e9c99-126">Скачайте генерируемые кадры и совместите образ с видео.</span><span class="sxs-lookup"><span data-stu-id="e9c99-126">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="e9c99-127">Архитектура</span><span class="sxs-lookup"><span data-stu-id="e9c99-127">Architecture</span></span>
<span data-ttu-id="e9c99-128">Архитектура состоит из следующих компонентов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-128">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="e9c99-129">Службы вычислений</span><span class="sxs-lookup"><span data-stu-id="e9c99-129">Compute</span></span>

<span data-ttu-id="e9c99-130">**[Azure Batch AI][batch-ai]** используется для запуска алгоритма нейронной передачи стиля.</span><span class="sxs-lookup"><span data-stu-id="e9c99-130">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="e9c99-131">Batch AI поддерживает рабочие нагрузки глубокого обучения, предоставляя контейнеризованные среды, которые предварительно настроены для платформы глубокого обучения на виртуальных машинах с поддержкой GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-131">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="e9c99-132">Вычислительный кластер можно также подключить к хранилищу BLOB-объектов с помощью Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-132">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="e9c99-133">Хранилище</span><span class="sxs-lookup"><span data-stu-id="e9c99-133">Storage</span></span>

<span data-ttu-id="e9c99-134">**[Хранилище BLOB-объектов][blob-storage]** используется для хранения всех образов (входных, стилевых и выходных), как и все журналы, полученные из Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-134">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="e9c99-135">Хранилище BLOB-объектов интегрируется с Batch AI с помощью [blobfuse][blobfuse], виртуальной файловой системы с открытым исходным кодом, который поддерживается службой хранилища BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-135">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="e9c99-136">Хранилище BLOB-объектов также является очень экономичным для производительности, которую требует эта рабочая нагрузка.</span><span class="sxs-lookup"><span data-stu-id="e9c99-136">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="e9c99-137">Активирование и планирование</span><span class="sxs-lookup"><span data-stu-id="e9c99-137">Trigger / scheduling</span></span>

<span data-ttu-id="e9c99-138">**[Служба Azure Logic Apps][logic-apps]** используется для запуска рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="e9c99-138">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="e9c99-139">Когда приложение логики обнаруживает, что большой двоичный объект был добавлен в контейнер, он активирует процесс Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-139">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="e9c99-140">Logic Apps хорошо подходит для этой эталонной архитектуры, так как это простой способ обнаружить изменения в хранилище BLOB-объектов и обеспечить простой процесс изменения триггера.</span><span class="sxs-lookup"><span data-stu-id="e9c99-140">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="e9c99-141">**[Экземпляры контейнеров Azure][container-instances]** используется для выполнения сценариев Python, которые создают задания Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-141">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="e9c99-142">Выполнение этих сценариев в контейнере Docker — это удобный способ их запуска по требованию.</span><span class="sxs-lookup"><span data-stu-id="e9c99-142">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="e9c99-143">Для этой архитектуры мы используем Экземпляры контейнеров, так как для него отсутствует предварительно созданный соединитель приложения логики, что позволяет приложению логики запускать задания Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-143">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="e9c99-144">Экземпляры контейнеров могут быстро запускать процессы без отслеживания состояния.</span><span class="sxs-lookup"><span data-stu-id="e9c99-144">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="e9c99-145">**[DockerHub][dockerhub]** используется для хранения образа Docker, который использует экземпляры контейнеров, чтобы выполнить процесс создания задания.</span><span class="sxs-lookup"><span data-stu-id="e9c99-145">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="e9c99-146">DockerHub был выбран для этой архитектуры, так как он прост в использовании и по умолчанию находится в репозиторие образов для пользователей Docker.</span><span class="sxs-lookup"><span data-stu-id="e9c99-146">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="e9c99-147">[Реестр контейнеров Azure][container-registry] также можно использовать.</span><span class="sxs-lookup"><span data-stu-id="e9c99-147">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="e9c99-148">Подготовка данных</span><span class="sxs-lookup"><span data-stu-id="e9c99-148">Data preparation</span></span>

<span data-ttu-id="e9c99-149">Эта эталонная архитектура использует видеоматериалы orangutan в дереве.</span><span class="sxs-lookup"><span data-stu-id="e9c99-149">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="e9c99-150">[Здесь][source-video] вы можете скачать материал и обработать их для рабочего процесса, выполнив следующие действия.</span><span class="sxs-lookup"><span data-stu-id="e9c99-150">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="e9c99-151">Используйте [AzCopy][azcopy], чтобы загружать видео из общедоступного большого двоичного объекта.</span><span class="sxs-lookup"><span data-stu-id="e9c99-151">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="e9c99-152">Используйте [FFmpeg][ffmpeg], чтобы извлечь звуковой файл, так чтобы его можно было присоединить обратно к выходному видео.</span><span class="sxs-lookup"><span data-stu-id="e9c99-152">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="e9c99-153">Используйте FFmpeg, чтобы разбить видео на отдельные кадры.</span><span class="sxs-lookup"><span data-stu-id="e9c99-153">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="e9c99-154">Кадры будут обрабатываться независимо друг от друга, в параллельном режиме.</span><span class="sxs-lookup"><span data-stu-id="e9c99-154">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="e9c99-155">Используйте AzCopy для копирования отдельных кадров в контейнер больших двоичных объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-155">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="e9c99-156">На этом этапе видеоматериал находится в форме, которая может использоваться для передачи нейронной стиля.</span><span class="sxs-lookup"><span data-stu-id="e9c99-156">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span> 

## <a name="performance-considerations"></a><span data-ttu-id="e9c99-157">Рекомендации по производительности</span><span class="sxs-lookup"><span data-stu-id="e9c99-157">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="e9c99-158">GPU и ЦП</span><span class="sxs-lookup"><span data-stu-id="e9c99-158">GPU vs CPU</span></span>

<span data-ttu-id="e9c99-159">Для нагрузок с глубоким обучением, GPU выполнит работу намного лучше чем ЦП, в той степени, в которой необходимо для объемного кластера ЦП для достижения сопоставимой производительности.</span><span class="sxs-lookup"><span data-stu-id="e9c99-159">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="e9c99-160">Хотя и существует возможность использовать в этой архитектуре только ЦП, GPU могут обеспечить намного лучший профиль затрат и производительности.</span><span class="sxs-lookup"><span data-stu-id="e9c99-160">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="e9c99-161">Мы рекомендуем использовать последнюю [серия NCv3]vm-sizes-gpu виртуальных машин оптимизированных для GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-161">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="e9c99-162">Графические процессоры отключены по умолчанию во всех регионах.</span><span class="sxs-lookup"><span data-stu-id="e9c99-162">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="e9c99-163">Убедитесь, что вы выбрали регион с поддержкой GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-163">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="e9c99-164">Кроме того, для подписок установлена квота по умолчанию ноль ядер для виртуальных машин оптимизированных для GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-164">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="e9c99-165">Эту квоту можно вызвать, открыв запрос в службу поддержки.</span><span class="sxs-lookup"><span data-stu-id="e9c99-165">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="e9c99-166">Убедитесь, что ваша подписка имеет достаточно квот для выполнения рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="e9c99-166">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="e9c99-167">Распараллеливание между виртуальными машинами и ядрами</span><span class="sxs-lookup"><span data-stu-id="e9c99-167">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="e9c99-168">При запуске процесса передачи стиля в качестве пакетного задания, задания, которые в основном выполняются GPU, будут выполняться параллельно на виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="e9c99-168">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="e9c99-169">Возможны два подхода: можно создать кластер большего размера, с помощью виртуальных машин, которые имеют один GPU, или создать кластер меньшего размера с помощью виртуальных машин с несколькими GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-169">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span> 

<span data-ttu-id="e9c99-170">Для этой рабочей нагрузки этих два варианта будут использовать сравнимую производительность.</span><span class="sxs-lookup"><span data-stu-id="e9c99-170">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="e9c99-171">С помощью меньшего числа виртуальных машин с несколькими GPU, на виртуальную машину можно сократить перемещение данных.</span><span class="sxs-lookup"><span data-stu-id="e9c99-171">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="e9c99-172">Тем не менее, объем данных для каждого задания для этой рабочей нагрузки не очень больших размеров, поэтому не будет наблюдаться регулирование количества запросов хранилищем BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-172">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="e9c99-173">Размер пакета образов на задания Batch AI</span><span class="sxs-lookup"><span data-stu-id="e9c99-173">Images batch size per Batch AI job</span></span>

<span data-ttu-id="e9c99-174">Еще один параметр, который должен быть настроен — число образов для обработки одного задания Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-174">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="e9c99-175">С одной стороны необходимо убедиться, что работа распределяется широко между узлами и что при сбое задания невозможно использовать повторно слишком много образов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-175">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="e9c99-176">Это указывает на наличие большого числа заданий Batch AI и, следовательно, небольшое количество образов для обработки одного задания.</span><span class="sxs-lookup"><span data-stu-id="e9c99-176">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="e9c99-177">С другой стороны, если на задание обрабатывается слишком мало образов, время установки или запуска непропорционально увеличивается.</span><span class="sxs-lookup"><span data-stu-id="e9c99-177">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="e9c99-178">Можно задать количество заданий, выравнять максимальное количество узлов в кластере.</span><span class="sxs-lookup"><span data-stu-id="e9c99-178">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="e9c99-179">Это будет наиболее производительно, при условии, что не было сбоя заданий, так как он уменьшает объем установки или запуска.</span><span class="sxs-lookup"><span data-stu-id="e9c99-179">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="e9c99-180">Тем не менее, при сбое задания, для большого количества образов может потребоваться провести повторную обработку.</span><span class="sxs-lookup"><span data-stu-id="e9c99-180">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="e9c99-181">Файловые серверы</span><span class="sxs-lookup"><span data-stu-id="e9c99-181">File servers</span></span>

<span data-ttu-id="e9c99-182">При использовании Batch AI, можно выбрать несколько вариантов хранения, в зависимости от пропускной способности, необходимой для вашего сценария.</span><span class="sxs-lookup"><span data-stu-id="e9c99-182">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="e9c99-183">Для рабочих нагрузок с низкой пропускной способностью использование хранилища BLOB-объектов (через blobfuse) должно быть достаточно.</span><span class="sxs-lookup"><span data-stu-id="e9c99-183">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="e9c99-184">В качестве альтернативы Batch AI также поддерживает Файловый сервер Batch AI, управляемый одноузловой NFS, который может автоматически монтироваться на узлах кластера чтобы обеспечить для заданий централизованной доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="e9c99-184">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="e9c99-185">В большинстве случаев требуется только один файловый сервер в рабочей области, и можно разделить данные для заданий обучения в разных каталогах.</span><span class="sxs-lookup"><span data-stu-id="e9c99-185">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="e9c99-186">Если одноузловая NFS не подходит для рабочих нагрузок, Batch AI поддерживает другие варианты хранения, включая файлы Azure или пользовательские решения, например, файловые системы Gluster или Lustre.</span><span class="sxs-lookup"><span data-stu-id="e9c99-186">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="e9c99-187">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="e9c99-187">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="e9c99-188">Ограничение доступа к хранилищу BLOB-объектов Azure</span><span class="sxs-lookup"><span data-stu-id="e9c99-188">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="e9c99-189">В этой эталонной архитектуре хранилище больших двоичных объектов — компонент основного хранилища, который необходимо защитить.</span><span class="sxs-lookup"><span data-stu-id="e9c99-189">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="e9c99-190">Развертывание базовых показателей, показанное в репозитории GitHub использует ключи учетной записи хранения для доступа к хранилищу BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-190">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="e9c99-191">Для дальнейшего управления и защиты рекомендуется использовать подписанный URL-адрес (SAS).</span><span class="sxs-lookup"><span data-stu-id="e9c99-191">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="e9c99-192">Это предоставляет ограниченный доступ к объектам в хранилище, без необходимости жесткого кодирования ключей учетной записи или сохранения их в виде открытого текста.</span><span class="sxs-lookup"><span data-stu-id="e9c99-192">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="e9c99-193">Этот подход особенно полезен, так как ключи учетной записи отображаются в виде обычного текста внутри интерфейса конструктора приложения логики.</span><span class="sxs-lookup"><span data-stu-id="e9c99-193">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="e9c99-194">Использование SAS гарантирует, что учетная запись хранения имеет надлежащее управление, и что доступ предоставляется только пользователям, которым он необходим.</span><span class="sxs-lookup"><span data-stu-id="e9c99-194">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="e9c99-195">Для сценариев с более конфиденциальными данными убедитесь, что все ключи к хранилищу защищены, так как эти ключи предоставляют полный доступ всем входным и выходным данным из рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="e9c99-195">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="e9c99-196">Шифрование и перемещение данных</span><span class="sxs-lookup"><span data-stu-id="e9c99-196">Data encryption and data movement</span></span>

<span data-ttu-id="e9c99-197">Эта эталонная архитектура использует перенос стиля в качестве примера процесса пакетной оценки.</span><span class="sxs-lookup"><span data-stu-id="e9c99-197">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="e9c99-198">Для сценариев с конфиденциальными данными, данные в хранилище необходимо шифровать в состояние покоя.</span><span class="sxs-lookup"><span data-stu-id="e9c99-198">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="e9c99-199">Каждый раз данные перемещаются из одного расположения в другое. Используйте SSL для безопасной передачи данных.</span><span class="sxs-lookup"><span data-stu-id="e9c99-199">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="e9c99-200">Дополнительные сведения см. в [руководстве по безопасности службы хранилища Azure][storage-security].</span><span class="sxs-lookup"><span data-stu-id="e9c99-200">For more information, see [Azure Storage security guide][storage-security].</span></span> 

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="e9c99-201">Защита данных в виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="e9c99-201">Securing data in a virtual network</span></span>

<span data-ttu-id="e9c99-202">При развертывании кластера Batch AI, можно подготовить кластер к работе в подсети виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="e9c99-202">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="e9c99-203">Это позволяет вычислительным узлам в кластере безопасно обмениваться данными с другими виртуальными машинами, или даже с локальной сетью.</span><span class="sxs-lookup"><span data-stu-id="e9c99-203">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="e9c99-204">Можно также использовать [конечные точки службы][service-endpoints] с хранилищем BLOB-объектов, чтобы предоставить доступ из виртуальной сети или использовать NFS с одним узлом внутри виртуальной сети с Batch AI, чтобы убедиться, что данные всегда защищены.</span><span class="sxs-lookup"><span data-stu-id="e9c99-204">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="e9c99-205">Защита от вредоносных действий</span><span class="sxs-lookup"><span data-stu-id="e9c99-205">Protecting against malicious activity</span></span>

<span data-ttu-id="e9c99-206">В сценариях, где имеется несколько пользователей, убедитесь, что конфиденциальные данные защищены от вредоносных действий.</span><span class="sxs-lookup"><span data-stu-id="e9c99-206">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="e9c99-207">Если другим пользователям предоставлен доступ к этому развертыванию, чтобы настроить входные данные, обратите внимание на следующие меры предосторожности и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="e9c99-207">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="e9c99-208">Используйте RBAC для ограничения доступа пользователей к нужным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="e9c99-208">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="e9c99-209">Подготовьте две отдельные учетные записи хранения.</span><span class="sxs-lookup"><span data-stu-id="e9c99-209">Provision two separate storage accounts.</span></span> <span data-ttu-id="e9c99-210">Храните входные и выходные данные в первой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="e9c99-210">Store input and output data in the first account.</span></span> <span data-ttu-id="e9c99-211">Доступ к этой учетной записи можно предоставить внешним пользователям.</span><span class="sxs-lookup"><span data-stu-id="e9c99-211">External users can be given access to this account.</span></span> <span data-ttu-id="e9c99-212">Храните исполняемые сценарии и выходные файлы журналов в другой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="e9c99-212">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="e9c99-213">Внешние пользователи не должны иметь доступ к этой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="e9c99-213">External users should not have access to this account.</span></span> <span data-ttu-id="e9c99-214">Это гарантирует то, что внешние пользователи не могут изменять любые исполняемые файлы (для внедрения вредоносного кода) и не имеют доступ к 	журнальным файлам, которые могут содержать конфиденциальные сведения.</span><span class="sxs-lookup"><span data-stu-id="e9c99-214">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="e9c99-215">Вредоносные пользователи могут использовать атаки DDOS в очереди заданий или вводить неверные сообщения в очереди заданий, заставляя систему блокировать или вызывать ошибки при запуске.</span><span class="sxs-lookup"><span data-stu-id="e9c99-215">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span> 

## <a name="monitoring-and-logging"></a><span data-ttu-id="e9c99-216">Мониторинг и ведение журнала</span><span class="sxs-lookup"><span data-stu-id="e9c99-216">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="e9c99-217">Отслеживание заданий Batch AI</span><span class="sxs-lookup"><span data-stu-id="e9c99-217">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="e9c99-218">Во время выполнения задания, важно отслеживать ход выполнения и убедиться, что все работает должным образом.</span><span class="sxs-lookup"><span data-stu-id="e9c99-218">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="e9c99-219">Тем не менее, сложно отслеживать кластер активных узлов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-219">However, it can be a challenge to monitor across a cluster of active nodes.</span></span> 

<span data-ttu-id="e9c99-220">Чтобы получить представление об общем состояние кластера, перейдите к колонке Batch AI на портале Azure, чтобы проанализировать состояние узлов в кластере.</span><span class="sxs-lookup"><span data-stu-id="e9c99-220">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="e9c99-221">Если узел неактивен или произошел сбой задания, журналы ошибок сохраняются в хранилище BLOB-объектов и также доступны в колонке "Задания" на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="e9c99-221">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span> 

<span data-ttu-id="e9c99-222">Мониторинг можно дополнительно наполнить путем подключения журналов к Application Insights или путем запуска отдельных процессов для опроса о состоянии кластера и заданий Batch AI.</span><span class="sxs-lookup"><span data-stu-id="e9c99-222">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="e9c99-223">Ведение журнала в Batch AI</span><span class="sxs-lookup"><span data-stu-id="e9c99-223">Logging in Batch AI</span></span>

<span data-ttu-id="e9c99-224">Batch AI автоматически выводит все stdout и stderr в учетную запись хранения соединенных больших двоичных объектов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-224">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="e9c99-225">Используя средство навигации хранилища, например, Обозреватель службы хранилища Azure, предоставляет существенно облегченные возможности перемещения файлов журнала.</span><span class="sxs-lookup"><span data-stu-id="e9c99-225">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span> 

<span data-ttu-id="e9c99-226">Этапы развертывания для этой эталонной архитектуры также показывают, как настроить более простую систему ведения журнала, таким образом, что все журналы, выполняемые различные задания, сохранятся в том же каталоге, в контейнере больших двоичных объектов, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="e9c99-226">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span>
<span data-ttu-id="e9c99-227">Используйте эти журналы, чтобы отслеживать, сколько времени необходимо для обработки каждого задания и каждого образа.</span><span class="sxs-lookup"><span data-stu-id="e9c99-227">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="e9c99-228">Это позволит получить более точное представление о том, как оптимизировать процесс еще больше.</span><span class="sxs-lookup"><span data-stu-id="e9c99-228">This will give you a better sense of how to optimize the process even further.</span></span>

![](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="e9c99-229">Рекомендации по стоимости</span><span class="sxs-lookup"><span data-stu-id="e9c99-229">Cost considerations</span></span>

<span data-ttu-id="e9c99-230">По сравнению с хранением и планированием компонентов, вычислительные ресурсы используются в этой эталонной архитектуре, несомненно с точки зрения затрат.</span><span class="sxs-lookup"><span data-stu-id="e9c99-230">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="e9c99-231">Одной из основных задач является эффективное распараллеливание работы на кластере с компьютерами с поддержкой GPU.</span><span class="sxs-lookup"><span data-stu-id="e9c99-231">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="e9c99-232">Размер кластера Batch AI можно автоматически масштабировать в зависимости от заданий в очереди.</span><span class="sxs-lookup"><span data-stu-id="e9c99-232">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="e9c99-233">Вы можете включить автоматическое масштабирование с помощью Batch AI одним из двух способов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-233">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="e9c99-234">Так можно сделать путем программирования, который можно настроить в файле `.env`, который является частью [шагов развертывания][deployment], или можно изменить формулу масштабирования на портале после создания кластера.</span><span class="sxs-lookup"><span data-stu-id="e9c99-234">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="e9c99-235">Для работы, которая не требует немедленной обработки, настройте формулу автоматического масштабирования, чтобы состояние по умолчанию (минимальное) было кластером нулевых узлов.</span><span class="sxs-lookup"><span data-stu-id="e9c99-235">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="e9c99-236">При использовании этой конфигурации кластер запускается с нулевых узлов и масштабируется только при обнаружении заданий в очереди.</span><span class="sxs-lookup"><span data-stu-id="e9c99-236">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="e9c99-237">Если процесс пакетной оценки происходит несколько раз в день или меньше, этот параметр позволяет значительно сократить затраты.</span><span class="sxs-lookup"><span data-stu-id="e9c99-237">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="e9c99-238">Автоматическое масштабирование может не подойти для пакетных заданий, которые происходят слишком близко друг к другу.</span><span class="sxs-lookup"><span data-stu-id="e9c99-238">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="e9c99-239">Время, затрачиваемое на развертывание кластера и его отключение, также несет расходы. Поэтому, если пакет рабочей нагрузки запускается всего через несколько минут после окончания предыдущего задания, более экономично запускать кластер между заданиями.</span><span class="sxs-lookup"><span data-stu-id="e9c99-239">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="e9c99-240">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="e9c99-240">Deploy the solution</span></span>

<span data-ttu-id="e9c99-241">Для развертывания этой эталонной архитектуры, выполните действия, описанные в [репозитории GitHub][deployment].</span><span class="sxs-lookup"><span data-stu-id="e9c99-241">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu