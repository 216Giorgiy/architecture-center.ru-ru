---
title: Пакетная оценка для моделей глубокого обучения
titleSuffix: Azure Reference Architectures
description: Эта эталонная архитектура показывает, как применять нейронную передачу стиля к видео, используя Машинное обучение Azure.
author: jiata
ms.date: 02/06/2019
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: azcat-ai
ms.openlocfilehash: 3459f7895b7b57833da5853a77b2641dc7c85a9e
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59639722"
---
# <a name="batch-scoring-of-deep-learning-models-on-azure"></a>Пакетная оценка моделей глубокого обучения в Azure

Эта эталонная архитектура показывает, как применять нейронную передачу стиля к видео, используя Машинное обучение Azure. *Передача стиля* —это глубокое обучения, которое объединяет существующий образ в стиле другого. Эту архитектуру можно подготовить к использованию для любого сценария, который использует пакетную оценку с глубоким обучением. [**Разверните это решение**](#deploy-the-solution).

![Схема архитектуры для моделей глубокого обучения с использованием Машинного обучения Azure](./_images/aml-scoring-deep-learning.png)

**Сценарий**. Организация, занимающаяся мультимедиа, выпустила видео, стиль которого необходимо изменить с тем, чтобы оно выглядело как определенная картинка. Организации необходимо применить этот стиль ко всем кадрам из видео своевременно и в автоматическом режиме. Дополнительные сведения об алгоритмах нейронной передачи стиля см. статью [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (Передача стиля образа с помощью сверточных нейронных сетей) (PDF-файл).

<!-- markdownlint-disable MD033 -->

| Стиль образа. | Входные данные и содержимое видео. | Выходной видеопоток. |
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | [<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Входные данные видео") *щелкните, чтобы просмотреть видео*. | [<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Выходные данные видео") *щелкните, чтобы просмотреть видео*. |

<!-- markdownlint-enable MD033 -->

Эта эталонная архитектура предназначена для рабочих нагрузок, которые активируются при наличие нового носителя в службе хранилища Azure.

Обработка предусматривает указанные ниже действия.

1. Видеофайл поступает в хранилище.
1. Он активирует приложение логики для отправки запроса к опубликованной конечной точке конвейера Машинного обучения Azure.
1. Конвейер обрабатывает видео, применяет передачу стиля с помощью MPI и выполняет постобработку видео.
1. Выходные данные отправляются обратно в хранилище BLOB-объектов после выполнения конвейера.

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов.

### <a name="compute"></a>Службы вычислений

**[Служба Машинного обучения Azure][amls]** использует конвейеры Машинного обучения Azure для создания воспроизводимых и простых в управлении последовательностей вычислений. Она также предоставляет управляемый целевой объект вычислений для обучения, развертывания и оценки моделей машинного обучения, который называется [Вычислительная среда Машинного обучения Azure][aml-compute].

### <a name="storage"></a>Хранилище

**[Хранилище BLOB-объектов][blob-storage]** используется для хранения всех изображений (входных, стилевых и выходных). Служба Машинного обучения Azure интегрируется с хранилищем BLOB-объектов, поэтому пользователям не нужно вручную отправлять данные на платформы вычислений и в хранилище BLOB-объектов. Хранилище BLOB-объектов также является очень экономичным для производительности, которую требует эта рабочая нагрузка.

### <a name="trigger--scheduling"></a>Активирование и планирование

**[Служба Azure Logic Apps][logic-apps]** используется для запуска рабочего процесса. Когда приложение логики обнаруживает, что большой двоичный объект был добавлен в контейнер, оно активирует конвейер Машинного обучения Azure. Logic Apps хорошо подходит для этой эталонной архитектуры, так как это простой способ обнаружить изменения в хранилище BLOB-объектов и обеспечить простой процесс изменения триггера.

### <a name="preprocessing-and-postprocessing-our-data"></a>Предобработка и постобработка данных

Эта эталонная архитектура использует видеоматериалы orangutan в дереве. Скачать видеозапись можно [здесь][source-video].

1. Используйте [FFmpeg][ffmpeg], чтобы извлечь звуковой файл, чтобы позже его можно было объединить с выходным видео.
1. Используйте FFmpeg, чтобы разбить видео на отдельные кадры. Кадры будут обрабатываться независимо друг от друга, в параллельном режиме.
1. Теперь можно применить нейронную передачу стиля к каждому кадру одновременно.
1. По окончании обработки нам нужно объединить кадры в видеоряд с помощью FFmpeg.
1. Наконец, необходимо добавить ранее извлеченный звуковой файл в объединенный видеоряд.

## <a name="performance-considerations"></a>Рекомендации по производительности

### <a name="gpu-versus-cpu"></a>GPU и ЦП

Для нагрузок с глубоким обучением, GPU выполнит работу намного лучше чем ЦП, в той степени, в которой необходимо для объемного кластера ЦП для достижения сопоставимой производительности. Хотя и существует возможность использовать в этой архитектуре только ЦП, GPU могут обеспечить намного лучший профиль затрат и производительности. Мы рекомендуем использовать последнюю [серия NCv3]vm-sizes-gpu виртуальных машин оптимизированных для GPU.

Графические процессоры отключены по умолчанию во всех регионах. Убедитесь, что вы выбрали регион с поддержкой GPU. Кроме того, для подписок установлена квота по умолчанию ноль ядер для виртуальных машин оптимизированных для GPU. Эту квоту можно вызвать, открыв запрос в службу поддержки. Убедитесь, что ваша подписка имеет достаточно квот для выполнения рабочей нагрузки.

### <a name="parallelizing-across-vms-versus-cores"></a>Параллелизации между виртуальными машинами и ядер

При запуске процесса передачи стиля в качестве пакетного задания, задания, которые в основном выполняются GPU, будут выполняться параллельно на виртуальных машинах. Возможны два подхода: можно создать кластер большего размера с помощью виртуальных машин с одним GPU или создать кластер меньшего размера с помощью виртуальных машин с несколькими GPU.

Для этой рабочей нагрузки этих два варианта будут использовать сравнимую производительность. С помощью меньшего числа виртуальных машин с несколькими GPU, на виртуальную машину можно сократить перемещение данных. Тем не менее, объем данных для каждого задания для этой рабочей нагрузки не очень больших размеров, поэтому не будет наблюдаться регулирование количества запросов хранилищем BLOB-объектов.

### <a name="mpi-step"></a>Этап MPI

При создании конвейера Машинного обучения Azure одним из этапов выполнения параллельных вычислений является этап MPI. Этот этап помогает равномерно распределить данные между всеми доступными узлами. Этап MPI выполняется только тогда, когда готовы все запрошенные узлы. Если на одном из узлов произойдет сбой или задание узла будет замещено (если это низкоприоритетная виртуальная машина), этап MPI потребуется выполнять заново.

## <a name="security-considerations"></a>Вопросы безопасности

### <a name="restricting-access-to-azure-blob-storage"></a>Ограничение доступа к хранилищу BLOB-объектов Azure

В этой эталонной архитектуре хранилище больших двоичных объектов — компонент основного хранилища, который необходимо защитить. Развертывание базовых показателей, показанное в репозитории GitHub использует ключи учетной записи хранения для доступа к хранилищу BLOB-объектов. Для дальнейшего управления и защиты рекомендуется использовать подписанный URL-адрес (SAS). Это предоставляет ограниченный доступ к объектам в хранилище, без необходимости жесткого кодирования ключей учетной записи или сохранения их в виде открытого текста. Этот подход особенно полезен, так как ключи учетной записи отображаются в виде обычного текста внутри интерфейса конструктора приложения логики. Использование SAS гарантирует, что учетная запись хранения имеет надлежащее управление, и что доступ предоставляется только пользователям, которым он необходим.

Для сценариев с более конфиденциальными данными убедитесь, что все ключи к хранилищу защищены, так как эти ключи предоставляют полный доступ всем входным и выходным данным из рабочей нагрузки.

### <a name="data-encryption-and-data-movement"></a>Шифрование и перемещение данных

Эта эталонная архитектура использует перенос стиля в качестве примера процесса пакетной оценки. Для сценариев с конфиденциальными данными, данные в хранилище необходимо шифровать в состояние покоя. Каждый раз данные перемещаются из одного расположения в другое. Используйте SSL для безопасной передачи данных. Дополнительные сведения см. в [руководстве по безопасности службы хранилища Azure][storage-security].

### <a name="securing-your-computation-in-a-virtual-network"></a>Безопасность вычислений в виртуальной сети

Развертываемый кластер вычислений Машинного обучения можно подготовить к работе в подсети [виртуальной сети][virtual-network]. Это позволит вычислительным узлам в кластере безопасно обмениваться данными с другими виртуальными машинами.

### <a name="protecting-against-malicious-activity"></a>Защита от вредоносных действий

В сценариях, где имеется несколько пользователей, убедитесь, что конфиденциальные данные защищены от вредоносных действий. Если другим пользователям предоставлен доступ к этому развертыванию, чтобы настроить входные данные, обратите внимание на следующие меры предосторожности и рекомендации.

- Используйте RBAC для ограничения доступа пользователей к нужным ресурсам.
- Подготовьте две отдельные учетные записи хранения. Храните входные и выходные данные в первой учетной записи. Доступ к этой учетной записи можно предоставить внешним пользователям. Храните исполняемые сценарии и выходные файлы журналов в другой учетной записи. Внешние пользователи не должны иметь доступ к этой учетной записи. Это гарантирует то, что внешние пользователи не могут изменять любые исполняемые файлы (для внедрения вредоносного кода) и не имеют доступ к 	журнальным файлам, которые могут содержать конфиденциальные сведения.
- Вредоносные пользователи могут использовать атаки DDOS в очереди заданий или вводить неверные сообщения в очереди заданий, заставляя систему блокировать или вызывать ошибки при запуске.

## <a name="monitoring-and-logging"></a>Мониторинг и ведение журнала

### <a name="monitoring-batch-jobs"></a>Отслеживание пакетных заданий

Во время выполнения задания, важно отслеживать ход выполнения и убедиться, что все работает должным образом. Тем не менее, сложно отслеживать кластер активных узлов.

Чтобы получить представление об общем состояние кластера, перейдите к колонке Машинного обучения на портале Azure для просмотра состояния узлов в кластере. Если узел неактивен или произошел сбой задания, журналы ошибок будут сохранены в хранилище BLOB-объектов и также будут доступными на портале Azure.

Мониторинг можно оптимизировать, подключив журналы к Application Insights или запустив отдельные процессы для опроса состояния кластера и его заданий.

### <a name="logging-with-azure-machine-learning"></a>Ведение журнала средствами Машинного обучения Azure

Машинное обучение Azure автоматически выводит все stdout и stderr в учетную запись хранения связывание больших двоичных объектов. Если эта функция не отключена, рабочая область Машинного обучения Azure автоматически подготавливает учетную запись хранения и сохраняет журналы в ней. С помощью средств навигации, например Обозревателя службы хранилища Azure, можно удобно работать с файлами журнала.

## <a name="cost-considerations"></a>Рекомендации по стоимости

По сравнению с хранением и планированием компонентов, вычислительные ресурсы используются в этой эталонной архитектуре, несомненно с точки зрения затрат. Одной из основных задач является эффективное распараллеливание работы на кластере с компьютерами с поддержкой GPU.

Кластер Вычислительной среды Машинного обучения можно автоматически масштабировать в зависимости от заданий в очереди. Вы можете включить автоматическое масштабирование программным способом, задав минимальное и максимальное количество узлов.

Для заданий, которые не требуют немедленной обработки, настройте автоматическое масштабирование так, чтобы состояние по умолчанию (минимальное) было кластером нулевых узлов. При использовании этой конфигурации кластер запускается с нулевых узлов и масштабируется только при обнаружении заданий в очереди. Если процесс пакетной оценки происходит несколько раз в день или меньше, этот параметр позволяет значительно сократить затраты.

Автоматическое масштабирование может не подойти для пакетных заданий, которые происходят слишком близко друг к другу. Время, затрачиваемое на развертывание кластера и его отключение, также несет расходы. Поэтому, если пакет рабочей нагрузки запускается всего через несколько минут после окончания предыдущего задания, более экономично запускать кластер между заданиями.

Вычислительная среда Машинного обучения также поддерживает низкоприоритетные виртуальные машины. Это позволяет выполнять вычисления на недорогих виртуальных машинах. Главный недостаток заключается в том, что их задания в любое время могут быть замещены. Низкоприоритетные виртуальные машины подходят для некритических рабочих нагрузок пакетной оценки.

## <a name="deploy-the-solution"></a>Развертывание решения

Для развертывания этой эталонной архитектуры, выполните действия, описанные в [репозитории GitHub][deployment].

> [!NOTE]
> Вы также можете развернуть архитектуру пакетной оценки для моделей глубокого обучения с помощью Службы Azure Kubernetes. Выполните действия, описанные в этом [репозитории GitHub][deployment2].

<!-- links -->

[aml-compute]: /azure/machine-learning/service/how-to-set-up-training-targets#amlcompute
[amls]: /azure/machine-learning/service/overview-what-is-azure-ml
[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/Batch-Scoring-Deep-Learning-Models-With-AML
[deployment2]: https://github.com/Azure/Batch-Scoring-Deep-Learning-Models-With-AKS
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu
[virtual-network]: /azure/machine-learning/service/how-to-enable-virtual-network
