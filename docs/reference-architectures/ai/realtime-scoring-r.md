---
title: Оценка в реальном времени с помощью моделей машинного обучения на языке R
description: Реализуйте службу для прогнозирования в реальном времени на языке R с помощью Machine Learning Server под управлением Службы Azure Kubernetes (AKS).
author: njray
ms.date: 12/12/2018
ms.custom: azcat-ai
ms.openlocfilehash: 6f3447d1dcab801ccdaf4cf88611725cc00eb68d
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54112283"
---
# <a name="real-time-scoring-of-r-machine-learning-models"></a><span data-ttu-id="98c45-103">Оценка в реальном времени с помощью моделей машинного обучения на языке R</span><span class="sxs-lookup"><span data-stu-id="98c45-103">Real-time scoring of R machine learning models</span></span>

<span data-ttu-id="98c45-104">В этой эталонной архитектуре показано, как реализовать службу для (синхронного) прогнозирования в реальном времени на языке R с помощью Microsoft Machine Learning Server под управлением Службы Azure Kubernetes (AKS).</span><span class="sxs-lookup"><span data-stu-id="98c45-104">This reference architecture shows how to implement a real-time (synchronous) prediction service in R using Microsoft Machine Learning Server running in Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="98c45-105">Эта архитектура должна быть универсальной и подходить для любой прогнозной модели, созданной на языке R, которую вы хотите развернуть как службу в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="98c45-105">This architecture is intended to be generic and suited for any predictive model built in R that you want to deploy as a real-time service.</span></span> <span data-ttu-id="98c45-106">**[Разверните это решение][github]**.</span><span class="sxs-lookup"><span data-stu-id="98c45-106">**[Deploy this solution][github]**.</span></span>

## <a name="architecture"></a><span data-ttu-id="98c45-107">Архитектура</span><span class="sxs-lookup"><span data-stu-id="98c45-107">Architecture</span></span>

![Оценка в реальном времени с помощью моделей машинного обучения на языке R в Azure][0]

<span data-ttu-id="98c45-109">В этой эталонной архитектуре используется подход на базе контейнеров.</span><span class="sxs-lookup"><span data-stu-id="98c45-109">This reference architecture takes a container-based approach.</span></span> <span data-ttu-id="98c45-110">Образ Docker содержит код R, а также различные артефакты, необходимые для оценки новых данных.</span><span class="sxs-lookup"><span data-stu-id="98c45-110">A Docker image is built containing R, as well as the various artifacts needed to score new data.</span></span> <span data-ttu-id="98c45-111">К ним относится сам объект модели и скрипт оценки.</span><span class="sxs-lookup"><span data-stu-id="98c45-111">These include the model object itself and a scoring script.</span></span> <span data-ttu-id="98c45-112">Этот образ отправляется в реестр Docker, размещенный в Azure, а затем развертывается в кластер Kubernetes, а также в Azure.</span><span class="sxs-lookup"><span data-stu-id="98c45-112">This image is pushed to a Docker registry hosted in Azure, and then deployed to a Kubernetes cluster, also in Azure.</span></span>

<span data-ttu-id="98c45-113">Архитектура этого рабочего процесса включает в себя следующие компоненты.</span><span class="sxs-lookup"><span data-stu-id="98c45-113">The architecture of this workflow includes the following components.</span></span>

- <span data-ttu-id="98c45-114">**[Реестр контейнеров Azure][acr]** используется для хранения образов для этого рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="98c45-114">**[Azure Container Registry][acr]** is used to store the images for this workflow.</span></span> <span data-ttu-id="98c45-115">Реестрами, созданными с помощью Реестра контейнеров, можно управлять с помощью стандартного [API версии 2 реестра Docker][docker] и клиента.</span><span class="sxs-lookup"><span data-stu-id="98c45-115">Registries created with Container Registry can be managed via the standard [Docker Registry V2 API][docker] and client.</span></span>

- <span data-ttu-id="98c45-116">**[Служба Azure Kubernetes][aks]** используется для размещения развертывания и службы.</span><span class="sxs-lookup"><span data-stu-id="98c45-116">**[Azure Kubernetes Service][aks]** is used to host the deployment and service.</span></span> <span data-ttu-id="98c45-117">Кластерами, созданными с помощью AKS, можно управлять с помощью стандартного [API Kubernetes][k-api] и клиента (kubectl).</span><span class="sxs-lookup"><span data-stu-id="98c45-117">Clusters created with AKS can be managed using the standard [Kubernetes API][k-api] and client (kubectl).</span></span>

- <span data-ttu-id="98c45-118">**[Microsoft Machine Learning Server][mmls]** используется для определения REST API для службы и включает в себя [ввод модели в эксплуатацию][operationalization].</span><span class="sxs-lookup"><span data-stu-id="98c45-118">**[Microsoft Machine Learning Server][mmls]** is used to define the REST API for the service and includes [Model Operationalization][operationalization].</span></span> <span data-ttu-id="98c45-119">Этот процесс веб-сервера, ориентированный на службы, прослушивает запросы, которые затем передаются в другие фоновые процессы, выполняющие фактический код R для формирования результатов.</span><span class="sxs-lookup"><span data-stu-id="98c45-119">This service-oriented web server process listens for requests, which are then handed off to other background processes that run the actual R code to generate the results.</span></span> <span data-ttu-id="98c45-120">Все эти процессы выполняются на одном узле в этой конфигурации, которая содержится внутри контейнера.</span><span class="sxs-lookup"><span data-stu-id="98c45-120">All these processes run on a single node in this configuration, which is wrapped in a container.</span></span> <span data-ttu-id="98c45-121">Для получения подробных сведений об использовании этой службы за пределами среды разработки или тестирования обратитесь к своему представителю корпорации Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="98c45-121">For details about using this service outside a dev or test environment, contact your Microsoft representative.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="98c45-122">Рекомендации по производительности</span><span class="sxs-lookup"><span data-stu-id="98c45-122">Performance considerations</span></span>

<span data-ttu-id="98c45-123">Рабочие нагрузки машинного обучения обычно интенсивно используют вычислительные ресурсы как при обучении, так и при оценке новых данных.</span><span class="sxs-lookup"><span data-stu-id="98c45-123">Machine learning workloads tend to be compute-intensive, both when training and when scoring new data.</span></span> <span data-ttu-id="98c45-124">Возьмите за правило не запускать более одного процесса оценки на ядро.</span><span class="sxs-lookup"><span data-stu-id="98c45-124">As a rule of thumb, try not to run more than one scoring process per core.</span></span> <span data-ttu-id="98c45-125">Machine Learning Server позволяет определить количество процессов R, выполняемых в каждом контейнере.</span><span class="sxs-lookup"><span data-stu-id="98c45-125">Machine Learning Server lets you define the number of R processes running in each container.</span></span> <span data-ttu-id="98c45-126">Значение по умолчанию составляет пять процессов.</span><span class="sxs-lookup"><span data-stu-id="98c45-126">The default is five processes.</span></span> <span data-ttu-id="98c45-127">При создании относительно простой модели, такой как линейная регрессия с небольшим количеством переменных или небольшое дерево принятия решений, можно увеличить число процессов.</span><span class="sxs-lookup"><span data-stu-id="98c45-127">When creating a relatively simple model, such as a linear regression with a small number of variables, or a small decision tree, you can increase the number of processes.</span></span> <span data-ttu-id="98c45-128">Отслеживайте нагрузку на ЦП на узлах кластера для определения соответствующего лимита на число контейнеров.</span><span class="sxs-lookup"><span data-stu-id="98c45-128">Monitor the CPU load on your cluster nodes to determine the appropriate limit on the number of containers.</span></span>

<span data-ttu-id="98c45-129">Кластер с поддержкой GPU может ускорить некоторые типы рабочих нагрузок и модели глубокого обучения в частности.</span><span class="sxs-lookup"><span data-stu-id="98c45-129">A GPU-enabled cluster can speed up some types of workloads, and deep learning models in particular.</span></span> <span data-ttu-id="98c45-130">Не все рабочие нагрузки могут воспользоваться преимуществами GPU &mdash; только те, которые активно используют алгебру матриц.</span><span class="sxs-lookup"><span data-stu-id="98c45-130">Not all workloads can take advantage of GPUs &mdash; only those that make heavy use of matrix algebra.</span></span> <span data-ttu-id="98c45-131">Например, модели на основе дерева, включая модели случайных лесов и бустинга, обычно не используют преимущества от GPU.</span><span class="sxs-lookup"><span data-stu-id="98c45-131">For example, tree-based models, including random forests and boosting models, generally derive no advantage from GPUs.</span></span>

<span data-ttu-id="98c45-132">Некоторые типы моделей, такие как случайные леса, являются массово параллелизуемыми на ЦП.</span><span class="sxs-lookup"><span data-stu-id="98c45-132">Some model types such as random forests are massively parallelizable on CPUs.</span></span> <span data-ttu-id="98c45-133">В этих случаях ускорьте оценку одного запроса, распределяя рабочую нагрузку между несколькими ядрами.</span><span class="sxs-lookup"><span data-stu-id="98c45-133">In these cases, speed up the scoring of a single request by distributing the workload across multiple cores.</span></span> <span data-ttu-id="98c45-134">Тем не менее при этом уменьшается объем емкости, доступной для обработки нескольких запросов оценки, учитывая фиксированный размер кластера.</span><span class="sxs-lookup"><span data-stu-id="98c45-134">However, doing so reduces your capacity to handle multiple scoring requests given a fixed cluster size.</span></span>

<span data-ttu-id="98c45-135">Как правило, модели R c открытым исходным кодом хранят все свои данные в памяти, поэтому убедитесь, что узлы имеют достаточно памяти для размещения процессов, которые вы собираетесь выполнять параллельно.</span><span class="sxs-lookup"><span data-stu-id="98c45-135">In general, open-source R models store all their data in memory, so ensure that your nodes have enough memory to accommodate the processes you plan to run concurrently.</span></span> <span data-ttu-id="98c45-136">Если вы применяете Machine Learning Server в соответствии с моделями, используйте библиотеки, которые могут обрабатывать данные на диске, а не считывают их все в памяти.</span><span class="sxs-lookup"><span data-stu-id="98c45-136">If you are using Machine Learning Server to fit your models, use the libraries that can process data on disk, rather than reading it all into memory.</span></span> <span data-ttu-id="98c45-137">Это помогает значительно снизить требования к памяти.</span><span class="sxs-lookup"><span data-stu-id="98c45-137">This can help reduce memory requirements significantly.</span></span> <span data-ttu-id="98c45-138">Независимо от того, используется ли Machine Learning Server или R с открытым исходным кодом, отслеживайте узлы, чтобы гарантировать, что процессы оценки не останутся без памяти.</span><span class="sxs-lookup"><span data-stu-id="98c45-138">Regardless of whether you use Machine Learning Server or open-source R, monitor your nodes to ensure that your scoring processes are not memory-starved.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="98c45-139">Вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="98c45-139">Security considerations</span></span>

### <a name="network-encryption"></a><span data-ttu-id="98c45-140">Сетевое шифрование</span><span class="sxs-lookup"><span data-stu-id="98c45-140">Network encryption</span></span>

<span data-ttu-id="98c45-141">В этой эталонной архитектуре включен протокол HTTPS для обмена данными с кластером и используется промежуточный сертификат от [Let's Encrypt][encrypt].</span><span class="sxs-lookup"><span data-stu-id="98c45-141">In this reference architecture, HTTPS is enabled for communication with the cluster, and a staging certificate from [Let’s Encrypt][encrypt] is used.</span></span> <span data-ttu-id="98c45-142">Для рабочей среды подставьте собственный сертификат от соответствующего заверителя подписи.</span><span class="sxs-lookup"><span data-stu-id="98c45-142">For production purposes, substitute your own certificate from an appropriate signing authority.</span></span>

### <a name="authentication-and-authorization"></a><span data-ttu-id="98c45-143">Аутентификация и авторизация</span><span class="sxs-lookup"><span data-stu-id="98c45-143">Authentication and authorization</span></span>

<span data-ttu-id="98c45-144">Для [ввода модели в эксплуатацию][operationalization] в среде Machine Learning Server требуется, чтобы оценка запросов прошла проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="98c45-144">Machine Learning Server [Model Operationalization][operationalization] requires scoring requests to be authenticated.</span></span> <span data-ttu-id="98c45-145">В этом развертывании используются имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="98c45-145">In this deployment, a username and password are used.</span></span> <span data-ttu-id="98c45-146">Для предприятия можно включить проверку подлинности с использованием [Azure Active Directory][AAD] или создать отдельный внешний интерфейс с помощью [службы управления API Azure][API].</span><span class="sxs-lookup"><span data-stu-id="98c45-146">In an enterprise setting, you can enable authentication using [Azure Active Directory][AAD] or create a separate front end using [Azure API Management][API].</span></span>

<span data-ttu-id="98c45-147">Чтобы задание ввода модели в эксплуатацию правильно работало с Machine Learning Server на контейнерах, необходимо установить сертификат JSON Web Token (JWT).</span><span class="sxs-lookup"><span data-stu-id="98c45-147">For Model Operationalization to work correctly with Machine Learning Server on containers, you must install a JSON Web Token (JWT) certificate.</span></span> <span data-ttu-id="98c45-148">Это развертывание использует сертификат, предоставленный корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="98c45-148">This deployment uses a certificate supplied by Microsoft.</span></span> <span data-ttu-id="98c45-149">Для рабочей среды предоставьте собственный сертификат.</span><span class="sxs-lookup"><span data-stu-id="98c45-149">In a production setting, supply your own.</span></span>

<span data-ttu-id="98c45-150">Для трафика между Реестром контейнеров и AKS рассмотрите возможность включения [управления доступом на основе ролей][rbac] (RBAC), чтобы предоставить только необходимые привилегии доступа.</span><span class="sxs-lookup"><span data-stu-id="98c45-150">For traffic between Container Registry and AKS, consider enabling [role-based access control][rbac] (RBAC) to limit access privileges to only those needed.</span></span>

### <a name="separate-storage"></a><span data-ttu-id="98c45-151">Отдельное хранилище</span><span class="sxs-lookup"><span data-stu-id="98c45-151">Separate storage</span></span>

<span data-ttu-id="98c45-152">Эта эталонная архитектура объединяет приложение (R) и данные (объект модели и скрипт оценки) в один образ.</span><span class="sxs-lookup"><span data-stu-id="98c45-152">This reference architecture bundles the application (R) and the data (model object and scoring script) into a single image.</span></span> <span data-ttu-id="98c45-153">В некоторых случаях может быть полезно разделить их.</span><span class="sxs-lookup"><span data-stu-id="98c45-153">In some cases, it may be beneficial to separate these.</span></span> <span data-ttu-id="98c45-154">Можно поместить модель данных и код в файловое хранилище или [хранилище][storage] BLOB-объектов Azure и извлекать их при инициализации контейнера.</span><span class="sxs-lookup"><span data-stu-id="98c45-154">You can place the model data and code into Azure blob or file [storage][storage], and retrieve them at container initialization.</span></span> <span data-ttu-id="98c45-155">В этом случае убедитесь, что учетная запись хранения настроена для разрешения только доступа с проверкой подлинности и обязательного использования протокола HTTPS.</span><span class="sxs-lookup"><span data-stu-id="98c45-155">In this case, ensure that the storage account is set to allow authenticated access only and require HTTPS.</span></span>

## <a name="monitoring-and-logging-considerations"></a><span data-ttu-id="98c45-156">Мониторинг и ведение журнала запросов</span><span class="sxs-lookup"><span data-stu-id="98c45-156">Monitoring and logging considerations</span></span>

<span data-ttu-id="98c45-157">С помощью [панели мониторинга Kubernetes][dashboard] можно отслеживать общее состояние кластера AKS.</span><span class="sxs-lookup"><span data-stu-id="98c45-157">Use the [Kubernetes dashboard][dashboard] to monitor the overall status of your AKS cluster.</span></span> <span data-ttu-id="98c45-158">Дополнительные сведения приведены в колонке обзора кластера на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="98c45-158">See the cluster’s overview blade in Azure portal for more details.</span></span> <span data-ttu-id="98c45-159">В ресурсах [GitHub][github] также показано, как открыть панель мониторинга из кода R.</span><span class="sxs-lookup"><span data-stu-id="98c45-159">The [GitHub][github] resources also show how to bring up the dashboard from R.</span></span>

<span data-ttu-id="98c45-160">Несмотря на то что панель мониторинга дает представление об общем состоянии работоспособности кластера, также важно отслеживать состояние отдельных контейнеров.</span><span class="sxs-lookup"><span data-stu-id="98c45-160">Although the dashboard gives you a view of the overall health of your cluster, it’s also important to track the status of individual containers.</span></span> <span data-ttu-id="98c45-161">Чтобы сделать это, необходимо включить [службу аналитических сведений Azure Monitor][monitor] в колонке обзора кластера на портале Azure или перейти к статье об [Azure Monitor для контейнеров][monitor-containers] (в предварительной версии).</span><span class="sxs-lookup"><span data-stu-id="98c45-161">To do this, enable [Azure Monitor Insights][monitor] from the cluster overview blade in Azure portal, or see [Azure Monitor for containers][monitor-containers] (in preview).</span></span>

## <a name="cost-considerations"></a><span data-ttu-id="98c45-162">Рекомендации по стоимости</span><span class="sxs-lookup"><span data-stu-id="98c45-162">Cost considerations</span></span>

<span data-ttu-id="98c45-163">Machine Learning Server лицензируется на каждое ядро, и в этом учитываются все ядра в кластере, где будет выполняться Machine Learning Server.</span><span class="sxs-lookup"><span data-stu-id="98c45-163">Machine Learning Server is licensed on a per-core basis, and all the cores in the cluster that will run Machine Learning  Server count towards this.</span></span> <span data-ttu-id="98c45-164">Если вы являетесь корпоративным клиентом Machine Learning Server или Microsoft SQL Server, обратитесь к представителю корпорации Майкрософт для дополнительных сведений о ценах.</span><span class="sxs-lookup"><span data-stu-id="98c45-164">If you are an enterprise Machine Learning Server or Microsoft SQL Server customer, contact your Microsoft representative for pricing details.</span></span>

<span data-ttu-id="98c45-165">Альтернативой Machine Learning Server с открытым исходным кодом является [Plumber][plumber] — пакет R, который превращает ваш код в REST API.</span><span class="sxs-lookup"><span data-stu-id="98c45-165">An open-source alternative to Machine Learning Server is [Plumber][plumber], an R package that turns your code into a REST API.</span></span> <span data-ttu-id="98c45-166">Plumber не такой полнофункциональный, как Machine Learning Server.</span><span class="sxs-lookup"><span data-stu-id="98c45-166">Plumber is less fully featured than Machine Learning Server.</span></span> <span data-ttu-id="98c45-167">Например, по умолчанию он не включает все функции, которые обеспечивают проверку подлинности запроса.</span><span class="sxs-lookup"><span data-stu-id="98c45-167">For example, by default it doesn't include any features that provide request authentication.</span></span> <span data-ttu-id="98c45-168">Если вы используете Plumber, рекомендуется включить [службу управления API Azure][API] для обработки сведений о проверке подлинности.</span><span class="sxs-lookup"><span data-stu-id="98c45-168">If you use Plumber, it’s recommended that you enable [Azure API Management][API] to handle authentication details.</span></span>

<span data-ttu-id="98c45-169">Помимо лицензирования, основной источник затрат — это вычислительные ресурсы кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="98c45-169">Besides licensing, the main cost consideration is the Kubernetes cluster's compute resources.</span></span> <span data-ttu-id="98c45-170">Кластер должен быть достаточно большим для обработки ожидаемого объема запросов в часы пик, но при этом подходе ресурсы простаивают в другое время.</span><span class="sxs-lookup"><span data-stu-id="98c45-170">The cluster must be large enough to handle the expected request volume at peak times, but this approach leaves resources idle at other times.</span></span> <span data-ttu-id="98c45-171">Чтобы ограничить влияние простаивающих ресурсов, необходимо включить [горизонтальное автомасштабирование][autoscaler] для кластера, используя средство kubectl.</span><span class="sxs-lookup"><span data-stu-id="98c45-171">To limit the impact of idle resources, enable the [horizontal autoscaler][autoscaler] for the cluster using the kubectl tool.</span></span> <span data-ttu-id="98c45-172">Можно также использовать [средство автомасштабирования кластера][cluster-autoscaler] AKS.</span><span class="sxs-lookup"><span data-stu-id="98c45-172">Or use the AKS [cluster autoscaler][cluster-autoscaler].</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="98c45-173">Развертывание решения</span><span class="sxs-lookup"><span data-stu-id="98c45-173">Deploy the solution</span></span>

<span data-ttu-id="98c45-174">Эталонную реализацию для этой архитектуры можно найти на сайте [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="98c45-174">The reference implementation of this architecture is available on [GitHub][github].</span></span> <span data-ttu-id="98c45-175">Выполните действия, описанные там, чтобы развернуть простую прогнозную модель как службу.</span><span class="sxs-lookup"><span data-stu-id="98c45-175">Follow the steps described there to deploy a simple predictive model as a service.</span></span>

<!-- links -->
[AAD]: /azure/active-directory/fundamentals/active-directory-whatis
[API]: /azure/api-management/api-management-key-concepts
[ACR]: /azure/container-registry/container-registry-intro
[AKS]: /azure/aks/intro-kubernetes
[autoscaler]: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/
[cluster-autoscaler]: /azure/aks/autoscaler
[monitor]: /azure/monitoring/monitoring-container-insights-overview
[dashboard]: /azure/aks/kubernetes-dashboard
[docker]: https://docs.docker.com/registry/spec/api/
[encrypt]: https://letsencrypt.org/
[gitHub]: https://github.com/Azure/RealtimeRDeployment
[K-API]: https://kubernetes.io/docs/reference/
[MMLS]: /machine-learning-server/what-is-machine-learning-server
[monitor-containers]: /azure/azure-monitor/insights/container-insights-overview
[operationalization]: /machine-learning-server/what-is-operationalization
[plumber]: https://www.rplumber.io
[RBAC]: /azure/role-based-access-control/overview
[storage]: /azure/storage/common/storage-introduction
[0]: ./_images/realtime-scoring-r.png
