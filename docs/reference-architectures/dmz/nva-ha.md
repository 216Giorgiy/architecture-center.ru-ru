---
title: Развертывание высокодоступных виртуальных сетевых модулей
titleSuffix: Azure Reference Architectures
description: Развертывание виртуальных сетевых модулей с высоким уровнем доступности.
author: telmosampaio
ms.date: 12/08/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, networking
ms.openlocfilehash: a0973fad14bd9b4e81ec9940c83b8ebb31e9599b
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486806"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="5f188-103">Развертывание высокодоступных виртуальных сетевых модулей</span><span class="sxs-lookup"><span data-stu-id="5f188-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="5f188-104">В этой статье показано, как развернуть набор виртуальных сетевых модулей (NVA) для обеспечения высокой доступности в Azure.</span><span class="sxs-lookup"><span data-stu-id="5f188-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="5f188-105">Виртуальный сетевой модуль обычно используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям.</span><span class="sxs-lookup"><span data-stu-id="5f188-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="5f188-106">Дополнительные сведения о реализации сети периметра в Azure см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="5f188-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="5f188-107">Статья включает примеры архитектуры для передачи входящего и исходящего трафика по отдельности и вместе.</span><span class="sxs-lookup"><span data-stu-id="5f188-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="5f188-108">**Предварительные требования:** В этой статье предполагается, что у вас есть базовое представление о сети Azure, [подсистемах балансировки нагрузки Azure][lb-overview] и [определяемых пользователем маршрутах][udr-overview].</span><span class="sxs-lookup"><span data-stu-id="5f188-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="5f188-109">Схемы архитектуры</span><span class="sxs-lookup"><span data-stu-id="5f188-109">Architecture diagrams</span></span>

<span data-ttu-id="5f188-110">Виртуальные сетевые модули можно развернуть в сеть периметра с разными архитектурами.</span><span class="sxs-lookup"><span data-stu-id="5f188-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="5f188-111">На следующем рисунке показан пример использования [одного виртуального сетевого модуля][nva-scenario] для входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="5f188-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="5f188-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="5f188-112">![[0]][0]</span></span>

<span data-ttu-id="5f188-113">В этой архитектуре виртуальный сетевой модуль позволяет установить границу в виде безопасной сети путем проверки всего входящего и исходящего сетевого трафика и передачи трафика, соответствующего правилам безопасности сети.</span><span class="sxs-lookup"><span data-stu-id="5f188-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="5f188-114">Тем не менее тот факт, что весь сетевой трафик проходит через NVA, означает, что NVA является единой точкой отказа в сети.</span><span class="sxs-lookup"><span data-stu-id="5f188-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="5f188-115">При сбое в работе NVA путь для сетевого трафика и все внутренние подсети недоступны.</span><span class="sxs-lookup"><span data-stu-id="5f188-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="5f188-116">Для обеспечения высокой доступности для NVA разверните несколько модулей в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="5f188-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="5f188-117">В следующих примерах архитектур описаны ресурсы и конфигурации, необходимые для обеспечения высокой доступности для NVA:</span><span class="sxs-lookup"><span data-stu-id="5f188-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="5f188-118">Решение</span><span class="sxs-lookup"><span data-stu-id="5f188-118">Solution</span></span> | <span data-ttu-id="5f188-119">Преимущества</span><span class="sxs-lookup"><span data-stu-id="5f188-119">Benefits</span></span> | <span data-ttu-id="5f188-120">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="5f188-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="5f188-121">[Входящий трафик с NVA уровня 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="5f188-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="5f188-122">Все узлы NVA активны</span><span class="sxs-lookup"><span data-stu-id="5f188-122">All NVA nodes are active</span></span> |<span data-ttu-id="5f188-123">Требуется NVA, который может завершать соединения и использовать SNAT</span><span class="sxs-lookup"><span data-stu-id="5f188-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="5f188-124">Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure</span><span class="sxs-lookup"><span data-stu-id="5f188-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="5f188-125">Может использоваться только для трафика, внешнего по отношению к среде Azure</span><span class="sxs-lookup"><span data-stu-id="5f188-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="5f188-126">[Исходящий трафик с NVA уровня 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="5f188-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="5f188-127">Все узлы NVA активны</span><span class="sxs-lookup"><span data-stu-id="5f188-127">All NVA nodes are active</span></span> | <span data-ttu-id="5f188-128">Требуется NVA, который может завершить соединения и реализует преобразование адресов исходной сети (SNAT)</span><span class="sxs-lookup"><span data-stu-id="5f188-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="5f188-129">[Входящий и исходящий трафик с NVA уровня 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="5f188-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="5f188-130">Все узлы активны</span><span class="sxs-lookup"><span data-stu-id="5f188-130">All nodes are active</span></span><br/><span data-ttu-id="5f188-131">Возможность обработки трафика, созданного в Azure</span><span class="sxs-lookup"><span data-stu-id="5f188-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="5f188-132">Требуется NVA, который может завершать соединения и использовать SNAT</span><span class="sxs-lookup"><span data-stu-id="5f188-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="5f188-133">Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure</span><span class="sxs-lookup"><span data-stu-id="5f188-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="5f188-134">[Переключение PIP и определяемого пользователем маршрута][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="5f188-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="5f188-135">Один набор NVA для всего трафика</span><span class="sxs-lookup"><span data-stu-id="5f188-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="5f188-136">Может обработать весь трафик (без ограничений на правила для портов)</span><span class="sxs-lookup"><span data-stu-id="5f188-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="5f188-137">Шаблон "активный — пассивный"</span><span class="sxs-lookup"><span data-stu-id="5f188-137">Active-passive</span></span><br/><span data-ttu-id="5f188-138">Требуется процесс отработки отказа</span><span class="sxs-lookup"><span data-stu-id="5f188-138">Requires a failover process</span></span> |
| [<span data-ttu-id="5f188-139">PIP и определяемый пользователем маршрут без SNAT</span><span class="sxs-lookup"><span data-stu-id="5f188-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="5f188-140">Один набор NVA для всего трафика</span><span class="sxs-lookup"><span data-stu-id="5f188-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="5f188-141">Может обработать весь трафик (без ограничений на правила для портов)</span><span class="sxs-lookup"><span data-stu-id="5f188-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="5f188-142">Не требует настройки SNAT для входящих запросов</span><span class="sxs-lookup"><span data-stu-id="5f188-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="5f188-143">Шаблон "активный — пассивный"</span><span class="sxs-lookup"><span data-stu-id="5f188-143">Active-passive</span></span><br/><span data-ttu-id="5f188-144">Требуется процесс отработки отказа</span><span class="sxs-lookup"><span data-stu-id="5f188-144">Requires a failover process</span></span><br/><span data-ttu-id="5f188-145">Проверка и логика отработки отказа выполняются за пределами виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="5f188-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="5f188-146">Входящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="5f188-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="5f188-147">На следующем рисунке показана высокодоступная архитектура, реализующая входящий трафик сети периметра за пределами балансировщика нагрузки, доступного в Интернете.</span><span class="sxs-lookup"><span data-stu-id="5f188-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="5f188-148">Эта архитектура предназначена для подключения к рабочим нагрузкам Azure для трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="5f188-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="5f188-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="5f188-149">![[1]][1]</span></span>

<span data-ttu-id="5f188-150">Преимущество этой архитектуры состоит в том, что NVA активны и в случае сбоя одного подсистема балансировки нагрузки направляет сетевой трафик на другой.</span><span class="sxs-lookup"><span data-stu-id="5f188-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="5f188-151">Оба NVA направляют трафик на внутреннюю подсистему балансировки нагрузки, и пока один из них активен, трафик по-прежнему передается.</span><span class="sxs-lookup"><span data-stu-id="5f188-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="5f188-152">Виртуальные сетевые модули необходимы для завершения передачи SSL-трафика, предназначенного для виртуальных машин веб-уровня.</span><span class="sxs-lookup"><span data-stu-id="5f188-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="5f188-153">Их невозможно расширить для обработки локального трафика, так как для этого требуется другой набор модулей с собственными сетевыми маршрутами.</span><span class="sxs-lookup"><span data-stu-id="5f188-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="5f188-154">Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="5f188-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="5f188-155">Каждая из этих архитектур включает решение развертывания, которое вы можете использовать.</span><span class="sxs-lookup"><span data-stu-id="5f188-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="5f188-156">Дополнительные сведения см. по ссылкам.</span><span class="sxs-lookup"><span data-stu-id="5f188-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="5f188-157">Исходящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="5f188-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="5f188-158">Чтобы предоставить исходящий трафик сети периметра для исходящих запросов рабочей нагрузки Azure, можно развернуть предыдущую архитектуру.</span><span class="sxs-lookup"><span data-stu-id="5f188-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="5f188-159">Следующая архитектура предназначена для обеспечения высокого уровня доступности NVA в сети периметра для трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="5f188-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="5f188-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="5f188-160">![[2]][2]</span></span>

<span data-ttu-id="5f188-161">В этой архитектуре весь исходящий трафик в Azure направляется во внутреннюю подсистему балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="5f188-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="5f188-162">Подсистема балансировки нагрузки распределяет исходящие запросы между набором виртуальных сетевых модулей.</span><span class="sxs-lookup"><span data-stu-id="5f188-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="5f188-163">Эти модули направляют трафик в Интернет по отдельным общедоступным IP-адресам.</span><span class="sxs-lookup"><span data-stu-id="5f188-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="5f188-164">Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="5f188-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="5f188-165">Каждая из этих архитектур включает решение развертывания, которое вы можете использовать.</span><span class="sxs-lookup"><span data-stu-id="5f188-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="5f188-166">Дополнительные сведения см. по ссылкам.</span><span class="sxs-lookup"><span data-stu-id="5f188-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="5f188-167">Входящий и исходящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="5f188-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="5f188-168">В двух предыдущих архитектурах были предусмотрены отдельные сети периметра для входящего и исходящего трафика.</span><span class="sxs-lookup"><span data-stu-id="5f188-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="5f188-169">На схеме следующей архитектуры представлены сведения о том, как создать сеть периметра, которая может использоваться для входящего и исходящего трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="5f188-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="5f188-171">В этой архитектуре виртуальные сетевые модули обрабатывают входящие запросы из шлюза приложений.</span><span class="sxs-lookup"><span data-stu-id="5f188-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="5f188-172">Кроме того, они обрабатывают исходящие запросы из рабочей нагрузки виртуальных машин в пуле внутренней подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="5f188-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="5f188-173">Так как входящий трафик направляется шлюзом приложений, а исходящий — подсистемой балансировки нагрузки, NVA отвечают за обеспечение сходства сеансов.</span><span class="sxs-lookup"><span data-stu-id="5f188-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="5f188-174">То есть шлюз приложения поддерживает сопоставление входящих и исходящих запросов. Благодаря этому он может перенаправлять правильный ответ запросившей стороне.</span><span class="sxs-lookup"><span data-stu-id="5f188-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="5f188-175">Однако внутренняя подсистема балансировки нагрузки не имеет доступа к сопоставлениям шлюза приложения и использует собственную логику для отправки ответов на NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="5f188-176">Подсистема балансировки нагрузки может отправить ответ на NVA, который изначально не получил запрос из шлюза приложения.</span><span class="sxs-lookup"><span data-stu-id="5f188-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="5f188-177">В этом случае модули должны взаимодействовать и передавать ответ между собой, чтобы правильный модуль переслал ответ шлюзу приложений.</span><span class="sxs-lookup"><span data-stu-id="5f188-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="5f188-178">Вы также можете решить проблему асимметричной маршрутизации, настроив виртуальные системные модули таким образом, чтобы они выполняли преобразование адресов исходной сети (SNAT).</span><span class="sxs-lookup"><span data-stu-id="5f188-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="5f188-179">При этом исходный IP-адрес источника запросившей стороны заменяется на один из IP-адресов входящего потока NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="5f188-180">Теперь вы можете использовать несколько виртуальных системных модулей одновременно, сохраняя симметрию маршрута.</span><span class="sxs-lookup"><span data-stu-id="5f188-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="5f188-181">Переключение PIP и определяемого пользователем маршрута с NVA уровня 4</span><span class="sxs-lookup"><span data-stu-id="5f188-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="5f188-182">В следующем примере показана архитектура с активным и пассивным модулем,</span><span class="sxs-lookup"><span data-stu-id="5f188-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="5f188-183">обрабатывающая входящий и исходящий трафик для уровня 4:</span><span class="sxs-lookup"><span data-stu-id="5f188-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="5f188-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="5f188-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="5f188-185">Полное решение для этой архитектуры доступно на сайте [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="5f188-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="5f188-186">Эта архитектура подобна первой, описанной в этой статье.</span><span class="sxs-lookup"><span data-stu-id="5f188-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="5f188-187">Она включает один NVA, принимающий и фильтрующий входящие запросы уровня 4.</span><span class="sxs-lookup"><span data-stu-id="5f188-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="5f188-188">Кроме того, в ней добавлен второй пассивный виртуальный сетевой модуль для обеспечения высокой доступности.</span><span class="sxs-lookup"><span data-stu-id="5f188-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="5f188-189">Если происходит сбой работы активного NVA, пассивный NVA стает активным и определяемый пользователем маршрут и PIP изменяются таким образом, чтобы указывать на сетевые адаптеры на активном NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="5f188-190">Эти изменения определяемого пользователем маршрута и PIP могут выполняться вручную или автоматически.</span><span class="sxs-lookup"><span data-stu-id="5f188-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="5f188-191">Автоматизированный процесс обычно является управляющей программой или другой службой мониторинга, работающей в Azure.</span><span class="sxs-lookup"><span data-stu-id="5f188-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="5f188-192">Он запрашивает проверку работоспособности активного NVA и выполняет переключение определяемого пользователем маршрута и PIP при обнаружении сбоя в работе модуля.</span><span class="sxs-lookup"><span data-stu-id="5f188-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="5f188-193">На предыдущем рисунке показан пример кластера [ZooKeeper][zookeeper], предоставляющего высокодоступную управляющую программу.</span><span class="sxs-lookup"><span data-stu-id="5f188-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="5f188-194">В пределах кластера ZooKeeper кворум узлов выбирает лидера.</span><span class="sxs-lookup"><span data-stu-id="5f188-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="5f188-195">Если в работе лидера происходит сбой, новый выбирается среди оставшихся узлов.</span><span class="sxs-lookup"><span data-stu-id="5f188-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="5f188-196">Узел-лидер выполняет роль управляющей программы, которая запрашивает проверку работоспособности конечной точки для NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="5f188-197">Если при проверке работоспособности NVA не отвечает, управляющая программа активирует пассивный модуль.</span><span class="sxs-lookup"><span data-stu-id="5f188-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="5f188-198">После этого она вызывает API REST Azure для удаления PIP из виртуального сетевого модуля, в котором произошел сбой, и привязывает его к новому активированному модулю.</span><span class="sxs-lookup"><span data-stu-id="5f188-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="5f188-199">Затем она настраивает определяемый пользователем маршрут таким образом, чтобы он указывал на внутренний IP-адрес активированного модуля.</span><span class="sxs-lookup"><span data-stu-id="5f188-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="5f188-200">Не включайте узлы ZooKeeper в подсеть, доступ к которой можно получить только по маршруту, включающему NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="5f188-201">В противном случае при сбое работы модуля узлы ZooKeeper будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="5f188-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="5f188-202">Если по какой-либо причине в работе управляющей программы возникнет сбой, у вас не будет доступа к узлам ZooKeeper для диагностики проблемы.</span><span class="sxs-lookup"><span data-stu-id="5f188-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="5f188-203">Чтобы ознакомиться с полным решением, включая примеры кода, просмотрите файлы в [репозитории GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="5f188-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="5f188-204">Виртуальные сетевые модули с PIP и определяемыми пользователем маршрутами без SNAT</span><span class="sxs-lookup"><span data-stu-id="5f188-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="5f188-205">Эта архитектура использует две виртуальные машины Azure, чтобы разместить брандмауэр NVA в активно-пассивной конфигурации, которая поддерживает автоматическую отработку отказа, но не требует преобразования исходных сетевых адресов (SNAT).</span><span class="sxs-lookup"><span data-stu-id="5f188-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![Архитектура виртуальных сетевых модулей с PIP и определяемыми пользователем маршрутами без SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="5f188-207">Полное решение для этой архитектуры доступно на сайте [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="5f188-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="5f188-208">Данное решение разработано для клиентов Azure, которые не могут настроить SNAT для входящих запросов на своих брандмауэрах NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="5f188-209">SNAT скрывает исходный IP-адрес клиента-источника.</span><span class="sxs-lookup"><span data-stu-id="5f188-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="5f188-210">Если нужно внести в журнал исходные IP-адреса или использовать их в других многоуровневых компонентах безопасности, размещенных за вашими NVA, это решение предлагает базовый подход.</span><span class="sxs-lookup"><span data-stu-id="5f188-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="5f188-211">Отработка отказа записей таблицы UDR выполняется автоматически с использованием адреса для следующего перехода, для которого задан IP-адрес интерфейса на активной виртуальной машине брандмауэра NVA.</span><span class="sxs-lookup"><span data-stu-id="5f188-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="5f188-212">Логика автоматической отработки отказа размещена в приложении-функции, которое создается при помощи [Функций Azure](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="5f188-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="5f188-213">Код отработки отказа выполняется как бессерверная функция внутри Функций Azure.</span><span class="sxs-lookup"><span data-stu-id="5f188-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="5f188-214">Развертывание удобное, экономически эффективное, а также легкое в обслуживании и настройке.</span><span class="sxs-lookup"><span data-stu-id="5f188-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="5f188-215">Кроме того, приложение-функция размещается в Функциях Azure, поэтому оно не имеет зависимостей в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="5f188-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="5f188-216">Если изменения виртуальной сети воздействуют на брандмауэры NVA, приложение-функция продолжает выполняться независимо.</span><span class="sxs-lookup"><span data-stu-id="5f188-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="5f188-217">Тестирование также является более точным, так как оно происходит за пределами виртуальной сети и использует тот же маршрут, что и входящие клиентские запросы.</span><span class="sxs-lookup"><span data-stu-id="5f188-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="5f188-218">Чтобы проверить доступность брандмауэра NVA, код приложения-функции выполняет тестирование одним из двух способов:</span><span class="sxs-lookup"><span data-stu-id="5f188-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="5f188-219">проводит мониторинг состояния виртуальных машин, на которых размещен брандмауэр NVA;</span><span class="sxs-lookup"><span data-stu-id="5f188-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="5f188-220">тестирует наличие открытых портов от брандмауэра к тыловому веб-серверу.</span><span class="sxs-lookup"><span data-stu-id="5f188-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="5f188-221">В этой конфигурации NVA должен предоставлять сокет через PIP, чтобы код приложения-функции мог выполнить тестирование.</span><span class="sxs-lookup"><span data-stu-id="5f188-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="5f188-222">Вы выбираете нужный тип пробы во время настройки приложения-функции.</span><span class="sxs-lookup"><span data-stu-id="5f188-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="5f188-223">Чтобы ознакомиться с полным решением, включая примеры кода, просмотрите файлы в [репозитории GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="5f188-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="5f188-224">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="5f188-224">Next steps</span></span>

- <span data-ttu-id="5f188-225">Узнайте, как [внедрить сеть периметра между Azure и локальным центром данных][dmz-on-prem] с помощью NVA уровня 7.</span><span class="sxs-lookup"><span data-stu-id="5f188-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="5f188-226">Узнайте, как [внедрить сеть периметра между Azure и Интернетом][dmz-internet] с помощью NVA уровня 7.</span><span class="sxs-lookup"><span data-stu-id="5f188-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="5f188-227">Устранение неполадок с сетевым виртуальным модулем в Azure</span><span class="sxs-lookup"><span data-stu-id="5f188-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Архитектура одного NVA"
[1]: ./images/nva-ha/l7-ingress.png "Входящий трафик уровня 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Исходящий трафик уровня 7"
[3]: ./images/nva-ha/active-passive.png "Кластер типа активный — пассивный"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
