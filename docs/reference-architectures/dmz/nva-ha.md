---
title: Развертывание высокодоступных виртуальных сетевых модулей
description: Инструкция по развертыванию высокодоступных виртуальных сетевых модулей.
author: telmosampaio
ms.date: 12/06/2016
pnp.series.title: Network DMZ
pnp.series.prev: secure-vnet-dmz
cardTitle: Deploy highly available network virtual appliances
ms.openlocfilehash: fe279eea3f9cb024d6c6c14943013b9b9a87bc9c
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="9536d-103">Развертывание высокодоступных виртуальных сетевых модулей</span><span class="sxs-lookup"><span data-stu-id="9536d-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="9536d-104">В этой статье показано, как развернуть набор виртуальных сетевых модулей (NVA) для обеспечения высокой доступности в Azure.</span><span class="sxs-lookup"><span data-stu-id="9536d-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="9536d-105">Виртуальный сетевой модуль обычно используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям.</span><span class="sxs-lookup"><span data-stu-id="9536d-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="9536d-106">Дополнительные сведения о реализации сети периметра в Azure см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="9536d-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="9536d-107">Статья включает примеры архитектуры для передачи входящего и исходящего трафика по отдельности и вместе.</span><span class="sxs-lookup"><span data-stu-id="9536d-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span> 

<span data-ttu-id="9536d-108"><strong>Необходимые условия.</strong> В этой статье предполагается, что вы имеете базовое представление о сети Azure, [подсистеме балансировки нагрузки Azure][lb-overview] и [определяемых пользователем маршрутах][udr-overview].</span><span class="sxs-lookup"><span data-stu-id="9536d-108"><strong>Prerequisites:</strong> This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span> 


## <a name="architecture-diagrams"></a><span data-ttu-id="9536d-109">Схемы архитектуры</span><span class="sxs-lookup"><span data-stu-id="9536d-109">Architecture Diagrams</span></span>

<span data-ttu-id="9536d-110">Виртуальные сетевые модули можно развернуть в сеть периметра с разными архитектурами.</span><span class="sxs-lookup"><span data-stu-id="9536d-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="9536d-111">На следующем рисунке показан пример использования [одного виртуального сетевого модуля][nva-scenario] для входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="9536d-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span> 

<span data-ttu-id="9536d-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="9536d-112">![[0]][0]</span></span>

<span data-ttu-id="9536d-113">В этой архитектуре виртуальный сетевой модуль позволяет установить границу в виде безопасной сети путем проверки всего входящего и исходящего сетевого трафика и передачи трафика, соответствующего правилам безопасности сети.</span><span class="sxs-lookup"><span data-stu-id="9536d-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="9536d-114">Тем не менее тот факт, что весь сетевой трафик проходит через NVA, означает, что NVA является единой точкой отказа в сети.</span><span class="sxs-lookup"><span data-stu-id="9536d-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="9536d-115">При сбое в работе NVA путь для сетевого трафика и все внутренние подсети недоступны.</span><span class="sxs-lookup"><span data-stu-id="9536d-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="9536d-116">Для обеспечения высокой доступности для NVA разверните несколько модулей в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="9536d-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>    

<span data-ttu-id="9536d-117">В следующих примерах архитектур описаны ресурсы и конфигурации, необходимые для обеспечения высокой доступности для NVA:</span><span class="sxs-lookup"><span data-stu-id="9536d-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

| <span data-ttu-id="9536d-118">Решение</span><span class="sxs-lookup"><span data-stu-id="9536d-118">Solution</span></span> | <span data-ttu-id="9536d-119">Преимущества</span><span class="sxs-lookup"><span data-stu-id="9536d-119">Benefits</span></span> | <span data-ttu-id="9536d-120">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="9536d-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9536d-121">[Входящий трафик с NVA уровня 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="9536d-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="9536d-122">Все узлы NVA активны</span><span class="sxs-lookup"><span data-stu-id="9536d-122">All NVA nodes are active</span></span> |<span data-ttu-id="9536d-123">Требуется NVA, который может завершать соединения и использовать SNAT</span><span class="sxs-lookup"><span data-stu-id="9536d-123">Requires an NVA that can terminate connections and use SNAT</span></span></br> <span data-ttu-id="9536d-124">Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure</span><span class="sxs-lookup"><span data-stu-id="9536d-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> </br> <span data-ttu-id="9536d-125">Может использоваться только для трафика, внешнего по отношению к среде Azure</span><span class="sxs-lookup"><span data-stu-id="9536d-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="9536d-126">[Исходящий трафик с NVA уровня 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="9536d-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="9536d-127">Все узлы NVA активны</span><span class="sxs-lookup"><span data-stu-id="9536d-127">All NVA nodes are active</span></span> | <span data-ttu-id="9536d-128">Требуется NVA, который может завершить соединения и реализует преобразование адресов исходной сети (SNAT)</span><span class="sxs-lookup"><span data-stu-id="9536d-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="9536d-129">[Входящий и исходящий трафик с NVA уровня 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="9536d-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="9536d-130">Все узлы активны</span><span class="sxs-lookup"><span data-stu-id="9536d-130">All nodes are active</span></span><br/><span data-ttu-id="9536d-131">Возможность обработки трафика, созданного в Azure</span><span class="sxs-lookup"><span data-stu-id="9536d-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="9536d-132">Требуется NVA, который может завершать соединения и использовать SNAT</span><span class="sxs-lookup"><span data-stu-id="9536d-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="9536d-133">Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure</span><span class="sxs-lookup"><span data-stu-id="9536d-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="9536d-134">[Переключение PIP и определяемого пользователем маршрута][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="9536d-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="9536d-135">Один набор NVA для всего трафика</span><span class="sxs-lookup"><span data-stu-id="9536d-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="9536d-136">Может обработать весь трафик (без ограничений на правила для портов)</span><span class="sxs-lookup"><span data-stu-id="9536d-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="9536d-137">Шаблон "активный — пассивный"</span><span class="sxs-lookup"><span data-stu-id="9536d-137">Active-passive</span></span><br/><span data-ttu-id="9536d-138">Требуется процесс отработки отказа</span><span class="sxs-lookup"><span data-stu-id="9536d-138">Requires a failover process</span></span> |

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="9536d-139">Входящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="9536d-139">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="9536d-140">На следующем рисунке показана высокодоступная архитектура, реализующая входящий трафик сети периметра за пределами балансировщика нагрузки, доступного в Интернете.</span><span class="sxs-lookup"><span data-stu-id="9536d-140">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="9536d-141">Эта архитектура предназначена для подключения к рабочим нагрузкам Azure для трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="9536d-141">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="9536d-142">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="9536d-142">![[1]][1]</span></span>

<span data-ttu-id="9536d-143">Преимущество этой архитектуры состоит в том, что NVA активны и в случае сбоя одного подсистема балансировки нагрузки направляет сетевой трафик на другой.</span><span class="sxs-lookup"><span data-stu-id="9536d-143">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="9536d-144">Оба NVA направляют трафик на внутреннюю подсистему балансировки нагрузки, и пока один из них активен, трафик по-прежнему передается.</span><span class="sxs-lookup"><span data-stu-id="9536d-144">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="9536d-145">Виртуальные сетевые модули необходимы для завершения передачи SSL-трафика, предназначенного для виртуальных машин веб-уровня.</span><span class="sxs-lookup"><span data-stu-id="9536d-145">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="9536d-146">Их невозможно расширить для обработки локального трафика, так как для этого требуется другой набор модулей с собственными сетевыми маршрутами.</span><span class="sxs-lookup"><span data-stu-id="9536d-146">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="9536d-147">Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="9536d-147">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="9536d-148">Каждая из этих архитектур включает решение развертывания, которое вы можете использовать.</span><span class="sxs-lookup"><span data-stu-id="9536d-148">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="9536d-149">Дополнительные сведения см. по ссылкам.</span><span class="sxs-lookup"><span data-stu-id="9536d-149">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="9536d-150">Исходящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="9536d-150">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="9536d-151">Чтобы предоставить исходящий трафик сети периметра для исходящих запросов рабочей нагрузки Azure, можно развернуть предыдущую архитектуру.</span><span class="sxs-lookup"><span data-stu-id="9536d-151">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="9536d-152">Следующая архитектура предназначена для обеспечения высокого уровня доступности NVA в сети периметра для трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="9536d-152">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="9536d-153">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="9536d-153">![[2]][2]</span></span>

<span data-ttu-id="9536d-154">В этой архитектуре весь исходящий трафик в Azure направляется во внутреннюю подсистему балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9536d-154">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="9536d-155">Подсистема балансировки нагрузки распределяет исходящие запросы между набором виртуальных сетевых модулей.</span><span class="sxs-lookup"><span data-stu-id="9536d-155">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="9536d-156">Эти модули направляют трафик в Интернет по отдельным общедоступным IP-адресам.</span><span class="sxs-lookup"><span data-stu-id="9536d-156">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="9536d-157">Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="9536d-157">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="9536d-158">Каждая из этих архитектур включает решение развертывания, которое вы можете использовать.</span><span class="sxs-lookup"><span data-stu-id="9536d-158">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="9536d-159">Дополнительные сведения см. по ссылкам.</span><span class="sxs-lookup"><span data-stu-id="9536d-159">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="9536d-160">Входящий и исходящий трафик с NVA уровня 7</span><span class="sxs-lookup"><span data-stu-id="9536d-160">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="9536d-161">В двух предыдущих архитектурах были предусмотрены отдельные сети периметра для входящего и исходящего трафика.</span><span class="sxs-lookup"><span data-stu-id="9536d-161">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="9536d-162">На схеме следующей архитектуры представлены сведения о том, как создать сеть периметра, которая может использоваться для входящего и исходящего трафика уровня 7, например HTTP или HTTPS:</span><span class="sxs-lookup"><span data-stu-id="9536d-162">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span> 

![[4]][4]

<span data-ttu-id="9536d-164">В этой архитектуре виртуальные сетевые модули обрабатывают входящие запросы из шлюза приложений.</span><span class="sxs-lookup"><span data-stu-id="9536d-164">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="9536d-165">Кроме того, они обрабатывают исходящие запросы из рабочей нагрузки виртуальных машин в пуле внутренней подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9536d-165">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="9536d-166">Так как входящий трафик направляется шлюзом приложений, а исходящий — подсистемой балансировки нагрузки, NVA отвечают за обеспечение сходства сеансов.</span><span class="sxs-lookup"><span data-stu-id="9536d-166">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="9536d-167">То есть шлюз приложения поддерживает сопоставление входящих и исходящих запросов. Благодаря этому он может перенаправлять правильный ответ запросившей стороне.</span><span class="sxs-lookup"><span data-stu-id="9536d-167">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="9536d-168">Однако внутренняя подсистема балансировки нагрузки не имеет доступа к сопоставлениям шлюза приложения и использует собственную логику для отправки ответов на NVA.</span><span class="sxs-lookup"><span data-stu-id="9536d-168">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="9536d-169">Подсистема балансировки нагрузки может отправить ответ на NVA, который изначально не получил запрос из шлюза приложения.</span><span class="sxs-lookup"><span data-stu-id="9536d-169">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="9536d-170">В этом случае модули должны взаимодействовать и передавать ответ между собой, чтобы правильный модуль переслал ответ шлюзу приложений.</span><span class="sxs-lookup"><span data-stu-id="9536d-170">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="9536d-171">Вы также можете решить проблему асимметричной маршрутизации, настроив виртуальные системные модули таким образом, чтобы они выполняли преобразование адресов исходной сети (SNAT).</span><span class="sxs-lookup"><span data-stu-id="9536d-171">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="9536d-172">При этом исходный IP-адрес источника запросившей стороны заменяется на один из IP-адресов входящего потока NVA.</span><span class="sxs-lookup"><span data-stu-id="9536d-172">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="9536d-173">Теперь вы можете использовать несколько виртуальных системных модулей одновременно, сохраняя симметрию маршрута.</span><span class="sxs-lookup"><span data-stu-id="9536d-173">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="9536d-174">Переключение PIP и определяемого пользователем маршрута с NVA уровня 4</span><span class="sxs-lookup"><span data-stu-id="9536d-174">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="9536d-175">В следующем примере показана архитектура с активным и пассивным модулем,</span><span class="sxs-lookup"><span data-stu-id="9536d-175">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="9536d-176">обрабатывающая входящий и исходящий трафик для уровня 4:</span><span class="sxs-lookup"><span data-stu-id="9536d-176">This architecture handles both ingress and egress for layer 4 traffic:</span></span> 

<span data-ttu-id="9536d-177">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="9536d-177">![[3]][3]</span></span>

<span data-ttu-id="9536d-178">Эта архитектура подобна первой, описанной в этой статье.</span><span class="sxs-lookup"><span data-stu-id="9536d-178">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="9536d-179">Она включает один NVA, принимающий и фильтрующий входящие запросы уровня 4.</span><span class="sxs-lookup"><span data-stu-id="9536d-179">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="9536d-180">Кроме того, в ней добавлен второй пассивный виртуальный сетевой модуль для обеспечения высокой доступности.</span><span class="sxs-lookup"><span data-stu-id="9536d-180">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="9536d-181">Если происходит сбой работы активного NVA, пассивный NVA стает активным и определяемый пользователем маршрут и PIP изменяются таким образом, чтобы указывать на сетевые адаптеры на активном NVA.</span><span class="sxs-lookup"><span data-stu-id="9536d-181">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="9536d-182">Эти изменения определяемого пользователем маршрута и PIP могут выполняться вручную или автоматически.</span><span class="sxs-lookup"><span data-stu-id="9536d-182">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="9536d-183">Автоматизированный процесс обычно является управляющей программой или другой службой мониторинга, работающей в Azure.</span><span class="sxs-lookup"><span data-stu-id="9536d-183">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="9536d-184">Он запрашивает проверку работоспособности активного NVA и выполняет переключение определяемого пользователем маршрута и PIP при обнаружении сбоя в работе модуля.</span><span class="sxs-lookup"><span data-stu-id="9536d-184">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span> 

<span data-ttu-id="9536d-185">На предыдущем рисунке показан пример кластера [ZooKeeper][zookeeper], предоставляющего высокодоступную управляющую программу.</span><span class="sxs-lookup"><span data-stu-id="9536d-185">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="9536d-186">В пределах кластера ZooKeeper кворум узлов выбирает лидера.</span><span class="sxs-lookup"><span data-stu-id="9536d-186">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="9536d-187">Если в работе лидера происходит сбой, новый выбирается среди оставшихся узлов.</span><span class="sxs-lookup"><span data-stu-id="9536d-187">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="9536d-188">Узел-лидер выполняет роль управляющей программы, которая запрашивает проверку работоспособности конечной точки для NVA.</span><span class="sxs-lookup"><span data-stu-id="9536d-188">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="9536d-189">Если при проверке работоспособности NVA не отвечает, управляющая программа активирует пассивный модуль.</span><span class="sxs-lookup"><span data-stu-id="9536d-189">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="9536d-190">После этого она вызывает API REST Azure для удаления PIP из виртуального сетевого модуля, в котором произошел сбой, и привязывает его к новому активированному модулю.</span><span class="sxs-lookup"><span data-stu-id="9536d-190">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="9536d-191">Затем она настраивает определяемый пользователем маршрут таким образом, чтобы он указывал на внутренний IP-адрес активированного модуля.</span><span class="sxs-lookup"><span data-stu-id="9536d-191">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

> [!NOTE]
> <span data-ttu-id="9536d-192">Не включайте узлы ZooKeeper в подсеть, доступ к которой можно получить только по маршруту, включающему NVA.</span><span class="sxs-lookup"><span data-stu-id="9536d-192">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="9536d-193">В противном случае при сбое работы модуля узлы ZooKeeper будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="9536d-193">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="9536d-194">Если по какой-либо причине в работе управляющей программы возникнет сбой, у вас не будет доступа к узлам ZooKeeper для диагностики проблемы.</span><span class="sxs-lookup"><span data-stu-id="9536d-194">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span> 

<!--### Solution Deployment-->

<!-- instructions for deploying this solution here --> 

## <a name="next-steps"></a><span data-ttu-id="9536d-195">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="9536d-195">Next steps</span></span>
* <span data-ttu-id="9536d-196">Узнайте, как [внедрить сеть периметра между Azure и локальным центром данных][dmz-on-prem] с помощью NVA уровня 7.</span><span class="sxs-lookup"><span data-stu-id="9536d-196">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
* <span data-ttu-id="9536d-197">Узнайте, как [внедрить сеть периметра между Azure и Интернетом][dmz-internet] с помощью NVA уровня 7.</span><span class="sxs-lookup"><span data-stu-id="9536d-197">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>

<!-- links -->
[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/

<!-- images -->
[0]: ./images/nva-ha/single-nva.png "Архитектура одного NVA"
[1]: ./images/nva-ha/l7-ingress.png "Входящий трафик уровня 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Исходящий трафик уровня 7"
[3]: ./images/nva-ha/active-passive.png "Кластер типа "активный — пассивный""
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
