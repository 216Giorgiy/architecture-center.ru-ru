---
title: Развертывание высокодоступных виртуальных сетевых модулей
titleSuffix: Azure Reference Architectures
description: Развертывание виртуальных сетевых модулей с высоким уровнем доступности.
author: telmosampaio
ms.date: 12/08/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, networking
ms.openlocfilehash: a0973fad14bd9b4e81ec9940c83b8ebb31e9599b
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486806"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a>Развертывание высокодоступных виртуальных сетевых модулей

В этой статье показано, как развернуть набор виртуальных сетевых модулей (NVA) для обеспечения высокой доступности в Azure. Виртуальный сетевой модуль обычно используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям. Дополнительные сведения о реализации сети периметра в Azure см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][cloud-security]. Статья включает примеры архитектуры для передачи входящего и исходящего трафика по отдельности и вместе.

**Предварительные требования:** В этой статье предполагается, что у вас есть базовое представление о сети Azure, [подсистемах балансировки нагрузки Azure][lb-overview] и [определяемых пользователем маршрутах][udr-overview].

## <a name="architecture-diagrams"></a>Схемы архитектуры

Виртуальные сетевые модули можно развернуть в сеть периметра с разными архитектурами. На следующем рисунке показан пример использования [одного виртуального сетевого модуля][nva-scenario] для входящего трафика.

![[0]][0]

В этой архитектуре виртуальный сетевой модуль позволяет установить границу в виде безопасной сети путем проверки всего входящего и исходящего сетевого трафика и передачи трафика, соответствующего правилам безопасности сети. Тем не менее тот факт, что весь сетевой трафик проходит через NVA, означает, что NVA является единой точкой отказа в сети. При сбое в работе NVA путь для сетевого трафика и все внутренние подсети недоступны.

Для обеспечения высокой доступности для NVA разверните несколько модулей в группе доступности.

В следующих примерах архитектур описаны ресурсы и конфигурации, необходимые для обеспечения высокой доступности для NVA:

<!-- markdownlint-disable MD033 -->

| Решение | Преимущества | Рекомендации |
| --- | --- | --- |
| [Входящий трафик с NVA уровня 7][ingress-with-layer-7] |Все узлы NVA активны |Требуется NVA, который может завершать соединения и использовать SNAT<br/> Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure <br/> Может использоваться только для трафика, внешнего по отношению к среде Azure |
| [Исходящий трафик с NVA уровня 7][egress-with-layer-7] |Все узлы NVA активны | Требуется NVA, который может завершить соединения и реализует преобразование адресов исходной сети (SNAT)
| [Входящий и исходящий трафик с NVA уровня 7][ingress-egress-with-layer-7] |Все узлы активны<br/>Возможность обработки трафика, созданного в Azure |Требуется NVA, который может завершать соединения и использовать SNAT<br/>Требуется отдельный набор NVA для трафика, поступающего из Интернета и Azure |
| [Переключение PIP и определяемого пользователем маршрута][pip-udr-switch] |Один набор NVA для всего трафика<br/>Может обработать весь трафик (без ограничений на правила для портов) |Шаблон "активный — пассивный"<br/>Требуется процесс отработки отказа |
| [PIP и определяемый пользователем маршрут без SNAT](#pip-udr-nvas-without-snat) | Один набор NVA для всего трафика<br/>Может обработать весь трафик (без ограничений на правила для портов)<br/>Не требует настройки SNAT для входящих запросов |Шаблон "активный — пассивный"<br/>Требуется процесс отработки отказа<br/>Проверка и логика отработки отказа выполняются за пределами виртуальной сети |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a>Входящий трафик с NVA уровня 7

На следующем рисунке показана высокодоступная архитектура, реализующая входящий трафик сети периметра за пределами балансировщика нагрузки, доступного в Интернете. Эта архитектура предназначена для подключения к рабочим нагрузкам Azure для трафика уровня 7, например HTTP или HTTPS:

![[1]][1]

Преимущество этой архитектуры состоит в том, что NVA активны и в случае сбоя одного подсистема балансировки нагрузки направляет сетевой трафик на другой. Оба NVA направляют трафик на внутреннюю подсистему балансировки нагрузки, и пока один из них активен, трафик по-прежнему передается. Виртуальные сетевые модули необходимы для завершения передачи SSL-трафика, предназначенного для виртуальных машин веб-уровня. Их невозможно расширить для обработки локального трафика, так как для этого требуется другой набор модулей с собственными сетевыми маршрутами.

> [!NOTE]
> Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet]. Каждая из этих архитектур включает решение развертывания, которое вы можете использовать. Дополнительные сведения см. по ссылкам.

## <a name="egress-with-layer-7-nvas"></a>Исходящий трафик с NVA уровня 7

Чтобы предоставить исходящий трафик сети периметра для исходящих запросов рабочей нагрузки Azure, можно развернуть предыдущую архитектуру. Следующая архитектура предназначена для обеспечения высокого уровня доступности NVA в сети периметра для трафика уровня 7, например HTTP или HTTPS:

![[2]][2]

В этой архитектуре весь исходящий трафик в Azure направляется во внутреннюю подсистему балансировки нагрузки. Подсистема балансировки нагрузки распределяет исходящие запросы между набором виртуальных сетевых модулей. Эти модули направляют трафик в Интернет по отдельным общедоступным IP-адресам.

> [!NOTE]
> Эта архитектура используется в эталонных архитектурах [сети периметра между Azure и локальным центром обработки данных][dmz-on-prem] и [сети периметра между Azure и Интернетом][dmz-internet]. Каждая из этих архитектур включает решение развертывания, которое вы можете использовать. Дополнительные сведения см. по ссылкам.

## <a name="ingress-egress-with-layer-7-nvas"></a>Входящий и исходящий трафик с NVA уровня 7

В двух предыдущих архитектурах были предусмотрены отдельные сети периметра для входящего и исходящего трафика. На схеме следующей архитектуры представлены сведения о том, как создать сеть периметра, которая может использоваться для входящего и исходящего трафика уровня 7, например HTTP или HTTPS:

![[4]][4]

В этой архитектуре виртуальные сетевые модули обрабатывают входящие запросы из шлюза приложений. Кроме того, они обрабатывают исходящие запросы из рабочей нагрузки виртуальных машин в пуле внутренней подсистемы балансировки нагрузки. Так как входящий трафик направляется шлюзом приложений, а исходящий — подсистемой балансировки нагрузки, NVA отвечают за обеспечение сходства сеансов. То есть шлюз приложения поддерживает сопоставление входящих и исходящих запросов. Благодаря этому он может перенаправлять правильный ответ запросившей стороне. Однако внутренняя подсистема балансировки нагрузки не имеет доступа к сопоставлениям шлюза приложения и использует собственную логику для отправки ответов на NVA. Подсистема балансировки нагрузки может отправить ответ на NVA, который изначально не получил запрос из шлюза приложения. В этом случае модули должны взаимодействовать и передавать ответ между собой, чтобы правильный модуль переслал ответ шлюзу приложений.

> [!NOTE]
> Вы также можете решить проблему асимметричной маршрутизации, настроив виртуальные системные модули таким образом, чтобы они выполняли преобразование адресов исходной сети (SNAT). При этом исходный IP-адрес источника запросившей стороны заменяется на один из IP-адресов входящего потока NVA. Теперь вы можете использовать несколько виртуальных системных модулей одновременно, сохраняя симметрию маршрута.

## <a name="pip-udr-switch-with-layer-4-nvas"></a>Переключение PIP и определяемого пользователем маршрута с NVA уровня 4

В следующем примере показана архитектура с активным и пассивным модулем, обрабатывающая входящий и исходящий трафик для уровня 4:

![[3]][3]

> [!TIP]
> Полное решение для этой архитектуры доступно на сайте [GitHub][pnp-ha-nva].

Эта архитектура подобна первой, описанной в этой статье. Она включает один NVA, принимающий и фильтрующий входящие запросы уровня 4. Кроме того, в ней добавлен второй пассивный виртуальный сетевой модуль для обеспечения высокой доступности. Если происходит сбой работы активного NVA, пассивный NVA стает активным и определяемый пользователем маршрут и PIP изменяются таким образом, чтобы указывать на сетевые адаптеры на активном NVA. Эти изменения определяемого пользователем маршрута и PIP могут выполняться вручную или автоматически. Автоматизированный процесс обычно является управляющей программой или другой службой мониторинга, работающей в Azure. Он запрашивает проверку работоспособности активного NVA и выполняет переключение определяемого пользователем маршрута и PIP при обнаружении сбоя в работе модуля.

На предыдущем рисунке показан пример кластера [ZooKeeper][zookeeper], предоставляющего высокодоступную управляющую программу. В пределах кластера ZooKeeper кворум узлов выбирает лидера. Если в работе лидера происходит сбой, новый выбирается среди оставшихся узлов. Узел-лидер выполняет роль управляющей программы, которая запрашивает проверку работоспособности конечной точки для NVA. Если при проверке работоспособности NVA не отвечает, управляющая программа активирует пассивный модуль. После этого она вызывает API REST Azure для удаления PIP из виртуального сетевого модуля, в котором произошел сбой, и привязывает его к новому активированному модулю. Затем она настраивает определяемый пользователем маршрут таким образом, чтобы он указывал на внутренний IP-адрес активированного модуля.

Не включайте узлы ZooKeeper в подсеть, доступ к которой можно получить только по маршруту, включающему NVA. В противном случае при сбое работы модуля узлы ZooKeeper будут недоступны. Если по какой-либо причине в работе управляющей программы возникнет сбой, у вас не будет доступа к узлам ZooKeeper для диагностики проблемы.

Чтобы ознакомиться с полным решением, включая примеры кода, просмотрите файлы в [репозитории GitHub][pnp-ha-nva].

## <a name="pip-udr-nvas-without-snat"></a>Виртуальные сетевые модули с PIP и определяемыми пользователем маршрутами без SNAT

Эта архитектура использует две виртуальные машины Azure, чтобы разместить брандмауэр NVA в активно-пассивной конфигурации, которая поддерживает автоматическую отработку отказа, но не требует преобразования исходных сетевых адресов (SNAT).

![Архитектура виртуальных сетевых модулей с PIP и определяемыми пользователем маршрутами без SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> Полное решение для этой архитектуры доступно на сайте [GitHub][ha-nva-fo].

Данное решение разработано для клиентов Azure, которые не могут настроить SNAT для входящих запросов на своих брандмауэрах NVA. SNAT скрывает исходный IP-адрес клиента-источника. Если нужно внести в журнал исходные IP-адреса или использовать их в других многоуровневых компонентах безопасности, размещенных за вашими NVA, это решение предлагает базовый подход.

Отработка отказа записей таблицы UDR выполняется автоматически с использованием адреса для следующего перехода, для которого задан IP-адрес интерфейса на активной виртуальной машине брандмауэра NVA. Логика автоматической отработки отказа размещена в приложении-функции, которое создается при помощи [Функций Azure](/azure/azure-functions/). Код отработки отказа выполняется как бессерверная функция внутри Функций Azure. Развертывание удобное, экономически эффективное, а также легкое в обслуживании и настройке. Кроме того, приложение-функция размещается в Функциях Azure, поэтому оно не имеет зависимостей в виртуальной сети. Если изменения виртуальной сети воздействуют на брандмауэры NVA, приложение-функция продолжает выполняться независимо. Тестирование также является более точным, так как оно происходит за пределами виртуальной сети и использует тот же маршрут, что и входящие клиентские запросы.

Чтобы проверить доступность брандмауэра NVA, код приложения-функции выполняет тестирование одним из двух способов:

- проводит мониторинг состояния виртуальных машин, на которых размещен брандмауэр NVA;

- тестирует наличие открытых портов от брандмауэра к тыловому веб-серверу. В этой конфигурации NVA должен предоставлять сокет через PIP, чтобы код приложения-функции мог выполнить тестирование.

Вы выбираете нужный тип пробы во время настройки приложения-функции. Чтобы ознакомиться с полным решением, включая примеры кода, просмотрите файлы в [репозитории GitHub][ha-nva-fo].

## <a name="next-steps"></a>Дополнительная информация

- Узнайте, как [внедрить сеть периметра между Azure и локальным центром данных][dmz-on-prem] с помощью NVA уровня 7.
- Узнайте, как [внедрить сеть периметра между Azure и Интернетом][dmz-internet] с помощью NVA уровня 7.
- [Устранение неполадок с сетевым виртуальным модулем в Azure](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Архитектура одного NVA"
[1]: ./images/nva-ha/l7-ingress.png "Входящий трафик уровня 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Исходящий трафик уровня 7"
[3]: ./images/nva-ha/active-passive.png "Кластер типа активный — пассивный"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
