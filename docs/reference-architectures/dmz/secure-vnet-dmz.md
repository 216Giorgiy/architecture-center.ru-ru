---
title: Реализация сети периметра между Azure и Интернетом
description: Способы реализации защищенной гибридной сетевой архитектуры с доступом к Интернету в Azure.
author: telmosampaio
ms.date: 07/02/2018
pnp.series.title: Network DMZ
pnp.series.next: nva-ha
pnp.series.prev: secure-vnet-hybrid
cardTitle: DMZ between Azure and the Internet
ms.openlocfilehash: 7a062d2394ae8b3bd1b17c19cbdf512327f9a766
ms.sourcegitcommit: 9b459f75254d97617e16eddd0d411d1f80b7fe90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2018
ms.locfileid: "37403153"
---
# <a name="dmz-between-azure-and-the-internet"></a>Сеть периметра между Azure и Интернетом

Эта эталонная архитектура представляет собой безопасную гибридную сеть, которая расширяет локальную сеть в Azure, а также принимает интернет-трафик. [**Разверните это решение**.](#deploy-the-solution)

[![0]][0] 

*Скачайте [файл Visio][visio-download] этой архитектуры.*

Эта эталонная архитектура расширяет архитектуру, описанную в [DMZ between Azure and your on-premises datacenter][implementing-a-secure-hybrid-network-architecture] (Сеть периметра между Azure и локальным центром данных). Она добавляет открытую сеть периметра, обрабатывающую интернет-трафик, в дополнение к частной сети периметра, которая обрабатывает трафик из локальной сети. 

Типичные способы использования этой архитектуры:

* Гибридные приложения, в которых рабочие нагрузки выполняются частично локально и частично в Azure.
* Инфраструктура Azure, которая направляет входящий трафик из локальной среды и Интернета.

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов:

* **Общедоступный IP-адрес (PIP).** IP-адрес общедоступной конечной точки. Внешние пользователи, подключенные к Интернету, могут получить доступ к системе через этот адрес.
* **Виртуальный сетевой модуль (NVA).** Эта архитектура включает в себя отдельный пул NVA для исходящего трафика в Интернете.
* **Azure Load Balancer.** Все входящие интернет-запросы проходят через подсистему балансировки нагрузки и распространяются в NVA в общедоступной сети периметра.
* **Подсеть входящего трафика общедоступной сети периметра.** Эта подсеть принимает запросы от подсистемы балансировки нагрузки Azure. Входящие запросы передаются одному из NVA в общедоступной сети периметра.
* **Подсеть исходящего трафика общедоступной сети периметра.** Запросы, утвержденные виртуальным сетевым модулем, проходят через подсеть внутренней подсистемы балансировки нагрузки для веб-уровня.

## <a name="recommendations"></a>Рекомендации

Следующие рекомендации применимы для большинства ситуаций. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая. 

### <a name="nva-recommendations"></a>Рекомендации по использованию виртуального сетевого модуля

Используйте разные наборы NVA для трафика в Интернете и трафика, создаваемого локальными системами. Использование только одного набора NVA в обоих случаях представляет угрозу безопасности, так как между двумя наборами сетевого трафика отсутствует периметр безопасности. Использование отдельных NVA упрощает проверку правил безопасности, а также позволяет понять, какие правила соответствуют определенным входящим сетевым запросам. Один набор NVA реализует правила для интернет-трафика, а другой — правила для локального трафика.

Включите NVA уровня 7, чтобы завершать соединения приложений на уровне NVA и обеспечить поддержку совместимости с серверными уровнями. Это гарантирует симметричное подключение, при котором ответный трафик из серверных уровней возвращается через NVA.  

### <a name="public-load-balancer-recommendations"></a>Рекомендации по использованию общедоступной подсистемы балансировки нагрузки

Для обеспечения масштабируемости и доступности развертывайте общедоступную сеть периметра NVA в [группе доступности][availability-set], а также распределяйте интернет-запросы по NVA в группе доступности с помощью [балансировщика нагрузки для Интернета][load-balancer].  

Настройте подсистему балансировки нагрузки для принятия запросов только на порты, необходимые для интернет-трафика. Например, ограничьте входящие HTTP-запросы на порт 80 и 443.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Даже если первоначально для архитектуры требуется один NVA в общедоступной сети периметра, мы рекомендуем сначала разместить подсистему балансировки нагрузки перед общедоступной сетью периметра. Это поможет упростить выполнение масштабирования для нескольких NVA в будущем.

## <a name="availability-considerations"></a>Вопросы доступности

Балансировщик нагрузки для Интернета требует, чтобы каждый NVA в подсети входящего трафика общедоступной сети периметра прошел [проверку работоспособности][lb-probe]. Проверка работоспособности, которая не отвечает на конечной точке, считается недоступной, из-за чего подсистема балансировки нагрузки будет направлять запросы к другим NVA в той же группе доступности. Обратите внимание, что если все NVA не отвечают, приложение не будет работать. Поэтому важно, чтобы были настроены уведомления на DevOps, когда число исправных экземпляров NVA падает ниже заданного порогового значения.

## <a name="manageability-considerations"></a>Вопросы управляемости

Все операции мониторинга и управления для NVA в общедоступной сети периметра должны выполняться в подсети управления с помощью jumpbox. Определите один сетевой маршрут из локальной сети через шлюз к jumpbox, чтобы ограничить доступ, как было сказано в статье [DMZ between Azure and your on-premises datacenter][implementing-a-secure-hybrid-network-architecture] (Сеть периметра между Azure и локальным центром данных).

При разрыве подключения шлюза из локальной сети в Azure можно по-прежнему подключиться к jumpbox путем развертывания общедоступного IP-адреса, добавив его в jumpbox и выполнив вход из Интернета.

## <a name="security-considerations"></a>Вопросы безопасности

Эта эталонная архитектура реализует несколько уровней безопасности:

* Балансировщик нагрузки для Интернета направляет запросы виртуальному сетевому модулю в подсеть входящего трафика общедоступной сети периметра и на порты, необходимые для приложения.
* Правила NSG для входящего и исходящего трафика подсетей общедоступной сети периметра предотвращают компрометацию NVA путем блокировки запросов, которые выходят за пределы правил NSG.
* Конфигурация маршрутизации NAT для NVA направляет входящие запросы к порту 80 и 443 в подсистему балансировки нагрузки веб-уровня. Однако запросы на остальных портах игнорируются.

Необходимо записывать входящие запросы на всех портах. Регулярно выполняйте аудит журналов, обращая внимание на запросы, которые выходят за пределы необходимых параметров, так как их появление может свидетельствовать о попытках вторжения.


## <a name="deploy-the-solution"></a>Развертывание решения

В репозитории [GitHub][github-folder] есть шаблон развертывания эталонной архитектуры, для которого реализованы эти рекомендации. 

### <a name="prerequisites"></a>предварительным требованиям

[!INCLUDE [ref-arch-prerequisites.md](../../../includes/ref-arch-prerequisites.md)]

### <a name="deploy-resources"></a>Развертывание ресурсов

1. Перейдите в папку `/dmz/secure-vnet-hybrid` в репозитории эталонных архитектур на сайте GitHub.

2. Выполните следующую команду:

    ```bash
    azbb -s <subscription_id> -g <resource_group_name> -l <region> -p onprem.json --deploy
    ```

3. Выполните следующую команду:

    ```bash
    azbb -s <subscription_id> -g <resource_group_name> -l <region> -p secure-vnet-hybrid.json --deploy
    ```

### <a name="connect-the-on-premises-and-azure-gateways"></a>Подключение локальных шлюзов и шлюзов Azure

На этом этапе вы подключите два шлюза локальной сети.

1. На портале Azure перейдите к созданной группе ресурсов. 

2. Найдите ресурс с именем `ra-vpn-vgw-pip` и скопируйте IP-адрес, который отображается в колонке **Обзор**.

3. Найдите ресурс с именем `onprem-vpn-lgw`.

4. Перейдите к колонке **Конфигурация**. В поле **IP-адрес** вставьте IP-адрес из шага 2.

    ![](./images/local-net-gw.png)

5. Нажмите кнопку **Сохранить** и дождитесь завершения операции. Это может занять около 5 минут.

6. Найдите ресурс с именем `onprem-vpn-gateway1-pip`. Скопируйте IP-адрес, который отображается в колонке **Обзор**.

7. Найдите ресурс с именем `ra-vpn-lgw`. 

8. Перейдите к колонке **Конфигурация**. В поле **IP-адрес** вставьте IP-адрес из шага 6.

9. Нажмите кнопку **Сохранить** и дождитесь завершения операции.

10. Чтобы проверить подключение, перейдите к колонке **Подключения** для каждого шлюза. Должно отображаться состояние **Подключено**.

### <a name="verify-that-network-traffic-reaches-the-web-tier"></a>Проверка того, поступает ли трафик на веб-уровень

1. На портале Azure перейдите к созданной группе ресурсов. 

2. Найдите ресурс с именем `pub-dmz-lb`. Это подсистема балансировки нагрузки, размещенная перед общедоступной промежуточной подсетью. 

3. Скопируйте общедоступный IP-адрес в колонке **Обзор** и откройте его в веб-браузере. Вы увидите домашнюю страницу сервера Apache2 по умолчанию.

4. Найдите ресурс с именем `int-dmz-lb`. Это подсистема балансировки нагрузки, размещенная перед частной промежуточной подсетью. Скопируйте частный IP-адрес в колонке **Обзор**.

5. Найдите виртуальную машину с именем `jb-vm1`. Нажмите кнопку **Подключиться** и используйте удаленный рабочий стол, чтобы подключиться к виртуальной машине. Имя пользователя и пароль указываются в файле onprem.json.

6. В сеансе удаленного рабочего стола откройте браузер и перейдите по IP-адресу из шага 4. Вы увидите домашнюю страницу сервера Apache2 по умолчанию.

[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/dmz/secure-vnet-dmz

[implementing-a-secure-hybrid-network-architecture]: ./secure-vnet-hybrid.md
[iptables]: https://help.ubuntu.com/community/IptablesHowTo
[lb-probe]: /azure/load-balancer/load-balancer-custom-probe-overview
[load-balancer]: /azure/load-balancer/load-balancer-Internet-overview
[network-security-group]: /azure/virtual-network/virtual-networks-nsg

[visio-download]: https://archcenter.blob.core.windows.net/cdn/dmz-reference-architectures.vsdx


[0]: ./images/dmz-public.png "Архитектура защищенной гибридной сети"
