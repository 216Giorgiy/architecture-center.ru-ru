---
title: Реализация архитектуры защищенной гибридной сети в Azure
description: Как реализовать архитектуру защищенной гибридной сети в Azure.
author: telmosampaio
ms.date: 10/22/2018
pnp.series.title: Network DMZ
pnp.series.prev: ./index
pnp.series.next: secure-vnet-dmz
cardTitle: DMZ between Azure and on-premises
ms.openlocfilehash: e13503c65430e46ef50898e471594a2ade3824b6
ms.sourcegitcommit: dbbf914757b03cdee7a274204f9579fa63d7eed2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/02/2018
ms.locfileid: "50916487"
---
# <a name="dmz-between-azure-and-your-on-premises-datacenter"></a>Промежуточная подсеть между Azure и локальным центром обработки данных

Эта эталонная архитектура представляет собой защищенную гибридную сеть, которая расширяет локальную сеть в Azure. В архитектуре реализована промежуточная подсеть (также называется *сетью периметра*) между локальной сетью и виртуальной сетью Azure. Промежуточная подсеть содержит виртуальные сетевые модули (NVA), в которых реализованы функции безопасности, например брандмауэры и проверка пакетов. Весь исходящий трафик из виртуальной сети принудительно туннелируется в Интернет через локальную сеть, чтобы можно было выполнить его аудит. [**Разверните это решение**.](#deploy-the-solution)

[![0]][0] 

*Скачайте [файл Visio][visio-download] этой архитектуры.*

Эта архитектура требует подключения к локальному ЦОД с помощью [VPN-шлюза][ra-vpn] или соединения [ExpressRoute][ra-expressroute]. Типичные способы использования этой архитектуры:

* Гибридные приложения, в которых рабочие нагрузки выполняются частично локально и частично в Azure.
* Инфраструктура, которая требует строгого контроля трафика, поступающего в виртуальную сеть Azure из локального центра обработки данных.
* Приложения, которые должны выполнять аудит исходящего трафика. Это распространенное нормативное требование в многих коммерческих системах. Такие приложения помогают предотвратить разглашение конфиденциальной информации.

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов:

* **Локальная сеть.** Частная локальная сеть, реализованная внутри организации.
* **Виртуальная сеть Azure.** В виртуальной сети размещаются приложение и другие ресурсы, работающие в Azure.
* **Шлюз.** Шлюз позволяет установить подключение между маршрутизаторами в локальной и виртуальной сетях.
* **Виртуальный сетевой модуль (NVA).** NVA — это общий термин, который означает виртуальную машину, выполняющую такие задачи, как разрешение или запрет доступа в качестве брандмауэра, оптимизация операций глобальной сети (WAN) (в том числе сжатие сети), настраиваемая маршрутизация или другие сетевые функции.
* **Подсети веб-уровня, уровня бизнес-логики и уровня данных.** Подсети, в которых размещены виртуальные машины и службы для реализации примера трехуровневого приложения в облаке. Дополнительные сведения см. в статье о [запуске виртуальных машин Windows для n-уровневой архитектуры в Azure][ra-n-tier].
* **Определяемые пользователем маршруты (UDR).** [Определяемые пользователем маршруты][udr-overview] используются для определения потока IP-трафика в виртуальных сетях Azure.

    > [!NOTE]
    > В зависимости от требований VPN-подключения вместо использования UDR можно настроить маршруты протокола пограничного шлюза (BGP). Это позволяет реализовать правила переадресации, при помощи которых трафик направляется обратно через локальную сеть.
    > 
    > 

* **Подсеть управления.** Эта подсеть содержит виртуальные машины для мониторинга компонентов, работающих в виртуальной сети, и управления ими.

## <a name="recommendations"></a>Рекомендации

Следующие рекомендации применимы для большинства ситуаций. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая. 

### <a name="access-control-recommendations"></a>Рекомендации по управлению доступом

Используйте [управление доступом на основе ролей][rbac] (RBAC), чтобы управлять ресурсами в приложении. Рекомендуем создать следующие [пользовательские роли][rbac-custom-roles]:

- Роль DevOps с разрешениями на администрирование инфраструктуры для приложения, развертывание компонентов приложения, а также мониторинг и перезапуск виртуальных машин.  

- Централизованная роль ИТ-администратора для мониторинга сетевых ресурсов и управления ими.

- Роль ИТ-администратора безопасности для управления ресурсами защищенной сети, например модулем NVA. 

Роли DevOps и ИТ-администратора не должны предоставлять доступ к ресурсам NVA. Он должен быть ограничен ролью ИТ-администратора безопасности.

### <a name="resource-group-recommendations"></a>Рекомендации по группам ресурсов

Управление ресурсами Azure, такими как виртуальные машины, виртуальные сети и подсистемы балансировки нагрузки, можно без труда осуществлять, объединив их в группы ресурсов Azure. Чтобы ограничить доступ, назначьте роли RBAC каждой группе ресурсов.

Рекомендуем создать следующие группы ресурсов:

* Группа ресурсов, которая содержит виртуальную сеть (за исключением виртуальных машин), группы безопасности сети и ресурсы шлюза для подключения к локальной сети. Назначьте централизованную роль ИТ-администратора этой группе ресурсов.
* Группа ресурсов, которая содержит виртуальные машины для модулей NVA (включая подсистему балансировки нагрузки), jumpbox и другие виртуальные машины управления, а также UDR для подсети шлюза, который позволяет направить весь трафик через NVA. Назначьте роль ИТ-администратора безопасности этой группе ресурсов.
* Отдельные группы ресурсов для каждого уровня приложения, которые содержат подсистемы балансировки нагрузки и виртуальные машины. Обратите внимание, что такая группа ресурсов не должна содержать подсети для каждого уровня. Назначьте роль DevOps этой группе ресурсов.

### <a name="virtual-network-gateway-recommendations"></a>Рекомендации по использованию шлюза виртуальной сети

Локальный трафик поступает в виртуальную сеть через шлюз виртуальной сети. Рекомендуем использовать [VPN-шлюз Azure][guidance-vpn-gateway] или [шлюз Azure ExpressRoute][guidance-expressroute].

### <a name="nva-recommendations"></a>Рекомендации по использованию виртуального сетевого модуля

Модули NVA предоставляют различные службы для мониторинга сетевого трафика и управления им. В [Azure Marketplace][azure-marketplace-nva] есть несколько модулей NVA сторонних поставщиков, которые можно использовать. Если ни один из таких модулей не соответствует вашим требованиям, вы можете создать пользовательский NVA с использованием виртуальных машин. 

Например, при развертывании решений для этой эталонной архитектуры NVA реализуется на виртуальной машине с помощью следующих функций:

* Трафик направляется в сетевые интерфейсы (NIC) для NVA с использованием [IP-переадресации][ip-forwarding].
* Трафик пропускается через NVA, только если он соответствует определенным требованиям. Каждая виртуальная машина NVA в эталонной архитектуре — это простой маршрутизатор Linux. Входящий трафик поступает в сетевой интерфейс *eth0*, а исходящий трафик, который соответствует правилам, определенным в пользовательских сценариях, подготавливается к отправке через сетевой интерфейс *eth1*.
* Модули NVA можно настроить только из подсети управления. 
* Трафик, направленный в подсеть управления, не проходит через модули NVA. Иначе при сбое NVA трафик не будет маршрутизироваться в подсеть управления для устранения неполадок.  
* Виртуальные машины NVA помещаются в [группу доступности][availability-set] за подсистемой балансировки нагрузки. UDR в подсети шлюза направляет запросы NVA в подсистему балансировки нагрузки.

Включите NVA уровня 7, чтобы завершать соединения приложений на уровне NVA и обеспечить поддержку соответствия серверным уровням. Это гарантирует симметричное подключение, при котором ответный трафик с серверных уровней возвращается через NVA.

Кроме того, можно последовательно подключить несколько NVA. При этом каждый модуль будет отвечать за определенную задачу безопасности. Это позволяет управлять каждой функцией обеспечения безопасности на основе отдельного модуля NVA. Например, NVA с брандмауэром можно последовательно разместить с NVA, в которых выполняются службы идентификации. Но упростив таким образом управление, можно добавить сетевые прыжки, что, в свою очередь, может привести к увеличению задержки. Поэтому убедитесь, что такой подход не влияет на производительность приложения.


### <a name="nsg-recommendations"></a>Рекомендации по использованию групп безопасности сети

VPN-шлюз предоставляет общедоступный IP-адрес для подключения к локальной сети. Рекомендуем создать группу безопасности сети (NSG) для входящей подсети NVA с правилами блокировки трафика, который поступает не из локальной сети.

Кроме того, желательно использовать NSG в каждой подсети, чтобы обеспечить второй уровень защиты от входящего трафика, который обходит неправильно настроенный или отключенный модуль NVA. Например, в подсети веб-уровня в эталонной архитектуре реализована группа NSG с правилом игнорирования всех запросов, кроме полученных из локальной (192.168.0.0/16) или виртуальной сети, и правило игнорирования всех запросов, которые поступают не через порт 80.

### <a name="internet-access-recommendations"></a>Рекомендации по доступу к Интернету

[Принудительно туннелируйте][azure-forced-tunneling] весь исходящий интернет-трафик через локальную сеть, используя туннель VPN "сеть — сеть", и направляйте его в Интернет при помощи преобразования сетевых адресов (NAT). Это позволяет предотвратить случайные утечки конфиденциальных данных, которые хранятся на уровне данных, и проводить проверку и аудит всего исходящего трафика.

> [!NOTE]
> Не блокируйте интернет-трафик с уровней приложений полностью. Это помешает использовать на этих уровнях службы Azure PaaS, в которых используются общедоступные IP-адреса (например, журнал ведения диагностики виртуальной машины, скачивание расширений виртуальной машины и т. д.). Для диагностики в Azure также требуется, чтобы компоненты имели разрешение на чтение и запись в учетной записи хранения Azure.
> 
> 

Убедитесь, что принудительное туннелирование исходящего интернет-трафика правильно реализовано. Если вы используете VPN-подключение к [службе маршрутизации и удаленного доступа][routing-and-remote-access-service] на локальном сервере, примените такое средство, как [WireShark][wireshark]или [Microsoft Message Analyzer](https://www.microsoft.com/download/details.aspx?id=44226).

### <a name="management-subnet-recommendations"></a>Рекомендации по использованию подсетей управления

В подсети управления есть сервер jumpbox, который осуществляет функции управления и мониторинга. Ограничьте выполнение всех задач управления безопасностью сервером jumpbox.
 
Не создавайте для него общедоступный IP-адрес. Вместо этого реализуйте один маршрут для доступа к jumpbox через входящий шлюз. Создайте такие правила NSG, чтобы подсеть управления отвечала только на запросы из разрешенных маршрутов.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

В эталонной архитектуре используется подсистема балансировки нагрузки для направления трафика из локальной сети в пул устройств NVA, которые маршрутизируют трафик. Модули NVA помещаются в [группу доступности][availability-set]. Такой подход позволяет отслеживать пропускную способность NVA в динамике и добавлять устройства NVA при увеличении нагрузки.

VPN-шлюз с номером SKU стандартной производительности поддерживает постоянную пропускную способность до 100 Мбит/с. Для шлюзов с номерами SKU высокой производительности этот показатель составляет200 Мбит/с. Для повышения пропускной способности рекомендуем выполнить обновление до шлюза ExpressRoute. ExpressRoute обеспечивает пропускную способность до 10 Гбит/с с меньшей задержкой, чем VPN-подключение.

Рекомендации по масштабируемости шлюзов Azure см. в статьях о реализации архитектуры гибридной сети при помощи [Azure и локальной VPN-сети][guidance-vpn-gateway-scalability] или [Azure ExpressRoute][guidance-expressroute-scalability].

## <a name="availability-considerations"></a>Вопросы доступности

Как уже упоминалось, в эталонной архитектуре используется пул устройств NVA за подсистемой балансировки нагрузки. В подсистеме балансировки нагрузки для мониторинга каждого модуля NVA применяется зонд работоспособности. Все неработоспособные устройства NVA удаляются из пула.

Если для связи между виртуальной и локальной сетями вы используете Azure ExpressRoute, [настройте VPN-шлюз, чтобы обеспечить отработку отказа][ra-vpn-failover], если подключение ExpressRoute станет недоступным.

Рекомендации по поддержке доступности подключений VPN и ExpressRoute см. в статьях о реализации архитектуры гибридной сети при помощи [Azure и локальной VPN-сети][guidance-vpn-gateway-availability] или [Azure ExpressRoute][guidance-expressroute-availability]. 

## <a name="manageability-considerations"></a>Вопросы управляемости

Все операции мониторинга для приложений и ресурсов должны выполняться на сервере jumpbox в подсети управления. В зависимости от требований приложения в подсети управления могут понадобиться дополнительные ресурсы мониторинга. В таком случае доступ к этим ресурсам должен осуществляться через jumpbox.

При разрыве подключения шлюза из локальной сети в Azure можно по-прежнему подключиться к jumpbox, развернув общедоступный IP-адрес, добавив его в jumpbox и установив удаленное подключение из Интернета.

В эталонной архитектуре подсеть каждого уровня защищена правилами NSG. Вам может потребоваться правило, которое позволяет открыть порт 3389 для доступа по протоколу удаленного рабочего стола (RDP) на виртуальных машинах Windows или порт 22 для доступа по протоколу Secure Shell (SSH) на виртуальных машинах Linux. Для других средств управления и мониторинга могут потребоваться правила, которые позволяют открыть дополнительные порты.

Если вы используете ExpressRoute для подключения локального ЦОД к Azure, примените [набор средств подключения Azure (AzureCT)][azurect] для мониторинга и устранения неполадок с подключением.

Дополнительные сведения о мониторинге и администрировании подключений VPN и ExpressRoute см. в статьях о реализации архитектуры гибридной сети при помощи [Azure и локальной VPN-сети][guidance-vpn-gateway-manageability] или [Azure ExpressRoute][guidance-expressroute-manageability].

## <a name="security-considerations"></a>Вопросы безопасности

В этой эталонной архитектуре реализовано несколько уровней безопасности.

### <a name="routing-all-on-premises-user-requests-through-the-nva"></a>Маршрутизация всех запросов пользователей локальной среды через модуль NVA
UDR в подсети шлюза блокирует все запросы пользователей, кроме полученных из локальной среды. UDR передает допустимые запросы в модули NVA в частной промежуточной подсети. Отсюда запросы поступают в приложение, если это разрешается правилами NVA. Можно добавить в UDR другие маршруты, но убедитесь, что они случайно не обходят модули NVA и не блокируют административный трафик, предназначенный для подсети управления.

Подсистема балансировки нагрузки перед модулями NVA также выступает в роли устройства безопасности. Она игнорирует трафик, поступающий через порты, которые еще не открыты в правилах подсистемы балансировки нагрузки. Подсистемы балансировки нагрузки в эталонной архитектуре прослушивают HTTP-запросы только в портах 80 и 443. Задокументируйте все дополнительные правила в подсистемах балансировки нагрузки и отслеживайте трафик на предмет проблем безопасности.

### <a name="using-nsgs-to-blockpass-traffic-between-application-tiers"></a>Использование групп NSG для блокировки или разрешения трафика между уровнями приложения
Трафик между уровнями ограничен использованием групп NSG. На уровне бизнес-логики блокируется весь трафик, который поступает не с веб-уровня, а на уровне данных блокируется весь трафик, который поступает не с уровня бизнес-логики. Если вы планируете расширить правила NSG, чтобы разрешить более свободный доступ к этим уровням, учитывайте риски безопасности. Каждый новый путь входящего трафика может привести к случайному или намеренному повреждению приложения либо утечке данных.

### <a name="devops-access"></a>Права доступа DevOps
Используйте [RBAC][rbac], чтобы ограничить операции для DevOps на каждом уровне. При предоставлении разрешений используйте [принцип минимальных привилегий][security-principle-of-least-privilege]. Ведите журнал всех административных операций и проводите регулярный аудит, чтобы следить за тем, все ли изменения конфигурации были запланированы.

## <a name="deploy-the-solution"></a>Развертывание решения

В репозитории [GitHub][github-folder] есть шаблон развертывания эталонной архитектуры, для которого реализованы эти рекомендации. 

### <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [ref-arch-prerequisites.md](../../../includes/ref-arch-prerequisites.md)]

### <a name="deploy-resources"></a>Развертывание ресурсов

1. Перейдите в папку `/dmz/secure-vnet-hybrid` в репозитории эталонных архитектур на сайте GitHub.

2. Выполните следующую команду:

    ```bash
    azbb -s <subscription_id> -g <resource_group_name> -l <region> -p onprem.json --deploy
    ```

3. Выполните следующую команду:

    ```bash
    azbb -s <subscription_id> -g <resource_group_name> -l <region> -p secure-vnet-hybrid.json --deploy
    ```

### <a name="connect-the-on-premises-and-azure-gateways"></a>Подключение локальных шлюзов и шлюзов Azure

На этом этапе вы подключите два шлюза локальной сети.

1. На портале Azure перейдите к созданной группе ресурсов. 

2. Найдите ресурс с именем `ra-vpn-vgw-pip` и скопируйте IP-адрес, который отображается в колонке **Обзор**.

3. Найдите ресурс с именем `onprem-vpn-lgw`.

4. Перейдите к колонке **Конфигурация**. В поле **IP-адрес** вставьте IP-адрес из шага 2.

    ![](./images/local-net-gw.png)

5. Нажмите кнопку **Сохранить** и дождитесь завершения операции. Это может занять около 5 минут.

6. Найдите ресурс с именем `onprem-vpn-gateway1-pip`. Скопируйте IP-адрес, который отображается в колонке **Обзор**.

7. Найдите ресурс с именем `ra-vpn-lgw`. 

8. Перейдите к колонке **Конфигурация**. В поле **IP-адрес** вставьте IP-адрес из шага 6.

9. Нажмите кнопку **Сохранить** и дождитесь завершения операции.

10. Чтобы проверить подключение, перейдите к колонке **Подключения** для каждого шлюза. Должно отображаться состояние **Подключено**.

### <a name="verify-that-network-traffic-reaches-the-web-tier"></a>Проверка того, поступает ли трафик на веб-уровень

1. На портале Azure перейдите к созданной группе ресурсов. 

2. Найдите ресурс с именем `int-dmz-lb`. Это подсистема балансировки нагрузки, размещенная перед частной промежуточной подсетью. Скопируйте частный IP-адрес в колонке **Обзор**.

3. Найдите виртуальную машину с именем `jb-vm1`. Нажмите кнопку **Подключиться** и используйте удаленный рабочий стол, чтобы подключиться к виртуальной машине. Имя пользователя и пароль указываются в файле onprem.json.

4. В сеансе удаленного рабочего стола откройте браузер и перейдите по IP-адресу из шага 2. Вы увидите домашнюю страницу сервера Apache2 по умолчанию.

## <a name="next-steps"></a>Дополнительная информация

* Узнайте, как реализовать [промежуточную сеть между Azure и Интернетом](secure-vnet-dmz.md).
* Узнайте, как реализовать [архитектуру высокодоступной гибридной сети][ra-vpn-failover].
* Дополнительные сведения об управлении безопасностью сети с помощью Azure см. в статье [Облачные службы Microsoft Cloud и сетевая безопасность][cloud-services-network-security].
* Подробные сведения о защите ресурсов в Azure см. в статье [Приступая к работе с безопасностью Microsoft Azure][getting-started-with-azure-security]. 
* Дополнительные рекомендации по обеспечению безопасности при подключении шлюзов Azure см. в статьях о реализации архитектуры гибридной сети при помощи [Azure и локальной VPN-сети][guidance-vpn-gateway-security] или [Azure ExpressRoute][guidance-expressroute-security].
* [Устранение неполадок с сетевым виртуальным модулем в Azure](/azure/virtual-network/virtual-network-troubleshoot-nva)
  > 

<!-- links -->

[availability-set]: /azure/virtual-machines/virtual-machines-windows-create-availability-set
[azurect]: https://github.com/Azure/NetworkMonitoring/tree/master/AzureCT
[azure-forced-tunneling]: https://azure.microsoft.com/en-gb/documentation/articles/vpn-gateway-forced-tunneling-rm/
[azure-marketplace-nva]: https://azuremarketplace.microsoft.com/marketplace/apps/category/networking
[cloud-services-network-security]: https://azure.microsoft.com/documentation/articles/best-practices-network-security/
[getting-started-with-azure-security]: /azure/security/azure-security-getting-started
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/dmz/secure-vnet-hybrid
[guidance-expressroute]: ../hybrid-networking/expressroute.md
[guidance-expressroute-availability]: ../hybrid-networking/expressroute.md#availability-considerations
[guidance-expressroute-manageability]: ../hybrid-networking/expressroute.md#manageability-considerations
[guidance-expressroute-security]: ../hybrid-networking/expressroute.md#security-considerations
[guidance-expressroute-scalability]: ../hybrid-networking/expressroute.md#scalability-considerations
[guidance-vpn-gateway]: ../hybrid-networking/vpn.md
[guidance-vpn-gateway-availability]: ../hybrid-networking/vpn.md#availability-considerations
[guidance-vpn-gateway-manageability]: ../hybrid-networking/vpn.md#manageability-considerations
[guidance-vpn-gateway-scalability]: ../hybrid-networking/vpn.md#scalability-considerations
[guidance-vpn-gateway-security]: ../hybrid-networking/vpn.md#security-considerations
[ip-forwarding]: /azure/virtual-network/virtual-networks-udr-overview#ip-forwarding
[ra-expressroute]: ../hybrid-networking/expressroute.md
[ra-n-tier]: ../virtual-machines-windows/n-tier.md
[ra-vpn]: ../hybrid-networking/vpn.md
[ra-vpn-failover]: ../hybrid-networking/expressroute-vpn-failover.md
[rbac]: /azure/active-directory/role-based-access-control-configure
[rbac-custom-roles]: /azure/active-directory/role-based-access-control-custom-roles
[routing-and-remote-access-service]: https://technet.microsoft.com/library/dd469790(v=ws.11).aspx
[security-principle-of-least-privilege]: https://msdn.microsoft.com/library/hdb58b2f(v=vs.110).aspx#Anchor_1
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview
[visio-download]: https://archcenter.blob.core.windows.net/cdn/dmz-reference-architectures.vsdx
[wireshark]: https://www.wireshark.org/
[0]: ./images/dmz-private.png "Архитектура защищенной гибридной сети"
