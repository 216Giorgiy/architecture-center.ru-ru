---
title: Конвейер CI/CD для рабочих нагрузок на основе контейнера
titleSuffix: Azure Example Scenarios
description: Создание конвейера DevOps для веб-приложения Node.js, который использует Jenkins, Реестр контейнеров Azure, Службу Azure Kubernetes, Cosmos DB и Grafana.
author: iainfoulds
ms.date: 07/05/2018
ms.openlocfilehash: 9d2681294b5c332e15259706518e4b02a488002f
ms.sourcegitcommit: bb7fcffbb41e2c26a26f8781df32825eb60df70c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2018
ms.locfileid: "53643770"
---
# <a name="cicd-pipeline-for-container-based-workloads"></a>Конвейер CI/CD для рабочих нагрузок на основе контейнера

Пример этого сценария применим к компаниям, которые хотят модернизировать разработку приложений, используя контейнеры и рабочие процессы DevOps. В этом сценарии веб-приложение Node.js создано и развернуто с помощью Jenkins в Реестре контейнеров Azure и Службе Azure Kubernetes. Azure Cosmos DB используется для уровня глобально распределенной базы данных. Для отслеживания и устранения неполадок с производительностью приложения, Azure Monitor интегрируется с экземпляром Grafana и панелью мониторинга.

Примеры сценариев приложений включают предоставление автоматизированной среды разработки, проверку новых фиксаций кода и отправку новых развертываний в промежуточную или производственную среду. Обычно компаниям приходилось вручную создавать и компилировать приложения и обновления, а также поддерживать большую монолитную базу кода. Благодаря современному подходу к разработке приложений, который использует непрерывную интеграцию (CI) и непрерывное развертывание (CD), вы можете быстрее создавать, тестировать и развертывать службы. Этот современный подход позволяет быстрее выпускать приложения и обновления для ваших клиентов и более гибко реагировать на меняющиеся требования компаний.

Используя такие службы Azure, как служба контейнеров Azure, реестр контейнеров Azure и Cosmos DB, компании могут использовать новейшие технологии разработки приложений и инструменты для упрощения процесса реализации высокого уровня доступности.

## <a name="relevant-use-cases"></a>Варианты соответствующего использования

Другие варианты использования:

- Модернизация разработки приложений с помощью микрослужб на основе контейнерного подхода.
- Ускорение разработки приложений и развертывание жизненных циклов.
- Автоматизация развертываний для тестирования или принятие среды для проверки.

## <a name="architecture"></a>Архитектура

![Общие сведения об архитектуре компонентов Azure, которые используются для сценария DevOps с применением Jenkins, Реестра контейнеров Azure и Службы Azure Kubernetes][architecture]

Этот сценарий охватывает конвейер DevOps для веб-приложения Node.js и серверную часть базы данных. Данные передаются в сценарии следующим образом:

1. Разработчик вносит изменения в исходный код веб-приложения Node.js.
2. Изменение кода фиксируется в репозитории управления исходным кодом, например, GitHub.
3. Чтобы начать процесс непрерывной интеграции (CI), веб-перехватчик GitHub активирует сборку проекта Jenkins.
4. Задача сборки Jenkins использует агента динамической сборки в службе контейнеров Azure для выполнения процесса сборки контейнера.
5. Образ контейнера создается из кода в системе управления версиями, а потом отправляется в реестр контейнеров Azure.
6. С помощью непрерывного развертывания (CD) Jenkins развертывает этот обновленный образ контейнера в кластер Kubernetes.
7. Веб-приложение Node.js использует Cosmos DB в качестве серверной части. И Cosmos DB, и служба контейнеров Azure посылают отчеты метрик в Azure Monitor.
8. Экземпляр Grafana предоставляет визуальные панели мониторинга производительности приложения на основе данных Azure Monitor.

### <a name="components"></a>Компоненты

- [Jenkins][jenkins] — это сервер автоматизации с открытым исходным кодом, который легко интегрируется со службами Azure для обеспечения непрерывной интеграции (CI) и непрерывного развертывания (CD). В этом сценарии Jenkins оркестрирует создание образов контейнеров на основе фиксаций для управления исходным кодом, отправляет эти образы в Реестр контейнеров Azure, а затем обновляет экземпляры приложений в Службе Azure Kubernetes.
- [Виртуальные машины Linux Azure][docs-virtual-machines] — это платформа IaaS для запуска экземпляров Jenkins и Grafana.
- [Реестр контейнеров Azure][docs-acr] хранит данные и управляет образами контейнеров, которые использует кластер службы контейнеров Azure. Изображения надежно сохранены и могут быть реплицированы платформой Azure в другие регионы для ускорения развертывания.
- [Служба контейнеров Azure][docs-aks] управляет платформой Kubernetes, которая позволяет быстро и легко развертывать контейнерные приложения и управлять ими, даже если вы никогда не оркестрировали контейнеры. Размещенная в Azure служба Kubernetes отвечает за критические задачи, в частности за мониторинг работоспособности и техническое обслуживание.
- [Azure Cosmos DB][docs-cosmos-db] — это глобально распределенная, многомодельная база данных, в которой можно выбрать различные модели баз данных и согласованности в соответствии с потребностями. С помощью базы данных Cosmos DB можно глобально реплицировать данные при отсутствии компонентов управления кластерами или репликации для развертывания и настройки.
- [Azure Monitor][docs-azure-monitor] помогает отслеживать производительность, обеспечивать безопасность и определять тенденции. Метрики, полученные с помощью Monitor, могут использоваться другими ресурсами и инструментами, например Grafana.
- [Grafana][grafana] — это решение с открытым исходным кодом для запросов, визуализации, оповещения и понимания метрики. Подключаемый модуль источника данных для Azure Monitor позволяет Grafana создавать визуальные панели мониторинга для наблюдения за производительностью приложений в службе контейнеров Azure и с помощью Cosmos DB.

### <a name="alternatives"></a>Альтернативные варианты

- [Azure Pipelines][azure-pipelines] помогают внедрять конвейер непрерывной интеграции (CI), тестирования и развертывания (CD) для любого приложения.
- Если необходимо больше контроля над кластером, [Kubernetes][kubernetes] можно запускать непосредственно на виртуальных машинах Azure, а не через управляемую службу.
- [Service Fabric][service-fabric] — другой альтернативный оркестратор контейнеров, который может заменить AKS.

## <a name="considerations"></a>Рекомендации

### <a name="availability"></a>Доступность

Этот сценарий сочетает в себе Azure Monitor и Grafana, чтобы контролировать производительность вашего приложения и сообщать о проблемах. Эти инструменты позволяют отслеживать и устранять проблемы с производительностью, которые могут потребовать обновления кода, которые можно затем развернуть в конвейер CI/CD.

Как часть кластера службы контейнеров Azure, подсистема балансировки нагрузки распределяет трафик приложения в один или несколько контейнеров (pods), которые запускают приложение. Такой подход к запуску контейнерных приложений в Kubernetes обеспечивает клиентам высокодоступную инфраструктуру.

Сведения о доступности см. в статье [Контрольный список для обеспечения доступности][availability] в Центре архитектуры Azure.

### <a name="scalability"></a>Масштабируемость

Служба контейнеров Azure позволяет масштабировать число узлов кластера в соответствии с требованиями приложений. По мере увеличения приложения можно развернуть количество узлов Kubernetes, которые запускают службу.

Данные приложения хранятся в базе данных Azure Cosmos DB — глобально распределенной, многомодельной базе данных, которая может глобально масштабироваться. Cosmos DB абстрагирует необходимость масштабирования инфраструктуры, как с обычными компонентами базы данных, и можно глобально реплицировать Cosmos DB для удовлетворения потребностей клиентов.

Сведения о масштабируемости см. в статье [Контрольный список для обеспечения масштабируемости][scalability] в Центре архитектуры Azure.

### <a name="security"></a>Безопасность

Чтобы минимизировать площадь атаки, эти сценарии не предоставляют экземпляр виртуальной машины Jenkins по HTTP. Для любых задач управления, требующих взаимодействия с Jenkins, необходимо создать безопасное удаленное соединение с использованием туннеля SSH на локальном компьютере. Для экземпляров виртуальных машин Jenkins и Grafana аутентификацию можно провести только с помощью открытого ключа SSH. Вход по паролю отключенный. Для получения дополнительных сведений см. [Запуск сервера Jenkins в Azure](../../reference-architectures/jenkins/index.md).

Этот сценарий использует специальный субъект-службу Azure Active Directory (AD) для разделения учетных данных и разрешений. Учетные данные этого субъекта-службы хранятся в Jenkins в качестве защищенного объекта учетных данных, так что они не отображаются напрямую и не видны внутри сценариев или конвейера сборки.

Общие рекомендации по разработке безопасных решений см. в разделе [Azure Security Documentation][security].

### <a name="resiliency"></a>Устойчивость

Этот сценарий использует Службу Azure Kubernetes для вашего приложения. В Kubernetes встроены компоненты отказоустойчивости, которые отслеживаются и, в случае проблемы, перезапускают контейнеры (pods). В сочетании с процедурой запуска нескольких узлов Kubernetes, приложение может допускать отключенный модуль или узел.

Общее руководство по проектированию устойчивых решений см. в разделе [Проектирование устойчивых приложений для Azure][resiliency].

## <a name="deploy-the-scenario"></a>Развертывание сценария

### <a name="prerequisites"></a>Предварительные требования

- Необходимо иметь учетную запись Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

- Вам потребуется открытая пара ключей SSH. Дополнительные сведения относительно пошагового создания открытой пары ключей см. в статье [Краткая инструкция: создание и использование пары из открытого и закрытого ключей SSH для виртуальных машин Linux в Azure][sshkeydocs].

- Для проверки подлинности службы и ресурсов требуется субъект-служба Azure Active Directory (AD). Если необходимо, создайте субъект-службу с помощью команды [az ad sp create-for-rbac][createsp]

    ```azurecli-interactive
    az ad sp create-for-rbac --name myDevOpsScenario
    ```

    Запишите значения параметров *appId* и *password* на выходе этой команды. При развертывании сценария необходимо ввести эти значения в шаблон.

### <a name="walk-through"></a>Пошаговое руководство

Чтобы развернуть сценарий с помощью шаблона Azure Resource Manager, выполните следующие действия.

<!-- markdownlint-disable MD033 -->

1. Нажмите кнопку **Развертывание в Azure**.<br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Fsolution-architectures%2Fmaster%2Fapps%2Fdevops-with-aks%2Fazuredeploy.json" target="_blank"><img src="https://azuredeploy.net/deploybutton.png"/></a>
2. Подождите, пока откроется развертывание шаблона на портале Azure, а затем выполните следующие шаги.
   - Выберите **Создать** группу ресурсов, а затем укажите в текстовом поле имя, например *myAKSDevOpsScenario*.
   - В раскрывающемся списке **Расположение** выберите регион.
   - Введите идентификатор приложения субъекта-службы и пароль из команды `az ad sp create-for-rbac`.
   - Укажите имя пользователя и надежный пароль для экземпляра Jenkins и консоли Grafana.
   - Укажите ключ SSH для защиты имен при входе в виртуальные машины Linux.
   - Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.
   - Нажмите кнопку **Приобрести**.

<!-- markdownlint-enable MD033 -->

Развертывание может занять 15-20 мин.

## <a name="pricing"></a>Цены

Чтобы изучить стоимость выполнения этого сценария, все услуги были предварительно сконфигурированы в калькуляторе стоимости. Чтобы узнать, как изменится цена для вашего конкретного варианта использования, измените соответствующие переменные в соответствии с ожидаемым трафиком.

Мы предоставили три примера профилей затрат, основанных на количестве образов контейнеров для хранения и узлов Kubernetes для запуска приложений.

- [Небольшой][small-pricing]. Этот пример тарификации предполагает наличие 1000 сборок контейнеров в месяц.
- [Средний][medium-pricing]. Этот пример тарификации предполагает наличие 100 000 сборок контейнеров в месяц.
- [Большой][large-pricing]. Этот пример тарификации предполагает наличие 1 000 000 сборок контейнеров в месяц.

## <a name="related-resources"></a>Связанные ресурсы

Этот сценарий использует Реестр контейнеров Azure и Службу Azure Kubernetes для хранения и запуска приложений на основе контейнеров. Экземпляры контейнеров Azure могут также использоваться для запуска приложений на основе контейнеров без необходимости создавать какие-либо компоненты оркестровки. Дополнительные сведения см. на странице [Экземпляры контейнеров Azure][docs-aci].

<!-- links -->
[architecture]: ./media/architecture-devops-with-aks.png
[autoscaling]: ../../best-practices/auto-scaling.md
[availability]: ../../checklist/availability.md
[docs-aci]: /azure/container-instances/container-instances-overview
[docs-acr]: /azure/container-registry/container-registry-intro
[docs-aks]: /azure/aks/intro-kubernetes
[docs-azure-monitor]: /azure/monitoring-and-diagnostics/monitoring-overview
[docs-cosmos-db]: /azure/cosmos-db/introduction
[docs-virtual-machines]: /azure/virtual-machines/linux/overview
[createsp]: /cli/azure/ad/sp#az-ad-sp-create
[grafana]: https://grafana.com/
[jenkins]: https://jenkins.io/
[resiliency]: ../../resiliency/index.md
[resource-groups]: /azure/azure-resource-manager/resource-group-overview
[security]: /azure/security/
[scalability]: ../../checklist/scalability.md
[sshkeydocs]: /azure/virtual-machines/linux/mac-create-ssh-keys
[azure-pipelines]: /azure/devops/pipelines
[kubernetes]: https://kubernetes.io/
[service-fabric]: /azure/service-fabric/

[small-pricing]: https://azure.com/e/841f0a75b1ea4802ba1ac8f7918a71e7
[medium-pricing]: https://azure.com/e/eea0e6d79b4e45618a96d33383ec77ba
[large-pricing]: https://azure.com/e/3faab662c54c473da55a1e93a27e0e64