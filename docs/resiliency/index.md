---
title: Проектирование устойчивых приложений для Azure
description: Сведения о том, как создать отказоустойчивые приложения в Azure для обеспечения высокой доступности и аварийного восстановления.
author: MikeWasson
ms.date: 07/29/2018
ms.custom: resiliency
ms.openlocfilehash: 73600650dc96fe85ad59e286079a3523ef25d055
ms.sourcegitcommit: 1b5411f07d74f0a0680b33c266227d24014ba4d1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2018
ms.locfileid: "52305967"
---
# <a name="designing-resilient-applications-for-azure"></a>Проектирование устойчивых приложений для Azure

В распределенной системе иногда происходят сбои. Может произойти сбой оборудования. В сети могут возникнуть временные сбои. В редких случаях вся служба или регион могут работать со сбоями, но даже такие случаи следует учесть. 

Создание надежного приложения в облаке отличается от создания надежного приложения в локальной среде компании. Хотя ранее вы, возможно, приобрели оборудование более высокого уровня для масштабирования, в облачной среде вы должны выполнять горизонтальное масштабирование, а не вертикальное. Затраты на облачные среды поддерживаются на низком уровне за счет использования стандартного оборудования. Вместо фокусировки на предотвращении сбоев и оптимизации "среднего времени между сбоями" в этой новой среде фокус смещается к "среднему времени восстановления". Цель состоит в том, чтобы минимизировать эффект сбоя.

В этой статье представлен обзор создания отказоустойчивых приложений в Microsoft Azure. Она начинается с определения термина *отказоустойчивость* и связанных с ним понятий. Далее описывается процесс достижения отказоустойчивости, используя структурированный подход в течение жизненного цикла приложения, от проектирования и реализации до развертывания и эксплуатации.

## <a name="what-is-resiliency"></a>Что такое отказоустойчивость?
**Устойчивость** представляет собой возможность восстановления системы после сбоев и продолжения работы. Устойчивость означает, что нужно не стараться *избежать* сбоев, а *реагировать* на них без простоя оборудования и потери данных. Назначение устойчивости состоит в том, чтобы вернуть приложение в рабочее состояние после сбоя.

Два важных аспекта отказоустойчивости — это высокая доступность и аварийное восстановление.

* **Высокий уровень доступности** — это способность приложения продолжать работу и находиться в работоспособном состоянии без значительного увеличения времени простоя. Под "работоспособным состоянием" мы понимаем то, что приложение в состоянии отвечать на запросы и пользователи могут подключиться к приложению и взаимодействовать с ним.  
* **Аварийное восстановление** — возможность восстановления после редких, но крупных инцидентов: не исчезающих самостоятельно широкомасштабных сбоев, таких как прерывание обслуживания, которое влияет на весь регион. Аварийное восстановление включает резервное копирование данных и архивацию и может включать ручное вмешательство, например восстановление базы данных из резервной копии.

Один из способов понять отличие высокой доступности от аварийного восстановления заключается в том, что последнее начинается, когда влияние ошибки превышает способность структуры высокой доступности ее обработать.  

При разработке отказоустойчивых приложений необходимо учитывать требования к доступности. Какое время простоя приемлемо? Это отчасти зависит от затрат. Во сколько возможный простой обойдется вашему бизнесу? Сколько вы должны инвестировать в высокую доступность приложения? Вам также необходимо определить, что означает доступность для приложения. Например, "простаивает" ли приложение, если клиент может разместить заказ, но система не может обработать его в течение обычного периода времени? Кроме того, рассмотрите вероятность возникновения определенного типа сбоев и то, является ли стратегия снижения рисков рентабельной.

Другим распространенным термином является **непрерывность бизнес-процессов**, которая является способностью выполнять важные бизнес-функции во время и после неблагоприятных условий, таких как стихийное бедствие или недоступность службы. Непрерывность бизнес-процессов охватывает всю деятельность бизнеса, включая физические объекты, людей, связь, транспорт и ИТ. В этой статье основное внимание уделяется облачным приложениям, но планирование отказоустойчивости должно выполняться в контексте общих требований непрерывности бизнес-процессов. 

**Резервное копирование данных** — важная часть процесса аварийного восстановления. При сбое компонентов приложения без отслеживания состояния их всегда можно развернуть повторно. Но в случае потери данных система не сможет вернуться в стабильное состояние. Следует создать резервную копию данных, в идеале — в другом регионе на случай аварии на уровне всего региона. 

Резервное копирование отличается от **репликации данных**. Репликация данных предполагает копирование данных практически в реальном времени, чтобы для системы можно было выполнить отработку отказа с переключением на реплику. Многие системы баз данных поддерживают репликацию. Например, SQL Server поддерживает группы доступности AlwaysOn SQL Server. Репликация данных может сократить время, необходимое для восстановления после сбоя, обеспечивая доступность таких данных. Но репликация данных не защищает от ошибок оператора. Если данные повреждены из-за ошибки оператора, в реплики будут скопированы поврежденные данные. Следовательно, вам по-прежнему необходимо включить в свою стратегию аварийного восстановления долгосрочное резервное копирование. 

## <a name="process-to-achieve-resiliency"></a>Процесс для обеспечения отказоустойчивости
Отказоустойчивость не является дополнительным компонентом. Ее следует спроектировать и реализовать в практической плоскости. Ниже приведена модель выполнения.

1. **Определите** требования к доступности, исходя из потребностей бизнеса.
2. **Разработайте** приложение для обеспечения отказоустойчивости. Начните с архитектуры, которая следует проверенным методам, а затем определите возможные точки сбоя в ней.
3. **Реализуйте** стратегии для обнаружения и восстановления после сбоев. 
4. **Протестируйте** реализацию путем имитации сбоев и активации принудительной отработки отказа. 
5. **Разверните** приложение в среде разработки, используя надежный, повторяемый процесс. 
6. **Отслеживайте** приложение для обнаружения сбоев. Контролируя систему, вы можете оценить работоспособность приложения и при необходимости отреагировать на инциденты. 
7. **Реагируйте** на сбои, требующие ручного вмешательства.

В оставшейся части этой статьи мы обсудим каждый из этих шагов более подробно.

## <a name="define-your-availability-requirements"></a>Определение требований к доступности
Планирование отказоустойчивости начинается с бизнес-требований. Ниже приведены несколько подходов к реализации отказоустойчивости в зависимости от требований.

### <a name="decompose-by-workload"></a>Распределение рабочей нагрузки
Многие облачные решения состоят из множества рабочих нагрузок приложений. Термин "рабочая нагрузка" в этом контексте означает дискретную возможность или вычислительную задачу, которая может быть логически отделена от других задач с точки зрения требований к бизнес-логике и хранению данных. Например, приложение для электронной коммерции может содержать следующие рабочие нагрузки:

* просмотр и поиск в каталоге продукции;
* создание и отслеживание заказов;
* просмотр рекомендаций.

Эти рабочие нагрузки могут иметь различные требования к доступности, масштабируемости, согласованности данных, аварийному восстановлению и т. д. Все это бизнес-решения.

Также рассмотрите варианты использования. Существуют ли определенные критические периоды, когда система должна быть доступной? Например, служба заполнения налоговых деклараций не должна стать недоступной прямо перед крайним сроком их подачи, служба потоковой передачи видео должна оставаться доступной во время большого спортивного мероприятия и так далее. В критические периоды у вас могут быть избыточные развертывания в нескольких регионах, чтобы приложение могло выполнить отработку отказа, если в одном регионе произошел сбой. Тем не менее, развертывание в нескольких регионах является более дорогостоящим, поэтому в менее критические моменты вы можете запустить приложение в одном регионе.

### <a name="rto-and-rpo"></a>RTO и RPO
Двумя важными метриками, которые следует рассмотреть, являются целевое время восстановления и целевая точка восстановления.

* **Целевое время восстановления** (RTO) — это максимально допустимое время, в течение которого приложение может быть недоступно после инцидента. Если ваше RTO составляет 90 минут, вы должны иметь возможность восстановить приложение в рабочем состоянии в течение 90 минут с момента начала сбоя. Если у вас очень низкое RTO, вы можете оставить второе развертывание, постоянно работающее в режиме ожидания, для защиты от регионального сбоя.

* **Целевая точка восстановления** (RPO) — это максимальная продолжительность потери данных, которая является приемлемой во время аварии. Например, если вы храните данные в одной базе данных без репликации в другие базы данных и ежечасно выполняете резервное копирование, вы можете потерять до часа данных. 

RTO и RPO являются бизнес-требованиями. Проведение оценки риска может помочь вам определить RTO и RPO для приложения. Другой распространенной метрикой является **среднее время восстановления**  (MTTR), которое является средним временем, которое требуется для восстановления приложения после сбоя. MTTR является эмпирическим фактом о системе. Если MTTR превышает RTO, то сбой в системе приведет к недопустимому сбою бизнес-процессов, поскольку восстановить систему в пределах определенного RTO невозможно. 

### <a name="slas"></a>Соглашения об уровне обслуживания
В [соглашении Azure об уровне обслуживания][sla] (SLA) приводится описание обязательств корпорации Майкрософт в отношении доступности и подключения. Если SLA для конкретной службы составляет 99,9 %, это означает, что вы должны ожидать, что служба будет доступна 99,9 % времени.

> [!NOTE]
> В SLA Azure также включены положения о получении кредита на службу, если SLA не выполняется, а также конкретные определения "доступности" для каждой службы. Этот аспект SLA действует как политика принудительного применения. 
> 
> 

Вы должны определить свои собственные целевые соглашения SLA для каждой рабочей нагрузки в своем решении. SLA позволяет оценить, соответствует ли архитектура бизнес-требованиям. Например, если для рабочей нагрузки требуется 99,99 % времени безотказной работы, но она зависит от службы с SLA на уровне 99,9 %, эта служба не может быть единой точкой отказа в системе. Одним из средств защиты является наличие резервного пути в случае сбоя службы или принятие других мер для восстановления после сбоя в этой службе. 

В следующей таблице показано потенциальное суммарное время простоя для различных уровней SLA. 

| Соглашение об уровне обслуживания | Время простоя в неделю | Время простоя в месяц | Время простоя в год |
| --- | --- | --- | --- |
| 99 % |1,68 часа |7,2 часа |3,65 дня |
| 99,9 % |10,1 минуты |43,2 мин |8,76 часа |
| 99,95 % |5 мин |21,6 мин |4,38 часа |
| 99,99 % |1,01 минуты |4,32 минуты |52,56 минуты |
| 99,999 % |6 секунд |25,9 секунды |5,26 минуты |

Конечно, более высокая доступность лучше при прочих равных условиях. Но по мере того, как вы стремитесь к большему показателю времени безотказной работы, стоимость и сложность достижения такого уровня доступности возрастают. Время безотказной работы на уровне 99,99 % составляет около 5 минут общего времени простоя в месяц. Стоит ли достижение уровня доступности 99,99999 % дополнительной сложности и затрат? Ответ зависит от бизнес-требований. 

Ниже приведены некоторые рекомендации по выбору SLA:

* Чтобы достичь уровня 99,99 %, вы, вероятно, не сможете полагаться на ручное вмешательство для восстановления после сбоев. Приложение должно иметь возможности самостоятельной диагностики и самовосстановления. 
* При более высоком уровне, чем 99,99 %, сложность состоит в обнаружении сбоев достаточно быстро, чтобы соответствовать SLA.
* Подумайте о временном окне, для которого измеряется SLA. Чем меньше окно, тем строже допуски. Вероятно, нет смысла определять SLA с точки зрения ежечасного или ежедневного времени непрерывной работы. 

### <a name="composite-slas"></a>Составные соглашения об уровне обслуживания
Рассмотрим веб-приложение службы приложений, которое выполняет запись в базу данных SQL Azure. На момент написания статьи эти службы Azure имеют следующие соглашения об уровне обслуживания:

* Веб-приложения службы приложений — 99,95 %.
* База данных SQL — 99,99 %.

![Составное соглашение об уровне обслуживания](./images/sla1.png)

Каково максимальное время простоя, ожидаемое для этого приложения? Если какая-либо из служб завершается ошибкой, приложение также прекращает работу. Как правило, вероятность сбоя каждой службы независима, поэтому составное SLA для этого приложения составляет 99,95 % &times; 99,99 % = 99,94 %. Это ниже, чем отдельные SLA, потому что приложение, которое основывается на нескольких службах, имеет больше потенциальных точек отказа. 

С другой стороны составное SLA можно усовершенствовать, создав независимые резервные пути. Например, если база данных SQL недоступна, поместите транзакции в очередь, которая будет обработана позже.

![Составное соглашение об уровне обслуживания](./images/sla2.png)

При такой структуре приложение по-прежнему доступно, даже если оно не может подключиться к базе данных. Тем не менее, оно завершится сбоем, если одновременно произойдет сбой базы данных и очереди. Ожидаемый процент времени для одновременного сбоя составляет 0,0001 &times; 0,001, поэтому составное SLA для этого комбинированного пути будет:  

* База данных или очередь = 1,0 &minus; (0,0001 &times; 0,001) = 99,99999 %

Общий уровень SLA:

* Веб-приложение и (очередь или база данных) = 99,95 % &times; 99,99999 % = ~99,95 %

Но есть и недостатки этого подхода. Логика приложения сложнее, вы платите за очередь, и могут возникнуть проблемы согласованности данных.

**SLA для развертываний в нескольких регионах**. Другой способ обеспечения высокой доступности заключается в развертывании приложения в нескольких регионах и использовании диспетчера трафика Azure для отработки отказа, если приложение не работает в одном регионе. Для развертывания в двух регионах составное SLA рассчитывается следующим образом. 

Например, *N* — составное SLA для приложения, развернутого в одном регионе. Ожидаемая вероятность того, что приложение будет работать в обоих регионах одновременно, будет (1 &minus; N) &times; (1 &minus; N). Таким образом:

* Комбинированное SLA для обоих регионов = 1 &minus; (1 &minus; N) (1 &minus; N) = N + (1 &minus; N) N.

Наконец, необходимо учитывать [SLA для диспетчера трафика][tm-sla]. На момент написания этой статьи SLA для SLA диспетчера трафика составляет 99,99 %.

* Составное SLA = 99,99 % &times; (комбинированное SLA для обоих регионов).

Кроме того, отработка отказа не происходит мгновенно и может привести к простоям во время перехода на другой ресурс. См. сведения в статье [Мониторинг конечных точек в диспетчере трафика][tm-failover].

Вычисленный номер SLA является полезным базовым показателем, но не достаточно репрезентативным в контексте доступности. Часто приложение может хуже работать постепенно, когда происходит сбой некритического пути. Рассмотрим приложение, которое отображает каталог книг. Если приложение не может получить уменьшенное изображение для обложки, оно может отображать изображение-заполнитель. В этом случае неспособность получить изображение не уменьшает время работы приложения, хотя оно влияет на работу пользователя.  

## <a name="design-for-resiliency"></a>Проектирование для обеспечения устойчивости

На этапе разработки следует провести анализ режимов сбоя (FMA). FMA предназначен для выявления потенциальных точек сбоя и определения того, как приложение реагирует на эти сбои.

* Как приложение обнаружит этот тип сбоя?
* Как приложение отреагирует на этот тип сбоя?
* Как регистрируется и отслеживается сбой данного типа? 

Дополнительные сведения о процессе FMA см. в статье [Анализ режима сбоя][fma].

### <a name="example-of-identifying-failure-modes-and-detection-strategy"></a>Пример определения режимов отказа и стратегии обнаружения
**Точка сбоя:** вызов внешней веб-службы или API.

| Режим сбоя | Стратегия обнаружения |
| --- | --- |
| Ресурс недоступен |HTTP 5xx |
| Регулирование |HTTP 429 (слишком много запросов) |
| Authentication |HTTP 401 (недостаточно прав) |
| Низкое время отклика |Истекло время ожидания для запроса |


### <a name="redundancy-and-designing-for-failure"></a>Избыточность и проектирование с учетом сбоев

Сбои могут иметь разную степень воздействия. Некоторые аппаратные сбои, например отказ диска, могут сказаться на работе одного хост-компьютера. Сбой сетевого коммутатора может повлиять на всю серверную стойку. Реже случаются сбои, нарушающие работу всего центра обработки данных, например отключения питания в центре обработки данных. В редких случаях весь регион может стать недоступным.

Один из основных способов обеспечить устойчивость приложения — настроить избыточность. Но вам нужно запланировать эту избыточность при разработке приложения. Кроме того, требуемый уровень избыточности зависит от бизнес-требований — не каждому приложению требуется избыточность по регионам для защиты от регионального сбоя. Как правило, используются компромиссные решения, обеспечивающие избыточность и надежность при сопоставимых затратах и уровне сложности.  

В Azure доступен ряд возможностей, которые обеспечивают избыточность приложения на каждом уровне сбоя — от отдельных виртуальных машин до целых регионов. 

![](./images/redundancy.svg)

**Отдельная виртуальная машина** В рамках соглашения об обслуживании Azure гарантирует определенное время доступности отдельной виртуальной машины. Вы можете использовать дополнительные возможности в рамках этого соглашения, запуская несколько виртуальных машин. Но отдельная виртуальная машина также может быть достаточно надежна для некоторых рабочих нагрузок. Для производственных рабочих нагрузок рекомендуем использовать две или более виртуальных машин, чтобы обеспечить избыточность. 

**Группы доступности**. Для защиты от локальных аппаратных сбоев, например сбоя диска или сетевого коммутатора, разверните две или более виртуальных машин в группе доступности. Группа доступности состоит из двух или более *доменов сбоя*, которые совместно используют общие источники питания и сетевые коммутаторы. Виртуальные машины в наборе доступности распределены между доменами сбоя. Поэтому если аппаратный сбой влияет на один домен сбоя, сетевой трафик по-прежнему будет перенаправлять виртуальные машины в другие домены сбоя. Дополнительные сведения о группах доступности см. в статье [Управление доступностью виртуальных машин Windows в Azure](/azure/virtual-machines/windows/manage-availability).

**Зоны доступности**  Зона доступности — это физически изолированная зона в регионе Azure. У каждой зоны доступности есть отдельный источник питания, сеть и система охлаждения. Развертывание виртуальных машин между зонами доступности помогает защитить приложения от сбоев в центре обработки данных.

**Azure Site Recovery**.  Реплицируйте виртуальные машины Azure в другой регион Azure для обеспечения непрерывности бизнес-процессов и аварийного восстановления. Вы можете проводить периодическое тестирование аварийного восстановления, чтобы обеспечить соответствие требованиям. Виртуальная машина будет реплицирована с указанными параметрами в выбранный регион, чтобы вы могли восстановить приложения в случае сбоев в исходном регионе. См. дополнительные сведения о [репликации виртуальных машин Azure с помощью Azure Site Recovery][site-recovery].

**Парные регионы** Чтобы защитить приложение от регионального сбоя, можно развернуть его между несколькими регионами с помощью диспетчера трафика Azure для распределения интернет-трафика по разным регионам. Каждый регион Azure сопряжен с другим регионом. Вместе они образуют [региональные пары](/azure/best-practices-availability-paired-regions). За исключением южной Бразилии, региональные пары находятся в одной и той же географической области. Так соблюдаются требования к размещению данных, связанные с налогообложением и применением законодательства в пределах юрисдикции.

При разработке приложения с поддержкой нескольких регионов следует учитывать, что задержка в сети для них превышает задержку в пределах одного региона. Например, если вы реплицируете базу данных для отработки отказа, используйте синхронную репликацию данных в пределах одного региона и асинхронную — в пределах нескольких.

| &nbsp; | Группа доступности | Зона доступности | Парный регион |
|--------|------------------|-------------------|---------------|
| Область сбоя | Стойка | Центр обработки данных | Регион |
| Маршрутизация запросов | Load Balancer | Распределение нагрузки между зонами | Диспетчер трафика |
| Задержки сети | Очень низкий | Низкий | От среднего до высокого |
| Виртуальная сеть  | Виртуальная сеть | Виртуальная сеть | Пиринговая связь между виртуальными сетями, размещенными в разных регионах |

## <a name="implement-resiliency-strategies"></a>Реализация стратегий обеспечения отказоустойчивости
В этом разделе представлен обзор некоторых общих стратегий обеспечения отказоустойчивости. Большинство из них не ограничены определенной технологией. Описания в этом разделе содержат общую идею каждой технологии и ссылки для дальнейшего чтения.

**Повтор в случае временного сбоя**. Временные сбои могут быть вызваны кратковременной потерей сетевого соединения, отсутствием подключения к базе данных или истечением времени ожидания, когда служба занята. Часто эту временную ошибку можно разрешить путем повторения запроса. Для многих служб Azure клиентский пакет SDK реализует автоматические повторы таким образом, который будет прозрачным для вызывающего объекта. Дополнительные сведения см. в статье [Конкретные рекомендации по использованию механизма повторов][retry-service-specific guidance].

Каждая попытка повторения увеличивает общую задержку. Кроме того, слишком много неудавшихся запросов могут вызвать узкое место, так как ожидающие запросы накапливаются в очереди. Эти заблокированные запросы могут содержать критические системные ресурсы, такие как память, потоки, подключения к базе данных и т. д., что может привести к каскадным сбоям. Чтобы избежать этого, увеличьте задержку между повторными попытками и ограничьте общее количество неудачных запросов. 

![](./images/retry.png)

**Балансировка нагрузки между несколькими экземплярами**. Для масштабируемости облачное приложение должно иметь возможность горизонтального масштабирования путем добавления экземпляров. Такой подход также повышает отказоустойчивость, так как неработоспособные экземпляры могут быть удалены из ротации. Например: 

* Поместите две или несколько виртуальных машин в подсистему балансировки нагрузки. Подсистема балансировки нагрузки распределяет трафик между всеми виртуальными машинами. Дополнительные сведения см. в статье [Run load-balanced VMs for scalability and availability][ra-multi-vm] (Запуск виртуальных машин с распределенной нагрузкой для масштабируемости и доступности).
* Выполните горизонтальное масштабирование приложения службы приложений Azure до нескольких экземпляров. Служба приложений автоматически распределяет нагрузку между экземплярами. См. статью [Basic web application][ra-basic-web] (Базовое веб-приложение).
* Используйте [диспетчер трафика Azure][tm] для распределения трафика между несколькими конечными точками.

**Репликация данных**. Репликация данных является общей стратегией для обработки постоянных ошибок в хранилище данных. Многие технологии хранения предоставляют встроенную репликацию, в том числе база данных SQL Azure, Cosmos DB и Apache Cassandra. Важно учитывать как пути чтения, так и пути записи. В зависимости от технологии хранения у вас может быть несколько записываемых реплик или одна копия, доступная для записи, и несколько копий только для чтения.

Чтобы добиться максимальной доступности, реплики можно разместить в разных регионах. Тем не менее это приводит к увеличению задержки при репликации данных. Как правило, репликация между регионами выполняется асинхронно, что подразумевает модель итоговой согласованности и возможную потерю данных в случае сбоя реплики.

Вы можете использовать службу [Azure Site Recovery][site-recovery] для репликации виртуальных машин Azure из одного региона в другой. Site Recovery непрерывно реплицирует данные в целевой регион. Если на вашем основном сайте произошел сбой, вы можете выполнить отработку отказа в дополнительное расположение.

**Корректно снижайте производительность**. Если служба терпит сбой и нет пути отработки отказа, приложение может корректно снижать производительность, сохраняя при этом приемлемое взаимодействие с пользователем. Например: 

* Рабочий элемент помещается в очередь для обработки позже. 
* Возвращается оцениваемое значение.
* Используются данные из локального кэша. 
* Пользователю отображается сообщение об ошибке. (Этот вариант лучше, чем если приложение перестает отвечать на запросы.)

**Регулирование пользователей, создающих большую нагрузку**. Иногда небольшое количество пользователей создает чрезмерную нагрузку. Это может повлиять на других пользователей, что снижает общую доступность вашего приложения.

Когда один клиент делает чрезмерное количество запросов, приложение может регулировать клиент в течение определенного периода времени. В период регулирования приложение отклоняет некоторые или все запросы от клиента (в зависимости от конкретной стратегии регулирования). Пороговое значение регулирования может зависеть от уровня обслуживания клиента. 

Регулирование не означает, что клиент действовал злонамеренно, а только то, что он превысил свою квоту службы. В некоторых случаях потребитель может последовательно превышать свою квоту. В противном случае его поведение ухудшается. В этом случае вы можете пойти дальше и заблокировать пользователя. Как правило, для этого блокируется API-ключ или диапазон IP-адресов. Дополнительные сведения см. в статье [Throttling Pattern][throttling-pattern] (Шаблон регулирования).

**Использование прерывателя**. С помощью шаблона [прерывателя][circuit-breaker-pattern] в приложении можно предотвратить повторное выполнение операции, которая, вероятнее всего, завершится ошибкой. Прерыватель завершает вызовы службы и отслеживает количество последних сбоев. Если число сбоев превышает пороговое значение, прерыватель начинает возвращать код ошибки, не вызывая службу. Это дает службе время на восстановление. 

**Использование выравнивания нагрузки для сглаживания пиков трафика**. Приложения могут испытывать внезапные всплески трафика, что может привести к чрезмерной нагрузке служб на стороне сервера. Если серверная служба не может достаточно быстро реагировать на запросы, это может привести к постановке запросов в очередь (архивация) или к регулированию приложения службой. Чтобы избежать этого, можно использовать очередь как буфер. Когда есть новый рабочий элемент, вместо того, чтобы немедленно вызывать серверную службу, приложение ставит в очередь рабочий элемент для асинхронного запуска. Очередь работает как буфер, который сглаживает высокие пики нагрузки. Дополнительные сведения см. в статье [Шаблон балансировки нагрузки на основе очередей][load-leveling-pattern].

**Изоляция критических ресурсов**. Сбои в одной подсистеме могут иногда иметь каскадный эффект, вызывая сбои в других частях приложения. Это может произойти, если отказ приводит к тому, что некоторые ресурсы, такие как потоки или сокеты, не освобождаются своевременно, что приводит к исчерпанию ресурсов. 

Чтобы избежать этого, вы можете разделить систему на изолированные группы, чтобы сбой в одном разделе не разрушал всю систему. Такой подход иногда называют шаблоном распределительного блока.

Примеры:

* Разделите базу данных (например, по клиентам) и назначьте отдельный пул экземпляров веб-сервера для каждого раздела.  
* Используйте отдельные пулы потоков для изоляции вызовов для разных служб. Это помогает предотвратить каскадные сбои, если одна из служб завершила работу с ошибкой. Пример см. в статье Netflix о [библиотеке Hystrix][hystrix].
* Используйте [контейнеры][containers] для ограничения ресурсов, доступных для конкретной подсистемы. 

![](./images/bulkhead.png)

**Применение компенсирующих транзакций**. [Компенсирующая транзакция][compensating-transaction-pattern] — это транзакция, которая отменяет эффект другой завершенной транзакции. В распределенной системе может быть сложно добиться сильной согласованности транзакций. Компенсирующие транзакции — это способ достижения согласованности, используя ряд небольших отдельных транзакций, которые можно отменить на каждом шаге.

Например, чтобы забронировать поездку, клиент может зарезервировать автомобиль, гостиничный номер и билет на самолет. В случае сбоя любого из этих шагов происходит сбой всей операции. Вместо того чтобы использовать одну распределенную транзакцию для всей операции, вы можете определить компенсирующую транзакцию для каждого шага. Например, чтобы отменить резервирование автомобиля, отмените резервирование. Чтобы завершить выполнение всей операции, координатор выполняет каждый шаг. Если какой-либо шаг завершается ошибкой, координатор применяет компенсирующие транзакции, чтобы отменить все действия, которые были выполнены. 

## <a name="test-for-resiliency"></a>Тестирование отказоустойчивости
Как правило, вы не можете тестировать отказоустойчивость так же, как вы тестируете функциональность приложения (путем запуска модульных тестов и т. д.). Вместо этого вы должны проверить, как сквозная рабочая нагрузка выполняется в условиях сбоя, которые происходят только периодически.

Тестирование — это итеративный процесс. Протестируйте приложение, измерьте результат, проанализируйте и устраните все возникающие сбои и повторите процесс.

**Тестирование путем внедрения ошибки**. Проверьте отказоустойчивость системы во время сбоев либо путем инициирования фактических сбоев, либо путем их имитации. Ниже приведены некоторые распространенные сценарии сбоев для тестирования.

* Завершите работу экземпляров виртуальной машины.
* Прекратите работу процессов.
* Завершите срок действия сертификатов.
* Измените ключи доступа.
* Завершите работу службы DNS на контроллерах домена.
* Ограничьте доступные системные ресурсы, такие как ОЗУ или количество потоков.
* Отключите диски.
* Повторно разверните виртуальную машину.

Измерьте время восстановления и убедитесь, что ваши бизнес-требования выполнены. Следует также протестировать комбинации режимов отказа. Убедитесь, что отказы не каскадируются и обрабатываются изолированно.

Это еще одна причина, по которой важно проанализировать возможные точки отказа на этапе разработки. Результаты этого анализа должны быть входными данными для плана тестирования.

**Нагрузочное тестирование**. Нагрузочное тестирование имеет решающее значение для обнаружения сбоев, которые происходят только под нагрузкой, таких как перегрузка серверной базы данных или регулирование службы. Протестируйте на максимальную нагрузку, используя рабочие данные или искусственные данные, максимально приближенные к рабочим данным. Цель — увидеть, как ведет себя приложение в реальных условиях.   

## <a name="deploy-using-reliable-processes"></a>Развертывание с помощью надежных процессов
После развертывания приложения в рабочей среде обновления выступают возможными источниками ошибок. В худшем случае неправильное обновление может привести к простою. Чтобы избежать этого, процесс развертывания должен быть предсказуемым и повторяемым. Развертывание включает в себя подготовку ресурсов Azure, развертывание кода приложения и применение параметров конфигурации. Обновление может включать все три этапа или подмножество. 

Ключевым моментом является то, что развертывания вручную подвержены ошибкам. Поэтому рекомендуется иметь автоматический, идемпотентный процесс, который вы можете выполнять по требованию и повторно запускать в случае сбоя. 

* Используйте шаблоны Azure Resource Manager для автоматизации подготовки ресурсов Azure.
* Используйте [настройку требуемого состояния службы автоматизации Azure][dsc] (DSC) для настройки виртуальных машин.
* Используйте автоматизированный процесс развертывания для кода приложения.

Две концепции, связанные с отказоустойчивым развертыванием, — это *инфраструктура как код* и *неизменяемая инфраструктура*.

* **Инфраструктура как код** — это способ использования кода для подготовки и настройки инфраструктуры. Инфраструктура как код может использовать декларативный или императивный подход (или их сочетание). Шаблоны Resource Manager являются примером декларативного подхода. Скрипты PowerShell являются примером императивного подхода.
* **Неизменяемая инфраструктура** — это принцип, согласно которому вы не должны изменять инфраструктуру после ее развертывания в рабочей среде. В противном случае в системе можно достичь состояния, когда были применены специальные изменения, поэтому трудно точно узнать, что изменилось, и сложно рассуждать о системе. 

Другой вопрос заключается в том, как развернуть обновление приложения. Мы рекомендуем такие методики, как "сине-зеленое" развертывание или ранние выпуски, которые отправляют обновления контролируемым образом, чтобы минимизировать возможные последствия некорректного развертывания.

* ["Сине-зеленое"развертывание][blue-green] — это способ развертывания обновления в рабочей среде отдельно от работающего приложения. После проверки развертывания переключите маршрутизацию трафика на обновленную версию. Например, веб-приложения службы приложения Azure позволяют сделать это с помощью промежуточных слотов.
* [Ранние выпуски][canary-release] аналогичны "сине-зеленым" развертываниям. Вместо того, чтобы переключать весь трафик на обновленную версию, вы развертываете обновление для небольшого процента пользователей, направляя часть трафика в новое развертывание. Если есть проблема, отмените обновления и вернитесь к старому развертыванию. В противном случае перенаправляйте большую часть трафика на новую версию, пока она не получит 100 % трафика.

Независимо от того, какой подход вы выберете, убедитесь, что можете вернуться к последнему известному корректному развертыванию на случай, если новая версия не работает. Кроме того, если возникают ошибки, журналы приложений должны указывать, какая версия вызвала ошибку. 

## <a name="monitor-to-detect-failures"></a>Мониторинг сбоев
Мониторинг и диагностика важны для обеспечения устойчивости. Если происходит какой-либо сбой, вам нужно об этом знать и понять его причину. 

Мониторинг крупномасштабной распределенной системы представляет собой нетривиальную задачу, Представим приложение, которое работает на нескольких десятках виртуальных машин. Невозможно войти в каждую виртуальную машину по одной за раз, и просмотреть файлы журналов, пытаясь устранить проблему. Кроме того, количество экземпляров виртуальных машин, скорее всего, не является статическим. Виртуальные машины добавляются и удаляются по мере того, как приложение масштабируется горизонтально и вертикально, и иногда может произойти сбой экземпляра, который необходимо повторно подготовить. Кроме того, типичное облачное приложение может использовать несколько хранилищ данных (хранилище Azure, база данных SQL, Cosmos DB, кэш Redis), а одно действие пользователя может охватывать несколько подсистем. 

Процесс наблюдения и диагностики можно считать конвейером с несколькими отдельными этапами:

![Составное соглашение об уровне обслуживания](./images/monitoring.png)

* **Инструментирование**. Необработанные данные для мониторинга и диагностики поступают из различных источников, включая журналы приложений, журналы веб-сервера, счетчики производительности ОС, журналы базы данных и диагностику, встроенную в платформу Azure. Большинство служб Azure имеют функцию диагностики, которую вы можете использовать для определения причины проблем.
* **Сбор и хранение**. Необработанные данные иснтрументирования могут храниться в разных местах и ​​в различных форматах (например, журналы трассировки приложений, журналы IIS, счетчики производительности). Эти разрозненные источники собираются, консолидируются и помещаются в надежное хранилище.
* **Анализ и диагностика**. После консолидирования данных они могут быть проанализированы для устранения неполадок и обеспечения общего представления работоспособности приложения.
* **Визуализация и оповещения**. На этом этапе данные телеметрии представлены таким образом, что оператор может быстро заметить проблемы или тенденции. Например, панели мониторинга или оповещения по электронной почте.  

Мониторинг — это не то же самое, что обнаружение сбоя. Например, приложение может обнаружить временную ошибку и повторить попытку, что позволит избежать простоя. Но оно также должно регистрировать операцию повтора, чтобы вы могли контролировать частоту ошибок и получать общую картину работоспособности приложения. 

Журналы приложений являются важным источником данных диагностики. Ниже приведены рекомендации по ведению журнала приложения.

* Войдите в рабочую среду. В противном случае у вас не будет важных данных аналитики.
* Регистрируйте события в границах служб. Включите идентификатор корреляции в границах служб. Если транзакции проходят через несколько служб и одна из них не работает, идентификатор корреляции поможет вам определить, почему транзакция завершилась сбоем.
* Используйте семантическое ведение журнала, также известное как структурированное ведение журнала. Неструктурированные журналы затрудняют автоматизацию потребления и анализа данных журнала, которые необходимы в масштабе облака.
* Используйте асинхронное ведение журнала. В противном случае сама система ведения журнала может привести к сбою приложения, вызвав резервное копирование запросов, поскольку они блокируются при ожидании записи события ведения журнала.
* Ведение журнала приложения — это не то же, что и аудит. Аудит может выполняться для соответствия требованиям или нормам. Таким образом, следует выполнять записи аудита, не прерывая запись при обработке транзакций. Если приложению требуется аудит, он должен выполняться отдельно от ведения журнала диагностики. 

Дополнительные сведения о мониторинге и диагностике см. в [этой статье][monitoring-guidance].

## <a name="respond-to-failures"></a>Реагирование на сбои
Предыдущие разделы посвящены автоматическим стратегиям восстановления, которые имеют решающее значение для обеспечения высокой доступности. Однако иногда требуется ручное вмешательство.

* **Оповещения.** Отслеживайте приложение на предмет предупреждающих знаков, которые могут потребовать активного вмешательства. Например, если вы видите, что база данных SQL или база данных Cosmos DB постоянно регулирует ваше приложение, вам может потребоваться увеличить емкость базы данных или оптимизировать ваши запросы. В этом примере, несмотря на то что приложение может обрабатывать ошибки регулирования прозрачно, ваша телеметрия должна все равно вызывать оповещение, чтобы вы могли предпринять ответные меры.  
* **Отработка отказа вручную**. Некоторые системы не могут автоматически выполнять отработку отказа и требуют выполнения перехода на другой ресурс вручную. 
* **Проверка готовности к работе**. Если ваше приложение выполняет отработку отказа в дополнительный регион, следует запустить тест готовности к работе, прежде чем вы восстановите размещение в основной регион. Тестирование должно проверить, что основной регион работоспособен и готов снова получать трафик.
* **Проверка согласованности данных**. Если сбой происходит в хранилище данных, может возникнуть несогласованность данных, когда хранилище снова станет доступным, особенно если данные были реплицированы. 
* **Восстановление из резервной копии**. Например, если в базе данных SQL происходит региональный сбой, вы можете выполнить геовосстановление базы данных из последней резервной копии.

Документируйте и протестируйте план аварийного восстановления. Оцените влияние сбоев приложения на бизнес. Максимально автоматизируйте процесс и документируйте любые шаги, выполняемые вручную, такие как переход на другой ресурс вручную или восстановление данных из резервных копий. Регулярно тестируйте процесс аварийного восстановления для проверки и улучшения плана. 

## <a name="summary"></a>Сводка
В этой статье комплексно рассматривается отказоустойчивость с учетом возможных сложностей облачной среды. К ним относятся распределенный характер облачных вычислений, использование стандартного оборудования и наличие временных сетевых сбоев.

Ниже приведены основные заключения.

* Отказоустойчивость приводит к более высокой доступности и более низкому среднему времени восстановления после сбоев. 
* Для достижения отказоустойчивости в облаке требуется набор методов, отличный от традиционных локальных решений. 
* Отказоустойчивость не достигается случайным образом. Она должна быть разработана и встроена изначально.
* Отказоустойчивость затрагивает каждую часть жизненного цикла приложения, от планирования и кодирования до операций.
* Выполняйте мониторинг и тестирование.


<!-- links -->

[blue-green]: https://martinfowler.com/bliki/BlueGreenDeployment.html
[canary-release]: https://martinfowler.com/bliki/CanaryRelease.html
[circuit-breaker-pattern]: https://msdn.microsoft.com/library/dn589784.aspx
[compensating-transaction-pattern]: https://msdn.microsoft.com/library/dn589804.aspx
[containers]: https://en.wikipedia.org/wiki/Operating-system-level_virtualization
[dsc]: /azure/automation/automation-dsc-overview
[contingency-planning-guide]: https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-34r1.pdf
[fma]: failure-mode-analysis.md
[hystrix]: https://medium.com/netflix-techblog/introducing-hystrix-for-resilience-engineering-13531c1ab362
[jmeter]: https://jmeter.apache.org/
[load-leveling-pattern]: ../patterns/queue-based-load-leveling.md
[monitoring-guidance]: ../best-practices/monitoring.md
[ra-basic-web]: ../reference-architectures/app-service-web-app/basic-web-app.md
[ra-multi-vm]: ../reference-architectures/virtual-machines-windows/multi-vm.md
[checklist]: ../checklist/resiliency.md
[retry-pattern]: ../patterns/retry.md
[retry-service-specific guidance]: ../best-practices/retry-service-specific.md
[sla]: https://azure.microsoft.com/support/legal/sla/
[throttling-pattern]: ../patterns/throttling.md
[tm]: https://azure.microsoft.com/services/traffic-manager/
[tm-failover]: /azure/traffic-manager/traffic-manager-monitoring
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[site-recovery]:/azure/site-recovery/azure-to-azure-quickstart/
