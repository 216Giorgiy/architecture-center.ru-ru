---
title: "Техническое руководство. Восстановление после локальных сбоев в Azure"
description: "Эта статья поможет вам понять и освоить процедуру создания надежных, высокодоступных, отказоустойчивых приложений, а также спланировать аварийное восстановление в случае локальных сбоев в Azure."
author: adamglick
ms.date: 08/18/2016
ms.openlocfilehash: 180eb465e5f82406bb03924a29d5b06d43bbaa24
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
[!INCLUDE [header](../_includes/header.md)]
# <a name="azure-resiliency-technical-guidance-recovery-from-local-failures-in-azure"></a><span data-ttu-id="436bf-103">Техническое руководство по обеспечению устойчивости в Azure. Восстановление после локальных сбоев в Azure</span><span class="sxs-lookup"><span data-stu-id="436bf-103">Azure resiliency technical guidance: Recovery from local failures in Azure</span></span>

<span data-ttu-id="436bf-104">На доступность приложения могут повлиять два основных фактора:</span><span class="sxs-lookup"><span data-stu-id="436bf-104">There are two primary threats to application availability:</span></span>

* <span data-ttu-id="436bf-105">сбой устройств, таких как диски и серверы;</span><span class="sxs-lookup"><span data-stu-id="436bf-105">The failure of devices, such as drives and servers</span></span>
* <span data-ttu-id="436bf-106">нехватка критически важных ресурсов, например вычислительных ресурсов при пиковой нагрузке.</span><span class="sxs-lookup"><span data-stu-id="436bf-106">The exhaustion of critical resources, such as compute under peak load conditions</span></span>

<span data-ttu-id="436bf-107">Azure позволяет сохранить высокий уровень доступности в этих условиях благодаря сочетанию управления ресурсами, обеспечения эластичности, балансировки нагрузки и секционирования.</span><span class="sxs-lookup"><span data-stu-id="436bf-107">Azure provides a combination of resource management, elasticity, load balancing, and partitioning to enable high availability under these circumstances.</span></span> <span data-ttu-id="436bf-108">Некоторые из этих функций выполняются автоматически для всех облачных служб.</span><span class="sxs-lookup"><span data-stu-id="436bf-108">Some of these features are performed automatically for all Azure services.</span></span> <span data-ttu-id="436bf-109">Но иногда разработчику приложения необходимо выполнить дополнительные действия, чтобы обеспечить применение этих функций.</span><span class="sxs-lookup"><span data-stu-id="436bf-109">However, in some cases, the application developer must do some additional work to benefit from them.</span></span>

## <a name="cloud-services"></a><span data-ttu-id="436bf-110">Облачные службы</span><span class="sxs-lookup"><span data-stu-id="436bf-110">Cloud Services</span></span>
<span data-ttu-id="436bf-111">Все облачные службы представляют собой коллекции экземпляров одной или нескольких веб- либо рабочих ролей.</span><span class="sxs-lookup"><span data-stu-id="436bf-111">Azure Cloud Services consists of collections of one or more web or worker roles.</span></span> <span data-ttu-id="436bf-112">Несколько экземпляров одной роли могут выполняться одновременно.</span><span class="sxs-lookup"><span data-stu-id="436bf-112">One or more instances of a role can run concurrently.</span></span> <span data-ttu-id="436bf-113">Количество экземпляров зависит от заданной конфигурации.</span><span class="sxs-lookup"><span data-stu-id="436bf-113">The configuration determines the number of instances.</span></span> <span data-ttu-id="436bf-114">Отслеживание экземпляров роли и управление ими осуществляется с помощью контроллера структуры.</span><span class="sxs-lookup"><span data-stu-id="436bf-114">Role instances are monitored and managed through a component called the fabric controller.</span></span> <span data-ttu-id="436bf-115">Этот компонент автоматически обнаруживает сбои программного обеспечения и оборудования и реагирует на них.</span><span class="sxs-lookup"><span data-stu-id="436bf-115">The fabric controller detects and responds to both software and hardware failures automatically.</span></span>

<span data-ttu-id="436bf-116">Каждый экземпляр роли выполняется в отдельной виртуальной машине и взаимодействует с контроллером структуры через гостевого агента.</span><span class="sxs-lookup"><span data-stu-id="436bf-116">Every role instance runs in its own virtual machine (VM) and communicates with its fabric controller through a guest agent.</span></span> <span data-ttu-id="436bf-117">Гостевой агент собирает метрики ресурсов и узлов, в том числе показатели использования виртуальных машин и ресурсов, данные журналов, а также сведения о состоянии, исключениях и сбоях.</span><span class="sxs-lookup"><span data-stu-id="436bf-117">The guest agent collects resource and node metrics, including VM usage, status, logs, resource usage, exceptions, and failure conditions.</span></span> <span data-ttu-id="436bf-118">Контроллер структуры отправляет запросы к гостевому агенту через интервалы, заданные в настройках, и перезапускает виртуальную машину, если гостевой агент не отвечает.</span><span class="sxs-lookup"><span data-stu-id="436bf-118">The fabric controller queries the guest agent at configurable intervals, and it restarts the VM if the guest agent fails to respond.</span></span> <span data-ttu-id="436bf-119">В случае сбоя оборудования связанный контроллер структуры перемещает все затронутые экземпляры роли на новый аппаратный узел и соответствующим образом изменяет параметры маршрутизации трафика в настройках сети.</span><span class="sxs-lookup"><span data-stu-id="436bf-119">In the event of hardware failure, the associated fabric controller moves all affected role instances to a new hardware node and reconfigures the network to route traffic there.</span></span>

<span data-ttu-id="436bf-120">Для использования этих возможностей разработчикам необходимо настроить все роли служб таким образом, чтобы они не сохраняли сведения о состоянии в экземплярах роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-120">To benefit from these features, developers should ensure that all service roles avoid storing state on the role instances.</span></span> <span data-ttu-id="436bf-121">Вместо этого все постоянные данные должны храниться в долговременном хранилище, например в службе хранилища Azure или Базе данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-121">Instead, all persistent data should be accessed from durable storage, such as Azure Storage or Azure SQL Database.</span></span> <span data-ttu-id="436bf-122">В этом случае запросы могут обрабатываться с помощью любых ролей.</span><span class="sxs-lookup"><span data-stu-id="436bf-122">This allows any roles to handle requests.</span></span> <span data-ttu-id="436bf-123">Кроме того, если экземпляры роли в любое время выйдут из строя, это не вызовет несоответствия между временным и постоянным состояниями службы.</span><span class="sxs-lookup"><span data-stu-id="436bf-123">It also means that role instances can go down at any time without creating inconsistencies in the transient or persistent state of the service.</span></span>

<span data-ttu-id="436bf-124">Необходимость хранить сведения о состоянии вне экземпляров роли сопровождается некоторыми требованиями.</span><span class="sxs-lookup"><span data-stu-id="436bf-124">The requirement to store state externally to the roles has several implications.</span></span> <span data-ttu-id="436bf-125">К примеру, все связанные изменения в таблице службы хранилища Azure по возможности должны осуществляться в одной транзакции группы сущностей.</span><span class="sxs-lookup"><span data-stu-id="436bf-125">It implies, for example, that all related changes to an Azure Storage table should be changed in a single entity-group transaction, if possible.</span></span> <span data-ttu-id="436bf-126">Конечно, внести все изменения в рамках одной транзакции возможно не всегда.</span><span class="sxs-lookup"><span data-stu-id="436bf-126">Of course, it isn't always possible to make all changes in a single transaction.</span></span> <span data-ttu-id="436bf-127">Необходимо также принять специальные меры, чтобы сбои экземпляров роли не вызывали проблем в случае прерывания длительных операций, охватывающих два и более обновлений постоянного состояния службы.</span><span class="sxs-lookup"><span data-stu-id="436bf-127">You must take special care to ensure that role instance failures do not cause problems when they interrupt long-running operations that span two or more updates to the persistent state of the service.</span></span> <span data-ttu-id="436bf-128">Другая роль, которая попытается повторить эту операцию, должна быть готова обрабатывать случаи, когда операция была частично завершена.</span><span class="sxs-lookup"><span data-stu-id="436bf-128">If another role attempts to retry such an operation, it should anticipate and handle the case where the work was partially completed.</span></span>

<span data-ttu-id="436bf-129">Например, если в службе, которая распределяет секции данных между несколькими хранилищами,</span><span class="sxs-lookup"><span data-stu-id="436bf-129">For example, consider a service that partitions data across multiple stores.</span></span> <span data-ttu-id="436bf-130">рабочая роль выйдет из строя при перемещении сегмента, эта операция может не завершиться</span><span class="sxs-lookup"><span data-stu-id="436bf-130">If a worker role goes down while it's relocating a shard, the relocation of the shard might not finish.</span></span> <span data-ttu-id="436bf-131">либо ее может заново начать другая рабочая роль, что может привести к потере или повреждению данных.</span><span class="sxs-lookup"><span data-stu-id="436bf-131">Or the relocation might be repeated from its inception by a different worker role, potentially causing orphaned data or data corruption.</span></span> <span data-ttu-id="436bf-132">Чтобы предотвратить возникновение таких проблем, длительные операции должны иметь следующие характеристики.</span><span class="sxs-lookup"><span data-stu-id="436bf-132">To prevent problems, long-running operations must be one or both of the following:</span></span>

* <span data-ttu-id="436bf-133">*Идемпотентность*. Повторяемые операции без побочных эффектов.</span><span class="sxs-lookup"><span data-stu-id="436bf-133">*Idempotent*: Repeatable without side effects.</span></span> <span data-ttu-id="436bf-134">Идемпотентная длительная операция должна действовать одинаково, независимо от того, сколько раз она выполняется, даже в случае прерывания во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="436bf-134">To be idempotent, a long-running operation should have the same effect no matter how many times it's executed, even when it's interrupted during execution.</span></span>
* <span data-ttu-id="436bf-135">*Добавочная возобновляемость*. Операции, способные продолжаться с момента сбоя.</span><span class="sxs-lookup"><span data-stu-id="436bf-135">*Incrementally restartable*: Able to continue from the most recent point of failure.</span></span> <span data-ttu-id="436bf-136">Добавочно возобновляемая длительная операция должна состоять из последовательности небольших атомарных операций.</span><span class="sxs-lookup"><span data-stu-id="436bf-136">To be incrementally restartable, a long-running operation should consist of a sequence of smaller atomic operations.</span></span> <span data-ttu-id="436bf-137">Кроме того, во время этой операции в долговременное хранилище должны записываться сведения о ходе ее выполнения, чтобы при каждом последующем вызове ее выполнение продолжалось с момента остановки.</span><span class="sxs-lookup"><span data-stu-id="436bf-137">It should also record its progress in durable storage, so that each subsequent invocation picks up where its predecessor stopped.</span></span>

<span data-ttu-id="436bf-138">И наконец, все длительные операции должны вызываться несколько раз, пока они не будут полностью завершены.</span><span class="sxs-lookup"><span data-stu-id="436bf-138">Finally, all long-running operations should be invoked repeatedly until they succeed.</span></span> <span data-ttu-id="436bf-139">Например, операция подготовки, помещенная в очередь Azure, будет удалена из нее экземпляром рабочей роли только после успешного завершения.</span><span class="sxs-lookup"><span data-stu-id="436bf-139">For example, a provisioning operation might be placed in an Azure queue, and then removed from the queue by a worker role only when it succeeds.</span></span> <span data-ttu-id="436bf-140">Для очистки данных, созданных в результате прерванных операций, может потребоваться сборка мусора.</span><span class="sxs-lookup"><span data-stu-id="436bf-140">Garbage collection might be necessary to clean up data that interrupted operations create.</span></span>

### <a name="elasticity"></a><span data-ttu-id="436bf-141">Эластичность</span><span class="sxs-lookup"><span data-stu-id="436bf-141">Elasticity</span></span>
<span data-ttu-id="436bf-142">Начальное количество выполняющихся экземпляров для каждой роли определено в конфигурации соответствующей роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-142">The initial number of instances running for each role is determined in each role’s configuration.</span></span> <span data-ttu-id="436bf-143">Администраторы должны изначально настроить для каждой роли выполнение двух или более экземпляров с учетом ожидаемой нагрузки.</span><span class="sxs-lookup"><span data-stu-id="436bf-143">Administrators should initially configure each role to run with two or more instances based on expected load.</span></span> <span data-ttu-id="436bf-144">Тем не менее число экземпляров роли можно с легкостью увеличить или уменьшить по мере изменения шаблонов использования.</span><span class="sxs-lookup"><span data-stu-id="436bf-144">But you can easily scale role instances up or down as usage patterns change.</span></span> <span data-ttu-id="436bf-145">Эту операцию можно выполнить вручную на портале Azure или автоматизировать с помощью Windows PowerShell, API управления службами или сторонних инструментов.</span><span class="sxs-lookup"><span data-stu-id="436bf-145">You can do this manually in the Azure portal, or you can automate the process by using Windows PowerShell, the Service Management API, or third-party tools.</span></span> <span data-ttu-id="436bf-146">Дополнительные сведения см. в статье [Автомасштабирование облачной службы](/azure/cloud-services/cloud-services-how-to-scale/).</span><span class="sxs-lookup"><span data-stu-id="436bf-146">For more information, see [How to autoscale an application](/azure/cloud-services/cloud-services-how-to-scale/).</span></span>

### <a name="partitioning"></a><span data-ttu-id="436bf-147">Секционирование</span><span class="sxs-lookup"><span data-stu-id="436bf-147">Partitioning</span></span>
<span data-ttu-id="436bf-148">Контроллер структуры Azure использует два компонента для секционирования:</span><span class="sxs-lookup"><span data-stu-id="436bf-148">The Azure fabric controller uses two types of partitions:</span></span>

* <span data-ttu-id="436bf-149">*Домен обновления* используется для обновления экземпляров роли службы в группах.</span><span class="sxs-lookup"><span data-stu-id="436bf-149">An *update domain* is used to upgrade a service’s role instances in groups.</span></span> <span data-ttu-id="436bf-150">Служба Azure развертывает экземпляры службы в нескольких доменах обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-150">Azure deploys service instances into multiple update domains.</span></span> <span data-ttu-id="436bf-151">При обновлении на месте контроллер структуры завершает работу всех экземпляров в одном домене обновления, обновляет их и перезапускает, а затем переходит к следующему домену обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-151">For an in-place update, the fabric controller brings down all the instances in one update domain, updates them, and then restarts them before moving to the next update domain.</span></span> <span data-ttu-id="436bf-152">Этот подход позволяет предотвратить недоступность всей службы во время процесса обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-152">This approach prevents the entire service from being unavailable during the update process.</span></span>
* <span data-ttu-id="436bf-153">*Домен сбоя* используется для изоляции компонентов оборудования или сети, которые являются потенциальными точками отказа.</span><span class="sxs-lookup"><span data-stu-id="436bf-153">A *fault domain* defines potential points of hardware or network failure.</span></span> <span data-ttu-id="436bf-154">Контроллер структуры распределяет экземпляры ролей с несколькими экземплярами между несколькими доменами сбоя, чтобы избежать прерывания работы службы из-за сбоев отдельного оборудования.</span><span class="sxs-lookup"><span data-stu-id="436bf-154">For any role that has more than one instance, the fabric controller ensures that the instances are distributed across multiple fault domains, to prevent isolated hardware failures from disrupting service.</span></span> <span data-ttu-id="436bf-155">С помощью доменов сбоя в Azure регулируются все риски, связанные со сбоями серверных и кластерных компонентов.</span><span class="sxs-lookup"><span data-stu-id="436bf-155">Fault domains govern all exposure to server and cluster failures.</span></span>

<span data-ttu-id="436bf-156">В соответствии с [соглашением об уровне обслуживания Azure](https://azure.microsoft.com/support/legal/sla/) корпорация Майкрософт гарантирует, что два или несколько экземпляров веб-роли, развернутых в разных доменах сбоя и обновления, будут иметь возможность внешнего подключения по крайней мере 99,95 % времени.</span><span class="sxs-lookup"><span data-stu-id="436bf-156">The [Azure service-level agreement (SLA)](https://azure.microsoft.com/support/legal/sla/) guarantees that when two or more web role instances are deployed to different fault and upgrade domains, they'll have external connectivity at least 99.95 percent of the time.</span></span> <span data-ttu-id="436bf-157">В отличие от доменов обновления количеством доменов сбоя управлять невозможно.</span><span class="sxs-lookup"><span data-stu-id="436bf-157">Unlike update domains, there's no way to control the number of fault domains.</span></span> <span data-ttu-id="436bf-158">Служба Azure автоматически выделяет домены сбоя и распределяет между ними экземпляры роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-158">Azure automatically allocates fault domains and distributes role instances across them.</span></span> <span data-ttu-id="436bf-159">По крайней мере два первых экземпляра каждой роли размещаются в разных доменах сбоя и обновления, чтобы гарантировать, что каждая роль с минимум двумя экземплярами будет удовлетворять условиям соглашения об уровне обслуживания.</span><span class="sxs-lookup"><span data-stu-id="436bf-159">At least the first two instances of every role are placed in different fault and upgrade domains to ensure that any role with at least two instances will satisfy the SLA.</span></span> <span data-ttu-id="436bf-160">Это показано на схеме ниже.</span><span class="sxs-lookup"><span data-stu-id="436bf-160">This is represented in the following diagram.</span></span>

![Упрощенное представление изоляции доменов сбоя](./images/technical-guidance-recovery-local-failures/partitioning-1.png)

### <a name="load-balancing"></a><span data-ttu-id="436bf-162">Балансировка нагрузки.</span><span class="sxs-lookup"><span data-stu-id="436bf-162">Load balancing</span></span>
<span data-ttu-id="436bf-163">Весь входящий трафик веб-роли проходит через балансировщик нагрузки без отслеживания состояния, который распределяет запросы клиентов между экземплярами роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-163">All inbound traffic to a web role passes through a stateless load balancer, which distributes client requests among the role instances.</span></span> <span data-ttu-id="436bf-164">У отдельных экземпляров роли нет общедоступных IP-адресов, и они недоступны напрямую через Интернет.</span><span class="sxs-lookup"><span data-stu-id="436bf-164">Individual role instances do not have public IP addresses, and they are not directly addressable from the Internet.</span></span> <span data-ttu-id="436bf-165">Веб-роли не отслеживают состояние, поэтому любой запрос клиента может быть направлен в любой экземпляр роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-165">Web roles are stateless so that any client request can be routed to any role instance.</span></span> <span data-ttu-id="436bf-166">Каждые 15 секунд возникает событие [StatusCheck](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.roleenvironment.statuscheck.aspx).</span><span class="sxs-lookup"><span data-stu-id="436bf-166">A [StatusCheck](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.roleenvironment.statuscheck.aspx) event is raised every 15 seconds.</span></span> <span data-ttu-id="436bf-167">Оно позволяет узнать, готова ли роль к приему трафика. Если роль занята, она перестанет использоваться в балансировщике нагрузки.</span><span class="sxs-lookup"><span data-stu-id="436bf-167">You can use this to indicate whether the role is ready to receive traffic, or whether it's busy and should be taken out of the load-balancer rotation.</span></span>

## <a name="virtual-machines"></a><span data-ttu-id="436bf-168">Виртуальные машины</span><span class="sxs-lookup"><span data-stu-id="436bf-168">Virtual Machines</span></span>
<span data-ttu-id="436bf-169">С точки зрения высокой доступности виртуальные машины Azure отличаются от вычислительных ролей модели "платформа как услуга" (PaaS) в нескольких аспектах.</span><span class="sxs-lookup"><span data-stu-id="436bf-169">Azure Virtual Machines differs from platform as a service (PaaS) compute roles in several respects in relation to high availability.</span></span> <span data-ttu-id="436bf-170">В некоторых случаях для обеспечения высокой доступности требуются дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="436bf-170">In some instances, you must do additional work to ensure high availability.</span></span>

### <a name="disk-durability"></a><span data-ttu-id="436bf-171">Устойчивость диска</span><span class="sxs-lookup"><span data-stu-id="436bf-171">Disk durability</span></span>
<span data-ttu-id="436bf-172">В отличие от экземпляров роли PaaS данные, хранящиеся на дисках виртуальной машины, остаются постоянными даже при перемещении виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="436bf-172">Unlike PaaS role instances, data stored on virtual machine drives is persistent even when the virtual machine is relocated.</span></span> <span data-ttu-id="436bf-173">Виртуальные машины Azure используют диски виртуальной машины, которые представлены в качестве больших двоичных объектов в службе хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-173">Azure virtual machines use VM disks that exist as blobs in Azure Storage.</span></span> <span data-ttu-id="436bf-174">Благодаря возможностям доступности службы хранилища Azure данные, хранящиеся на дисках виртуальной машины, также имеют высокий уровень доступности.</span><span class="sxs-lookup"><span data-stu-id="436bf-174">Because of the availability characteristics of Azure Storage, the data stored on a virtual machine’s drives is also highly available.</span></span>

<span data-ttu-id="436bf-175">Однако это не относится к диску D (в виртуальных машинах Windows).</span><span class="sxs-lookup"><span data-stu-id="436bf-175">Note that drive D (in Windows VMs) is the exception to this rule.</span></span> <span data-ttu-id="436bf-176">Диск D представляет собой физическое хранилище на стоечном сервере, где размещена виртуальная машина. При перезапуске этого диска хранящиеся на нем данные будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="436bf-176">Drive D is actually physical storage on the rack server that hosts the VM, and its data will be lost if the VM is recycled.</span></span> <span data-ttu-id="436bf-177">Таким образом, диск D предназначен только для временного хранения.</span><span class="sxs-lookup"><span data-stu-id="436bf-177">Drive D is intended for temporary storage only.</span></span> <span data-ttu-id="436bf-178">В Linux Azure обычно (но не всегда) предоставляет в качестве локального временного диска блочное устройство /dev/sdb.</span><span class="sxs-lookup"><span data-stu-id="436bf-178">In Linux, Azure “usually” (but not always) exposes the local temporary disk as /dev/sdb block device.</span></span> <span data-ttu-id="436bf-179">Зачастую он подключается агентом Linux для Azure. Точками подключения выступают /mnt/resource и /mnt (настраиваемые в файле конфигурации /etc/waagent.conf).</span><span class="sxs-lookup"><span data-stu-id="436bf-179">It is often mounted by the Azure Linux Agent as /mnt/resource or /mnt mount points (configurable via /etc/waagent.conf).</span></span>

### <a name="partitioning"></a><span data-ttu-id="436bf-180">Секционирование</span><span class="sxs-lookup"><span data-stu-id="436bf-180">Partitioning</span></span>
<span data-ttu-id="436bf-181">Служба Azure изначально распознает уровни приложения PaaS (веб-роль и рабочая роль) и, соответственно, может должным образом распределить их по доменам сбоя и обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-181">Azure natively understands the tiers in a PaaS application (web role and worker role) and thus can properly distribute them across fault and update domains.</span></span> <span data-ttu-id="436bf-182">Уровни в приложениях IaaS, напротив, следует определить вручную с помощью групп доступности.</span><span class="sxs-lookup"><span data-stu-id="436bf-182">In contrast, the tiers in an infrastructure as a service (IaaS) application must be manually defined through availability sets.</span></span> <span data-ttu-id="436bf-183">Группы доступности требуются в рамках соглашения об уровне обслуживания для систем IaaS.</span><span class="sxs-lookup"><span data-stu-id="436bf-183">Availability sets are required for an SLA under IaaS.</span></span>

![Группы доступности для виртуальных машин Azure](./images/technical-guidance-recovery-local-failures/partitioning-2.png)

<span data-ttu-id="436bf-185">На схеме выше уровень Internet Information Server (IIS), который выступает в качестве уровня веб-приложения, и уровень SQL, который выступает в качестве уровня данных, назначены разным группам доступности.</span><span class="sxs-lookup"><span data-stu-id="436bf-185">In the preceding diagram, the Internet Information Services (IIS) tier (which works as a web app tier) and the SQL tier (which works as a data tier) are assigned to different availability sets.</span></span> <span data-ttu-id="436bf-186">Это позволяет гарантировать аппаратную избыточность всех экземпляров каждого уровня за счет распределения виртуальных машин по доменам сбоя и поддержания уровней работы во время обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-186">This ensures that all instances of each tier have hardware redundancy by distributing virtual machines across fault domains, and that entire tiers are not taken down during an update.</span></span>

### <a name="load-balancing"></a><span data-ttu-id="436bf-187">Балансировка нагрузки.</span><span class="sxs-lookup"><span data-stu-id="436bf-187">Load balancing</span></span>
<span data-ttu-id="436bf-188">Если требуется распределять трафик между виртуальными машинами, необходимо сгруппировать их в приложении и распределить нагрузку в определенной конечной точке TCP или UDP.</span><span class="sxs-lookup"><span data-stu-id="436bf-188">If the VMs should have traffic distributed across them, you must group the VMs in an application and load balance across a specific TCP or UDP endpoint.</span></span> <span data-ttu-id="436bf-189">Дополнительные сведения см. в статье [Балансировка нагрузки для служб инфраструктуры Azure](/azure/virtual-machines/virtual-machines-linux-load-balance/?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="436bf-189">For more information, see [Load balancing virtual machines](/azure/virtual-machines/virtual-machines-linux-load-balance/?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <span data-ttu-id="436bf-190">Если виртуальные машины получают входящие данные из другого источника (например, механизма очередей), то балансировщик нагрузки не требуется.</span><span class="sxs-lookup"><span data-stu-id="436bf-190">If the VMs receive input from another source (for example, a queuing mechanism), a load balancer is not required.</span></span> <span data-ttu-id="436bf-191">Балансировщик нагрузки использует обычную проверку работоспособности, чтобы определить, следует ли отправлять трафик на узел.</span><span class="sxs-lookup"><span data-stu-id="436bf-191">The load balancer uses a basic health check to determine whether traffic should be sent to the node.</span></span> <span data-ttu-id="436bf-192">Можно также настроить собственные зонды, которые помогут определить, следует ли отправлять трафик в виртуальную машину, на основе метрик работоспособности приложения.</span><span class="sxs-lookup"><span data-stu-id="436bf-192">It's also possible to create your own probes to implement application-specific health metrics that determine whether the VM should receive traffic.</span></span>

## <a name="storage"></a><span data-ttu-id="436bf-193">Хранилище</span><span class="sxs-lookup"><span data-stu-id="436bf-193">Storage</span></span>
<span data-ttu-id="436bf-194">Служба хранилища Azure — это базовая служба долговременного хранения данных Azure,</span><span class="sxs-lookup"><span data-stu-id="436bf-194">Azure Storage is the baseline durable data service for Azure.</span></span> <span data-ttu-id="436bf-195">которая предоставляет хранилища BLOB-объектов, таблиц, очередей и дисков виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="436bf-195">It provides blob, table, queue, and VM disk storage.</span></span> <span data-ttu-id="436bf-196">Она обеспечивает высокую доступность в пределах одного центра обработки данных благодаря сочетанию репликации и управления ресурсами.</span><span class="sxs-lookup"><span data-stu-id="436bf-196">It uses a combination of replication and resource management to provide high availability within a single datacenter.</span></span> <span data-ttu-id="436bf-197">Соглашение об уровне обслуживания по доступности службы хранилища Azure гарантирует, что по крайней мере в 99,9 % случаев:</span><span class="sxs-lookup"><span data-stu-id="436bf-197">The Azure Storage availability SLA guarantees that at least 99.9 percent of the time:</span></span>

* <span data-ttu-id="436bf-198">правильно отформатированные запросы на добавление, обновление, чтение и удаление данных будут должным образом обработаны;</span><span class="sxs-lookup"><span data-stu-id="436bf-198">Correctly formatted requests to add, update, read, and delete data will be successfully and correctly processed.</span></span>
* <span data-ttu-id="436bf-199">учетные записи хранения будут иметь возможность подключения к шлюзу Интернета.</span><span class="sxs-lookup"><span data-stu-id="436bf-199">Storage accounts will have connectivity to the Internet gateway.</span></span>

### <a name="replication"></a><span data-ttu-id="436bf-200">Репликация</span><span class="sxs-lookup"><span data-stu-id="436bf-200">Replication</span></span>
<span data-ttu-id="436bf-201">Надежность данных в службе хранилища Azure обеспечивается за счет хранения нескольких копий всех данных на разных дисках, расположенных в полностью независимых физических подсистемах хранения в регионе.</span><span class="sxs-lookup"><span data-stu-id="436bf-201">Azure Storage facilitates data durability by maintaining multiple copies of all data on different drives across fully independent physical storage subsystems within the region.</span></span> <span data-ttu-id="436bf-202">Данные реплицируются синхронно, и перед подтверждением записи все копии фиксируются.</span><span class="sxs-lookup"><span data-stu-id="436bf-202">Data is replicated synchronously, and all copies are committed before the write is acknowledged.</span></span> <span data-ttu-id="436bf-203">Служба хранилища Azure строго согласованная. Это означает, что операции чтения гарантировано отражают последние записанные данные.</span><span class="sxs-lookup"><span data-stu-id="436bf-203">Azure Storage is strongly consistent, meaning that reads are guaranteed to reflect the most recent writes.</span></span> <span data-ttu-id="436bf-204">Кроме того, копии данных постоянно сканируются на наличие ухудшения производительности и нарушения целостности (чему часто не уделяют должного внимания). В случае обнаружения эти проблемы устраняются.</span><span class="sxs-lookup"><span data-stu-id="436bf-204">In addition, copies of data are continually scanned to detect and repair bit rot, an often overlooked threat to the integrity of stored data.</span></span>

<span data-ttu-id="436bf-205">Служба хранилища Azure обеспечивает репликацию служб.</span><span class="sxs-lookup"><span data-stu-id="436bf-205">Services benefit from replication just by using Azure Storage.</span></span> <span data-ttu-id="436bf-206">Разработчику службы не нужно предпринимать какие-либо дополнительные действия для восстановления после локального сбоя.</span><span class="sxs-lookup"><span data-stu-id="436bf-206">The service developer doesn't need to do additional work to recover from a local failure.</span></span>

### <a name="resource-management"></a><span data-ttu-id="436bf-207">Управление ресурсами</span><span class="sxs-lookup"><span data-stu-id="436bf-207">Resource management</span></span>
<span data-ttu-id="436bf-208">Учетные записи хранения, созданные после мая 2014 года, могут предоставлять до 500 ТБ емкости (предыдущее ограничение — 200 ТБ).</span><span class="sxs-lookup"><span data-stu-id="436bf-208">Storage accounts created after May 2014, can grow to up to 500 TB (the previous maximum was 200 TB).</span></span> <span data-ttu-id="436bf-209">Если этого пространства недостаточно, приложения необходимо спроектировать таким образом, чтобы они поддерживали использование нескольких учетных записей хранения.</span><span class="sxs-lookup"><span data-stu-id="436bf-209">If additional space is required, applications must be designed to use multiple storage accounts.</span></span>

### <a name="virtual-machine-disks"></a><span data-ttu-id="436bf-210">Диски виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="436bf-210">Virtual machine disks</span></span>
<span data-ttu-id="436bf-211">Диск виртуальной машины хранится в качестве страничного BLOB-объекта в службе хранилища Azure, благодаря чему он получает те же свойства надежности и масштабируемости, что и хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="436bf-211">A virtual machine’s disk is stored as a page blob in Azure Storage, giving it all the same durability and scalability properties as Blob storage.</span></span> <span data-ttu-id="436bf-212">Таким образом, данные на диске виртуальной машины не могут быть утеряны, даже если на сервере, где запущена виртуальная машина, происходит сбой и ее необходимо перезапустить на другом сервере.</span><span class="sxs-lookup"><span data-stu-id="436bf-212">This design makes the data on a virtual machine’s disk persistent, even if the server running the VM fails and the VM must be restarted on another server.</span></span>

## <a name="database"></a><span data-ttu-id="436bf-213">База данных</span><span class="sxs-lookup"><span data-stu-id="436bf-213">Database</span></span>
### <a name="sql-database"></a><span data-ttu-id="436bf-214">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="436bf-214">SQL Database</span></span>
<span data-ttu-id="436bf-215">База данных SQL Azure предоставляется как услуга.</span><span class="sxs-lookup"><span data-stu-id="436bf-215">Azure SQL Database provides database as a service.</span></span> <span data-ttu-id="436bf-216">Благодаря этому приложения могут быстро подготавливать реляционные базы данных, вставлять в них данные и отправлять к ним запросы.</span><span class="sxs-lookup"><span data-stu-id="436bf-216">It allows applications to quickly provision, insert data into, and query relational databases.</span></span> <span data-ttu-id="436bf-217">Эта база данных содержит много привычных возможностей и функций SQL Server, а все, что касается оборудования, конфигурации, исправлений и устойчивости, представлено в ней на абстрактном уровне.</span><span class="sxs-lookup"><span data-stu-id="436bf-217">It provides many of the familiar SQL Server features and functionality, while abstracting the burden of hardware, configuration, patching, and resiliency.</span></span>

> [!NOTE]
> <span data-ttu-id="436bf-218">База данных SQL Azure не предоставляет все точно такие же функции, как SQL Server.</span><span class="sxs-lookup"><span data-stu-id="436bf-218">Azure SQL Database does not provide one-to-one feature parity with SQL Server.</span></span> <span data-ttu-id="436bf-219">Она предназначена для выполнения других требований, соответствующих облачным приложениям (эластичное масштабирование, предоставление модели "база данных как услуга" для уменьшения расходов на обслуживание и т. д.).</span><span class="sxs-lookup"><span data-stu-id="436bf-219">It's intended to fulfill a different set of requirements--one that's uniquely suited to cloud applications (elastic scale, database as a service to reduce maintenance costs, and so on).</span></span> <span data-ttu-id="436bf-220">Дополнительные сведения см. в [этой статье](/azure/sql-database/sql-database-paas-vs-sql-server-iaas/).</span><span class="sxs-lookup"><span data-stu-id="436bf-220">For more information, see [Choose a cloud SQL Server option: Azure SQL (PaaS) Database or SQL Server on Azure VMs (IaaS)](/azure/sql-database/sql-database-paas-vs-sql-server-iaas/).</span></span>
> 
> 

#### <a name="replication"></a><span data-ttu-id="436bf-221">Репликация</span><span class="sxs-lookup"><span data-stu-id="436bf-221">Replication</span></span>
<span data-ttu-id="436bf-222">База данных SQL Azure обеспечивает высокий уровень устойчивости к сбоям на уровне узла.</span><span class="sxs-lookup"><span data-stu-id="436bf-222">Azure SQL Database provides built-in resiliency to node-level failure.</span></span> <span data-ttu-id="436bf-223">Все операции записи в базу данных автоматически реплицируются на два или более фоновых узла с помощью метода фиксации кворума.</span><span class="sxs-lookup"><span data-stu-id="436bf-223">All writes into a database are automatically replicated to two or more background nodes through a quorum commit technique.</span></span> <span data-ttu-id="436bf-224">При этом транзакция будет считаться завершенной и вернется, только если первичная реплика и по крайней мере одна вторичная реплика подтвердят, что действие записано в журнал транзакций. В случае сбоя узла база данных автоматически переносится на одну из вторичных реплик.</span><span class="sxs-lookup"><span data-stu-id="436bf-224">(The primary and at least one secondary must confirm that the activity is written to the transaction log before the transaction is deemed successful and returns.) In the case of node failure, the database automatically fails over to one of the secondary replicas.</span></span> <span data-ttu-id="436bf-225">При этом временное подключение для клиентских приложений прерывается.</span><span class="sxs-lookup"><span data-stu-id="436bf-225">This causes a transient connection interruption for client applications.</span></span> <span data-ttu-id="436bf-226">По этой причине все клиенты Базы данных SQL Azure должны выполнять определенный вид обработки временных подключений.</span><span class="sxs-lookup"><span data-stu-id="436bf-226">For this reason, all Azure SQL Database clients must implement some form of transient connection handling.</span></span> <span data-ttu-id="436bf-227">Дополнительные сведения см. в статье [Конкретные рекомендации по использованию механизма повторов](/azure/best-practices-retry-service-specific/).</span><span class="sxs-lookup"><span data-stu-id="436bf-227">For more information, see [Retry service specific guidance](/azure/best-practices-retry-service-specific/).</span></span>

#### <a name="resource-management"></a><span data-ttu-id="436bf-228">Управление ресурсами</span><span class="sxs-lookup"><span data-stu-id="436bf-228">Resource management</span></span>
<span data-ttu-id="436bf-229">Во время создания для каждой базы данных задается предельное значение размера.</span><span class="sxs-lookup"><span data-stu-id="436bf-229">Each database, when created, is configured with an upper size limit.</span></span> <span data-ttu-id="436bf-230">В настоящее время максимальный размер составляет 1 ТБ. Ограничения размера зависят от уровня службы. См. сведения об [уровнях служб и производительности баз данных SQL Azure](/azure/sql-database/sql-database-resource-limits/#service-tiers-and-performance-levels).</span><span class="sxs-lookup"><span data-stu-id="436bf-230">The currently available maximum size is 1 TB (size limits vary based on your service tier, see [service tiers and performance levels of Azure SQL Databases](/azure/sql-database/sql-database-resource-limits/#service-tiers-and-performance-levels).</span></span> <span data-ttu-id="436bf-231">Если база данных достигает максимального размера, последующие команды вставки и обновления отклоняются</span><span class="sxs-lookup"><span data-stu-id="436bf-231">When a database hits its upper size limit, it rejects additional INSERT or UPDATE commands.</span></span> <span data-ttu-id="436bf-232">(запрос и удаление данных по-прежнему возможны).</span><span class="sxs-lookup"><span data-stu-id="436bf-232">(Querying and deleting data is still possible.)</span></span>

<span data-ttu-id="436bf-233">Для управления ресурсами в Базе данных SQL Azure используется структура.</span><span class="sxs-lookup"><span data-stu-id="436bf-233">Within a database, Azure SQL Database uses a fabric to manage resources.</span></span> <span data-ttu-id="436bf-234">Однако вместо контроллера структуры для обнаружения сбоев применяется кольцевая топология.</span><span class="sxs-lookup"><span data-stu-id="436bf-234">However, instead of a fabric controller, it uses a ring topology to detect failures.</span></span> <span data-ttu-id="436bf-235">Каждая реплика в кластере имеет два соседних экземпляра и отвечает за обнаружение, когда они выходят из строя.</span><span class="sxs-lookup"><span data-stu-id="436bf-235">Every replica in a cluster has two neighbors and is responsible for detecting when they go down.</span></span> <span data-ttu-id="436bf-236">Если реплика выходит из строя, ее соседи активируют агент перенастройки, чтобы повторно создать эту реплику на другом компьютере.</span><span class="sxs-lookup"><span data-stu-id="436bf-236">When a replica goes down, its neighbors trigger a reconfiguration agent to re-create it on another machine.</span></span> <span data-ttu-id="436bf-237">Чтобы логический сервер не использовал слишком много ресурсов на виртуальной машине и не превышал физические ограничения, осуществляется регулирование ресурсов ядра.</span><span class="sxs-lookup"><span data-stu-id="436bf-237">Engine throttling is provided to ensure that a logical server doesn't use too many resources on a machine or exceed the machine’s physical limits.</span></span>

### <a name="elasticity"></a><span data-ttu-id="436bf-238">Эластичность</span><span class="sxs-lookup"><span data-stu-id="436bf-238">Elasticity</span></span>
<span data-ttu-id="436bf-239">Если приложению требуется более 1 ТБ емкости для базы данных, необходимо применить масштабирование.</span><span class="sxs-lookup"><span data-stu-id="436bf-239">If the application requires more than the 1 TB database limit, it must implement a scale-out approach.</span></span> <span data-ttu-id="436bf-240">Масштабирование при использовании Базы данных SQL Azure можно выполнить путем секционирования данных по нескольким базам данных SQL вручную (также известно как сегментирование).</span><span class="sxs-lookup"><span data-stu-id="436bf-240">You scale out with Azure SQL Database by manually partitioning, also known as sharding, data across multiple SQL databases.</span></span> <span data-ttu-id="436bf-241">Такой подход гарантирует практически линейный рост затрат в соответствии с масштабом.</span><span class="sxs-lookup"><span data-stu-id="436bf-241">This scale-out approach provides the opportunity to achieve nearly linear cost growth with scale.</span></span> <span data-ttu-id="436bf-242">Гибкий рост или предоставление емкости по запросу могут сопровождаться добавочными затратами, так как счета за базы данных выставляются на основе средней фактической используемой емкости за день, а не максимально возможного размера.</span><span class="sxs-lookup"><span data-stu-id="436bf-242">Elastic growth or capacity on demand can grow with incremental costs as needed because databases are billed based on the average actual size used per day, not based on maximum possible size.</span></span>

## <a name="sql-server-on-virtual-machines"></a><span data-ttu-id="436bf-243">SQL Server на виртуальных машинах</span><span class="sxs-lookup"><span data-stu-id="436bf-243">SQL Server on Virtual Machines</span></span>
<span data-ttu-id="436bf-244">Установив SQL Server (версии 2014 или более поздней) на виртуальных машинах Azure, вы получаете стандартные функции обеспечения доступности SQL Server,</span><span class="sxs-lookup"><span data-stu-id="436bf-244">By installing SQL Server (version 2014 or later) on Azure Virtual Machines, you can take advantage of the traditional availability features of SQL Server.</span></span> <span data-ttu-id="436bf-245">такие как группы доступности AlwaysOn и зеркальное отображение базы данных.</span><span class="sxs-lookup"><span data-stu-id="436bf-245">These features include AlwaysOn Availability Groups and database mirroring.</span></span> <span data-ttu-id="436bf-246">Обратите внимание, что виртуальные машины, хранилища и сети Azure имеют рабочие характеристики, отличные от характеристик локальной, невиртуализированной ИТ-инфраструктуры.</span><span class="sxs-lookup"><span data-stu-id="436bf-246">Note that Azure VMs, storage, and networking have different operational characteristics than an on-premises, non-virtualized IT infrastructure.</span></span> <span data-ttu-id="436bf-247">Чтобы успешно реализовать решение по обеспечению высокой доступности и аварийному восстановлению для SQL Server в Azure, вы должны понимать эти различия и учитывать их при разработке решения.</span><span class="sxs-lookup"><span data-stu-id="436bf-247">A successful implementation of a high availability/disaster recovery (HA/DR) SQL Server solution in Azure requires that you understand these differences and design your solution to accommodate them.</span></span>

### <a name="high-availability-nodes-in-an-availability-set"></a><span data-ttu-id="436bf-248">Узлы с высоким уровнем доступности в группе доступности</span><span class="sxs-lookup"><span data-stu-id="436bf-248">High-availability nodes in an availability set</span></span>
<span data-ttu-id="436bf-249">При реализации решения для обеспечения высокой доступности в Azure группа доступности позволяет помещать узлы с высоким уровнем доступности в отдельные домены сбоя и обновления.</span><span class="sxs-lookup"><span data-stu-id="436bf-249">When you implement a high-availability solution in Azure, you can use the availability set in Azure to place the high-availability nodes into separate fault domains and upgrade domains.</span></span> <span data-ttu-id="436bf-250">Следует уточнить, что группа доступности — это понятие Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-250">To be clear, the availability set is an Azure concept.</span></span> <span data-ttu-id="436bf-251">Это рекомендуемый подход, которому необходимо следовать, чтобы обеспечить высокую доступность баз данных при использовании групп доступности AlwaysOn, зеркального отображения базы данных или других методов.</span><span class="sxs-lookup"><span data-stu-id="436bf-251">It's a best practice that you should follow to make sure that your databases are indeed highly available, whether you're using AlwaysOn Availability Groups, database mirroring, or something else.</span></span> <span data-ttu-id="436bf-252">В противном случае вы можете думать, что в вашей системе обеспечена высокая доступность,</span><span class="sxs-lookup"><span data-stu-id="436bf-252">If you don't follow this best practice, you might be under the false assumption that your system is highly available.</span></span> <span data-ttu-id="436bf-253">но на самом деле все узлы могут одновременно выйти из строя, так как они размещены в одном домене сбоя в регионе Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-253">But in reality, your nodes can all fail simultaneously because they happen to be placed in the same fault domain in the Azure region.</span></span>

<span data-ttu-id="436bf-254">Этот подход неприменим при использовании доставки журналов,</span><span class="sxs-lookup"><span data-stu-id="436bf-254">This recommendation is not as applicable with log shipping.</span></span> <span data-ttu-id="436bf-255">так как это решение предназначено для обеспечения аварийного восстановления, и, следовательно, серверы должны находиться в разных регионах Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-255">As a disaster recovery feature, you should ensure that the servers are running in separate Azure regions.</span></span> <span data-ttu-id="436bf-256">По определению эти регионы представляют собой отдельные домены сбоя.</span><span class="sxs-lookup"><span data-stu-id="436bf-256">By definition, these regions are separate fault domains.</span></span>

<span data-ttu-id="436bf-257">Чтобы развертываемые на классическом портале виртуальные машины облачных служб Azure находились в одной группе доступности, их необходимо развернуть в одной облачной службе.</span><span class="sxs-lookup"><span data-stu-id="436bf-257">For Azure Cloud Services VMs deployed through the classic portal to be in the same availability set, you must deploy them in the same Cloud Service.</span></span> <span data-ttu-id="436bf-258">Что же касается виртуальных машин, развертываемых с помощью Azure Resource Manager (на текущем портале), такого ограничения нет.</span><span class="sxs-lookup"><span data-stu-id="436bf-258">VMs deployed through Azure Resource Manager (the current portal) do not have this limitation.</span></span> <span data-ttu-id="436bf-259">При развертывании виртуальных машин в облачной службе Azure через классический портал в одной группе доступности можно разместить только узлы одной облачной службы.</span><span class="sxs-lookup"><span data-stu-id="436bf-259">For classic portal deployed VMs in Azure Cloud Service, only nodes in the same Cloud Service can participate in the same availability set.</span></span> <span data-ttu-id="436bf-260">Кроме того, виртуальные машины облачных служб должны находиться в одной и той же виртуальной сети, чтобы их IP-адреса не менялись даже после восстановления службы.</span><span class="sxs-lookup"><span data-stu-id="436bf-260">In addition, the Cloud Services VMs should be in the same virtual network to ensure that they maintain their IPs even after service healing.</span></span> <span data-ttu-id="436bf-261">Это позволяет избежать сбоев при обновлении DNS.</span><span class="sxs-lookup"><span data-stu-id="436bf-261">This avoids DNS update disruptions.</span></span>

### <a name="azure-only-high-availability-solutions"></a><span data-ttu-id="436bf-262">Только в Azure: решения для обеспечения высокой доступности</span><span class="sxs-lookup"><span data-stu-id="436bf-262">Azure-only: High-availability solutions</span></span>
<span data-ttu-id="436bf-263">У вас может быть решение высокого уровня доступности для баз данных SQL Server в Azure, использующее группы доступности AlwaysOn или зеркальное отображение базы данных.</span><span class="sxs-lookup"><span data-stu-id="436bf-263">You can have a high-availability solution for your SQL Server databases in Azure by using AlwaysOn Availability Groups or database mirroring.</span></span>

<span data-ttu-id="436bf-264">На схеме ниже показана архитектура групп доступности AlwaysOn в виртуальных машинах Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-264">The following diagram demonstrates the architecture of AlwaysOn Availability Groups running on Azure Virtual Machines.</span></span> <span data-ttu-id="436bf-265">Эта схема взята из подробной статьи на эту тему: [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span><span class="sxs-lookup"><span data-stu-id="436bf-265">This diagram was taken from the in-depth article on this subject, [High availability and disaster recovery for SQL Server on Azure Virtual Machines](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span></span>

![Группы доступности AlwaysOn в Microsoft Azure](./images/technical-guidance-recovery-local-failures/high_availability_solutions-1.png)

<span data-ttu-id="436bf-267">С помощью шаблона AlwaysOn на портале Azure можно автоматически подготовить готовое развертывание групп доступности AlwaysOn в виртуальных машинах Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-267">You can also automatically provision an AlwaysOn Availability Groups deployment end-to-end on Azure VMs by using the AlwaysOn template in the Azure portal.</span></span> <span data-ttu-id="436bf-268">Дополнительные сведения см. в записи блога [SQL Server AlwaysOn Offering in Microsoft Azure Portal Gallery](https://blogs.technet.microsoft.com/dataplatforminsider/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery/) (Предложения AlwaysOn SQL Server в коллекции портала Microsoft Azure).</span><span class="sxs-lookup"><span data-stu-id="436bf-268">For more information, see [SQL Server AlwaysOn Offering in Microsoft Azure Portal Gallery](https://blogs.technet.microsoft.com/dataplatforminsider/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery/).</span></span>

<span data-ttu-id="436bf-269">На схеме ниже показано использование зеркального отображения базы данных в виртуальных машинах Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-269">The following diagram demonstrates the use of database mirroring on Azure Virtual Machines.</span></span> <span data-ttu-id="436bf-270">Эта схема взята из той же подробной статьи: [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span><span class="sxs-lookup"><span data-stu-id="436bf-270">It was also taken from the in-depth topic [High availability and disaster recovery for SQL Server on Azure Virtual Machines](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span></span>

![Зеркальное отображение базы данных в Microsoft Azure](./images/technical-guidance-recovery-local-failures/high_availability_solutions-2.png)

> [!NOTE]
> <span data-ttu-id="436bf-272">В обеих архитектурах требуется контроллер домена.</span><span class="sxs-lookup"><span data-stu-id="436bf-272">Both architectures require a domain controller.</span></span> <span data-ttu-id="436bf-273">Однако при применении зеркального отображения базы данных можно использовать сертификаты сервера, и тогда необходимость в контроллере домена отпадет.</span><span class="sxs-lookup"><span data-stu-id="436bf-273">However, with database mirroring, it's possible to use server certificates to eliminate the need for a domain controller.</span></span>
> 
> 

## <a name="other-azure-platform-services"></a><span data-ttu-id="436bf-274">Другие службы платформы Azure</span><span class="sxs-lookup"><span data-stu-id="436bf-274">Other Azure platform services</span></span>
<span data-ttu-id="436bf-275">Приложения, созданные на основе Azure, поддерживают возможности платформы для восстановления после локальных сбоев.</span><span class="sxs-lookup"><span data-stu-id="436bf-275">Applications that are built on Azure benefit from platform capabilities to recover from local failures.</span></span> <span data-ttu-id="436bf-276">В некоторых случаях можно предпринять определенные действия, чтобы повысить доступность для конкретного сценария.</span><span class="sxs-lookup"><span data-stu-id="436bf-276">In some cases, you can take specific actions to increase availability for your specific scenario.</span></span>

### <a name="service-bus"></a><span data-ttu-id="436bf-277">Service Bus</span><span class="sxs-lookup"><span data-stu-id="436bf-277">Service Bus</span></span>
<span data-ttu-id="436bf-278">Чтобы снизить риск временного сбоя служебной шины Azure, можно создать долгосрочную очередь на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="436bf-278">To mitigate against a temporary outage of Azure Service Bus, consider creating a durable client-side queue.</span></span> <span data-ttu-id="436bf-279">Это временный альтернативный метод, позволяющий локально хранить сообщения, которые не могут быть добавлены в очередь служебной шины.</span><span class="sxs-lookup"><span data-stu-id="436bf-279">This temporarily uses an alternate, local storage mechanism to store messages that cannot be added to the Service Bus queue.</span></span> <span data-ttu-id="436bf-280">Эти временно хранимые сообщения будут обработаны в приложении после восстановления работы службы.</span><span class="sxs-lookup"><span data-stu-id="436bf-280">The application can decide how to handle the temporarily stored messages after the service is restored.</span></span> <span data-ttu-id="436bf-281">Дополнительные сведения см. в статье [Рекомендации по повышению производительности с помощью обмена сообщениями через брокер в служебной шине](/azure/service-bus-messaging/service-bus-performance-improvements/) и в разделе о [служебной шине в рамках решения по аварийному восстановлению](recovery-loss-azure-region.md#other-azure-platform-services).</span><span class="sxs-lookup"><span data-stu-id="436bf-281">For more information, see [Best practices for performance improvements using Service Bus brokered messaging](/azure/service-bus-messaging/service-bus-performance-improvements/) and [Service Bus (disaster recovery)](recovery-loss-azure-region.md#other-azure-platform-services).</span></span>

### <a name="hdinsight"></a><span data-ttu-id="436bf-282">HDInsight</span><span class="sxs-lookup"><span data-stu-id="436bf-282">HDInsight</span></span>
<span data-ttu-id="436bf-283">Данные, связанные с Azure HDInsight, по умолчанию сохраняются в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-283">The data that's associated with Azure HDInsight is stored by default in Azure Blob storage.</span></span> <span data-ttu-id="436bf-284">Свойства высокой доступности и устойчивости для хранилища BLOB-объектов задаются в службе хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="436bf-284">Azure Storage specifies high-availability and durability properties for Blob storage.</span></span> <span data-ttu-id="436bf-285">Во временной распределенной файловой системе Hadoop (HDFS), которую при необходимости подготавливает служба HDInsight, выполняется многоузловая обработка в рамках заданий Hadoop MapReduce.</span><span class="sxs-lookup"><span data-stu-id="436bf-285">The multiple-node processing that's associated with Hadoop MapReduce jobs occurs on a transient Hadoop Distributed File System (HDFS) that is provisioned when HDInsight needs it.</span></span> <span data-ttu-id="436bf-286">Результаты задания MapReduce также по умолчанию сохраняются в хранилище BLOB-объектов Azure. Таким образом, обработанные данные устойчивы и имеют высокий уровень доступности после отзыва кластера Hadoop.</span><span class="sxs-lookup"><span data-stu-id="436bf-286">Results from a MapReduce job are also stored by default in Azure Blob storage, so that the processed data is durable and remains highly available after the Hadoop cluster is deprovisioned.</span></span> <span data-ttu-id="436bf-287">Дополнительные сведения см. в разделе об [HDInsight в рамках решения по аварийному восстановлению](recovery-loss-azure-region.md#other-azure-platform-services).</span><span class="sxs-lookup"><span data-stu-id="436bf-287">For more information, see [HDInsight (disaster recovery)](recovery-loss-azure-region.md#other-azure-platform-services).</span></span>

## <a name="checklists-for-local-failures"></a><span data-ttu-id="436bf-288">Контрольные списки для локальных сбоев</span><span class="sxs-lookup"><span data-stu-id="436bf-288">Checklists for local failures</span></span>
### <a name="cloud-services"></a><span data-ttu-id="436bf-289">Облачные службы</span><span class="sxs-lookup"><span data-stu-id="436bf-289">Cloud Services</span></span>
1. <span data-ttu-id="436bf-290">Просмотрите раздел "Облачные службы" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-290">Review the Cloud Services section of this document.</span></span>
2. <span data-ttu-id="436bf-291">Настройте по крайней мере два экземпляра для каждой роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-291">Configure at least two instances for each role.</span></span>
3. <span data-ttu-id="436bf-292">Сохраняйте сведения о состоянии в долговременном хранилище, а не в экземплярах роли.</span><span class="sxs-lookup"><span data-stu-id="436bf-292">Persist state in durable storage, not on role instances.</span></span>
4. <span data-ttu-id="436bf-293">Настройте правильную обработку события StatusCheck.</span><span class="sxs-lookup"><span data-stu-id="436bf-293">Correctly handle the StatusCheck event.</span></span>
5. <span data-ttu-id="436bf-294">По возможности объединяйте связанные изменения в транзакциях.</span><span class="sxs-lookup"><span data-stu-id="436bf-294">Wrap related changes in transactions when possible.</span></span>
6. <span data-ttu-id="436bf-295">Убедитесь, что задачи рабочей роли идемпотентные и перезапускаемые.</span><span class="sxs-lookup"><span data-stu-id="436bf-295">Verify that worker role tasks are idempotent and restartable.</span></span>
7. <span data-ttu-id="436bf-296">Настройте выполнение вызова неудачных операций до тех пор, пока они не будут завершены.</span><span class="sxs-lookup"><span data-stu-id="436bf-296">Continue to invoke operations until they succeed.</span></span>
8. <span data-ttu-id="436bf-297">Рассмотрите возможность применения стратегий автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="436bf-297">Consider autoscaling strategies.</span></span>

### <a name="virtual-machines"></a><span data-ttu-id="436bf-298">Виртуальные машины</span><span class="sxs-lookup"><span data-stu-id="436bf-298">Virtual Machines</span></span>
1. <span data-ttu-id="436bf-299">Просмотрите раздел "Виртуальные машины" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-299">Review the Virtual Machines section of this document.</span></span>
2. <span data-ttu-id="436bf-300">Не используйте диск D для постоянного хранения.</span><span class="sxs-lookup"><span data-stu-id="436bf-300">Do not use drive D for persistent storage.</span></span>
3. <span data-ttu-id="436bf-301">Объединяйте виртуальные машины на уровне службы в группу доступности.</span><span class="sxs-lookup"><span data-stu-id="436bf-301">Group machines in a service tier into an availability set.</span></span>
4. <span data-ttu-id="436bf-302">Настройте балансировку нагрузки и при необходимости зонды.</span><span class="sxs-lookup"><span data-stu-id="436bf-302">Configure load balancing and optional probes.</span></span>

### <a name="storage"></a><span data-ttu-id="436bf-303">Хранилище</span><span class="sxs-lookup"><span data-stu-id="436bf-303">Storage</span></span>
1. <span data-ttu-id="436bf-304">Просмотрите раздел "Хранилище" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-304">Review the Storage section of this document.</span></span>
2. <span data-ttu-id="436bf-305">Используйте несколько учетных записей хранения, если объем данных или пропускной способности превышает квоту.</span><span class="sxs-lookup"><span data-stu-id="436bf-305">Use multiple storage accounts when data or bandwidth exceeds quotas.</span></span>

### <a name="sql-database"></a><span data-ttu-id="436bf-306">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="436bf-306">SQL Database</span></span>
1. <span data-ttu-id="436bf-307">Просмотрите раздел "База данных SQL" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-307">Review the SQL Database section of this document.</span></span>
2. <span data-ttu-id="436bf-308">Реализуйте политику повтора для обработки временных ошибок.</span><span class="sxs-lookup"><span data-stu-id="436bf-308">Implement a retry policy to handle transient errors.</span></span>
3. <span data-ttu-id="436bf-309">Используйте секционирование или сегментирование в качестве стратегии масштабирования.</span><span class="sxs-lookup"><span data-stu-id="436bf-309">Use partitioning/sharding as a scale-out strategy.</span></span>

### <a name="sql-server-on-virtual-machines"></a><span data-ttu-id="436bf-310">SQL Server на виртуальных машинах</span><span class="sxs-lookup"><span data-stu-id="436bf-310">SQL Server on Virtual Machines</span></span>
1. <span data-ttu-id="436bf-311">Просмотрите раздел "SQL Server на виртуальных машинах" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-311">Review the SQL Server on Virtual Machines section of this document.</span></span>
2. <span data-ttu-id="436bf-312">Следуйте приведенным выше рекомендациям для виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="436bf-312">Follow the previous recommendations for Virtual Machines.</span></span>
3. <span data-ttu-id="436bf-313">Используйте функции для обеспечения высокой доступности SQL Server, например AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="436bf-313">Use SQL Server high availability features, such as AlwaysOn.</span></span>

### <a name="service-bus"></a><span data-ttu-id="436bf-314">Service Bus</span><span class="sxs-lookup"><span data-stu-id="436bf-314">Service Bus</span></span>
1. <span data-ttu-id="436bf-315">Просмотрите раздел "Служебная шина" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-315">Review the Service Bus section of this document.</span></span>
2. <span data-ttu-id="436bf-316">Рассмотрите возможность создания долгосрочной очереди на стороне клиента для хранения избыточных сообщений.</span><span class="sxs-lookup"><span data-stu-id="436bf-316">Consider creating a durable client-side queue as a backup.</span></span>

### <a name="hdinsight"></a><span data-ttu-id="436bf-317">HDInsight</span><span class="sxs-lookup"><span data-stu-id="436bf-317">HDInsight</span></span>
1. <span data-ttu-id="436bf-318">Просмотрите раздел "HDInsight" этого документа.</span><span class="sxs-lookup"><span data-stu-id="436bf-318">Review the HDInsight section of this document.</span></span>
2. <span data-ttu-id="436bf-319">Дополнительные действия, касающиеся обеспечения высокой доступности, в случае локальных сбоев для этого компонента отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="436bf-319">No additional availability steps are required for local failures.</span></span>

