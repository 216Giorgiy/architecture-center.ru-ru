---
title: Анализ режима сбоя
description: Эта статья содержит сведения о выполнении анализа режима сбоя для облачных решений на платформе Azure.
author: MikeWasson
ms.date: 05/07/2018
ms.custom: resiliency
ms.openlocfilehash: e74a98ed1d57c3bd0b3b518ff4fae743dd12f02b
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54113218"
---
# <a name="failure-mode-analysis"></a><span data-ttu-id="1ceb7-103">Анализ режима сбоя</span><span class="sxs-lookup"><span data-stu-id="1ceb7-103">Failure mode analysis</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="1ceb7-104">Анализ режимов сбоя (FMA) — это процесс реализации устойчивости в системе за счет определения возможных точек сбоя в системе.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-104">Failure mode analysis (FMA) is a process for building resiliency into a system, by identifying possible failure points in the system.</span></span> <span data-ttu-id="1ceb7-105">FMA должна быть частью архитектуры и выполняться на этапе разработки, чтобы вы могли включить функцию восстановления после сбоев в систему с самого начала.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-105">The FMA should be part of the architecture and design phases, so that you can build failure recovery into the system from the beginning.</span></span>

<span data-ttu-id="1ceb7-106">Ниже описана общая процедура для выполнения FMA:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-106">Here is the general process to conduct an FMA:</span></span>

1. <span data-ttu-id="1ceb7-107">Определите все компоненты в системе.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-107">Identify all of the components in the system.</span></span> <span data-ttu-id="1ceb7-108">Включите внешние зависимости, например поставщики удостоверений, сторонние службы и т. д.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-108">Include external dependencies, such as as identity providers, third-party services, and so on.</span></span>
2. <span data-ttu-id="1ceb7-109">Для каждого компонента определите потенциальные сбои, которые могут произойти.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-109">For each component, identify potential failures that could occur.</span></span> <span data-ttu-id="1ceb7-110">Один компонент может иметь несколько режимов сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-110">A single component may have more than one failure mode.</span></span> <span data-ttu-id="1ceb7-111">Например, следует рассматривать ошибки чтения и записи отдельно, так как их влияние и способы решения будут отличаться.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-111">For example, you should consider read failures and write failures separately, because the impact and possible mitigations will be different.</span></span>
3. <span data-ttu-id="1ceb7-112">Оценивайте каждый режим сбоя в соответствии с его общим уровнем риска.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-112">Rate each failure mode according to its overall risk.</span></span> <span data-ttu-id="1ceb7-113">Учитывайте следующие факторы:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-113">Consider these factors:</span></span>

   - <span data-ttu-id="1ceb7-114">Какова вероятность возникновения сбоя?</span><span class="sxs-lookup"><span data-stu-id="1ceb7-114">What is the likelihood of the failure.</span></span> <span data-ttu-id="1ceb7-115">Возникает ли он очень часто</span><span class="sxs-lookup"><span data-stu-id="1ceb7-115">Is it relatively common?</span></span> <span data-ttu-id="1ceb7-116">или крайне редко?</span><span class="sxs-lookup"><span data-stu-id="1ceb7-116">Extrememly rare?</span></span> <span data-ttu-id="1ceb7-117">Вам не нужны точные показатели, главное — это назначить приоритет.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-117">You don't need exact numbers; the purpose is to help rank the priority.</span></span>
   - <span data-ttu-id="1ceb7-118">Каково влияние на работу приложения с точки зрения доступности, потери данных, денежных расходов и нарушения работы организации?</span><span class="sxs-lookup"><span data-stu-id="1ceb7-118">What is the impact on the application, in terms of availability, data loss, monetary cost, and business disruption?</span></span>

4. <span data-ttu-id="1ceb7-119">Для каждого режима сбоя определите, как приложение будет реагировать на эти сбои и восстанавливаться после них.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-119">For each failure mode, determine how the application will respond and recover.</span></span> <span data-ttu-id="1ceb7-120">Оцените компромиссы в цене и сложности приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-120">Consider tradeoffs in cost and application complexity.</span></span>

<span data-ttu-id="1ceb7-121">В качестве отправной точки для процесса FMA эта статья содержит каталог потенциальных режимов сбоя и способов их устранения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-121">As a starting point for your FMA process, this article contains a catalog of potential failure modes and their mitigations.</span></span> <span data-ttu-id="1ceb7-122">Каталог упорядочен по технологии или службе Azure, а также общей категории для проектирования уровня приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-122">The catalog is organized by technology or Azure service, plus a general category for application-level design.</span></span> <span data-ttu-id="1ceb7-123">Каталог не является исчерпывающим, но охватывает множество основных служб Azure.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-123">The catalog is not exhaustive, but covers many of the core Azure services.</span></span>

## <a name="app-service"></a><span data-ttu-id="1ceb7-124">Служба приложений</span><span class="sxs-lookup"><span data-stu-id="1ceb7-124">App Service</span></span>

<!-- markdownlint-disable MD026 -->

### <a name="app-service-app-shuts-down"></a><span data-ttu-id="1ceb7-125">Приложение службы приложений завершает работу.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-125">App Service app shuts down.</span></span>

<span data-ttu-id="1ceb7-126">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-126">**Detection**.</span></span> <span data-ttu-id="1ceb7-127">Возможные причины:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-127">Possible causes:</span></span>

- <span data-ttu-id="1ceb7-128">Ожидаемое завершение работы</span><span class="sxs-lookup"><span data-stu-id="1ceb7-128">Expected shutdown</span></span>

  - <span data-ttu-id="1ceb7-129">Оператор завершает работу приложения, например, с помощью портала Azure.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-129">An operator shuts down the application; for example, using the Azure portal.</span></span>
  - <span data-ttu-id="1ceb7-130">Приложение выгружено, так как оно бездействовало.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-130">The app was unloaded because it was idle.</span></span> <span data-ttu-id="1ceb7-131">(Только если параметр `Always On` отключен.)</span><span class="sxs-lookup"><span data-stu-id="1ceb7-131">(Only if the `Always On` setting is disabled.)</span></span>

- <span data-ttu-id="1ceb7-132">Непредвиденное завершение работы</span><span class="sxs-lookup"><span data-stu-id="1ceb7-132">Unexpected shutdown</span></span>

  - <span data-ttu-id="1ceb7-133">Приложение аварийно завершает работу.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-133">The app crashes.</span></span>
  - <span data-ttu-id="1ceb7-134">Экземпляр виртуальной машины службы приложений становится недоступным.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-134">An App Service VM instance becomes unavailable.</span></span>

<span data-ttu-id="1ceb7-135">Журнал метода Application_End зарегистрирует завершение работы домена приложения (несерьезный сбой процесса). Это единственный способ регистрации завершения работы доменов приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-135">Application_End logging will catch the app domain shutdown (soft process crash) and is the only way to catch the application domain shutdowns.</span></span>

<span data-ttu-id="1ceb7-136">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-136">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-137">Если завершение работы ожидалось, корректно завершите работу с помощь соответствующего события.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-137">If the shutdown was expected, use the application's shutdown event to shut down gracefully.</span></span> <span data-ttu-id="1ceb7-138">Например, в ASP.NET используйте метод `Application_End`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-138">For example, in ASP.NET, use the `Application_End` method.</span></span>
- <span data-ttu-id="1ceb7-139">Если приложение было выгружено из-за бездействия, оно будет автоматически перезагружено при следующем запросе.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-139">If the application was unloaded while idle, it is automatically restarted on the next request.</span></span> <span data-ttu-id="1ceb7-140">Тем не менее с вас будет взиматься плата за "холодный запуск".</span><span class="sxs-lookup"><span data-stu-id="1ceb7-140">However, you will incur the "cold start" cost.</span></span>
- <span data-ttu-id="1ceb7-141">Чтобы избежать выгрузки приложения, когда оно бездействует, включите параметр `Always On` в веб-приложении.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-141">To prevent the application from being unloaded while idle, enable the `Always On` setting in the web app.</span></span> <span data-ttu-id="1ceb7-142">Ознакомьтесь со статьей [Настройка веб-приложений в службе приложений Azure][app-service-configure].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-142">See [Configure web apps in Azure App Service][app-service-configure].</span></span>
- <span data-ttu-id="1ceb7-143">Чтобы оператор не завершал работу приложения, установите блокировку ресурсов с уровнем `ReadOnly`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-143">To prevent an operator from shutting down the app, set a resource lock with `ReadOnly` level.</span></span> <span data-ttu-id="1ceb7-144">Ознакомьтесь со статьей [Блокировка ресурсов для предотвращения непредвиденных изменений][rm-locks].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-144">See [Lock resources with Azure Resource Manager][rm-locks].</span></span>
- <span data-ttu-id="1ceb7-145">Если происходит сбой приложения или виртуальная машина службы приложений становится недоступной, служба приложений автоматически перезагружает приложение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-145">If the app crashes or an App Service VM becomes unavailable, App Service automatically restarts the app.</span></span>

<span data-ttu-id="1ceb7-146">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-146">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-147">Журналы приложений и веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-147">Application logs and web server logs.</span></span> <span data-ttu-id="1ceb7-148">Ознакомьтесь со статьей [Включение ведения журнала диагностики для веб-приложений в службе приложений Azure][app-service-logging].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-148">See [Enable diagnostics logging for web apps in Azure App Service][app-service-logging].</span></span>

### <a name="a-particular-user-repeatedly-makes-bad-requests-or-overloads-the-system"></a><span data-ttu-id="1ceb7-149">Конкретный пользователь многократно выполняет неправильные запросы или перегружает систему.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-149">A particular user repeatedly makes bad requests or overloads the system.</span></span>

<span data-ttu-id="1ceb7-150">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-150">**Detection**.</span></span> <span data-ttu-id="1ceb7-151">Выполните проверку подлинности пользователей и включите идентификаторы пользователей в журналы приложений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-151">Authenticate users and include user ID in application logs.</span></span>

<span data-ttu-id="1ceb7-152">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-152">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-153">Выполните регулирование запросов от пользователя с помощью [службы управления API Azure][api-management].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-153">Use [Azure API Management][api-management] to throttle requests from the user.</span></span> <span data-ttu-id="1ceb7-154">Ознакомьтесь со статьей [Расширенное регулирование запросов с помощью API Management][api-management-throttling].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-154">See [Advanced request throttling with Azure API Management][api-management-throttling]</span></span>
- <span data-ttu-id="1ceb7-155">Заблокируйте пользователя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-155">Block the user.</span></span>

<span data-ttu-id="1ceb7-156">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-156">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-157">Регистрируйте все запросы проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-157">Log all authentication requests.</span></span>

### <a name="a-bad-update-was-deployed"></a><span data-ttu-id="1ceb7-158">Развернуто неправильное обновление.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-158">A bad update was deployed.</span></span>

<span data-ttu-id="1ceb7-159">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-159">**Detection**.</span></span> <span data-ttu-id="1ceb7-160">Выполните мониторинг работоспособности приложения с помощью портала Azure (ознакомьтесь со статьей [Мониторинг производительности веб-приложения Azure][app-insights-web-apps]) или реализуйте [шаблон мониторинга конечной точки работоспособности][health-endpoint-monitoring-pattern].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-160">Monitor the application health through the Azure Portal (see [Monitor Azure web app performance][app-insights-web-apps]) or implement the [health endpoint monitoring pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="1ceb7-161">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-161">**Recovery:**.</span></span> <span data-ttu-id="1ceb7-162">Используйте несколько [слотов развертывания][app-service-slots] и выполните откат до последнего известного корректного развертывания.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-162">Use multiple [deployment slots][app-service-slots] and roll back to the last-known-good deployment.</span></span> <span data-ttu-id="1ceb7-163">Дополнительные сведения см. в статье [Basic web application][ra-web-apps-basic] (Базовое веб-приложение).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-163">For more information, see [Basic web application][ra-web-apps-basic].</span></span>

## <a name="azure-active-directory"></a><span data-ttu-id="1ceb7-164">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="1ceb7-164">Azure Active Directory</span></span>

### <a name="openid-connect-oidc-authentication-fails"></a><span data-ttu-id="1ceb7-165">Проверка подлинности OpenID Connect (OIDC) завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-165">OpenID Connect (OIDC) authentication fails.</span></span>

<span data-ttu-id="1ceb7-166">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-166">**Detection**.</span></span> <span data-ttu-id="1ceb7-167">К возможным режимам сбоев относится следующее:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-167">Possible failure modes include:</span></span>

1. <span data-ttu-id="1ceb7-168">Azure AD недоступен, или не удается получить к нему доступ из-за сбоя сети.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-168">Azure AD is not available, or cannot be reached due to a network problem.</span></span> <span data-ttu-id="1ceb7-169">Перенаправление на конечную точку проверки подлинности завершается сбоем, и ПО промежуточного слоя OIDC выдает исключение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-169">Redirection to the authentication endpoint fails, and the OIDC middleware throws an exception.</span></span>
2. <span data-ttu-id="1ceb7-170">Клиент Azure AD не существует.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-170">Azure AD tenant does not exist.</span></span> <span data-ttu-id="1ceb7-171">При перенаправлении на конечную точку проверки подлинности возвращается код ошибки HTTP и ПО промежуточного слоя OIDC выдает исключение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-171">Redirection to the authentication endpoint returns an HTTP error code, and the OIDC middleware throws an exception.</span></span>
3. <span data-ttu-id="1ceb7-172">Пользователь не может выполнить проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-172">User cannot authenticate.</span></span> <span data-ttu-id="1ceb7-173">Стратегия обнаружения не нужна. Azure AD обрабатывает ошибки входа.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-173">No detection strategy is necessary; Azure AD handles login failures.</span></span>

<span data-ttu-id="1ceb7-174">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-174">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-175">Перехват необработанных исключений из ПО промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-175">Catch unhandled exceptions from the middleware.</span></span>
2. <span data-ttu-id="1ceb7-176">Обработка событий `AuthenticationFailed`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-176">Handle `AuthenticationFailed` events.</span></span>
3. <span data-ttu-id="1ceb7-177">Перенаправление пользователя на страницу ошибки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-177">Redirect the user to an error page.</span></span>
4. <span data-ttu-id="1ceb7-178">Выполнение повторного подключения пользователем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-178">User retries.</span></span>

## <a name="azure-search"></a><span data-ttu-id="1ceb7-179">Поиск Azure</span><span class="sxs-lookup"><span data-stu-id="1ceb7-179">Azure Search</span></span>

### <a name="writing-data-to-azure-search-fails"></a><span data-ttu-id="1ceb7-180">Запись данных в службу поиска Azure завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-180">Writing data to Azure Search fails.</span></span>

<span data-ttu-id="1ceb7-181">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-181">**Detection**.</span></span> <span data-ttu-id="1ceb7-182">Перехватите ошибки `Microsoft.Rest.Azure.CloudException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-182">Catch `Microsoft.Rest.Azure.CloudException` errors.</span></span>

<span data-ttu-id="1ceb7-183">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-183">**Recovery:**</span></span>

<span data-ttu-id="1ceb7-184">[Пакет SDK для .NET службы поиска][search-sdk] автоматически осуществляет новую попытку после временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-184">The [Search .NET SDK][search-sdk] automatically retries after transient failures.</span></span> <span data-ttu-id="1ceb7-185">Исключения, выдаваемые клиентским пакетом SDK, должны рассматриваться как повторяющиеся ошибки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-185">Any exceptions thrown by the client SDK should be treated as non-transient errors.</span></span>

<span data-ttu-id="1ceb7-186">Политика повтора по умолчанию использует стратегию экспоненциальной отсрочки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-186">The default retry policy uses exponential back-off.</span></span> <span data-ttu-id="1ceb7-187">Чтобы использовать другую политику повтора, вызовите `SetRetryPolicy` в классе `SearchIndexClient` или `SearchServiceClient`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-187">To use a different retry policy, call `SetRetryPolicy` on the `SearchIndexClient` or `SearchServiceClient` class.</span></span> <span data-ttu-id="1ceb7-188">Дополнительные сведения см. в документации по [автоматическим повторам][auto-rest-client-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-188">For more information, see [Automatic Retries][auto-rest-client-retry].</span></span>

<span data-ttu-id="1ceb7-189">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-189">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-190">Воспользуйтесь [аналитикой поискового трафика][search-analytics].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-190">Use [Search Traffic Analytics][search-analytics].</span></span>

### <a name="reading-data-from-azure-search-fails"></a><span data-ttu-id="1ceb7-191">Считывание данных из службы поиска Azure завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-191">Reading data from Azure Search fails.</span></span>

<span data-ttu-id="1ceb7-192">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-192">**Detection**.</span></span> <span data-ttu-id="1ceb7-193">Перехватите ошибки `Microsoft.Rest.Azure.CloudException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-193">Catch `Microsoft.Rest.Azure.CloudException` errors.</span></span>

<span data-ttu-id="1ceb7-194">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-194">**Recovery:**</span></span>

<span data-ttu-id="1ceb7-195">[Пакет SDK для .NET службы поиска][search-sdk] автоматически осуществляет новую попытку после временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-195">The [Search .NET SDK][search-sdk]  automatically retries after transient failures.</span></span> <span data-ttu-id="1ceb7-196">Исключения, выдаваемые клиентским пакетом SDK, должны рассматриваться как повторяющиеся ошибки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-196">Any exceptions thrown by the client SDK should be treated as non-transient errors.</span></span>

<span data-ttu-id="1ceb7-197">Политика повтора по умолчанию использует стратегию экспоненциальной отсрочки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-197">The default retry policy uses exponential back-off.</span></span> <span data-ttu-id="1ceb7-198">Чтобы использовать другую политику повтора, вызовите `SetRetryPolicy` в классе `SearchIndexClient` или `SearchServiceClient`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-198">To use a different retry policy, call `SetRetryPolicy` on the `SearchIndexClient` or `SearchServiceClient` class.</span></span> <span data-ttu-id="1ceb7-199">Дополнительные сведения см. в документации по [автоматическим повторам][auto-rest-client-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-199">For more information, see [Automatic Retries][auto-rest-client-retry].</span></span>

<span data-ttu-id="1ceb7-200">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-200">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-201">Воспользуйтесь [аналитикой поискового трафика][search-analytics].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-201">Use [Search Traffic Analytics][search-analytics].</span></span>

## <a name="cassandra"></a><span data-ttu-id="1ceb7-202">Cassandra</span><span class="sxs-lookup"><span data-stu-id="1ceb7-202">Cassandra</span></span>

### <a name="reading-or-writing-to-a-node-fails"></a><span data-ttu-id="1ceb7-203">Чтение или запись в узле завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-203">Reading or writing to a node fails.</span></span>

<span data-ttu-id="1ceb7-204">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-204">**Detection**.</span></span> <span data-ttu-id="1ceb7-205">Перехватите исключение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-205">Catch the exception.</span></span> <span data-ttu-id="1ceb7-206">Для клиентов .NET это, как правило, будет `System.Web.HttpException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-206">For .NET clients, this will typically be `System.Web.HttpException`.</span></span> <span data-ttu-id="1ceb7-207">Другой клиент может иметь другие типы исключений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-207">Other client may have other exception types.</span></span>  <span data-ttu-id="1ceb7-208">Дополнительные сведения см. в записи блога [Cassandra error handling done right](https://www.datastax.com/dev/blog/cassandra-error-handling-done-right) (Правильная обработка ошибок Cassandra).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-208">For more information, see [Cassandra error handling done right](https://www.datastax.com/dev/blog/cassandra-error-handling-done-right).</span></span>

<span data-ttu-id="1ceb7-209">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-209">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-210">Каждый [клиент Cassandra](https://wiki.apache.org/cassandra/ClientOptions) имеет собственные политики повтора и возможности.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-210">Each [Cassandra client](https://wiki.apache.org/cassandra/ClientOptions) has its own retry policies and capabilities.</span></span> <span data-ttu-id="1ceb7-211">Дополнительные сведения см. в записи блога [Cassandra error handling done right][cassandra-error-handling] (Правильная обработка ошибок Cassandra).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-211">For more information, see [Cassandra error handling done right][cassandra-error-handling].</span></span>
- <span data-ttu-id="1ceb7-212">Используйте развертывание с поддержкой стоек с узлами данных, распределенными между доменами сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-212">Use a rack-aware deployment, with data nodes distributed across the fault domains.</span></span>
- <span data-ttu-id="1ceb7-213">Выполните развертывание в несколько регионов, используя согласованность локального кворума.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-213">Deploy to multiple regions with local quorum consistency.</span></span> <span data-ttu-id="1ceb7-214">При возникновении ошибки, которая не является временной, выполните отработку отказа в другой регион.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-214">If a non-transient failure occurs, fail over to another region.</span></span>

<span data-ttu-id="1ceb7-215">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-215">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-216">Журналы приложений</span><span class="sxs-lookup"><span data-stu-id="1ceb7-216">Application logs</span></span>

## <a name="cloud-service"></a><span data-ttu-id="1ceb7-217">Облачная служба</span><span class="sxs-lookup"><span data-stu-id="1ceb7-217">Cloud Service</span></span>

### <a name="web-or-worker-roles-are-unexpectedlybeing-shut-down"></a><span data-ttu-id="1ceb7-218">Веб-роли или рабочие роли неожиданно завершают работу.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-218">Web or worker roles are unexpectedly being shut down.</span></span>

<span data-ttu-id="1ceb7-219">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-219">**Detection**.</span></span> <span data-ttu-id="1ceb7-220">Появляется событие [RoleEnvironment.Stopping][RoleEnvironment.Stopping].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-220">The [RoleEnvironment.Stopping][RoleEnvironment.Stopping] event is fired.</span></span>

<span data-ttu-id="1ceb7-221">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-221">**Recovery**.</span></span> <span data-ttu-id="1ceb7-222">Переопределите метод [RoleEntryPoint.OnStop][RoleEntryPoint.OnStop], чтобы выполнить корректную очистку.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-222">Override the [RoleEntryPoint.OnStop][RoleEntryPoint.OnStop] method to gracefully clean up.</span></span> <span data-ttu-id="1ceb7-223">Дополнительные сведения см. в записи блога [The Right Way to Handle Azure OnStop Events][onstop-events] (Правильный способ обработки событий Azure OnStop).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-223">For more information, see [The Right Way to Handle Azure OnStop Events][onstop-events] (blog).</span></span>

## <a name="cosmos-db"></a><span data-ttu-id="1ceb7-224">База данных Cosmos</span><span class="sxs-lookup"><span data-stu-id="1ceb7-224">Cosmos DB</span></span>

### <a name="reading-data-fails"></a><span data-ttu-id="1ceb7-225">Считывание данных завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-225">Reading data fails.</span></span>

<span data-ttu-id="1ceb7-226">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-226">**Detection**.</span></span> <span data-ttu-id="1ceb7-227">Перехватите `System.Net.Http.HttpRequestException` или `Microsoft.Azure.Documents.DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-227">Catch `System.Net.Http.HttpRequestException` or `Microsoft.Azure.Documents.DocumentClientException`.</span></span>

<span data-ttu-id="1ceb7-228">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-228">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-229">Пакет SDK автоматически осуществляет новую попытку после сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-229">The SDK automatically retries failed attempts.</span></span> <span data-ttu-id="1ceb7-230">Чтобы задать количество повторных попыток и максимальное время ожидания, настройте свойство `ConnectionPolicy.RetryOptions`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-230">To set the number of retries and the maximum wait time, configure `ConnectionPolicy.RetryOptions`.</span></span> <span data-ttu-id="1ceb7-231">Исключения клиента находятся за пределами действия политики повтора или не являются временными ошибками.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-231">Exceptions that the client raises are either beyond the retry policy or are not transient errors.</span></span>
- <span data-ttu-id="1ceb7-232">Если Cosmos DB выполняет для клиента регулирование, возвращается ошибка HTTP 429.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-232">If Cosmos DB throttles the client, it returns an HTTP 429 error.</span></span> <span data-ttu-id="1ceb7-233">Проверьте код состояния в `DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-233">Check the status code in the `DocumentClientException`.</span></span> <span data-ttu-id="1ceb7-234">Если вы постоянно получаете ошибку 429, попробуйте увеличить значение пропускной способности коллекции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-234">If you are getting error 429 consistently, consider increasing the throughput value of the collection.</span></span>
  - <span data-ttu-id="1ceb7-235">При использовании API MongoDB служба возвращает код ошибки 16500 при регулировании количества запросов.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-235">If you are using the MongoDB API, the service returns error code 16500 when throttling.</span></span>
- <span data-ttu-id="1ceb7-236">Реплицируйте базу данных Cosmos DB в двух или более регионах.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-236">Replicate the Cosmos DB database across two or more regions.</span></span> <span data-ttu-id="1ceb7-237">Все реплики доступны для чтения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-237">All replicas are readable.</span></span> <span data-ttu-id="1ceb7-238">Укажите параметр `PreferredLocations` с помощью клиентских пакетов SDK.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-238">Using the client SDKs, specify the `PreferredLocations` parameter.</span></span> <span data-ttu-id="1ceb7-239">Это упорядоченный список регионов Azure.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-239">This is an ordered list of Azure regions.</span></span> <span data-ttu-id="1ceb7-240">Все операции чтения будут отправляться в первый доступный регион из списка.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-240">All reads will be sent to the first available region in the list.</span></span> <span data-ttu-id="1ceb7-241">Если запрос завершается сбоем, клиент попытается отправить операции в другие регионы в списке в указанном порядке.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-241">If the request fails, the client will try the other regions in the list, in order.</span></span> <span data-ttu-id="1ceb7-242">Дополнительные сведения см. в статье [Как настроить глобальное распределение Azure Cosmos DB с помощью API SQL][cosmosdb-multi-region].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-242">For more information, see [How to setup Azure Cosmos DB global distribution using the SQL API][cosmosdb-multi-region].</span></span>

<span data-ttu-id="1ceb7-243">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-243">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-244">Регистрируйте все ошибки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-244">Log all errors on the client side.</span></span>

### <a name="writing-data-fails"></a><span data-ttu-id="1ceb7-245">Запись данных завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-245">Writing data fails.</span></span>

<span data-ttu-id="1ceb7-246">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-246">**Detection**.</span></span> <span data-ttu-id="1ceb7-247">Перехватите `System.Net.Http.HttpRequestException` или `Microsoft.Azure.Documents.DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-247">Catch `System.Net.Http.HttpRequestException` or `Microsoft.Azure.Documents.DocumentClientException`.</span></span>

<span data-ttu-id="1ceb7-248">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-248">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-249">Пакет SDK автоматически осуществляет новую попытку после сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-249">The SDK automatically retries failed attempts.</span></span> <span data-ttu-id="1ceb7-250">Чтобы задать количество повторных попыток и максимальное время ожидания, настройте свойство `ConnectionPolicy.RetryOptions`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-250">To set the number of retries and the maximum wait time, configure `ConnectionPolicy.RetryOptions`.</span></span> <span data-ttu-id="1ceb7-251">Исключения клиента находятся за пределами действия политики повтора или не являются временными ошибками.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-251">Exceptions that the client raises are either beyond the retry policy or are not transient errors.</span></span>
- <span data-ttu-id="1ceb7-252">Если Cosmos DB выполняет для клиента регулирование, возвращается ошибка HTTP 429.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-252">If Cosmos DB throttles the client, it returns an HTTP 429 error.</span></span> <span data-ttu-id="1ceb7-253">Проверьте код состояния в `DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-253">Check the status code in the `DocumentClientException`.</span></span> <span data-ttu-id="1ceb7-254">Если вы постоянно получаете ошибку 429, попробуйте увеличить значение пропускной способности коллекции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-254">If you are getting error 429 consistently, consider increasing the throughput value of the collection.</span></span>
- <span data-ttu-id="1ceb7-255">Реплицируйте базу данных Cosmos DB в двух или более регионах.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-255">Replicate the Cosmos DB database across two or more regions.</span></span> <span data-ttu-id="1ceb7-256">При сбое основного региона уровень другого региона будет повышен для записи.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-256">If the primary region fails, another region will be promoted to write.</span></span> <span data-ttu-id="1ceb7-257">Вы также можете активировать отработку отказа вручную.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-257">You can also trigger a failover manually.</span></span> <span data-ttu-id="1ceb7-258">Пакет SDK выполняет автоматическое обнаружение и маршрутизацию, поэтому код приложения продолжает работать после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-258">The SDK does automatic discovery and routing, so application code continues to work after a failover.</span></span> <span data-ttu-id="1ceb7-259">Во время отработки отказа (обычно в минутах) операции записи будут выполняться дольше, так как пакет SDK ищет новый регион записи.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-259">During the failover period (typically minutes), write operations will have higher latency, as the SDK finds the new write region.</span></span> <span data-ttu-id="1ceb7-260">Дополнительные сведения см. в статье [Как настроить глобальное распределение Azure Cosmos DB с помощью API SQL][cosmosdb-multi-region].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-260">For more information, see [How to setup Azure Cosmos DB global distribution using the SQL API][cosmosdb-multi-region].</span></span>
- <span data-ttu-id="1ceb7-261">В качестве резерва сохраните документ в резервной очереди и обработайте очередь позже.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-261">As a fallback, persist the document to a backup queue, and process the queue later.</span></span>

<span data-ttu-id="1ceb7-262">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-262">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-263">Регистрируйте все ошибки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-263">Log all errors on the client side.</span></span>

## <a name="elasticsearch"></a><span data-ttu-id="1ceb7-264">Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="1ceb7-264">Elasticsearch</span></span>

### <a name="reading-data-from-elasticsearch-fails"></a><span data-ttu-id="1ceb7-265">Считывание данных из Elasticsearch завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-265">Reading data from Elasticsearch fails.</span></span>

<span data-ttu-id="1ceb7-266">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-266">**Detection**.</span></span> <span data-ttu-id="1ceb7-267">Перехватите соответствующее исключение для конкретного используемого [клиента Elasticsearch][elasticsearch-client].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-267">Catch the appropriate exception for the particular [Elasticsearch client][elasticsearch-client] being used.</span></span>

<span data-ttu-id="1ceb7-268">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-268">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-269">Используйте механизм повтора.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-269">Use a retry mechanism.</span></span> <span data-ttu-id="1ceb7-270">Каждый клиент имеет собственные политики повтора.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-270">Each client has its own retry policies.</span></span>
- <span data-ttu-id="1ceb7-271">Разверните несколько узлов Elasticsearch и выполните репликацию для обеспечения высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-271">Deploy multiple Elasticsearch nodes and use replication for high availability.</span></span>

<span data-ttu-id="1ceb7-272">Дополнительные сведения см. в статье [Run Elasticsearch on Azure][elasticsearch-azure] (Запуск Elasticsearch в Azure).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-272">For more information, see [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

<span data-ttu-id="1ceb7-273">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-273">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-274">Вы можете использовать средства мониторинга для Elasticsearch или регистрируйте все ошибки на стороне клиента с использованием полезных данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-274">You can use monitoring tools for Elasticsearch, or log all errors on the client side with the payload.</span></span> <span data-ttu-id="1ceb7-275">Просмотрите раздел "Мониторинг" статьи [Running Elasticsearch on Azure][elasticsearch-azure] (Запуск Elasticsearch в Azure).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-275">See the 'Monitoring' section in [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

### <a name="writing-data-to-elasticsearch-fails"></a><span data-ttu-id="1ceb7-276">Запись данных в Elasticsearch завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-276">Writing data to Elasticsearch fails.</span></span>

<span data-ttu-id="1ceb7-277">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-277">**Detection**.</span></span> <span data-ttu-id="1ceb7-278">Перехватите соответствующее исключение для конкретного используемого [клиента Elasticsearch][elasticsearch-client].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-278">Catch the appropriate exception for the particular [Elasticsearch client][elasticsearch-client] being used.</span></span>

<span data-ttu-id="1ceb7-279">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-279">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-280">Используйте механизм повтора.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-280">Use a retry mechanism.</span></span> <span data-ttu-id="1ceb7-281">Каждый клиент имеет собственные политики повтора.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-281">Each client has its own retry policies.</span></span>
- <span data-ttu-id="1ceb7-282">Если пониженный уровень согласованности приложения допустим, рассмотрите возможность записи с помощью параметра `write_consistency` `quorum`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-282">If the application can tolerate a reduced consistency level, consider writing with `write_consistency` setting of `quorum`.</span></span>

<span data-ttu-id="1ceb7-283">Дополнительные сведения см. в статье [Run Elasticsearch on Azure][elasticsearch-azure] (Запуск Elasticsearch в Azure).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-283">For more information, see [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

<span data-ttu-id="1ceb7-284">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-284">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-285">Вы можете использовать средства мониторинга для Elasticsearch или регистрируйте все ошибки на стороне клиента с использованием полезных данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-285">You can use monitoring tools for Elasticsearch, or log all errors on the client side with the payload.</span></span> <span data-ttu-id="1ceb7-286">Просмотрите раздел "Мониторинг" статьи [Running Elasticsearch on Azure][elasticsearch-azure] (Запуск Elasticsearch в Azure).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-286">See the 'Monitoring' section in [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

## <a name="queue-storage"></a><span data-ttu-id="1ceb7-287">Хранилище очередей</span><span class="sxs-lookup"><span data-stu-id="1ceb7-287">Queue storage</span></span>

### <a name="writing-a-message-to-azure-queue-storage-fails-consistently"></a><span data-ttu-id="1ceb7-288">Запись сообщения в хранилище очередей Azure постоянно завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-288">Writing a message to Azure Queue storage fails consistently.</span></span>

<span data-ttu-id="1ceb7-289">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-289">**Detection**.</span></span> <span data-ttu-id="1ceb7-290">После *N* повторных попыток операции записи по-прежнему завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-290">After *N* retry attempts, the write operation still fails.</span></span>

<span data-ttu-id="1ceb7-291">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-291">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-292">Сохраните данные в локальном кэше и выполните переадресацию записей в хранилище, когда служба станет доступной.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-292">Store the data in a local cache, and forward the writes to storage later, when the service becomes available.</span></span>
- <span data-ttu-id="1ceb7-293">Создайте дополнительную очередь и запишите в нее данные, если основная очередь недоступна.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-293">Create a secondary queue, and write to that queue if the primary queue is unavailable.</span></span>

<span data-ttu-id="1ceb7-294">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-294">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-295">Используйте [метрики хранения][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-295">Use [storage metrics][storage-metrics].</span></span>

### <a name="the-application-cannot-process-a-particular-message-from-the-queue"></a><span data-ttu-id="1ceb7-296">Приложение не может обработать конкретное сообщение из очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-296">The application cannot process a particular message from the queue.</span></span>

<span data-ttu-id="1ceb7-297">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-297">**Detection**.</span></span> <span data-ttu-id="1ceb7-298">Зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-298">Application specific.</span></span> <span data-ttu-id="1ceb7-299">Например, сообщение содержит недопустимые данные или по какой-то причине происходит сбой бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-299">For example, the message contains invalid data, or the business logic fails for some reason.</span></span>

<span data-ttu-id="1ceb7-300">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-300">**Recovery:**</span></span>

<span data-ttu-id="1ceb7-301">Переместите сообщение в отдельную очередь.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-301">Move the message to a separate queue.</span></span> <span data-ttu-id="1ceb7-302">Запустите отдельный процесс для проверки сообщений в этой очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-302">Run a separate process to examine the messages in that queue.</span></span>

<span data-ttu-id="1ceb7-303">Попробуйте использовать очереди сообщений служебной шины Azure, которые для этой цели предоставляют функции [очереди недоставленных сообщений][sb-dead-letter-queue].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-303">Consider using Azure Service Bus Messaging queues, which provides a [dead-letter queue][sb-dead-letter-queue] functionality for this purpose.</span></span>

> [!NOTE]
> <span data-ttu-id="1ceb7-304">Если вы используете очереди хранилища с веб-заданиями, пакет SDK для веб-заданий предоставляет встроенную обработку сообщений о сбое.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-304">If you are using Storage queues with WebJobs, the WebJobs SDK provides built-in poison message handling.</span></span> <span data-ttu-id="1ceb7-305">Ознакомьтесь со статьей об [использовании пакета SDK веб-заданий для работы с хранилищем очередей Azure][sb-poison-message].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-305">See [How to use Azure queue storage with the WebJobs SDK][sb-poison-message].</span></span>

<span data-ttu-id="1ceb7-306">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-306">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-307">Воспользуйтесь данными журнала.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-307">Use application logging.</span></span>

## <a name="redis-cache"></a><span data-ttu-id="1ceb7-308">кэш Redis;</span><span class="sxs-lookup"><span data-stu-id="1ceb7-308">Redis Cache</span></span>

### <a name="reading-from-the-cache-fails"></a><span data-ttu-id="1ceb7-309">Чтение из кэша завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-309">Reading from the cache fails.</span></span>

<span data-ttu-id="1ceb7-310">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-310">**Detection**.</span></span> <span data-ttu-id="1ceb7-311">Перехватите `StackExchange.Redis.RedisConnectionException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-311">Catch `StackExchange.Redis.RedisConnectionException`.</span></span>

<span data-ttu-id="1ceb7-312">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-312">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-313">Повторите попытки в случае временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-313">Retry on transient failures.</span></span> <span data-ttu-id="1ceb7-314">Кэш Redis для Azure поддерживает встроенный механизм повторных попыток. Ознакомьтесь с разделом [Руководство по использованию механизма повторов для кэша Redis для Azure][redis-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-314">Azure Redis cache supports built-in retry through See [Redis Cache retry guidelines][redis-retry].</span></span>
2. <span data-ttu-id="1ceb7-315">Обрабатывайте постоянные ошибки в качестве промахов кэша и переключитесь на исходный источник данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-315">Treat non-transient failures as a cache miss, and fall back to the original data source.</span></span>

<span data-ttu-id="1ceb7-316">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-316">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-317">Выполните [диагностику кэша Redis][redis-monitor].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-317">Use [Redis Cache diagnostics][redis-monitor].</span></span>

### <a name="writing-to-the-cache-fails"></a><span data-ttu-id="1ceb7-318">Сбой при записи в кэш.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-318">Writing to the cache fails.</span></span>

<span data-ttu-id="1ceb7-319">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-319">**Detection**.</span></span> <span data-ttu-id="1ceb7-320">Перехватите `StackExchange.Redis.RedisConnectionException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-320">Catch `StackExchange.Redis.RedisConnectionException`.</span></span>

<span data-ttu-id="1ceb7-321">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-321">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-322">Повторите попытки в случае временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-322">Retry on transient failures.</span></span> <span data-ttu-id="1ceb7-323">Кэш Redis для Azure поддерживает встроенный механизм повторных попыток. Ознакомьтесь с разделом [Руководство по использованию механизма повторов для кэша Redis для Azure][redis-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-323">Azure Redis cache supports built-in retry through See [Redis Cache retry guidelines][redis-retry].</span></span>
2. <span data-ttu-id="1ceb7-324">Если ошибка не временная, игнорируйте ее и позвольте другим транзакциям позже выполнить запись данных в кэш.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-324">If the error is non-transient, ignore it and let other transactions write to the cache later.</span></span>

<span data-ttu-id="1ceb7-325">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-325">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-326">Выполните [диагностику кэша Redis][redis-monitor].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-326">Use [Redis Cache diagnostics][redis-monitor].</span></span>

## <a name="sql-database"></a><span data-ttu-id="1ceb7-327">База данных SQL</span><span class="sxs-lookup"><span data-stu-id="1ceb7-327">SQL Database</span></span>

### <a name="cannot-connect-to-the-database-in-the-primary-region"></a><span data-ttu-id="1ceb7-328">Не удается подключиться к базе данных в основном регионе.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-328">Cannot connect to the database in the primary region.</span></span>

<span data-ttu-id="1ceb7-329">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-329">**Detection**.</span></span> <span data-ttu-id="1ceb7-330">Сбой подключения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-330">Connection fails.</span></span>

<span data-ttu-id="1ceb7-331">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-331">**Recovery:**</span></span>

<span data-ttu-id="1ceb7-332">Предварительные требования: База данных должна быть настроена для активной георепликации.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-332">Prerequisite: The database must be configured for active geo-replication.</span></span> <span data-ttu-id="1ceb7-333">Ознакомьтесь сто статьей [Обзор. Группы отработки отказа и активная георепликация][sql-db-replication].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-333">See [SQL Database Active Geo-Replication][sql-db-replication].</span></span>

- <span data-ttu-id="1ceb7-334">Для запросов выполните чтение из вторичной реплики.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-334">For queries, read from a secondary replica.</span></span>
- <span data-ttu-id="1ceb7-335">Для операций вставок и обновлений выполните отработку отказа вручную во вторичную реплику.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-335">For inserts and updates, manually fail over to a secondary replica.</span></span> <span data-ttu-id="1ceb7-336">Ознакомьтесь со статьей [Настройка активной георепликации для базы данных SQL Azure с помощью портала Azure и запуск отработки отказа][sql-db-failover].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-336">See [Initiate a planned or unplanned failover for Azure SQL Database][sql-db-failover].</span></span>

<span data-ttu-id="1ceb7-337">Реплика использует другую строку подключения, поэтому необходимо будет обновить строку подключения в приложении.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-337">The replica uses a different connection string, so you will need to update the connection string in your application.</span></span>

### <a name="client-runs-out-of-connections-in-the-connection-pool"></a><span data-ttu-id="1ceb7-338">Клиенту не хватает подключений в пуле подключений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-338">Client runs out of connections in the connection pool.</span></span>

<span data-ttu-id="1ceb7-339">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-339">**Detection**.</span></span> <span data-ttu-id="1ceb7-340">Перехватите ошибки `System.InvalidOperationException`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-340">Catch `System.InvalidOperationException` errors.</span></span>

<span data-ttu-id="1ceb7-341">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-341">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-342">Повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-342">Retry the operation.</span></span>
- <span data-ttu-id="1ceb7-343">В качестве плана по устранению рисков используйте следующий прием: изолируйте пулы подключений для каждого варианта использования, чтобы один из вариантов использования не мог влиять на все подключения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-343">As a mitigation plan, isolate the connection pools for each use case, so that one use case can't dominate all the connections.</span></span>
- <span data-ttu-id="1ceb7-344">Увеличьте максимальное количество пулов подключений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-344">Increase the maximum connection pools.</span></span>

<span data-ttu-id="1ceb7-345">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-345">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-346">Журналы приложений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-346">Application logs.</span></span>

### <a name="database-connection-limit-is-reached"></a><span data-ttu-id="1ceb7-347">Достигнут предел для числа подключений к базе данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-347">Database connection limit is reached.</span></span>

<span data-ttu-id="1ceb7-348">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-348">**Detection**.</span></span> <span data-ttu-id="1ceb7-349">База данных SQL Azure ограничивает количество одновременных рабочих ролей, входов в систему и сеансов.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-349">Azure SQL Database limits the number of concurrent workers, logins, and sessions.</span></span> <span data-ttu-id="1ceb7-350">Ограничения зависят от уровня службы.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-350">The limits depend on the service tier.</span></span> <span data-ttu-id="1ceb7-351">Дополнительные сведения см. в статье [Ограничения ресурсов базы данных SQL Azure][sql-db-limits].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-351">For more information, see [Azure SQL Database resource limits][sql-db-limits].</span></span>

<span data-ttu-id="1ceb7-352">Чтобы обнаружить эти ошибки, перехватите `System.Data.SqlClient.SqlException` и проверьте значение `SqlException.Number` для кода ошибки SQL.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-352">To detect these errors, catch `System.Data.SqlClient.SqlException` and check the value of `SqlException.Number` for the SQL error code.</span></span> <span data-ttu-id="1ceb7-353">Список кодов ошибок см. в описании [кодов ошибок SQL для клиентских приложений Базы данных SQL (ошибки подключения базы данных и другие проблемы)][sql-db-errors].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-353">For a list of relevant error codes, see [SQL error codes for SQL Database client applications: Database connection error and other issues][sql-db-errors].</span></span>

<span data-ttu-id="1ceb7-354">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-354">**Recovery**.</span></span> <span data-ttu-id="1ceb7-355">Эти ошибки считаются временными, поэтому повторная попытка может решить проблему.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-355">These errors are considered transient, so retrying may resolve the issue.</span></span> <span data-ttu-id="1ceb7-356">Если вы постоянно получаете эти ошибки, попробуйте выполнить масштабирование базы данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-356">If you consistently hit these errors, consider scaling the database.</span></span>

<span data-ttu-id="1ceb7-357">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-357">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-358">Запрос [sys.event_log][sys.event_log] возвращает сведения об успешных подключениях к базе данных, а также о сбоях подключения и взаимоблокировках.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-358">- The [sys.event_log][sys.event_log] query returns successful database connections, connection failures, and deadlocks.</span></span>

- <span data-ttu-id="1ceb7-359">Создайте [правило генерации оповещений][azure-alerts] для неудачных подключений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-359">Create an [alert rule][azure-alerts] for failed connections.</span></span>
- <span data-ttu-id="1ceb7-360">Включите [аудит базы данных SQL][sql-db-audit] и проверьте неудачные попытки входа.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-360">Enable [SQL Database auditing][sql-db-audit] and check for failed logins.</span></span>

## <a name="service-bus-messaging"></a><span data-ttu-id="1ceb7-361">Обмен сообщениями через служебную шину</span><span class="sxs-lookup"><span data-stu-id="1ceb7-361">Service Bus Messaging</span></span>

### <a name="reading-a-message-from-a-service-bus-queue-fails"></a><span data-ttu-id="1ceb7-362">Чтение сообщения из очереди служебной шины завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-362">Reading a message from a Service Bus queue fails.</span></span>

<span data-ttu-id="1ceb7-363">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-363">**Detection**.</span></span> <span data-ttu-id="1ceb7-364">Перехватите исключения из пакета SDK клиента.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-364">Catch exceptions from the client SDK.</span></span> <span data-ttu-id="1ceb7-365">Базовый класс для исключений служебной шины — это [MessagingException][sb-messagingexception-class].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-365">The base class for Service Bus exceptions is [MessagingException][sb-messagingexception-class].</span></span> <span data-ttu-id="1ceb7-366">Если это временная ошибка, свойство `IsTransient` имеет значение true.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-366">If the error is transient, the `IsTransient` property is true.</span></span>

<span data-ttu-id="1ceb7-367">Дополнительные сведения см. в статье [Исключения обмена сообщениями служебной шины][sb-messaging-exceptions].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-367">For more information, see [Service Bus messaging exceptions][sb-messaging-exceptions].</span></span>

<span data-ttu-id="1ceb7-368">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-368">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-369">Повторите попытки в случае временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-369">Retry on transient failures.</span></span> <span data-ttu-id="1ceb7-370">Ознакомьтесь с разделом [Руководство по использованию механизма повторов для служебной шины][sb-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-370">See [Service Bus retry guidelines][sb-retry].</span></span>
2. <span data-ttu-id="1ceb7-371">Сообщения, которые не удается доставить ни одному адресату, помещаются в *очередь недоставленных сообщений*.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-371">Messages that cannot be delivered to any receiver are placed in a *dead-letter queue*.</span></span> <span data-ttu-id="1ceb7-372">С помощью этой очереди можно просмотреть, какие сообщения невозможно получить.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-372">Use this queue to see which messages could not be received.</span></span> <span data-ttu-id="1ceb7-373">Автоматическая очистка очереди недоставленных сообщений не предусмотрена.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-373">There is no automatic cleanup of the dead-letter queue.</span></span> <span data-ttu-id="1ceb7-374">Сообщения остаются там, пока вы явно не извлечете их.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-374">Messages remain there until you explicitly retrieve them.</span></span> <span data-ttu-id="1ceb7-375">Ознакомьтесь со статьей [Обзор очередей недоставленных сообщений служебной шины][sb-dead-letter-queue].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-375">See [Overview of Service Bus dead-letter queues][sb-dead-letter-queue].</span></span>

### <a name="writing-a-message-to-a-service-bus-queue-fails"></a><span data-ttu-id="1ceb7-376">Запись сообщения в очередь служебной шины завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-376">Writing a message to a Service Bus queue fails.</span></span>

<span data-ttu-id="1ceb7-377">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-377">**Detection**.</span></span> <span data-ttu-id="1ceb7-378">Перехватите исключения из пакета SDK клиента.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-378">Catch exceptions from the client SDK.</span></span> <span data-ttu-id="1ceb7-379">Базовый класс для исключений служебной шины — это [MessagingException][sb-messagingexception-class].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-379">The base class for Service Bus exceptions is [MessagingException][sb-messagingexception-class].</span></span> <span data-ttu-id="1ceb7-380">Если это временная ошибка, свойство `IsTransient` имеет значение true.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-380">If the error is transient, the `IsTransient` property is true.</span></span>

<span data-ttu-id="1ceb7-381">Дополнительные сведения см. в статье [Исключения обмена сообщениями служебной шины][sb-messaging-exceptions].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-381">For more information, see [Service Bus messaging exceptions][sb-messaging-exceptions].</span></span>

<span data-ttu-id="1ceb7-382">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-382">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-383">Клиент служебной шины автоматически осуществляет новую попытку после временных ошибок.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-383">The Service Bus client automatically retries after transient errors.</span></span> <span data-ttu-id="1ceb7-384">По умолчанию он использует экспоненциальную задержку.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-384">By default, it uses exponential back-off.</span></span> <span data-ttu-id="1ceb7-385">По достижении максимального числа повторных попыток или завершении периода ожидания клиент создает исключение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-385">After the maximum retry count or maximum timeout period, the client throws an exception.</span></span> <span data-ttu-id="1ceb7-386">Дополнительные сведения см. в разделе [Руководство по использованию механизма повторов для служебной шины][sb-retry].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-386">For more information, see [Service Bus retry guidelines][sb-retry].</span></span>
2. <span data-ttu-id="1ceb7-387">В случае превышения квоты очереди клиент создает исключение [QuotaExceededException][QuotaExceededException].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-387">If the queue quota is exceeded, the client throws [QuotaExceededException][QuotaExceededException].</span></span> <span data-ttu-id="1ceb7-388">Сообщение об исключении содержит более подробные сведения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-388">The exception message gives more details.</span></span> <span data-ttu-id="1ceb7-389">Остановите запись некоторых сообщений из очереди, прежде чем повторить попытку, и попробуйте использовать шаблон автоматического выключения, чтобы избежать непрерывных попыток в случае превышения квоты.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-389">Drain some messages from the queue before retrying, and consider using the Circuit Breaker pattern to avoid continued retries while the quota is exceeded.</span></span> <span data-ttu-id="1ceb7-390">Кроме того, убедитесь, что свойству [BrokeredMessage.TimeToLive] не задано слишком большое значение.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-390">Also, make sure the [BrokeredMessage.TimeToLive] property is not set too high.</span></span>
3. <span data-ttu-id="1ceb7-391">В пределах региона можно повысить устойчивость с помощью [секционированных очередей и разделов][sb-partition].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-391">Within a region, resiliency can be improved by using [partitioned queues or topics][sb-partition].</span></span> <span data-ttu-id="1ceb7-392">Несекционированные очередь или раздел назначаются одному хранилищу сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-392">A non-partitioned queue or topic is assigned to one messaging store.</span></span> <span data-ttu-id="1ceb7-393">Если это хранилище сообщений недоступно, все операции с этой очередью или разделом завершатся с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-393">If this messaging store is unavailable, all operations on that queue or topic will fail.</span></span> <span data-ttu-id="1ceb7-394">Секционированные очереди или разделы разделяются по нескольким хранилищам сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-394">A partitioned queue or topic is partitioned across multiple messaging stores.</span></span>
4. <span data-ttu-id="1ceb7-395">Для повышения устойчивости создайте два пространства имен служебной шины в разных регионах и реплицируйте сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-395">For additional resiliency, create two Service Bus namespaces in different regions, and replicate the messages.</span></span> <span data-ttu-id="1ceb7-396">Вы можете использовать активную или пассивную репликацию.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-396">You can use either active replication or passive replication.</span></span>

    - <span data-ttu-id="1ceb7-397">Активная репликация. Клиент отправляет каждое сообщение в обе очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-397">Active replication: The client sends every message to both queues.</span></span> <span data-ttu-id="1ceb7-398">Получатель прослушивает обе очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-398">The receiver listens on both queues.</span></span> <span data-ttu-id="1ceb7-399">Отметьте сообщения уникальным идентификатором, чтобы клиент мог удалять повторяющиеся сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-399">Tag messages with a unique identifier, so the client can discard duplicate messages.</span></span>
    - <span data-ttu-id="1ceb7-400">Пассивная репликация. Клиент отправляет сообщение в одну очередь.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-400">Passive replication: The client sends the message to one queue.</span></span> <span data-ttu-id="1ceb7-401">Если возникает ошибка, клиент начинает использовать другую очередь.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-401">If there is an error, the client falls back to the other queue.</span></span> <span data-ttu-id="1ceb7-402">Получатель прослушивает обе очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-402">The receiver listens on both queues.</span></span> <span data-ttu-id="1ceb7-403">При таком подходе уменьшается число отправляемых повторяющихся сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-403">This approach reduces the number of duplicate messages that are sent.</span></span> <span data-ttu-id="1ceb7-404">Тем не менее получатель должен по-прежнему обрабатывать повторяющиеся сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-404">However, the receiver must still handle duplicate messages.</span></span>

    <span data-ttu-id="1ceb7-405">Дополнительные сведения см. в статье, посвященной [примеру GeoReplication][sb-georeplication-sample], и статье [Рекомендации по изолированию приложений от простоев и аварий служебной шины](/azure/service-bus-messaging/service-bus-outages-disasters/).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-405">For more information, see [GeoReplication sample][sb-georeplication-sample] and [Best practices for insulating applications against Service Bus outages and disasters](/azure/service-bus-messaging/service-bus-outages-disasters/).</span></span>

### <a name="duplicate-message"></a><span data-ttu-id="1ceb7-406">Повторяющиеся сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-406">Duplicate message.</span></span>

<span data-ttu-id="1ceb7-407">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-407">**Detection**.</span></span> <span data-ttu-id="1ceb7-408">Изучите свойства `MessageId` и `DeliveryCount` сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-408">Examine the `MessageId` and `DeliveryCount` properties of the message.</span></span>

<span data-ttu-id="1ceb7-409">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-409">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-410">По возможности спроектируйте операции обработки сообщений идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-410">If possible, design your message processing operations to be idempotent.</span></span> <span data-ttu-id="1ceb7-411">В противном случае сохраните идентификаторы уже обработанных сообщений и проверьте их перед обработкой сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-411">Otherwise, store message IDs of messages that are already processed, and check the ID before processing a message.</span></span>
- <span data-ttu-id="1ceb7-412">Включите поиск повторяющихся сообщений, создав очередь с параметром `RequiresDuplicateDetection`, которому присвоено значение true.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-412">Enable duplicate detection, by creating the queue with `RequiresDuplicateDetection` set to true.</span></span> <span data-ttu-id="1ceb7-413">С помощью этого параметра служебная шина автоматически удаляет любое сообщение, отправленное с тем же `MessageId`, что и предыдущее.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-413">With this setting, Service Bus automatically deletes any message that is sent with the same `MessageId` as a previous message.</span></span>  <span data-ttu-id="1ceb7-414">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-414">Note the following:</span></span>

  - <span data-ttu-id="1ceb7-415">Этот параметр предотвращает помещение в очередь повторяющихся сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-415">This setting prevents duplicate messages from being put into the queue.</span></span> <span data-ttu-id="1ceb7-416">Он не предотвращает повторную обработку одного и того же сообщения пользователем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-416">It doesn't prevent a receiver from processing the same message more than once.</span></span>
  - <span data-ttu-id="1ceb7-417">Функция обнаружения дубликатов имеет временное окно.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-417">Duplicate detection has a time window.</span></span> <span data-ttu-id="1ceb7-418">Если повторяющееся сообщение отправляется в это время, оно не будет обнаружено.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-418">If a duplicate is sent beyond this window, it won't be detected.</span></span>

<span data-ttu-id="1ceb7-419">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-419">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-420">Регистрируйте повторяющиеся сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-420">Log duplicated messages.</span></span>

### <a name="the-application-cant-process-a-particular-message-from-the-queue"></a><span data-ttu-id="1ceb7-421">Приложение не может обработать конкретное сообщение из очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-421">The application can't process a particular message from the queue.</span></span>

<span data-ttu-id="1ceb7-422">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-422">**Detection**.</span></span> <span data-ttu-id="1ceb7-423">Зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-423">Application specific.</span></span> <span data-ttu-id="1ceb7-424">Например, сообщение содержит недопустимые данные или по какой-то причине происходит сбой бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-424">For example, the message contains invalid data, or the business logic fails for some reason.</span></span>

<span data-ttu-id="1ceb7-425">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-425">**Recovery:**</span></span>

<span data-ttu-id="1ceb7-426">Существует два режима сбоя, которые следует учитывать.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-426">There are two failure modes to consider.</span></span>

- <span data-ttu-id="1ceb7-427">Получатель обнаруживает сбой.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-427">The receiver detects the failure.</span></span> <span data-ttu-id="1ceb7-428">В этом случает переместите сообщение в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-428">In this case, move the message to the dead-letter queue.</span></span> <span data-ttu-id="1ceb7-429">Позже запустите отдельный процесс для проверки сообщений в этой очереди.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-429">Later, run a separate process to examine the messages in the dead-letter queue.</span></span>
- <span data-ttu-id="1ceb7-430">В процессе обработки сообщения получателем происходит сбой, например, из-за необработанного исключения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-430">The receiver fails in the middle of processing the message &mdash; for example, due to an unhandled exception.</span></span> <span data-ttu-id="1ceb7-431">В этом случае используйте режим `PeekLock`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-431">To handle this case, use `PeekLock` mode.</span></span> <span data-ttu-id="1ceb7-432">В этом режиме по истечении срока действия блокировки сообщение стает доступным для других получателей.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-432">In this mode, if the lock expires, the message becomes available to other receivers.</span></span> <span data-ttu-id="1ceb7-433">Если максимальное число доставок или срок жизни сообщения превышают предел, сообщение автоматически перемещается в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-433">If the message exceeds the maximum delivery count or the time-to-live, the message is automatically moved to the dead-letter queue.</span></span>

<span data-ttu-id="1ceb7-434">Дополнительные сведения см. в статье [Обзор очередей недоставленных сообщений служебной шины][sb-dead-letter-queue].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-434">For more information, see [Overview of Service Bus dead-letter queues][sb-dead-letter-queue].</span></span>

<span data-ttu-id="1ceb7-435">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-435">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-436">Каждый раз, когда приложение перемещает сообщение в очередь недоставленных сообщений, записывайте событие в журнал приложений.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-436">Whenever the application moves a message to the dead-letter queue, write an event to the application logs.</span></span>

## <a name="service-fabric"></a><span data-ttu-id="1ceb7-437">Service Fabric</span><span class="sxs-lookup"><span data-stu-id="1ceb7-437">Service Fabric</span></span>

### <a name="a-request-to-a-service-fails"></a><span data-ttu-id="1ceb7-438">Запрос к службе завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-438">A request to a service fails.</span></span>

<span data-ttu-id="1ceb7-439">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-439">**Detection**.</span></span> <span data-ttu-id="1ceb7-440">Служба возвращает ошибку.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-440">The service returns an error.</span></span>

<span data-ttu-id="1ceb7-441">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-441">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-442">Снова найдите прокси-сервер (`ServiceProxy` или `ActorProxy`) и повторно вызовите метод службы или субъекта.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-442">Locate a proxy again (`ServiceProxy` or `ActorProxy`) and call the service/actor method again.</span></span>
- <span data-ttu-id="1ceb7-443">**Служба с отслеживанием состояния.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-443">**Stateful service**.</span></span> <span data-ttu-id="1ceb7-444">Поместите операции в надежных коллекциях в транзакцию.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-444">Wrap operations on reliable collections in a transaction.</span></span> <span data-ttu-id="1ceb7-445">Если возникает ошибка, будет выполнен откат транзакции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-445">If there is an error, the transaction will be rolled back.</span></span> <span data-ttu-id="1ceb7-446">Запрос (если он извлечен из очереди) будет обрабатываться повторно.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-446">The request, if pulled from a queue, will be processed again.</span></span>
- <span data-ttu-id="1ceb7-447">**Служба без отслеживания состояния.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-447">**Stateless service**.</span></span> <span data-ttu-id="1ceb7-448">Если служба сохраняет данные во внешнее хранилище, все операции должны быть идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-448">If the service persists data to an external store, all operations need to be idempotent.</span></span>

<span data-ttu-id="1ceb7-449">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-449">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-450">Журнал приложений</span><span class="sxs-lookup"><span data-stu-id="1ceb7-450">Application log</span></span>

### <a name="service-fabric-node-is-shut-down"></a><span data-ttu-id="1ceb7-451">Узел Service Fabric завершил работу.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-451">Service Fabric node is shut down.</span></span>

<span data-ttu-id="1ceb7-452">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-452">**Detection**.</span></span> <span data-ttu-id="1ceb7-453">Токен отмены передается в метод `RunAsync` службы.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-453">A cancellation token is passed to the service's `RunAsync` method.</span></span> <span data-ttu-id="1ceb7-454">Service Fabric отменяет задачу до завершения работы узла.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-454">Service Fabric cancels the task before shutting down the node.</span></span>

<span data-ttu-id="1ceb7-455">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-455">**Recovery**.</span></span> <span data-ttu-id="1ceb7-456">С помощью токена отмены можно обнаружить завершение работы.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-456">Use the cancellation token to detect shutdown.</span></span> <span data-ttu-id="1ceb7-457">Когда Service Fabric запрашивает отмену задачи, как можно быстрее завершите все выполняющиеся операции и выйдите из  `RunAsync`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-457">When Service Fabric requests cancellation, finish any work and exit `RunAsync` as quickly as possible.</span></span>

<span data-ttu-id="1ceb7-458">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-458">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-459">Журналы приложений</span><span class="sxs-lookup"><span data-stu-id="1ceb7-459">Application logs</span></span>

## <a name="storage"></a><span data-ttu-id="1ceb7-460">Хранилище</span><span class="sxs-lookup"><span data-stu-id="1ceb7-460">Storage</span></span>

### <a name="writing-data-to-azure-storage-fails"></a><span data-ttu-id="1ceb7-461">Запись данных в службу хранилища Azure завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-461">Writing data to Azure Storage fails</span></span>

<span data-ttu-id="1ceb7-462">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-462">**Detection**.</span></span> <span data-ttu-id="1ceb7-463">Клиент получает ошибки при записи.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-463">The client receives errors when writing.</span></span>

<span data-ttu-id="1ceb7-464">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-464">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-465">Повторите операцию, чтобы восстановить данные после временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-465">Retry the operation, to recover from transient failures.</span></span> <span data-ttu-id="1ceb7-466">[Политика повтора][Storage.RetryPolicies] в клиентском пакете SDK обрабатывает это автоматически.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-466">The [retry policy][Storage.RetryPolicies] in the client SDK handles this automatically.</span></span>
2. <span data-ttu-id="1ceb7-467">Реализуйте шаблон автоматического выключения, чтобы избежать перегрузки хранилища.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-467">Implement the Circuit Breaker pattern to avoid overwhelming storage.</span></span>
3. <span data-ttu-id="1ceb7-468">При сбое N повторных попыток выполните корректный переход.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-468">If N retry attempts fail, perform a graceful fallback.</span></span> <span data-ttu-id="1ceb7-469">Например: </span><span class="sxs-lookup"><span data-stu-id="1ceb7-469">For example:</span></span>

   - <span data-ttu-id="1ceb7-470">Сохраните данные в локальном кэше и выполните переадресацию записей в хранилище, когда служба станет доступной.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-470">Store the data in a local cache, and forward the writes to storage later, when the service becomes available.</span></span>
   - <span data-ttu-id="1ceb7-471">Если действие записи выполнялось в области транзакций, компенсируйте транзакции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-471">If the write action was in a transactional scope, compensate the transaction.</span></span>

<span data-ttu-id="1ceb7-472">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-472">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-473">Используйте [метрики хранения][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-473">Use [storage metrics][storage-metrics].</span></span>

### <a name="reading-data-from-azure-storage-fails"></a><span data-ttu-id="1ceb7-474">Считывание данных из службы хранилища Azure завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-474">Reading data from Azure Storage fails.</span></span>

<span data-ttu-id="1ceb7-475">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-475">**Detection**.</span></span> <span data-ttu-id="1ceb7-476">Клиент получает ошибки при считывании данных.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-476">The client receives errors when reading.</span></span>

<span data-ttu-id="1ceb7-477">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-477">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-478">Повторите операцию, чтобы восстановить данные после временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-478">Retry the operation, to recover from transient failures.</span></span> <span data-ttu-id="1ceb7-479">[Политика повтора][Storage.RetryPolicies] в клиентском пакете SDK обрабатывает это автоматически.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-479">The [retry policy][Storage.RetryPolicies] in the client SDK handles this automatically.</span></span>
2. <span data-ttu-id="1ceb7-480">Для хранилища RA-GRS, если произошел сбой при чтении из основной конечной точки, переключитесь на чтение из вторичной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-480">For RA-GRS storage, if reading from the primary endpoint fails, try reading from the secondary endpoint.</span></span> <span data-ttu-id="1ceb7-481">Клиентский пакет SDK может обрабатывать это автоматически.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-481">The client SDK can handle this automatically.</span></span> <span data-ttu-id="1ceb7-482">Ознакомьтесь со статьей [Репликация службы хранилища Azure][storage-replication].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-482">See [Azure Storage replication][storage-replication].</span></span>
3. <span data-ttu-id="1ceb7-483">При сбое *N* повторных попыток выполните откат, чтобы корректно снизить производительность.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-483">If *N* retry attempts fail, take a fallback action to degrade gracefully.</span></span> <span data-ttu-id="1ceb7-484">Например, если изображение продукта нельзя извлечь из хранилища, используйте универсальное изображение-заполнитель.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-484">For example, if a product image can't be retrieved from storage, show a generic placeholder image.</span></span>

<span data-ttu-id="1ceb7-485">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-485">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-486">Используйте [метрики хранения][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-486">Use [storage metrics][storage-metrics].</span></span>

## <a name="virtual-machine"></a><span data-ttu-id="1ceb7-487">Виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-487">Virtual machine</span></span>

### <a name="connection-to-a-backend-vm-fails"></a><span data-ttu-id="1ceb7-488">Подключение к серверной виртуальной машине завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-488">Connection to a backend VM fails.</span></span>

<span data-ttu-id="1ceb7-489">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-489">**Detection**.</span></span> <span data-ttu-id="1ceb7-490">Ошибки сетевого подключения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-490">Network connection errors.</span></span>

<span data-ttu-id="1ceb7-491">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-491">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-492">Разверните по крайней мере две серверных виртуальных машины в группе доступности за подсистемой балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-492">Deploy at least two backend VMs in an availability set, behind a load balancer.</span></span>
- <span data-ttu-id="1ceb7-493">Если ошибка подключения временная, иногда протокол TCP будет успешно выполнять повторную отправку сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-493">If the connection error is transient, sometimes TCP will successfully retry sending the message.</span></span>
- <span data-ttu-id="1ceb7-494">Реализуйте политику повтора в приложении.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-494">Implement a retry policy in the application.</span></span>
- <span data-ttu-id="1ceb7-495">Если ошибки постоянные или повторяющиеся, реализуйте шаблон [автоматического выключения][circuit-breaker].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-495">For persistent or non-transient errors, implement the [Circuit Breaker][circuit-breaker] pattern.</span></span>
- <span data-ttu-id="1ceb7-496">Если вызывающая виртуальная машина превышает предел возврата данных по сети, очередь исходящих сообщений будет заполнена.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-496">If the calling VM exceeds its network egress limit, the outbound queue will fill up.</span></span> <span data-ttu-id="1ceb7-497">Если очередь исходящих сообщений постоянно заполнена, попробуйте выполнить масштабирование.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-497">If the outbound queue is consistently full, consider scaling out.</span></span>

<span data-ttu-id="1ceb7-498">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-498">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-499">Регистрируйте события в границах служб.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-499">Log events at service boundaries.</span></span>

### <a name="vm-instance-becomes-unavailable-or-unhealthy"></a><span data-ttu-id="1ceb7-500">Экземпляр виртуальной машины становится недоступным или неработоспособным.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-500">VM instance becomes unavailable or unhealthy.</span></span>

<span data-ttu-id="1ceb7-501">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-501">**Detection**.</span></span> <span data-ttu-id="1ceb7-502">Настройте [проверку работоспособности][lb-probe] подсистемы балансировки нагрузки, которая сообщает о том, работоспособен ли экземпляр виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-502">Configure a Load Balancer [health probe][lb-probe] that signals whether the VM instance is healthy.</span></span> <span data-ttu-id="1ceb7-503">При этом проверяется, правильно ли отвечают критически важные функции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-503">The probe should check whether critical functions are responding correctly.</span></span>

<span data-ttu-id="1ceb7-504">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-504">**Recovery**.</span></span> <span data-ttu-id="1ceb7-505">Для каждого уровня приложения поместите несколько экземпляров виртуальной машины в одну и ту же группу доступности и разместите подсистему балансировки нагрузки перед виртуальной машиной.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-505">For each application tier, put multiple VM instances into the same availability set, and place a load balancer in front of the VMs.</span></span> <span data-ttu-id="1ceb7-506">Если проверка завершается сбоем, подсистема балансировки нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-506">If the health probe fails, the Load Balancer stops sending new connections to the unhealthy instance.</span></span>

<span data-ttu-id="1ceb7-507">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-507">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-508">Используйте службу [Log Analytics][lb-monitor] для подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-508">- Use Load Balancer [log analytics][lb-monitor].</span></span>

- <span data-ttu-id="1ceb7-509">Настройте систему мониторинга для отслеживания всех конечных точек мониторинга работоспособности.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-509">Configure your monitoring system to monitor all of the health monitoring endpoints.</span></span>

### <a name="operator-accidentally-shuts-down-a-vm"></a><span data-ttu-id="1ceb7-510">Оператор случайно завершает работу виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-510">Operator accidentally shuts down a VM.</span></span>

<span data-ttu-id="1ceb7-511">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-511">**Detection**.</span></span> <span data-ttu-id="1ceb7-512">Недоступно</span><span class="sxs-lookup"><span data-stu-id="1ceb7-512">N/A</span></span>

<span data-ttu-id="1ceb7-513">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-513">**Recovery**.</span></span> <span data-ttu-id="1ceb7-514">Установите блокировку ресурсов с уровнем `ReadOnly`.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-514">Set a resource lock with `ReadOnly` level.</span></span> <span data-ttu-id="1ceb7-515">Ознакомьтесь со статьей [Блокировка ресурсов для предотвращения непредвиденных изменений][rm-locks].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-515">See [Lock resources with Azure Resource Manager][rm-locks].</span></span>

<span data-ttu-id="1ceb7-516">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-516">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-517">Используйте [журналы действий Azure][azure-activity-logs].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-517">Use [Azure Activity Logs][azure-activity-logs].</span></span>

## <a name="webjobs"></a><span data-ttu-id="1ceb7-518">Веб-задания</span><span class="sxs-lookup"><span data-stu-id="1ceb7-518">WebJobs</span></span>

### <a name="continuous-job-stops-running-when-the-scm-host-is-idle"></a><span data-ttu-id="1ceb7-519">Выполнение непрерывного задания останавливается, когда узел диспетчера служб неактивен.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-519">Continuous job stops running when the SCM host is idle.</span></span>

<span data-ttu-id="1ceb7-520">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-520">**Detection**.</span></span> <span data-ttu-id="1ceb7-521">Передайте токен отмены в функцию веб-задания.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-521">Pass a cancellation token to the WebJob function.</span></span> <span data-ttu-id="1ceb7-522">Дополнительные сведения см. в статье о [корректном завершении работы][web-jobs-shutdown].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-522">For more information, see [Graceful shutdown][web-jobs-shutdown].</span></span>

<span data-ttu-id="1ceb7-523">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-523">**Recovery**.</span></span> <span data-ttu-id="1ceb7-524">Включите параметр `Always On` в веб-приложении.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-524">Enable the `Always On` setting in the web app.</span></span> <span data-ttu-id="1ceb7-525">Дополнительные сведения см. в статье [Выполнение фоновых задач с помощью веб-заданий в службе приложений Azure][web-jobs].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-525">For more information, see [Run Background tasks with WebJobs][web-jobs].</span></span>

## <a name="application-design"></a><span data-ttu-id="1ceb7-526">Проектирование приложений</span><span class="sxs-lookup"><span data-stu-id="1ceb7-526">Application design</span></span>

### <a name="application-cant-handle-a-spike-in-incoming-requests"></a><span data-ttu-id="1ceb7-527">Приложение не может обработать всплеск входящих запросов.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-527">Application can't handle a spike in incoming requests.</span></span>

<span data-ttu-id="1ceb7-528">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-528">**Detection**.</span></span> <span data-ttu-id="1ceb7-529">Зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-529">Depends on the application.</span></span> <span data-ttu-id="1ceb7-530">Обычные симптомы:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-530">Typical symptoms:</span></span>

- <span data-ttu-id="1ceb7-531">Веб-сайт начинает возвращать коды ошибок HTTP 5xx.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-531">The website starts returning HTTP 5xx error codes.</span></span>
- <span data-ttu-id="1ceb7-532">Зависимые службы, например база данных или служба хранилища, начинают регулировать запросы.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-532">Dependent services, such as database or storage, start to throttle requests.</span></span> <span data-ttu-id="1ceb7-533">Найдите ошибки HTTP, такие как HTTP 429 (слишком много запросов), в зависимости от службы.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-533">Look for HTTP errors such as HTTP 429 (Too Many Requests), depending on the service.</span></span>
- <span data-ttu-id="1ceb7-534">Длина очереди HTTP увеличивается.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-534">HTTP queue length grows.</span></span>

<span data-ttu-id="1ceb7-535">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-535">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-536">Выполните развертывание, чтобы обработать более высокие нагрузки.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-536">Scale out to handle increased load.</span></span>
- <span data-ttu-id="1ceb7-537">Устраните ошибки, чтобы предотвратить каскадные сбои во всем приложении.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-537">Mitigate failures to avoid having cascading failures disrupt the entire application.</span></span> <span data-ttu-id="1ceb7-538">Стратегии устранения рисков включают следующее:</span><span class="sxs-lookup"><span data-stu-id="1ceb7-538">Mitigation strategies include:</span></span>

  - <span data-ttu-id="1ceb7-539">Реализация [шаблона регулирования][throttling-pattern] во избежание перегрузки серверных систем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-539">Implement the [Throttling pattern][throttling-pattern] to avoid overwhelming backend systems.</span></span>
  - <span data-ttu-id="1ceb7-540">Использование [выравнивания нагрузки на основе очередей][queue-based-load-leveling], чтобы выполнить буферизацию запросов и обрабатывать их с удобной для вас скоростью.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-540">Use [queue-based load leveling][queue-based-load-leveling] to buffer requests and process them at an appropriate pace.</span></span>
  - <span data-ttu-id="1ceb7-541">Назначение приоритетов нескольким клиентам.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-541">Prioritize certain clients.</span></span> <span data-ttu-id="1ceb7-542">Например, если приложение имеет платные и бесплатные уровни, выполните регулирование клиентов бесплатного уровня, а не платного.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-542">For example, if the application has free and paid tiers, throttle customers on the free tier, but not paid customers.</span></span> <span data-ttu-id="1ceb7-543">Ознакомьтесь со статьей [Шаблон очереди с приоритетом][priority-queue-pattern].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-543">See [Priority queue pattern][priority-queue-pattern].</span></span>

<span data-ttu-id="1ceb7-544">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-544">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-545">Используйте [журнал ведения диагностики службы приложений][app-service-logging].</span><span class="sxs-lookup"><span data-stu-id="1ceb7-545">Use [App Service diagnostic logging][app-service-logging].</span></span> <span data-ttu-id="1ceb7-546">Воспользуйтесь службой, например [Azure Log Analytics][azure-log-analytics], [Application Insights][app-insights] или [New Relic][new-relic], чтобы разобраться в журналах диагностики.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-546">Use a service such as [Azure Log Analytics][azure-log-analytics], [Application Insights][app-insights], or [New Relic][new-relic] to help understand the diagnostic logs.</span></span>

### <a name="one-of-the-operations-in-a-workflow-or-distributed-transaction-fails"></a><span data-ttu-id="1ceb7-547">Одна из операций в рабочем процессе или распределенная транзакция завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-547">One of the operations in a workflow or distributed transaction fails.</span></span>

<span data-ttu-id="1ceb7-548">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-548">**Detection**.</span></span> <span data-ttu-id="1ceb7-549">После *N* повторных попыток по-прежнему происходит сбой.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-549">After *N* retry attempts, it still fails.</span></span>

<span data-ttu-id="1ceb7-550">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-550">**Recovery:**</span></span>

- <span data-ttu-id="1ceb7-551">В качестве плана устранения рисков реализуйте шаблон [Планировщик, агент, контролер][scheduler-agent-supervisor] для управления целым рабочим процессом.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-551">As a mitigation plan, implement the [Scheduler Agent Supervisor][scheduler-agent-supervisor] pattern to manage the entire workflow.</span></span>
- <span data-ttu-id="1ceb7-552">Не повторяйте попытку после истечения времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-552">Don't retry on timeouts.</span></span> <span data-ttu-id="1ceb7-553">Процент успешных операций для устранения этой ошибки очень мал.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-553">There is a low success rate for this error.</span></span>
- <span data-ttu-id="1ceb7-554">Если очередь работает, повторите попытку позже.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-554">Queue work, in order to retry later.</span></span>

<span data-ttu-id="1ceb7-555">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-555">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-556">Регистрируйте все операции (успешные и неудачные), включая компенсирующие действия.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-556">Log all operations (successful and failed), including compensating actions.</span></span> <span data-ttu-id="1ceb7-557">Используйте идентификаторы корреляции, чтобы отслеживать все операции в одной и той же транзакции.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-557">Use correlation IDs, so that you can track all operations within the same transaction.</span></span>

### <a name="a-call-to-a-remote-service-fails"></a><span data-ttu-id="1ceb7-558">Вызов удаленной службы завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-558">A call to a remote service fails.</span></span>

<span data-ttu-id="1ceb7-559">**Обнаружение.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-559">**Detection**.</span></span> <span data-ttu-id="1ceb7-560">Код ошибки HTTP.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-560">HTTP error code.</span></span>

<span data-ttu-id="1ceb7-561">**Восстановление**.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-561">**Recovery:**</span></span>

1. <span data-ttu-id="1ceb7-562">Повторите попытки в случае временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-562">Retry on transient failures.</span></span>
2. <span data-ttu-id="1ceb7-563">Если вызов завершается сбоем после *N* попыток, выполите откат.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-563">If the call fails after *N* attempts, take a fallback action.</span></span> <span data-ttu-id="1ceb7-564">(Зависит от приложения.)</span><span class="sxs-lookup"><span data-stu-id="1ceb7-564">(Application specific.)</span></span>
3. <span data-ttu-id="1ceb7-565">Реализуйте [шаблон автоматического выключения][circuit-breaker], чтобы избежать каскадных сбоев.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-565">Implement the [Circuit Breaker pattern][circuit-breaker] to avoid cascading failures.</span></span>

<span data-ttu-id="1ceb7-566">**Диагностика.**</span><span class="sxs-lookup"><span data-stu-id="1ceb7-566">**Diagnostics**.</span></span> <span data-ttu-id="1ceb7-567">Регистрируйте все ошибки удаленных вызовов.</span><span class="sxs-lookup"><span data-stu-id="1ceb7-567">Log all remote call failures.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1ceb7-568">Дополнительная информация</span><span class="sxs-lookup"><span data-stu-id="1ceb7-568">Next steps</span></span>

<span data-ttu-id="1ceb7-569">Дополнительные сведения о процессе FMA см. в статье [Resilience by design for cloud services][resilience-by-design-pdf] (Намеренная устойчивость облачных служб) (скачиваемый PDF-файл).</span><span class="sxs-lookup"><span data-stu-id="1ceb7-569">For more information about the FMA process, see [Resilience by design for cloud services][resilience-by-design-pdf] (PDF download).</span></span>

<!-- markdownlint-enable MD026 -->

<!-- links -->

[api-management]: /azure/api-management/
[api-management-throttling]: /azure/api-management/api-management-sample-flexible-throttling/
[app-insights]: /azure/application-insights/app-insights-overview/
[app-insights-web-apps]: /azure/application-insights/app-insights-azure-web-apps/
[app-service-configure]: /azure/app-service-web/web-sites-configure/
[app-service-logging]: /azure/app-service-web/web-sites-enable-diagnostic-log/
[app-service-slots]: /azure/app-service-web/web-sites-staged-publishing/
[auto-rest-client-retry]: https://github.com/Azure/autorest/tree/master/docs
[azure-activity-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-activity-logs/
[azure-alerts]: /azure/monitoring-and-diagnostics/insights-alerts-portal/
[azure-log-analytics]: /azure/log-analytics/log-analytics-overview/
[BrokeredMessage.TimeToLive]: https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.timetolive.aspx
[cassandra-error-handling]: https://www.datastax.com/dev/blog/cassandra-error-handling-done-right
[circuit-breaker]: https://msdn.microsoft.com/library/dn589784.aspx
[cosmosdb-multi-region]: /azure/cosmos-db/tutorial-global-distribution-sql-api
[elasticsearch-azure]: ../elasticsearch/index.md
[elasticsearch-client]: https://www.elastic.co/guide/en/elasticsearch/client/index.html
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[onstop-events]: https://azure.microsoft.com/blog/the-right-way-to-handle-azure-onstop-events/
[lb-monitor]: /azure/load-balancer/load-balancer-monitor-log/
[lb-probe]: /azure/load-balancer/load-balancer-custom-probe-overview/#learn-about-the-types-of-probes
[new-relic]: https://newrelic.com/
[priority-queue-pattern]: https://msdn.microsoft.com/library/dn589794.aspx
[queue-based-load-leveling]: https://msdn.microsoft.com/library/dn589783.aspx
[QuotaExceededException]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.quotaexceededexception.aspx
[ra-web-apps-basic]: ../reference-architectures/app-service-web-app/basic-web-app.md
[redis-monitor]: /azure/redis-cache/cache-how-to-monitor/
[redis-retry]: ../best-practices/retry-service-specific.md#azure-redis-cache
[resilience-by-design-pdf]: https://download.microsoft.com/download/D/8/C/D8C599A4-4E8A-49BF-80EE-FE35F49B914D/Resilience_by_Design_for_Cloud_Services_White_Paper.pdf
[RoleEntryPoint.OnStop]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx
[RoleEnvironment.Stopping]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx
[rm-locks]: /azure/azure-resource-manager/resource-group-lock-resources/
[sb-dead-letter-queue]: /azure/service-bus-messaging/service-bus-dead-letter-queues/
[sb-georeplication-sample]: https://github.com/Azure-Samples/azure-servicebus-messaging-samples/tree/master/GeoReplication
[sb-messagingexception-class]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingexception.aspx
[sb-messaging-exceptions]: /azure/service-bus-messaging/service-bus-messaging-exceptions/
[sb-outages]: /azure/service-bus-messaging/service-bus-outages-disasters/#protecting-queues-and-topics-against-datacenter-outages-or-disasters
[sb-partition]: /azure/service-bus-messaging/service-bus-partitioning/
[sb-poison-message]: /azure/app-service-web/websites-dotnet-webjobs-sdk-storage-queues-how-to/#poison
[sb-retry]: ../best-practices/retry-service-specific.md#service-bus
[search-sdk]: https://msdn.microsoft.com/library/dn951165.aspx
[scheduler-agent-supervisor]: https://msdn.microsoft.com/library/dn589780.aspx
[search-analytics]: /azure/search/search-traffic-analytics/
[sql-db-audit]: /azure/sql-database/sql-database-auditing-get-started/
[sql-db-errors]: /azure/sql-database/sql-database-develop-error-messages/#resource-governance-errors
[sql-db-failover]: /azure/sql-database/sql-database-geo-replication-failover-portal/
[sql-db-limits]: /azure/sql-database/sql-database-resource-limits/
[sql-db-replication]: /azure/sql-database/sql-database-geo-replication-overview/
[storage-metrics]: https://msdn.microsoft.com/library/dn782843.aspx
[storage-replication]: /azure/storage/storage-redundancy/
[Storage.RetryPolicies]: https://msdn.microsoft.com/library/microsoft.windowsazure.storage.retrypolicies.aspx
[sys.event_log]: https://msdn.microsoft.com/library/dn270018.aspx
[throttling-pattern]: https://msdn.microsoft.com/library/dn589798.aspx
[web-jobs]: /azure/app-service-web/web-sites-create-web-jobs/
[web-jobs-shutdown]: /azure/app-service-web/websites-dotnet-webjobs-sdk-storage-queues-how-to/#graceful
