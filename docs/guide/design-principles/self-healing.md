---
title: "Разработка с учетом самовосстановления"
description: "Устойчивые приложения могут выполнять восстановление после сбоев самостоятельно, без вмешательства оператора."
author: MikeWasson
layout: LandingPage
ms.openlocfilehash: 0782b65b77615f7c006724264ab0ca2d2c7c04e2
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="design-for-self-healing"></a>Разработка с учетом самовосстановления

## <a name="design-your-application-to-be-self-healing-when-failures-occur"></a>Разрабатывая приложение, предусмотрите возможность его самовосстановления при сбоях

В любой распределенной системе иногда происходят сбои. Например, может отказать оборудование. В сети могут возникнуть временные сбои. В редких случаях проблемы могут нарушить работу целой службы или даже региона, но для всех таких случаев должен быть план действий.

Поэтому мы рекомендуем реализовать в приложении возможность самовосстановления при сбоях. Для этого подход должен быть следующим:

- Определяйте сбои.
- Корректно обрабатывайте сбои.
- Регистрируйте и отслеживайте ошибки, чтобы получить информацию об условиях работы.

Реагирование на сбои определенного типа зависит от требований к доступности приложения. Например, если предполагается очень высокая доступность, можно настроить автоматическую обработку отказа в дополнительный регион. Но это будет стоить дороже, чем развертывание в одном регионе. 

Кроме того, нужно учитывать не только глобальные сбои, затрагивающие весь регион, которые к тому же довольно редки. Следует уделять не меньше (или даже больше) внимания обработке локальных и кратковременных сбоев, таких как неполадки сетевого подключения или неудачные подключения к базе данных.

## <a name="recommendations"></a>Рекомендации

**Настройте механизм повторных попыток при неудачных операциях**. Временные сбои могут быть связаны с кратковременной потерей сетевого соединения, отсутствием подключения к базе данных или истечением времени ожидания, когда служба занята. Реализуйте в приложении логику повторных попыток, чтобы справиться с временными сбоями. Для многих служб Azure механизм автоматических повторных попыток реализован в клиентском пакете SDK. См. дополнительные сведения об [обработке временных сбоев][transient-fault-handling] и [шаблоне повторных попыток][retry].

**Обеспечивайте защиту удаленных служб (автоматическое выключение)**. Повторные попытки дают хороший результат при временных сбоях, но если ошибка не будет устранена, накопится слишком много вызывающих объектов, пытающихся подключиться к проблемной службе. Это чревато каскадными сбоями из-за превышения допустимого объема запросов. Используйте [шаблон автоматического выключения][circuit-breaker], чтобы быстро завершить процесс и не выполнять удаленный вызов при высокой вероятности сбоя.  

**Изолируйте критические ресурсы (распределительный блок)**. Проблема в одной подсистеме иногда приводит к каскадным сбоям. Это может произойти, когда из-за отказа некоторые ресурсы, такие как потоки или сокеты, не освобождаются своевременно, что приводит к исчерпанию ресурсов. Чтобы избежать этого, постарайтесь разделить систему на изолированные группы, чтобы сбой в одном разделе не влиял на всю систему.  

**Выравнивайте нагрузку**. Приложения могут испытывать внезапные всплески трафика, которые приводят к чрезмерной нагрузке серверных служб. Чтобы избежать этого, используйте [шаблон балансировки нагрузки на основе очередей][load-level], чтобы накапливать задания в очереди для асинхронного выполнения. Очередь работает как буфер, который сглаживает высокие пики нагрузки. 

**Выполняйте отработку отказа**. Если один экземпляр становится недоступным, переносите работу на другой экземпляр. Для веб-серверов и других компонентов, которые не отслеживают состояние, достаточно просто поместить несколько экземпляров за подсистемой балансировки нагрузки или диспетчером трафика. Если это служба с сохранением состояния, например база данных, используйте реплики и процессы отработки отказа. В зависимости от характеристик хранилища данных и методов репликации, приложению придется выполнять некоторые действия для обеспечения согласованности в конечном счете. 

**Компенсируйте проблемные транзакции**. По возможности старайтесь не использовать распределенные транзакции, так как они требуют координации между службами и ресурсами. Составляйте нужные операции из нескольких отдельных транзакций меньшего размера. Если же в середине такой операции происходит сбой, используйте [компенсирующие транзакции][compensating-transactions] для отмены уже внесенных в этой операции изменений. 

**Используйте контрольные точки для длительных транзакций**. Контрольные точки обеспечивают устойчивость при сбоях длительной операции. Они позволяют возобновлять операцию (например, на другой виртуальной машине) не с самого начала, а с последней успешной контрольной точки.

**Корректно снижайте производительность**. Иногда устранить неполадки не получается, но можно сохранить для пользователей ограниченную функциональность приложения. Рассмотрим приложение, которое отображает каталог книг. Если это приложение не может получить эскиз обложки, просто используйте изображение-заполнитель. Иногда работа приложения может не зависеть от целых подсистем. Например, на сайте электронной коммерции отображение рекомендаций по товарам является менее важным, чем обработка заказов.

**Выполняйте регулирование клиентов**. Иногда небольшое количество пользователей создает избыточную нагрузку, что снижает доступность приложения для других пользователей. Выполняйте регулирование таких клиентов на определенный период времени. Смю дополнительные сведения о [шаблоне регулирования][throttle].

**Блокируйте клиентов, совершающих недопустимые действия**. Регулирование клиента не означает, что такой клиент является злоумышленником. Он всего лишь превысил квоту на использование службы. Но если клиент превышает квоту постоянно или совершает другие некорректные действия, его можно заблокировать. Определите отдельный процесс для таких случаев, чтобы клиент мог запросить снятие блокировки.

**Используйте шаблон выборов лидера**. Если некоторая задача требует координации действий, используйте шаблон [выбора лидера][leader-election] для назначения координирующего субъекта. В такой схеме координатор не становится единой точкой отказа. Если происходит сбой координатора, просто выбирается новый. Чтобы не создавать с нуля алгоритм выбора лидера, попробуйте применить готовое решение, например Zookeeper.  

**Выполняйте тестирование путем внесения ошибок**. Очень часто бывает так, что хорошо протестирован только "правильный" процесс, но не функционирование в случае ошибок. В рабочей среде системе может потребоваться много времени, чтобы запустить алгоритм обработки ошибок. Проверьте отказоустойчивость системы путем внесения ошибок, отключая реальные службы или моделируя сбой программным образом. 

**Применяйте хаотическую разработку**. Модель хаоса является логичным продолжением модели внесения ошибок. Она подразумевает регулярное внедрение случайных сбоев или аномальных состояний в экземпляры рабочей среды. 

Структурированный подход к самовосстановлению приложений описан в статье [Проектирование устойчивых приложений для Azure][resiliency-overview].  

[circuit-breaker]: ../../patterns/circuit-breaker.md
[compensating-transactions]: ../../patterns/compensating-transaction.md
[leader-election]: ../../patterns/leader-election.md
[load-level]: ../../patterns/queue-based-load-leveling.md
[resiliency-overview]: ../../resiliency/index.md
[retry]: ../../patterns/retry.md
[throttle]: ../../patterns/throttling.md
[transient-fault-handling]: ../../best-practices/transient-faults.md

