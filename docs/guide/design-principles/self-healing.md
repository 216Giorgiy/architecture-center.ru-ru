---
title: Разработка с учетом самовосстановления
titleSuffix: Azure Application Architecture Guide
description: Устойчивые приложения могут выполнять восстановление после сбоев самостоятельно, без вмешательства оператора.
author: MikeWasson
ms.date: 08/30/2018
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seojan19
ms.openlocfilehash: 5e5af0be41fa892e490d556ef4286d5367144fd9
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58249509"
---
# <a name="design-for-self-healing"></a><span data-ttu-id="0138b-103">Разработка с учетом самовосстановления</span><span class="sxs-lookup"><span data-stu-id="0138b-103">Design for self healing</span></span>

## <a name="design-your-application-to-be-self-healing-when-failures-occur"></a><span data-ttu-id="0138b-104">Разрабатывая приложение, предусмотрите возможность его самовосстановления при сбоях</span><span class="sxs-lookup"><span data-stu-id="0138b-104">Design your application to be self healing when failures occur</span></span>

<span data-ttu-id="0138b-105">В любой распределенной системе иногда происходят сбои.</span><span class="sxs-lookup"><span data-stu-id="0138b-105">In a distributed system, failures happen.</span></span> <span data-ttu-id="0138b-106">Например, может отказать оборудование.</span><span class="sxs-lookup"><span data-stu-id="0138b-106">Hardware can fail.</span></span> <span data-ttu-id="0138b-107">В сети могут возникнуть временные сбои.</span><span class="sxs-lookup"><span data-stu-id="0138b-107">The network can have transient failures.</span></span> <span data-ttu-id="0138b-108">В редких случаях проблемы могут нарушить работу целой службы или даже региона, но для всех таких случаев должен быть план действий.</span><span class="sxs-lookup"><span data-stu-id="0138b-108">Rarely, an entire service or region may experience a disruption, but even those must be planned for.</span></span>

<span data-ttu-id="0138b-109">Поэтому мы рекомендуем реализовать в приложении возможность самовосстановления при сбоях.</span><span class="sxs-lookup"><span data-stu-id="0138b-109">Therefore, design an application to be self healing when failures occur.</span></span> <span data-ttu-id="0138b-110">Для этого подход должен быть следующим:</span><span class="sxs-lookup"><span data-stu-id="0138b-110">This requires a three-pronged approach:</span></span>

- <span data-ttu-id="0138b-111">Определяйте сбои.</span><span class="sxs-lookup"><span data-stu-id="0138b-111">Detect failures.</span></span>
- <span data-ttu-id="0138b-112">Корректно обрабатывайте сбои.</span><span class="sxs-lookup"><span data-stu-id="0138b-112">Respond to failures gracefully.</span></span>
- <span data-ttu-id="0138b-113">Регистрируйте и отслеживайте ошибки, чтобы получить информацию об условиях работы.</span><span class="sxs-lookup"><span data-stu-id="0138b-113">Log and monitor failures, to give operational insight.</span></span>

<span data-ttu-id="0138b-114">Реагирование на сбои определенного типа зависит от требований к доступности приложения.</span><span class="sxs-lookup"><span data-stu-id="0138b-114">How you respond to a particular type of failure may depend on your application's availability requirements.</span></span> <span data-ttu-id="0138b-115">Например, если предполагается очень высокая доступность, можно настроить автоматическую обработку отказа в дополнительный регион.</span><span class="sxs-lookup"><span data-stu-id="0138b-115">For example, if you require very high availability, you might automatically fail over to a secondary region during a regional outage.</span></span> <span data-ttu-id="0138b-116">Но это будет стоить дороже, чем развертывание в одном регионе.</span><span class="sxs-lookup"><span data-stu-id="0138b-116">However, that will incur a higher cost than a single-region deployment.</span></span>

<span data-ttu-id="0138b-117">Кроме того, нужно учитывать не только глобальные сбои, затрагивающие весь регион, которые к тому же довольно редки.</span><span class="sxs-lookup"><span data-stu-id="0138b-117">Also, don't just consider big events like regional outages, which are generally rare.</span></span> <span data-ttu-id="0138b-118">Следует уделять не меньше (или даже больше) внимания обработке локальных и кратковременных сбоев, таких как неполадки сетевого подключения или неудачные подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="0138b-118">You should focus as much, if not more, on handling local, short-lived failures, such as network connectivity failures or failed database connections.</span></span>

## <a name="recommendations"></a><span data-ttu-id="0138b-119">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="0138b-119">Recommendations</span></span>

<span data-ttu-id="0138b-120">**Настройте механизм повторных попыток при неудачных операциях**.</span><span class="sxs-lookup"><span data-stu-id="0138b-120">**Retry failed operations**.</span></span> <span data-ttu-id="0138b-121">Временные сбои могут быть связаны с кратковременной потерей сетевого соединения, отсутствием подключения к базе данных или истечением времени ожидания, когда служба занята.</span><span class="sxs-lookup"><span data-stu-id="0138b-121">Transient failures may occur due to momentary loss of network connectivity, a dropped database connection, or a timeout when a service is busy.</span></span> <span data-ttu-id="0138b-122">Реализуйте в приложении логику повторных попыток, чтобы справиться с временными сбоями.</span><span class="sxs-lookup"><span data-stu-id="0138b-122">Build retry logic into your application to handle transient failures.</span></span> <span data-ttu-id="0138b-123">Для многих служб Azure механизм автоматических повторных попыток реализован в клиентском пакете SDK.</span><span class="sxs-lookup"><span data-stu-id="0138b-123">For many Azure services, the client SDK implements automatic retries.</span></span> <span data-ttu-id="0138b-124">См. дополнительные сведения об [обработке временных сбоев][transient-fault-handling] и [шаблоне повторных попыток][retry].</span><span class="sxs-lookup"><span data-stu-id="0138b-124">For more information, see [Transient fault handling][transient-fault-handling] and the [Retry pattern][retry].</span></span>

<span data-ttu-id="0138b-125">**Обеспечивайте защиту удаленных служб (автоматическое выключение)**.</span><span class="sxs-lookup"><span data-stu-id="0138b-125">**Protect failing remote services (Circuit Breaker)**.</span></span> <span data-ttu-id="0138b-126">Повторные попытки дают хороший результат при временных сбоях, но если ошибка не будет устранена, накопится слишком много вызывающих объектов, пытающихся подключиться к проблемной службе.</span><span class="sxs-lookup"><span data-stu-id="0138b-126">It's good to retry after a transient failure, but if the failure persists, you can end up with too many callers hammering a failing service.</span></span> <span data-ttu-id="0138b-127">Это чревато каскадными сбоями из-за превышения допустимого объема запросов.</span><span class="sxs-lookup"><span data-stu-id="0138b-127">This can lead to cascading failures, as requests back up.</span></span> <span data-ttu-id="0138b-128">Используйте [шаблон автоматического выключения][circuit-breaker], чтобы процесс завершался при первой ошибке без выполнения удаленного вызова в случае высокой вероятности сбоя.</span><span class="sxs-lookup"><span data-stu-id="0138b-128">Use the [Circuit Breaker pattern][circuit-breaker] to fail fast (without making the remote call) when an operation is likely to fail.</span></span>

<span data-ttu-id="0138b-129">**Изолируйте критические ресурсы (распределительный блок)**.</span><span class="sxs-lookup"><span data-stu-id="0138b-129">**Isolate critical resources (Bulkhead)**.</span></span> <span data-ttu-id="0138b-130">Проблема в одной подсистеме иногда приводит к каскадным сбоям.</span><span class="sxs-lookup"><span data-stu-id="0138b-130">Failures in one subsystem can sometimes cascade.</span></span> <span data-ttu-id="0138b-131">Это может произойти, когда из-за отказа некоторые ресурсы, такие как потоки или сокеты, не освобождаются своевременно, что приводит к исчерпанию ресурсов.</span><span class="sxs-lookup"><span data-stu-id="0138b-131">This can happen if a failure causes some resources, such as threads or sockets, not to get freed in a timely manner, leading to resource exhaustion.</span></span> <span data-ttu-id="0138b-132">Чтобы избежать этого, постарайтесь разделить систему на изолированные группы, чтобы сбой в одном разделе не влиял на всю систему.</span><span class="sxs-lookup"><span data-stu-id="0138b-132">To avoid this, partition a system into isolated groups, so that a failure in one partition does not bring down the entire system.</span></span>

<span data-ttu-id="0138b-133">**Выравнивайте нагрузку**.</span><span class="sxs-lookup"><span data-stu-id="0138b-133">**Perform load leveling**.</span></span> <span data-ttu-id="0138b-134">Приложения могут испытывать внезапные всплески трафика, которые приводят к чрезмерной нагрузке серверных служб.</span><span class="sxs-lookup"><span data-stu-id="0138b-134">Applications may experience sudden spikes in traffic that can overwhelm services on the backend.</span></span> <span data-ttu-id="0138b-135">Чтобы избежать этого, используйте [шаблон балансировки нагрузки на основе очередей][load-level], чтобы накапливать задания в очереди для асинхронного выполнения.</span><span class="sxs-lookup"><span data-stu-id="0138b-135">To avoid this, use the [Queue-Based Load Leveling pattern][load-level] to queue work items to run asynchronously.</span></span> <span data-ttu-id="0138b-136">Очередь работает как буфер, который сглаживает высокие пики нагрузки.</span><span class="sxs-lookup"><span data-stu-id="0138b-136">The queue acts as a buffer that smooths out peaks in the load.</span></span>

<span data-ttu-id="0138b-137">**Выполняйте отработку отказа**.</span><span class="sxs-lookup"><span data-stu-id="0138b-137">**Fail over**.</span></span> <span data-ttu-id="0138b-138">Если один экземпляр становится недоступным, переносите работу на другой экземпляр.</span><span class="sxs-lookup"><span data-stu-id="0138b-138">If an instance can't be reached, fail over to another instance.</span></span> <span data-ttu-id="0138b-139">Для веб-серверов и других компонентов, которые не отслеживают состояние, достаточно просто поместить несколько экземпляров за подсистемой балансировки нагрузки или диспетчером трафика.</span><span class="sxs-lookup"><span data-stu-id="0138b-139">For things that are stateless, like a web server, put several instances behind a load balancer or traffic manager.</span></span> <span data-ttu-id="0138b-140">Если это служба с сохранением состояния, например база данных, используйте реплики и процессы отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="0138b-140">For things that store state, like a database, use replicas and fail over.</span></span> <span data-ttu-id="0138b-141">В зависимости от характеристик хранилища данных и методов репликации, приложению придется выполнять некоторые действия для обеспечения согласованности в конечном счете.</span><span class="sxs-lookup"><span data-stu-id="0138b-141">Depending on the data store and how it replicates, this may require the application to deal with eventual consistency.</span></span>

<span data-ttu-id="0138b-142">**Компенсируйте проблемные транзакции**.</span><span class="sxs-lookup"><span data-stu-id="0138b-142">**Compensate failed transactions**.</span></span> <span data-ttu-id="0138b-143">По возможности старайтесь не использовать распределенные транзакции, так как они требуют координации между службами и ресурсами.</span><span class="sxs-lookup"><span data-stu-id="0138b-143">In general, avoid distributed transactions, as they require coordination across services and resources.</span></span> <span data-ttu-id="0138b-144">Составляйте нужные операции из нескольких отдельных транзакций меньшего размера.</span><span class="sxs-lookup"><span data-stu-id="0138b-144">Instead, compose an operation from smaller individual transactions.</span></span> <span data-ttu-id="0138b-145">Если же в середине такой операции происходит сбой, используйте [компенсирующие транзакции][compensating-transactions] для отмены уже внесенных в этой операции изменений.</span><span class="sxs-lookup"><span data-stu-id="0138b-145">If the operation fails midway through, use [Compensating Transactions][compensating-transactions] to undo any step that already completed.</span></span>

<span data-ttu-id="0138b-146">**Используйте контрольные точки для длительных транзакций**.</span><span class="sxs-lookup"><span data-stu-id="0138b-146">**Checkpoint long-running transactions**.</span></span> <span data-ttu-id="0138b-147">Контрольные точки обеспечивают устойчивость при сбоях длительной операции.</span><span class="sxs-lookup"><span data-stu-id="0138b-147">Checkpoints can provide resiliency if a long-running operation fails.</span></span> <span data-ttu-id="0138b-148">Они позволяют возобновлять операцию (например, на другой виртуальной машине) не с самого начала, а с последней успешной контрольной точки.</span><span class="sxs-lookup"><span data-stu-id="0138b-148">When the operation restarts (for example, it is picked up by another VM), it can be resumed from the last checkpoint.</span></span>

<span data-ttu-id="0138b-149">**Корректно снижайте производительность**.</span><span class="sxs-lookup"><span data-stu-id="0138b-149">**Degrade gracefully**.</span></span> <span data-ttu-id="0138b-150">Иногда устранить неполадки не получается, но можно сохранить для пользователей ограниченную функциональность приложения.</span><span class="sxs-lookup"><span data-stu-id="0138b-150">Sometimes you can't work around a problem, but you can provide reduced functionality that is still useful.</span></span> <span data-ttu-id="0138b-151">Рассмотрим приложение, которое отображает каталог книг.</span><span class="sxs-lookup"><span data-stu-id="0138b-151">Consider an application that shows a catalog of books.</span></span> <span data-ttu-id="0138b-152">Если это приложение не может получить эскиз обложки, просто используйте изображение-заполнитель.</span><span class="sxs-lookup"><span data-stu-id="0138b-152">If the application can't retrieve the thumbnail image for the cover, it might show a placeholder image.</span></span> <span data-ttu-id="0138b-153">Иногда работа приложения может не зависеть от целых подсистем.</span><span class="sxs-lookup"><span data-stu-id="0138b-153">Entire subsystems might be noncritical for the application.</span></span> <span data-ttu-id="0138b-154">Например, на сайте электронной коммерции отображение рекомендаций по товарам является менее важным, чем обработка заказов.</span><span class="sxs-lookup"><span data-stu-id="0138b-154">For example, in an e-commerce site, showing product recommendations is probably less critical than processing orders.</span></span>

<span data-ttu-id="0138b-155">**Выполняйте регулирование клиентов**.</span><span class="sxs-lookup"><span data-stu-id="0138b-155">**Throttle clients**.</span></span> <span data-ttu-id="0138b-156">Иногда небольшое количество пользователей создает избыточную нагрузку, что снижает доступность приложения для других пользователей.</span><span class="sxs-lookup"><span data-stu-id="0138b-156">Sometimes a small number of users create excessive load, which can reduce your application's availability for other users.</span></span> <span data-ttu-id="0138b-157">Выполняйте регулирование таких клиентов на определенный период времени.</span><span class="sxs-lookup"><span data-stu-id="0138b-157">In this situation, throttle the client for a certain period of time.</span></span> <span data-ttu-id="0138b-158">См. дополнительные сведения о [шаблоне регулирования][throttle].</span><span class="sxs-lookup"><span data-stu-id="0138b-158">See the [Throttling pattern][throttle].</span></span>

<span data-ttu-id="0138b-159">**Блокируйте клиентов, совершающих недопустимые действия**.</span><span class="sxs-lookup"><span data-stu-id="0138b-159">**Block bad actors**.</span></span> <span data-ttu-id="0138b-160">Регулирование клиента не означает, что такой клиент является злоумышленником.</span><span class="sxs-lookup"><span data-stu-id="0138b-160">Just because you throttle a client, it doesn't mean client was acting maliciously.</span></span> <span data-ttu-id="0138b-161">Он всего лишь превысил квоту на использование службы.</span><span class="sxs-lookup"><span data-stu-id="0138b-161">It just means the client exceeded their service quota.</span></span> <span data-ttu-id="0138b-162">Но если клиент превышает квоту постоянно или совершает другие некорректные действия, его можно заблокировать.</span><span class="sxs-lookup"><span data-stu-id="0138b-162">But if a client consistently exceeds their quota or otherwise behaves badly, you might block them.</span></span> <span data-ttu-id="0138b-163">Определите отдельный процесс для таких случаев, чтобы клиент мог запросить снятие блокировки.</span><span class="sxs-lookup"><span data-stu-id="0138b-163">Define an out-of-band process for user to request getting unblocked.</span></span>

<span data-ttu-id="0138b-164">**Используйте шаблон выборов лидера**.</span><span class="sxs-lookup"><span data-stu-id="0138b-164">**Use leader election**.</span></span> <span data-ttu-id="0138b-165">Если некоторая задача требует координации действий, используйте шаблон [выбора лидера][leader-election] для назначения координирующего субъекта.</span><span class="sxs-lookup"><span data-stu-id="0138b-165">When you need to coordinate a task, use [Leader Election][leader-election] to select a coordinator.</span></span> <span data-ttu-id="0138b-166">В такой схеме координатор не становится единой точкой отказа.</span><span class="sxs-lookup"><span data-stu-id="0138b-166">That way, the coordinator is not a single point of failure.</span></span> <span data-ttu-id="0138b-167">Если происходит сбой координатора, просто выбирается новый.</span><span class="sxs-lookup"><span data-stu-id="0138b-167">If the coordinator fails, a new one is selected.</span></span> <span data-ttu-id="0138b-168">Чтобы не создавать с нуля алгоритм выбора лидера, попробуйте применить готовое решение, например Zookeeper.</span><span class="sxs-lookup"><span data-stu-id="0138b-168">Rather than implement a leader election algorithm from scratch, consider an off-the-shelf solution such as Zookeeper.</span></span>

<span data-ttu-id="0138b-169">**Выполняйте тестирование путем внесения ошибок**.</span><span class="sxs-lookup"><span data-stu-id="0138b-169">**Test with fault injection**.</span></span> <span data-ttu-id="0138b-170">Очень часто бывает так, что хорошо протестирован только "правильный" процесс, но не функционирование в случае ошибок.</span><span class="sxs-lookup"><span data-stu-id="0138b-170">All too often, the success path is well tested but not the failure path.</span></span> <span data-ttu-id="0138b-171">В рабочей среде системе может потребоваться много времени, чтобы запустить алгоритм обработки ошибок.</span><span class="sxs-lookup"><span data-stu-id="0138b-171">A system could run in production for a long time before a failure path is exercised.</span></span> <span data-ttu-id="0138b-172">Проверьте отказоустойчивость системы путем внесения ошибок, отключая реальные службы или моделируя сбой программным образом.</span><span class="sxs-lookup"><span data-stu-id="0138b-172">Use fault injection to test the resiliency of the system to failures, either by triggering actual failures or by simulating them.</span></span>

<span data-ttu-id="0138b-173">**Применяйте хаотическую разработку**.</span><span class="sxs-lookup"><span data-stu-id="0138b-173">**Embrace chaos engineering**.</span></span> <span data-ttu-id="0138b-174">Модель хаоса является логичным продолжением модели внесения ошибок. Она подразумевает регулярное внедрение случайных сбоев или аномальных состояний в экземпляры рабочей среды.</span><span class="sxs-lookup"><span data-stu-id="0138b-174">Chaos engineering extends the notion of fault injection, by randomly injecting failures or abnormal conditions into production instances.</span></span>

<span data-ttu-id="0138b-175">Структурированный подход к самовосстановлению приложений описан в статье [Проектирование устойчивых приложений для Azure][resiliency-overview].</span><span class="sxs-lookup"><span data-stu-id="0138b-175">For a structured approach to making your applications self healing, see [Design resilient applications for Azure][resiliency-overview].</span></span>

<!-- links -->

[circuit-breaker]: ../../patterns/circuit-breaker.md
[compensating-transactions]: ../../patterns/compensating-transaction.md
[leader-election]: ../../patterns/leader-election.md
[load-level]: ../../patterns/queue-based-load-leveling.md
[resiliency-overview]: ../../resiliency/index.md
[retry]: ../../patterns/retry.md
[throttle]: ../../patterns/throttling.md
[transient-fault-handling]: ../../best-practices/transient-faults.md
