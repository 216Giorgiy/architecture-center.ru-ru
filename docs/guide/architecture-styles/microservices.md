---
title: Стиль архитектуры микрослужб
description: В этой статье описываются преимущества и недостатки архитектур микрослужб в Azure, а также рекомендации по работе с ними.
author: MikeWasson
ms.openlocfilehash: 08fd39b6cf0b3c88af654b27e21b2d7dd9fb19b1
ms.sourcegitcommit: 7764a804f000180c37a4f8dbab946b525f784f58
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2018
ms.locfileid: "27717646"
---
# <a name="microservices-architecture-style"></a>Стиль архитектуры микрослужб

Архитектура микрослужб представляет собой набор небольших автономных служб. Каждая служба является самодостаточной и должна реализовывать возможности одной компании. Подробное руководство по разработке архитектуры микрослужб в Azure см. в статье [Проектирование, создание и использование микрослужб в Azure](../../microservices/index.md).

![](./images/microservices-logical.svg)
 
В каком-то смысле микрослужбы являются естественным результатом развития сервисноориентированных архитектур (SOA). Но микрослужбы и SOA отличаются. Ниже приведены определяющие характеристики микрослужбы.

- Архитектура микрослужб состоит из небольших, независимых и слабо связанных между собой служб.

- Каждая служба является отдельной базой кода, которой может управлять небольшая команда разработчиков.

- Службы можно развертывать независимо друг от друга. Разработчики могут обновлять существующую службу без повторной сборки и повторного развертывания всего приложения.

- Службы отвечают за сохранение собственных данных или внешнего состояния. В этом состоит отличие от традиционной модели, в которой сохранение данных обрабатывается на отдельном уровне.

- Службы взаимодействуют между собой с помощью четко определенных API-интерфейсов. Сведения о внутренней реализации каждой службы скрыты от других служб.

- Службы не должны совместно использовать один и тот же стек технологий, библиотеки или платформы.

Помимо самих служб, некоторые компоненты обладают типичной архитектурой микрослужб:

**Управление.** Компонент управления отвечает за размещение служб на узлах, определение сбоев, перераспределение служб между узлами и другие операции.  

**Обнаружение служб.**  Этот компонент ведет список служб и узлов, на которых находятся службы. Он поддерживает поиск в службах, позволяя найти конечную точку службы. 

**Шлюз API.** Шлюз API является точкой входа для клиентов. Клиенты не вызывают службы напрямую. Вместо этого они вызывают шлюз API, который пересылает вызов соответствующим службам в серверной части. Шлюз API может собирать ответы от нескольких служб и возвращать совокупный ответ. 

Преимущества использования API шлюза:

- Он разделяет клиенты и службы. Можно управлять версиями служб и выполнять их рефакторинг без обновления всех клиентов.

-  Службы могут использовать протоколы обмена сообщениями, которые не работают в Интернете, например AMQP.

- Шлюз API может выполнять другие сквозные функции, например аутентификацию, ведение журнала, завершение запросов SSL и балансировку нагрузки.

## <a name="when-to-use-this-architecture"></a>Когда следует использовать эту архитектуру

Используйте эту архитектуру для следующих сценариев:

- крупные приложения, для которых требуется выпуск на высокой скорости;

- сложные приложения, которым нужна высокая степень масштабируемости;

- приложения с так называемыми "толстыми" доменами или большим количеством поддоменов;

- организация, состоящая из небольших команд разработчиков.


## <a name="benefits"></a>Преимущества 

- **Независимые развертывания.** Вы можете обновить службу без повторного развертывания всего приложения, а также выполнить откат или накат обновления, если что-то работает неправильно. Исправления ошибок и выпуски компонентов лучше поддаются управлению и в меньшей степени сопряжены с рисками.

- **Независимая разработка.** Одна команда разработчиков может выполнить сборку, тестирование и развертывание службы. Это позволяет непрерывно внедрять инновации и быстрее выпускать службы. 

- **Небольшие специализированные команды.** Команда может сосредоточиться на одной службе. Чем меньше объем каждой службы, тем проще понять ее базу кода и тем легче будет его освоить новым членам команды.

- **Изоляция ошибок.** Если одна служба выходит из строя, приложение продолжает работать. Но это не означает, что такая устойчивость доступна по умолчанию. Вам необходимо соблюдать рекомендации по обеспечению устойчивости и следовать конструктивным шаблонам. См. статью о [проектировании устойчивых приложений для Azure][resiliency-overview].

- **Стеки смешанных технологий.** Команды могут выбрать технологию, которая лучше всего подходит их службе. 

- **Детальное масштабирование.** Службы можно масштабировать независимо друг от друга. В то же время из-за более высокой плотности служб на одной виртуальной машине ее ресурсы будут полностью использованы. Благодаря ограничениям размещения службы можно привести в соответствие с профилем виртуальной машины (высокая загрузка ЦП, большой объем памяти и т. д.).

## <a name="challenges"></a>Сложности

- **Сложность.** Приложение для микрослужб содержит больше перемещаемых частей, чем эквивалентное монолитное приложение. Каждая служба является простой структурой, но вся система в целом гораздо сложнее.

- **Разработка и тестирование.** Разработка с учетом зависимостей между службами требует другого подхода. Существующие средства не всегда предназначены для работы с зависимостями служб. Рефакторинг между службами может быть сложной задачей. Также непросто тестировать зависимости служб, особенно если приложение быстро изменяется.

- **Недостаток управления.** Децентрализованный подход к созданию микрослужб имеет свои преимущества, но он также может привести к проблемам. В приложении может появиться так много разных языков и платформ, что его будет трудно обслуживать. Можно попробовать установить некоторые стандарты для всего проекта, не ограничивая чрезмерно гибкость разработчиков. В частности, это касается сквозных функций, таких как ведение журнала.

- **Перегрузки и задержки сети.** Использование большого количества мелких детальных служб может привести к интенсивному взаимодействию между ними. Кроме того, если цепочка зависимостей службы становится слишком длинной (служба A вызывает службу B, которая вызывает службу C и так далее), дополнительная задержка может стать проблемой. Необходимо тщательно разрабатывать API-интерфейсы. Не создавайте API-интерфейсы, которые отправляют слишком много сообщений, и найдите места, в которых можно использовать асинхронные модели связи.

- **Целостность данных.** Каждая микрослужба отвечает за сохранение своих данных. Поэтому может быть сложно поддерживать согласованность данных. Применяйте итоговую согласованность, где это возможно.

- **Управление.** Для успешной работы с микрослужбами требуется современная культура DevOps. Коррелированное ведение журнала для разных служб может оказаться сложной задачей. Как правило, ведение журнала необходимо коррелировать с несколькими вызовами службы для одной операции пользователя.

- **Управление версиями.** Обновления службы не должны нарушать работу служб, зависящих от нее. Несколько служб могут обновляться в любой момент времени, поэтому без тщательного планирования могут возникнуть проблемы с обратной или прямой совместимостью.

- **Набор навыков.** Микрослужбы являются распределенными системами. Тщательно оцените знания и опыт своей команды для работы с этими службами.

## <a name="best-practices"></a>Рекомендации

- Моделируйте службы для определенной сферы деятельности. 

- Децентрализуйте все данные. Отдельные команды разработчиков отвечают за проектирование и создание служб. Избегайте совместного использования кода или схем данных. 

- Данные должны храниться в службе, к которой они относятся. Используйте наиболее подходящее хранилище для каждой службы и каждого типа данных. 

- Службы взаимодействуют через хорошо спроектированные API-интерфейсы. Избегайте утечки сведений о реализации. API-интерфейсы должны моделировать домен, а не внутреннюю реализацию службы.

- Избегайте взаимозависимостей между службами. Взаимозависимости могут возникать при использовании общих схем баз данных и жестких протоколов связи.

- Перенесите нагрузку сквозных функций, таких как аутентификация и завершение SSL-запросов, в шлюз.

- Храните набор знаний домена за пределами шлюза. Шлюз должен обрабатывать и перенаправлять клиентские запросы без знания бизнес-правил или логики домена. Иначе шлюз становится зависимостью и может привести к взаимозависимости между службами.

- Службы должны иметь слабую взаимозависимость и высокую функциональную слаженность. Функции, которые, вероятно, будут изменяться одновременно, должны упаковываться и развертываться одновременно. Если они находятся в отдельных службах, эти службы в конечном итоге становятся тесно связанными, потому что изменения в одной службе требуют обновления другой службы. Слишком частый обмен данными между двумя службами может быть признаком тесной взаимозависимости и низкой слаженности. 

- Изолируйте сбои. Используйте стратегии обеспечения устойчивости для предотвращения каскадных сбоев в службе. См. статьи о [шаблонах устойчивости][resiliency-patterns] и [проектировании устойчивых приложений][resiliency-overview].

## <a name="microservices-using-azure-container-service"></a>Микрослужбы, использующие службу контейнеров Azure 

[Службу контейнеров Azure](/azure/container-service/) можно использовать для настройки и подготовки кластера Docker. Служба контейнеров Azure поддерживает несколько популярных оркестраторов контейнеров, среди которых Kubernetes, DC/OS и Docker Swarm.

![](./images/microservices-acs.png)
 
**Общедоступные узлы.** Эти узлы доступны через общедоступную подсистему балансировки нагрузки. Шлюз API размещается на этих узлах.

**Узлы серверной части.** На этих узлах работают службы, к которым клиенты получают доступ через шлюз API. Эти узлы не получают интернет-трафик напрямую. Узлы серверной части могут включать несколько пулов виртуальных машин с различными профилями оборудования. Например, можно создать отдельные пулы для общих вычислительных рабочих нагрузок, рабочих нагрузок с высокой загрузкой ЦП и рабочих нагрузок с использованием большого объема памяти. 

**Виртуальные машины управления.** На этих виртуальных машинах работают главные узлы оркестратора контейнеров. 

**Сеть.** Общедоступные узлы, узлы серверной части и виртуальные машины управления помещаются в отдельные подсети в пределах одной виртуальной сети. 

**Подсистемы балансировки нагрузки.**  Внешняя подсистема балансировки нагрузки размещается перед общедоступными узлами. Она распределяет запросы из Интернета к общедоступным узлам. Другая подсистема балансировки нагрузки находится перед виртуальными машинами управления. Она пропускает безопасный трафик по протоколу Secure Shell (SSH) к этим виртуальным машинам, используя правила преобразования сетевых адресов.

Для обеспечения надежности и масштабируемости каждая служба реплицируется на несколько виртуальных машин. Но так как службы занимают относительно мало места (по сравнению с монолитными приложениями), несколько служб обычно размещаются на одной виртуальной машине. Высокая плотность обеспечивает эффективное использование ресурсов. Если определенная служба не использует много ресурсов, не нужно выделять всю виртуальную машину для выполнения этой службы.

На следующей схеме показаны три узла, на которых работают четыре разные службы (они обозначены разными фигурами). Обратите внимание, что каждая служба имеет по крайней мере два экземпляра. 
 
![](./images/microservices-node-density.png)

## <a name="microservices-using-azure-service-fabric"></a>Микрослужбы, использующие Azure Service Fabric

На приведенной ниже схеме показана архитектура микрослужб с использованием [Azure Service Fabric](/azure/service-fabric/).

![](./images/service-fabric.png)

Кластер Service Fabric развертывается в одном или нескольких масштабируемых наборах виртуальных машин. Если вам нужны виртуальные машины разных типов, в кластере может быть несколько масштабируемых наборов виртуальных машин. Шлюз API с внешней подсистемой балансировки нагрузки, которая получает запросы клиентов, помещается перед кластером Service Fabric.

Среда выполнения Service Fabric управляет кластером, в том числе выполняет размещение службы, отработку отказа узла и мониторинг работоспособности. Среда выполнения развертывается непосредственно на узлах кластера. Отдельного набора виртуальных машин для управления кластером нет.

Службы взаимодействуют между собой с помощью обратного прокси-сервера, встроенного в Service Fabric. Service Fabric предоставляет службу обнаружения, которая может разрешать конечную точку для конкретной службы.


<!-- links -->

[resiliency-overview]: ../../resiliency/index.md
[resiliency-patterns]: ../../patterns/category/resiliency.md



