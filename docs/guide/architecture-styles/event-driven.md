---
title: "Стиль архитектуры, управляемой событиями"
description: "В этой статье описаны преимущества и проблемы, связанные с управляемой событиями архитектурой и архитектурой Интернета вещей в Azure, а также рекомендации по работе с ними"
author: MikeWasson
ms.openlocfilehash: 3289bf784b02d62e3d0c1a29b4839c9be3501134
ms.sourcegitcommit: 3d9ee03e2dda23753661a80c7106d1789f5223bb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2018
---
# <a name="event-driven-architecture-style"></a><span data-ttu-id="9a61f-103">Стиль архитектуры, управляемой событиями</span><span class="sxs-lookup"><span data-stu-id="9a61f-103">Event-driven architecture style</span></span>

<span data-ttu-id="9a61f-104">Управляемая событиями архитектура включает **поставщики событий**, которые создают потоки событий, и **потребители событий**, которые прослушивают эти события.</span><span class="sxs-lookup"><span data-stu-id="9a61f-104">An event-driven architecture consists of **event producers** that generate a stream of events, and **event consumers** that listen for the events.</span></span> 

![](./images/event-driven.svg)

<span data-ttu-id="9a61f-105">События доставляются практически мгновенно, что позволяет потребителям немедленно реагировать на происходящие события.</span><span class="sxs-lookup"><span data-stu-id="9a61f-105">Events are delivered in near real time, so consumers can respond immediately to events as they occur.</span></span> <span data-ttu-id="9a61f-106">Поставщики не связаны с потребителями — ни один поставщик не знает, кто прослушивает его события.</span><span class="sxs-lookup"><span data-stu-id="9a61f-106">Producers are decoupled from consumers &mdash; a producer doesn't know which consumers are listening.</span></span> <span data-ttu-id="9a61f-107">Потребители также не зависят друг от друга, и каждый из них получает все события.</span><span class="sxs-lookup"><span data-stu-id="9a61f-107">Consumers are also decoupled from each other, and every consumer sees all of the events.</span></span> <span data-ttu-id="9a61f-108">Это важное отличие от шаблона [конкурирующих клиентов][competing-consumers], в котором пользователи извлекают сообщения из очереди, и каждое сообщение обрабатывается только один раз (если не возникает ошибок).</span><span class="sxs-lookup"><span data-stu-id="9a61f-108">This differs from a [Competing Consumers][competing-consumers] pattern, where consumers pull messages from a queue and a message is processed just once (assuming no errors).</span></span> <span data-ttu-id="9a61f-109">В некоторых системах, таких как Интернет вещей, события обрабатываются в огромных объемах.</span><span class="sxs-lookup"><span data-stu-id="9a61f-109">In some systems, such as IoT, events must be ingested at very high volumes.</span></span>

<span data-ttu-id="9a61f-110">В основе управляемой событиями архитектуры может лежать модель публикации и подписки или модель потока событий.</span><span class="sxs-lookup"><span data-stu-id="9a61f-110">An event driven architecture can use a pub/sub model or an event stream model.</span></span> 

- <span data-ttu-id="9a61f-111">**Публикация и подписка**. Инфраструктура обмена сообщениями поддерживает список подписок.</span><span class="sxs-lookup"><span data-stu-id="9a61f-111">**Pub/sub**: The messaging infrastructure keeps track of subscriptions.</span></span> <span data-ttu-id="9a61f-112">Каждое публикуемое событие отправляется каждому подписчику.</span><span class="sxs-lookup"><span data-stu-id="9a61f-112">When an event is published, it sends the event to each subscriber.</span></span> <span data-ttu-id="9a61f-113">Полученное сообщение нельзя воспроизвести повторно. Также оно не доставляется тем подписчикам, которые добавляются позднее.</span><span class="sxs-lookup"><span data-stu-id="9a61f-113">After an event is received, it cannot be replayed, and new subscribers do not see the event.</span></span> 

- <span data-ttu-id="9a61f-114">**Потоковая передача событий**. Все события записываются в журнал.</span><span class="sxs-lookup"><span data-stu-id="9a61f-114">**Event streaming**: Events are written to a log.</span></span> <span data-ttu-id="9a61f-115">События в пределах каждой секции строго упорядочены и сохраняются в течение долгого времени.</span><span class="sxs-lookup"><span data-stu-id="9a61f-115">Events are strictly ordered (within a partition) and durable.</span></span> <span data-ttu-id="9a61f-116">Клиенты не подписываются на поток, а просто считывают события из любой его части.</span><span class="sxs-lookup"><span data-stu-id="9a61f-116">Clients don't subscribe to the stream, instead a client can read from any part of the stream.</span></span> <span data-ttu-id="9a61f-117">Каждый клиент самостоятельно управляет своим положением в потоке.</span><span class="sxs-lookup"><span data-stu-id="9a61f-117">The client is responsible for advancing its position in the stream.</span></span> <span data-ttu-id="9a61f-118">Это означает, что клиент может подключиться в любое время и (или) прослушать события повторно.</span><span class="sxs-lookup"><span data-stu-id="9a61f-118">That means a client can join at any time, and can replay events.</span></span>

<span data-ttu-id="9a61f-119">На стороне получателя есть несколько распространенных вариантов реализации.</span><span class="sxs-lookup"><span data-stu-id="9a61f-119">On the consumer side, there are some common variations:</span></span>

- <span data-ttu-id="9a61f-120">**Обработка простых событий**.</span><span class="sxs-lookup"><span data-stu-id="9a61f-120">**Simple event processing**.</span></span> <span data-ttu-id="9a61f-121">Каждое событие немедленно запускает действие в объекте-получателе.</span><span class="sxs-lookup"><span data-stu-id="9a61f-121">An event immediately triggers an action in the consumer.</span></span> <span data-ttu-id="9a61f-122">Например, в Функциях Azure можно создать триггер служебной шины, который будет выполнять некоторую функцию при каждой публикации сообщения в определенном разделе служебной шины.</span><span class="sxs-lookup"><span data-stu-id="9a61f-122">For example, you could use Azure Functions with a Service Bus trigger, so that a function executes whenever a message is published to a Service Bus topic.</span></span>

- <span data-ttu-id="9a61f-123">**Обработка сложных событий**.</span><span class="sxs-lookup"><span data-stu-id="9a61f-123">**Complex event processing**.</span></span> <span data-ttu-id="9a61f-124">Объект-получатель обрабатывает последовательность событий и отслеживает в них определенные закономерности с помощью некоторого технологического решения, например Azure Stream Analytics или Apache Storm.</span><span class="sxs-lookup"><span data-stu-id="9a61f-124">A consumer processes a series of events, looking for patterns in the event data, using a technology such as Azure Stream Analytics or Apache Storm.</span></span> <span data-ttu-id="9a61f-125">Например, можно выполнять статистическую обработку показаний встроенного устройства за некоторый период времени, чтобы создавать уведомления, когда скользящее среднее значение выходит за определенные пороговые значения.</span><span class="sxs-lookup"><span data-stu-id="9a61f-125">For example, you could aggregate readings from an embedded device over a time window, and generate a notification if the moving average crosses a certain threshold.</span></span> 

- <span data-ttu-id="9a61f-126">**Обработка потока событий**.</span><span class="sxs-lookup"><span data-stu-id="9a61f-126">**Event stream processing**.</span></span> <span data-ttu-id="9a61f-127">Платформу потоковой передачи данных, например Центр Интернета вещей Azure или Apache Kafka, можно использовать как конвейер для приема событий и передачи их в обработчики потоков.</span><span class="sxs-lookup"><span data-stu-id="9a61f-127">Use a data streaming platform, such as Azure IoT Hub or Apache Kafka, as a pipeline to ingest events and feed them to stream processors.</span></span> <span data-ttu-id="9a61f-128">Обработчики потоков определенным образом реагируют на эти процессы или преобразовывают поток.</span><span class="sxs-lookup"><span data-stu-id="9a61f-128">The stream processors act to process or transform the stream.</span></span> <span data-ttu-id="9a61f-129">Может существовать несколько обработчиков потока для разных подсистем приложения.</span><span class="sxs-lookup"><span data-stu-id="9a61f-129">There may be multiple stream processors for different subsystems of the application.</span></span> <span data-ttu-id="9a61f-130">Такой подход хорошо подходит для рабочих нагрузок Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="9a61f-130">This approach is a good fit for IoT workloads.</span></span>

<span data-ttu-id="9a61f-131">Источник событий может находиться за пределами системы, например это могут быть физические устройства в решении Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="9a61f-131">The source of the events may be external to the system, such as physical devices in an IoT solution.</span></span> <span data-ttu-id="9a61f-132">В такой ситуации система должна поддерживать прием данных в таких объемах и на такой скорости, которые соответствуют характеристикам источника данных.</span><span class="sxs-lookup"><span data-stu-id="9a61f-132">In that case, the system must be able to ingest the data at the volume and throughput that is required by the data source.</span></span>

<span data-ttu-id="9a61f-133">На представленной выше логической схеме каждый тип потребителя обозначен отдельным блоком.</span><span class="sxs-lookup"><span data-stu-id="9a61f-133">In the logical diagram above, each type of consumer is shown as a single box.</span></span> <span data-ttu-id="9a61f-134">На практике обычно используется несколько экземпляров каждого поставщика, чтобы они не становились единой точкой отказа.</span><span class="sxs-lookup"><span data-stu-id="9a61f-134">In practice, it's common to have multiple instances of a consumer, to avoid having the consumer become a single point of failure in system.</span></span> <span data-ttu-id="9a61f-135">Наличие нескольких экземпляров также может требоваться для обработки событий в нужных объемах и (или) с нужной скоростью.</span><span class="sxs-lookup"><span data-stu-id="9a61f-135">Multiple instances might also be necessary to handle the volume and frequency of events.</span></span> <span data-ttu-id="9a61f-136">Кроме того, каждый объект-получатель может обрабатывать события в нескольких потоках.</span><span class="sxs-lookup"><span data-stu-id="9a61f-136">Also, a single consumer might process events on multiple threads.</span></span> <span data-ttu-id="9a61f-137">Это вызывает определенные сложности, если события должны обрабатываться в строгом порядке или строго один раз.</span><span class="sxs-lookup"><span data-stu-id="9a61f-137">This can create challenges if events must be processed in order, or require exactly-once semantics.</span></span> <span data-ttu-id="9a61f-138">См. руководство по [минимизации координации][minimize-coordination].</span><span class="sxs-lookup"><span data-stu-id="9a61f-138">See [Minimize Coordination][minimize-coordination].</span></span> 

## <a name="when-to-use-this-architecture"></a><span data-ttu-id="9a61f-139">Когда следует использовать эту архитектуру</span><span class="sxs-lookup"><span data-stu-id="9a61f-139">When to use this architecture</span></span>

- <span data-ttu-id="9a61f-140">Для обработки одних и тех же событий несколькими подсистемами.</span><span class="sxs-lookup"><span data-stu-id="9a61f-140">Multiple subsystems must process the same events.</span></span> 
- <span data-ttu-id="9a61f-141">Для обработки в режиме реального времени, с минимальными задержками.</span><span class="sxs-lookup"><span data-stu-id="9a61f-141">Real-time processing with minimum time lag.</span></span>
- <span data-ttu-id="9a61f-142">Для обработки сложных событий, например сопоставления шаблонов или статистической обработки за некоторый период.</span><span class="sxs-lookup"><span data-stu-id="9a61f-142">Complex event processing, such as pattern matching or aggregation over time windows.</span></span>
- <span data-ttu-id="9a61f-143">При больших объемах и скоростях поступления данных, например в Интернете вещей.</span><span class="sxs-lookup"><span data-stu-id="9a61f-143">High volume and high velocity of data, such as IoT.</span></span>

## <a name="benefits"></a><span data-ttu-id="9a61f-144">Преимущества</span><span class="sxs-lookup"><span data-stu-id="9a61f-144">Benefits</span></span>

- <span data-ttu-id="9a61f-145">Отправители и получатели независимы друг от друга.</span><span class="sxs-lookup"><span data-stu-id="9a61f-145">Producers and consumers are decoupled.</span></span>
- <span data-ttu-id="9a61f-146">Нет требуется интеграция "от точки к точке".</span><span class="sxs-lookup"><span data-stu-id="9a61f-146">No point-to point-integrations.</span></span> <span data-ttu-id="9a61f-147">Очень легко добавлять в систему новые объекты-получатели.</span><span class="sxs-lookup"><span data-stu-id="9a61f-147">It's easy to add new consumers to the system.</span></span>
- <span data-ttu-id="9a61f-148">Объекты-получатели могут реагировать на события сразу при их поступлении.</span><span class="sxs-lookup"><span data-stu-id="9a61f-148">Consumers can respond to events immediately as they arrive.</span></span> 
- <span data-ttu-id="9a61f-149">Высокая масштабируемость и распределение.</span><span class="sxs-lookup"><span data-stu-id="9a61f-149">Highly scalable and distributed.</span></span> 
- <span data-ttu-id="9a61f-150">Подсистемы получают независимые представления потока событий.</span><span class="sxs-lookup"><span data-stu-id="9a61f-150">Subsystems have independent views of the event stream.</span></span>

## <a name="challenges"></a><span data-ttu-id="9a61f-151">Сложности</span><span class="sxs-lookup"><span data-stu-id="9a61f-151">Challenges</span></span>

- <span data-ttu-id="9a61f-152">Гарантированная доставка.</span><span class="sxs-lookup"><span data-stu-id="9a61f-152">Guaranteed delivery.</span></span> <span data-ttu-id="9a61f-153">В некоторых системах, особенно в среде Интернета вещей, важно гарантировать доставку событий.</span><span class="sxs-lookup"><span data-stu-id="9a61f-153">In some systems, especially in IoT scenarios, it's crucial to guarantee that events are delivered.</span></span>
- <span data-ttu-id="9a61f-154">Обработка событий в строгом порядке и (или) строго один раз.</span><span class="sxs-lookup"><span data-stu-id="9a61f-154">Processing events in order or exactly once.</span></span> <span data-ttu-id="9a61f-155">Каждый тип потребителя обычно выполняется на нескольких экземплярах, чтобы обеспечить надежность и масштабируемость.</span><span class="sxs-lookup"><span data-stu-id="9a61f-155">Each consumer type typically runs in multiple instances, for resiliency and scalability.</span></span> <span data-ttu-id="9a61f-156">Это создает некоторые трудности, если события должны обрабатываться в строгом порядке (для каждого типа потребителя) или логика их обработки не является идемпотентной.</span><span class="sxs-lookup"><span data-stu-id="9a61f-156">This can create a challenge if the events must be processed in order (within a consumer type), or if the processing logic is not idempotent.</span></span>

## <a name="iot-architecture"></a><span data-ttu-id="9a61f-157">Архитектура Интернета вещей</span><span class="sxs-lookup"><span data-stu-id="9a61f-157">IoT architecture</span></span>

<span data-ttu-id="9a61f-158">Управляемые событиями архитектуры очень удобны при работе с решениями Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="9a61f-158">Event-driven architectures are central to IoT solutions.</span></span> <span data-ttu-id="9a61f-159">На следующей схеме представлены возможные варианты логической архитектуры для Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="9a61f-159">The following diagram shows a possible logical architecture for IoT.</span></span> <span data-ttu-id="9a61f-160">Особое внимание в этой схеме уделяется компонентам архитектуры для потоковой передачи событий.</span><span class="sxs-lookup"><span data-stu-id="9a61f-160">The diagram emphasizes the event-streaming components of the architecture.</span></span>

![](./images/iot.png)

<span data-ttu-id="9a61f-161">**Облачный шлюз** принимает события от устройств на границе облака, используя надежную службу сообщений с низкой задержкой.</span><span class="sxs-lookup"><span data-stu-id="9a61f-161">The **cloud gateway** ingests device events at the cloud boundary, using a reliable, low latency messaging system.</span></span>

<span data-ttu-id="9a61f-162">Устройства могут отправлять события в облачный шлюз напрямую или через **полевой шлюз**.</span><span class="sxs-lookup"><span data-stu-id="9a61f-162">Devices might send events directly to the cloud gateway, or through a **field gateway**.</span></span> <span data-ttu-id="9a61f-163">Полевой шлюз — это специальное устройство или программа, обычно размещаемые рядом с устройствами, которые получают события и пересылают их в облачный шлюз.</span><span class="sxs-lookup"><span data-stu-id="9a61f-163">A field gateway is a specialized device or software, usually colocated with the devices, that receives events and forwards them to the cloud gateway.</span></span> <span data-ttu-id="9a61f-164">Полевой шлюз может выполнять некоторую предварительную обработку событий, собираемых с устройств, например фильтрацию, статистическую обработку или преобразование протоколов.</span><span class="sxs-lookup"><span data-stu-id="9a61f-164">The field gateway might also preprocess the raw device events, performing functions such as filtering, aggregation, or protocol transformation.</span></span>

<span data-ttu-id="9a61f-165">Полученные события проходят через один или несколько **обработчиков потока**, которые передают данные в другие системы (например, хранилище данных) или выполняют аналитическую или другую обработку.</span><span class="sxs-lookup"><span data-stu-id="9a61f-165">After ingestion, events go through one or more **stream processors** that can route the data (for example, to storage) or perform analytics and other processing.</span></span>

<span data-ttu-id="9a61f-166">Ниже приводятся примеры типичных процессов обработки.</span><span class="sxs-lookup"><span data-stu-id="9a61f-166">The following are some common types of processing.</span></span> <span data-ttu-id="9a61f-167">(Очевидно, что этот список не является исчерпывающим.)</span><span class="sxs-lookup"><span data-stu-id="9a61f-167">(This list is certainly not exhaustive.)</span></span>

- <span data-ttu-id="9a61f-168">Сохранение данных о событиях в "холодное" хранилище для архивации или пакетной аналитики.</span><span class="sxs-lookup"><span data-stu-id="9a61f-168">Writing event data to cold storage, for archiving or batch analytics.</span></span>

- <span data-ttu-id="9a61f-169">Аналитика критического пути, то есть анализ потока событий почти в режиме реального времени для обнаружения аномалий, выявления закономерностей в скользящих диапазонах времени или создания оповещений при выполнении определенных условий в потоке.</span><span class="sxs-lookup"><span data-stu-id="9a61f-169">Hot path analytics, analyzing the event stream in (near) real time, to detect anomalies, recognize patterns over rolling time windows, or trigger alerts when a specific condition occurs in the stream.</span></span> 

- <span data-ttu-id="9a61f-170">Обработка специальных типов сообщений, не относящихся к телеметрии, например уведомлений и тревожных сигналов.</span><span class="sxs-lookup"><span data-stu-id="9a61f-170">Handling special types of non-telemetry messages from devices, such as notifications and alarms.</span></span> 

- <span data-ttu-id="9a61f-171">Машинное обучение.</span><span class="sxs-lookup"><span data-stu-id="9a61f-171">Machine learning.</span></span>

<span data-ttu-id="9a61f-172">Серые блоки обозначают компоненты системы Интернета вещей, не связанные напрямую с потоковой передачей событий. Они включены в схему для полноты представления.</span><span class="sxs-lookup"><span data-stu-id="9a61f-172">The boxes that are shaded gray show components of an IoT system that are not directly related to event streaming, but are included here for completeness.</span></span>

- <span data-ttu-id="9a61f-173">**Реестр устройств** — это база данных о подготовленных устройствах, которая содержит идентификаторы устройств и некоторые метаданные, например расположение.</span><span class="sxs-lookup"><span data-stu-id="9a61f-173">The **device registry** is a database of the provisioned devices, including the device IDs and usually device metadata, such as location.</span></span>

- <span data-ttu-id="9a61f-174">**API подготовки** — это общий внешний интерфейс для подготовки и регистрации новых устройств.</span><span class="sxs-lookup"><span data-stu-id="9a61f-174">The **provisioning API** is a common external interface for provisioning and registering new devices.</span></span>

- <span data-ttu-id="9a61f-175">В некоторых решениях Интернета вещей допускается отправка **управляющих сообщений** на устройства.</span><span class="sxs-lookup"><span data-stu-id="9a61f-175">Some IoT solutions allow **command and control messages** to be sent to devices.</span></span>

> <span data-ttu-id="9a61f-176">В этом разделе представлен общий обзор Интернета вещей, и в нем не упоминается множество тонкостей и проблем, которые необходимо учитывать.</span><span class="sxs-lookup"><span data-stu-id="9a61f-176">This section has presented a very high-level view of IoT, and there are many subtleties and challenges to consider.</span></span> <span data-ttu-id="9a61f-177">Подробный пример использования архитектуре вы найдете в PDF-документе с описанием [эталонной архитектуры Центра интернета вещей Microsoft Azure][iot-ref-arch].</span><span class="sxs-lookup"><span data-stu-id="9a61f-177">For a more detailed reference architecture and discussion, see the [Microsoft Azure IoT Reference Architecture][iot-ref-arch] (PDF download).</span></span>

 <!-- links -->

[competing-consumers]: ../../patterns/competing-consumers.md
[iot-ref-arch]: https://azure.microsoft.com/updates/microsoft-azure-iot-reference-architecture-available/
[minimize-coordination]: ../design-principles/minimize-coordination.md


