---
title: "Контрольный список для обеспечения отказоустойчивости"
description: "Контрольный список с рекомендациями по вопросам обеспечения отказоустойчивости, возникающим во время проектирования."
author: petertaylor9999
ms.date: 03/24/2017
ms.custom: resiliency, checklist
ms.openlocfilehash: d0ae48be603391a7be043130d6d77d3c82abad18
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2017
---
# <a name="resiliency-checklist"></a>Контрольный список для обеспечения отказоустойчивости
[!INCLUDE [header](../_includes/header.md)]

Разработка приложения для обеспечения отказоустойчивости требует планирования и устранения различных режимов сбоев, которые могут возникнуть. Просмотрите пункты в этом контрольном списке при разработке приложения, чтобы повысить его отказоустойчивость.

## <a name="requirements"></a>Требования
* **Определите требования вашего клиента к обеспечению доступности.** У вашего клиента будут требования к обеспечению доступности для компонентов приложения, которые повлияют на проектирование вашего приложения. Получите соглашение вашего клиента с требованиями к обеспечению доступности каждой части приложения, иначе ваш проект может не соответствовать ожиданиям клиента. Дополнительные сведения см. в разделе [Определение требований к отказоустойчивости](../resiliency/index.md#defining-your-resiliency-requirements).

## <a name="application-design"></a>Проектирование приложений
* **Выполните анализ режима сбоя (FMA) приложения.** FMA — это процесс повышения отказоустойчивости в приложении на ранней стадии проектирования. Дополнительные сведения см. в статье [Анализ режима сбоя][fma]. Цели FMA:  

  * Определите типы сбоев, которые могут возникнуть в приложении.
  * Запишите потенциальные эффекты и влияние каждого типа сбоя на приложение.
  * Определите стратегии восстановления.
  
* **Развертывайте несколько экземпляров служб.** Если приложение зависит от одного экземпляра службы, создается единая точка отказа. Подготовка нескольких экземпляров улучшает как отказоустойчивость, так и масштабируемость. Для [службы приложений Azure](/azure/app-service/app-service-value-prop-what-is/) выберите [план служб приложений](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/), где есть несколько экземпляров. Для облачных служб Azure настройте каждую роль для применения [нескольких экземпляров](/azure/cloud-services/cloud-services-choose-me/#scaling-and-management). Для [виртуальных машин Azure](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) убедитесь, что архитектура виртуальных машин содержит несколько виртуальных машин, а также что каждая виртуальная машина входит в [группу доступности][availability-sets].   
* **Используйте автоматическое масштабирование для реагирования на увеличение нагрузки.** Если в приложении не настроено автоматическое масштабирование при увеличении нагрузки, возможно, при перегрузке пользовательскими запросами в службах вашего приложения будут происходить сбои. Подробные сведения см. в следующих статьях:

  * Общие сведения: [Контрольный список для обеспечения масштабируемости](./scalability.md).
  * Служба приложений Azure: [Масштабирование числа экземпляров вручную или автоматически][app-service-autoscale].
  * Облачные службы: [Как настроить автомасштабирование для облачной службы на портале][cloud-service-autoscale].
  * Виртуальные машины: [Обзор автомасштабирования с помощью масштабируемых наборов виртуальных машин Azure][vmss-autoscale].
* **Используйте балансировку нагрузки для распределения запросов.** Балансировка нагрузки распределяет запросы вашего приложения между работоспособными экземплярами службы, удаляя неработоспособные экземпляры из ротации. Если служба использует службу приложений Azure или облачные службы Azure, нагрузка в ней уже сбалансирована. Однако, если приложение использует виртуальные машины Azure, вам необходимо будет установить подсистему балансировки нагрузки. Дополнительные сведения см. в статье [Обзор Azure Load Balancer](/azure/load-balancer/load-balancer-overview/).
* **Настройте шлюзы приложения Azure для использования нескольких экземпляров.** В зависимости от требований приложения [шлюз приложений Azure](/azure/application-gateway/application-gateway-introduction/) может лучше подойти для распространения запросов в вашем приложении. Однако единичные экземпляры службы шлюза приложений не гарантируются соглашением об уровне обслуживания (SLA), поэтому возможно, что в вашем приложении могут возникать сбои, если экземпляр шлюза приложения завершит работу с ошибкой. Подготовьте несколько небольших или средних экземпляров шлюза приложений для гарантии доступности службы в соответствии с условиями [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/v1_0/).
* **Используйте группы доступности Azure для каждого уровня приложения.** Размещение экземпляров в [группе доступности][availability-sets] обеспечивает более высокий уровень [SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/). 
* **Рассмотрите возможность развертывания приложения в нескольких регионах.** Если ваше приложение развертывается в одном регионе, в редких случаях, когда весь регион становится недоступным, ваше приложение также будет недоступно. Это может быть неприемлемо в соответствии с условиями SLA вашего приложения. Если это так, рассмотрите возможность развертывания приложения и служб в нескольких регионах. Развертывание в нескольких регионах может использовать шаблон "активный — активный" (распределение запросов между несколькими активными экземплярами) или "активный — пассивный" (сохранение резервного экземпляра на случай сбоя основного). Мы рекомендуем развернуть несколько экземпляров служб вашего приложения в парах регионов. Дополнительные сведения см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure](/azure/best-practices-availability-paired-regions).
* **Используйте диспетчер трафика Azure для маршрутизации трафика вашего приложения в разные регионы.**  [Диспетчер трафика Azure][traffic-manager] выполняет балансировку нагрузки на уровне DNS и направляет трафик в разные регионы на основе указанного метода [маршрутизации трафика][traffic-manager-routing] и состояния конечных точек вашего приложения. Без диспетчера трафика вы ограничены одним регионом для развертывания. При этом ограничивается масштаб, увеличивается задержка для некоторых пользователей и возникает простой приложений в случае нарушения работы служб на уровне региона.
* **Настройте и выполните проверку работоспособности подсистемы балансировки нагрузки и диспетчеров трафика.** Убедитесь, что ваша логика работоспособности проверяет критически важные части системы и соответствующим образом реагирует на проверки работоспособности.
  * Проверки работоспособности [диспетчера трафика Azure][traffic-manager] и [Azure Load Balancer][load-balancer] выполняют определенную функцию. Для диспетчера трафика при проверке работоспособности определяется, следует ли выполнить отработку отказа в другой регион. Для подсистемы балансировки нагрузки определяется, следует ли удалять виртуальную машину из ротации.      
  * Для проверки диспетчера трафика конечная точка работоспособности должна проверять любые критические зависимости, которые развертываются в одном регионе и сбой которых должен инициировать отработку отказа с переходом в другой регион.  
  * Для подсистемы балансировки нагрузки конечная точка работоспособности должна сообщать о работоспособности виртуальной машины. Не включайте в развертывание другие уровни или внешние службы. В противном случае при сбое вне виртуальной машины подсистема балансировки нагрузки удалит виртуальную машину из ротации.
  * Инструкции по реализации мониторинга работоспособности в приложении см. в статье [Health Endpoint Monitoring Pattern](https://msdn.microsoft.com/library/dn589789.aspx) (Шаблон мониторинга конечной точки работоспособности).
* **Отслеживайте сторонние службы.** Если ваше приложение зависит от сторонних служб, определите, где и как могут произойти сбои этих сторонних служб и как эти сбои могут повлиять на ваше приложение. Сторонняя служба может не включать в себя мониторинг и диагностику, поэтому важно регистрировать свои вызовы и сопоставлять их с журналом работоспособности и диагностики вашего приложения с использованием уникального идентификатора. Дополнительные сведения о методиках мониторинга и диагностики см. в статье [Мониторинг и диагностика][monitoring-and-diagnostics-guidance].
* **Убедитесь, что любая используемая сторонняя служба предоставляет SLA.** Если ваше приложение зависит от сторонней службы, но сторонний поставщик не гарантирует доступность в форме SLA, доступность вашего приложения также невозможно гарантировать. Соглашение SLA зависит от наименее доступного компонента вашего приложения.
* **При необходимости применяйте шаблоны отказоустойчивости для удаленных операций.** Если ваше приложение зависит от связи между удаленными службами, следуйте конструктивным шаблонам для устранения кратковременных сбоев, таким как [шаблон повторов][retry-pattern] и [шаблон автоматического выключения][circuit-breaker]. Дополнительные сведения см. в разделе [Стратегии обеспечения отказоустойчивости](../resiliency/index.md#resiliency-strategies).
* **По возможности реализуйте асинхронные операции.** Синхронные операции могут монополизировать ресурсы и блокировать другие операции, пока вызывающий объект ждет завершения процесса. Проектируйте каждую часть приложения таким образом, чтобы по возможности обеспечить возможность асинхронных операций. Дополнительные сведения о том, как реализовать асинхронное программирование в C#, см. в статье [Асинхронное программирование][asynchronous-c-sharp].

## <a name="data-management"></a>Управление данными
* **Изучите методы репликации источников данных приложения.** Данные приложения будут храниться в разных источниках данных и иметь разные требования к доступности. Проанализируйте методы репликации для каждого типа хранилища данных в Azure, включая [репликацию хранилища Azure](/azure/storage/storage-redundancy/) и [активную георепликацию для базы данных SQL](/azure/sql-database/sql-database-geo-replication-overview/), чтобы убедиться, что требования данных приложения выполняются.
* **Убедитесь, что ни одна учетная запись пользователя не имеет доступа к рабочим и резервным данным.** Резервные копии данных будут скомпрометированы, если одна учетная запись пользователя имеет разрешение на запись как в источники рабочих данных разработки, так и в источники резервных копий. Злоумышленник может намеренно удалить все ваши данные, а обычный пользователь может сделать это случайно. Создайте приложение для ограничения разрешений каждой учетной записи пользователя, чтобы только пользователи, которым требуется доступ на запись, имели доступ на запись только в рабочих или резервных данных, но не в обоих.
* **Документируйте процесс отработки отказа и восстановления размещения источника данных и протестируйте его.** В случае, когда ваш источник данных полностью выходит из строя, оператору придется следовать набору документированных инструкций, чтобы выполнить отработку отказа и перейти к новому источнику данных. Если в задокументированных шагах есть ошибки, оператор не сможет успешно выполнить их и выполнить отработку отказа ресурса. Регулярно проверяйте шаги инструкции, чтобы убедиться, что оператор может успешно выполнить отработку отказа и восстановить размещение источника данных.
* **Проверяйте резервные копии данных.** Регулярно проверяйте состояние резервных данных, запустив скрипт для проверки целостности данных, схемы и запросов. Резервная копия не имеет смысла, если с ее помощью невозможно восстановить источники данных. Регистрируйте и сообщайте о любых несоответствиях, чтобы можно было устранить неисправность службы восстановления.
* **Рассмотрите возможность использования геоизбыточной учетной записи хранения.** Данные, хранящиеся в учетной записи хранения Azure, всегда реплицируются локально. Однако существует несколько стратегий репликации, которые можно выбрать при подготовке учетной записи хранения. Выберите [геоизбыточное хранилище с доступом на чтение (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage) для защиты данных приложения в тех редких случаях, когда весь регион становится недоступным.

  > [!NOTE]
  > Для виртуальных машин не следует полагаться на репликацию RA-GRS для восстановления дисков виртуальных машин (файлы VHD). Вместо этого используйте [Azure Backup][azure-backup].   
  >
  >

## <a name="security"></a>Безопасность
* **Реализуйте защиту на уровне приложения от атак типа "отказ в обслуживании" (DDoS).** Службы Azure защищены от атак DDoS на сетевом уровне. Тем не менее Azure не может защитить от атак на уровне приложений, потому что трудно отличить истинные запросы пользователей от вредоносных. Дополнительные сведения о том, как обеспечить защиту от атак DDoS на уровне приложений, см. в разделе "Защита от атак DDoS" документа о [сетевой безопасности Microsoft Azure](http://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf) (в формате PDF).
* **Реализуйте принцип наименьших привилегий для доступа к ресурсам приложения.** Значение по умолчанию для доступа к ресурсам приложения должно быть максимально ограничивающим. Предоставляйте разрешения более высокого уровня на основе утверждения. Предоставление повышенных прав доступа к ресурсам приложения по умолчанию может привести к тому, что кто-то намеренно или случайно удалит ресурсы. Azure предоставляет [управление доступом на основе ролей](/azure/active-directory/role-based-access-built-in-roles/) для управления привилегиями пользователей, но важно проверить разрешения с минимальными привилегиями для других ресурсов с собственными системами разрешений, например SQL Server.

## <a name="testing"></a>Тестирование
* **Протестируйте отработку отказа и восстановление размещения для приложения.** Если вы еще не полностью протестировали отработку отказа и восстановление размещения, нельзя с уверенностью заявить, что зависимые службы в вашем приложении восстановят работу синхронизировано во время аварийного восстановления. Убедитесь в том, что зависимые службы приложения выполняют отработку отказа и восстановление размещения в правильном порядке.
* **Выполните тестирование путем внедрения ошибки в приложение.** Приложение может не работать по разным причинам, таким как истечение срока действия сертификата, исчерпание системных ресурсов в виртуальной машине или сбои хранилища. Протестируйте приложение в среде, максимально приближенной к рабочей, путем моделирования или запуска реальных сбоев. Например, удалите сертификаты, искусственно используйте системные ресурсы или удалите источник хранения. Проверьте способность вашего приложения восстанавливать все типы неисправностей автономно и в сочетании с различными методами. Убедитесь, что ошибки не распространяются или не объединяются в вашей системе.
* **Выполните тестирования в среде разработки с использованием как синтетических, так и реальных пользовательских данных.** Тестирование и разработка редко идентичны, поэтому важно использовать метод развертывания Blue-Green или раннее развертывание и тестировать приложение в рабочей среде. Это позволяет протестировать приложение в рабочей среде с реальной нагрузкой и гарантировать, что оно будет функционировать должным образом после полного развертывания.

## <a name="deployment"></a>Развертывание
* **Документируйте процесс выпуска вашего приложения.** Без подробного документирования процесса выпуска оператор может развернуть неправильное обновление или неправильно настроить параметры вашего приложения. Четко определите и задокументируйте процесс выпуска и убедитесь, что он доступен для всей группы разработки. 
* **Автоматизируйте процесс развертывания приложения.** Если рабочий персонал должен вручную развертывать ваше приложение, человеческий фактор может привести к сбою развертывания. 
* **Разработайте процесс выпуска, максимально повышающий доступность приложений.** Если процесс выпуска требует, чтобы службы отключались во время развертывания, ваше приложение будет недоступно, пока службы не вернутся в сеть. Используйте метод развертывания выпуска [Blue-Green](http://martinfowler.com/bliki/BlueGreenDeployment.html) или [раннее](http://martinfowler.com/bliki/CanaryRelease.html) развертывание для развертывания приложения в рабочей среде. Оба этих метода включают в себя развертывание кода выпуска вместе с рабочим кодом, чтобы пользователей кода выпуска можно было перенаправить в рабочий код в случае сбоя.
* **Выполняйте регистрирование и аудит развертываний приложения.** Если вы используете промежуточные методы развертывания, такие как Blue-Green или ранние выпуски, в рабочей среде будет существовать несколько версий вашего приложения. Если возникает ошибка, очень важно определить, какая версия приложения вызвала ее. Реализуйте надежную стратегию ведения журнала, чтобы получить как можно больше сведений о версии.
* **Составьте план отката развертывания.** Возможно, развертывание приложения может завершиться сбоем и привести к тому, что ваше приложение станет недоступно. Создайте процесс отката, позволяющий вернуться к последней известной рабочей версии и минимизировать время простоя. 

## <a name="operations"></a>Операции
* **Реализуйте рекомендации по мониторингу и оповещению в приложении.** Без надлежащего мониторинга, диагностики и оповещения невозможно обнаружить сбои в приложении и сообщить оператору об их устранении. Дополнительные сведения см. в статье [Мониторинг и диагностика][monitoring-and-diagnostics-guidance].
* **Измеряйте статистику удаленных вызовов, чтобы сделать информацию доступной команде разработки.**  Если не отслеживать и не передавать статистику удаленных вызовов в режиме реального времени и не предоставлять простой способ просмотра этой информации, группа разработки не сможет мгновенно узнать о работоспособности вашего приложения. Если вы измеряете среднее время удаленного вызова, у вас будет недостаточно информации для выявления проблем в службах. Суммируйте показатели удаленного вызова, такие как задержка, пропускная способность и ошибки на уровне 99-го и 95-го процентилей. Выполните статистический анализ показателей, чтобы выявить ошибки, возникающие на каждом процентиле.
* **Отслеживайте количество временных исключений и повторений за соответствующий временной интервал.** Если вы не отслеживаете временные исключения и попытки повторения с течением времени, возможно, что проблема или сбой могут быть скрыты логикой повторения вашего приложения. То есть, если мониторинг и ведение журнала показывают только успешность или неудачу операции, то тот факт, что операцию пришлось повторить несколько раз из-за исключений, будет скрыт. Тенденция увеличения исключений с течением времени указывает на то, что в службе возникла проблема и она может выйти из строя. Дополнительные сведения см. в статье [Руководство по использованию механизма повторов для отдельных служб][retry-service-guidance].
* **Реализуйте систему раннего предупреждения оператора.** Определите ключевые показатели эффективности вашего приложения, такие как временные исключения и задержка удаленного вызова, и установите соответствующие пороговые значения для каждого из них. Отправьте оповещение операциям при достижении порогового значения. Установите эти пороговые значения на уровнях, которые идентифицируют проблемы до того, как они станут критическими и потребуют мер восстановления.
* **Убедитесь, что в команде несколько специалистов обучено контролировать приложение и выполнять любые шаги восстановления вручную.** Если в вашей команде есть только один оператор, который может контролировать приложение и запускать шаги восстановления, он становится единой точкой отказа. Обучите нескольких людей обнаружению и восстановлению и убедитесь, что в любой момент всегда есть как минимум один активный участник.
* **Убедитесь, что приложение не сталкивается с [ограничениями подписки Azure](/azure/azure-subscription-service-limits/).** В подписках Azure предусмотрены ограничения на определенные типы ресурсов, такие как количество групп ресурсов, количество ядер и количество учетных записей.  Если ваши требования к приложениям превышают лимиты подписки Azure, создайте еще одну подписку Azure и подготовьте в ней достаточное количество ресурсов.
* **Убедитесь, что приложение не сталкивается с [ограничениями для одной службы](/azure/azure-subscription-service-limits/).** Отдельные службы Azure имеют ограничения на потребление, например ограничения на объем хранения, пропускную способность, количество подключений, запросы в секунду и другие показатели. Приложение не будет работать, если оно попытается использовать ресурсы за пределами этих ограничений. Это приведет к регулированию службы и возможному простою для затронутых пользователей. В зависимости от конкретной службы и требований приложений вы можете избежать этих ограничений путем вертикального (например, выбора другого уровня цен) или горизонтального масштабирования (добавления новых экземпляров).  
* **Разрабатывайте требования к хранилищу приложений в соответствии целевыми показателями масштабируемости и производительности службы хранилища Azure.** Служба хранилища Azure предназначена для работы в рамках предопределенных целевых показателей масштабируемости и производительности, поэтому разрабатывайте приложение для использования хранилища в рамках этих показателей. При превышении этих целевых показателей хранилище приложения будет регулироваться. Чтобы устранить эту проблему, подготовьте дополнительные учетные записи хранения. Если вы столкнулись с лимитом учетной записи хранения, подготовьте дополнительные подписки Azure и дополнительные учетные записи хранения. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/storage-scalability-targets/).
* **Выберите правильный размер виртуальной машины для своего приложения.** Измерьте фактические показатели по использованию процессора, памяти, диску и операциям ввода-вывода ваших виртуальных машин в рабочей среде и убедитесь, что выбранный вами размер виртуальной машины достаточен. В противном случае ваше приложение может испытывать проблемы с пропускной способностью при достижении ограничений в виртуальных машинах. Размеры виртуальных машин подробно описываются в статье [Размеры виртуальных машин Windows в Azure](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
* **Определите, является ли рабочая нагрузка вашего приложения стабильной или колеблющейся с течением времени.** Если ваша рабочая нагрузка изменяется с течением времени, используйте масштабируемые наборы виртуальных машин для автоматического масштабирования требуемого количества экземпляров виртуальных машин. В противном случае необходимо вручную увеличить или уменьшить число виртуальных машин. Дополнительные сведения см. в статье [Общие сведения о масштабируемых наборах виртуальных машин в Azure](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/).
* **Выберите соответствующий уровень служб для базы данных Azure SQL.** Если приложение использует базу данных Azure SQL, убедитесь, что вы выбрали соответствующий уровень служб. Если вы выберете уровень, который не сможет обрабатывать требования к единицам передачи данных приложения (DTU), использование данных будет регулироваться. Дополнительные сведения о выборе соответствующего плана служб см. в статье [Что такое уровни служб Базы данных SQL](/azure/sql-database/sql-database-service-tiers/).
* **Создайте процесс для взаимодействия со службой поддержки Azure.** Если процесс обращения в [службу поддержки Azure](https://azure.microsoft.com/support/plans/) не установлен до того, как возникнет необходимость обратиться в службу поддержки, время простоя будет увеличиваться по мере того, как процесс обращения в службу поддержки будет применяться в первый раз. Изначально включите процесс обращения в службу поддержки и эскалацию проблем как часть отказоустойчивости вашего приложения.
* **Убедитесь, что приложение не использует больше максимального количества учетных записей для подписки.** Azure поддерживает не более 200 учетных записей хранения для подписки. Если вашему приложению требуется больше учетных записей, чем в настоящее время доступно в вашей подписке, вам придется создать подписку и создать в ней дополнительные учетные записи хранения. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы](/azure/azure-subscription-service-limits/#storage-limits).
* **Убедитесь, что приложение не превышает целевые показатели масштабируемости для дисков виртуальной машины.** Виртуальные машины Azure IaaS поддерживают подключение нескольких дисков данных в зависимости от ряда факторов, включая размер виртуальной машины и тип учетной записи хранения. Если приложение превышает целевые показатели масштабируемости для дисков виртуальных машин, подготовьте дополнительные учетные записи хранения и создайте в них виртуальные диски. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/storage-scalability-targets/#scalability-targets-for-virtual-machine-disks).

## <a name="telemetry"></a>Телеметрия
* **Регистрируйте данные телеметрии во время работы приложения в рабочей среде.** Сохраняйте надежные данные телеметрии во время работы приложения в рабочей среде. В противном случае у вас будет недостаточно информации, чтобы диагностировать причину проблем во время активного обслуживания пользователей в приложении. Дополнительные сведения см. в статье [Мониторинг и диагностика][monitoring-and-diagnostics-guidance].
* **Реализуйте ведение журнала с использованием асинхронного шаблона.** Если операции ведения журнала являются синхронными, они могут блокировать код приложения. Убедитесь, что ведение журнала операций реализовано в виде асинхронных операций.
* **Сопоставляйте данные журнала в границах служб.** В типичном n-уровневом приложении пользовательский запрос может пересекать границы нескольких служб. Например, пользовательский запрос обычно возникает на веб-уровне и передается на бизнес-уровень и, наконец, сохраняется на уровне данных. В более сложных сценариях запрос пользователя может распространяться на множество различных служб и хранилищ данных. Убедитесь, что система ведения журнала сопоставляет вызовы в границах служб для отслеживания запроса в приложении.

## <a name="azure-resources"></a>Ресурсы Azure
* **Используйте шаблоны Azure Resource Manager для подготовки ресурсов.** Шаблоны Resource Manager облегчают автоматизирование развертываний с помощью PowerShell или Azure CLI, что обеспечивает более надежный процесс развертывания. Дополнительные сведения см. в [обзоре Azure Resource Manager][resource-manager].
* **Присваивайте ресурсам информативные имена.** Это упростит поиск определенного ресурса и понимание его роли. Дополнительные сведения см. в статье [Соглашения об именовании](../best-practices/naming-conventions.md).
* **Управление доступом на основе ролей (RBAC).** Контролируйте доступ к развертываемым ресурсам Azure с помощью RBAC. RBAC позволяет назначать роли авторизации участникам команды DevOps, чтобы предотвратить случайное удаление или изменение развернутых ресурсов. Дополнительные сведения см. в статье [Начало работы с управлением доступом на основе ролей на портале Azure](/azure/active-directory/role-based-access-control-what-is/).
* **Используйте блокировки ресурсов для критических ресурсов, таких как виртуальные машины.** Блокировки ресурсов предотвращают случайное удаление ресурса оператором. Дополнительные сведения см. в статье [Блокировка ресурсов для предотвращения непредвиденных изменений](/azure/azure-resource-manager/resource-group-lock-resources/).
* **Выберите пары регионов.** При развертывании в двух регионах выберите регионы из одной пары регионов. На случай масштабного сбоя в каждой паре определяется приоритетный регион для восстановления. Некоторые службы, например геоизбыточное хранилище, автоматически реплицируют данные в дополнительный регион. Дополнительные сведения см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure](/azure/best-practices-availability-paired-regions).
* **Организуйте группы ресурсов в соответствии с функциями и жизненным циклом.**  Как правило, группа ресурсов должна содержать ресурсы с одним и тем же жизненным циклом. Это упрощает управление развертываниями, удаление тестовых развертываний и назначение прав доступа, что снижает вероятность случайного удаления или изменения рабочего развертывания. Создайте отдельные группы ресурсов для рабочей среды, сред разработки и тестирования. При развертывании в нескольких регионах поместите ресурсы для каждого региона в отдельные группы ресурсов. Это упрощает повторное развертывание в одном регионе, не затрагивая другие.

## <a name="azure-services"></a>Службы Azure
Следующие элементы контрольного списка применяются к отдельным службам в Azure.

### <a name="app-service"></a>Служба приложений
* **Уровень "Стандартный" или "Премиум".** Эти уровни поддерживают промежуточные слоты и автоматическое резервное копирование. Дополнительные сведения см. в статье [Подробный обзор планов службы приложений Azure](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/).
* **Избегайте увеличения или уменьшения масштаба.** Вместо этого выберите уровень и размер экземпляра в соответствии с требованиями к производительности при типичной нагрузке, а затем выполните [горизонтальное масштабирование](/azure/app-service-web/web-sites-scale/) экземпляров для обработки изменений объема трафика. Увеличение или уменьшение масштаба может вызвать перезапуск приложения.  
* **Сохраняйте конфигурацию в виде настроек приложений.** Используйте настройки приложения, чтобы сохранить параметры конфигурации в качестве настроек приложения. Определите параметры в шаблонах Resource Manager или с помощью PowerShell, чтобы применить их в процессе автоматического развертывания или обновления. Этот подход надежнее. Дополнительные сведения см. в статье [Настройка веб-приложений в службе приложений Azure](/azure/app-service-web/web-sites-configure/).
* **Используйте разные планы службы приложений для рабочей и тестовой сред.** Не используйте слоты в рабочем развертывании для тестирования.  Все приложения, которые находятся в одном плане службы приложений, совместно используют одни экземпляры виртуальных машин. Если разместить рабочее и тестовое развертывание в одном плане, это может негативно повлиять на рабочее развертывание. Например, нагрузочные тесты могут привести к ухудшению производительности активного рабочего сайта. Поместив тестовые развертывания в отдельный план, можно изолировать их от рабочей версии.  
* **Отделите веб-приложения от веб-API.** Если в решении есть как веб-интерфейс, так и веб-API, рассмотрите возможность их разбивки на отдельные приложения службы приложений. Такой подход помогает распределять решения по рабочим нагрузкам. Вы можете запускать веб-приложение и API в отдельных планах службы приложений, чтобы они могли масштабироваться независимо друг от друга. Если изначально этот уровень масштабируемости не требуется, можно развертывать приложения в одном плане и позже переместить их в отдельные планы (при необходимости).
* **Избегайте использования функции резервного копирования службы приложений для резервного копирования баз данных Azure SQL.** Вместо этого используйте [автоматическое резервное копирование базы данных SQL][sql-backup]. При резервном копировании службы приложений база данных экспортируется в BACPAC-файл SQL, использующий единицы DTU.  
* **Выполняйте развертывания в промежуточном слоте.** Создайте слот развертывания для размещения в промежуточной среде. Разверните обновления приложений в промежуточном слоте и проверьте развертывание, прежде чем переносить его в рабочую среду. Это снижает вероятность неправильного обновления в рабочей среде. Это также гарантирует, что все экземпляры подготовлены перед перемещением в рабочую среду. Для многих приложений довольно долго выполняются начальная загрузка и "холодный" запуск. Дополнительные сведения см. в статье [Настройка промежуточных сред в службе приложений Azure](/azure/app-service-web/web-sites-staged-publishing/).
* **Создайте слот развертывания для хранения последнего известного корректного развертывания (LKG).** При развертывании обновления в рабочей среде переместите предыдущее рабочее развертывание в слот LKG. Это упрощает откат неправильного развертывания. Если в дальнейшем обнаруживается проблема, можно быстро вернуться к версии LKG. Дополнительные сведения см. в статье [Basic web application](../reference-architectures/app-service-web-app/basic-web-app.md) (Базовое веб-приложение).
* **Включите ведение журнала диагностики**, в частности для приложения и веб-сервера. Ведение журнала важно для мониторинга и диагностики. Ознакомьтесь со статьей [Включение ведения журнала диагностики для веб-приложений в службе приложений Azure](/azure/app-service-web/web-sites-enable-diagnostic-log/).
* **Храните данные журнала в хранилище BLOB-объектов.** Это упрощает сбор и анализ данных.
* **Создайте отдельную учетную запись хранения для журналов.** Не используйте одну учетную запись хранения для журналов и данных приложения. Это помогает предотвратить снижение производительности приложения из-за ведения журнала.
* **Отслеживайте производительность.** Используйте службу мониторинга производительности, например [New Relic](http://newrelic.com/) или [Application Insights](/azure/application-insights/app-insights-overview/), чтобы контролировать производительность и поведение загруженных приложений.  Мониторинг производительности дает вам представление о приложении в режиме реального времени. Он позволяет диагностировать проблемы и выполнять анализ основной причины сбоев.

### <a name="application-gateway"></a>Шлюз приложений
* **Подготовьте по крайней мере два экземпляра.** Разверните шлюз приложений как минимум с двумя экземплярами. Один экземпляр является единой точкой отказа. Используйте два или более экземпляров для обеспечения избыточности и масштабируемости. В соответствии с [соглашением об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/application-gateway/v1_0/) необходимо предоставить два или более экземпляров среднего или большего размера.

### <a name="azure-search"></a>поиск Azure;
* **Подготовьте несколько реплик.** Используйте как минимум две реплики, чтобы обеспечить высокую доступность операций чтения, или три, чтобы обеспечить высокую доступность операций чтения и записи.
* **Настройте индексаторы для развертываний в нескольких регионах.** Если имеется развертывание в нескольких регионах, рассмотрите варианты непрерывности индексирования.

  * Если источник данных геореплицируется, вы должны, как правило, указывать для каждого индексатора каждой региональной службы поиска Azure свою локальную реплику источника данных. Однако мы не рекомендуем использовать этот подход для больших наборов данных, хранящихся в базе данных SQL Azure. Причина в том, что служба "Поиск Azure" не может выполнить добавочное индексирование из вторичных реплик базы данных SQL, а только из первичной реплики. Вместо этого укажите для всех индексаторов первичную реплику. После отработки отказа укажите для индексаторов службы "Поиск Azure" новую первичную реплику.  
  * Если источник данных не геореплицируется, укажите для нескольких индексаторов один источник данных, чтобы службы Поиска Azure в нескольких регионах непрерывно и независимо индексировали источник данных. Дополнительные сведения см. в статье [Рекомендации по производительности и оптимизации Поиска Azure][search-optimization].

### <a name="azure-storage"></a>Хранилище Azure
* Используйте **геоизбыточное хранилище с доступом для чтения** для данных приложения. Хранилище RA-GRS реплицирует данные в дополнительный регион и предоставляет доступ только для чтения из вторичного региона. При наличии доступа к хранилищу в первичном регионе приложение может считывать данные из вторичного региона. Дополнительные сведения см. в статье [Репликация службы хранилища Azure](/azure/storage/storage-redundancy/).
* **Используйте управляемые диски в качестве дисков виртуальных машин.** Служба [Управляемые диски][managed-disks] обеспечивает более высокую надежность виртуальных машин в группах доступности, так как диски достаточно изолированы друг от друга, что позволяет избежать единой точки отказа. Кроме того, управляемые диски не подпадают под ограничения операций ввода-вывода в секунду для виртуальных жестких дисков (VHD), созданных в учетной записи хранения. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure][vm-manage-availability].
* **Создайте резервную очередь в другом регионе, чтобы создать хранилище очередей.** Для хранилища очередей реплика, предназначенная только для чтения, ограничена в использовании, так как вы не можете ставить элементы в очередь или удалять их из нее. Вместо этого создайте резервную очередь в учетной записи хранения в другом регионе. При отказе хранилища приложение может использовать резервную очередь, пока основной регион снова не станет доступен. Таким образом приложение может обрабатывать новые запросы.  

### <a name="cosmos-db"></a>База данных Cosmos
* **Реплицируйте базу данных в разные регионы.** Cosmos DB позволяет связать любое количество регионов Azure с учетной записью базы данных Cosmos DB. База данных Cosmos DB может иметь один регион записи и несколько регионов чтения. В случае сбоя в регионе записи можно выполнять чтение из другой реплики. Клиентский пакет SDK обрабатывает это автоматически. Кроме того, можно выполнить отработку отказа региона записи в другой регион. Дополнительные сведения см. в статье [Как работает глобальное распределение данных в Azure с помощью Cosmos DB](/azure/documentdb/documentdb-distribute-data-globally).

### <a name="sql-database"></a>База данных SQL
* **Уровень "Стандартный" или "Премиум".** Эти уровни обеспечивают более длительный период восстановления на определенный момент времени (35 дней). Дополнительные сведения см. в статье [Что такое уровни служб Базы данных SQL](/azure/sql-database/sql-database-service-tiers/).
* **Включите аудит базы данных SQL.** Аудит может использоваться для диагностики вредоносных атак или ошибки из-за человеческого фактора. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](/azure/sql-database/sql-database-auditing-get-started/).
* Используйте **активную георепликацию**, чтобы создать доступную для чтения вторичную реплику в другом регионе.  Если произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), выполните отработку отказа в ручном режиме в любую базу данных-получатель.  До отработки отказа база данных-получатель остается доступной только для чтения.  Дополнительные сведения см. в статье [Обзор. Группы отработки отказа и активная георепликация](/azure/sql-database/sql-database-geo-replication-overview/).
* **Используйте сегментирование.** Рассмотрите возможность использования сегментирования для горизонтального секционирования базы данных. Сегментирование может обеспечить изоляцию от сбоев. Дополнительные сведения см. в статье [Развертывание с помощью Базы данных SQL Azure](/azure/sql-database/sql-database-elastic-scale-introduction/).
* **Используйте восстановление до точки во времени для восстановления после ошибки пользователя.**  При восстановлении до точки во времени база данных возвращается в состояние на более ранний момент времени. Дополнительные сведения см. в статье [Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий][sql-restore].
* **Используйте геовосстановление для восстановления после сбоя службы.** При геовосстановлении база данных восстанавливается из геоизбыточной резервной копии.  Дополнительные сведения см. в статье [Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий][sql-restore].

### <a name="sql-server-running-in-a-vm"></a>SQL Server (на виртуальной машине)
* **Реплицируйте базу данных.** Используйте группы доступности Always On SQL Server для репликации базы данных. При сбое в одном экземпляре SQL Server они обеспечивают высокий уровень доступности. Дополнительные сведения см. в статье [Запуск виртуальных машин Windows для n-уровневого приложения](../reference-architectures/virtual-machines-windows/n-tier.md).
* **Архивируйте базу данных.** Если вы уже используете службу [Azure Backup](https://azure.microsoft.com/documentation/services/backup/) для архивации виртуальных машин, рассмотрите возможность ее использования [для рабочих нагрузок SQL Server с помощью DPM](/azure/backup/backup-azure-backup-sql/). При таком подходе используется одна роль администратора архивации для организации и единая процедура восстановления для виртуальных машин и SQL Server. В противном случае используйте [управляемое резервное копирование SQL Server в Microsoft Azure](https://msdn.microsoft.com/library/dn449496.aspx).

### <a name="traffic-manager"></a>Диспетчер трафика
* **Выполняйте восстановление размещения вручную.** После отработки отказа диспетчера трафика выполните восстановление размещения вручную, а не автоматически. Убедитесь, что все подсистемы приложения полностью работоспособны, и лишь затем выполните восстановление размещения.  В противном случае могут возникнуть ситуации, в которых приложение будет переходить между центрами обработки данных. Дополнительные сведения см. в статье [Запуск виртуальных машин Windows в нескольких регионах для обеспечения высокой доступности](../reference-architectures/virtual-machines-windows/multi-region-application.md).
* **Создайте конечную точку проверки работоспособности.** Создайте пользовательскую конечную точку, которая сообщает об общей работоспособности приложения. Это позволяет диспетчеру трафика выполнить отработку отказа при сбое любого критического пути, а не только внешнего интерфейса. Конечная точка должна возвращать код ошибки HTTP, если какая-либо критическая зависимость неработоспособна или недоступна. Однако не сообщайте об ошибках некритических служб. В противном случае проверка работоспособности может вызвать ненужную отработку отказа, создавая ложные срабатывания. Дополнительные сведения см. в статье [Мониторинг конечных точек в диспетчере трафика](/azure/traffic-manager/traffic-manager-monitoring/).

### <a name="virtual-machines"></a>Виртуальные машины
* **Не выполняйте рабочую нагрузку на одной виртуальной машине.** Одно развертывание виртуальной машины неустойчиво при плановом или внеплановом обслуживании. Вместо этого поместите несколько виртуальных машин в группу доступности или [масштабируемый набор виртуальных машин](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/) перед подсистемой балансировки нагрузки.
* **Укажите группу доступности при подготовке виртуальной машины.** В настоящее время после подготовки виртуальную машину невозможно добавить в группу доступности. Добавляя новую виртуальную машину в имеющуюся группу доступности, обязательно создайте сетевую карту для виртуальной машины и добавьте ее в серверный пул адресов в подсистеме балансировки нагрузки. В противном случае подсистема балансировки нагрузки не будет маршрутизировать сетевой трафик на эту виртуальную машину.
* **Поместите каждый уровень приложения в отдельных группах доступности.** В n-уровневом приложении не следует размещать виртуальные машины из разных уровней в одной группе доступности. Виртуальные машины в группе доступности располагаются в доменах сбоя и доменах обновления. Тем не менее, чтобы получить преимущества избыточности этих доменов, каждая виртуальная машина в группе доступности должна иметь возможность обрабатывать одни и те же клиентские запросы.
* **Выберите подходящий размер виртуальной машины в соответствии с требованиями к производительности.** При перемещении имеющейся рабочей нагрузки в Azure выберите начальный размер виртуальной машины, который больше всего соответствует вашим локальным серверам. Затем измерьте производительность фактической рабочей нагрузки по таким ресурсам, как потребление ЦП, памяти и дисковых операций ввода-вывода в секунду, и при необходимости измените размер виртуальной машины. Это гарантирует, что приложение будет правильно работать в облачной среде. Кроме того, если требуется использовать несколько сетевых карт, то учтите ограничения на количество сетевых карт для каждого размера.
* **Используйте управляемые диски для VHD.** Служба [Управляемые диски][managed-disks] обеспечивает более высокую надежность виртуальных машин в группах доступности, так как диски достаточно изолированы друг от друга, что позволяет избежать единой точки отказа. Кроме того, управляемые диски не подпадают под ограничения операций ввода-вывода в секунду для виртуальных жестких дисков (VHD), созданных в учетной записи хранения. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure][vm-manage-availability].
* **Устанавливайте приложения на диск данных, а не на диск операционной системы.** В противном случае можно превысить предельный размер диска.
* **Используйте службу Azure Backup для архивации виртуальных машин.** Резервные копии позволяют обеспечить защиту от случайной потери данных. Дополнительные сведения см. в статье [Архивация виртуальных машин Azure в хранилище служб восстановления](/azure/backup/backup-azure-vms-first-look-arm/).
* **Включите журналы диагностики**, в том числе базовые метрики работоспособности, а также ведение журналов инфраструктуры и [диагностику загрузки][boot-diagnostics]. Если виртуальную машину невозможно загрузить, для обнаружения неисправностей можно использовать диагностику загрузки. Дополнительные сведения см. в статье [Сбор и использование данных журнала из ресурсов Azure][diagnostics-logs].
* **Используйте расширение AzureLogCollector.** (Только для виртуальных машин Windows.) Это расширение объединяет журналы платформы Azure и загружает их в службу хранилища Azure без необходимости удаленного входа оператора в виртуальную машину. Дополнительные сведения см. в статье [Расширение AzureLogCollector](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

### <a name="virtual-network"></a>Виртуальная сеть
* **Чтобы поместить общедоступные IP-адреса в список разрешений или заблокировать их, добавьте NSG в подсеть.** Блокируйте доступ злоумышленников или разрешите доступ только для пользователей с привилегиями для доступа к приложению.  
* **Создайте пользовательскую проверку работоспособности.** При проверке работоспособности Load Balancer может тестироваться HTTP или TCP. Если виртуальная машина работает на HTTP-сервере, проверка HTTP поможет лучше определить состояние работоспособности, чем проверка TCP. Для проверки HTTP используйте настраиваемую конечную точку, которая сообщает об общей работоспособности приложения, включая все критические зависимости. Дополнительные сведения см. в разделе [Обзор Azure Load Balancer](/azure/load-balancer/load-balancer-overview/).
* **Не блокируйте проверку работоспособности.** Проверка работоспособности Load Balancer отправляется с известного IP-адреса — 168.63.129.16. Не блокируйте входящий и исходящий трафик для этого IP-адреса в каких-либо политиках брандмауэра или правилах группы безопасности сети (NSG). При блокировании проверки работоспособности подсистема балансировки нагрузки удаляет виртуальную машину из ротации.
* **Включите ведение журнала для Load Balancer.** В журналах показано, сколько виртуальных машин на серверной стороне не получают сетевой трафик из-за неудачных ответов проверки. Дополнительные сведения см. в статье [Служба анализа журналов для Azure Load Balancer](/azure/load-balancer/load-balancer-monitor-log/).

<!-- links -->
[app-service-autoscale]: /azure/monitoring-and-diagnostics/insights-how-to-scale/
[asynchronous-c-sharp]: /dotnet/articles/csharp/async
[availability-sets]:/azure/virtual-machines/virtual-machines-windows-manage-availability/
[azure-backup]: https://azure.microsoft.com/documentation/services/backup/
[boot-diagnostics]: https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/
[circuit-breaker]: ../patterns/circuit-breaker.md
[cloud-service-autoscale]: /azure/cloud-services/cloud-services-how-to-scale/
[diagnostics-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs/
[fma]: ../resiliency/failure-mode-analysis.md
[resilient-deployment]: ../resiliency/index.md#resilient-deployment
[load-balancer]: /azure/load-balancer/load-balancer-overview/
[managed-disks]: /azure/storage/storage-managed-disks-overview
[monitoring-and-diagnostics-guidance]: ../best-practices/monitoring.md
[resource-manager]: /azure/azure-resource-manager/resource-group-overview/
[retry-pattern]: ../patterns/retry.md
[retry-service-guidance]: ../best-practices/retry-service-specific.md
[search-optimization]: /azure/search/search-performance-optimization/
[sql-backup]: /azure/sql-database/sql-database-automated-backups/
[sql-restore]: /azure/sql-database/sql-database-recovery-using-backups/
[traffic-manager]: /azure/traffic-manager/traffic-manager-overview/
[traffic-manager-routing]: /azure/traffic-manager/traffic-manager-routing-methods/
[vm-manage-availability]: /azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set
[vmss-autoscale]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/
