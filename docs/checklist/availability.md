---
title: Контрольный список для обеспечения доступности
titleSuffix: Azure Design Review Framework
description: Контрольный список с рекомендациями по вопросам доступности, возникающим во время проектирования.
author: dragon119
ms.date: 11/26/2018
ms.topic: checklist
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: checklist
ms.openlocfilehash: 2e0c337cb0a5f343ae3dd94ae209d01f063cab35
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54483596"
---
# <a name="availability-checklist"></a>Контрольный список для обеспечения доступности

Доступность — это доля времени, в течение которого система функционирует и работает, а также один из [основных аспектов качества программного обеспечения](../guide/pillars.md). Воспользуйтесь этим контрольным списком, чтобы проверить архитектуру приложения с точки зрения доступности.

## <a name="application-design"></a>Проектирование приложений

**Избегайте единых точек отказа.**  Все компоненты, службы, ресурсы и вычислительные сущности должны развертываться в нескольких экземплярах, чтобы предотвратить влияние на доступность единой точки отказа. Это относится и к механизмам аутентификации. Проектируйте приложение так, чтобы его можно было настроить для использования нескольких экземпляров, а также для автоматического обнаружения сбоев и перенаправления запросов в исправные экземпляры там, где платформы не делают это автоматически.

**Разделяйте рабочие нагрузки в зависимости от задач уровня службы.** Если служба состоит из критически важных и менее важных рабочих нагрузок, управляйте ими по-разному и укажите функции службы и число экземпляров в соответствии с их требованиями доступности.

**Сводите к минимуму и понимайте зависимости службы.** Сведите к минимуму количество различных используемых служб, где это возможно, и убедитесь, что вы понимаете все функции и зависимости службы, которые существуют в системе. Сюда относится характер этих зависимостей и влияние сбоя или понижения производительности в каждой из них на приложение в целом.

**По возможности проектируйте задачи и сообщения как идемпотентные**. Если операция может повторяться несколько раз и дает одинаковый результат, она является идемпотентной. Идемпотентность гарантирует, что повторяющиеся запросы не создадут проблем. Объекты-получатели сообщений и операции, которые они выполняют, должны быть идемпотентными, чтобы повторение ранее выполненных операций не приводило к недопустимым результатам. Это может означать обнаружение повторяющихся сообщений или обеспечение согласованности с помощью оптимистичной методики обработки конфликтов.

**Используйте брокер сообщений, реализующий высокий уровень доступности, для важных транзакций.** Во многих облачных приложениях для запуска задач, которые выполняются асинхронно, используется обмен сообщениями. Чтобы гарантировать доставку сообщений, системе обмена сообщениями следует обеспечивать высокий уровень доступности. [Обмен сообщениями через служебную шину](/azure/service-bus-messaging) реализует семантику *по крайней мере один раз*. Это означает, что сообщение, отправленное в очередь, не будет потеряно, несмотря на то, что при определенных обстоятельствах в очереди могут появиться дубликаты. Если обработка сообщений идемпотентна (см. предыдущий пункт), то повторная доставка не должна стать проблемой.

**Проектируйте приложения так, чтобы производительность понижалась корректно.** Нагрузка на приложение может превышать возможности одной или нескольких частей, вызывая ограничение доступности и сбои подключений. Масштабирование позволяет обойти эту проблему, но оно может достичь предела, обусловленного другими факторами, такими как доступность ресурсов или затраты. Когда приложение достигает лимита ресурсов, ему необходимо выполнить соответствующие действия, чтобы свести к минимуму влияние на пользователя. Например, если в системе электронной коммерции подсистема обработки заказов неисправна или испытывает высокую нагрузку, эту часть системы можно временно отключить, включив другие функциональные возможности (например, просмотр каталога продуктов). При этом может быть удобно отложить запросы к неисправной подсистеме, например, по-прежнему позволяя клиентам размещать заказы, но сохраняя их для последующей обработки, когда подсистема обработки заказов снова станет доступна.

**Корректно обрабатывайте внезапные всплески активности.** Большинству приложений с течением времени необходимо обрабатывать меняющиеся рабочие нагрузки. Автоматическое масштабирование позволяет справиться с нагрузкой, но подключение дополнительных экземпляров к сети для обработки запросов может потребовать какого-то времени. Предотвратите перегрузку приложения при внезапных и непредвиденных всплесках активности. Для этого спроектируйте его так, чтобы оно ставило в очередь запросы к службам и постепенно снижало скорость обработки запросов, когда очереди близки к заполнению. Убедитесь, что при отсутствии всплесков производительности и мощности достаточно, чтобы опустошить очереди и обработать необработанные запросы. Дополнительные сведения см. в статье [Шаблон балансировки нагрузки на основе очередей](../patterns/queue-based-load-leveling.md).

## <a name="deployment-and-maintenance"></a>Развертывание и обслуживание

**Развертывайте несколько экземпляров служб.** Если приложение зависит от одного экземпляра службы, создается единая точка отказа. Подготовка нескольких экземпляров улучшает как отказоустойчивость, так и масштабируемость. Для [службы приложений Azure](/azure/app-service/app-service-value-prop-what-is/) выберите [план служб приложений](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/), где есть несколько экземпляров. Для облачных служб Azure настройте каждую роль для применения [нескольких экземпляров](/azure/cloud-services/cloud-services-choose-me/#scaling-and-management). Для [виртуальных машин Azure](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) убедитесь, что архитектура виртуальных машин содержит несколько виртуальных машин, а также что каждая виртуальная машина входит в [группу доступности][availability-sets].

**Рассмотрите возможность развертывания приложения в нескольких регионах.** Если ваше приложение развертывается в одном регионе, в редких случаях, когда весь регион становится недоступным, ваше приложение также будет недоступно. Это может быть неприемлемо в соответствии с условиями SLA вашего приложения. Если это так, рассмотрите возможность развертывания приложения и служб в нескольких регионах.

**Автоматизируйте и тестируйте задачи развертывания и обслуживания.** Распределенные приложения состоят из нескольких частей, которые должны работать вместе. Развертывание должно быть автоматизировано с помощью проверенных и надежных механизмов, таких как скрипты. Они могут обновить и проверить конфигурацию, а также автоматизировать процесс развертывания. Используйте [шаблоны Azure Resource Manager](/azure/azure-resource-manager/resource-group-authoring-templates) для подготовки ресурсов Azure. Также используйте автоматические методы для выполнения обновления приложения. Важно протестировать все эти процессы полностью, чтобы удостовериться, что ошибки не приводят к дополнительным простоям. У всех инструментов развертывания должны быть соответствующие ограничения безопасности для защиты развернутого приложения. Внимательно определяйте и применяйте политики развертывания и сведите к минимуму необходимость вмешательства человека.

**Используйте функции промежуточной и рабочей среды для платформы.**. Например, служба приложений Azure поддерживает [слоты развертывания](/azure/app-service/web-sites-staged-publishing), которые можно использовать для размещения развертывания в промежуточной среде, прежде чем переключиться на рабочую среду. Azure Service Fabric поддерживает [последовательное обновление](/azure/service-fabric/service-fabric-application-upgrade) для служб приложений.

**Размещайте виртуальные машины в группе доступности.** Чтобы добиться максимальной доступности, создайте несколько экземпляров каждой роли виртуальной машины и поместите их в одну группу доступности. Если вы используете несколько виртуальных машин, которые выполняют разные роли (например, разные уровни приложения), создайте группу доступности для каждой роли виртуальной машины. Например, создайте одну группу доступности для веб-уровня, а другую — для уровня данных.

**Репликация виртуальных машин с помощью Site Recovery.** Чтобы повысить доступность, реплицируйте все свои виртуальные машины в другой регион Azure с помощью [Site Recovery][site-recovery]. Убедитесь в том, что все виртуальные машины на всех уровнях вашего приложения реплицированы. В случае сбоя в исходном регионе можно выполнить отработку отказа виртуальных машин в другой регион за считанные минуты.

## <a name="data-management"></a>Управление данными

**Георепликация данных в службе хранилища Azure.** Данные в службе хранилище Azure автоматически реплицируются в пределах центра обработки данных. Чтобы дополнительно повысить их доступность, используйте геоизбыточное хранилище с доступом для чтения (-RAGRS), которое реплицирует хранимые данные в дополнительный регион и предоставляет к ним доступ только для чтения. Данные будут доступны даже в случае аварии или полного отключения региона. Дополнительные сведения см. в статье [Репликация службы хранилища Azure](/azure/storage/storage-redundancy).

**Георепликация баз данных.** База данных SQL Azure и Cosmos DB поддерживают георепликацию, что позволяет настроить базы данных-получатели (реплики) в других регионах. Базы данных-получатели доступны для выполнения запросов и отработки отказа при сбое центра обработки данных или невозможности подключения к базе данных-источнику. Дополнительные сведения см. в обзоре [групп отработки отказа и активной георепликации](/azure/sql-database/sql-database-geo-replication-overview) (для базы данных SQL) и в статье [Как работает глобальное распределение данных в Azure с помощью Cosmos DB](/azure/cosmos-db/distribute-data-globally).

**Используйте оптимистичный параллелизм и итоговую согласованность**. Транзакции, которые блокируют доступ к ресурсам из-за блокировки (пессимистичный параллелизм), могут привести к снижению производительности и значительно уменьшить доступность. Эти проблемы могут стать особенно ощутимыми в распределенных системах. Во многих случаях тщательное проектирование и такие методы, как секционирование, могут свести к минимуму вероятность конфликта обновлений. Когда данные реплицируются или считываются из отдельно обновляемого хранилища, эти данные будут окончательно согласованными. Но преимущества обычно намного перевешивают влияние транзакций для обеспечения мгновенной согласованности на доступность.

**Используйте периодическое резервное копирование и восстановление на определенный момент**. Автоматически и регулярно создавайте резервные копии данных, которые не сохраняются в другом месте, и убедитесь, что можете гарантированно восстановить данные и само приложение в случае сбоя. Убедитесь, что резервные копии соответствуют целевой точке восстановления (RPO). Репликация данных — это не функция резервного копирования, так как ошибки пользователя или вредоносные операции могут повредить данные во всех репликах. Процесс резервного копирования должен быть безопасным, чтобы обеспечить защиту данных во время передачи и хранения. Базы данных или части хранилища данных обычно восстанавливаются до состояния в более ранний момент времени с помощью журналов транзакций. Дополнительные сведения см. в статье [Техническое руководство по обеспечению устойчивости в Azure. Восстановление данных после повреждения или случайного удаления](../resiliency/recovery-data-corruption.md).

**Репликация дисков виртуальных машин с помощью Azure Site Recovery** При репликации виртуальных машин Azure с помощью [Site Recovery][site-recovery] все диски виртуальных машин непрерывно и асинхронно реплицируются в целевой регион. Точки восстановления создаются каждые несколько минут. Это обеспечивает требуемую RPO в минутах.

## <a name="errors-and-failures"></a>Ошибки и сбои

**Настройте время ожидания запросов.** Службы и ресурсы могут стать недоступными, что приводит к сбою запросов. Убедитесь, что используемые значения времени ожидания достаточны для каждой службы или ресурса, а также для клиента, который к ним обращается. В некоторых случаях можно увеличить время ожидания для конкретного экземпляра клиента в зависимости от контекста и других действий, выполняемых клиентом. Очень короткое время ожидания может привести к чрезмерному повторению операций для служб и ресурсов, которые имеют значительные задержки. Очень длинное время ожидания может вызвать блокировку, если в очереди находится большое количество запросов, ожидающих ответа от служб или ресурсов.

**Повторяйте неудачные операции, вызванные временными сбоями.** Разработайте стратегию повторов для доступа ко всем службам и ресурсам там, где они по своей природе не поддерживают автоматический повтор подключения. Используйте стратегию, которая включает в себя увеличение интервала между повторными попытками при увеличении количества сбоев. Это позволит предотвратить перегрузку ресурса и корректно восстановить его работоспособность и обработать запросы в очереди. Постоянные повторные попытки с очень короткими задержками могут усугубить проблему. Дополнительные сведения см. в статье, посвященной [конкретным рекомендациям по использованию механизма повторов](../best-practices/retry-service-specific.md).

**Реализуйте автоматическое выключение, чтобы избежать каскадных сбоев.** Возможны ситуации, при которых временные или другие ошибки (различающиеся по степени серьезности от частичной потери подключения до полного сбоя службы) требуют намного больше времени для возврата в обычный режим. Если служба очень занята, сбой в одной из частей системы может привести к лавинообразному накоплению сбоев и, в свою очередь, блокированию многих операций, удерживающих критические системные ресурсы, например память, потоки и подключения к базе данных. Вместо постоянных попыток повторить операцию, которая, скорее всего, не будет успешно выполнена, приложение должно быстро принять сбой операции и обработать этот сбой. Используйте шаблон автоматического выключения, чтобы отклонять запросы для определенных операций в заданные периоды. Дополнительные сведения см. в статье [Шаблон автоматического выключения](../patterns/circuit-breaker.md).

**Составьте или вернитесь к нескольким компонентам.** Проектируйте приложения таким образом, чтобы использовать несколько экземпляров, не влияя на операции и существующие подключения, где это возможно. Используйте несколько экземпляров и распределяйте запросы между ними. Выявляйте неработоспособные экземпляры и не отправляйте запросы к ним. Все это позволит добиться максимальной доступности.

**Возвращайтесь к другой службе или рабочему процессу.** Например, в случае сбоя при записи в базу данных SQL временно сохраняйте данные в хранилище BLOB-объектов или кэш Redis. Предоставьте способ воспроизведения записей в базу данных SQL, когда служба станет доступной. В некоторых случаях у завершенной сбоем операции может быть альтернативное действие, которое позволяет приложению продолжать работать даже при сбое компонента или службы. По возможности выявляйте сбои и перенаправляйте запросы в другие службы, которые могут предложить подходящие альтернативные функции, или в резервные экземпляры или экземпляры со сниженной функциональностью, которые могут поддержать основные операции, пока основная служба отключена.

## <a name="monitoring-and-disaster-recovery"></a>Мониторинг и аварийное восстановление

**Предоставьте расширенный инструментарий для обработки возможных сбоев и событий сбоев**, чтобы сообщать о ситуации эксплуатационному персоналу. Для сбоев, которые вероятны, но еще не произошли, предоставьте достаточно данных, чтобы эксплуатационный персонал мог определить причину, уменьшить последствия ситуации и обеспечить доступность системы. Для сбоев, которые уже произошли, приложение должно возвращать соответствующее сообщение об ошибке для пользователя. При этом приложение пытается продолжать работу, пусть и с ограниченными функциональными возможностями. Во всех случаях система мониторинга должна записывать всеобъемлющие данные, чтобы эксплуатационный персонал мог быстро восстановить работу приложения, а конструкторы и разработчики при необходимости могли изменить систему для предотвращения подобных ситуаций в будущем.

**Наблюдайте за работоспособностью системы, реализовав функции проверки.**  Работоспособность и производительность приложения могут незаметно снижаться с течением времени, пока не произойдет сбой. Реализуйте проверочные функции, которые будут регулярно выполняться извне приложения. Эти проверки могут быть просто измерением времени отклика приложения в целом, отдельных частей приложения, отдельных служб, которые используются приложением, или отдельных компонентов. Функции проверки могут выполнять процессы, чтобы обеспечить получение ими допустимых результатов, измерять задержку и проверять доступность, а также извлекать информацию из системы.

**Регулярно тестируйте все системы отработки отказа и восстановления размещения.** Изменения систем и операций могут повлиять на резервные функции и функции отработки отказа, но влияние может быть не обнаружено, пока не произойдет сбой основной системы или она не окажется перегружена. Проводите тестирование заблаговременно, чтобы не пришлось расплачиваться за это реальной ошибкой в рабочей системе. Если вы используете [Azure Site Recovery][site-recovery] для репликации виртуальных машин, периодически запускайте аварийное восстановление периодически, выполняя тестовую отработку отказа. См. дополнительные сведения об [отработке аварийного восстановления в Azure][site-recovery-test].

**Протестируйте системы мониторинга.**  Работа всех автоматизированных систем отработки отказа и восстановления, а также всех систем визуализации работоспособности и производительности системы с использованием панелей мониторинга зависит от правильной работы функций мониторинга и инструментирования. Если происходит сбой этих элементов, они пропускают важную информацию или сообщают неточные данные, поэтому оператор может не понять, что система работает неправильно.

**Отслеживайте ход выполнения длительных рабочих процессов и повторяйте попытку в случае сбоя.** Длительные рабочие процессы часто состоят из нескольких шагов. Убедитесь, что каждый шаг независим и его можно повторить. Это позволит свести к минимуму вероятность того, что придется производить откат всего рабочего процесса или выполнять несколько компенсирующих транзакций. Отслеживайте ход выполнения длительных рабочих процессов и управляйте ими, реализовав шаблон, такой как [шаблон супервизора агента планировщика](../patterns/scheduler-agent-supervisor.md).

**Планируйте аварийное восстановление.** Создайте утвержденный и полностью проверенный план восстановления для ошибок любого типа, которые могут повлиять на доступность системы. Выберите архитектуру с несколькими сайтами для восстановления всех критически важных приложений. Назначьте ответственного за реализацию плана аварийного восстановления, включая его автоматизацию и тестирование. Убедитесь, что план хорошо документирован, и максимально автоматизируйте все его процессы. Создайте стратегию резервного копирования для всех эталонных данных и данных о транзакциях. Регулярно проверяйте возможность восстановления из этих резервных копий. Обучите линейных сотрудников выполнять этот план и регулярно проводите имитации аварийных ситуаций, чтобы постоянно проверять и улучшать его. Если вы используете [Azure Site Recovery][site-recovery] для репликации виртуальных машин, создайте план автоматического восстановления для отработки отказа всего приложения за считанные минуты.

<!-- links -->
[availability-sets]:/azure/virtual-machines/virtual-machines-windows-manage-availability/
[site-recovery]: /azure/site-recovery/
[site-recovery-test]: /azure/site-recovery/site-recovery-test-failover-to-azure
